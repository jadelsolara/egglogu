<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>EGGlogU - Sistema Av√≠cola 360¬∞</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--primary:#1A3C6E;--primary-light:#4A7AB5;--primary-dark:#0E2240;--secondary:#FF8F00;--accent:#2E7D32;--danger:#C62828;--danger-light:#EF5350;--warning:#F9A825;--success:#2E7D32;--bg:#F5F5F5;--card:#FFF;--text:#212121;--text-light:#757575;--sidebar-bg:#0E2240;--sidebar-width:240px;--border:#E0E0E0;--radius:8px;--primary-hover:rgba(26,60,110,.04);--primary-ring:rgba(26,60,110,.15);--primary-fill:rgba(26,60,110,.1)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.app{display:flex;min-height:100vh}
.sidebar{width:var(--sidebar-width);background:var(--sidebar-bg);color:#fff;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;transition:transform .3s}
.sidebar-logo{padding:20px;font-size:24px;font-weight:700;text-align:center;border-bottom:1px solid rgba(255,255,255,.2);letter-spacing:2px}
.sidebar-logo small{display:block;font-size:10px;font-weight:400;opacity:.7}
.sidebar nav{flex:1;padding:10px 0;overflow-y:auto}
.sidebar nav a{display:flex;align-items:center;gap:12px;padding:12px 20px;color:rgba(255,255,255,.8);text-decoration:none;transition:all .2s;cursor:pointer;font-size:14px}
.sidebar nav a:hover{background:rgba(255,255,255,.1);color:#fff}
.sidebar nav a.active{background:rgba(255,255,255,.2);color:#fff;font-weight:600;border-left:3px solid var(--secondary)}
.sidebar nav a i{font-style:normal;font-size:18px;width:24px;text-align:center}
.lang-toggle{padding:15px;display:flex;gap:8px;justify-content:center;border-top:1px solid rgba(255,255,255,.2)}
.lang-toggle button{padding:6px 16px;border:1px solid rgba(255,255,255,.5);background:transparent;color:#fff;border-radius:4px;cursor:pointer;font-size:13px}
.lang-toggle button.active{background:#fff;color:var(--sidebar-bg);font-weight:600}
.hamburger{display:none;position:fixed;top:10px;left:10px;z-index:101;background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:var(--radius);font-size:20px;cursor:pointer}
.main-content{margin-left:var(--sidebar-width);flex:1;padding:20px 30px;min-height:100vh}
.section{display:none}.section.active{display:block}
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px}
.page-header h2{font-size:24px;color:var(--primary-dark)}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-bottom:24px}
.kpi-card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);border-left:4px solid var(--primary)}
.kpi-card.warning{border-left-color:var(--warning)}.kpi-card.danger{border-left-color:var(--danger)}.kpi-card.accent{border-left-color:var(--accent)}.kpi-card.secondary{border-left-color:var(--secondary)}
.kpi-card .kpi-label{font-size:12px;color:var(--text-light);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.kpi-card .kpi-value{font-size:28px;font-weight:700}.kpi-card .kpi-sub{font-size:12px;color:var(--text-light);margin-top:4px}
.card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:20px}
.card h3{margin-bottom:16px;color:var(--primary-dark);font-size:18px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border)}
th{background:var(--bg);font-weight:600;color:var(--text-light);font-size:12px;text-transform:uppercase;letter-spacing:.5px;position:sticky;top:0}
tr:hover{background:var(--primary-hover)}
.table-wrap{overflow-x:auto;max-height:500px;overflow-y:auto}
.btn{padding:8px 20px;border:none;border-radius:var(--radius);cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark)}
.btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{background:var(--border)}
.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#a51c1c}
.btn-warning{background:var(--warning);color:#000}.btn-sm{padding:4px 12px;font-size:12px}
.btn-group{display:flex;gap:6px;flex-wrap:wrap}
.form-group{margin-bottom:16px}
.form-group label{display:block;margin-bottom:6px;font-weight:500;font-size:14px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;font-family:inherit;transition:border-color .2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-ring)}
.form-group textarea{min-height:80px;resize:vertical}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;justify-content:center;align-items:flex-start;padding:40px 20px;overflow-y:auto}
.modal-overlay.open{display:flex}
.modal{background:var(--card);border-radius:var(--radius);width:100%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border)}
.modal-header h3{font-size:18px;color:var(--primary-dark)}
.modal-header button{background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-light);padding:0 4px}
.modal-body{padding:20px}
.modal-footer{padding:15px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}
.toast{position:fixed;bottom:20px;right:20px;background:var(--primary);color:#fff;padding:12px 24px;border-radius:var(--radius);box-shadow:0 4px 12px rgba(0,0,0,.2);transform:translateY(100px);opacity:0;transition:all .3s;z-index:300;font-size:14px}
.toast.show{transform:translateY(0);opacity:1}.toast.error{background:var(--danger)}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase}
.badge-success{background:#E8F5E9;color:#2E7D32}.badge-warning{background:#FFF8E1;color:#F57F17}.badge-danger{background:#FFEBEE;color:#C62828}.badge-info{background:#E3F2FD;color:#1565C0}.badge-secondary{background:#F5F5F5;color:#757575}
.health-score{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;font-weight:700;font-size:14px;color:#fff}
.health-score.good{background:var(--success)}.health-score.warn{background:var(--warning);color:#000}.health-score.bad{background:var(--danger)}
.tabs{display:flex;gap:0;margin-bottom:20px;border-bottom:2px solid var(--border)}
.tab{padding:10px 20px;cursor:pointer;font-size:14px;font-weight:500;color:var(--text-light);border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s}
.tab:hover{color:var(--text)}.tab.active{color:var(--primary);border-bottom-color:var(--primary);font-weight:600}
.alert-card{padding:12px 16px;border-radius:var(--radius);margin-bottom:10px;font-size:14px;display:flex;align-items:center;gap:10px}
.alert-card.alert-danger{background:#FFEBEE;border-left:4px solid var(--danger);color:var(--danger)}
.alert-card.alert-warning{background:#FFF8E1;border-left:4px solid var(--warning);color:#E65100}
.alert-card.alert-success{background:#E8F5E9;border-left:4px solid var(--success);color:var(--success)}
.alert-card.alert-info{background:#E3F2FD;border-left:4px solid var(--accent);color:var(--accent)}
.checklist-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
.checklist-item input[type=checkbox]{width:18px;height:18px;accent-color:var(--primary)}
.checklist-item.done span{text-decoration:line-through;color:var(--text-light)}
.empty-state{text-align:center;padding:40px;color:var(--text-light)}
.empty-state .empty-icon{font-size:48px;margin-bottom:12px}.empty-state p{margin-bottom:16px}
.chart-container{position:relative;height:300px;margin-bottom:20px}
.filter-bar{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.filter-bar select,.filter-bar input{padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px}
.stat-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:14px}
.stat-row:last-child{border-bottom:none}.stat-row .stat-label{color:var(--text-light)}.stat-row .stat-value{font-weight:600}
.lifecycle-bar{display:flex;border-radius:var(--radius);overflow:hidden;height:48px;margin:16px 0}
.lifecycle-stage{display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;padding:4px 8px;position:relative;cursor:pointer;transition:opacity .2s;text-align:center;line-height:1.2}
.lifecycle-stage:hover{opacity:.85}
.lifecycle-stage.current{box-shadow:inset 0 0 0 3px var(--primary-dark);z-index:1}
.lifecycle-detail{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin:16px 0}
.lifecycle-card{border-radius:var(--radius);padding:12px;text-align:center;font-size:13px}
.lifecycle-card .lc-icon{font-size:28px;margin-bottom:4px}
.lifecycle-card .lc-name{font-weight:700;margin-bottom:4px}
.lifecycle-card .lc-weeks{font-size:11px;color:var(--text-light)}
.lifecycle-card .lc-info{font-size:11px;margin-top:6px;text-align:left}
.snapshot-badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:10px;font-weight:600;margin-left:6px}
.snapshot-up{background:#E8F5E9;color:#2E7D32}.snapshot-down{background:#FFEBEE;color:#C62828}.snapshot-same{background:#F5F5F5;color:#757575}
@media(max-width:768px){
.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.hamburger{display:block}
.main-content{margin-left:0;padding:60px 15px 20px}
.kpi-grid{grid-template-columns:1fr 1fr}.form-row,.form-row-3{grid-template-columns:1fr}
.page-header{flex-direction:column;align-items:flex-start}.modal{max-width:95vw}
.lifecycle-bar{flex-wrap:wrap;height:auto}.lifecycle-stage{padding:8px}
}
@media(max-width:480px){.kpi-grid{grid-template-columns:1fr}.kpi-card .kpi-value{font-size:22px}}
</style>
</head>
<body>
<div class="app">
<aside class="sidebar" id="sidebar">
<div class="sidebar-logo">ü•ö EGGlogU<small data-t="sidebar_subtitle">Sistema Av√≠cola 360¬∞</small></div>
<nav id="main-nav">
<a data-section="dashboard" class="active" onclick="nav('dashboard')"><i>üìä</i><span data-t="nav_dashboard">Dashboard</span></a>
<a data-section="produccion" onclick="nav('produccion')"><i>ü•ö</i><span data-t="nav_production">Producci√≥n</span></a>
<a data-section="lotes" onclick="nav('lotes')"><i>üêî</i><span data-t="nav_flocks">Lotes</span></a>
<a data-section="sanidad" onclick="nav('sanidad')"><i>üíâ</i><span data-t="nav_health">Sanidad</span></a>
<a data-section="alimento" onclick="nav('alimento')"><i>üåæ</i><span data-t="nav_feed">Alimento</span></a>
<a data-section="clientes" onclick="nav('clientes')"><i>üë•</i><span data-t="nav_clients">Clientes</span></a>
<a data-section="finanzas" onclick="nav('finanzas')"><i>üí∞</i><span data-t="nav_finances">Finanzas</span></a>
<a data-section="analisis" onclick="nav('analisis')"><i>üìà</i><span data-t="nav_analysis">An√°lisis</span></a>
<a data-section="operaciones" onclick="nav('operaciones')"><i>üìã</i><span data-t="nav_operations">Operaciones</span></a>
<a data-section="ambiente" onclick="nav('ambiente')"><i>üå°Ô∏è</i><span data-t="nav_environment">Ambiente</span></a>
<a data-section="config" onclick="nav('config')"><i>‚öôÔ∏è</i><span data-t="nav_config">Config</span></a>
</nav>
<div class="lang-toggle">
<button onclick="switchLang('es')" id="btn-es" class="active">ES</button>
<button onclick="switchLang('en')" id="btn-en">EN</button>
<button onclick="switchLang('pt')" id="btn-pt">PT</button>
</div>
</aside>
<main class="main-content">
<button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
<div id="sec-dashboard" class="section active"></div>
<div id="sec-produccion" class="section"></div>
<div id="sec-lotes" class="section"></div>
<div id="sec-sanidad" class="section"></div>
<div id="sec-alimento" class="section"></div>
<div id="sec-clientes" class="section"></div>
<div id="sec-finanzas" class="section"></div>
<div id="sec-analisis" class="section"></div>
<div id="sec-operaciones" class="section"></div>
<div id="sec-ambiente" class="section"></div>
<div id="sec-config" class="section"></div>
</main>
</div>
<div class="modal-overlay" id="modal-overlay" onclick="closeModal()">
<div class="modal" onclick="event.stopPropagation()">
<div class="modal-header"><h3 id="modal-title"></h3><button onclick="closeModal()">‚úï</button></div>
<div class="modal-body" id="modal-body"></div>
</div>
</div>
<div class="toast" id="toast"></div>
<script>
// ============ TRANSLATIONS ============
const T={es:{
save:'Guardar',cancel:'Cancelar',delete:'Eliminar',edit:'Editar',add:'Agregar',close:'Cerrar',actions:'Acciones',date:'Fecha',notes:'Notas',name:'Nombre',phone:'Tel√©fono',email:'Email',address:'Direcci√≥n',confirm_delete:'¬øEliminar este registro?',no_data:'No hay datos registrados',total:'Total',all:'Todos',loading:'Cargando',search:'Buscar',from:'Desde',to:'Hasta',status:'Estado',export_csv:'Exportar CSV',today:'Hoy',active:'Activo',inactive:'Inactivo',
nav_dashboard:'Dashboard',nav_production:'Producci√≥n',nav_flocks:'Lotes',nav_health:'Sanidad',nav_feed:'Alimento',nav_clients:'Clientes',nav_finances:'Finanzas',nav_analysis:'An√°lisis',nav_operations:'Operaciones',nav_environment:'Ambiente',nav_config:'Configuraci√≥n',
dash_title:'Panel Principal',kpi_today:'Producci√≥n Hoy',kpi_henday:'Tasa Hen-Day',kpi_fcr:'Conversi√≥n (FCR)',kpi_mortality:'Mortalidad',kpi_cost_egg:'Costo/Huevo',kpi_income_net:'Ingreso Neto',kpi_alerts:'Alertas',kpi_active_hens:'Gallinas Activas',kpi_active_flocks:'Lotes Activos',dash_alerts:'Alertas',dash_trend:'Tendencia 30 D√≠as',dash_no_alerts:'Sin alertas',dash_snapshot:'Guardar Snapshot KPI',dash_kpi_history:'Historial KPI',
alert_vaccine_overdue:'Vacuna vencida',alert_vaccine_soon:'Vacuna pr√≥xima',alert_low_feed:'Stock alimento bajo',alert_high_mortality:'Mortalidad alta',alert_active_outbreak:'Brote activo',alert_withdrawal:'Retiro activo',
flock_title:'Gesti√≥n de Lotes',flock_add:'Nuevo Lote',flock_name:'Nombre',flock_breed:'Raza',flock_count:'Cantidad Inicial',flock_birthdate:'Fecha Nacimiento',flock_purchase_date:'Fecha Compra',flock_supplier:'Proveedor',flock_cost:'Costo Total',flock_status:'Estado',flock_notes:'Notas',flock_age:'Edad',flock_health:'Salud',flock_weeks:'sem',flock_days:'d√≠as',flock_current:'Actuales',flock_status_cria:'Cr√≠a',flock_status_recria:'Recr√≠a',flock_status_produccion:'Producci√≥n',flock_status_descarte:'Descarte',flock_edit:'Editar Lote',flock_lifecycle:'Ciclo de Vida',flock_roadmap:'Roadmap',
lc_pollito:'Pollito',lc_cria:'Cr√≠a',lc_recria:'Recr√≠a',lc_prepostura:'Pre-postura',lc_pico:'Postura Pico',lc_media:'Postura Media',lc_baja:'Postura Baja',lc_descarte:'Descarte',lc_feed:'Alimento',lc_temp:'Temp',lc_weeks:'Semanas',lc_milestone:'Hitos',lc_current_stage:'Etapa Actual',
prod_title:'Registro de Producci√≥n',prod_add:'Nuevo Registro',prod_flock:'Lote',prod_eggs:'Huevos Recolectados',prod_broken:'Rotos/Defectuosos',prod_size_s:'Peque√±o (S)',prod_size_m:'Mediano (M)',prod_size_l:'Grande (L)',prod_size_xl:'Extra Grande (XL)',prod_size_jumbo:'Jumbo',prod_shell:'Color C√°scara',prod_yolk:'Calidad Yema (1-10)',prod_deaths:'Muertes',prod_death_cause:'Causa de Muerte',prod_date:'Fecha',
san_title:'Sanidad',san_vaccines:'Vacunas',san_medications:'Medicamentos',san_outbreaks:'Brotes',
vac_title:'Plan de Vacunaci√≥n',vac_add:'Registrar Vacuna',vac_vaccine:'Vacuna',vac_scheduled:'Programada',vac_applied:'Aplicada',vac_batch:'Lote Vacuna',vac_route:'V√≠a',vac_overdue:'Vencida',vac_upcoming:'Pr√≥xima',vac_applied_status:'Aplicada',vac_pending:'Pendiente',vac_generate:'Generar Calendario',vac_mark_applied:'Marcar Aplicada',
med_title:'Medicamentos',med_add:'Registrar Medicamento',med_name:'Medicamento',med_reason:'Motivo',med_start:'Inicio',med_end:'Fin',med_withdrawal:'D√≠as Retiro',med_withdrawal_end:'Fin Retiro',med_dosage:'Dosis',med_in_withdrawal:'En Retiro',
out_title:'Brotes',out_add:'Registrar Brote',out_disease:'Enfermedad',out_start:'Inicio',out_end:'Fin',out_affected:'Afectadas',out_deaths:'Muertes',out_symptoms:'S√≠ntomas',out_treatment:'Tratamiento',out_loss:'P√©rdida Econ√≥mica',out_active:'Activo',out_controlled:'Controlado',out_resolved:'Resuelto',
feed_title:'Alimentaci√≥n',feed_purchases:'Compras',feed_consumption:'Consumo',feed_stock:'Stock Actual',feed_add_purchase:'Nueva Compra',feed_add_consumption:'Registrar Consumo',feed_type:'Tipo',feed_qty:'Cantidad (kg)',feed_cost:'Costo',feed_supplier:'Proveedor',feed_flock:'Lote',feed_low_alert:'Stock bajo',
cli_title:'Clientes',cli_add:'Nuevo Cliente',cli_route:'Ruta/Zona',cli_price:'Precios Acordados',cli_total:'Total Clientes',
fin_title:'Finanzas',fin_income:'Ingresos',fin_expenses:'Gastos',fin_receivables:'Cuentas por Cobrar',fin_summary:'Resumen',fin_add_income:'Nuevo Ingreso',fin_add_expense:'Nuevo Gasto',fin_add_receivable:'Nueva Cuenta',fin_type:'Tipo',fin_qty:'Cantidad',fin_unit_price:'Precio Unit.',fin_client:'Cliente',fin_category:'Categor√≠a',fin_description:'Descripci√≥n',fin_amount:'Monto',fin_due_date:'Vencimiento',fin_paid:'Pagado',fin_total_income:'Total Ingresos',fin_total_expenses:'Total Gastos',fin_net:'Resultado Neto',fin_cost_per_egg:'Costo/Huevo',fin_break_even:'Punto Equilibrio',fin_month:'Mes',
fin_cat_feed:'Alimento',fin_cat_vaccines:'Vacunas/Med.',fin_cat_transport:'Transporte',fin_cat_labor:'Mano de Obra',fin_cat_infrastructure:'Infraestructura',fin_cat_other:'Otros',
fin_type_eggs:'Venta Huevos',fin_type_birds:'Venta Aves',fin_type_manure:'Venta Abono',fin_type_other:'Otro',
ana_title:'An√°lisis',ana_comparison:'Comparaci√≥n Lotes',ana_seasonality:'Estacionalidad',ana_profitability:'Rentabilidad',ana_benchmarks:'Benchmarks',ana_best_flock:'Mejor Lote',ana_worst_flock:'Peor Lote',ana_avg_production:'Producci√≥n Promedio',ana_trend:'Tendencia',ana_kpi_evolution:'Evoluci√≥n KPI',ana_no_snapshots:'Sin snapshots. Guarde snapshots desde el Dashboard.',
ops_title:'Operaciones',ops_checklist:'Checklist Diario',ops_logbook:'Bit√°cora',ops_personnel:'Personal',ops_task:'Tarea',ops_done:'Completado',ops_add_task:'Agregar Tarea',ops_check_date:'Fecha',ops_log_entry:'Entrada',ops_log_category:'Categor√≠a',ops_log_add:'Nueva Entrada',
ops_log_cat_general:'General',ops_log_cat_health:'Sanidad',ops_log_cat_production:'Producci√≥n',ops_log_cat_maintenance:'Mantenimiento',ops_log_cat_observation:'Observaci√≥n',
ops_per_name:'Nombre',ops_per_role:'Cargo',ops_per_salary:'Salario',ops_per_start:'Fecha Inicio',ops_per_active:'Activo',ops_per_add:'Agregar Personal',
env_title:'Condiciones Ambientales',env_add:'Nuevo Registro',env_temp:'Temperatura (¬∞C)',env_humidity:'Humedad (%)',env_light:'Horas Luz',env_ventilation:'Ventilaci√≥n',env_density:'Densidad (aves/m¬≤)',env_optimal:'Rango √ìptimo',env_temp_range:'18-24¬∞C',env_humidity_range:'40-70%',env_light_range:'14-16 hrs',env_density_range:'4-5 aves/m¬≤',
cfg_title:'Configuraci√≥n',cfg_farm:'Datos de la Granja',cfg_farm_name:'Nombre Granja',cfg_location:'Ubicaci√≥n',cfg_capacity:'Capacidad (aves)',cfg_currency:'Moneda',cfg_alerts:'Umbrales de Alertas',cfg_min_feed:'Stock M√≠n. Alimento (kg)',cfg_max_mortality:'Mortalidad M√°x. (%)',cfg_alert_days:'D√≠as Anticipaci√≥n',cfg_data:'Datos',cfg_export:'Exportar (JSON)',cfg_import:'Importar (JSON)',cfg_reset:'Borrar Todo',cfg_reset_confirm:'¬øEliminar TODOS los datos?',cfg_saved:'Guardado',cfg_exported:'Datos exportados',cfg_imported:'Datos importados',cfg_reset_done:'Datos eliminados',cfg_checklist:'Checklist Predeterminado',cfg_checklist_items:'Tareas del checklist',cfg_theme:'Tema de Color',cfg_theme_blue:'Azul Marino',cfg_theme_green:'Verde',cfg_theme_purple:'P√∫rpura',cfg_theme_black:'Negro',
sidebar_subtitle:'Sistema Av√≠cola 360¬∞',prod_shell_white:'Blanco',prod_shell_brown:'Marr√≥n',prod_shell_cream:'Crema',required:'Campo requerido',no_flocks_birthdate:'No hay lotes con fecha de nacimiento',vac_select_flocks:'Seleccione lotes para generar calendario:',feed_type_placeholder:'Postura, Iniciador, etc.',avg_per_day:'Prom/d√≠a',per_flock:'Lote',history:'Historial',env_latest_reading:'√öltima Lectura',env_ok:'OK',env_out_of_range:'Fuera de rango',data_stats:'Estad√≠sticas de Datos',final_warning:'‚ö†Ô∏è ADVERTENCIA FINAL ‚Äî Se eliminar√°n TODOS los datos',total_salaries:'Total Salarios',eggs_unit:'huevos',csv_income:'Ingreso',csv_expense:'Gasto',fcr_unit:'kg alimento/kg huevo',lc_feed_starter:'Iniciador',lc_feed_grower:'Crecimiento',lc_feed_developer:'Desarrollo',lc_feed_prelay:'Pre-postura',lc_feed_layer:'Postura',lc_feed_lowlay:'Postura baja',lc_prod_label:'Prod',lc_prod_first:'Primeros huevos',lc_mile_1:'Vacunas Marek, Newcastle+BI, Gumboro',lc_mile_2:'Newcastle refuerzo, desarrollo plumaje',lc_mile_3:'Viruela, Encefalomielitis, Coriza, Salmonella',lc_mile_4:'Newcastle+BI refuerzo, cambio dieta, 16h luz',lc_mile_5:'Pico producci√≥n sem 26-30, monitorear FCR',lc_mile_6:'Newcastle refuerzo c/8-12 sem, evaluar rentabilidad',lc_mile_7:'Evaluar descarte vs muda forzada',lc_mile_8:'Venta ave descarte, limpieza galp√≥n',vac_route_injection:'Inyecci√≥n',vac_route_ocular:'Ocular/spray',vac_route_water:'Agua',vac_route_wing:'Punci√≥n alar',snapshots:'snapshots',error_prefix:'Error',chk_collect_eggs:'Recolectar huevos',chk_feed_birds:'Alimentar aves',chk_check_water:'Verificar agua',chk_check_health:'Revisar salud',chk_cleaning:'Limpieza',chk_record_temp:'Registrar temperatura'
},en:{
save:'Save',cancel:'Cancel',delete:'Delete',edit:'Edit',add:'Add',close:'Close',actions:'Actions',date:'Date',notes:'Notes',name:'Name',phone:'Phone',email:'Email',address:'Address',confirm_delete:'Delete this record?',no_data:'No data recorded',total:'Total',all:'All',loading:'Loading',search:'Search',from:'From',to:'To',status:'Status',export_csv:'Export CSV',today:'Today',active:'Active',inactive:'Inactive',
nav_dashboard:'Dashboard',nav_production:'Production',nav_flocks:'Flocks',nav_health:'Health',nav_feed:'Feed',nav_clients:'Clients',nav_finances:'Finances',nav_analysis:'Analysis',nav_operations:'Operations',nav_environment:'Environment',nav_config:'Settings',
dash_title:'Main Dashboard',kpi_today:'Production Today',kpi_henday:'Hen-Day Rate',kpi_fcr:'Feed Conversion (FCR)',kpi_mortality:'Mortality',kpi_cost_egg:'Cost/Egg',kpi_income_net:'Net Income',kpi_alerts:'Alerts',kpi_active_hens:'Active Hens',kpi_active_flocks:'Active Flocks',dash_alerts:'Alerts',dash_trend:'30 Day Trend',dash_no_alerts:'No alerts',dash_snapshot:'Save KPI Snapshot',dash_kpi_history:'KPI History',
alert_vaccine_overdue:'Vaccine overdue',alert_vaccine_soon:'Vaccine upcoming',alert_low_feed:'Feed stock low',alert_high_mortality:'High mortality',alert_active_outbreak:'Active outbreak',alert_withdrawal:'Active withdrawal',
flock_title:'Flock Management',flock_add:'New Flock',flock_name:'Name',flock_breed:'Breed',flock_count:'Initial Count',flock_birthdate:'Birth Date',flock_purchase_date:'Purchase Date',flock_supplier:'Supplier',flock_cost:'Total Cost',flock_status:'Status',flock_notes:'Notes',flock_age:'Age',flock_health:'Health',flock_weeks:'wks',flock_days:'days',flock_current:'Current',flock_status_cria:'Brooding',flock_status_recria:'Growing',flock_status_produccion:'Production',flock_status_descarte:'Culled',flock_edit:'Edit Flock',flock_lifecycle:'Lifecycle',flock_roadmap:'Roadmap',
lc_pollito:'Chick',lc_cria:'Brooding',lc_recria:'Growing',lc_prepostura:'Pre-lay',lc_pico:'Peak Lay',lc_media:'Mid Lay',lc_baja:'Low Lay',lc_descarte:'Culled',lc_feed:'Feed',lc_temp:'Temp',lc_weeks:'Weeks',lc_milestone:'Milestones',lc_current_stage:'Current Stage',
prod_title:'Production Log',prod_add:'New Record',prod_flock:'Flock',prod_eggs:'Eggs Collected',prod_broken:'Broken/Defective',prod_size_s:'Small (S)',prod_size_m:'Medium (M)',prod_size_l:'Large (L)',prod_size_xl:'Extra Large (XL)',prod_size_jumbo:'Jumbo',prod_shell:'Shell Color',prod_yolk:'Yolk Quality (1-10)',prod_deaths:'Deaths',prod_death_cause:'Cause of Death',prod_date:'Date',
san_title:'Health Management',san_vaccines:'Vaccines',san_medications:'Medications',san_outbreaks:'Outbreaks',
vac_title:'Vaccination Plan',vac_add:'Record Vaccine',vac_vaccine:'Vaccine',vac_scheduled:'Scheduled',vac_applied:'Applied',vac_batch:'Batch',vac_route:'Route',vac_overdue:'Overdue',vac_upcoming:'Upcoming',vac_applied_status:'Applied',vac_pending:'Pending',vac_generate:'Generate Calendar',vac_mark_applied:'Mark Applied',
med_title:'Medications',med_add:'Record Medication',med_name:'Medication',med_reason:'Reason',med_start:'Start',med_end:'End',med_withdrawal:'Withdrawal Days',med_withdrawal_end:'Withdrawal End',med_dosage:'Dosage',med_in_withdrawal:'In Withdrawal',
out_title:'Outbreaks',out_add:'Record Outbreak',out_disease:'Disease',out_start:'Start',out_end:'End',out_affected:'Affected',out_deaths:'Deaths',out_symptoms:'Symptoms',out_treatment:'Treatment',out_loss:'Economic Loss',out_active:'Active',out_controlled:'Controlled',out_resolved:'Resolved',
feed_title:'Feed Management',feed_purchases:'Purchases',feed_consumption:'Consumption',feed_stock:'Current Stock',feed_add_purchase:'New Purchase',feed_add_consumption:'Record Consumption',feed_type:'Type',feed_qty:'Quantity (kg)',feed_cost:'Cost',feed_supplier:'Supplier',feed_flock:'Flock',feed_low_alert:'Low stock',
cli_title:'Clients',cli_add:'New Client',cli_route:'Route/Zone',cli_price:'Agreed Prices',cli_total:'Total Clients',
fin_title:'Finances',fin_income:'Income',fin_expenses:'Expenses',fin_receivables:'Receivables',fin_summary:'Summary',fin_add_income:'New Income',fin_add_expense:'New Expense',fin_add_receivable:'New Receivable',fin_type:'Type',fin_qty:'Quantity',fin_unit_price:'Unit Price',fin_client:'Client',fin_category:'Category',fin_description:'Description',fin_amount:'Amount',fin_due_date:'Due Date',fin_paid:'Paid',fin_total_income:'Total Income',fin_total_expenses:'Total Expenses',fin_net:'Net Result',fin_cost_per_egg:'Cost/Egg',fin_break_even:'Break-even',fin_month:'Month',
fin_cat_feed:'Feed',fin_cat_vaccines:'Vaccines/Meds',fin_cat_transport:'Transport',fin_cat_labor:'Labor',fin_cat_infrastructure:'Infrastructure',fin_cat_other:'Other',
fin_type_eggs:'Egg Sales',fin_type_birds:'Bird Sales',fin_type_manure:'Manure Sales',fin_type_other:'Other',
ana_title:'Analysis',ana_comparison:'Flock Comparison',ana_seasonality:'Seasonality',ana_profitability:'Profitability',ana_benchmarks:'Benchmarks',ana_best_flock:'Best Flock',ana_worst_flock:'Worst Flock',ana_avg_production:'Avg Production',ana_trend:'Trend',ana_kpi_evolution:'KPI Evolution',ana_no_snapshots:'No snapshots. Save snapshots from Dashboard.',
ops_title:'Operations',ops_checklist:'Daily Checklist',ops_logbook:'Logbook',ops_personnel:'Personnel',ops_task:'Task',ops_done:'Completed',ops_add_task:'Add Task',ops_check_date:'Date',ops_log_entry:'Entry',ops_log_category:'Category',ops_log_add:'New Entry',
ops_log_cat_general:'General',ops_log_cat_health:'Health',ops_log_cat_production:'Production',ops_log_cat_maintenance:'Maintenance',ops_log_cat_observation:'Observation',
ops_per_name:'Name',ops_per_role:'Role',ops_per_salary:'Salary',ops_per_start:'Start Date',ops_per_active:'Active',ops_per_add:'Add Personnel',
env_title:'Environmental Conditions',env_add:'New Record',env_temp:'Temperature (¬∞C)',env_humidity:'Humidity (%)',env_light:'Light Hours',env_ventilation:'Ventilation',env_density:'Density (birds/m¬≤)',env_optimal:'Optimal Range',env_temp_range:'18-24¬∞C',env_humidity_range:'40-70%',env_light_range:'14-16 hrs',env_density_range:'4-5 birds/m¬≤',
cfg_title:'Settings',cfg_farm:'Farm Details',cfg_farm_name:'Farm Name',cfg_location:'Location',cfg_capacity:'Capacity (birds)',cfg_currency:'Currency',cfg_alerts:'Alert Thresholds',cfg_min_feed:'Min Feed Stock (kg)',cfg_max_mortality:'Max Mortality (%)',cfg_alert_days:'Alert Days Ahead',cfg_data:'Data',cfg_export:'Export (JSON)',cfg_import:'Import (JSON)',cfg_reset:'Delete All',cfg_reset_confirm:'Delete ALL data permanently?',cfg_saved:'Saved',cfg_exported:'Data exported',cfg_imported:'Data imported',cfg_reset_done:'Data deleted',cfg_checklist:'Default Checklist',cfg_checklist_items:'Daily checklist tasks',cfg_theme:'Color Theme',cfg_theme_blue:'Navy Blue',cfg_theme_green:'Green',cfg_theme_purple:'Purple',cfg_theme_black:'Black',
sidebar_subtitle:'Poultry System 360¬∞',prod_shell_white:'White',prod_shell_brown:'Brown',prod_shell_cream:'Cream',required:'Required field',no_flocks_birthdate:'No flocks with birth date',vac_select_flocks:'Select flocks to generate calendar:',feed_type_placeholder:'Layer, Starter, etc.',avg_per_day:'Avg/day',per_flock:'Flock',history:'History',env_latest_reading:'Latest Reading',env_ok:'OK',env_out_of_range:'Out of range',data_stats:'Data Statistics',final_warning:'‚ö†Ô∏è FINAL WARNING ‚Äî ALL data will be deleted',total_salaries:'Total Salaries',eggs_unit:'eggs',csv_income:'Income',csv_expense:'Expense',fcr_unit:'kg feed/kg egg',lc_feed_starter:'Starter',lc_feed_grower:'Grower',lc_feed_developer:'Developer',lc_feed_prelay:'Pre-lay',lc_feed_layer:'Layer',lc_feed_lowlay:'Low-lay',lc_prod_label:'Prod',lc_prod_first:'First eggs',lc_mile_1:'Marek, Newcastle+IB, Gumboro vaccines',lc_mile_2:'Newcastle booster, feather development',lc_mile_3:'Fowl Pox, AE, Coryza, Salmonella',lc_mile_4:'Newcastle+IB booster, diet change, 16h light',lc_mile_5:'Peak production wk 26-30, monitor FCR',lc_mile_6:'Newcastle booster every 8-12 wk, evaluate profitability',lc_mile_7:'Evaluate culling vs forced molting',lc_mile_8:'Sell culled birds, clean house',vac_route_injection:'Injection',vac_route_ocular:'Ocular/spray',vac_route_water:'Water',vac_route_wing:'Wing web',snapshots:'snapshots',error_prefix:'Error',chk_collect_eggs:'Collect eggs',chk_feed_birds:'Feed birds',chk_check_water:'Check water',chk_check_health:'Check health',chk_cleaning:'Cleaning',chk_record_temp:'Record temperature'
},pt:{
save:'Salvar',cancel:'Cancelar',delete:'Excluir',edit:'Editar',add:'Adicionar',close:'Fechar',actions:'A√ß√µes',date:'Data',notes:'Observa√ß√µes',name:'Nome',phone:'Telefone',email:'Email',address:'Endere√ßo',confirm_delete:'Excluir este registro?',no_data:'Nenhum dado registrado',total:'Total',all:'Todos',loading:'Carregando',search:'Buscar',from:'De',to:'At√©',status:'Status',export_csv:'Exportar CSV',today:'Hoje',active:'Ativo',inactive:'Inativo',
nav_dashboard:'Dashboard',nav_production:'Produ√ß√£o',nav_flocks:'Lotes',nav_health:'Sanidade',nav_feed:'Alimenta√ß√£o',nav_clients:'Clientes',nav_finances:'Finan√ßas',nav_analysis:'An√°lise',nav_operations:'Opera√ß√µes',nav_environment:'Ambiente',nav_config:'Configura√ß√£o',
dash_title:'Painel Principal',kpi_today:'Produ√ß√£o Hoje',kpi_henday:'Taxa Hen-Day',kpi_fcr:'Convers√£o (FCR)',kpi_mortality:'Mortalidade',kpi_cost_egg:'Custo/Ovo',kpi_income_net:'Receita L√≠quida',kpi_alerts:'Alertas',kpi_active_hens:'Galinhas Ativas',kpi_active_flocks:'Lotes Ativos',dash_alerts:'Alertas',dash_trend:'Tend√™ncia 30 Dias',dash_no_alerts:'Sem alertas',dash_snapshot:'Salvar Snapshot KPI',dash_kpi_history:'Hist√≥rico KPI',
alert_vaccine_overdue:'Vacina vencida',alert_vaccine_soon:'Vacina pr√≥xima',alert_low_feed:'Estoque de ra√ß√£o baixo',alert_high_mortality:'Mortalidade alta',alert_active_outbreak:'Surto ativo',alert_withdrawal:'Car√™ncia ativa',
flock_title:'Gest√£o de Lotes',flock_add:'Novo Lote',flock_name:'Nome',flock_breed:'Ra√ßa',flock_count:'Quantidade Inicial',flock_birthdate:'Data de Nascimento',flock_purchase_date:'Data de Compra',flock_supplier:'Fornecedor',flock_cost:'Custo Total',flock_status:'Status',flock_notes:'Observa√ß√µes',flock_age:'Idade',flock_health:'Sa√∫de',flock_weeks:'sem',flock_days:'dias',flock_current:'Atuais',flock_status_cria:'Cria',flock_status_recria:'Recria',flock_status_produccion:'Produ√ß√£o',flock_status_descarte:'Descarte',flock_edit:'Editar Lote',flock_lifecycle:'Ciclo de Vida',flock_roadmap:'Roadmap',
lc_pollito:'Pintinho',lc_cria:'Cria',lc_recria:'Recria',lc_prepostura:'Pr√©-postura',lc_pico:'Postura Pico',lc_media:'Postura M√©dia',lc_baja:'Postura Baixa',lc_descarte:'Descarte',lc_feed:'Ra√ß√£o',lc_temp:'Temp',lc_weeks:'Semanas',lc_milestone:'Marcos',lc_current_stage:'Etapa Atual',
prod_title:'Registro de Produ√ß√£o',prod_add:'Novo Registro',prod_flock:'Lote',prod_eggs:'Ovos Coletados',prod_broken:'Quebrados/Defeituosos',prod_size_s:'Pequeno (S)',prod_size_m:'M√©dio (M)',prod_size_l:'Grande (L)',prod_size_xl:'Extra Grande (XL)',prod_size_jumbo:'Jumbo',prod_shell:'Cor da Casca',prod_yolk:'Qualidade Gema (1-10)',prod_deaths:'Mortes',prod_death_cause:'Causa da Morte',prod_date:'Data',
san_title:'Sanidade',san_vaccines:'Vacinas',san_medications:'Medicamentos',san_outbreaks:'Surtos',
vac_title:'Plano de Vacina√ß√£o',vac_add:'Registrar Vacina',vac_vaccine:'Vacina',vac_scheduled:'Programada',vac_applied:'Aplicada',vac_batch:'Lote Vacina',vac_route:'Via',vac_overdue:'Vencida',vac_upcoming:'Pr√≥xima',vac_applied_status:'Aplicada',vac_pending:'Pendente',vac_generate:'Gerar Calend√°rio',vac_mark_applied:'Marcar Aplicada',
med_title:'Medicamentos',med_add:'Registrar Medicamento',med_name:'Medicamento',med_reason:'Motivo',med_start:'In√≠cio',med_end:'Fim',med_withdrawal:'Dias de Car√™ncia',med_withdrawal_end:'Fim da Car√™ncia',med_dosage:'Dosagem',med_in_withdrawal:'Em Car√™ncia',
out_title:'Surtos',out_add:'Registrar Surto',out_disease:'Doen√ßa',out_start:'In√≠cio',out_end:'Fim',out_affected:'Afetadas',out_deaths:'Mortes',out_symptoms:'Sintomas',out_treatment:'Tratamento',out_loss:'Perda Econ√¥mica',out_active:'Ativo',out_controlled:'Controlado',out_resolved:'Resolvido',
feed_title:'Alimenta√ß√£o',feed_purchases:'Compras',feed_consumption:'Consumo',feed_stock:'Estoque Atual',feed_add_purchase:'Nova Compra',feed_add_consumption:'Registrar Consumo',feed_type:'Tipo',feed_qty:'Quantidade (kg)',feed_cost:'Custo',feed_supplier:'Fornecedor',feed_flock:'Lote',feed_low_alert:'Estoque baixo',
cli_title:'Clientes',cli_add:'Novo Cliente',cli_route:'Rota/Zona',cli_price:'Pre√ßos Acordados',cli_total:'Total de Clientes',
fin_title:'Finan√ßas',fin_income:'Receitas',fin_expenses:'Despesas',fin_receivables:'Contas a Receber',fin_summary:'Resumo',fin_add_income:'Nova Receita',fin_add_expense:'Nova Despesa',fin_add_receivable:'Nova Conta',fin_type:'Tipo',fin_qty:'Quantidade',fin_unit_price:'Pre√ßo Unit.',fin_client:'Cliente',fin_category:'Categoria',fin_description:'Descri√ß√£o',fin_amount:'Valor',fin_due_date:'Vencimento',fin_paid:'Pago',fin_total_income:'Total Receitas',fin_total_expenses:'Total Despesas',fin_net:'Resultado L√≠quido',fin_cost_per_egg:'Custo/Ovo',fin_break_even:'Ponto de Equil√≠brio',fin_month:'M√™s',
fin_cat_feed:'Ra√ß√£o',fin_cat_vaccines:'Vacinas/Med.',fin_cat_transport:'Transporte',fin_cat_labor:'M√£o de Obra',fin_cat_infrastructure:'Infraestrutura',fin_cat_other:'Outros',
fin_type_eggs:'Venda de Ovos',fin_type_birds:'Venda de Aves',fin_type_manure:'Venda de Adubo',fin_type_other:'Outro',
ana_title:'An√°lise',ana_comparison:'Compara√ß√£o de Lotes',ana_seasonality:'Sazonalidade',ana_profitability:'Rentabilidade',ana_benchmarks:'Benchmarks',ana_best_flock:'Melhor Lote',ana_worst_flock:'Pior Lote',ana_avg_production:'Produ√ß√£o M√©dia',ana_trend:'Tend√™ncia',ana_kpi_evolution:'Evolu√ß√£o KPI',ana_no_snapshots:'Sem snapshots. Salve snapshots pelo Dashboard.',
ops_title:'Opera√ß√µes',ops_checklist:'Checklist Di√°rio',ops_logbook:'Di√°rio de Bordo',ops_personnel:'Pessoal',ops_task:'Tarefa',ops_done:'Conclu√≠do',ops_add_task:'Adicionar Tarefa',ops_check_date:'Data',ops_log_entry:'Entrada',ops_log_category:'Categoria',ops_log_add:'Nova Entrada',
ops_log_cat_general:'Geral',ops_log_cat_health:'Sanidade',ops_log_cat_production:'Produ√ß√£o',ops_log_cat_maintenance:'Manuten√ß√£o',ops_log_cat_observation:'Observa√ß√£o',
ops_per_name:'Nome',ops_per_role:'Cargo',ops_per_salary:'Sal√°rio',ops_per_start:'Data de In√≠cio',ops_per_active:'Ativo',ops_per_add:'Adicionar Pessoal',
env_title:'Condi√ß√µes Ambientais',env_add:'Novo Registro',env_temp:'Temperatura (¬∞C)',env_humidity:'Umidade (%)',env_light:'Horas de Luz',env_ventilation:'Ventila√ß√£o',env_density:'Densidade (aves/m¬≤)',env_optimal:'Faixa Ideal',env_temp_range:'18-24¬∞C',env_humidity_range:'40-70%',env_light_range:'14-16 hrs',env_density_range:'4-5 aves/m¬≤',
cfg_title:'Configura√ß√£o',cfg_farm:'Dados da Granja',cfg_farm_name:'Nome da Granja',cfg_location:'Localiza√ß√£o',cfg_capacity:'Capacidade (aves)',cfg_currency:'Moeda',cfg_alerts:'Limites de Alertas',cfg_min_feed:'Estoque M√≠n. Ra√ß√£o (kg)',cfg_max_mortality:'Mortalidade M√°x. (%)',cfg_alert_days:'Dias de Anteced√™ncia',cfg_data:'Dados',cfg_export:'Exportar (JSON)',cfg_import:'Importar (JSON)',cfg_reset:'Excluir Tudo',cfg_reset_confirm:'Excluir TODOS os dados permanentemente?',cfg_saved:'Salvo',cfg_exported:'Dados exportados',cfg_imported:'Dados importados',cfg_reset_done:'Dados exclu√≠dos',cfg_checklist:'Checklist Padr√£o',cfg_checklist_items:'Tarefas do checklist di√°rio',cfg_theme:'Tema de Cor',cfg_theme_blue:'Azul Marinho',cfg_theme_green:'Verde',cfg_theme_purple:'Roxo',cfg_theme_black:'Preto',
sidebar_subtitle:'Sistema Av√≠cola 360¬∞',prod_shell_white:'Branco',prod_shell_brown:'Marrom',prod_shell_cream:'Creme',required:'Campo obrigat√≥rio',no_flocks_birthdate:'Nenhum lote com data de nascimento',vac_select_flocks:'Selecione lotes para gerar calend√°rio:',feed_type_placeholder:'Postura, Inicial, etc.',avg_per_day:'M√©d/dia',per_flock:'Lote',history:'Hist√≥rico',env_latest_reading:'√öltima Leitura',env_ok:'OK',env_out_of_range:'Fora da faixa',data_stats:'Estat√≠sticas de Dados',final_warning:'‚ö†Ô∏è AVISO FINAL ‚Äî TODOS os dados ser√£o exclu√≠dos',total_salaries:'Total Sal√°rios',eggs_unit:'ovos',csv_income:'Receita',csv_expense:'Despesa',fcr_unit:'kg ra√ß√£o/kg ovo',lc_feed_starter:'Inicial',lc_feed_grower:'Crescimento',lc_feed_developer:'Desenvolvimento',lc_feed_prelay:'Pr√©-postura',lc_feed_layer:'Postura',lc_feed_lowlay:'Postura baixa',lc_prod_label:'Prod',lc_prod_first:'Primeiros ovos',lc_mile_1:'Vacinas Marek, Newcastle+BI, Gumboro',lc_mile_2:'Newcastle refor√ßo, desenvolvimento plumagem',lc_mile_3:'Var√≠ola, Encefalomielite, Coriza, Salmonela',lc_mile_4:'Newcastle+BI refor√ßo, mudan√ßa dieta, 16h luz',lc_mile_5:'Pico produ√ß√£o sem 26-30, monitorar FCR',lc_mile_6:'Newcastle refor√ßo a cada 8-12 sem, avaliar rentabilidade',lc_mile_7:'Avaliar descarte vs muda for√ßada',lc_mile_8:'Venda ave descarte, limpeza galp√£o',vac_route_injection:'Inje√ß√£o',vac_route_ocular:'Ocular/spray',vac_route_water:'√Ågua',vac_route_wing:'Pun√ß√£o alar',snapshots:'snapshots',error_prefix:'Erro',chk_collect_eggs:'Coletar ovos',chk_feed_birds:'Alimentar aves',chk_check_water:'Verificar √°gua',chk_check_health:'Verificar sa√∫de',chk_cleaning:'Limpeza',chk_record_temp:'Registrar temperatura'
}};

// ============ LIFECYCLE ROADMAP ============
const LIFECYCLE=[
{stage:'pollito',key:'lc_pollito',weekStart:0,weekEnd:4,color:'#FFF9C4',icon:'üê£',feed:'lc_feed_starter',temp:'32-35¬∞C',prod:'-',milestones:'lc_mile_1'},
{stage:'cria',key:'lc_cria',weekStart:4,weekEnd:8,color:'#FFECB3',icon:'üê§',feed:'lc_feed_grower',temp:'28-32¬∞C',prod:'-',milestones:'lc_mile_2'},
{stage:'recria',key:'lc_recria',weekStart:8,weekEnd:18,color:'#C8E6C9',icon:'üêî',feed:'lc_feed_developer',temp:'22-28¬∞C',prod:'-',milestones:'lc_mile_3'},
{stage:'pre_postura',key:'lc_prepostura',weekStart:18,weekEnd:20,color:'#B3E5FC',icon:'üêî',feed:'lc_feed_prelay',temp:'20-24¬∞C',prod:'lc_prod_first',milestones:'lc_mile_4'},
{stage:'postura_pico',key:'lc_pico',weekStart:20,weekEnd:42,color:'#A5D6A7',icon:'ü•ö',feed:'lc_feed_layer',temp:'18-24¬∞C',prod:'90-95%',milestones:'lc_mile_5'},
{stage:'postura_media',key:'lc_media',weekStart:42,weekEnd:62,color:'#FFCC80',icon:'ü•ö',feed:'lc_feed_layer',temp:'18-24¬∞C',prod:'80-90%',milestones:'lc_mile_6'},
{stage:'postura_baja',key:'lc_baja',weekStart:62,weekEnd:80,color:'#FFAB91',icon:'ü•ö',feed:'lc_feed_lowlay',temp:'18-24¬∞C',prod:'<80%',milestones:'lc_mile_7'},
{stage:'descarte',key:'lc_descarte',weekStart:80,weekEnd:999,color:'#BDBDBD',icon:'üì¶',feed:'-',temp:'-',prod:'-',milestones:'lc_mile_8'}
];

// ============ THEMES ============
const THEMES={
blue:{primary:'#1A3C6E','primary-light':'#4A7AB5','primary-dark':'#0E2240','sidebar-bg':'#0E2240',rgb:'26,60,110'},
green:{primary:'#2E7D32','primary-light':'#4CAF50','primary-dark':'#1B5E20','sidebar-bg':'#1B5E20',rgb:'46,125,50'},
purple:{primary:'#6A1B9A','primary-light':'#AB47BC','primary-dark':'#4A148C','sidebar-bg':'#4A148C',rgb:'106,27,154'},
black:{primary:'#37474F','primary-light':'#607D8B','primary-dark':'#263238','sidebar-bg':'#263238',rgb:'55,71,79'}
};
function applyTheme(name){
const th=THEMES[name]||THEMES.blue;const s=document.documentElement.style;
s.setProperty('--primary',th.primary);s.setProperty('--primary-light',th['primary-light']);
s.setProperty('--primary-dark',th['primary-dark']);s.setProperty('--sidebar-bg',th['sidebar-bg']);
s.setProperty('--primary-hover','rgba('+th.rgb+',.04)');s.setProperty('--primary-ring','rgba('+th.rgb+',.15)');
s.setProperty('--primary-fill','rgba('+th.rgb+',.1)');localStorage.setItem('egglogu_theme',name);
Object.keys(CHARTS).forEach(k=>{if(CHARTS[k]){try{CHARTS[k].destroy();}catch(e){}}});CHARTS={};
}
function themeColor(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
function themeRgba(a){const th=THEMES[localStorage.getItem('egglogu_theme')||'blue']||THEMES.blue;return'rgba('+th.rgb+','+a+')';}

// ============ CORE ============
let LANG=localStorage.getItem('egglogu_lang')||'es';
let DATA=null;let CHARTS={};let currentSection='dashboard';
let currentSanidadTab='vaccines';let currentFinanceTab='income';let currentOpsTab='checklist';
const $=id=>document.getElementById(id);
function t(k){return(T[LANG]&&T[LANG][k])||(T.es&&T.es[k])||k;}
function fmtNum(n,d=0){const loc=LANG==='es'?'es-CL':LANG==='pt'?'pt-BR':'en-US';return Number(n||0).toLocaleString(loc,{minimumFractionDigits:d,maximumFractionDigits:d});}
function fmtMoney(n){return currency()+fmtNum(n,0);}
function fmtDate(d){if(!d)return'-';const loc=LANG==='es'?'es-CL':LANG==='pt'?'pt-BR':'en-US';return new Date(d+'T12:00:00').toLocaleDateString(loc);}
function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5);}
function currency(){return(DATA||loadData()).farm.currency||'$';}
function todayStr(){return new Date().toISOString().substring(0,10);}

// ============ DATA MODEL ============
const DEFAULT_DATA={
farm:{name:'Mi Granja',location:'',capacity:500,currency:'$'},
flocks:[],dailyProduction:[],vaccines:[],medications:[],outbreaks:[],
feed:{purchases:[],consumption:[]},clients:[],
finances:{income:[],expenses:[],receivables:[]},
environment:[],checklist:[],logbook:[],personnel:[],
kpiSnapshots:[],
settings:{minFeedStock:50,maxMortality:5,alertDaysBefore:3,
defaultChecklist:['chk_collect_eggs','chk_feed_birds','chk_check_water','chk_check_health','chk_cleaning','chk_record_temp']}
};
function loadData(){
if(DATA)return DATA;
try{const r=localStorage.getItem('egglogu_data');
if(r){DATA=JSON.parse(r);
for(const k of Object.keys(DEFAULT_DATA)){if(!(k in DATA))DATA[k]=JSON.parse(JSON.stringify(DEFAULT_DATA[k]));}
if(!DATA.feed.purchases)DATA.feed.purchases=[];if(!DATA.feed.consumption)DATA.feed.consumption=[];
if(!DATA.finances.receivables)DATA.finances.receivables=[];
['medications','outbreaks','clients','checklist','logbook','personnel','kpiSnapshots'].forEach(k=>{if(!DATA[k])DATA[k]=[];});
}else{DATA=JSON.parse(JSON.stringify(DEFAULT_DATA));}
}catch(e){DATA=JSON.parse(JSON.stringify(DEFAULT_DATA));}
return DATA;
}
function saveData(d){DATA=d||DATA;localStorage.setItem('egglogu_data',JSON.stringify(DATA));}

function activeHens(){const D=loadData();let n=0;D.flocks.forEach(f=>{if(f.status!=='descarte')n+=activeHensByFlock(f.id);});return n;}
function activeHensByFlock(fid){
const D=loadData();const f=D.flocks.find(x=>x.id===fid);if(!f)return 0;
const deaths=D.dailyProduction.filter(p=>p.flockId===fid).reduce((s,p)=>s+(p.deaths||0),0);
const oD=D.outbreaks.filter(o=>o.flockId===fid).reduce((s,o)=>s+(o.deaths||0),0);
return Math.max(0,(f.count||0)-deaths-oD);
}
function flockAge(f){if(!f.birthDate)return{days:0,weeks:0};const d=Math.floor((new Date()-new Date(f.birthDate+'T12:00:00'))/864e5);return{days:Math.max(0,d),weeks:Math.max(0,Math.floor(d/7))};}
function flockLifecycleStage(f){const w=flockAge(f).weeks;return LIFECYCLE.find(l=>w>=l.weekStart&&w<l.weekEnd)||LIFECYCLE[LIFECYCLE.length-1];}
function healthScore(fid){
const D=loadData();const f=D.flocks.find(x=>x.id===fid);if(!f)return 0;
const td=D.dailyProduction.filter(p=>p.flockId===fid).reduce((s,p)=>s+(p.deaths||0),0);
const mPct=f.count>0?(td/f.count)*100:0;const mS=Math.max(0,100-mPct*10);
const l7=D.dailyProduction.filter(p=>p.flockId===fid).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const hens=activeHensByFlock(fid);let pS=50;
if(l7.length>0&&hens>0){const avg=l7.reduce((s,p)=>s+(p.eggsCollected||0),0)/l7.length;pS=Math.min(100,(avg/hens)*125);}
let fS=80;const l7f=D.feed.consumption.filter(c=>c.flockId===fid).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
if(l7f.length>0&&l7.length>0&&hens>0){const aF=l7f.reduce((s,c)=>s+(c.quantityKg||0),0)/l7f.length;const aE=(l7.reduce((s,p)=>s+(p.eggsCollected||0),0)/l7.length*0.06);const fcr=aE>0?aF/aE:99;fS=fcr<2?100:fcr<2.5?80:fcr<3?60:fcr<4?40:20;}
const ao=D.outbreaks.filter(o=>o.flockId===fid&&o.status==='active').length;const oS=ao===0?100:ao===1?40:0;
return Math.round(mS*0.3+pS*0.3+fS*0.2+oS*0.2);
}
function healthBadge(s){return `<span class="health-score ${s>=70?'good':s>=40?'warn':'bad'}">${s}</span>`;}
function statusBadge(st){
const m={cria:'info',recria:'warning',produccion:'success',descarte:'secondary',active:'danger',controlled:'warning',resolved:'success',pending:'warning',applied:'success',overdue:'danger'};
const lb={cria:t('flock_status_cria'),recria:t('flock_status_recria'),produccion:t('flock_status_produccion'),descarte:t('flock_status_descarte'),active:t('out_active'),controlled:t('out_controlled'),resolved:t('out_resolved'),pending:t('vac_pending'),applied:t('vac_applied_status'),overdue:t('vac_overdue')};
return `<span class="badge badge-${m[st]||'secondary'}">${lb[st]||st}</span>`;
}

// ============ KPI SNAPSHOT SYSTEM ============
function computeKpiSnapshot(){
const D=loadData();const hens=activeHens();const today=todayStr();
const tp=D.dailyProduction.filter(p=>p.date===today);
const eggsToday=tp.reduce((s,p)=>s+(p.eggsCollected||0),0);
const henDay=hens>0?((eggsToday/hens)*100):0;
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const p30=D.dailyProduction.filter(p=>p.date>=d30s);const te30=p30.reduce((s,p)=>s+(p.eggsCollected||0),0);
const teKg=te30*0.06;const f30=D.feed.consumption.filter(c=>c.date>=d30s);const tfKg=f30.reduce((s,c)=>s+(c.quantityKg||0),0);
const fcr=teKg>0?(tfKg/teKg):0;
const tDeaths=D.dailyProduction.reduce((s,p)=>s+(p.deaths||0),0);const tInit=D.flocks.reduce((s,f)=>s+(f.count||0),0);
const mort=tInit>0?((tDeaths/tInit)*100):0;
const tExp=D.finances.expenses.reduce((s,e)=>s+(e.amount||0),0);const tEggs=D.dailyProduction.reduce((s,p)=>s+(p.eggsCollected||0),0);
const cpe=tEggs>0?tExp/tEggs:0;
const mo=today.substring(0,7);
const mInc=D.finances.income.filter(i=>i.date&&i.date.startsWith(mo)).reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
const mExp=D.finances.expenses.filter(e=>e.date&&e.date.startsWith(mo)).reduce((s,e)=>s+(e.amount||0),0);
const stock=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0)-D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0);
return{date:today,activeHens:hens,eggsToday,henDay:Math.round(henDay*10)/10,fcr:Math.round(fcr*100)/100,
mortality:Math.round(mort*10)/10,costPerEgg:Math.round(cpe*100)/100,netIncome:mInc-mExp,feedStock:Math.round(stock*10)/10,
totalFlocks:D.flocks.filter(f=>f.status!=='descarte').length,activeOutbreaks:D.outbreaks.filter(o=>o.status==='active').length};
}
function saveKpiSnapshot(){
const D=loadData();const snap={id:genId(),...computeKpiSnapshot()};
D.kpiSnapshots.push(snap);saveData(D);toast(t('cfg_saved'));renderDashboard();
}
function snapshotDelta(current,previous){
if(!previous)return'';const diff=current-previous;
if(Math.abs(diff)<0.01)return `<span class="snapshot-badge snapshot-same">= </span>`;
return diff>0?`<span class="snapshot-badge snapshot-up">‚ñ≤ ${fmtNum(diff,1)}</span>`:`<span class="snapshot-badge snapshot-down">‚ñº ${fmtNum(Math.abs(diff),1)}</span>`;
}

// ============ VACCINE SCHEDULE ============
const VACCINE_SCHEDULE=[
{name:'Marek',ageDays:1,route:'vac_route_injection'},{name:'Newcastle + Bronquitis Infecciosa',ageDays:6,route:'vac_route_ocular'},
{name:'Gumboro (IBD)',ageDays:14,route:'vac_route_water'},{name:'Newcastle refuerzo',ageDays:21,route:'vac_route_water'},
{name:'Viruela Aviar',ageDays:49,route:'vac_route_wing'},{name:'Encefalomielitis Aviar',ageDays:63,route:'vac_route_water'},
{name:'Coriza Infecciosa',ageDays:77,route:'vac_route_injection'},{name:'Salmonella',ageDays:91,route:'vac_route_injection'},
{name:'Newcastle + BI pre-postura',ageDays:112,route:'vac_route_injection'}
];
function generateVaccineCalendar(flock){
const D=loadData();if(!flock.birthDate)return;const birth=new Date(flock.birthDate+'T12:00:00');
VACCINE_SCHEDULE.forEach(vs=>{const sd=new Date(birth.getTime()+vs.ageDays*864e5);
if(!D.vaccines.find(v=>v.flockId===flock.id&&v.vaccineName===vs.name)){
D.vaccines.push({id:genId(),flockId:flock.id,vaccineName:vs.name,scheduledDate:sd.toISOString().substring(0,10),appliedDate:'',batchNumber:'',route:vs.route,notes:'',status:'pending'});}});
saveData(D);
}

// ============ UI HELPERS ============
function nav(section){
currentSection=section;document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
$('sec-'+section).classList.add('active');
document.querySelectorAll('#main-nav a').forEach(a=>a.classList.toggle('active',a.dataset.section===section));
$('sidebar').classList.remove('open');
const R={dashboard:renderDashboard,produccion:renderProduction,lotes:renderFlocks,sanidad:renderSanidad,alimento:renderFeed,clientes:renderClients,finanzas:renderFinances,analisis:renderAnalysis,operaciones:renderOperations,ambiente:renderEnvironment,config:renderConfig};
if(R[section])R[section]();
}
function toggleSidebar(){$('sidebar').classList.toggle('open');}
function openModal(title,body){$('modal-title').textContent=title;$('modal-body').innerHTML=body;$('modal-overlay').classList.add('open');}
function closeModal(){$('modal-overlay').classList.remove('open');}
function toast(msg,err=false){const e=$('toast');e.textContent=msg;e.className='toast show'+(err?' error':'');setTimeout(()=>e.className='toast',3000);}
function emptyState(icon,msg,btn,act){let h=`<div class="empty-state"><div class="empty-icon">${icon}</div><p>${msg}</p>`;if(btn)h+=`<button class="btn btn-primary" onclick="${act}">${btn}</button>`;return h+'</div>';}
function switchLang(l){LANG=l;localStorage.setItem('egglogu_lang',l);$('btn-es').classList.toggle('active',l==='es');$('btn-en').classList.toggle('active',l==='en');$('btn-pt').classList.toggle('active',l==='pt');document.querySelectorAll('[data-t]').forEach(el=>el.textContent=t(el.dataset.t));nav(currentSection);}
function flockSelect(sel,all=false){const D=loadData();let h=all?`<option value="">${t('all')}</option>`:'<option value="">--</option>';D.flocks.forEach(f=>{h+=`<option value="${f.id}"${f.id===sel?' selected':''}>${f.name}</option>`;});return h;}
function clientSelect(sel){const D=loadData();let h='<option value="">--</option>';D.clients.forEach(c=>{h+=`<option value="${c.id}"${c.id===sel?' selected':''}>${c.name}</option>`;});return h;}
function destroyCharts(){Object.values(CHARTS).forEach(c=>{try{c.destroy();}catch(e){}});CHARTS={};}

// ============ ALERTS ============
function getAlerts(D){
const alerts=[];const today=todayStr();const ad=D.settings.alertDaysBefore||3;
const soon=new Date();soon.setDate(soon.getDate()+ad);const soonStr=soon.toISOString().substring(0,10);
D.vaccines.filter(v=>v.status!=='applied').forEach(v=>{
const f=D.flocks.find(x=>x.id===v.flockId);const fn=f?f.name:'';
if(v.scheduledDate<today)alerts.push({type:'danger',icon:'üíâ',msg:`${t('alert_vaccine_overdue')}: ${v.vaccineName} - ${fn}`});
else if(v.scheduledDate<=soonStr)alerts.push({type:'warning',icon:'üíâ',msg:`${t('alert_vaccine_soon')}: ${v.vaccineName} - ${fn} (${fmtDate(v.scheduledDate)})`});
});
const stock=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0)-D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0);
if(stock<(D.settings.minFeedStock||50))alerts.push({type:'warning',icon:'üåæ',msg:`${t('alert_low_feed')}: ${fmtNum(stock,1)} kg`});
const tD=D.dailyProduction.reduce((s,p)=>s+(p.deaths||0),0);const tI=D.flocks.reduce((s,f)=>s+(f.count||0),0);
if(tI>0&&(tD/tI)*100>(D.settings.maxMortality||5))alerts.push({type:'danger',icon:'‚ö†Ô∏è',msg:`${t('alert_high_mortality')}: ${fmtNum((tD/tI)*100,1)}%`});
D.outbreaks.filter(o=>o.status==='active').forEach(o=>{const f=D.flocks.find(x=>x.id===o.flockId);alerts.push({type:'danger',icon:'ü¶†',msg:`${t('alert_active_outbreak')}: ${o.disease} - ${f?f.name:''}`});});
D.medications.forEach(m=>{if(m.withdrawalEnd&&m.withdrawalEnd>=today){const f=D.flocks.find(x=>x.id===m.flockId);alerts.push({type:'warning',icon:'‚è≥',msg:`${t('alert_withdrawal')}: ${m.name} - ${f?f.name:''} (${fmtDate(m.withdrawalEnd)})`});}});
return alerts;
}

// ============ DASHBOARD ============
function renderDashboard(){
const D=loadData();const today=todayStr();const snap=computeKpiSnapshot();
const prevSnap=D.kpiSnapshots.length>0?D.kpiSnapshots[D.kpiSnapshots.length-1]:null;
const alerts=getAlerts(D);
let h=`<div class="page-header"><h2>${t('dash_title')}</h2><div class="btn-group"><button class="btn btn-secondary" onclick="saveKpiSnapshot()">${t('dash_snapshot')}</button><span>${D.farm.name}</span></div></div><div class="kpi-grid">`;
h+=kpi(t('kpi_today'),fmtNum(snap.eggsToday),'','')+kpi(t('kpi_henday'),fmtNum(snap.henDay,1)+'%',fmtNum(snap.activeHens)+' '+t('kpi_active_hens').toLowerCase()+(prevSnap?snapshotDelta(snap.henDay,prevSnap.henDay):''),snap.henDay<50?'danger':snap.henDay<70?'warning':'');
h+=kpi(t('kpi_fcr'),snap.fcr>0?fmtNum(snap.fcr,2):'-',t('fcr_unit')+(prevSnap?snapshotDelta(-snap.fcr,-prevSnap.fcr):''),snap.fcr>3?'danger':snap.fcr>2.5?'warning':'');
h+=kpi(t('kpi_mortality'),fmtNum(snap.mortality,1)+'%',''+(prevSnap?snapshotDelta(-snap.mortality,-prevSnap.mortality):''),snap.mortality>5?'danger':snap.mortality>3?'warning':'');
h+=kpi(t('kpi_cost_egg'),fmtMoney(snap.costPerEgg),''+(prevSnap?snapshotDelta(-snap.costPerEgg,-prevSnap.costPerEgg):''),'accent');
h+=kpi(t('kpi_income_net'),fmtMoney(snap.netIncome),today.substring(0,7)+(prevSnap?snapshotDelta(snap.netIncome,prevSnap.netIncome):''),snap.netIncome<0?'danger':'secondary');
h+=kpi(t('kpi_active_hens'),fmtNum(snap.activeHens),snap.totalFlocks+' '+t('kpi_active_flocks').toLowerCase());
h+=kpi(t('kpi_alerts'),alerts.length.toString(),alerts.length>0?'‚ö†':'‚úì',alerts.length>0?'warning':'');
h+='</div>';
if(alerts.length){h+=`<div class="card"><h3>${t('dash_alerts')}</h3>`;alerts.forEach(a=>{h+=`<div class="alert-card alert-${a.type}">${a.icon} ${a.msg}</div>`;});h+='</div>';}
h+=`<div class="card"><h3>${t('dash_trend')}</h3><div class="chart-container"><canvas id="chart-trend"></canvas></div></div>`;
if(D.kpiSnapshots.length>1){h+=`<div class="card"><h3>${t('dash_kpi_history')} (${D.kpiSnapshots.length} ${t('snapshots')})</h3><div class="table-wrap"><table><thead><tr><th>${t('date')}</th><th>Hen-Day</th><th>FCR</th><th>${t('kpi_mortality')}</th><th>${t('kpi_cost_egg')}</th><th>${t('kpi_income_net')}</th><th>${t('kpi_active_hens')}</th></tr></thead><tbody>`;
D.kpiSnapshots.slice(-10).reverse().forEach((s,i,arr)=>{const prev=arr[i+1]||null;
h+=`<tr><td>${fmtDate(s.date)}</td><td>${fmtNum(s.henDay,1)}%${prev?snapshotDelta(s.henDay,prev.henDay):''}</td>
<td>${fmtNum(s.fcr,2)}</td><td>${fmtNum(s.mortality,1)}%</td><td>${fmtMoney(s.costPerEgg)}</td>
<td>${fmtMoney(s.netIncome)}</td><td>${fmtNum(s.activeHens)}</td></tr>`;});
h+='</tbody></table></div></div>';}
$('sec-dashboard').innerHTML=h;destroyCharts();renderTrendChart(D);
}
function kpi(label,value,sub,cls=''){return `<div class="kpi-card ${cls}"><div class="kpi-label">${label}</div><div class="kpi-value">${value}</div><div class="kpi-sub">${sub||''}</div></div>`;}
function renderTrendChart(D){
const c=document.getElementById('chart-trend');if(!c)return;
const labels=[],dE=[],dH=[];
for(let i=29;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().substring(0,10);
labels.push(ds.substring(5));const dp=D.dailyProduction.filter(p=>p.date===ds);
const eggs=dp.reduce((s,p)=>s+(p.eggsCollected||0),0);dE.push(eggs);const h=activeHens();dH.push(h>0?((eggs/h)*100):0);}
CHARTS.trend=new Chart(c,{type:'line',data:{labels,datasets:[
{label:t('prod_eggs'),data:dE,borderColor:themeColor('--primary'),backgroundColor:themeRgba(.1),fill:true,tension:.3,yAxisID:'y'},
{label:t('kpi_henday'),data:dH,borderColor:'#FF8F00',backgroundColor:'transparent',borderDash:[5,5],tension:.3,yAxisID:'y1'}
]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
scales:{y:{position:'left',title:{display:true,text:t('prod_eggs')}},y1:{position:'right',title:{display:true,text:'%'},grid:{drawOnChartArea:false},min:0,max:100}}}});
}

// ============ FLOCKS ============
function renderFlocks(){
const D=loadData();let h=`<div class="page-header"><h2>${t('flock_title')}</h2><button class="btn btn-primary" onclick="showFlockForm()">${t('flock_add')}</button></div>`;
if(!D.flocks.length){h+=emptyState('üêî',t('no_data'),t('flock_add'),'showFlockForm()');}
else{
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('flock_name')}</th><th>${t('flock_breed')}</th><th>${t('flock_count')}</th><th>${t('flock_current')}</th><th>${t('flock_age')}</th><th>${t('lc_current_stage')}</th><th>${t('flock_status')}</th><th>${t('flock_health')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.flocks.forEach(f=>{const age=flockAge(f);const cur=activeHensByFlock(f.id);const hs=healthScore(f.id);const lc=flockLifecycleStage(f);
h+=`<tr><td><strong>${f.name}</strong></td><td>${f.breed||'-'}</td><td>${fmtNum(f.count)}</td><td>${fmtNum(cur)}</td>
<td>${age.weeks} ${t('flock_weeks')} (${age.days} ${t('flock_days')})</td>
<td><span style="background:${lc.color};padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600">${lc.icon} ${t(lc.key)}</span></td>
<td>${statusBadge(f.status)}</td><td>${healthBadge(hs)}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showFlockForm('${f.id}')">${t('edit')}</button>
<button class="btn btn-sm" style="background:var(--accent);color:#fff" onclick="showFlockRoadmap('${f.id}')">${t('flock_roadmap')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteFlock('${f.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';}
$('sec-lotes').innerHTML=h;
}
function showFlockRoadmap(fid){
const D=loadData();const f=D.flocks.find(x=>x.id===fid);if(!f)return;
const age=flockAge(f);const currentLC=flockLifecycleStage(f);
let h=`<h3 style="margin-bottom:8px">${f.name} ‚Äî ${t('flock_lifecycle')}</h3>
<p style="color:var(--text-light);margin-bottom:16px">${t('flock_age')}: ${age.weeks} ${t('flock_weeks')} | ${t('lc_current_stage')}: ${currentLC.icon} ${t(currentLC.key)}</p>`;
h+='<div class="lifecycle-bar">';
const totalWeeks=80;
LIFECYCLE.forEach(l=>{
const w=Math.min(l.weekEnd,totalWeeks)-l.weekStart;const pct=(w/totalWeeks*100);
if(pct<=0)return;
const isCurrent=l.stage===currentLC.stage;
h+=`<div class="lifecycle-stage${isCurrent?' current':''}" style="width:${pct}%;background:${l.color};${isCurrent?'font-weight:800':''}" title="${t(l.key)}: ${l.weekStart}-${l.weekEnd} ${t('flock_weeks')}">${l.icon} ${t(l.key)}</div>`;
});h+='</div>';
h+='<div class="lifecycle-detail">';
LIFECYCLE.forEach(l=>{const isCurrent=l.stage===currentLC.stage;
h+=`<div class="lifecycle-card" style="background:${l.color};${isCurrent?'box-shadow:0 0 0 3px var(--primary)':''}">
<div class="lc-icon">${l.icon}</div><div class="lc-name">${t(l.key)}</div>
<div class="lc-weeks">${t('lc_weeks')}: ${l.weekStart}-${l.weekEnd===999?'80+':l.weekEnd}</div>
<div class="lc-info"><strong>${t('lc_feed')}:</strong> ${l.feed==='-'?'-':t(l.feed)}<br><strong>${t('lc_temp')}:</strong> ${l.temp}<br>
<strong>${t('lc_prod_label')}:</strong> ${l.prod.startsWith('lc_')?t(l.prod):l.prod}<br><strong>${t('lc_milestone')}:</strong> ${t(l.milestones)}</div></div>`;
});h+='</div>';
// Vaccine timeline for this flock
const vaccines=D.vaccines.filter(v=>v.flockId===fid).sort((a,b)=>a.scheduledDate.localeCompare(b.scheduledDate));
if(vaccines.length){h+=`<h3 style="margin-top:16px">${t('san_vaccines')}</h3><div class="table-wrap" style="margin-top:8px"><table><thead><tr><th>${t('vac_vaccine')}</th><th>${t('vac_scheduled')}</th><th>${t('vac_route')}</th><th>${t('status')}</th></tr></thead><tbody>`;
vaccines.forEach(v=>{h+=`<tr><td>${v.vaccineName}</td><td>${fmtDate(v.scheduledDate)}</td><td>${t(v.route)}</td><td>${statusBadge(v.status==='applied'?'applied':v.scheduledDate<todayStr()?'overdue':'pending')}</td></tr>`;});
h+='</tbody></table></div>';}
openModal(t('flock_lifecycle')+' ‚Äî '+f.name,h);
}
function showFlockForm(id){
const D=loadData();const f=id?D.flocks.find(x=>x.id===id):null;
openModal(f?t('flock_edit'):t('flock_add'),`
<div class="form-row"><div class="form-group"><label>${t('flock_name')}</label><input id="f-name" value="${f?f.name:''}"></div>
<div class="form-group"><label>${t('flock_breed')}</label><input id="f-breed" value="${f?f.breed:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('flock_count')}</label><input type="number" id="f-count" value="${f?f.count:''}"></div>
<div class="form-group"><label>${t('flock_status')}</label><select id="f-status">
<option value="cria"${f&&f.status==='cria'?' selected':''}>${t('flock_status_cria')}</option>
<option value="recria"${f&&f.status==='recria'?' selected':''}>${t('flock_status_recria')}</option>
<option value="produccion"${(!f||f.status==='produccion')?' selected':''}>${t('flock_status_produccion')}</option>
<option value="descarte"${f&&f.status==='descarte'?' selected':''}>${t('flock_status_descarte')}</option></select></div></div>
<div class="form-row"><div class="form-group"><label>${t('flock_birthdate')}</label><input type="date" id="f-birth" value="${f?f.birthDate:''}"></div>
<div class="form-group"><label>${t('flock_purchase_date')}</label><input type="date" id="f-purchase" value="${f?f.purchaseDate:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('flock_supplier')}</label><input id="f-supplier" value="${f?f.supplier:''}"></div>
<div class="form-group"><label>${t('flock_cost')}</label><input type="number" id="f-cost" value="${f?f.cost:''}"></div></div>
<div class="form-group"><label>${t('flock_notes')}</label><textarea id="f-notes">${f?f.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveFlock('${id||''}')">${t('save')}</button></div>`);
}
function saveFlock(id){
const D=loadData();const o={name:$('f-name').value,breed:$('f-breed').value,count:parseInt($('f-count').value)||0,
status:$('f-status').value,birthDate:$('f-birth').value,purchaseDate:$('f-purchase').value,
supplier:$('f-supplier').value,cost:parseFloat($('f-cost').value)||0,notes:$('f-notes').value};
if(!o.name){toast(t('flock_name'),true);return;}
if(id){const i=D.flocks.findIndex(f=>f.id===id);if(i>=0)D.flocks[i]={...D.flocks[i],...o};}
else{o.id=genId();D.flocks.push(o);if(o.birthDate)generateVaccineCalendar(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFlocks();
}
function deleteFlock(id){
if(!confirm(t('confirm_delete')))return;const D=loadData();
D.flocks=D.flocks.filter(f=>f.id!==id);D.dailyProduction=D.dailyProduction.filter(p=>p.flockId!==id);
D.vaccines=D.vaccines.filter(v=>v.flockId!==id);D.medications=D.medications.filter(m=>m.flockId!==id);
D.outbreaks=D.outbreaks.filter(o=>o.flockId!==id);D.feed.consumption=D.feed.consumption.filter(c=>c.flockId!==id);
saveData(D);toast(t('cfg_saved'));renderFlocks();
}

// ============ PRODUCTION ============
function renderProduction(){
const D=loadData();let h=`<div class="page-header"><h2>${t('prod_title')}</h2><button class="btn btn-primary" onclick="showProdForm()">${t('prod_add')}</button></div>`;
h+=`<div class="filter-bar"><select onchange="filterProd()" id="pf-flock">${flockSelect('',true)}</select>
<input type="date" id="pf-from" onchange="filterProd()"><input type="date" id="pf-to" onchange="filterProd()"></div>`;
if(!D.dailyProduction.length){h+=emptyState('ü•ö',t('no_data'),t('prod_add'),'showProdForm()');}
else{h+='<div id="prod-table"></div>';}
$('sec-produccion').innerHTML=h;if(D.dailyProduction.length)filterProd();
}
function filterProd(){
const D=loadData();const fid=$('pf-flock')?.value||'';const fr=$('pf-from')?.value||'';const to=$('pf-to')?.value||'';
let recs=D.dailyProduction.sort((a,b)=>b.date.localeCompare(a.date));
if(fid)recs=recs.filter(r=>r.flockId===fid);if(fr)recs=recs.filter(r=>r.date>=fr);if(to)recs=recs.filter(r=>r.date<=to);
let h='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('prod_flock')}</th><th>${t('prod_eggs')}</th><th>S/M/L/XL/J</th><th>${t('prod_broken')}</th><th>${t('prod_deaths')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
recs.forEach(p=>{const f=D.flocks.find(x=>x.id===p.flockId);
h+=`<tr><td>${fmtDate(p.date)}</td><td>${f?f.name:'-'}</td><td><strong>${fmtNum(p.eggsCollected)}</strong></td>
<td>${[p.eggsS||0,p.eggsM||0,p.eggsL||0,p.eggsXL||0,p.eggsJumbo||0].join('/')}</td>
<td>${fmtNum(p.eggsBroken||0)}</td><td>${p.deaths?'<span style="color:var(--danger)">'+p.deaths+'</span>':'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showProdForm('${p.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteProd('${p.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';const w=$('prod-table');if(w)w.innerHTML=h;
}
function showProdForm(id){
const D=loadData();const p=id?D.dailyProduction.find(x=>x.id===id):null;
openModal(p?t('edit'):t('prod_add'),`
<div class="form-row"><div class="form-group"><label>${t('prod_date')}</label><input type="date" id="p-date" value="${p?p.date:todayStr()}"></div>
<div class="form-group"><label>${t('prod_flock')}</label><select id="p-flock">${flockSelect(p?p.flockId:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('prod_eggs')}</label><input type="number" id="p-eggs" value="${p?p.eggsCollected:''}" min="0"></div>
<div class="form-group"><label>${t('prod_broken')}</label><input type="number" id="p-broken" value="${p?p.eggsBroken||'':''}" min="0"></div></div>
<div class="form-row-3"><div class="form-group"><label>${t('prod_size_s')}</label><input type="number" id="p-s" value="${p?p.eggsS||'':''}" min="0"></div>
<div class="form-group"><label>${t('prod_size_m')}</label><input type="number" id="p-m" value="${p?p.eggsM||'':''}" min="0"></div>
<div class="form-group"><label>${t('prod_size_l')}</label><input type="number" id="p-l" value="${p?p.eggsL||'':''}" min="0"></div></div>
<div class="form-row-3"><div class="form-group"><label>${t('prod_size_xl')}</label><input type="number" id="p-xl" value="${p?p.eggsXL||'':''}" min="0"></div>
<div class="form-group"><label>${t('prod_size_jumbo')}</label><input type="number" id="p-jumbo" value="${p?p.eggsJumbo||'':''}" min="0"></div>
<div class="form-group"><label>${t('prod_yolk')}</label><input type="number" id="p-yolk" value="${p?p.yolkScore||'':''}" min="1" max="10"></div></div>
<div class="form-row"><div class="form-group"><label>${t('prod_shell')}</label><select id="p-shell">
<option value="">--</option><option value="blanco"${p&&p.shellColor==='blanco'?' selected':''}>${t('prod_shell_white')}</option>
<option value="marron"${p&&p.shellColor==='marron'?' selected':''}>${t('prod_shell_brown')}</option>
<option value="crema"${p&&p.shellColor==='crema'?' selected':''}>${t('prod_shell_cream')}</option></select></div>
<div class="form-group"><label>${t('prod_deaths')}</label><input type="number" id="p-deaths" value="${p?p.deaths||'':''}" min="0"></div></div>
<div class="form-group"><label>${t('prod_death_cause')}</label><input id="p-cause" value="${p?p.deathCause||'':''}"></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="p-notes">${p?p.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveProd('${id||''}')">${t('save')}</button></div>`);
}
function saveProd(id){
const D=loadData();const o={date:$('p-date').value,flockId:$('p-flock').value,
eggsCollected:parseInt($('p-eggs').value)||0,eggsBroken:parseInt($('p-broken').value)||0,
eggsS:parseInt($('p-s').value)||0,eggsM:parseInt($('p-m').value)||0,eggsL:parseInt($('p-l').value)||0,
eggsXL:parseInt($('p-xl').value)||0,eggsJumbo:parseInt($('p-jumbo').value)||0,
shellColor:$('p-shell').value,yolkScore:parseInt($('p-yolk').value)||0,
deaths:parseInt($('p-deaths').value)||0,deathCause:$('p-cause').value,notes:$('p-notes').value};
if(!o.date||!o.flockId){toast(t('required'),true);return;}
if(id){const i=D.dailyProduction.findIndex(p=>p.id===id);if(i>=0)D.dailyProduction[i]={...D.dailyProduction[i],...o};}
else{o.id=genId();D.dailyProduction.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderProduction();
}
function deleteProd(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.dailyProduction=D.dailyProduction.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderProduction();}

// === SANIDAD MODULE ===
function renderSanidad(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('san_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentSanidadTab==='vaccines'?' active':''}" onclick="currentSanidadTab='vaccines';renderSanidad()">üíâ ${t('san_vaccines')}</div>
<div class="tab${currentSanidadTab==='medications'?' active':''}" onclick="currentSanidadTab='medications';renderSanidad()">üíä ${t('san_medications')}</div>
<div class="tab${currentSanidadTab==='outbreaks'?' active':''}" onclick="currentSanidadTab='outbreaks';renderSanidad()">ü¶† ${t('san_outbreaks')}</div></div>`;
if(currentSanidadTab==='vaccines')h+=renderVaccinesTab(D);
else if(currentSanidadTab==='medications')h+=renderMedicationsTab(D);
else h+=renderOutbreaksTab(D);
$('sec-sanidad').innerHTML=h;
}
function renderVaccinesTab(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('vac_title')}</h3><div class="btn-group">
<button class="btn btn-secondary btn-sm" onclick="showGenVaccines()">${t('vac_generate')}</button>
<button class="btn btn-primary btn-sm" onclick="showVaccineForm()">${t('vac_add')}</button></div></div>`;
h+=`<div class="filter-bar"><select id="vf-flock" onchange="renderSanidad()">${flockSelect('',true)}</select>
<select id="vf-status" onchange="renderSanidad()"><option value="">${t('all')}</option><option value="pending">${t('vac_pending')}</option><option value="overdue">${t('vac_overdue')}</option><option value="applied">${t('vac_applied_status')}</option></select></div>`;
const fid=document.getElementById('vf-flock')?.value||'';const st=document.getElementById('vf-status')?.value||'';
let vacs=D.vaccines.sort((a,b)=>a.scheduledDate.localeCompare(b.scheduledDate));
if(fid)vacs=vacs.filter(v=>v.flockId===fid);
const today=todayStr();
vacs=vacs.map(v=>{const eff=v.status==='applied'?'applied':v.scheduledDate<today?'overdue':'pending';return{...v,effectiveStatus:eff};});
if(st)vacs=vacs.filter(v=>v.effectiveStatus===st);
if(!vacs.length)return h+emptyState('üíâ',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('prod_flock')}</th><th>${t('vac_vaccine')}</th><th>${t('vac_route')}</th><th>${t('vac_scheduled')}</th><th>${t('vac_applied')}</th><th>${t('vac_batch')}</th><th>${t('status')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
vacs.forEach(v=>{const f=D.flocks.find(x=>x.id===v.flockId);
h+=`<tr><td>${f?f.name:'-'}</td><td>${v.vaccineName}</td><td>${v.route?t(v.route):'-'}</td><td>${fmtDate(v.scheduledDate)}</td>
<td>${v.appliedDate?fmtDate(v.appliedDate):'-'}</td><td>${v.batchNumber||'-'}</td>
<td>${statusBadge(v.effectiveStatus)}</td>
<td><div class="btn-group">${v.effectiveStatus!=='applied'?`<button class="btn btn-primary btn-sm" onclick="markVaccineApplied('${v.id}')">${t('vac_mark_applied')}</button>`:''}
<button class="btn btn-secondary btn-sm" onclick="showVaccineForm('${v.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteVaccine('${v.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showGenVaccines(){
const D=loadData();const flocks=D.flocks.filter(f=>f.birthDate&&f.status!=='descarte');
if(!flocks.length){toast(t('no_flocks_birthdate'),true);return;}
let body=`<p>${t('vac_select_flocks')}</p>`;
flocks.forEach(f=>{body+=`<div class="checklist-item"><input type="checkbox" id="gv-${f.id}" checked><span>${f.name} (${fmtDate(f.birthDate)})</span></div>`;});
body+=`<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="doGenVaccines()">${t('vac_generate')}</button></div>`;
openModal(t('vac_generate'),body);
}
function doGenVaccines(){
const D=loadData();D.flocks.filter(f=>f.birthDate&&f.status!=='descarte').forEach(f=>{
const cb=document.getElementById('gv-'+f.id);if(cb&&cb.checked)generateVaccineCalendar(f);});
closeModal();toast(t('cfg_saved'));renderSanidad();
}
function showVaccineForm(id){
const D=loadData();const v=id?D.vaccines.find(x=>x.id===id):null;
openModal(v?t('edit'):t('vac_add'),`
<div class="form-row"><div class="form-group"><label>${t('prod_flock')}</label><select id="v-flock">${flockSelect(v?v.flockId:'')}</select></div>
<div class="form-group"><label>${t('vac_vaccine')}</label><input id="v-name" value="${v?v.vaccineName:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('vac_route')}</label><input id="v-route" value="${v?t(v.route):''}"></div>
<div class="form-group"><label>${t('vac_batch')}</label><input id="v-batch" value="${v?v.batchNumber:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('vac_scheduled')}</label><input type="date" id="v-sched" value="${v?v.scheduledDate:''}"></div>
<div class="form-group"><label>${t('vac_applied')}</label><input type="date" id="v-applied" value="${v?v.appliedDate:''}"></div></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="v-notes">${v?v.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveVaccine('${id||''}')">${t('save')}</button></div>`);
}
function saveVaccine(id){
const D=loadData();const o={flockId:$('v-flock').value,vaccineName:$('v-name').value,route:$('v-route').value,
batchNumber:$('v-batch').value,scheduledDate:$('v-sched').value,appliedDate:$('v-applied').value,
notes:$('v-notes').value,status:$('v-applied').value?'applied':'pending'};
if(!o.vaccineName){toast(t('required'),true);return;}
if(id){const i=D.vaccines.findIndex(v=>v.id===id);if(i>=0)D.vaccines[i]={...D.vaccines[i],...o};}
else{o.id=genId();D.vaccines.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderSanidad();
}
function markVaccineApplied(id){
const D=loadData();const v=D.vaccines.find(x=>x.id===id);if(!v)return;
v.appliedDate=todayStr();v.status='applied';saveData(D);toast(t('cfg_saved'));renderSanidad();
}
function deleteVaccine(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.vaccines=D.vaccines.filter(v=>v.id!==id);saveData(D);toast(t('cfg_saved'));renderSanidad();}

function renderMedicationsTab(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('med_title')}</h3>
<button class="btn btn-primary btn-sm" onclick="showMedForm()">${t('med_add')}</button></div>`;
if(!D.medications.length)return h+emptyState('üíä',t('no_data'));
const today=todayStr();
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('prod_flock')}</th><th>${t('med_name')}</th><th>${t('med_reason')}</th><th>${t('med_dosage')}</th><th>${t('med_start')}</th><th>${t('med_end')}</th><th>${t('med_withdrawal')}</th><th>${t('med_withdrawal_end')}</th><th>${t('status')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.medications.forEach(m=>{const f=D.flocks.find(x=>x.id===m.flockId);
const inWD=m.withdrawalEnd&&m.withdrawalEnd>=today;
h+=`<tr><td>${f?f.name:'-'}</td><td>${m.name}</td><td>${m.reason||'-'}</td><td>${m.dosage||'-'}</td>
<td>${fmtDate(m.startDate)}</td><td>${fmtDate(m.endDate)}</td><td>${m.withdrawalDays||'-'}</td>
<td>${fmtDate(m.withdrawalEnd)}</td>
<td>${inWD?'<span class="badge badge-warning">'+t('med_in_withdrawal')+'</span>':'<span class="badge badge-success">OK</span>'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showMedForm('${m.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteMed('${m.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showMedForm(id){
const D=loadData();const m=id?D.medications.find(x=>x.id===id):null;
openModal(m?t('edit'):t('med_add'),`
<div class="form-row"><div class="form-group"><label>${t('prod_flock')}</label><select id="m-flock">${flockSelect(m?m.flockId:'')}</select></div>
<div class="form-group"><label>${t('med_name')}</label><input id="m-name" value="${m?m.name:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('med_reason')}</label><input id="m-reason" value="${m?m.reason||'':''}"></div>
<div class="form-group"><label>${t('med_dosage')}</label><input id="m-dosage" value="${m?m.dosage||'':''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('med_start')}</label><input type="date" id="m-start" value="${m?m.startDate:''}"></div>
<div class="form-group"><label>${t('med_end')}</label><input type="date" id="m-end" value="${m?m.endDate:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('med_withdrawal')}</label><input type="number" id="m-wd" value="${m?m.withdrawalDays||'':''}" min="0"></div>
<div class="form-group"><label>${t('notes')}</label><input id="m-notes" value="${m?m.notes||'':''}"></div></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveMed('${id||''}')">${t('save')}</button></div>`);
}
function saveMed(id){
const D=loadData();const o={flockId:$('m-flock').value,name:$('m-name').value,reason:$('m-reason').value,
dosage:$('m-dosage').value,startDate:$('m-start').value,endDate:$('m-end').value,
withdrawalDays:parseInt($('m-wd').value)||0,notes:$('m-notes').value};
if(!o.name){toast(t('required'),true);return;}
if(o.endDate&&o.withdrawalDays){const d=new Date(o.endDate+'T12:00:00');d.setDate(d.getDate()+o.withdrawalDays);o.withdrawalEnd=d.toISOString().substring(0,10);}else{o.withdrawalEnd='';}
if(id){const i=D.medications.findIndex(m=>m.id===id);if(i>=0)D.medications[i]={...D.medications[i],...o};}
else{o.id=genId();D.medications.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderSanidad();
}
function deleteMed(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.medications=D.medications.filter(m=>m.id!==id);saveData(D);toast(t('cfg_saved'));renderSanidad();}

function renderOutbreaksTab(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('out_title')}</h3>
<button class="btn btn-primary btn-sm" onclick="showOutbreakForm()">${t('out_add')}</button></div>`;
if(!D.outbreaks.length)return h+emptyState('ü¶†',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('prod_flock')}</th><th>${t('out_disease')}</th><th>${t('out_start')}</th><th>${t('out_end')}</th><th>${t('out_affected')}</th><th>${t('out_deaths')}</th><th>${t('out_loss')}</th><th>${t('status')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.outbreaks.forEach(o=>{const f=D.flocks.find(x=>x.id===o.flockId);
h+=`<tr><td>${f?f.name:'-'}</td><td>${o.disease}</td><td>${fmtDate(o.startDate)}</td><td>${fmtDate(o.endDate)}</td>
<td>${fmtNum(o.affected||0)}</td><td>${o.deaths?'<span style="color:var(--danger)">'+o.deaths+'</span>':'-'}</td>
<td>${fmtMoney(o.economicLoss||0)}</td><td>${statusBadge(o.status)}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showOutbreakForm('${o.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteOutbreak('${o.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showOutbreakForm(id){
const D=loadData();const o=id?D.outbreaks.find(x=>x.id===id):null;
openModal(o?t('edit'):t('out_add'),`
<div class="form-row"><div class="form-group"><label>${t('prod_flock')}</label><select id="o-flock">${flockSelect(o?o.flockId:'')}</select></div>
<div class="form-group"><label>${t('out_disease')}</label><input id="o-disease" value="${o?o.disease:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('out_start')}</label><input type="date" id="o-start" value="${o?o.startDate:todayStr()}"></div>
<div class="form-group"><label>${t('out_end')}</label><input type="date" id="o-end" value="${o?o.endDate||'':''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('out_affected')}</label><input type="number" id="o-affected" value="${o?o.affected||'':''}" min="0"></div>
<div class="form-group"><label>${t('out_deaths')}</label><input type="number" id="o-deaths" value="${o?o.deaths||'':''}" min="0"></div></div>
<div class="form-row"><div class="form-group"><label>${t('out_loss')}</label><input type="number" id="o-loss" value="${o?o.economicLoss||'':''}" min="0"></div>
<div class="form-group"><label>${t('status')}</label><select id="o-status">
<option value="active"${o&&o.status==='active'?' selected':''}>${t('out_active')}</option>
<option value="controlled"${o&&o.status==='controlled'?' selected':''}>${t('out_controlled')}</option>
<option value="resolved"${o&&o.status==='resolved'?' selected':''}>${t('out_resolved')}</option></select></div></div>
<div class="form-group"><label>${t('out_symptoms')}</label><textarea id="o-symptoms">${o?o.symptoms||'':''}</textarea></div>
<div class="form-group"><label>${t('out_treatment')}</label><textarea id="o-treatment">${o?o.treatment||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveOutbreak('${id||''}')">${t('save')}</button></div>`);
}
function saveOutbreak(id){
const D=loadData();const o={flockId:$('o-flock').value,disease:$('o-disease').value,startDate:$('o-start').value,
endDate:$('o-end').value,affected:parseInt($('o-affected').value)||0,deaths:parseInt($('o-deaths').value)||0,
economicLoss:parseFloat($('o-loss').value)||0,status:$('o-status').value,
symptoms:$('o-symptoms').value,treatment:$('o-treatment').value};
if(!o.disease){toast(t('required'),true);return;}
if(id){const i=D.outbreaks.findIndex(x=>x.id===id);if(i>=0)D.outbreaks[i]={...D.outbreaks[i],...o};}
else{o.id=genId();D.outbreaks.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderSanidad();
}
function deleteOutbreak(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.outbreaks=D.outbreaks.filter(o=>o.id!==id);saveData(D);toast(t('cfg_saved'));renderSanidad();}
// === END SANIDAD ===

// === FEED MODULE ===
let currentFeedTab='purchases';
function renderFeed(){
const D=loadData();
const totalPurchased=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0);
const totalConsumed=D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0);
const stock=totalPurchased-totalConsumed;
const isLow=stock<(D.settings.minFeedStock||50);
let h=`<div class="page-header"><h2>${t('feed_title')}</h2></div>`;
h+=`<div class="kpi-grid">`;
h+=kpi(t('feed_stock'),fmtNum(stock,1)+' kg','',isLow?'danger':'');
h+=kpi(t('feed_purchases'),fmtNum(totalPurchased,1)+' kg',fmtMoney(D.feed.purchases.reduce((s,p)=>s+(p.cost||0),0))+' '+t('total'));
h+=kpi(t('feed_consumption'),fmtNum(totalConsumed,1)+' kg','');
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const f30=D.feed.consumption.filter(c=>c.date>=d30s);const tF30=f30.reduce((s,c)=>s+(c.quantityKg||0),0);
const p30=D.dailyProduction.filter(p=>p.date>=d30s);const tE30=p30.reduce((s,p)=>s+(p.eggsCollected||0),0)*0.06;
const fcr=tE30>0?(tF30/tE30):0;
h+=kpi(t('kpi_fcr'),fcr>0?fmtNum(fcr,2):'-','30d',fcr>3?'danger':fcr>2.5?'warning':'');
h+='</div>';
h+=`<div class="tabs"><div class="tab${currentFeedTab==='purchases'?' active':''}" onclick="currentFeedTab='purchases';renderFeed()">üì¶ ${t('feed_purchases')}</div>
<div class="tab${currentFeedTab==='consumption'?' active':''}" onclick="currentFeedTab='consumption';renderFeed()">üçΩÔ∏è ${t('feed_consumption')}</div></div>`;
if(currentFeedTab==='purchases')h+=renderFeedPurchases(D);
else h+=renderFeedConsumption(D);
$('sec-alimento').innerHTML=h;
}
function renderFeedPurchases(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('feed_purchases')}</h3>
<button class="btn btn-primary btn-sm" onclick="showFeedPurchaseForm()">${t('feed_add_purchase')}</button></div>`;
if(!D.feed.purchases.length)return h+emptyState('üì¶',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('feed_type')}</th><th>${t('feed_qty')}</th><th>${t('feed_cost')}</th><th>$/kg</th><th>${t('feed_supplier')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.feed.purchases.sort((a,b)=>b.date.localeCompare(a.date)).forEach(p=>{
const ppkg=p.quantityKg>0?(p.cost/p.quantityKg):0;
h+=`<tr><td>${fmtDate(p.date)}</td><td>${p.type||'-'}</td><td>${fmtNum(p.quantityKg,1)}</td>
<td>${fmtMoney(p.cost)}</td><td>${fmtMoney(ppkg)}</td><td>${p.supplier||'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showFeedPurchaseForm('${p.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteFeedPurchase('${p.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showFeedPurchaseForm(id){
const D=loadData();const p=id?D.feed.purchases.find(x=>x.id===id):null;
openModal(p?t('edit'):t('feed_add_purchase'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fp-date" value="${p?p.date:todayStr()}"></div>
<div class="form-group"><label>${t('feed_type')}</label><input id="fp-type" value="${p?p.type||'':''}" placeholder="${t('feed_type_placeholder')}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('feed_qty')}</label><input type="number" id="fp-qty" value="${p?p.quantityKg:''}" step="0.1" min="0"></div>
<div class="form-group"><label>${t('feed_cost')}</label><input type="number" id="fp-cost" value="${p?p.cost:''}" min="0"></div></div>
<div class="form-group"><label>${t('feed_supplier')}</label><input id="fp-sup" value="${p?p.supplier||'':''}"></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveFeedPurchase('${id||''}')">${t('save')}</button></div>`);
}
function saveFeedPurchase(id){
const D=loadData();const o={date:$('fp-date').value,type:$('fp-type').value,
quantityKg:parseFloat($('fp-qty').value)||0,cost:parseFloat($('fp-cost').value)||0,supplier:$('fp-sup').value};
if(!o.date){toast(t('required'),true);return;}
if(id){const i=D.feed.purchases.findIndex(p=>p.id===id);if(i>=0)D.feed.purchases[i]={...D.feed.purchases[i],...o};}
else{o.id=genId();D.feed.purchases.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFeed();
}
function deleteFeedPurchase(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.feed.purchases=D.feed.purchases.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderFeed();}

function renderFeedConsumption(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('feed_consumption')}</h3>
<button class="btn btn-primary btn-sm" onclick="showFeedConsForm()">${t('feed_add_consumption')}</button></div>`;
if(!D.feed.consumption.length)return h+emptyState('üçΩÔ∏è',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('feed_flock')}</th><th>${t('feed_qty')}</th><th>${t('feed_type')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.feed.consumption.sort((a,b)=>b.date.localeCompare(a.date)).forEach(c=>{const f=D.flocks.find(x=>x.id===c.flockId);
h+=`<tr><td>${fmtDate(c.date)}</td><td>${f?f.name:'-'}</td><td>${fmtNum(c.quantityKg,1)} kg</td><td>${c.type||'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showFeedConsForm('${c.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteFeedCons('${c.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showFeedConsForm(id){
const D=loadData();const c=id?D.feed.consumption.find(x=>x.id===id):null;
openModal(c?t('edit'):t('feed_add_consumption'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fc-date" value="${c?c.date:todayStr()}"></div>
<div class="form-group"><label>${t('feed_flock')}</label><select id="fc-flock">${flockSelect(c?c.flockId:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('feed_qty')}</label><input type="number" id="fc-qty" value="${c?c.quantityKg:''}" step="0.1" min="0"></div>
<div class="form-group"><label>${t('feed_type')}</label><input id="fc-type" value="${c?c.type||'':''}" placeholder="${t('feed_type_placeholder')}"></div></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveFeedCons('${id||''}')">${t('save')}</button></div>`);
}
function saveFeedCons(id){
const D=loadData();const o={date:$('fc-date').value,flockId:$('fc-flock').value,
quantityKg:parseFloat($('fc-qty').value)||0,type:$('fc-type').value};
if(!o.date||!o.flockId){toast(t('required'),true);return;}
if(id){const i=D.feed.consumption.findIndex(c=>c.id===id);if(i>=0)D.feed.consumption[i]={...D.feed.consumption[i],...o};}
else{o.id=genId();D.feed.consumption.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFeed();
}
function deleteFeedCons(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.feed.consumption=D.feed.consumption.filter(c=>c.id!==id);saveData(D);toast(t('cfg_saved'));renderFeed();}
// === END FEED ===

// === CLIENTS MODULE ===
function renderClients(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('cli_title')}</h2><button class="btn btn-primary" onclick="showClientForm()">${t('cli_add')}</button></div>`;
h+=`<div class="kpi-grid">${kpi(t('cli_total'),fmtNum(D.clients.length))}</div>`;
if(!D.clients.length){h+=emptyState('üë•',t('no_data'),t('cli_add'),'showClientForm()');}
else{
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('name')}</th><th>${t('phone')}</th><th>${t('email')}</th><th>${t('cli_route')}</th><th>${t('cli_price')} (S/M/L/XL/J)</th><th>${t('notes')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.clients.forEach(c=>{
const prices=[c.priceS||'-',c.priceM||'-',c.priceL||'-',c.priceXL||'-',c.priceJumbo||'-'].join(' / ');
h+=`<tr><td><strong>${c.name}</strong></td><td>${c.phone||'-'}</td><td>${c.email||'-'}</td><td>${c.route||'-'}</td>
<td>${prices}</td><td>${c.notes||'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showClientForm('${c.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteClient('${c.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';}
$('sec-clientes').innerHTML=h;
}
function showClientForm(id){
const D=loadData();const c=id?D.clients.find(x=>x.id===id):null;
openModal(c?t('edit'):t('cli_add'),`
<div class="form-row"><div class="form-group"><label>${t('name')}</label><input id="cl-name" value="${c?c.name:''}"></div>
<div class="form-group"><label>${t('phone')}</label><input id="cl-phone" value="${c?c.phone||'':''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('email')}</label><input id="cl-email" value="${c?c.email||'':''}"></div>
<div class="form-group"><label>${t('cli_route')}</label><input id="cl-route" value="${c?c.route||'':''}"></div></div>
<div class="form-group"><label>${t('address')}</label><input id="cl-addr" value="${c?c.address||'':''}"></div>
<p style="font-weight:600;margin:12px 0 8px">${t('cli_price')} (${currency()}/huevo)</p>
<div class="form-row-3"><div class="form-group"><label>S</label><input type="number" id="cl-ps" value="${c?c.priceS||'':''}" step="1" min="0"></div>
<div class="form-group"><label>M</label><input type="number" id="cl-pm" value="${c?c.priceM||'':''}" step="1" min="0"></div>
<div class="form-group"><label>L</label><input type="number" id="cl-pl" value="${c?c.priceL||'':''}" step="1" min="0"></div></div>
<div class="form-row"><div class="form-group"><label>XL</label><input type="number" id="cl-pxl" value="${c?c.priceXL||'':''}" step="1" min="0"></div>
<div class="form-group"><label>Jumbo</label><input type="number" id="cl-pj" value="${c?c.priceJumbo||'':''}" step="1" min="0"></div></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="cl-notes">${c?c.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveClient('${id||''}')">${t('save')}</button></div>`);
}
function saveClient(id){
const D=loadData();const o={name:$('cl-name').value,phone:$('cl-phone').value,email:$('cl-email').value,
route:$('cl-route').value,address:$('cl-addr').value,
priceS:parseFloat($('cl-ps').value)||0,priceM:parseFloat($('cl-pm').value)||0,priceL:parseFloat($('cl-pl').value)||0,
priceXL:parseFloat($('cl-pxl').value)||0,priceJumbo:parseFloat($('cl-pj').value)||0,notes:$('cl-notes').value};
if(!o.name){toast(t('required'),true);return;}
if(id){const i=D.clients.findIndex(c=>c.id===id);if(i>=0)D.clients[i]={...D.clients[i],...o};}
else{o.id=genId();D.clients.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderClients();
}
function deleteClient(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.clients=D.clients.filter(c=>c.id!==id);saveData(D);toast(t('cfg_saved'));renderClients();}
// === END CLIENTS ===

// === FINANCES MODULE ===
function renderFinances(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('fin_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentFinanceTab==='income'?' active':''}" onclick="currentFinanceTab='income';renderFinances()">üìà ${t('fin_income')}</div>
<div class="tab${currentFinanceTab==='expenses'?' active':''}" onclick="currentFinanceTab='expenses';renderFinances()">üìâ ${t('fin_expenses')}</div>
<div class="tab${currentFinanceTab==='receivables'?' active':''}" onclick="currentFinanceTab='receivables';renderFinances()">üìã ${t('fin_receivables')}</div>
<div class="tab${currentFinanceTab==='summary'?' active':''}" onclick="currentFinanceTab='summary';renderFinances()">üìä ${t('fin_summary')}</div></div>`;
if(currentFinanceTab==='income')h+=renderFinIncome(D);
else if(currentFinanceTab==='expenses')h+=renderFinExpenses(D);
else if(currentFinanceTab==='receivables')h+=renderFinReceivables(D);
else h+=renderFinSummary(D);
$('sec-finanzas').innerHTML=h;
}
function renderFinIncome(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('fin_income')}</h3>
<button class="btn btn-primary btn-sm" onclick="showIncomeForm()">${t('fin_add_income')}</button></div>`;
if(!D.finances.income.length)return h+emptyState('üìà',t('no_data'));
const tot=D.finances.income.reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
h+=`<div class="kpi-grid">${kpi(t('fin_total_income'),fmtMoney(tot))}</div>`;
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('fin_type')}</th><th>${t('fin_qty')}</th><th>${t('fin_unit_price')}</th><th>${t('total')}</th><th>${t('fin_client')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.finances.income.sort((a,b)=>b.date.localeCompare(a.date)).forEach(i=>{
const cl=D.clients.find(c=>c.id===i.clientId);const amt=(i.quantity||0)*(i.unitPrice||0)||(i.amount||0);
h+=`<tr><td>${fmtDate(i.date)}</td><td>${t('fin_type_'+i.type)||i.type||'-'}</td><td>${fmtNum(i.quantity||0)}</td>
<td>${fmtMoney(i.unitPrice||0)}</td><td><strong>${fmtMoney(amt)}</strong></td><td>${cl?cl.name:i.clientName||'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showIncomeForm('${i.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteIncome('${i.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showIncomeForm(id){
const D=loadData();const i=id?D.finances.income.find(x=>x.id===id):null;
openModal(i?t('edit'):t('fin_add_income'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fi-date" value="${i?i.date:todayStr()}"></div>
<div class="form-group"><label>${t('fin_type')}</label><select id="fi-type">
<option value="eggs"${i&&i.type==='eggs'?' selected':''}>${t('fin_type_eggs')}</option>
<option value="birds"${i&&i.type==='birds'?' selected':''}>${t('fin_type_birds')}</option>
<option value="manure"${i&&i.type==='manure'?' selected':''}>${t('fin_type_manure')}</option>
<option value="other"${i&&i.type==='other'?' selected':''}>${t('fin_type_other')}</option></select></div></div>
<div class="form-row"><div class="form-group"><label>${t('fin_qty')}</label><input type="number" id="fi-qty" value="${i?i.quantity||'':''}" min="0"></div>
<div class="form-group"><label>${t('fin_unit_price')}</label><input type="number" id="fi-price" value="${i?i.unitPrice||'':''}" min="0"></div></div>
<div class="form-group"><label>${t('fin_client')}</label><select id="fi-client">${clientSelect(i?i.clientId:'')}</select></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="fi-notes">${i?i.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveIncome('${id||''}')">${t('save')}</button></div>`);
}
function saveIncome(id){
const D=loadData();const o={date:$('fi-date').value,type:$('fi-type').value,
quantity:parseInt($('fi-qty').value)||0,unitPrice:parseFloat($('fi-price').value)||0,
clientId:$('fi-client').value,notes:$('fi-notes').value};
if(!o.date){toast(t('required'),true);return;}
if(id){const i=D.finances.income.findIndex(x=>x.id===id);if(i>=0)D.finances.income[i]={...D.finances.income[i],...o};}
else{o.id=genId();D.finances.income.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFinances();
}
function deleteIncome(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.finances.income=D.finances.income.filter(i=>i.id!==id);saveData(D);toast(t('cfg_saved'));renderFinances();}

function renderFinExpenses(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('fin_expenses')}</h3>
<button class="btn btn-primary btn-sm" onclick="showExpenseForm()">${t('fin_add_expense')}</button></div>`;
if(!D.finances.expenses.length)return h+emptyState('üìâ',t('no_data'));
const tot=D.finances.expenses.reduce((s,e)=>s+(e.amount||0),0);
h+=`<div class="kpi-grid">${kpi(t('fin_total_expenses'),fmtMoney(tot),'','danger')}</div>`;
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('fin_category')}</th><th>${t('fin_description')}</th><th>${t('fin_amount')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.finances.expenses.sort((a,b)=>b.date.localeCompare(a.date)).forEach(e=>{
h+=`<tr><td>${fmtDate(e.date)}</td><td>${t('fin_cat_'+e.category)||e.category||'-'}</td><td>${e.description||'-'}</td>
<td><strong>${fmtMoney(e.amount)}</strong></td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showExpenseForm('${e.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteExpense('${e.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showExpenseForm(id){
const D=loadData();const e=id?D.finances.expenses.find(x=>x.id===id):null;
const cats=['feed','vaccines','transport','labor','infrastructure','other'];
openModal(e?t('edit'):t('fin_add_expense'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fe-date" value="${e?e.date:todayStr()}"></div>
<div class="form-group"><label>${t('fin_category')}</label><select id="fe-cat">${cats.map(c=>`<option value="${c}"${e&&e.category===c?' selected':''}>${t('fin_cat_'+c)}</option>`).join('')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('fin_description')}</label><input id="fe-desc" value="${e?e.description||'':''}"></div>
<div class="form-group"><label>${t('fin_amount')}</label><input type="number" id="fe-amt" value="${e?e.amount:''}" min="0"></div></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="fe-notes">${e?e.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveExpense('${id||''}')">${t('save')}</button></div>`);
}
function saveExpense(id){
const D=loadData();const o={date:$('fe-date').value,category:$('fe-cat').value,
description:$('fe-desc').value,amount:parseFloat($('fe-amt').value)||0,notes:$('fe-notes').value};
if(!o.date){toast(t('required'),true);return;}
if(id){const i=D.finances.expenses.findIndex(e=>e.id===id);if(i>=0)D.finances.expenses[i]={...D.finances.expenses[i],...o};}
else{o.id=genId();D.finances.expenses.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFinances();
}
function deleteExpense(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.finances.expenses=D.finances.expenses.filter(e=>e.id!==id);saveData(D);toast(t('cfg_saved'));renderFinances();}

function renderFinReceivables(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('fin_receivables')}</h3>
<button class="btn btn-primary btn-sm" onclick="showReceivableForm()">${t('fin_add_receivable')}</button></div>`;
if(!D.finances.receivables.length)return h+emptyState('üìã',t('no_data'));
const pending=D.finances.receivables.filter(r=>!r.paid);const tot=pending.reduce((s,r)=>s+(r.amount||0),0);
h+=`<div class="kpi-grid">${kpi(t('fin_receivables'),fmtMoney(tot),pending.length+' '+t('vac_pending').toLowerCase(),'warning')}</div>`;
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('fin_client')}</th><th>${t('fin_description')}</th><th>${t('fin_amount')}</th><th>${t('fin_due_date')}</th><th>${t('fin_paid')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.finances.receivables.sort((a,b)=>b.date.localeCompare(a.date)).forEach(r=>{
const cl=D.clients.find(c=>c.id===r.clientId);
h+=`<tr><td>${fmtDate(r.date)}</td><td>${cl?cl.name:r.clientName||'-'}</td><td>${r.description||'-'}</td>
<td><strong>${fmtMoney(r.amount)}</strong></td><td>${fmtDate(r.dueDate)}</td>
<td><input type="checkbox" ${r.paid?'checked':''} onchange="toggleReceivablePaid('${r.id}',this.checked)"></td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showReceivableForm('${r.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteReceivable('${r.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showReceivableForm(id){
const D=loadData();const r=id?D.finances.receivables.find(x=>x.id===id):null;
openModal(r?t('edit'):t('fin_add_receivable'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fr-date" value="${r?r.date:todayStr()}"></div>
<div class="form-group"><label>${t('fin_due_date')}</label><input type="date" id="fr-due" value="${r?r.dueDate||'':''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('fin_client')}</label><select id="fr-client">${clientSelect(r?r.clientId:'')}</select></div>
<div class="form-group"><label>${t('fin_amount')}</label><input type="number" id="fr-amt" value="${r?r.amount:''}" min="0"></div></div>
<div class="form-group"><label>${t('fin_description')}</label><input id="fr-desc" value="${r?r.description||'':''}"></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveReceivable('${id||''}')">${t('save')}</button></div>`);
}
function saveReceivable(id){
const D=loadData();const o={date:$('fr-date').value,dueDate:$('fr-due').value,clientId:$('fr-client').value,
amount:parseFloat($('fr-amt').value)||0,description:$('fr-desc').value,paid:false};
if(!o.date){toast(t('required'),true);return;}
if(id){const i=D.finances.receivables.findIndex(r=>r.id===id);if(i>=0){o.paid=D.finances.receivables[i].paid;D.finances.receivables[i]={...D.finances.receivables[i],...o};}}
else{o.id=genId();D.finances.receivables.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFinances();
}
function toggleReceivablePaid(id,paid){const D=loadData();const r=D.finances.receivables.find(x=>x.id===id);if(r){r.paid=paid;saveData(D);}}
function deleteReceivable(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.finances.receivables=D.finances.receivables.filter(r=>r.id!==id);saveData(D);toast(t('cfg_saved'));renderFinances();}

function renderFinSummary(D){
const mo=todayStr().substring(0,7);
const mInc=D.finances.income.filter(i=>i.date&&i.date.startsWith(mo)).reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
const mExp=D.finances.expenses.filter(e=>e.date&&e.date.startsWith(mo)).reduce((s,e)=>s+(e.amount||0),0);
const net=mInc-mExp;
const tEggs=D.dailyProduction.reduce((s,p)=>s+(p.eggsCollected||0),0);
const tExp=D.finances.expenses.reduce((s,e)=>s+(e.amount||0),0);
const cpe=tEggs>0?tExp/tEggs:0;
const avgPrice=D.finances.income.length>0?D.finances.income.reduce((s,i)=>s+(i.unitPrice||0),0)/D.finances.income.length:0;
const breakEven=avgPrice>0?Math.ceil(tExp/avgPrice):0;
let h=`<div class="kpi-grid">`;
h+=kpi(t('fin_total_income')+' ('+mo+')',fmtMoney(mInc),'','secondary');
h+=kpi(t('fin_total_expenses')+' ('+mo+')',fmtMoney(mExp),'','danger');
h+=kpi(t('fin_net')+' ('+mo+')',fmtMoney(net),'',net<0?'danger':'');
h+=kpi(t('fin_cost_per_egg'),fmtMoney(cpe),'global','accent');
h+=kpi(t('fin_break_even'),fmtNum(breakEven)+' '+t('eggs_unit'),'global','warning');
h+='</div>';
// Monthly breakdown
const months={};D.finances.income.forEach(i=>{const m=i.date?.substring(0,7);if(!m)return;if(!months[m])months[m]={income:0,expenses:0};months[m].income+=(i.quantity||0)*(i.unitPrice||0)||(i.amount||0);});
D.finances.expenses.forEach(e=>{const m=e.date?.substring(0,7);if(!m)return;if(!months[m])months[m]={income:0,expenses:0};months[m].expenses+=(e.amount||0);});
const mKeys=Object.keys(months).sort().reverse();
if(mKeys.length){
h+='<div class="card"><h3>'+t('fin_summary')+' '+t('fin_month')+'</h3><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('fin_month')}</th><th>${t('fin_income')}</th><th>${t('fin_expenses')}</th><th>${t('fin_net')}</th></tr></thead><tbody>`;
mKeys.forEach(m=>{const d=months[m];const n=d.income-d.expenses;
h+=`<tr><td>${m}</td><td style="color:var(--success)">${fmtMoney(d.income)}</td><td style="color:var(--danger)">${fmtMoney(d.expenses)}</td>
<td style="font-weight:700;color:${n<0?'var(--danger)':'var(--success)'}">${fmtMoney(n)}</td></tr>`;});
h+='</tbody></table></div></div>';}
// Expense by category
const cats={};D.finances.expenses.forEach(e=>{const c=e.category||'other';cats[c]=(cats[c]||0)+(e.amount||0);});
if(Object.keys(cats).length){
h+='<div class="card"><h3>'+t('fin_expenses')+' / '+t('fin_category')+'</h3>';
Object.entries(cats).sort((a,b)=>b[1]-a[1]).forEach(([c,v])=>{const pct=tExp>0?(v/tExp*100):0;
h+=`<div class="stat-row"><span class="stat-label">${t('fin_cat_'+c)||c}</span><span class="stat-value">${fmtMoney(v)} (${fmtNum(pct,1)}%)</span></div>`;});
h+='</div>';}
// CSV export
h+=`<div class="card"><button class="btn btn-secondary" onclick="exportFinCSV()">${t('export_csv')}</button></div>`;
return h;
}
function exportFinCSV(){
const D=loadData();let csv=t('fin_type')+','+t('date')+','+t('fin_category')+','+t('fin_description')+','+t('fin_qty')+','+t('fin_unit_price')+','+t('fin_amount')+'\n';
D.finances.income.forEach(i=>{const a=(i.quantity||0)*(i.unitPrice||0);csv+=`${t('csv_income')},${i.date},${i.type||''},${(i.notes||'').replace(/,/g,';')},${i.quantity||0},${i.unitPrice||0},${a}\n`;});
D.finances.expenses.forEach(e=>{csv+=`${t('csv_expense')},${e.date},${e.category||''},${(e.description||'').replace(/,/g,';')},,,${e.amount||0}\n`;});
const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);
a.download='egglogu_finanzas_'+todayStr()+'.csv';a.click();toast(t('cfg_exported'));
}
// === END FINANCES ===

// === ANALYSIS MODULE ===
let currentAnaTab='comparison';
function renderAnalysis(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('ana_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentAnaTab==='comparison'?' active':''}" onclick="currentAnaTab='comparison';renderAnalysis()">üîÑ ${t('ana_comparison')}</div>
<div class="tab${currentAnaTab==='seasonality'?' active':''}" onclick="currentAnaTab='seasonality';renderAnalysis()">üìÖ ${t('ana_seasonality')}</div>
<div class="tab${currentAnaTab==='profitability'?' active':''}" onclick="currentAnaTab='profitability';renderAnalysis()">üí∞ ${t('ana_profitability')}</div>
<div class="tab${currentAnaTab==='kpi_evo'?' active':''}" onclick="currentAnaTab='kpi_evo';renderAnalysis()">üìä ${t('ana_kpi_evolution')}</div></div>`;
if(currentAnaTab==='comparison')h+=renderAnaComparison(D);
else if(currentAnaTab==='seasonality')h+=renderAnaSeasonality(D);
else if(currentAnaTab==='profitability')h+=renderAnaProfitability(D);
else h+=renderAnaKpiEvo(D);
$('sec-analisis').innerHTML=h;
}
function renderAnaComparison(D){
if(!D.flocks.length)return emptyState('üîÑ',t('no_data'));
let h='<div class="card"><h3>'+t('ana_comparison')+'</h3><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('flock_name')}</th><th>${t('flock_count')}</th><th>${t('flock_current')}</th><th>${t('kpi_henday')} (7d)</th><th>FCR (30d)</th><th>${t('kpi_mortality')} %</th><th>${t('flock_health')}</th></tr></thead><tbody>`;
const stats=D.flocks.map(f=>{
const cur=activeHensByFlock(f.id);const l7=D.dailyProduction.filter(p=>p.flockId===f.id).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const avgE=l7.length>0?l7.reduce((s,p)=>s+(p.eggsCollected||0),0)/l7.length:0;
const hd=cur>0?(avgE/cur*100):0;
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const f30=D.feed.consumption.filter(c=>c.flockId===f.id&&c.date>=d30s);const e30=D.dailyProduction.filter(p=>p.flockId===f.id&&p.date>=d30s);
const tfkg=f30.reduce((s,c)=>s+(c.quantityKg||0),0);const tekg=e30.reduce((s,p)=>s+(p.eggsCollected||0),0)*0.06;
const fcr=tekg>0?tfkg/tekg:0;
const deaths=D.dailyProduction.filter(p=>p.flockId===f.id).reduce((s,p)=>s+(p.deaths||0),0);
const mort=f.count>0?(deaths/f.count*100):0;const hs=healthScore(f.id);
return{f,cur,hd,fcr,mort,hs};
});
stats.sort((a,b)=>b.hd-a.hd);
stats.forEach(s=>{
h+=`<tr><td><strong>${s.f.name}</strong></td><td>${fmtNum(s.f.count)}</td><td>${fmtNum(s.cur)}</td>
<td style="color:${s.hd>=80?'var(--success)':s.hd>=60?'var(--warning)':'var(--danger)'}">${fmtNum(s.hd,1)}%</td>
<td>${s.fcr>0?fmtNum(s.fcr,2):'-'}</td><td>${fmtNum(s.mort,1)}%</td><td>${healthBadge(s.hs)}</td></tr>`;});
h+='</tbody></table></div></div>';
if(stats.length>=2){
h+=`<div class="kpi-grid">${kpi(t('ana_best_flock'),stats[0].f.name,'Hen-Day: '+fmtNum(stats[0].hd,1)+'%')}`;
h+=kpi(t('ana_worst_flock'),stats[stats.length-1].f.name,'Hen-Day: '+fmtNum(stats[stats.length-1].hd,1)+'%','danger');
h+='</div>';}
return h;
}
function renderAnaSeasonality(D){
const months={};D.dailyProduction.forEach(p=>{const m=p.date?.substring(5,7);if(!m)return;if(!months[m])months[m]={eggs:0,days:new Set()};months[m].eggs+=(p.eggsCollected||0);months[m].days.add(p.date);});
if(!Object.keys(months).length)return emptyState('üìÖ',t('no_data'));
const mNames=LANG==='es'?['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic']:LANG==='pt'?['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez']:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
let h='<div class="card"><h3>'+t('ana_seasonality')+'</h3><div class="chart-container"><canvas id="chart-season"></canvas></div></div>';
h+='<div class="card"><div class="table-wrap"><table><thead><tr><th>'+t('fin_month')+'</th><th>'+t('prod_eggs')+'</th><th>'+t('avg_per_day')+'</th></tr></thead><tbody>';
for(let i=1;i<=12;i++){const k=String(i).padStart(2,'0');const d=months[k];
const avg=d?Math.round(d.eggs/d.days.size):0;
h+=`<tr><td>${mNames[i-1]}</td><td>${d?fmtNum(d.eggs):'-'}</td><td>${d?fmtNum(avg):'-'}</td></tr>`;}
h+='</tbody></table></div></div>';
$('sec-analisis').innerHTML?.includes('chart-season')||setTimeout(()=>{
const c=document.getElementById('chart-season');if(!c)return;
const labels=mNames;const vals=[];for(let i=1;i<=12;i++){const k=String(i).padStart(2,'0');const d=months[k];vals.push(d?Math.round(d.eggs/d.days.size):0);}
CHARTS.season=new Chart(c,{type:'bar',data:{labels,datasets:[{label:t('avg_per_day'),data:vals,backgroundColor:themeColor('--primary-light')}]},options:{responsive:true,maintainAspectRatio:false}});
},100);
return h;
}
function renderAnaProfitability(D){
if(!D.flocks.length)return emptyState('üí∞',t('no_data'));
let h='<div class="card"><h3>'+t('ana_profitability')+' / '+t('per_flock')+'</h3><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('flock_name')}</th><th>${t('prod_eggs')}</th><th>${t('fin_income')}</th><th>${t('fin_expenses')}</th><th>${t('fin_net')}</th><th>${t('fin_cost_per_egg')}</th></tr></thead><tbody>`;
D.flocks.forEach(f=>{
const eggs=D.dailyProduction.filter(p=>p.flockId===f.id).reduce((s,p)=>s+(p.eggsCollected||0),0);
const feedCost=D.feed.consumption.filter(c=>c.flockId===f.id).reduce((s,c)=>{
const price=D.feed.purchases.length>0?D.feed.purchases.reduce((s,p)=>s+(p.cost||0),0)/D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0):0;
return s+(c.quantityKg||0)*price;},0);
const inc=eggs*(D.finances.income.length>0?D.finances.income.reduce((s,i)=>s+(i.unitPrice||0),0)/D.finances.income.length:0);
const net=inc-feedCost-(f.cost||0);const cpe=eggs>0?(feedCost+(f.cost||0))/eggs:0;
h+=`<tr><td><strong>${f.name}</strong></td><td>${fmtNum(eggs)}</td><td style="color:var(--success)">${fmtMoney(inc)}</td>
<td style="color:var(--danger)">${fmtMoney(feedCost+(f.cost||0))}</td>
<td style="font-weight:700;color:${net<0?'var(--danger)':'var(--success)'}">${fmtMoney(net)}</td><td>${fmtMoney(cpe)}</td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function renderAnaKpiEvo(D){
if(!D.kpiSnapshots.length)return emptyState('üìä',t('ana_no_snapshots'));
let h='<div class="card"><h3>'+t('ana_kpi_evolution')+'</h3><div class="chart-container"><canvas id="chart-kpi-evo"></canvas></div></div>';
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('kpi_active_hens')}</th><th>Hen-Day %</th><th>FCR</th><th>${t('kpi_mortality')} %</th><th>${t('kpi_cost_egg')}</th><th>${t('kpi_income_net')}</th></tr></thead><tbody>`;
D.kpiSnapshots.slice(-20).reverse().forEach(s=>{
h+=`<tr><td>${fmtDate(s.date)}</td><td>${fmtNum(s.activeHens)}</td><td>${fmtNum(s.henDay,1)}%</td>
<td>${fmtNum(s.fcr,2)}</td><td>${fmtNum(s.mortality,1)}%</td><td>${fmtMoney(s.costPerEgg)}</td><td>${fmtMoney(s.netIncome)}</td></tr>`;});
h+='</tbody></table></div></div>';
setTimeout(()=>{
const c=document.getElementById('chart-kpi-evo');if(!c)return;
const snaps=D.kpiSnapshots.slice(-30);
CHARTS.kpiEvo=new Chart(c,{type:'line',data:{labels:snaps.map(s=>s.date.substring(5)),datasets:[
{label:'Hen-Day %',data:snaps.map(s=>s.henDay),borderColor:themeColor('--primary'),tension:.3,yAxisID:'y'},
{label:'FCR',data:snaps.map(s=>s.fcr),borderColor:'#FF8F00',tension:.3,yAxisID:'y1'},
{label:t('kpi_mortality')+' %',data:snaps.map(s=>s.mortality),borderColor:'#C62828',tension:.3,yAxisID:'y'}
]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
scales:{y:{position:'left',min:0},y1:{position:'right',grid:{drawOnChartArea:false}}}}});
},100);
return h;
}
// === END ANALYSIS ===

// === OPERATIONS MODULE ===
function renderOperations(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('ops_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentOpsTab==='checklist'?' active':''}" onclick="currentOpsTab='checklist';renderOperations()">‚úÖ ${t('ops_checklist')}</div>
<div class="tab${currentOpsTab==='logbook'?' active':''}" onclick="currentOpsTab='logbook';renderOperations()">üìì ${t('ops_logbook')}</div>
<div class="tab${currentOpsTab==='personnel'?' active':''}" onclick="currentOpsTab='personnel';renderOperations()">üë∑ ${t('ops_personnel')}</div></div>`;
if(currentOpsTab==='checklist')h+=renderOpsChecklist(D);
else if(currentOpsTab==='logbook')h+=renderOpsLogbook(D);
else h+=renderOpsPersonnel(D);
$('sec-operaciones').innerHTML=h;
}
function renderOpsChecklist(D){
const today=todayStr();
let todayItems=D.checklist.filter(c=>c.date===today);
if(!todayItems.length&&D.settings.defaultChecklist){
D.settings.defaultChecklist.forEach(task=>{
D.checklist.push({id:genId(),date:today,task,done:false});});
todayItems=D.checklist.filter(c=>c.date===today);saveData(D);
}
const done=todayItems.filter(c=>c.done).length;const total=todayItems.length;
let h=`<div class="kpi-grid">${kpi(t('ops_done'),done+'/'+total,total>0?fmtNum(done/total*100,0)+'%':'',done===total&&total>0?'':'warning')}</div>`;
h+=`<div class="card"><h3>${t('ops_checklist')} ‚Äî ${fmtDate(today)}</h3>`;
todayItems.forEach(c=>{
h+=`<div class="checklist-item${c.done?' done':''}"><input type="checkbox" ${c.done?'checked':''} onchange="toggleCheck('${c.id}',this.checked)"><span>${t(c.task)}</span>
<button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="deleteCheck('${c.id}')">‚úï</button></div>`;});
h+=`<div style="margin-top:12px;display:flex;gap:8px"><input id="new-task" placeholder="${t('ops_task')}" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:var(--radius)">
<button class="btn btn-primary btn-sm" onclick="addCheckTask()">${t('add')}</button></div></div>`;
// History
const dates=[...new Set(D.checklist.map(c=>c.date))].sort().reverse().filter(d=>d!==today).slice(0,7);
if(dates.length){
h+='<div class="card"><h3>'+t('history')+'</h3>';
dates.forEach(d=>{const items=D.checklist.filter(c=>c.date===d);const dn=items.filter(c=>c.done).length;
h+=`<div class="stat-row"><span class="stat-label">${fmtDate(d)}</span><span class="stat-value">${dn}/${items.length} (${items.length>0?fmtNum(dn/items.length*100,0):0}%)</span></div>`;});
h+='</div>';}
return h;
}
function toggleCheck(id,done){const D=loadData();const c=D.checklist.find(x=>x.id===id);if(c){c.done=done;saveData(D);renderOperations();}}
function deleteCheck(id){const D=loadData();D.checklist=D.checklist.filter(c=>c.id!==id);saveData(D);renderOperations();}
function addCheckTask(){const v=$('new-task')?.value;if(!v)return;const D=loadData();D.checklist.push({id:genId(),date:todayStr(),task:v,done:false});saveData(D);renderOperations();}

function renderOpsLogbook(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('ops_logbook')}</h3>
<button class="btn btn-primary btn-sm" onclick="showLogForm()">${t('ops_log_add')}</button></div>`;
if(!D.logbook.length)return h+emptyState('üìì',t('no_data'));
const cats=['general','health','production','maintenance','observation'];
h+=`<div class="filter-bar"><select id="lf-cat" onchange="renderOperations()"><option value="">${t('all')}</option>${cats.map(c=>`<option value="${c}">${t('ops_log_cat_'+c)}</option>`).join('')}</select></div>`;
const selCat=document.getElementById('lf-cat')?.value||'';
let logs=D.logbook.sort((a,b)=>b.date.localeCompare(a.date));
if(selCat)logs=logs.filter(l=>l.category===selCat);
h+='<div class="card">';
logs.forEach(l=>{
h+=`<div class="alert-card alert-info" style="flex-wrap:wrap"><div style="flex:1"><strong>${fmtDate(l.date)}</strong> ‚Äî <span class="badge badge-info">${t('ops_log_cat_'+l.category)||l.category}</span>
<p style="margin-top:4px">${l.entry}</p></div>
<div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showLogForm('${l.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteLog('${l.id}')">${t('delete')}</button></div></div>`;});
h+='</div>';return h;
}
function showLogForm(id){
const D=loadData();const l=id?D.logbook.find(x=>x.id===id):null;
const cats=['general','health','production','maintenance','observation'];
openModal(l?t('edit'):t('ops_log_add'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="lg-date" value="${l?l.date:todayStr()}"></div>
<div class="form-group"><label>${t('ops_log_category')}</label><select id="lg-cat">${cats.map(c=>`<option value="${c}"${l&&l.category===c?' selected':''}>${t('ops_log_cat_'+c)}</option>`).join('')}</select></div></div>
<div class="form-group"><label>${t('ops_log_entry')}</label><textarea id="lg-entry" rows="4">${l?l.entry||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveLog('${id||''}')">${t('save')}</button></div>`);
}
function saveLog(id){
const D=loadData();const o={date:$('lg-date').value,category:$('lg-cat').value,entry:$('lg-entry').value};
if(!o.entry){toast(t('required'),true);return;}
if(id){const i=D.logbook.findIndex(l=>l.id===id);if(i>=0)D.logbook[i]={...D.logbook[i],...o};}
else{o.id=genId();D.logbook.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderOperations();
}
function deleteLog(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.logbook=D.logbook.filter(l=>l.id!==id);saveData(D);toast(t('cfg_saved'));renderOperations();}

function renderOpsPersonnel(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('ops_personnel')}</h3>
<button class="btn btn-primary btn-sm" onclick="showPersonnelForm()">${t('ops_per_add')}</button></div>`;
if(!D.personnel.length)return h+emptyState('üë∑',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('ops_per_name')}</th><th>${t('ops_per_role')}</th><th>${t('ops_per_salary')}</th><th>${t('ops_per_start')}</th><th>${t('ops_per_active')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.personnel.forEach(p=>{
h+=`<tr><td><strong>${p.name}</strong></td><td>${p.role||'-'}</td><td>${fmtMoney(p.salary||0)}</td><td>${fmtDate(p.startDate)}</td>
<td>${p.active?'<span class="badge badge-success">'+t('active')+'</span>':'<span class="badge badge-secondary">'+t('inactive')+'</span>'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showPersonnelForm('${p.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deletePersonnel('${p.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';
const totalSalary=D.personnel.filter(p=>p.active).reduce((s,p)=>s+(p.salary||0),0);
h+=`<div class="kpi-grid">${kpi(t('total_salaries'),fmtMoney(totalSalary),D.personnel.filter(p=>p.active).length+' '+t('active').toLowerCase())}</div>`;
return h;
}
function showPersonnelForm(id){
const D=loadData();const p=id?D.personnel.find(x=>x.id===id):null;
openModal(p?t('edit'):t('ops_per_add'),`
<div class="form-row"><div class="form-group"><label>${t('ops_per_name')}</label><input id="pe-name" value="${p?p.name:''}"></div>
<div class="form-group"><label>${t('ops_per_role')}</label><input id="pe-role" value="${p?p.role||'':''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('ops_per_salary')}</label><input type="number" id="pe-salary" value="${p?p.salary||'':''}" min="0"></div>
<div class="form-group"><label>${t('ops_per_start')}</label><input type="date" id="pe-start" value="${p?p.startDate||'':''}"></div></div>
<div class="form-group"><label>${t('ops_per_active')}</label><select id="pe-active">
<option value="1"${!p||p.active?' selected':''}>${t('active')}</option>
<option value="0"${p&&!p.active?' selected':''}>${t('inactive')}</option></select></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="pe-notes">${p?p.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="savePersonnel('${id||''}')">${t('save')}</button></div>`);
}
function savePersonnel(id){
const D=loadData();const o={name:$('pe-name').value,role:$('pe-role').value,
salary:parseFloat($('pe-salary').value)||0,startDate:$('pe-start').value,
active:$('pe-active').value==='1',notes:$('pe-notes').value};
if(!o.name){toast(t('required'),true);return;}
if(id){const i=D.personnel.findIndex(p=>p.id===id);if(i>=0)D.personnel[i]={...D.personnel[i],...o};}
else{o.id=genId();D.personnel.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderOperations();
}
function deletePersonnel(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.personnel=D.personnel.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderOperations();}
// === END OPERATIONS ===

// === ENVIRONMENT MODULE ===
function renderEnvironment(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('env_title')}</h2><button class="btn btn-primary" onclick="showEnvForm()">${t('env_add')}</button></div>`;
// Optimal ranges reference
h+=`<div class="card"><h3>${t('env_optimal')}</h3><div class="kpi-grid">
${kpi(t('env_temp'),t('env_temp_range'),'','')}</div><div class="kpi-grid">
${kpi(t('env_humidity'),t('env_humidity_range'),'','')}
${kpi(t('env_light'),t('env_light_range'),'','')}
${kpi(t('env_density'),t('env_density_range'),'','')}</div></div>`;
// Latest reading
const latest=D.environment.sort((a,b)=>b.date.localeCompare(a.date))[0];
if(latest){
const tOk=latest.temperature>=18&&latest.temperature<=24;const hOk=latest.humidity>=40&&latest.humidity<=70;
const lOk=latest.lightHours>=14&&latest.lightHours<=16;
h+=`<div class="card"><h3>${t('env_latest_reading')} (${fmtDate(latest.date)})</h3><div class="kpi-grid">`;
h+=`<div class="kpi-card ${tOk?'':'danger'}"><div class="kpi-label">${t('env_temp')}</div><div class="kpi-value">${latest.temperature||'-'}¬∞C</div><div class="kpi-sub">${tOk?'‚úì '+t('env_ok'):'‚ö† '+t('env_out_of_range')}</div></div>`;
h+=`<div class="kpi-card ${hOk?'':'warning'}"><div class="kpi-label">${t('env_humidity')}</div><div class="kpi-value">${latest.humidity||'-'}%</div><div class="kpi-sub">${hOk?'‚úì '+t('env_ok'):'‚ö† '+t('env_out_of_range')}</div></div>`;
h+=`<div class="kpi-card ${lOk?'':'warning'}"><div class="kpi-label">${t('env_light')}</div><div class="kpi-value">${latest.lightHours||'-'} hrs</div><div class="kpi-sub">${lOk?'‚úì '+t('env_ok'):'‚ö† '+t('env_out_of_range')}</div></div>`;
h+='</div></div>';}
if(!D.environment.length){h+=emptyState('üå°Ô∏è',t('no_data'),t('env_add'),'showEnvForm()');}
else{
h+='<div class="card"><h3>'+t('history')+'</h3><div class="chart-container"><canvas id="chart-env"></canvas></div></div>';
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('env_temp')}</th><th>${t('env_humidity')}</th><th>${t('env_light')}</th><th>${t('env_ventilation')}</th><th>${t('notes')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.environment.sort((a,b)=>b.date.localeCompare(a.date)).forEach(e=>{
const tOk=e.temperature>=18&&e.temperature<=24;const hOk=e.humidity>=40&&e.humidity<=70;
h+=`<tr><td>${fmtDate(e.date)}</td><td style="color:${tOk?'var(--success)':'var(--danger)'}">${e.temperature||'-'}¬∞C</td>
<td style="color:${hOk?'var(--success)':'var(--warning)'}">${e.humidity||'-'}%</td>
<td>${e.lightHours||'-'} hrs</td><td>${e.ventilation||'-'}</td><td>${e.notes||'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showEnvForm('${e.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteEnv('${e.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';
setTimeout(()=>{
const c=document.getElementById('chart-env');if(!c)return;
const recs=D.environment.sort((a,b)=>a.date.localeCompare(b.date)).slice(-30);
CHARTS.env=new Chart(c,{type:'line',data:{labels:recs.map(r=>r.date.substring(5)),datasets:[
{label:t('env_temp')+' ¬∞C',data:recs.map(r=>r.temperature),borderColor:'#C62828',tension:.3,yAxisID:'y'},
{label:t('env_humidity')+' %',data:recs.map(r=>r.humidity),borderColor:themeColor('--primary'),tension:.3,yAxisID:'y1'}
]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
scales:{y:{position:'left',title:{display:true,text:'¬∞C'}},y1:{position:'right',title:{display:true,text:'%'},grid:{drawOnChartArea:false}}}}});
},100);}
$('sec-ambiente').innerHTML=h;
}
function showEnvForm(id){
const D=loadData();const e=id?D.environment.find(x=>x.id===id):null;
openModal(e?t('edit'):t('env_add'),`
<div class="form-group"><label>${t('date')}</label><input type="date" id="en-date" value="${e?e.date:todayStr()}"></div>
<div class="form-row"><div class="form-group"><label>${t('env_temp')}</label><input type="number" id="en-temp" value="${e?e.temperature||'':''}" step="0.1"></div>
<div class="form-group"><label>${t('env_humidity')}</label><input type="number" id="en-hum" value="${e?e.humidity||'':''}" step="1" min="0" max="100"></div></div>
<div class="form-row"><div class="form-group"><label>${t('env_light')}</label><input type="number" id="en-light" value="${e?e.lightHours||'':''}" step="0.5" min="0" max="24"></div>
<div class="form-group"><label>${t('env_ventilation')}</label><input id="en-vent" value="${e?e.ventilation||'':''}"></div></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="en-notes">${e?e.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveEnv('${id||''}')">${t('save')}</button></div>`);
}
function saveEnv(id){
const D=loadData();const o={date:$('en-date').value,temperature:parseFloat($('en-temp').value)||null,
humidity:parseFloat($('en-hum').value)||null,lightHours:parseFloat($('en-light').value)||null,
ventilation:$('en-vent').value,notes:$('en-notes').value};
if(!o.date){toast(t('required'),true);return;}
if(id){const i=D.environment.findIndex(e=>e.id===id);if(i>=0)D.environment[i]={...D.environment[i],...o};}
else{o.id=genId();D.environment.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderEnvironment();
}
function deleteEnv(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.environment=D.environment.filter(e=>e.id!==id);saveData(D);toast(t('cfg_saved'));renderEnvironment();}
// === END ENVIRONMENT ===

// === CONFIG MODULE ===
function renderConfig(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('cfg_title')}</h2></div>`;
// Theme picker
const curTheme=localStorage.getItem('egglogu_theme')||'blue';
h+='<div class="card"><h3>'+t('cfg_theme')+'</h3><div style="display:flex;gap:12px;flex-wrap:wrap">';
Object.keys(THEMES).forEach(name=>{const th=THEMES[name];const active=curTheme===name;
h+='<button onclick="applyTheme(\''+name+'\');nav(\'config\')" style="width:90px;height:64px;border-radius:var(--radius);border:'+(active?'3px solid var(--secondary)':'2px solid var(--border)')+';background:'+th['sidebar-bg']+';color:#fff;cursor:pointer;font-weight:'+(active?'700':'400')+';font-size:13px;transition:all .2s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px"><span style="width:24px;height:24px;border-radius:50%;background:'+th.primary+';border:2px solid rgba(255,255,255,.5)"></span>'+t('cfg_theme_'+name)+'</button>';});
h+='</div></div>';
// Farm info
h+=`<div class="card"><h3>${t('cfg_farm')}</h3>
<div class="form-row"><div class="form-group"><label>${t('cfg_farm_name')}</label><input id="cfg-name" value="${D.farm.name||''}"></div>
<div class="form-group"><label>${t('cfg_location')}</label><input id="cfg-loc" value="${D.farm.location||''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('cfg_capacity')}</label><input type="number" id="cfg-cap" value="${D.farm.capacity||''}" min="0"></div>
<div class="form-group"><label>${t('cfg_currency')}</label><input id="cfg-cur" value="${D.farm.currency||'$'}" maxlength="5"></div></div>
<button class="btn btn-primary" onclick="saveConfig()">${t('save')}</button></div>`;
// Alert thresholds
h+=`<div class="card"><h3>${t('cfg_alerts')}</h3>
<div class="form-row-3"><div class="form-group"><label>${t('cfg_min_feed')}</label><input type="number" id="cfg-minfeed" value="${D.settings.minFeedStock||50}" min="0"></div>
<div class="form-group"><label>${t('cfg_max_mortality')}</label><input type="number" id="cfg-maxmort" value="${D.settings.maxMortality||5}" min="0" step="0.5"></div>
<div class="form-group"><label>${t('cfg_alert_days')}</label><input type="number" id="cfg-alertdays" value="${D.settings.alertDaysBefore||3}" min="1"></div></div>
<button class="btn btn-primary" onclick="saveAlertConfig()">${t('save')}</button></div>`;
// Default checklist
h+=`<div class="card"><h3>${t('cfg_checklist')}</h3><p style="color:var(--text-light);font-size:13px;margin-bottom:12px">${t('cfg_checklist_items')}</p>`;
(D.settings.defaultChecklist||[]).forEach((task,i)=>{
h+=`<div class="checklist-item"><span>${t(task)}</span><button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="removeChecklistItem(${i})">‚úï</button></div>`;});
h+=`<div style="margin-top:12px;display:flex;gap:8px"><input id="cfg-newtask" placeholder="${t('ops_task')}" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:var(--radius)">
<button class="btn btn-primary btn-sm" onclick="addChecklistItem()">${t('add')}</button></div></div>`;
// Data management
h+=`<div class="card"><h3>${t('cfg_data')}</h3><div class="btn-group">
<button class="btn btn-secondary" onclick="exportData()">${t('cfg_export')}</button>
<button class="btn btn-secondary" onclick="$('cfg-import-file').click()">${t('cfg_import')}</button>
<input type="file" id="cfg-import-file" accept=".json" style="display:none" onchange="importData(event)">
<button class="btn btn-danger" onclick="resetData()">${t('cfg_reset')}</button></div></div>`;
// Stats
const stats={flocks:D.flocks.length,production:D.dailyProduction.length,vaccines:D.vaccines.length,
medications:D.medications.length,outbreaks:D.outbreaks.length,feedPurchases:D.feed.purchases.length,
feedConsumption:D.feed.consumption.length,clients:D.clients.length,income:D.finances.income.length,
expenses:D.finances.expenses.length,environment:D.environment.length,logbook:D.logbook.length,
personnel:D.personnel.length,snapshots:D.kpiSnapshots.length};
h+='<div class="card"><h3>'+t('data_stats')+'</h3>';
Object.entries(stats).forEach(([k,v])=>{h+=`<div class="stat-row"><span class="stat-label">${k}</span><span class="stat-value">${v}</span></div>`;});
h+='</div>';
$('sec-config').innerHTML=h;
}
function saveConfig(){
const D=loadData();D.farm.name=$('cfg-name').value;D.farm.location=$('cfg-loc').value;
D.farm.capacity=parseInt($('cfg-cap').value)||0;D.farm.currency=$('cfg-cur').value||'$';
saveData(D);toast(t('cfg_saved'));
}
function saveAlertConfig(){
const D=loadData();D.settings.minFeedStock=parseFloat($('cfg-minfeed').value)||50;
D.settings.maxMortality=parseFloat($('cfg-maxmort').value)||5;
D.settings.alertDaysBefore=parseInt($('cfg-alertdays').value)||3;
saveData(D);toast(t('cfg_saved'));
}
function addChecklistItem(){const v=$('cfg-newtask')?.value;if(!v)return;const D=loadData();if(!D.settings.defaultChecklist)D.settings.defaultChecklist=[];D.settings.defaultChecklist.push(v);saveData(D);renderConfig();}
function removeChecklistItem(i){const D=loadData();D.settings.defaultChecklist.splice(i,1);saveData(D);renderConfig();}
function exportData(){
const D=loadData();const blob=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});
const a=document.createElement('a');a.href=URL.createObjectURL(blob);
a.download='egglogu_backup_'+todayStr()+'.json';a.click();toast(t('cfg_exported'));
}
function importData(e){
const file=e.target.files[0];if(!file)return;
const reader=new FileReader();reader.onload=function(ev){
try{const d=JSON.parse(ev.target.result);
DATA=d;saveData(d);toast(t('cfg_imported'));nav('config');
}catch(err){toast(t('error_prefix')+': '+err.message,true);}};
reader.readAsText(file);e.target.value='';
}
function resetData(){
if(!confirm(t('cfg_reset_confirm')))return;if(!confirm(t('final_warning')))return;
localStorage.removeItem('egglogu_data');DATA=null;loadData();toast(t('cfg_reset_done'));nav('dashboard');
}
// === END CONFIG ===

// ============ INIT ============
function init(){DATA=null;loadData();const savedTheme=localStorage.getItem('egglogu_theme');if(savedTheme&&THEMES[savedTheme])applyTheme(savedTheme);switchLang(LANG);nav('dashboard');}
window.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>