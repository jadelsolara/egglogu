<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>EGGlogU 360 — Gestión Avícola Inteligente</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1A3C6E">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob: https:; connect-src 'self' https://api.openweathermap.org wss: ws:; worker-src 'self'">
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="icon" type="image/png" href="favicon.png">
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"></noscript>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7"></script>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script defer src="https://unpkg.com/mqtt@5.14.1/dist/mqtt.min.js"></script>
<script defer src="https://unpkg.com/simple-statistics@7.8.8/dist/simple-statistics.min.js"></script>
<style>
:root{--primary:#1A3C6E;--primary-light:#4A7AB5;--primary-dark:#0E2240;--secondary:#FF8F00;--accent:#2E7D32;--danger:#C62828;--danger-light:#EF5350;--warning:#F9A825;--success:#2E7D32;--bg:#F5F5F5;--card:#FFF;--text:#212121;--text-light:#757575;--sidebar-bg:#0E2240;--sidebar-width:240px;--border:#E0E0E0;--radius:8px;--primary-hover:rgba(26,60,110,.04);--primary-ring:rgba(26,60,110,.15);--primary-fill:rgba(26,60,110,.1)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.app{display:flex;min-height:100vh}
.sidebar{width:var(--sidebar-width);background:var(--sidebar-bg);color:#fff;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;transition:transform .3s}
.sidebar-logo{padding:20px;font-size:24px;font-weight:700;text-align:center;border-bottom:1px solid rgba(255,255,255,.2);letter-spacing:2px}
.sidebar-logo small{display:block;font-size:10px;font-weight:400;opacity:.7}
.sidebar nav{flex:1;padding:10px 0;overflow-y:auto}
.sidebar nav a{display:flex;align-items:center;gap:12px;padding:12px 20px;color:rgba(255,255,255,.8);text-decoration:none;transition:all .2s;cursor:pointer;font-size:14px}
.sidebar nav a:hover{background:rgba(255,255,255,.1);color:#fff}
.sidebar nav a.active{background:rgba(255,255,255,.2);color:#fff;font-weight:600;border-left:3px solid var(--secondary)}
.nav-group-label{padding:10px 20px 6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.55);margin-top:8px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none;transition:all .2s;border-radius:6px;margin-left:8px;margin-right:8px}
.nav-group-label:hover{color:rgba(255,255,255,.85);background:rgba(255,255,255,.05)}
.nav-group-label.grp-open{color:rgba(255,255,255,.9);background:rgba(255,255,255,.08)}
.nav-group-label::after{content:'\25B8';font-size:10px;transition:transform .25s}
.nav-group-label.grp-open::after{transform:rotate(90deg)}
.nav-group-links{max-height:0;overflow:hidden;transition:max-height .3s ease}
.nav-group-links.grp-open{max-height:500px}

.sidebar nav a i{font-style:normal;font-size:18px;width:24px;text-align:center}
.lang-collapse{border-top:1px solid rgba(255,255,255,.15);padding:0 16px}
.lang-collapse-btn{width:100%;padding:10px 0;background:none;border:none;color:rgba(255,255,255,.7);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:space-between}
.lang-collapse-btn:hover{color:#fff}
.lang-collapse-btn::after{content:'▾';transition:transform .2s}
.lang-collapse.open .lang-collapse-btn::after{transform:rotate(180deg)}
.lang-grid{max-height:0;overflow:hidden;transition:max-height .3s ease}
.lang-collapse.open .lang-grid{max-height:200px}
.lang-grid-inner{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;padding:8px 0 12px}
.lang-grid button{padding:4px 10px;border:1px solid rgba(255,255,255,.4);background:transparent;color:#fff;border-radius:4px;cursor:pointer;font-size:11px;font-weight:500;transition:all .2s;display:flex;align-items:center;gap:4px}
.lang-grid button:hover{background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.7)}
.lang-grid button.active{background:#fff;color:var(--sidebar-bg);font-weight:700;border-color:#fff}
.hamburger{display:none;position:fixed;top:10px;left:10px;z-index:101;background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:var(--radius);font-size:20px;cursor:pointer}
.main-content{margin-left:var(--sidebar-width);flex:1;padding:20px 30px;min-height:100vh}
.section{display:none}.section.active{display:block}
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px}
.page-header h2{font-size:24px;color:var(--primary-dark)}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-bottom:24px}
.kpi-card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);border-left:4px solid var(--primary)}
.kpi-card.warning{border-left-color:var(--warning)}.kpi-card.danger{border-left-color:var(--danger)}.kpi-card.accent{border-left-color:var(--accent)}.kpi-card.secondary{border-left-color:var(--secondary)}
.kpi-card .kpi-label{font-size:12px;color:var(--text-light);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.kpi-card .kpi-value{font-size:28px;font-weight:700}.kpi-card .kpi-sub{font-size:12px;color:var(--text-light);margin-top:4px}
.card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:20px}
.card h3{margin-bottom:16px;color:var(--primary-dark);font-size:18px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border)}
th{background:var(--bg);font-weight:600;color:var(--text-light);font-size:12px;text-transform:uppercase;letter-spacing:.5px;position:sticky;top:0}
tr:hover{background:var(--primary-hover)}
.table-wrap{overflow-x:auto;max-height:500px;overflow-y:auto}
.btn{padding:8px 20px;border:none;border-radius:var(--radius);cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark)}
.btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{background:var(--border)}
.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#a51c1c}
.btn-warning{background:var(--warning);color:#000}.btn-sm{padding:4px 12px;font-size:12px}
.btn-group{display:flex;gap:6px;flex-wrap:wrap}
.form-group{margin-bottom:16px}
.form-group label{display:block;margin-bottom:6px;font-weight:500;font-size:14px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;font-family:inherit;transition:border-color .2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-ring)}
.form-group textarea{min-height:80px;resize:vertical}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;justify-content:center;align-items:flex-start;padding:40px 20px;overflow-y:auto}
.modal-overlay.open{display:flex}
.modal{background:var(--card);border-radius:var(--radius);width:100%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border)}
.modal-header h3{font-size:18px;color:var(--primary-dark)}
.modal-header button{background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-light);padding:0 4px}
.modal-body{padding:20px}
.modal-footer{padding:15px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}
.toast{position:fixed;bottom:20px;right:20px;background:var(--primary);color:#fff;padding:12px 24px;border-radius:var(--radius);box-shadow:0 4px 12px rgba(0,0,0,.2);transform:translateY(100px);opacity:0;transition:all .3s;z-index:300;font-size:14px}
.toast.show{transform:translateY(0);opacity:1}.toast.error{background:var(--danger)}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase}
.badge-success{background:#E8F5E9;color:#2E7D32}.badge-warning{background:#FFF8E1;color:#F57F17}.badge-danger{background:#FFEBEE;color:#C62828}.badge-info{background:#E3F2FD;color:#1565C0}.badge-secondary{background:#F5F5F5;color:#757575}
.health-score{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;font-weight:700;font-size:14px;color:#fff}
.health-score.good{background:var(--success)}.health-score.warn{background:var(--warning);color:#000}.health-score.bad{background:var(--danger)}
.tabs{display:flex;gap:0;margin-bottom:20px;border-bottom:2px solid var(--border)}
.tab{padding:10px 20px;cursor:pointer;font-size:14px;font-weight:500;color:var(--text-light);border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s}
.tab:hover{color:var(--text)}.tab.active{color:var(--primary);border-bottom-color:var(--primary);font-weight:600}
.alert-card{padding:12px 16px;border-radius:var(--radius);margin-bottom:10px;font-size:14px;display:flex;align-items:center;gap:10px}
.alert-card.alert-danger{background:#FFEBEE;border-left:4px solid var(--danger);color:var(--danger)}
.alert-card.alert-warning{background:#FFF8E1;border-left:4px solid var(--warning);color:#E65100}
.alert-card.alert-success{background:#E8F5E9;border-left:4px solid var(--success);color:var(--success)}
.alert-card.alert-info{background:#E3F2FD;border-left:4px solid var(--accent);color:var(--accent)}
.checklist-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
.checklist-item input[type=checkbox]{width:18px;height:18px;accent-color:var(--primary)}
.checklist-item.done span{text-decoration:line-through;color:var(--text-light)}
.empty-state{text-align:center;padding:40px;color:var(--text-light)}
.empty-state .empty-icon{font-size:48px;margin-bottom:12px}.empty-state p{margin-bottom:16px}
.chart-container{position:relative;height:300px;margin-bottom:20px}
.filter-bar{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.filter-bar select,.filter-bar input{padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px}
.stat-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:14px}
.stat-row:last-child{border-bottom:none}.stat-row .stat-label{color:var(--text-light)}.stat-row .stat-value{font-weight:600}
.lifecycle-bar{display:flex;border-radius:var(--radius);overflow:hidden;height:48px;margin:16px 0}
.lifecycle-stage{display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;padding:4px 8px;position:relative;cursor:pointer;transition:opacity .2s;text-align:center;line-height:1.2}
.lifecycle-stage:hover{opacity:.85}
.lifecycle-stage.current{box-shadow:inset 0 0 0 3px var(--primary-dark);z-index:1}
.lifecycle-detail{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin:16px 0}
.lifecycle-card{border-radius:var(--radius);padding:12px;text-align:center;font-size:13px}
.lifecycle-card .lc-icon{font-size:28px;margin-bottom:4px}
.lifecycle-card .lc-name{font-weight:700;margin-bottom:4px}
.lifecycle-card .lc-weeks{font-size:11px;color:var(--text-light)}
.lifecycle-card .lc-info{font-size:11px;margin-top:6px;text-align:left}
.snapshot-badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:10px;font-weight:600;margin-left:6px}
.snapshot-up{background:#E8F5E9;color:#2E7D32}.snapshot-down{background:#FFEBEE;color:#C62828}.snapshot-same{background:#F5F5F5;color:#757575}
@media(max-width:768px){
.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.hamburger{display:block}
.main-content{margin-left:0;padding:60px 15px 20px}
.kpi-grid{grid-template-columns:1fr 1fr}.form-row,.form-row-3{grid-template-columns:1fr}
.page-header{flex-direction:column;align-items:flex-start}.modal{max-width:95vw}
.lifecycle-bar{flex-wrap:wrap;height:auto}.lifecycle-stage{padding:8px}
}
@media(max-width:480px){.kpi-grid{grid-template-columns:1fr}.kpi-card .kpi-value{font-size:22px}}
.leaflet-container{height:400px;width:100%;border-radius:var(--radius);z-index:1}
.weather-widget{background:linear-gradient(135deg,#4A7AB5,#1A3C6E);color:#fff;border-radius:var(--radius);padding:20px;margin-bottom:20px}
.weather-widget .weather-main{display:flex;align-items:center;gap:16px;margin-bottom:12px}
.weather-widget .weather-temp{font-size:42px;font-weight:700}.weather-widget .weather-desc{font-size:14px;opacity:.9}
.weather-widget .weather-details{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:13px}
.weather-widget .weather-details div{background:rgba(255,255,255,.15);padding:8px;border-radius:6px;text-align:center}
.weather-forecast{display:flex;gap:8px;margin-top:12px}.weather-forecast .fc-day{flex:1;background:rgba(255,255,255,.1);border-radius:6px;padding:8px;text-align:center;font-size:12px}
.gauge-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;margin:16px 0}
.gauge{text-align:center;background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.gauge svg{width:120px;height:120px}.gauge .gauge-value{font-size:24px;font-weight:700;margin-top:8px}.gauge .gauge-label{font-size:12px;color:var(--text-light);margin-top:4px}
.stress-timeline{position:relative;padding-left:24px;margin:16px 0}
.stress-timeline::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:var(--border)}
.stress-event{position:relative;margin-bottom:16px;padding:12px;background:var(--card);border-radius:var(--radius);box-shadow:0 1px 4px rgba(0,0,0,.08)}
.stress-event::before{content:'';position:absolute;left:-20px;top:16px;width:12px;height:12px;border-radius:50%;border:2px solid var(--card)}
.stress-event.sev-1::before{background:#4CAF50}.stress-event.sev-2::before{background:#8BC34A}.stress-event.sev-3::before{background:#FFC107}
.stress-event.sev-4::before{background:#FF9800}.stress-event.sev-5::before{background:#F44336}
.mqtt-status{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 10px;border-radius:12px}
.mqtt-status.connected{background:#E8F5E9;color:#2E7D32}.mqtt-status.disconnected{background:#FFEBEE;color:#C62828}
.mqtt-status .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.mqtt-status.connected .dot{background:#2E7D32}.mqtt-status.disconnected .dot{background:#C62828}
.pred-card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.08);text-align:center}
.pred-card .pred-score{font-size:36px;font-weight:700;margin:8px 0}.pred-card .pred-label{font-size:12px;color:var(--text-light)}
.anomaly-icon{color:var(--warning);font-weight:700;cursor:help}
.nav-badge{background:var(--secondary);color:#fff;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:auto}
/* Mode toggles */
.mode-toggles{padding:8px 12px;display:flex;gap:6px}
.mode-btn{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:var(--radius);padding:6px 10px;font-size:12px;cursor:pointer;flex:1;text-align:center;transition:.2s}
.mode-btn:hover{background:rgba(255,255,255,.2)}.mode-btn.active{background:var(--secondary);border-color:var(--secondary);font-weight:600}
/* Zone risk badges */
.risk-badge{display:inline-block;padding:2px 10px;border-radius:12px;font-size:12px;font-weight:600;color:#fff}
.risk-green{background:#4CAF50}.risk-yellow{background:#FFC107;color:#333}.risk-red{background:#F44336}
/* Pest severity */
.severity-bar{width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden}.severity-bar>div{height:100%;border-radius:4px;transition:width .3s}.severity-dot{width:10px;height:10px;border-radius:50%;background:var(--border)}
.severity-dot.active{background:var(--secondary)}
/* Recommendation card */
.rec-card{background:#E3F2FD;border:1px solid #90CAF9;border-radius:var(--radius);padding:16px;margin-top:12px}
.rec-item{display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid #BBDEFB}
.rec-item:last-child{border-bottom:none}
.rec-priority{font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;white-space:nowrap}
.rec-priority.high{background:#FFCDD2;color:#C62828}.rec-priority.medium{background:#FFF9C4;color:#F57F17}.rec-priority.low{background:#C8E6C9;color:#2E7D32}
/* Traffic light */
.traffic-light{display:flex;align-items:center;gap:8px;font-size:24px}
.traffic-dot{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);opacity:.3}.traffic-dot.active{opacity:1;box-shadow:0 0 8px currentColor}
.traffic-dot.green{background:#4CAF50;border-color:#4CAF50}.traffic-dot.yellow{background:#FFC107;border-color:#FFC107}.traffic-dot.red{background:#F44336;border-color:#F44336}
/* Campo & Vet mode */
body.campo-mode .campo-hide,body.vet-mode .campo-hide{display:none!important}
.campo-kpi{font-size:48px;font-weight:800;text-align:center;color:var(--primary)}
.campo-btn-big{display:block;width:100%;padding:24px;font-size:24px;font-weight:700;border:none;border-radius:var(--radius);background:var(--secondary);color:#fff;cursor:pointer;margin-top:16px}
/* Dark mode */
body.dark-mode{--bg:#1E1E1E;--card:#2D2D2D;--text:#E0E0E0;--text-light:#BDBDBD;--border:#424242}
body.dark-mode .sidebar{background:#121212}
body.dark-mode .kpi-card{background:#2D2D2D;border-color:#424242}
body.dark-mode input,body.dark-mode select,body.dark-mode textarea{background:#383838;color:#E0E0E0;border-color:#555}
body.dark-mode .modal{background:#2D2D2D;color:#E0E0E0}
body.dark-mode .rec-card{background:#1A237E;border-color:#3949AB}
body.dark-mode .card{background:#2D2D2D}
/* QR display */
.qr-display{padding:12px;background:#fff;border:1px solid var(--border);border-radius:var(--radius);font-family:monospace;word-break:break-all;text-align:center;font-size:11px}
/* Font scale */
body.font-small{font-size:13px}body.font-normal{font-size:15px}body.font-large{font-size:18px}body.font-xlarge{font-size:21px}
/* Field validation errors */
.field-error{border-color:var(--danger)!important;box-shadow:0 0 0 2px rgba(198,40,40,.2)!important}
.field-error-msg{color:var(--danger);font-size:11px;margin-top:2px}
/* Confirm dialog */
.confirm-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:10001;opacity:0;pointer-events:none;transition:opacity .2s}
.confirm-overlay.open{opacity:1;pointer-events:auto}
.confirm-box{background:var(--card);border-radius:var(--radius);padding:24px;max-width:400px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.2);text-align:center}
.confirm-box h4{margin-bottom:8px;font-size:18px;color:var(--text)}
.confirm-box p{margin-bottom:20px;color:var(--text-light);font-size:14px}
.confirm-box .confirm-btns{display:flex;gap:10px;justify-content:center}
.confirm-box .confirm-btns button{padding:8px 24px;border-radius:var(--radius);border:none;font-size:14px;font-weight:600;cursor:pointer}
.confirm-box .btn-confirm-yes{background:var(--danger);color:#fff}.confirm-box .btn-confirm-no{background:var(--border);color:var(--text)}
body.dark-mode .confirm-box{background:#2D2D2D;color:#E0E0E0}
/* Login screen */
.login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#0E2240 0%,#1A3C6E 50%,#2A5CAE 100%);display:flex;align-items:center;justify-content:center;z-index:20000}
.login-screen.hidden{display:none}
.login-card{background:#fff;border-radius:16px;padding:40px;max-width:380px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3);text-align:center}
.login-card .login-logo{margin-bottom:20px}
.login-card h2{color:var(--primary);margin-bottom:4px;font-size:22px}
.login-card .login-subtitle{color:#757575;font-size:13px;margin-bottom:24px}
.login-card input{width:100%;padding:12px 16px;border:1px solid #E0E0E0;border-radius:var(--radius);font-size:15px;margin-bottom:12px;transition:border-color .2s}
.login-card input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-ring)}
.login-card .login-btn{width:100%;padding:12px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius);font-size:16px;font-weight:600;cursor:pointer;margin-top:8px;transition:background .2s}
.login-card .login-btn:hover{background:var(--primary-dark)}
.login-card .login-error{color:var(--danger);font-size:13px;margin-top:8px;min-height:20px}
.login-card .login-setup{background:var(--border);font-size:12px;padding:8px;border-radius:6px;margin-top:16px;color:#555}
/* Skip to content (accessibility) */
.skip-link{position:absolute;top:-40px;left:0;background:var(--primary);color:#fff;padding:8px 16px;z-index:30000;border-radius:0 0 var(--radius) 0;transition:top .2s}
.skip-link:focus{top:0}
/* Screen reader only */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
/* Loading spinner */
.loading-spinner{display:flex;align-items:center;justify-content:center;padding:40px}
.loading-spinner::after{content:'';width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>
<!-- Login Screen -->
<div class="login-screen" id="login-screen" role="form" aria-label="Login">
<div class="login-card">
<div class="login-logo"><img src="data:image/png;base64,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" alt="EGGlogU" style="width:72px;height:72px;border-radius:12px"></div>
<h2>EGGlogU 360</h2>
<p class="login-subtitle" data-t="login_subtitle">Ingrese sus credenciales</p>
<input type="text" id="login-user" placeholder="Usuario" autocomplete="username" aria-label="Username">
<input type="password" id="login-pass" placeholder="Password" autocomplete="current-password" aria-label="Password" onkeydown="if(event.key==='Enter')doLogin()">
<button class="login-btn" onclick="doLogin()" aria-label="Login">Entrar</button>
<div class="login-error" id="login-error" role="alert" aria-live="polite"></div>
<div class="login-setup" id="login-setup-msg"></div>
</div>
</div>
<!-- Confirm dialog -->
<div class="confirm-overlay" id="confirm-overlay" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title">
<div class="confirm-box">
<h4 id="confirm-title"></h4>
<p id="confirm-msg"></p>
<div class="confirm-btns">
<button class="btn-confirm-no confirm-btn-cancel" onclick="confirmNo()" data-t="cancel" aria-label="Cancel">Cancelar</button>
<button class="btn-confirm-yes" onclick="confirmYes()" data-t="delete" aria-label="Confirm delete">Eliminar</button>
</div>
</div>
</div>
<div class="app" id="app-container">
<aside class="sidebar" id="sidebar" role="navigation" aria-label="Main Navigation">
<div class="sidebar-logo" aria-label="EGGlogU 360"><img src="data:image/png;base64,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" alt="EGGlogU" style="width:36px;height:36px;vertical-align:middle;margin-right:6px;border-radius:6px"> EGGlogU <span style="color:#FF8F00;font-size:16px">360</span><small data-t="sidebar_subtitle">Gestión Avícola Inteligente</small></div>
<nav id="main-nav" role="menubar" aria-label="Modules">
 <a data-section="dashboard" class="active" onclick="nav('dashboard')"><i>📊</i><span data-t="nav_dashboard">Dashboard</span></a>
 <div class="nav-group-label grp-open" data-t="grp_production" onclick="toggleNavGroup(this)">Producción</div>
 <div class="nav-group-links grp-open" data-grp="production">
 <a data-section="produccion" onclick="nav('produccion')"><i>🥚</i><span data-t="nav_production">Producción</span></a>
 <a data-section="lotes" onclick="nav('lotes')"><i>🐔</i><span data-t="nav_flocks">Lotes</span></a>
 <a data-section="alimento" onclick="nav('alimento')"><i>🌾</i><span data-t="nav_feed">Alimento</span></a>
 <a data-section="ambiente" onclick="nav('ambiente')"><i>🌡️</i><span data-t="nav_environment">Ambiente</span></a>
 </div>
 <div class="nav-group-label grp-open" data-t="grp_health" onclick="toggleNavGroup(this)">Salud</div>
 <div class="nav-group-links grp-open" data-grp="health">
 <a data-section="sanidad" onclick="nav('sanidad')"><i>💉</i><span data-t="nav_health">Sanidad</span></a>
 <a data-section="bioseguridad" onclick="nav('bioseguridad')"><i>🛡️</i><span data-t="nav_biosecurity">Bioseguridad</span></a>
 </div>
 <div class="nav-group-label grp-open" data-t="grp_commercial" onclick="toggleNavGroup(this)">Comercial</div>
 <div class="nav-group-links grp-open" data-grp="commercial">
 <a data-section="clientes" onclick="nav('clientes')"><i>👥</i><span data-t="nav_clients">Clientes</span></a>
 <a data-section="inventario" onclick="nav('inventario')"><i>📦</i><span data-t="nav_inventory">Inventario</span></a>
 <a data-section="finanzas" onclick="nav('finanzas')"><i>💰</i><span data-t="nav_finances">Finanzas</span></a>
 </div>
 <div class="nav-group-label grp-open" data-t="grp_management" onclick="toggleNavGroup(this)">Gestión</div>
 <div class="nav-group-links grp-open" data-grp="management">
 <a data-section="analisis" onclick="nav('analisis')"><i>📈</i><span data-t="nav_analysis">Análisis</span></a>
 <a data-section="operaciones" onclick="nav('operaciones')"><i>📋</i><span data-t="nav_operations">Operaciones</span></a>
 <a data-section="trazabilidad" onclick="nav('trazabilidad')"><i>🔗</i><span data-t="nav_traceability">Trazabilidad</span></a>
 <a data-section="planificacion" onclick="nav('planificacion')"><i>📅</i><span data-t="nav_planning">Planificación</span></a>
 <a data-section="carencias" onclick="nav('carencias')"><i>🔍</i><span data-t="nav_census">Carencias</span></a>
 </div>
 <div class="nav-group-label grp-open" data-t="grp_system" onclick="toggleNavGroup(this)">Sistema</div>
 <div class="nav-group-links grp-open" data-grp="system">
 <a data-section="admin" onclick="nav('admin')"><i>👑</i><span data-t="nav_admin">Admin</span></a>
 <a data-section="config" onclick="nav('config')"><i>⚙️</i><span data-t="nav_config">Config</span></a>
 </div>
 </nav>
<div class="mode-toggles">
<button onclick="toggleCampoMode()" id="btn-campo" class="mode-btn" aria-label="Toggle Campo Mode">🌾 <span data-t="nav_campo_mode">Modo Campo</span></button>
<button onclick="toggleVetMode()" id="btn-vet" class="mode-btn" aria-label="Toggle Vet Mode">🩺 <span data-t="nav_vet_mode">Modo Vet</span></button>
</div>
<div class="lang-collapse" id="langToggle">
<button class="lang-collapse-btn" onclick="this.parentElement.classList.toggle('open')">🌐 <span id="langCurrent">Español</span></button>
<div class="lang-grid"><div class="lang-grid-inner">
<button onclick="switchLang('es')" id="btn-es" class="active">🇨🇱 ES</button>
<button onclick="switchLang('en')" id="btn-en">🇺🇸 EN</button>
<button onclick="switchLang('pt')" id="btn-pt">🇧🇷 PT</button>
<button onclick="switchLang('fr')" id="btn-fr">🇫🇷 FR</button>
<button onclick="switchLang('de')" id="btn-de">🇩🇪 DE</button>
<button onclick="switchLang('it')" id="btn-it">🇮🇹 IT</button>
<button onclick="switchLang('ja')" id="btn-ja">🇯🇵 JA</button>
<button onclick="switchLang('zh')" id="btn-zh">🇨🇳 ZH</button>
</div></div>
</div>
<div style="padding:8px 12px;margin-top:auto">
<button onclick="doLogout()" class="mode-btn" style="width:100%;background:rgba(198,40,40,.3);border-color:rgba(198,40,40,.4)" aria-label="Logout">&#x1F6AA; <span data-t="logout">Cerrar sesión</span></button>
</div>
</aside>
<main class="main-content" id="main-content" role="main" aria-label="Content">
<button class="hamburger" onclick="toggleSidebar()" aria-label="Toggle menu">☰</button>
<div id="sec-dashboard" class="section active" role="region" aria-label="Dashboard"></div>
<div id="sec-produccion" class="section" role="region" aria-label="Production"></div>
<div id="sec-lotes" class="section" role="region" aria-label="Flocks"></div>
<div id="sec-sanidad" class="section" role="region" aria-label="Health"></div>
<div id="sec-alimento" class="section" role="region" aria-label="Feed"></div>
<div id="sec-clientes" class="section" role="region" aria-label="Clients"></div>
<div id="sec-inventario" class="section" role="region" aria-label="Inventory"></div>
<div id="sec-finanzas" class="section" role="region" aria-label="Finance"></div>
<div id="sec-analisis" class="section" role="region" aria-label="Analytics"></div>
<div id="sec-operaciones" class="section" role="region" aria-label="Operations"></div>
<div id="sec-bioseguridad" class="section" role="region" aria-label="Biosecurity"></div>
<div id="sec-trazabilidad" class="section" role="region" aria-label="Traceability"></div>
<div id="sec-planificacion" class="section" role="region" aria-label="Planning"></div>
<div id="sec-ambiente" class="section" role="region" aria-label="Environment"></div>
<div id="sec-carencias" class="section" role="region" aria-label="Deficiency Census"></div>
<div id="sec-admin" class="section" role="region" aria-label="Administration"></div>
<div id="sec-config" class="section" role="region" aria-label="Settings"></div>
</main>
</div>
<div class="modal-overlay" id="modal-overlay" onclick="closeModal()" role="dialog" aria-modal="true" aria-labelledby="modal-title">
<div class="modal" onclick="event.stopPropagation()">
<div class="modal-header"><h3 id="modal-title"></h3><button onclick="closeModal()" aria-label="Close dialog">✕</button></div>
<div class="modal-body" id="modal-body"></div>
</div>
</div>
<div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>
<script>
// ============ GLOBAL ERROR HANDLER + BUG REPORTER ============
const _bugErrors=[];const _BUG_ERROR_CAP=50;
window.onerror = function(msg, src, line, col, err) {
  console.error('[EGGlogU Error]', msg, src, line, col);
  _bugErrors.push({ts:new Date().toISOString(),type:'error',msg:String(msg),src:String(src||'').split('/').pop(),line,col,stack:err?.stack?.substring(0,300)||'',section:typeof currentSection!=='undefined'?currentSection:'?'});
  if(_bugErrors.length>_BUG_ERROR_CAP)_bugErrors.shift();
  _bugUpdateBadge();
  return false;
};
window.addEventListener('unhandledrejection', function(e) {
  console.error('[EGGlogU Promise]', e.reason);
  _bugErrors.push({ts:new Date().toISOString(),type:'promise',msg:String(e.reason?.message||e.reason||'Unknown rejection').substring(0,200),src:'',line:0,col:0,stack:e.reason?.stack?.substring(0,300)||'',section:typeof currentSection!=='undefined'?currentSection:'?'});
  if(_bugErrors.length>_BUG_ERROR_CAP)_bugErrors.shift();
  _bugUpdateBadge();
});
function _bugUpdateBadge(){const b=document.getElementById('bug-badge');if(b){b.textContent=_bugErrors.length;b.style.display=_bugErrors.length?'flex':'none';}}

// ============ TRANSLATIONS ============
const T={es:{
save:'Guardar',cancel:'Cancelar',delete:'Eliminar',edit:'Editar',add:'Agregar',close:'Cerrar',actions:'Acciones',date:'Fecha',notes:'Notas',name:'Nombre',phone:'Teléfono',email:'Email',address:'Dirección',confirm_delete:'¿Eliminar este registro?',no_data:'No hay datos registrados',total:'Total',all:'Todos',loading:'Cargando',search:'Buscar',from:'Desde',to:'Hasta',status:'Estado',export_csv:'Exportar CSV',today:'Hoy',active:'Activo',inactive:'Inactivo',
nav_dashboard:'Dashboard',nav_production:'Producción',nav_flocks:'Lotes',nav_health:'Sanidad',nav_feed:'Alimento',nav_clients:'Clientes',nav_finances:'Finanzas',nav_analysis:'Análisis',nav_operations:'Operaciones',nav_environment:'Ambiente',nav_config:'Configuración',nav_admin:'Admin SaaS',nav_inventory:'Inventario',grp_production:'Producción',grp_health:'Salud',grp_commercial:'Comercial',grp_management:'Gestión',grp_system:'Sistema',
dash_title:'Panel Principal',kpi_today:'Producción Hoy',kpi_henday:'Tasa Hen-Day',kpi_fcr:'Conversión (FCR)',kpi_mortality:'Mortalidad',kpi_cost_egg:'Costo/Huevo',kpi_income_net:'Ingreso Neto',kpi_alerts:'Alertas',kpi_active_hens:'Gallinas Activas',kpi_active_flocks:'Lotes Activos',dash_alerts:'Alertas',dash_trend:'Tendencia 30 Días',dash_no_alerts:'Sin alertas',dash_snapshot:'Guardar Snapshot KPI',dash_kpi_history:'Historial KPI',
alert_vaccine_overdue:'Vacuna vencida',alert_vaccine_soon:'Vacuna próxima',alert_low_feed:'Stock alimento bajo',alert_high_mortality:'Mortalidad alta',alert_active_outbreak:'Brote activo',alert_withdrawal:'Retiro activo',
flock_title:'Gestión de Lotes',flock_add:'Nuevo Lote',flock_name:'Nombre',flock_breed:'Raza',flock_count:'Cantidad Inicial',flock_birthdate:'Fecha Nacimiento',flock_purchase_date:'Fecha Compra',flock_supplier:'Proveedor',flock_cost:'Costo Total',flock_status:'Estado',flock_notes:'Notas',flock_age:'Edad',flock_health:'Salud',flock_weeks:'sem',flock_days:'días',flock_current:'Actuales',flock_status_cria:'Cría',flock_status_recria:'Recría',flock_status_produccion:'Producción',flock_status_descarte:'Descarte',flock_edit:'Editar Lote',flock_lifecycle:'Ciclo de Vida',flock_roadmap:'Roadmap',
lc_pollito:'Pollito',lc_cria:'Cría',lc_recria:'Recría',lc_prepostura:'Pre-postura',lc_pico:'Postura Pico',lc_media:'Postura Media',lc_baja:'Postura Baja',lc_descarte:'Descarte',lc_feed:'Alimento',lc_temp:'Temp',lc_weeks:'Semanas',lc_milestone:'Hitos',lc_current_stage:'Etapa Actual',
prod_title:'Registro de Producción',prod_add:'Nuevo Registro',prod_flock:'Lote',prod_eggs:'Huevos Recolectados',prod_broken:'Rotos/Defectuosos',prod_size_s:'Pequeño (S)',prod_size_m:'Mediano (M)',prod_size_l:'Grande (L)',prod_size_xl:'Extra Grande (XL)',prod_size_jumbo:'Jumbo',prod_shell:'Color Cáscara',prod_yolk:'Calidad Yema (1-10)',prod_deaths:'Muertes',prod_death_cause:'Causa de Muerte',prod_date:'Fecha',
san_title:'Sanidad',san_vaccines:'Vacunas',san_medications:'Medicamentos',san_outbreaks:'Brotes',
vac_title:'Plan de Vacunación',vac_add:'Registrar Vacuna',vac_vaccine:'Vacuna',vac_scheduled:'Programada',vac_applied:'Aplicada',vac_batch:'Lote Vacuna',vac_route:'Vía',vac_overdue:'Vencida',vac_upcoming:'Próxima',vac_applied_status:'Aplicada',vac_pending:'Pendiente',vac_generate:'Generar Calendario',vac_mark_applied:'Marcar Aplicada',
med_title:'Medicamentos',med_add:'Registrar Medicamento',med_name:'Medicamento',med_reason:'Motivo',med_start:'Inicio',med_end:'Fin',med_withdrawal:'Días Retiro',med_withdrawal_end:'Fin Retiro',med_dosage:'Dosis',med_in_withdrawal:'En Retiro',
out_title:'Brotes',out_add:'Registrar Brote',out_disease:'Enfermedad',out_start:'Inicio',out_end:'Fin',out_affected:'Afectadas',out_deaths:'Muertes',out_symptoms:'Síntomas',out_treatment:'Tratamiento',out_loss:'Pérdida Económica',out_active:'Activo',out_controlled:'Controlado',out_resolved:'Resuelto',
feed_title:'Alimentación',feed_purchases:'Compras',feed_consumption:'Consumo',feed_stock:'Stock Actual',feed_add_purchase:'Nueva Compra',feed_add_consumption:'Registrar Consumo',feed_type:'Tipo',feed_qty:'Cantidad (kg)',feed_cost:'Costo',feed_supplier:'Proveedor',feed_flock:'Lote',feed_low_alert:'Stock bajo',
cli_title:'Clientes',cli_add:'Nuevo Cliente',cli_route:'Ruta/Zona',cli_price:'Precios Acordados',cli_total:'Total Clientes',
fin_title:'Finanzas',fin_income:'Ingresos',fin_expenses:'Gastos',fin_receivables:'Cuentas por Cobrar',fin_summary:'Resumen',fin_add_income:'Nuevo Ingreso',fin_add_expense:'Nuevo Gasto',fin_add_receivable:'Nueva Cuenta',fin_type:'Tipo',fin_qty:'Cantidad',fin_unit_price:'Precio Unit.',fin_client:'Cliente',fin_category:'Categoría',fin_description:'Descripción',fin_amount:'Monto',fin_due_date:'Vencimiento',fin_paid:'Pagado',fin_total_income:'Total Ingresos',fin_total_expenses:'Total Gastos',fin_net:'Resultado Neto',fin_cost_per_egg:'Costo/Huevo',fin_break_even:'Punto Equilibrio',fin_month:'Mes',
fin_cat_feed:'Alimento',fin_cat_vaccines:'Vacunas/Med.',fin_cat_transport:'Transporte',fin_cat_labor:'Mano de Obra',fin_cat_infrastructure:'Infraestructura',fin_cat_bird_purchase:'Compra Aves',fin_cat_other:'Otros',
fin_type_eggs:'Venta Huevos',fin_type_birds:'Venta Aves',fin_type_manure:'Venta Abono',fin_type_other:'Otro',
ana_title:'Análisis',ana_comparison:'Comparación Lotes',ana_seasonality:'Estacionalidad',ana_profitability:'Rentabilidad',ana_benchmarks:'Benchmarks',ana_best_flock:'Mejor Lote',ana_worst_flock:'Peor Lote',ana_avg_production:'Producción Promedio',ana_trend:'Tendencia',ana_kpi_evolution:'Evolución KPI',ana_no_snapshots:'Sin snapshots. Guarde snapshots desde el Dashboard.',
ops_title:'Operaciones',ops_checklist:'Checklist Diario',ops_logbook:'Bitácora',ops_personnel:'Personal',ops_task:'Tarea',ops_done:'Completado',ops_add_task:'Agregar Tarea',ops_check_date:'Fecha',ops_log_entry:'Entrada',ops_log_category:'Categoría',ops_log_add:'Nueva Entrada',
ops_log_cat_general:'General',ops_log_cat_health:'Sanidad',ops_log_cat_production:'Producción',ops_log_cat_maintenance:'Mantenimiento',ops_log_cat_observation:'Observación',
ops_per_name:'Nombre',ops_per_role:'Cargo',ops_per_salary:'Salario',ops_per_start:'Fecha Inicio',ops_per_active:'Activo',ops_per_add:'Agregar Personal',
env_title:'Condiciones Ambientales',env_add:'Nuevo Registro',env_temp:'Temperatura (°C)',env_humidity:'Humedad (%)',env_light:'Horas Luz',env_ventilation:'Ventilación',env_density:'Densidad (aves/m²)',env_optimal:'Rango Óptimo',env_temp_range:'18-24°C',env_humidity_range:'40-70%',env_light_range:'14-16 hrs',env_density_range:'4-5 aves/m²',
cfg_title:'Configuración',cfg_farm:'Datos de la Granja',cfg_farm_name:'Nombre Granja',cfg_location:'Ubicación',cfg_capacity:'Capacidad (aves)',cfg_currency:'Moneda',cfg_alerts:'Umbrales de Alertas',cfg_min_feed:'Stock Mín. Alimento (kg)',cfg_max_mortality:'Mortalidad Máx. (%)',cfg_alert_days:'Días Anticipación',cfg_data:'Datos',cfg_export:'Exportar (JSON)',cfg_import:'Importar (JSON)',cfg_reset:'Borrar Todo',cfg_reset_confirm:'¿Eliminar TODOS los datos?',cfg_saved:'Guardado',cfg_exported:'Datos exportados',cfg_imported:'Datos importados',cfg_reset_done:'Datos eliminados',cfg_checklist:'Checklist Predeterminado',cfg_checklist_items:'Tareas del checklist',cfg_theme:'Tema de Color',cfg_theme_blue:'Azul Marino',cfg_theme_green:'Verde',cfg_theme_purple:'Púrpura',cfg_theme_black:'Negro',
sidebar_subtitle:'Sistema Avícola 360°',prod_shell_white:'Blanco',prod_shell_brown:'Marrón',prod_shell_cream:'Crema',required:'Campo requerido',no_flocks_birthdate:'No hay lotes con fecha de nacimiento',vac_select_flocks:'Seleccione lotes para generar calendario:',feed_type_placeholder:'Postura, Iniciador, etc.',avg_per_day:'Prom/día',per_flock:'Lote',history:'Historial',env_latest_reading:'Última Lectura',env_ok:'OK',env_out_of_range:'Fuera de rango',data_stats:'Estadísticas de Datos',final_warning:'⚠️ ADVERTENCIA FINAL — Se eliminarán TODOS los datos',total_salaries:'Total Salarios',eggs_unit:'huevos',csv_income:'Ingreso',csv_expense:'Gasto',fcr_unit:'kg alimento/kg huevo',lc_feed_starter:'Iniciador',lc_feed_grower:'Crecimiento',lc_feed_developer:'Desarrollo',lc_feed_prelay:'Pre-postura',lc_feed_layer:'Postura',lc_feed_lowlay:'Postura baja',lc_prod_label:'Prod',lc_prod_first:'Primeros huevos',lc_mile_1:'Vacunas Marek, Newcastle+BI, Gumboro',lc_mile_2:'Newcastle refuerzo, desarrollo plumaje',lc_mile_3:'Viruela, Encefalomielitis, Coriza, Salmonella',lc_mile_4:'Newcastle+BI refuerzo, cambio dieta, 16h luz',lc_mile_5:'Pico producción sem 26-30, monitorear FCR',lc_mile_6:'Newcastle refuerzo c/8-12 sem, evaluar rentabilidad',lc_mile_7:'Evaluar descarte vs muda forzada',lc_mile_8:'Venta ave descarte, limpieza galpón',vac_route_injection:'Inyección',vac_route_ocular:'Ocular/spray',vac_route_water:'Agua',vac_route_wing:'Punción alar',snapshots:'snapshots',error_prefix:'Error',chk_collect_eggs:'Recolectar huevos',chk_feed_birds:'Alimentar aves',chk_check_water:'Verificar agua',chk_check_health:'Revisar salud',chk_cleaning:'Limpieza',chk_record_temp:'Registrar temperatura',
weather_title:'Clima',weather_temp:'Temperatura',weather_humidity:'Humedad',weather_wind:'Viento',weather_forecast:'Pronóstico 3 Días',weather_no_key:'Configure API key de OpenWeatherMap en Configuración',weather_heat_alert:'Alerta de Estrés Calórico',weather_thi:'Índice THI',weather_feels:'Sensación',weather_last_update:'Última actualización',weather_test:'Probar',
geo_set_location:'Ubicación de la Granja',geo_use_gps:'Usar mi GPS',geo_click_map:'Clic en el mapa para ubicar',geo_lat:'Latitud',geo_lng:'Longitud',geo_saved:'Ubicación guardada',
iot_title:'IoT Sensores',iot_broker:'Broker MQTT (wss://)',iot_user:'Usuario MQTT',iot_pass:'Contraseña MQTT',iot_topic:'Prefijo Topic',iot_connect:'Conectar',iot_disconnect:'Desconectar',iot_live:'IoT En Vivo',iot_no_config:'Configure MQTT en Configuración',iot_save_reading:'Guardar lectura actual',iot_connected:'Conectado',iot_disconnected:'Desconectado',iot_ammonia:'Amoníaco',iot_light:'Luz',iot_lux:'lux',iot_ppm:'ppm',
pred_title:'Predicciones',pred_forecast:'Pronóstico Producción',pred_anomaly:'Anomalías',pred_drop_risk:'Riesgo de Caída',pred_breed_curve:'Curva de Raza',pred_fcr_trend:'Tendencia FCR',pred_next_7d:'Próximos 7 días',pred_improving:'Mejorando',pred_worsening:'Empeorando',pred_stable:'Estable',pred_score:'Puntuación',pred_low:'Bajo',pred_medium:'Medio',pred_high:'Alto',pred_vs_expected:'Real vs Esperado',
stress_title:'Eventos de Estrés',stress_type:'Tipo',stress_severity:'Severidad',stress_heat:'Calor',stress_disease:'Enfermedad',stress_feed_change:'Cambio Alimento',stress_power:'Corte Eléctrico',stress_predator:'Depredador',stress_other:'Otro',stress_description:'Descripción',stress_add:'Nuevo Evento',stress_impact:'Impacto en Producción',stress_auto:'(Auto-generado)',
env_ammonia:'Amoníaco (ppm)',env_wind:'Velocidad Viento (km/h)',env_thi:'Índice THI',env_manual:'Entrada Manual',env_history:'Historial',env_iot:'IoT En Vivo',
pwa_install:'Instalar App',pwa_offline:'Modo Offline Disponible',
cfg_owm_key:'API Key OpenWeatherMap',cfg_mqtt:'Configuración MQTT',cfg_geo:'Geolocalización',
flock_housing:'Tipo Alojamiento',flock_housing_floor:'Piso',flock_housing_cage:'Jaula',flock_housing_free:'Libre',flock_target_curve:'Curva Objetivo',flock_egg_color:'Color Huevo',
ana_predictions:'Predicciones',
per_day:'por día',actual:'Real',expected:'Esperado',not_available:'no disponible',
// Biosecurity
nav_biosecurity:'Bioseguridad',bio_title:'Bioseguridad y Control de Plagas',bio_visitors:'Visitantes',bio_zones:'Zonas',bio_pests:'Plagas',bio_protocols:'Protocolos',
bio_add_visitor:'Nuevo Visitante',bio_visitor_name:'Nombre',bio_visitor_company:'Empresa',bio_visitor_purpose:'Propósito',bio_visitor_zone:'Zona',bio_visitor_plate:'Placa Vehículo',bio_visitor_disinfected:'Desinfectado',bio_visitor_from_farm:'Granja Origen',bio_visitor_from_health:'Salud Granja Origen',bio_cross_risk:'⚠️ Riesgo contaminación cruzada',
bio_add_zone:'Nueva Zona',bio_zone_name:'Nombre Zona',bio_zone_risk:'Nivel Riesgo',bio_zone_last_disinfection:'Última Desinfección',bio_zone_frequency:'Frecuencia (días)',bio_risk_green:'Verde',bio_risk_yellow:'Amarillo',bio_risk_red:'Rojo',
bio_add_pest:'Nuevo Avistamiento',bio_pest_type:'Tipo',bio_pest_rodent:'Roedor',bio_pest_fly:'Mosca',bio_pest_wild_bird:'Ave Silvestre',bio_pest_other:'Otro',bio_pest_location:'Ubicación',bio_pest_severity:'Severidad',bio_pest_action:'Acción Tomada',bio_pest_resolved:'Resuelto',
bio_add_protocol:'Nuevo Protocolo',bio_protocol_name:'Nombre Protocolo',bio_protocol_frequency:'Frecuencia',bio_protocol_daily:'Diario',bio_protocol_weekly:'Semanal',bio_protocol_monthly:'Mensual',bio_protocol_last:'Último Completado',bio_protocol_items:'Ítems del Protocolo',bio_protocol_complete:'Completar',bio_protocol_overdue:'Vencido',
bio_pest_score:'Puntuación Plagas',bio_overdue_disinfection:'Desinfección vencida',bio_unresolved_pests:'Plagas sin resolver',
alert_bio_disinfection:'Desinfección vencida zona',alert_bio_pests:'Plagas sin resolver',alert_bio_cross:'Riesgo contaminación cruzada',
// Traceability
nav_traceability:'Trazabilidad',trace_title:'Trazabilidad de Huevos',trace_add:'Nuevo Lote',trace_batch_id:'ID Lote',trace_rack:'Rack',trace_box_count:'Cajas',trace_eggs_per_box:'Huevos/Caja',trace_qr:'Código QR',trace_delivery:'Fecha Entrega',trace_search:'Buscar por ID/QR',trace_origin:'Origen',trace_house:'Galpón',
// Planning
nav_planning:'Planificación',plan_title:'Planificación de Producción',plan_add:'Nuevo Plan',plan_name:'Nombre Plan',plan_target_date:'Fecha Objetivo',plan_eggs_needed:'Huevos Necesarios',plan_allocations:'Asignación de Lotes',plan_expected:'Producción Esperada',plan_gap:'Brecha',plan_on_track:'En Meta',plan_behind:'Atrás',plan_ahead:'Adelante',plan_estimate:'Estimación',plan_commitment:'Compromiso',
// Egg types + market
prod_egg_type:'Tipo Huevo',prod_type_conventional:'Convencional',prod_type_free_range:'Campo Libre',prod_type_organic:'Orgánico',prod_type_pasture:'Pastoreo',prod_type_decorative:'Decorativo',
prod_market:'Canal de Venta',prod_market_wholesale:'Mayorista',prod_market_supermarket:'Supermercado',prod_market_restaurant:'Restaurant',prod_market_direct:'Venta Directa',prod_market_export:'Exportación',prod_market_pasteurized:'Pasteurizado',
ana_by_segment:'Rentabilidad por Segmento',ana_by_type:'Por Tipo',ana_by_channel:'Por Canal',
// Campo & Vet modes
nav_campo_mode:'Modo Campo',nav_vet_mode:'Modo Vet',campo_today:'HOY',campo_quick_entry:'Entrada Rápida',vet_visit:'Visita realizada',vet_vaccines:'Vacunas aplicadas',vet_pending:'Pendiente revisión',vet_select_farm:'Seleccionar Granja/Lote',
// Accessibility
cfg_font_size:'Tamaño Texto',cfg_font_small:'Pequeño',cfg_font_normal:'Normal',cfg_font_large:'Grande',cfg_font_xlarge:'Extra Grande',cfg_dark_mode:'Modo Oscuro',cfg_theme_dark:'Oscuro',
// ML/Intelligence
pred_outbreak_risk:'Riesgo de Brote',pred_outbreak_high:'Alto Riesgo',pred_outbreak_medium:'Riesgo Medio',pred_outbreak_low:'Bajo Riesgo',pred_outbreak_factor:'Factor',pred_outbreak_weight:'Peso',pred_outbreak_value:'Valor',pred_probability:'Probabilidad',pred_factors:'Factores',pred_recommendations:'Recomendaciones',pred_confidence:'Confianza',pred_forecast_7d:'7 días',pred_forecast_14d:'14 días',pred_ensemble:'Pronóstico Conjunto',pred_forecast_upper:'Banda Superior',pred_forecast_lower:'Banda Inferior',
ana_segment_profit:'Rentabilidad por Segmento',cfg_accessibility:'Accesibilidad',
rec_title:'Recomendaciones',rec_dismiss:'Descartar',rec_check_diet:'Revisar dieta / diseño de alimentación / descartar enfermedad',rec_check_env:'Verificar ambiente / enfermedad / estrés inmediatamente',rec_below_curve:'Producción bajo estándar — revisar estrés, luz, alimentación',rec_buy_feed:'Programar compra de alimento',rec_record_env:'Registrar condiciones ambientales',rec_disinfect:'Ejecutar protocolo de desinfección zona',rec_heat_plan:'Estrés calórico prolongado — activar plan de enfriamiento',rec_lab_samples:'Llevar muestras al laboratorio',rec_ventilation:'Aumentar ventilación, verificar agua fresca',
auth_welcome:'Cuenta creada. Bienvenido!',auth_error:'Credenciales incorrectas',auth_first_run:'Primera vez: ingrese usuario y contraseña para crear su cuenta.',login_subtitle:'Ingrese sus credenciales',logout:'Cerrar sesión',required:'Campo obligatorio',invalid_email:'Email inválido',invalid_phone:'Teléfono inválido',must_be_number:'Debe ser un número',invalid_date:'Fecha inválida',invalid_format:'Formato inválido',min_length:'Largo mínimo',max_length:'Largo máximo',min_value:'Valor mínimo',max_value:'Valor máximo',error_network:'Error de red',error_unexpected:'Error inesperado',error_loading:'Error al cargar'
},en:{
save:'Save',cancel:'Cancel',delete:'Delete',edit:'Edit',add:'Add',close:'Close',actions:'Actions',date:'Date',notes:'Notes',name:'Name',phone:'Phone',email:'Email',address:'Address',confirm_delete:'Delete this record?',no_data:'No data recorded',total:'Total',all:'All',loading:'Loading',search:'Search',from:'From',to:'To',status:'Status',export_csv:'Export CSV',today:'Today',active:'Active',inactive:'Inactive',
nav_dashboard:'Dashboard',nav_production:'Production',nav_flocks:'Flocks',nav_health:'Health',nav_feed:'Feed',nav_clients:'Clients',nav_finances:'Finances',nav_analysis:'Analysis',nav_operations:'Operations',nav_environment:'Environment',nav_config:'Settings',nav_admin:'SaaS Admin',nav_inventory:'Inventory',grp_production:'Production',grp_health:'Health',grp_commercial:'Commercial',grp_management:'Management',grp_system:'System',
dash_title:'Main Dashboard',kpi_today:'Production Today',kpi_henday:'Hen-Day Rate',kpi_fcr:'Feed Conversion (FCR)',kpi_mortality:'Mortality',kpi_cost_egg:'Cost/Egg',kpi_income_net:'Net Income',kpi_alerts:'Alerts',kpi_active_hens:'Active Hens',kpi_active_flocks:'Active Flocks',dash_alerts:'Alerts',dash_trend:'30 Day Trend',dash_no_alerts:'No alerts',dash_snapshot:'Save KPI Snapshot',dash_kpi_history:'KPI History',
alert_vaccine_overdue:'Vaccine overdue',alert_vaccine_soon:'Vaccine upcoming',alert_low_feed:'Feed stock low',alert_high_mortality:'High mortality',alert_active_outbreak:'Active outbreak',alert_withdrawal:'Active withdrawal',
flock_title:'Flock Management',flock_add:'New Flock',flock_name:'Name',flock_breed:'Breed',flock_count:'Initial Count',flock_birthdate:'Birth Date',flock_purchase_date:'Purchase Date',flock_supplier:'Supplier',flock_cost:'Total Cost',flock_status:'Status',flock_notes:'Notes',flock_age:'Age',flock_health:'Health',flock_weeks:'wks',flock_days:'days',flock_current:'Current',flock_status_cria:'Brooding',flock_status_recria:'Growing',flock_status_produccion:'Production',flock_status_descarte:'Culled',flock_edit:'Edit Flock',flock_lifecycle:'Lifecycle',flock_roadmap:'Roadmap',
lc_pollito:'Chick',lc_cria:'Brooding',lc_recria:'Growing',lc_prepostura:'Pre-lay',lc_pico:'Peak Lay',lc_media:'Mid Lay',lc_baja:'Low Lay',lc_descarte:'Culled',lc_feed:'Feed',lc_temp:'Temp',lc_weeks:'Weeks',lc_milestone:'Milestones',lc_current_stage:'Current Stage',
prod_title:'Production Log',prod_add:'New Record',prod_flock:'Flock',prod_eggs:'Eggs Collected',prod_broken:'Broken/Defective',prod_size_s:'Small (S)',prod_size_m:'Medium (M)',prod_size_l:'Large (L)',prod_size_xl:'Extra Large (XL)',prod_size_jumbo:'Jumbo',prod_shell:'Shell Color',prod_yolk:'Yolk Quality (1-10)',prod_deaths:'Deaths',prod_death_cause:'Cause of Death',prod_date:'Date',
san_title:'Health Management',san_vaccines:'Vaccines',san_medications:'Medications',san_outbreaks:'Outbreaks',
vac_title:'Vaccination Plan',vac_add:'Record Vaccine',vac_vaccine:'Vaccine',vac_scheduled:'Scheduled',vac_applied:'Applied',vac_batch:'Batch',vac_route:'Route',vac_overdue:'Overdue',vac_upcoming:'Upcoming',vac_applied_status:'Applied',vac_pending:'Pending',vac_generate:'Generate Calendar',vac_mark_applied:'Mark Applied',
med_title:'Medications',med_add:'Record Medication',med_name:'Medication',med_reason:'Reason',med_start:'Start',med_end:'End',med_withdrawal:'Withdrawal Days',med_withdrawal_end:'Withdrawal End',med_dosage:'Dosage',med_in_withdrawal:'In Withdrawal',
out_title:'Outbreaks',out_add:'Record Outbreak',out_disease:'Disease',out_start:'Start',out_end:'End',out_affected:'Affected',out_deaths:'Deaths',out_symptoms:'Symptoms',out_treatment:'Treatment',out_loss:'Economic Loss',out_active:'Active',out_controlled:'Controlled',out_resolved:'Resolved',
feed_title:'Feed Management',feed_purchases:'Purchases',feed_consumption:'Consumption',feed_stock:'Current Stock',feed_add_purchase:'New Purchase',feed_add_consumption:'Record Consumption',feed_type:'Type',feed_qty:'Quantity (kg)',feed_cost:'Cost',feed_supplier:'Supplier',feed_flock:'Flock',feed_low_alert:'Low stock',
cli_title:'Clients',cli_add:'New Client',cli_route:'Route/Zone',cli_price:'Agreed Prices',cli_total:'Total Clients',
fin_title:'Finances',fin_income:'Income',fin_expenses:'Expenses',fin_receivables:'Receivables',fin_summary:'Summary',fin_add_income:'New Income',fin_add_expense:'New Expense',fin_add_receivable:'New Receivable',fin_type:'Type',fin_qty:'Quantity',fin_unit_price:'Unit Price',fin_client:'Client',fin_category:'Category',fin_description:'Description',fin_amount:'Amount',fin_due_date:'Due Date',fin_paid:'Paid',fin_total_income:'Total Income',fin_total_expenses:'Total Expenses',fin_net:'Net Result',fin_cost_per_egg:'Cost/Egg',fin_break_even:'Break-even',fin_month:'Month',
fin_cat_feed:'Feed',fin_cat_vaccines:'Vaccines/Meds',fin_cat_transport:'Transport',fin_cat_labor:'Labor',fin_cat_infrastructure:'Infrastructure',fin_cat_bird_purchase:'Bird Purchase',fin_cat_other:'Other',
fin_type_eggs:'Egg Sales',fin_type_birds:'Bird Sales',fin_type_manure:'Manure Sales',fin_type_other:'Other',
ana_title:'Analysis',ana_comparison:'Flock Comparison',ana_seasonality:'Seasonality',ana_profitability:'Profitability',ana_benchmarks:'Benchmarks',ana_best_flock:'Best Flock',ana_worst_flock:'Worst Flock',ana_avg_production:'Avg Production',ana_trend:'Trend',ana_kpi_evolution:'KPI Evolution',ana_no_snapshots:'No snapshots. Save snapshots from Dashboard.',
ops_title:'Operations',ops_checklist:'Daily Checklist',ops_logbook:'Logbook',ops_personnel:'Personnel',ops_task:'Task',ops_done:'Completed',ops_add_task:'Add Task',ops_check_date:'Date',ops_log_entry:'Entry',ops_log_category:'Category',ops_log_add:'New Entry',
ops_log_cat_general:'General',ops_log_cat_health:'Health',ops_log_cat_production:'Production',ops_log_cat_maintenance:'Maintenance',ops_log_cat_observation:'Observation',
ops_per_name:'Name',ops_per_role:'Role',ops_per_salary:'Salary',ops_per_start:'Start Date',ops_per_active:'Active',ops_per_add:'Add Personnel',
env_title:'Environmental Conditions',env_add:'New Record',env_temp:'Temperature (°C)',env_humidity:'Humidity (%)',env_light:'Light Hours',env_ventilation:'Ventilation',env_density:'Density (birds/m²)',env_optimal:'Optimal Range',env_temp_range:'18-24°C',env_humidity_range:'40-70%',env_light_range:'14-16 hrs',env_density_range:'4-5 birds/m²',
cfg_title:'Settings',cfg_farm:'Farm Details',cfg_farm_name:'Farm Name',cfg_location:'Location',cfg_capacity:'Capacity (birds)',cfg_currency:'Currency',cfg_alerts:'Alert Thresholds',cfg_min_feed:'Min Feed Stock (kg)',cfg_max_mortality:'Max Mortality (%)',cfg_alert_days:'Alert Days Ahead',cfg_data:'Data',cfg_export:'Export (JSON)',cfg_import:'Import (JSON)',cfg_reset:'Delete All',cfg_reset_confirm:'Delete ALL data permanently?',cfg_saved:'Saved',cfg_exported:'Data exported',cfg_imported:'Data imported',cfg_reset_done:'Data deleted',cfg_checklist:'Default Checklist',cfg_checklist_items:'Daily checklist tasks',cfg_theme:'Color Theme',cfg_theme_blue:'Navy Blue',cfg_theme_green:'Green',cfg_theme_purple:'Purple',cfg_theme_black:'Black',
sidebar_subtitle:'Poultry System 360°',prod_shell_white:'White',prod_shell_brown:'Brown',prod_shell_cream:'Cream',required:'Required field',no_flocks_birthdate:'No flocks with birth date',vac_select_flocks:'Select flocks to generate calendar:',feed_type_placeholder:'Layer, Starter, etc.',avg_per_day:'Avg/day',per_flock:'Flock',history:'History',env_latest_reading:'Latest Reading',env_ok:'OK',env_out_of_range:'Out of range',data_stats:'Data Statistics',final_warning:'⚠️ FINAL WARNING — ALL data will be deleted',total_salaries:'Total Salaries',eggs_unit:'eggs',csv_income:'Income',csv_expense:'Expense',fcr_unit:'kg feed/kg egg',lc_feed_starter:'Starter',lc_feed_grower:'Grower',lc_feed_developer:'Developer',lc_feed_prelay:'Pre-lay',lc_feed_layer:'Layer',lc_feed_lowlay:'Low-lay',lc_prod_label:'Prod',lc_prod_first:'First eggs',lc_mile_1:'Marek, Newcastle+IB, Gumboro vaccines',lc_mile_2:'Newcastle booster, feather development',lc_mile_3:'Fowl Pox, AE, Coryza, Salmonella',lc_mile_4:'Newcastle+IB booster, diet change, 16h light',lc_mile_5:'Peak production wk 26-30, monitor FCR',lc_mile_6:'Newcastle booster every 8-12 wk, evaluate profitability',lc_mile_7:'Evaluate culling vs forced molting',lc_mile_8:'Sell culled birds, clean house',vac_route_injection:'Injection',vac_route_ocular:'Ocular/spray',vac_route_water:'Water',vac_route_wing:'Wing web',snapshots:'snapshots',error_prefix:'Error',chk_collect_eggs:'Collect eggs',chk_feed_birds:'Feed birds',chk_check_water:'Check water',chk_check_health:'Check health',chk_cleaning:'Cleaning',chk_record_temp:'Record temperature',
weather_title:'Weather',weather_temp:'Temperature',weather_humidity:'Humidity',weather_wind:'Wind',weather_forecast:'3-Day Forecast',weather_no_key:'Configure OpenWeatherMap API key in Settings',weather_heat_alert:'Heat Stress Alert',weather_thi:'THI Index',weather_feels:'Feels like',weather_last_update:'Last updated',weather_test:'Test',
geo_set_location:'Farm Location',geo_use_gps:'Use my GPS',geo_click_map:'Click map to set location',geo_lat:'Latitude',geo_lng:'Longitude',geo_saved:'Location saved',
iot_title:'IoT Sensors',iot_broker:'MQTT Broker (wss://)',iot_user:'MQTT User',iot_pass:'MQTT Password',iot_topic:'Topic Prefix',iot_connect:'Connect',iot_disconnect:'Disconnect',iot_live:'IoT Live',iot_no_config:'Configure MQTT in Settings',iot_save_reading:'Save current reading',iot_connected:'Connected',iot_disconnected:'Disconnected',iot_ammonia:'Ammonia',iot_light:'Light',iot_lux:'lux',iot_ppm:'ppm',
pred_title:'Predictions',pred_forecast:'Production Forecast',pred_anomaly:'Anomalies',pred_drop_risk:'Drop Risk',pred_breed_curve:'Breed Curve',pred_fcr_trend:'FCR Trend',pred_next_7d:'Next 7 days',pred_improving:'Improving',pred_worsening:'Worsening',pred_stable:'Stable',pred_score:'Score',pred_low:'Low',pred_medium:'Medium',pred_high:'High',pred_vs_expected:'Actual vs Expected',
stress_title:'Stress Events',stress_type:'Type',stress_severity:'Severity',stress_heat:'Heat',stress_disease:'Disease',stress_feed_change:'Feed Change',stress_power:'Power Outage',stress_predator:'Predator',stress_other:'Other',stress_description:'Description',stress_add:'New Event',stress_impact:'Production Impact',stress_auto:'(Auto-generated)',
env_ammonia:'Ammonia (ppm)',env_wind:'Wind Speed (km/h)',env_thi:'THI Index',env_manual:'Manual Entry',env_history:'History',env_iot:'IoT Live',
pwa_install:'Install App',pwa_offline:'Offline Mode Available',
cfg_owm_key:'OpenWeatherMap API Key',cfg_mqtt:'MQTT Settings',cfg_geo:'Geolocation',
flock_housing:'Housing Type',flock_housing_floor:'Floor',flock_housing_cage:'Cage',flock_housing_free:'Free-range',flock_target_curve:'Target Curve',flock_egg_color:'Egg Color',
ana_predictions:'Predictions',
per_day:'per day',actual:'Actual',expected:'Expected',not_available:'not available',
nav_biosecurity:'Biosecurity',bio_title:'Biosecurity & Pest Control',bio_visitors:'Visitors',bio_zones:'Zones',bio_pests:'Pests',bio_protocols:'Protocols',
bio_add_visitor:'New Visitor',bio_visitor_name:'Name',bio_visitor_company:'Company',bio_visitor_purpose:'Purpose',bio_visitor_zone:'Zone',bio_visitor_plate:'Vehicle Plate',bio_visitor_disinfected:'Disinfected',bio_visitor_from_farm:'Origin Farm',bio_visitor_from_health:'Origin Farm Health',bio_cross_risk:'⚠️ Cross-contamination risk',
bio_add_zone:'New Zone',bio_zone_name:'Zone Name',bio_zone_risk:'Risk Level',bio_zone_last_disinfection:'Last Disinfection',bio_zone_frequency:'Frequency (days)',bio_risk_green:'Green',bio_risk_yellow:'Yellow',bio_risk_red:'Red',
bio_add_pest:'New Sighting',bio_pest_type:'Type',bio_pest_rodent:'Rodent',bio_pest_fly:'Fly',bio_pest_wild_bird:'Wild Bird',bio_pest_other:'Other',bio_pest_location:'Location',bio_pest_severity:'Severity',bio_pest_action:'Action Taken',bio_pest_resolved:'Resolved',
bio_add_protocol:'New Protocol',bio_protocol_name:'Protocol Name',bio_protocol_frequency:'Frequency',bio_protocol_daily:'Daily',bio_protocol_weekly:'Weekly',bio_protocol_monthly:'Monthly',bio_protocol_last:'Last Completed',bio_protocol_items:'Protocol Items',bio_protocol_complete:'Complete',bio_protocol_overdue:'Overdue',
bio_pest_score:'Pest Score',bio_overdue_disinfection:'Overdue disinfection',bio_unresolved_pests:'Unresolved pests',
alert_bio_disinfection:'Zone disinfection overdue',alert_bio_pests:'Unresolved pests',alert_bio_cross:'Cross-contamination risk',
nav_traceability:'Traceability',trace_title:'Egg Traceability',trace_add:'New Batch',trace_batch_id:'Batch ID',trace_rack:'Rack',trace_box_count:'Boxes',trace_eggs_per_box:'Eggs/Box',trace_qr:'QR Code',trace_delivery:'Delivery Date',trace_search:'Search by ID/QR',trace_origin:'Origin',trace_house:'House',
nav_planning:'Planning',plan_title:'Production Planning',plan_add:'New Plan',plan_name:'Plan Name',plan_target_date:'Target Date',plan_eggs_needed:'Eggs Needed',plan_allocations:'Flock Allocations',plan_expected:'Expected Production',plan_gap:'Gap',plan_on_track:'On Track',plan_behind:'Behind',plan_ahead:'Ahead',plan_estimate:'Estimate',plan_commitment:'Commitment',
prod_egg_type:'Egg Type',prod_type_conventional:'Conventional',prod_type_free_range:'Free Range',prod_type_organic:'Organic',prod_type_pasture:'Pasture Raised',prod_type_decorative:'Decorative',
prod_market:'Market Channel',prod_market_wholesale:'Wholesale',prod_market_supermarket:'Supermarket',prod_market_restaurant:'Restaurant',prod_market_direct:'Direct Sale',prod_market_export:'Export',prod_market_pasteurized:'Pasteurized',
ana_by_segment:'Profitability by Segment',ana_by_type:'By Type',ana_by_channel:'By Channel',
nav_campo_mode:'Campo Mode',nav_vet_mode:'Vet Mode',campo_today:'TODAY',campo_quick_entry:'Quick Entry',vet_visit:'Visit completed',vet_vaccines:'Vaccines applied',vet_pending:'Pending review',vet_select_farm:'Select Farm/Flock',
cfg_font_size:'Text Size',cfg_font_small:'Small',cfg_font_normal:'Normal',cfg_font_large:'Large',cfg_font_xlarge:'Extra Large',cfg_dark_mode:'Dark Mode',cfg_theme_dark:'Dark',
pred_outbreak_risk:'Outbreak Risk',pred_outbreak_high:'High Risk',pred_outbreak_medium:'Medium Risk',pred_outbreak_low:'Low Risk',pred_outbreak_factor:'Factor',pred_outbreak_weight:'Weight',pred_outbreak_value:'Value',pred_probability:'Probability',pred_factors:'Factors',pred_recommendations:'Recommendations',pred_confidence:'Confidence',pred_forecast_7d:'7 days',pred_forecast_14d:'14 days',pred_ensemble:'Ensemble Forecast',pred_forecast_upper:'Upper Band',pred_forecast_lower:'Lower Band',
ana_segment_profit:'Profitability by Segment',cfg_accessibility:'Accessibility',
rec_title:'Recommendations',rec_dismiss:'Dismiss',rec_check_diet:'Check diet / feed design / rule out disease',rec_check_env:'Check environment / disease / stress immediately',rec_below_curve:'Below standard production — check stress, light, feed',rec_buy_feed:'Schedule feed purchase',rec_record_env:'Record environmental conditions',rec_disinfect:'Execute disinfection protocol zone',rec_heat_plan:'Prolonged heat stress — activate cooling plan',rec_lab_samples:'Take samples to laboratory',rec_ventilation:'Increase ventilation, check fresh water',
auth_welcome:'Account created. Welcome!',auth_error:'Invalid credentials',auth_first_run:'First time: enter username and password to create your account.',login_subtitle:'Enter your credentials',logout:'Logout',required:'Required field',invalid_email:'Invalid email',invalid_phone:'Invalid phone',must_be_number:'Must be a number',invalid_date:'Invalid date',invalid_format:'Invalid format',min_length:'Min length',max_length:'Max length',min_value:'Min value',max_value:'Max value',error_network:'Network error',error_unexpected:'Unexpected error',error_loading:'Loading error'
},pt:{
save:'Salvar',cancel:'Cancelar',delete:'Excluir',edit:'Editar',add:'Adicionar',close:'Fechar',actions:'Ações',date:'Data',notes:'Observações',name:'Nome',phone:'Telefone',email:'Email',address:'Endereço',confirm_delete:'Excluir este registro?',no_data:'Nenhum dado registrado',total:'Total',all:'Todos',loading:'Carregando',search:'Buscar',from:'De',to:'Até',status:'Status',export_csv:'Exportar CSV',today:'Hoje',active:'Ativo',inactive:'Inativo',
nav_dashboard:'Dashboard',nav_production:'Produção',nav_flocks:'Lotes',nav_health:'Sanidade',nav_feed:'Alimentação',nav_clients:'Clientes',nav_finances:'Finanças',nav_analysis:'Análise',nav_operations:'Operações',nav_environment:'Ambiente',nav_config:'Configuração',nav_admin:'Admin SaaS',nav_inventory:'Inventário',grp_production:'Produção',grp_health:'Saúde',grp_commercial:'Comercial',grp_management:'Gestão',grp_system:'Sistema',
dash_title:'Painel Principal',kpi_today:'Produção Hoje',kpi_henday:'Taxa Hen-Day',kpi_fcr:'Conversão (FCR)',kpi_mortality:'Mortalidade',kpi_cost_egg:'Custo/Ovo',kpi_income_net:'Receita Líquida',kpi_alerts:'Alertas',kpi_active_hens:'Galinhas Ativas',kpi_active_flocks:'Lotes Ativos',dash_alerts:'Alertas',dash_trend:'Tendência 30 Dias',dash_no_alerts:'Sem alertas',dash_snapshot:'Salvar Snapshot KPI',dash_kpi_history:'Histórico KPI',
alert_vaccine_overdue:'Vacina vencida',alert_vaccine_soon:'Vacina próxima',alert_low_feed:'Estoque de ração baixo',alert_high_mortality:'Mortalidade alta',alert_active_outbreak:'Surto ativo',alert_withdrawal:'Carência ativa',
flock_title:'Gestão de Lotes',flock_add:'Novo Lote',flock_name:'Nome',flock_breed:'Raça',flock_count:'Quantidade Inicial',flock_birthdate:'Data de Nascimento',flock_purchase_date:'Data de Compra',flock_supplier:'Fornecedor',flock_cost:'Custo Total',flock_status:'Status',flock_notes:'Observações',flock_age:'Idade',flock_health:'Saúde',flock_weeks:'sem',flock_days:'dias',flock_current:'Atuais',flock_status_cria:'Cria',flock_status_recria:'Recria',flock_status_produccion:'Produção',flock_status_descarte:'Descarte',flock_edit:'Editar Lote',flock_lifecycle:'Ciclo de Vida',flock_roadmap:'Roadmap',
lc_pollito:'Pintinho',lc_cria:'Cria',lc_recria:'Recria',lc_prepostura:'Pré-postura',lc_pico:'Postura Pico',lc_media:'Postura Média',lc_baja:'Postura Baixa',lc_descarte:'Descarte',lc_feed:'Ração',lc_temp:'Temp',lc_weeks:'Semanas',lc_milestone:'Marcos',lc_current_stage:'Etapa Atual',
prod_title:'Registro de Produção',prod_add:'Novo Registro',prod_flock:'Lote',prod_eggs:'Ovos Coletados',prod_broken:'Quebrados/Defeituosos',prod_size_s:'Pequeno (S)',prod_size_m:'Médio (M)',prod_size_l:'Grande (L)',prod_size_xl:'Extra Grande (XL)',prod_size_jumbo:'Jumbo',prod_shell:'Cor da Casca',prod_yolk:'Qualidade Gema (1-10)',prod_deaths:'Mortes',prod_death_cause:'Causa da Morte',prod_date:'Data',
san_title:'Sanidade',san_vaccines:'Vacinas',san_medications:'Medicamentos',san_outbreaks:'Surtos',
vac_title:'Plano de Vacinação',vac_add:'Registrar Vacina',vac_vaccine:'Vacina',vac_scheduled:'Programada',vac_applied:'Aplicada',vac_batch:'Lote Vacina',vac_route:'Via',vac_overdue:'Vencida',vac_upcoming:'Próxima',vac_applied_status:'Aplicada',vac_pending:'Pendente',vac_generate:'Gerar Calendário',vac_mark_applied:'Marcar Aplicada',
med_title:'Medicamentos',med_add:'Registrar Medicamento',med_name:'Medicamento',med_reason:'Motivo',med_start:'Início',med_end:'Fim',med_withdrawal:'Dias de Carência',med_withdrawal_end:'Fim da Carência',med_dosage:'Dosagem',med_in_withdrawal:'Em Carência',
out_title:'Surtos',out_add:'Registrar Surto',out_disease:'Doença',out_start:'Início',out_end:'Fim',out_affected:'Afetadas',out_deaths:'Mortes',out_symptoms:'Sintomas',out_treatment:'Tratamento',out_loss:'Perda Econômica',out_active:'Ativo',out_controlled:'Controlado',out_resolved:'Resolvido',
feed_title:'Alimentação',feed_purchases:'Compras',feed_consumption:'Consumo',feed_stock:'Estoque Atual',feed_add_purchase:'Nova Compra',feed_add_consumption:'Registrar Consumo',feed_type:'Tipo',feed_qty:'Quantidade (kg)',feed_cost:'Custo',feed_supplier:'Fornecedor',feed_flock:'Lote',feed_low_alert:'Estoque baixo',
cli_title:'Clientes',cli_add:'Novo Cliente',cli_route:'Rota/Zona',cli_price:'Preços Acordados',cli_total:'Total de Clientes',
fin_title:'Finanças',fin_income:'Receitas',fin_expenses:'Despesas',fin_receivables:'Contas a Receber',fin_summary:'Resumo',fin_add_income:'Nova Receita',fin_add_expense:'Nova Despesa',fin_add_receivable:'Nova Conta',fin_type:'Tipo',fin_qty:'Quantidade',fin_unit_price:'Preço Unit.',fin_client:'Cliente',fin_category:'Categoria',fin_description:'Descrição',fin_amount:'Valor',fin_due_date:'Vencimento',fin_paid:'Pago',fin_total_income:'Total Receitas',fin_total_expenses:'Total Despesas',fin_net:'Resultado Líquido',fin_cost_per_egg:'Custo/Ovo',fin_break_even:'Ponto de Equilíbrio',fin_month:'Mês',
fin_cat_feed:'Ração',fin_cat_vaccines:'Vacinas/Med.',fin_cat_transport:'Transporte',fin_cat_labor:'Mão de Obra',fin_cat_infrastructure:'Infraestrutura',fin_cat_bird_purchase:'Compra de Aves',fin_cat_other:'Outros',
fin_type_eggs:'Venda de Ovos',fin_type_birds:'Venda de Aves',fin_type_manure:'Venda de Adubo',fin_type_other:'Outro',
ana_title:'Análise',ana_comparison:'Comparação de Lotes',ana_seasonality:'Sazonalidade',ana_profitability:'Rentabilidade',ana_benchmarks:'Benchmarks',ana_best_flock:'Melhor Lote',ana_worst_flock:'Pior Lote',ana_avg_production:'Produção Média',ana_trend:'Tendência',ana_kpi_evolution:'Evolução KPI',ana_no_snapshots:'Sem snapshots. Salve snapshots pelo Dashboard.',
ops_title:'Operações',ops_checklist:'Checklist Diário',ops_logbook:'Diário de Bordo',ops_personnel:'Pessoal',ops_task:'Tarefa',ops_done:'Concluído',ops_add_task:'Adicionar Tarefa',ops_check_date:'Data',ops_log_entry:'Entrada',ops_log_category:'Categoria',ops_log_add:'Nova Entrada',
ops_log_cat_general:'Geral',ops_log_cat_health:'Sanidade',ops_log_cat_production:'Produção',ops_log_cat_maintenance:'Manutenção',ops_log_cat_observation:'Observação',
ops_per_name:'Nome',ops_per_role:'Cargo',ops_per_salary:'Salário',ops_per_start:'Data de Início',ops_per_active:'Ativo',ops_per_add:'Adicionar Pessoal',
env_title:'Condições Ambientais',env_add:'Novo Registro',env_temp:'Temperatura (°C)',env_humidity:'Umidade (%)',env_light:'Horas de Luz',env_ventilation:'Ventilação',env_density:'Densidade (aves/m²)',env_optimal:'Faixa Ideal',env_temp_range:'18-24°C',env_humidity_range:'40-70%',env_light_range:'14-16 hrs',env_density_range:'4-5 aves/m²',
cfg_title:'Configuração',cfg_farm:'Dados da Granja',cfg_farm_name:'Nome da Granja',cfg_location:'Localização',cfg_capacity:'Capacidade (aves)',cfg_currency:'Moeda',cfg_alerts:'Limites de Alertas',cfg_min_feed:'Estoque Mín. Ração (kg)',cfg_max_mortality:'Mortalidade Máx. (%)',cfg_alert_days:'Dias de Antecedência',cfg_data:'Dados',cfg_export:'Exportar (JSON)',cfg_import:'Importar (JSON)',cfg_reset:'Excluir Tudo',cfg_reset_confirm:'Excluir TODOS os dados permanentemente?',cfg_saved:'Salvo',cfg_exported:'Dados exportados',cfg_imported:'Dados importados',cfg_reset_done:'Dados excluídos',cfg_checklist:'Checklist Padrão',cfg_checklist_items:'Tarefas do checklist diário',cfg_theme:'Tema de Cor',cfg_theme_blue:'Azul Marinho',cfg_theme_green:'Verde',cfg_theme_purple:'Roxo',cfg_theme_black:'Preto',
sidebar_subtitle:'Sistema Avícola 360°',prod_shell_white:'Branco',prod_shell_brown:'Marrom',prod_shell_cream:'Creme',required:'Campo obrigatório',no_flocks_birthdate:'Nenhum lote com data de nascimento',vac_select_flocks:'Selecione lotes para gerar calendário:',feed_type_placeholder:'Postura, Inicial, etc.',avg_per_day:'Méd/dia',per_flock:'Lote',history:'Histórico',env_latest_reading:'Última Leitura',env_ok:'OK',env_out_of_range:'Fora da faixa',data_stats:'Estatísticas de Dados',final_warning:'⚠️ AVISO FINAL — TODOS os dados serão excluídos',total_salaries:'Total Salários',eggs_unit:'ovos',csv_income:'Receita',csv_expense:'Despesa',fcr_unit:'kg ração/kg ovo',lc_feed_starter:'Inicial',lc_feed_grower:'Crescimento',lc_feed_developer:'Desenvolvimento',lc_feed_prelay:'Pré-postura',lc_feed_layer:'Postura',lc_feed_lowlay:'Postura baixa',lc_prod_label:'Prod',lc_prod_first:'Primeiros ovos',lc_mile_1:'Vacinas Marek, Newcastle+BI, Gumboro',lc_mile_2:'Newcastle reforço, desenvolvimento plumagem',lc_mile_3:'Varíola, Encefalomielite, Coriza, Salmonela',lc_mile_4:'Newcastle+BI reforço, mudança dieta, 16h luz',lc_mile_5:'Pico produção sem 26-30, monitorar FCR',lc_mile_6:'Newcastle reforço a cada 8-12 sem, avaliar rentabilidade',lc_mile_7:'Avaliar descarte vs muda forçada',lc_mile_8:'Venda ave descarte, limpeza galpão',vac_route_injection:'Injeção',vac_route_ocular:'Ocular/spray',vac_route_water:'Água',vac_route_wing:'Punção alar',snapshots:'snapshots',error_prefix:'Erro',chk_collect_eggs:'Coletar ovos',chk_feed_birds:'Alimentar aves',chk_check_water:'Verificar água',chk_check_health:'Verificar saúde',chk_cleaning:'Limpeza',chk_record_temp:'Registrar temperatura',
weather_title:'Clima',weather_temp:'Temperatura',weather_humidity:'Umidade',weather_wind:'Vento',weather_forecast:'Previsão 3 Dias',weather_no_key:'Configure a chave API OpenWeatherMap em Configuração',weather_heat_alert:'Alerta de Estresse Térmico',weather_thi:'Índice THI',weather_feels:'Sensação',weather_last_update:'Última atualização',weather_test:'Testar',
geo_set_location:'Localização da Granja',geo_use_gps:'Usar meu GPS',geo_click_map:'Clique no mapa para localizar',geo_lat:'Latitude',geo_lng:'Longitude',geo_saved:'Localização salva',
iot_title:'IoT Sensores',iot_broker:'Broker MQTT (wss://)',iot_user:'Usuário MQTT',iot_pass:'Senha MQTT',iot_topic:'Prefixo Tópico',iot_connect:'Conectar',iot_disconnect:'Desconectar',iot_live:'IoT Ao Vivo',iot_no_config:'Configure MQTT em Configuração',iot_save_reading:'Salvar leitura atual',iot_connected:'Conectado',iot_disconnected:'Desconectado',iot_ammonia:'Amônia',iot_light:'Luz',iot_lux:'lux',iot_ppm:'ppm',
pred_title:'Predições',pred_forecast:'Previsão de Produção',pred_anomaly:'Anomalias',pred_drop_risk:'Risco de Queda',pred_breed_curve:'Curva da Raça',pred_fcr_trend:'Tendência FCR',pred_next_7d:'Próximos 7 dias',pred_improving:'Melhorando',pred_worsening:'Piorando',pred_stable:'Estável',pred_score:'Pontuação',pred_low:'Baixo',pred_medium:'Médio',pred_high:'Alto',pred_vs_expected:'Real vs Esperado',
stress_title:'Eventos de Estresse',stress_type:'Tipo',stress_severity:'Severidade',stress_heat:'Calor',stress_disease:'Doença',stress_feed_change:'Mudança de Ração',stress_power:'Queda de Energia',stress_predator:'Predador',stress_other:'Outro',stress_description:'Descrição',stress_add:'Novo Evento',stress_impact:'Impacto na Produção',stress_auto:'(Auto-gerado)',
env_ammonia:'Amônia (ppm)',env_wind:'Velocidade do Vento (km/h)',env_thi:'Índice THI',env_manual:'Entrada Manual',env_history:'Histórico',env_iot:'IoT Ao Vivo',
pwa_install:'Instalar App',pwa_offline:'Modo Offline Disponível',
cfg_owm_key:'Chave API OpenWeatherMap',cfg_mqtt:'Configuração MQTT',cfg_geo:'Geolocalização',
flock_housing:'Tipo de Alojamento',flock_housing_floor:'Piso',flock_housing_cage:'Gaiola',flock_housing_free:'Livre',flock_target_curve:'Curva Alvo',flock_egg_color:'Cor do Ovo',
ana_predictions:'Predições',
per_day:'por dia',actual:'Real',expected:'Esperado',not_available:'não disponível',
nav_biosecurity:'Biossegurança',bio_title:'Biossegurança e Controle de Pragas',bio_visitors:'Visitantes',bio_zones:'Zonas',bio_pests:'Pragas',bio_protocols:'Protocolos',
bio_add_visitor:'Novo Visitante',bio_visitor_name:'Nome',bio_visitor_company:'Empresa',bio_visitor_purpose:'Propósito',bio_visitor_zone:'Zona',bio_visitor_plate:'Placa Veículo',bio_visitor_disinfected:'Desinfetado',bio_visitor_from_farm:'Granja de Origem',bio_visitor_from_health:'Saúde Granja Origem',bio_cross_risk:'⚠️ Risco de contaminação cruzada',
bio_add_zone:'Nova Zona',bio_zone_name:'Nome da Zona',bio_zone_risk:'Nível de Risco',bio_zone_last_disinfection:'Última Desinfecção',bio_zone_frequency:'Frequência (dias)',bio_risk_green:'Verde',bio_risk_yellow:'Amarelo',bio_risk_red:'Vermelho',
bio_add_pest:'Novo Avistamento',bio_pest_type:'Tipo',bio_pest_rodent:'Roedor',bio_pest_fly:'Mosca',bio_pest_wild_bird:'Ave Silvestre',bio_pest_other:'Outro',bio_pest_location:'Localização',bio_pest_severity:'Severidade',bio_pest_action:'Ação Tomada',bio_pest_resolved:'Resolvido',
bio_add_protocol:'Novo Protocolo',bio_protocol_name:'Nome do Protocolo',bio_protocol_frequency:'Frequência',bio_protocol_daily:'Diário',bio_protocol_weekly:'Semanal',bio_protocol_monthly:'Mensal',bio_protocol_last:'Último Completado',bio_protocol_items:'Itens do Protocolo',bio_protocol_complete:'Completar',bio_protocol_overdue:'Vencido',
bio_pest_score:'Pontuação de Pragas',bio_overdue_disinfection:'Desinfecção vencida',bio_unresolved_pests:'Pragas não resolvidas',
alert_bio_disinfection:'Desinfecção de zona vencida',alert_bio_pests:'Pragas não resolvidas',alert_bio_cross:'Risco de contaminação cruzada',
nav_traceability:'Rastreabilidade',trace_title:'Rastreabilidade de Ovos',trace_add:'Novo Lote',trace_batch_id:'ID do Lote',trace_rack:'Rack',trace_box_count:'Caixas',trace_eggs_per_box:'Ovos/Caixa',trace_qr:'Código QR',trace_delivery:'Data de Entrega',trace_search:'Buscar por ID/QR',trace_origin:'Origem',trace_house:'Galpão',
nav_planning:'Planejamento',plan_title:'Planejamento de Produção',plan_add:'Novo Plano',plan_name:'Nome do Plano',plan_target_date:'Data Alvo',plan_eggs_needed:'Ovos Necessários',plan_allocations:'Alocação de Lotes',plan_expected:'Produção Esperada',plan_gap:'Diferença',plan_on_track:'No Alvo',plan_behind:'Atrasado',plan_ahead:'Adiantado',plan_estimate:'Estimativa',plan_commitment:'Compromisso',
prod_egg_type:'Tipo de Ovo',prod_type_conventional:'Convencional',prod_type_free_range:'Caipira',prod_type_organic:'Orgânico',prod_type_pasture:'Pastoreio',prod_type_decorative:'Decorativo',
prod_market:'Canal de Venda',prod_market_wholesale:'Atacado',prod_market_supermarket:'Supermercado',prod_market_restaurant:'Restaurante',prod_market_direct:'Venda Direta',prod_market_export:'Exportação',prod_market_pasteurized:'Pasteurizado',
ana_by_segment:'Rentabilidade por Segmento',ana_by_type:'Por Tipo',ana_by_channel:'Por Canal',
nav_campo_mode:'Modo Campo',nav_vet_mode:'Modo Vet',campo_today:'HOJE',campo_quick_entry:'Entrada Rápida',vet_visit:'Visita realizada',vet_vaccines:'Vacinas aplicadas',vet_pending:'Pendente revisão',vet_select_farm:'Selecionar Granja/Lote',
cfg_font_size:'Tamanho do Texto',cfg_font_small:'Pequeno',cfg_font_normal:'Normal',cfg_font_large:'Grande',cfg_font_xlarge:'Extra Grande',cfg_dark_mode:'Modo Escuro',cfg_theme_dark:'Escuro',
pred_outbreak_risk:'Risco de Surto',pred_outbreak_high:'Alto Risco',pred_outbreak_medium:'Risco Médio',pred_outbreak_low:'Baixo Risco',pred_outbreak_factor:'Fator',pred_outbreak_weight:'Peso',pred_outbreak_value:'Valor',pred_probability:'Probabilidade',pred_factors:'Fatores',pred_recommendations:'Recomendações',pred_confidence:'Confiança',pred_forecast_7d:'7 dias',pred_forecast_14d:'14 dias',pred_ensemble:'Previsão Conjunta',pred_forecast_upper:'Banda Superior',pred_forecast_lower:'Banda Inferior',
ana_segment_profit:'Rentabilidade por Segmento',cfg_accessibility:'Acessibilidade',
rec_title:'Recomendações',rec_dismiss:'Descartar',rec_check_diet:'Verificar dieta / formulação de ração / descartar doença',rec_check_env:'Verificar ambiente / doença / estresse imediatamente',rec_below_curve:'Produção abaixo do padrão — verificar estresse, luz, alimentação',rec_buy_feed:'Programar compra de ração',rec_record_env:'Registrar condições ambientais',rec_disinfect:'Executar protocolo de desinfecção zona',rec_heat_plan:'Estresse térmico prolongado — ativar plano de resfriamento',rec_lab_samples:'Levar amostras ao laboratório',rec_ventilation:'Aumentar ventilação, verificar água fresca',
auth_welcome:'Conta criada. Bem-vindo!',auth_error:'Credenciais inválidas',auth_first_run:'Primeira vez: insira usuário e senha para criar sua conta.',login_subtitle:'Insira suas credenciais',logout:'Sair',required:'Campo obrigatório',invalid_email:'Email inválido',invalid_phone:'Telefone inválido',must_be_number:'Deve ser um número',invalid_date:'Data inválida',invalid_format:'Formato inválido',min_length:'Comprimento mínimo',max_length:'Comprimento máximo',min_value:'Valor mínimo',max_value:'Valor máximo',error_network:'Erro de rede',error_unexpected:'Erro inesperado',error_loading:'Erro ao carregar'
},
fr:{
save:'Enregistrer',cancel:'Annuler',delete:'Supprimer',edit:'Modifier',add:'Ajouter',close:'Fermer',actions:'Actions',date:'Date',notes:'Notes',name:'Nom',phone:'Téléphone',email:'E-mail',address:'Adresse',confirm_delete:'Supprimer cet enregistrement ?',no_data:'Aucune donnée enregistrée',total:'Total',all:'Tout',loading:'Chargement',search:'Rechercher',from:'Du',to:'Au',status:'Statut',export_csv:'Exporter CSV',today:'Aujourd\'hui',active:'Actif',inactive:'Inactif',
nav_dashboard:'Tableau de bord',nav_production:'Production',nav_flocks:'Lots',nav_health:'Santé',nav_feed:'Alimentation',nav_clients:'Clients',nav_finances:'Finances',nav_analysis:'Analyses',nav_operations:'Opérations',nav_environment:'Environnement',nav_config:'Paramètres',nav_admin:'Admin SaaS',nav_inventory:'Inventaire',grp_production:'Production',grp_health:'Santé',grp_commercial:'Commercial',grp_management:'Gestion',grp_system:'Système',
dash_title:'Tableau de bord principal',kpi_today:'Production du jour',kpi_henday:'Taux de ponte',kpi_fcr:'Indice de consommation (FCR)',kpi_mortality:'Mortalité',kpi_cost_egg:'Coût/Œuf',kpi_income_net:'Revenu net',kpi_alerts:'Alertes',kpi_active_hens:'Poules actives',kpi_active_flocks:'Lots actifs',dash_alerts:'Alertes',dash_trend:'Tendance 30 jours',dash_no_alerts:'Aucune alerte',dash_snapshot:'Sauvegarder un instantané KPI',dash_kpi_history:'Historique KPI',
alert_vaccine_overdue:'Vaccin en retard',alert_vaccine_soon:'Vaccin à venir',alert_low_feed:'Stock d\'aliment bas',alert_high_mortality:'Mortalité élevée',alert_active_outbreak:'Épidémie active',alert_withdrawal:'Délai d\'attente actif',
flock_title:'Gestion des lots',flock_add:'Nouveau lot',flock_name:'Nom',flock_breed:'Race',flock_count:'Effectif initial',flock_birthdate:'Date de naissance',flock_purchase_date:'Date d\'achat',flock_supplier:'Fournisseur',flock_cost:'Coût total',flock_status:'Statut',flock_notes:'Notes',flock_age:'Âge',flock_health:'Santé',flock_weeks:'sem',flock_days:'jours',flock_current:'Actuel',flock_status_cria:'Démarrage',flock_status_recria:'Croissance',flock_status_produccion:'Production',flock_status_descarte:'Réformé',flock_edit:'Modifier le lot',flock_lifecycle:'Cycle de vie',flock_roadmap:'Plan de route',
lc_pollito:'Poussin',lc_cria:'Démarrage',lc_recria:'Croissance',lc_prepostura:'Pré-ponte',lc_pico:'Pic de ponte',lc_media:'Mi-ponte',lc_baja:'Fin de ponte',lc_descarte:'Réformé',lc_feed:'Aliment',lc_temp:'Temp',lc_weeks:'Semaines',lc_milestone:'Étapes clés',lc_current_stage:'Stade actuel',
prod_title:'Journal de production',prod_add:'Nouvel enregistrement',prod_flock:'Lot',prod_eggs:'Œufs collectés',prod_broken:'Cassés/Défectueux',prod_size_s:'Petit (S)',prod_size_m:'Moyen (M)',prod_size_l:'Gros (L)',prod_size_xl:'Très gros (XL)',prod_size_jumbo:'Jumbo',prod_shell:'Couleur de coquille',prod_yolk:'Qualité du jaune (1-10)',prod_deaths:'Mortalités',prod_death_cause:'Cause de mortalité',prod_date:'Date',
san_title:'Gestion sanitaire',san_vaccines:'Vaccins',san_medications:'Médicaments',san_outbreaks:'Épidémies',
vac_title:'Plan de vaccination',vac_add:'Enregistrer un vaccin',vac_vaccine:'Vaccin',vac_scheduled:'Prévu',vac_applied:'Appliqué',vac_batch:'Lot',vac_route:'Voie',vac_overdue:'En retard',vac_upcoming:'À venir',vac_applied_status:'Appliqué',vac_pending:'En attente',vac_generate:'Générer le calendrier',vac_mark_applied:'Marquer comme appliqué',
med_title:'Médicaments',med_add:'Enregistrer un médicament',med_name:'Médicament',med_reason:'Motif',med_start:'Début',med_end:'Fin',med_withdrawal:'Jours d\'attente',med_withdrawal_end:'Fin du délai d\'attente',med_dosage:'Posologie',med_in_withdrawal:'En délai d\'attente',
out_title:'Épidémies',out_add:'Enregistrer une épidémie',out_disease:'Maladie',out_start:'Début',out_end:'Fin',out_affected:'Affectés',out_deaths:'Mortalités',out_symptoms:'Symptômes',out_treatment:'Traitement',out_loss:'Perte économique',out_active:'Active',out_controlled:'Contrôlée',out_resolved:'Résolue',
feed_title:'Gestion de l\'alimentation',feed_purchases:'Achats',feed_consumption:'Consommation',feed_stock:'Stock actuel',feed_add_purchase:'Nouvel achat',feed_add_consumption:'Enregistrer la consommation',feed_type:'Type',feed_qty:'Quantité (kg)',feed_cost:'Coût',feed_supplier:'Fournisseur',feed_flock:'Lot',feed_low_alert:'Stock bas',
cli_title:'Clients',cli_add:'Nouveau client',cli_route:'Route/Zone',cli_price:'Prix convenus',cli_total:'Total clients',
fin_title:'Finances',fin_income:'Revenus',fin_expenses:'Dépenses',fin_receivables:'Créances',fin_summary:'Résumé',fin_add_income:'Nouveau revenu',fin_add_expense:'Nouvelle dépense',fin_add_receivable:'Nouvelle créance',fin_type:'Type',fin_qty:'Quantité',fin_unit_price:'Prix unitaire',fin_client:'Client',fin_category:'Catégorie',fin_description:'Description',fin_amount:'Montant',fin_due_date:'Date d\'échéance',fin_paid:'Payé',fin_total_income:'Revenu total',fin_total_expenses:'Dépenses totales',fin_net:'Résultat net',fin_cost_per_egg:'Coût/Œuf',fin_break_even:'Seuil de rentabilité',fin_month:'Mois',
fin_cat_feed:'Alimentation',fin_cat_vaccines:'Vaccins/Médicaments',fin_cat_transport:'Transport',fin_cat_labor:'Main-d\'œuvre',fin_cat_infrastructure:'Infrastructure',fin_cat_bird_purchase:'Achat de Volailles',fin_cat_other:'Autre',
fin_type_eggs:'Vente d\'œufs',fin_type_birds:'Vente de volailles',fin_type_manure:'Vente de fumier',fin_type_other:'Autre',
ana_title:'Analyses',ana_comparison:'Comparaison des lots',ana_seasonality:'Saisonnalité',ana_profitability:'Rentabilité',ana_benchmarks:'Références',ana_best_flock:'Meilleur lot',ana_worst_flock:'Lot le moins performant',ana_avg_production:'Production moyenne',ana_trend:'Tendance',ana_kpi_evolution:'Évolution des KPI',ana_no_snapshots:'Aucun instantané. Sauvegardez des instantanés depuis le tableau de bord.',
ops_title:'Opérations',ops_checklist:'Liste de contrôle quotidienne',ops_logbook:'Journal de bord',ops_personnel:'Personnel',ops_task:'Tâche',ops_done:'Terminé',ops_add_task:'Ajouter une tâche',ops_check_date:'Date',ops_log_entry:'Entrée',ops_log_category:'Catégorie',ops_log_add:'Nouvelle entrée',
ops_log_cat_general:'Général',ops_log_cat_health:'Santé',ops_log_cat_production:'Production',ops_log_cat_maintenance:'Maintenance',ops_log_cat_observation:'Observation',
ops_per_name:'Nom',ops_per_role:'Poste',ops_per_salary:'Salaire',ops_per_start:'Date d\'embauche',ops_per_active:'Actif',ops_per_add:'Ajouter du personnel',
env_title:'Conditions environnementales',env_add:'Nouvel enregistrement',env_temp:'Température (°C)',env_humidity:'Humidité (%)',env_light:'Heures de lumière',env_ventilation:'Ventilation',env_density:'Densité (oiseaux/m²)',env_optimal:'Plage optimale',env_temp_range:'18-24°C',env_humidity_range:'40-70%',env_light_range:'14-16 h',env_density_range:'4-5 oiseaux/m²',
cfg_title:'Paramètres',cfg_farm:'Détails de l\'exploitation',cfg_farm_name:'Nom de l\'exploitation',cfg_location:'Localisation',cfg_capacity:'Capacité (oiseaux)',cfg_currency:'Devise',cfg_alerts:'Seuils d\'alerte',cfg_min_feed:'Stock min d\'aliment (kg)',cfg_max_mortality:'Mortalité max (%)',cfg_alert_days:'Jours d\'alerte à l\'avance',cfg_data:'Données',cfg_export:'Exporter (JSON)',cfg_import:'Importer (JSON)',cfg_reset:'Tout supprimer',cfg_reset_confirm:'Supprimer TOUTES les données définitivement ?',cfg_saved:'Enregistré',cfg_exported:'Données exportées',cfg_imported:'Données importées',cfg_reset_done:'Données supprimées',cfg_checklist:'Liste de contrôle par défaut',cfg_checklist_items:'Tâches quotidiennes de contrôle',cfg_theme:'Thème de couleur',cfg_theme_blue:'Bleu marine',cfg_theme_green:'Vert',cfg_theme_purple:'Violet',cfg_theme_black:'Noir',
sidebar_subtitle:'Système avicole 360°',prod_shell_white:'Blanc',prod_shell_brown:'Brun',prod_shell_cream:'Crème',required:'Champ obligatoire',no_flocks_birthdate:'Aucun lot avec date de naissance',vac_select_flocks:'Sélectionnez les lots pour générer le calendrier :',feed_type_placeholder:'Pondeuse, Démarrage, etc.',avg_per_day:'Moy/jour',per_flock:'Lot',history:'Historique',env_latest_reading:'Dernière mesure',env_ok:'OK',env_out_of_range:'Hors plage',data_stats:'Statistiques des données',final_warning:'⚠️ DERNIER AVERTISSEMENT — TOUTES les données seront supprimées',total_salaries:'Total des salaires',eggs_unit:'œufs',csv_income:'Revenu',csv_expense:'Dépense',fcr_unit:'kg aliment/kg œuf',lc_feed_starter:'Démarrage',lc_feed_grower:'Croissance',lc_feed_developer:'Développement',lc_feed_prelay:'Pré-ponte',lc_feed_layer:'Pondeuse',lc_feed_lowlay:'Fin de ponte',lc_prod_label:'Prod',lc_prod_first:'Premiers œufs',lc_mile_1:'Vaccins Marek, Newcastle+BI, Gumboro',lc_mile_2:'Rappel Newcastle, développement du plumage',lc_mile_3:'Variole aviaire, EA, Coryza, Salmonelle',lc_mile_4:'Rappel Newcastle+BI, changement d\'aliment, 16h lumière',lc_mile_5:'Pic de production sem 26-30, surveiller le FCR',lc_mile_6:'Rappel Newcastle toutes les 8-12 sem, évaluer la rentabilité',lc_mile_7:'Évaluer la réforme vs mue forcée',lc_mile_8:'Vendre les poules réformées, nettoyer le bâtiment',vac_route_injection:'Injection',vac_route_ocular:'Oculaire/nébulisation',vac_route_water:'Eau de boisson',vac_route_wing:'Transfixion alaire',snapshots:'instantanés',error_prefix:'Erreur',chk_collect_eggs:'Collecter les œufs',chk_feed_birds:'Nourrir les volailles',chk_check_water:'Vérifier l\'eau',chk_check_health:'Contrôler la santé',chk_cleaning:'Nettoyage',chk_record_temp:'Relever la température',
weather_title:'Météo',weather_temp:'Température',weather_humidity:'Humidité',weather_wind:'Vent',weather_forecast:'Prévisions 3 jours',weather_no_key:'Configurez la clé API OpenWeatherMap dans les paramètres',weather_heat_alert:'Alerte stress thermique',weather_thi:'Indice THI',weather_feels:'Ressenti',weather_last_update:'Dernière mise à jour',weather_test:'Tester',
geo_set_location:'Localisation de l\'exploitation',geo_use_gps:'Utiliser mon GPS',geo_click_map:'Cliquez sur la carte pour définir la localisation',geo_lat:'Latitude',geo_lng:'Longitude',geo_saved:'Localisation enregistrée',
iot_title:'Capteurs IoT',iot_broker:'Broker MQTT (wss://)',iot_user:'Utilisateur MQTT',iot_pass:'Mot de passe MQTT',iot_topic:'Préfixe du topic',iot_connect:'Connecter',iot_disconnect:'Déconnecter',iot_live:'IoT en direct',iot_no_config:'Configurez MQTT dans les paramètres',iot_save_reading:'Enregistrer la mesure actuelle',iot_connected:'Connecté',iot_disconnected:'Déconnecté',iot_ammonia:'Ammoniac',iot_light:'Lumière',iot_lux:'lux',iot_ppm:'ppm',
pred_title:'Prédictions',pred_forecast:'Prévision de production',pred_anomaly:'Anomalies',pred_drop_risk:'Risque de chute',pred_breed_curve:'Courbe de race',pred_fcr_trend:'Tendance FCR',pred_next_7d:'7 prochains jours',pred_improving:'En amélioration',pred_worsening:'En dégradation',pred_stable:'Stable',pred_score:'Score',pred_low:'Faible',pred_medium:'Moyen',pred_high:'Élevé',pred_vs_expected:'Réel vs Attendu',
stress_title:'Événements de stress',stress_type:'Type',stress_severity:'Gravité',stress_heat:'Chaleur',stress_disease:'Maladie',stress_feed_change:'Changement d\'aliment',stress_power:'Coupure de courant',stress_predator:'Prédateur',stress_other:'Autre',stress_description:'Description',stress_add:'Nouvel événement',stress_impact:'Impact sur la production',stress_auto:'(Généré automatiquement)',
env_ammonia:'Ammoniac (ppm)',env_wind:'Vitesse du vent (km/h)',env_thi:'Indice THI',env_manual:'Saisie manuelle',env_history:'Historique',env_iot:'IoT en direct',
pwa_install:'Installer l\'application',pwa_offline:'Mode hors ligne disponible',
cfg_owm_key:'Clé API OpenWeatherMap',cfg_mqtt:'Paramètres MQTT',cfg_geo:'Géolocalisation',
flock_housing:'Type de logement',flock_housing_floor:'Au sol',flock_housing_cage:'En cage',flock_housing_free:'Plein air',flock_target_curve:'Courbe cible',flock_egg_color:'Couleur des œufs',
ana_predictions:'Prédictions',
per_day:'par jour',actual:'Réel',expected:'Attendu',not_available:'non disponible',
nav_biosecurity:'Biosécurité',bio_title:'Biosécurité & Lutte antiparasitaire',bio_visitors:'Visiteurs',bio_zones:'Zones',bio_pests:'Nuisibles',bio_protocols:'Protocoles',
bio_add_visitor:'Nouveau visiteur',bio_visitor_name:'Nom',bio_visitor_company:'Entreprise',bio_visitor_purpose:'Motif',bio_visitor_zone:'Zone',bio_visitor_plate:'Plaque du véhicule',bio_visitor_disinfected:'Désinfecté',bio_visitor_from_farm:'Exploitation d\'origine',bio_visitor_from_health:'Santé de l\'exploitation d\'origine',bio_cross_risk:'⚠️ Risque de contamination croisée',
bio_add_zone:'Nouvelle zone',bio_zone_name:'Nom de la zone',bio_zone_risk:'Niveau de risque',bio_zone_last_disinfection:'Dernière désinfection',bio_zone_frequency:'Fréquence (jours)',bio_risk_green:'Vert',bio_risk_yellow:'Jaune',bio_risk_red:'Rouge',
bio_add_pest:'Nouveau signalement',bio_pest_type:'Type',bio_pest_rodent:'Rongeur',bio_pest_fly:'Mouche',bio_pest_wild_bird:'Oiseau sauvage',bio_pest_other:'Autre',bio_pest_location:'Localisation',bio_pest_severity:'Gravité',bio_pest_action:'Action entreprise',bio_pest_resolved:'Résolu',
bio_add_protocol:'Nouveau protocole',bio_protocol_name:'Nom du protocole',bio_protocol_frequency:'Fréquence',bio_protocol_daily:'Quotidien',bio_protocol_weekly:'Hebdomadaire',bio_protocol_monthly:'Mensuel',bio_protocol_last:'Dernier achèvement',bio_protocol_items:'Éléments du protocole',bio_protocol_complete:'Terminé',bio_protocol_overdue:'En retard',
bio_pest_score:'Score nuisibles',bio_overdue_disinfection:'Désinfection en retard',bio_unresolved_pests:'Nuisibles non résolus',
alert_bio_disinfection:'Désinfection de zone en retard',alert_bio_pests:'Nuisibles non résolus',alert_bio_cross:'Risque de contamination croisée',
nav_traceability:'Traçabilité',trace_title:'Traçabilité des œufs',trace_add:'Nouveau lot',trace_batch_id:'ID du lot',trace_rack:'Casier',trace_box_count:'Boîtes',trace_eggs_per_box:'Œufs/Boîte',trace_qr:'Code QR',trace_delivery:'Date de livraison',trace_search:'Rechercher par ID/QR',trace_origin:'Origine',trace_house:'Bâtiment',
nav_planning:'Planification',plan_title:'Planification de production',plan_add:'Nouveau plan',plan_name:'Nom du plan',plan_target_date:'Date cible',plan_eggs_needed:'Œufs nécessaires',plan_allocations:'Répartition par lot',plan_expected:'Production attendue',plan_gap:'Écart',plan_on_track:'Dans les temps',plan_behind:'En retard',plan_ahead:'En avance',plan_estimate:'Estimation',plan_commitment:'Engagement',
prod_egg_type:'Type d\'œuf',prod_type_conventional:'Conventionnel',prod_type_free_range:'Plein air',prod_type_organic:'Biologique',prod_type_pasture:'Élevé en pâturage',prod_type_decorative:'Décoratif',
prod_market:'Canal de distribution',prod_market_wholesale:'Grossiste',prod_market_supermarket:'Supermarché',prod_market_restaurant:'Restaurant',prod_market_direct:'Vente directe',prod_market_export:'Export',prod_market_pasteurized:'Pasteurisé',
ana_by_segment:'Rentabilité par segment',ana_by_type:'Par type',ana_by_channel:'Par canal',
nav_campo_mode:'Mode terrain',nav_vet_mode:'Mode vétérinaire',campo_today:'AUJOURD\'HUI',campo_quick_entry:'Saisie rapide',vet_visit:'Visite effectuée',vet_vaccines:'Vaccins administrés',vet_pending:'En attente de révision',vet_select_farm:'Sélectionner exploitation/lot',
cfg_font_size:'Taille du texte',cfg_font_small:'Petit',cfg_font_normal:'Normal',cfg_font_large:'Grand',cfg_font_xlarge:'Très grand',cfg_dark_mode:'Mode sombre',cfg_theme_dark:'Sombre',
pred_outbreak_risk:'Risque d\'épidémie',pred_outbreak_high:'Risque élevé',pred_outbreak_medium:'Risque moyen',pred_outbreak_low:'Risque faible',pred_outbreak_factor:'Facteur',pred_outbreak_weight:'Poids',pred_outbreak_value:'Valeur',pred_probability:'Probabilité',pred_factors:'Facteurs',pred_recommendations:'Recommandations',pred_confidence:'Confiance',pred_forecast_7d:'7 jours',pred_forecast_14d:'14 jours',pred_ensemble:'Prévision d\'ensemble',pred_forecast_upper:'Bande supérieure',pred_forecast_lower:'Bande inférieure',
ana_segment_profit:'Rentabilité par segment',cfg_accessibility:'Accessibilité',
rec_title:'Recommandations',rec_dismiss:'Ignorer',rec_check_diet:'Vérifier l\'alimentation / formulation / exclure une maladie',rec_check_env:'Vérifier environnement / maladie / stress immédiatement',rec_below_curve:'En dessous de la courbe standard — vérifier stress, lumière, aliment',rec_buy_feed:'Planifier l\'achat d\'aliment',rec_record_env:'Enregistrer les conditions environnementales',rec_disinfect:'Exécuter le protocole de désinfection de la zone',rec_heat_plan:'Stress thermique prolongé — activer le plan de refroidissement',rec_lab_samples:'Envoyer des échantillons au laboratoire',rec_ventilation:'Augmenter la ventilation, vérifier l\'eau fraîche',
auth_welcome:'Compte créé. Bienvenue!',auth_error:'Identifiants incorrects',auth_first_run:'Première fois: entrez un nom d\'utilisateur et un mot de passe pour créer votre compte.',login_subtitle:'Entrez vos identifiants',logout:'Déconnexion',required:'Champ obligatoire',invalid_email:'Email invalide',invalid_phone:'Téléphone invalide',must_be_number:'Doit être un nombre',invalid_date:'Date invalide',invalid_format:'Format invalide',min_length:'Longueur min',max_length:'Longueur max',min_value:'Valeur min',max_value:'Valeur max',error_network:'Erreur réseau',error_unexpected:'Erreur inattendue',error_loading:'Erreur de chargement'
},
de:{
save:'Speichern',cancel:'Abbrechen',delete:'Löschen',edit:'Bearbeiten',add:'Hinzufügen',close:'Schließen',actions:'Aktionen',date:'Datum',notes:'Notizen',name:'Name',phone:'Telefon',email:'E-Mail',address:'Adresse',confirm_delete:'Diesen Eintrag löschen?',no_data:'Keine Daten erfasst',total:'Gesamt',all:'Alle',loading:'Laden',search:'Suche',from:'Von',to:'Bis',status:'Status',export_csv:'CSV exportieren',today:'Heute',active:'Aktiv',inactive:'Inaktiv',
nav_dashboard:'Übersicht',nav_production:'Produktion',nav_flocks:'Herden',nav_health:'Gesundheit',nav_feed:'Futter',nav_clients:'Kunden',nav_finances:'Finanzen',nav_analysis:'Analyse',nav_operations:'Betrieb',nav_environment:'Umwelt',nav_config:'Einstellungen',nav_admin:'SaaS-Admin',nav_inventory:'Inventar',grp_production:'Produktion',grp_health:'Gesundheit',grp_commercial:'Geschäft',grp_management:'Verwaltung',grp_system:'System',
dash_title:'Hauptübersicht',kpi_today:'Produktion heute',kpi_henday:'Legeleistung',kpi_fcr:'Futterverwertung (FCR)',kpi_mortality:'Mortalität',kpi_cost_egg:'Kosten/Ei',kpi_income_net:'Nettoeinkommen',kpi_alerts:'Warnungen',kpi_active_hens:'Aktive Hennen',kpi_active_flocks:'Aktive Herden',dash_alerts:'Warnungen',dash_trend:'30-Tage-Trend',dash_no_alerts:'Keine Warnungen',dash_snapshot:'KPI-Snapshot speichern',dash_kpi_history:'KPI-Verlauf',
alert_vaccine_overdue:'Impfung überfällig',alert_vaccine_soon:'Impfung bevorstehend',alert_low_feed:'Futterbestand niedrig',alert_high_mortality:'Hohe Mortalität',alert_active_outbreak:'Aktiver Ausbruch',alert_withdrawal:'Aktive Wartezeit',
flock_title:'Herdenverwaltung',flock_add:'Neue Herde',flock_name:'Name',flock_breed:'Rasse',flock_count:'Anfangsbestand',flock_birthdate:'Schlupfdatum',flock_purchase_date:'Kaufdatum',flock_supplier:'Lieferant',flock_cost:'Gesamtkosten',flock_status:'Status',flock_notes:'Notizen',flock_age:'Alter',flock_health:'Gesundheit',flock_weeks:'Wo.',flock_days:'Tage',flock_current:'Aktuell',flock_status_cria:'Aufzucht',flock_status_recria:'Junghennenaufzucht',flock_status_produccion:'Produktion',flock_status_descarte:'Aussortiert',flock_edit:'Herde bearbeiten',flock_lifecycle:'Lebenszyklus',flock_roadmap:'Fahrplan',
lc_pollito:'Küken',lc_cria:'Aufzucht',lc_recria:'Junghennenaufzucht',lc_prepostura:'Vorlegephase',lc_pico:'Legehöhepunkt',lc_media:'Mittlere Legephase',lc_baja:'Niedrige Legephase',lc_descarte:'Aussortiert',lc_feed:'Futter',lc_temp:'Temp.',lc_weeks:'Wochen',lc_milestone:'Meilensteine',lc_current_stage:'Aktuelle Phase',
prod_title:'Produktionsprotokoll',prod_add:'Neuer Eintrag',prod_flock:'Herde',prod_eggs:'Gesammelte Eier',prod_broken:'Bruch/Defekt',prod_size_s:'Klein (S)',prod_size_m:'Mittel (M)',prod_size_l:'Groß (L)',prod_size_xl:'Sehr groß (XL)',prod_size_jumbo:'Jumbo',prod_shell:'Schalenfarbe',prod_yolk:'Dotterqualität (1-10)',prod_deaths:'Verluste',prod_death_cause:'Todesursache',prod_date:'Datum',
san_title:'Gesundheitsmanagement',san_vaccines:'Impfungen',san_medications:'Medikamente',san_outbreaks:'Ausbrüche',
vac_title:'Impfplan',vac_add:'Impfung erfassen',vac_vaccine:'Impfstoff',vac_scheduled:'Geplant',vac_applied:'Verabreicht',vac_batch:'Charge',vac_route:'Verabreichungsweg',vac_overdue:'Überfällig',vac_upcoming:'Bevorstehend',vac_applied_status:'Verabreicht',vac_pending:'Ausstehend',vac_generate:'Kalender erstellen',vac_mark_applied:'Als verabreicht markieren',
med_title:'Medikamente',med_add:'Medikament erfassen',med_name:'Medikament',med_reason:'Grund',med_start:'Beginn',med_end:'Ende',med_withdrawal:'Wartezeit (Tage)',med_withdrawal_end:'Ende der Wartezeit',med_dosage:'Dosierung',med_in_withdrawal:'In Wartezeit',
out_title:'Ausbrüche',out_add:'Ausbruch erfassen',out_disease:'Krankheit',out_start:'Beginn',out_end:'Ende',out_affected:'Betroffen',out_deaths:'Verluste',out_symptoms:'Symptome',out_treatment:'Behandlung',out_loss:'Wirtschaftlicher Schaden',out_active:'Aktiv',out_controlled:'Kontrolliert',out_resolved:'Behoben',
feed_title:'Futterverwaltung',feed_purchases:'Einkäufe',feed_consumption:'Verbrauch',feed_stock:'Aktueller Bestand',feed_add_purchase:'Neuer Einkauf',feed_add_consumption:'Verbrauch erfassen',feed_type:'Art',feed_qty:'Menge (kg)',feed_cost:'Kosten',feed_supplier:'Lieferant',feed_flock:'Herde',feed_low_alert:'Niedriger Bestand',
cli_title:'Kunden',cli_add:'Neuer Kunde',cli_route:'Route/Gebiet',cli_price:'Vereinbarte Preise',cli_total:'Kunden gesamt',
fin_title:'Finanzen',fin_income:'Einnahmen',fin_expenses:'Ausgaben',fin_receivables:'Forderungen',fin_summary:'Zusammenfassung',fin_add_income:'Neue Einnahme',fin_add_expense:'Neue Ausgabe',fin_add_receivable:'Neue Forderung',fin_type:'Art',fin_qty:'Menge',fin_unit_price:'Stückpreis',fin_client:'Kunde',fin_category:'Kategorie',fin_description:'Beschreibung',fin_amount:'Betrag',fin_due_date:'Fälligkeitsdatum',fin_paid:'Bezahlt',fin_total_income:'Gesamteinnahmen',fin_total_expenses:'Gesamtausgaben',fin_net:'Nettoergebnis',fin_cost_per_egg:'Kosten/Ei',fin_break_even:'Gewinnschwelle',fin_month:'Monat',
fin_cat_feed:'Futter',fin_cat_vaccines:'Impfstoffe/Medikamente',fin_cat_transport:'Transport',fin_cat_labor:'Personal',fin_cat_infrastructure:'Infrastruktur',fin_cat_bird_purchase:'Geflügelkauf',fin_cat_other:'Sonstiges',
fin_type_eggs:'Eierverkauf',fin_type_birds:'Geflügelverkauf',fin_type_manure:'Mistverkauf',fin_type_other:'Sonstiges',
ana_title:'Analyse',ana_comparison:'Herdenvergleich',ana_seasonality:'Saisonalität',ana_profitability:'Rentabilität',ana_benchmarks:'Benchmarks',ana_best_flock:'Beste Herde',ana_worst_flock:'Schwächste Herde',ana_avg_production:'Ø Produktion',ana_trend:'Trend',ana_kpi_evolution:'KPI-Entwicklung',ana_no_snapshots:'Keine Snapshots. Speichern Sie Snapshots über die Übersicht.',
ops_title:'Betrieb',ops_checklist:'Tägliche Checkliste',ops_logbook:'Logbuch',ops_personnel:'Personal',ops_task:'Aufgabe',ops_done:'Erledigt',ops_add_task:'Aufgabe hinzufügen',ops_check_date:'Datum',ops_log_entry:'Eintrag',ops_log_category:'Kategorie',ops_log_add:'Neuer Eintrag',
ops_log_cat_general:'Allgemein',ops_log_cat_health:'Gesundheit',ops_log_cat_production:'Produktion',ops_log_cat_maintenance:'Wartung',ops_log_cat_observation:'Beobachtung',
ops_per_name:'Name',ops_per_role:'Rolle',ops_per_salary:'Gehalt',ops_per_start:'Eintrittsdatum',ops_per_active:'Aktiv',ops_per_add:'Personal hinzufügen',
env_title:'Umweltbedingungen',env_add:'Neuer Eintrag',env_temp:'Temperatur (°C)',env_humidity:'Luftfeuchtigkeit (%)',env_light:'Lichtstunden',env_ventilation:'Belüftung',env_density:'Besatzdichte (Tiere/m²)',env_optimal:'Optimalbereich',env_temp_range:'18–24 °C',env_humidity_range:'40–70 %',env_light_range:'14–16 Std.',env_density_range:'4–5 Tiere/m²',
cfg_title:'Einstellungen',cfg_farm:'Betriebsdaten',cfg_farm_name:'Betriebsname',cfg_location:'Standort',cfg_capacity:'Kapazität (Tiere)',cfg_currency:'Währung',cfg_alerts:'Warnschwellen',cfg_min_feed:'Min. Futterbestand (kg)',cfg_max_mortality:'Max. Mortalität (%)',cfg_alert_days:'Warnungstage im Voraus',cfg_data:'Daten',cfg_export:'Exportieren (JSON)',cfg_import:'Importieren (JSON)',cfg_reset:'Alle Daten löschen',cfg_reset_confirm:'ALLE Daten unwiderruflich löschen?',cfg_saved:'Gespeichert',cfg_exported:'Daten exportiert',cfg_imported:'Daten importiert',cfg_reset_done:'Daten gelöscht',cfg_checklist:'Standard-Checkliste',cfg_checklist_items:'Tägliche Checklistenaufgaben',cfg_theme:'Farbschema',cfg_theme_blue:'Marineblau',cfg_theme_green:'Grün',cfg_theme_purple:'Lila',cfg_theme_black:'Schwarz',
sidebar_subtitle:'Geflügelsystem 360°',prod_shell_white:'Weiß',prod_shell_brown:'Braun',prod_shell_cream:'Creme',required:'Pflichtfeld',no_flocks_birthdate:'Keine Herden mit Schlupfdatum',vac_select_flocks:'Herden für Kalender auswählen:',feed_type_placeholder:'Legehenne, Starter, usw.',avg_per_day:'Ø/Tag',per_flock:'Herde',history:'Verlauf',env_latest_reading:'Letzter Messwert',env_ok:'OK',env_out_of_range:'Außerhalb des Bereichs',data_stats:'Datenstatistik',final_warning:'⚠️ LETZTE WARNUNG — ALLE Daten werden gelöscht',total_salaries:'Gesamtgehälter',eggs_unit:'Eier',csv_income:'Einnahmen',csv_expense:'Ausgabe',fcr_unit:'kg Futter/kg Ei',lc_feed_starter:'Starter',lc_feed_grower:'Aufzuchtfutter',lc_feed_developer:'Entwicklungsfutter',lc_feed_prelay:'Vorlegefutter',lc_feed_layer:'Legefutter',lc_feed_lowlay:'Spätlegefutter',lc_prod_label:'Prod.',lc_prod_first:'Erste Eier',lc_mile_1:'Marek-, Newcastle+IB-, Gumboro-Impfungen',lc_mile_2:'Newcastle-Auffrischung, Federentwicklung',lc_mile_3:'Geflügelpocken, AE, Coryza, Salmonellen',lc_mile_4:'Newcastle+IB-Auffrischung, Futterwechsel, 16 Std. Licht',lc_mile_5:'Legehöhepunkt Wo. 26–30, FCR überwachen',lc_mile_6:'Newcastle-Auffrischung alle 8–12 Wo., Rentabilität prüfen',lc_mile_7:'Aussortierung vs. Zwangsmauser bewerten',lc_mile_8:'Aussortierte Tiere verkaufen, Stall reinigen',vac_route_injection:'Injektion',vac_route_ocular:'Okular/Spray',vac_route_water:'Trinkwasser',vac_route_wing:'Flügelstichmethode',snapshots:'Snapshots',error_prefix:'Fehler',chk_collect_eggs:'Eier sammeln',chk_feed_birds:'Tiere füttern',chk_check_water:'Wasser kontrollieren',chk_check_health:'Gesundheit kontrollieren',chk_cleaning:'Reinigung',chk_record_temp:'Temperatur erfassen',
weather_title:'Wetter',weather_temp:'Temperatur',weather_humidity:'Luftfeuchtigkeit',weather_wind:'Wind',weather_forecast:'3-Tage-Vorhersage',weather_no_key:'OpenWeatherMap-API-Schlüssel in den Einstellungen konfigurieren',weather_heat_alert:'Hitzestress-Warnung',weather_thi:'THI-Index',weather_feels:'Gefühlt',weather_last_update:'Zuletzt aktualisiert',weather_test:'Test',
geo_set_location:'Betriebsstandort',geo_use_gps:'Mein GPS verwenden',geo_click_map:'Karte klicken, um Standort zu setzen',geo_lat:'Breitengrad',geo_lng:'Längengrad',geo_saved:'Standort gespeichert',
iot_title:'IoT-Sensoren',iot_broker:'MQTT-Broker (wss://)',iot_user:'MQTT-Benutzer',iot_pass:'MQTT-Passwort',iot_topic:'Topic-Präfix',iot_connect:'Verbinden',iot_disconnect:'Trennen',iot_live:'IoT Live',iot_no_config:'MQTT in den Einstellungen konfigurieren',iot_save_reading:'Aktuellen Messwert speichern',iot_connected:'Verbunden',iot_disconnected:'Getrennt',iot_ammonia:'Ammoniak',iot_light:'Licht',iot_lux:'lux',iot_ppm:'ppm',
pred_title:'Prognosen',pred_forecast:'Produktionsprognose',pred_anomaly:'Anomalien',pred_drop_risk:'Rückgangsrisiko',pred_breed_curve:'Rassenkurve',pred_fcr_trend:'FCR-Trend',pred_next_7d:'Nächste 7 Tage',pred_improving:'Verbessernd',pred_worsening:'Verschlechternd',pred_stable:'Stabil',pred_score:'Bewertung',pred_low:'Niedrig',pred_medium:'Mittel',pred_high:'Hoch',pred_vs_expected:'Ist vs. Soll',
stress_title:'Stressereignisse',stress_type:'Art',stress_severity:'Schweregrad',stress_heat:'Hitze',stress_disease:'Krankheit',stress_feed_change:'Futterwechsel',stress_power:'Stromausfall',stress_predator:'Raubtier',stress_other:'Sonstiges',stress_description:'Beschreibung',stress_add:'Neues Ereignis',stress_impact:'Produktionsauswirkung',stress_auto:'(Automatisch generiert)',
env_ammonia:'Ammoniak (ppm)',env_wind:'Windgeschwindigkeit (km/h)',env_thi:'THI-Index',env_manual:'Manuelle Eingabe',env_history:'Verlauf',env_iot:'IoT Live',
pwa_install:'App installieren',pwa_offline:'Offline-Modus verfügbar',
cfg_owm_key:'OpenWeatherMap-API-Schlüssel',cfg_mqtt:'MQTT-Einstellungen',cfg_geo:'Geolokalisierung',
flock_housing:'Haltungsform',flock_housing_floor:'Bodenhaltung',flock_housing_cage:'Käfighaltung',flock_housing_free:'Freilandhaltung',flock_target_curve:'Sollkurve',flock_egg_color:'Eierfarbe',
ana_predictions:'Prognosen',
per_day:'pro Tag',actual:'Ist',expected:'Soll',not_available:'nicht verfügbar',
nav_biosecurity:'Biosicherheit',bio_title:'Biosicherheit & Schädlingsbekämpfung',bio_visitors:'Besucher',bio_zones:'Zonen',bio_pests:'Schädlinge',bio_protocols:'Protokolle',
bio_add_visitor:'Neuer Besucher',bio_visitor_name:'Name',bio_visitor_company:'Firma',bio_visitor_purpose:'Zweck',bio_visitor_zone:'Zone',bio_visitor_plate:'Kennzeichen',bio_visitor_disinfected:'Desinfiziert',bio_visitor_from_farm:'Herkunftsbetrieb',bio_visitor_from_health:'Gesundheitsstatus Herkunftsbetrieb',bio_cross_risk:'⚠️ Kreuzkontaminationsrisiko',
bio_add_zone:'Neue Zone',bio_zone_name:'Zonenname',bio_zone_risk:'Risikostufe',bio_zone_last_disinfection:'Letzte Desinfektion',bio_zone_frequency:'Häufigkeit (Tage)',bio_risk_green:'Grün',bio_risk_yellow:'Gelb',bio_risk_red:'Rot',
bio_add_pest:'Neue Sichtung',bio_pest_type:'Art',bio_pest_rodent:'Nager',bio_pest_fly:'Fliege',bio_pest_wild_bird:'Wildvogel',bio_pest_other:'Sonstiges',bio_pest_location:'Ort',bio_pest_severity:'Schweregrad',bio_pest_action:'Ergriffene Maßnahme',bio_pest_resolved:'Behoben',
bio_add_protocol:'Neues Protokoll',bio_protocol_name:'Protokollname',bio_protocol_frequency:'Häufigkeit',bio_protocol_daily:'Täglich',bio_protocol_weekly:'Wöchentlich',bio_protocol_monthly:'Monatlich',bio_protocol_last:'Zuletzt durchgeführt',bio_protocol_items:'Protokollpunkte',bio_protocol_complete:'Abgeschlossen',bio_protocol_overdue:'Überfällig',
bio_pest_score:'Schädlingsbewertung',bio_overdue_disinfection:'Desinfektion überfällig',bio_unresolved_pests:'Ungelöste Schädlinge',
alert_bio_disinfection:'Zonendesinfektion überfällig',alert_bio_pests:'Ungelöste Schädlinge',alert_bio_cross:'Kreuzkontaminationsrisiko',
nav_traceability:'Rückverfolgbarkeit',trace_title:'Eier-Rückverfolgbarkeit',trace_add:'Neue Charge',trace_batch_id:'Chargen-ID',trace_rack:'Gestell',trace_box_count:'Kartons',trace_eggs_per_box:'Eier/Karton',trace_qr:'QR-Code',trace_delivery:'Lieferdatum',trace_search:'Suche nach ID/QR',trace_origin:'Herkunft',trace_house:'Stall',
nav_planning:'Planung',plan_title:'Produktionsplanung',plan_add:'Neuer Plan',plan_name:'Planname',plan_target_date:'Zieldatum',plan_eggs_needed:'Benötigte Eier',plan_allocations:'Herdenzuordnungen',plan_expected:'Erwartete Produktion',plan_gap:'Differenz',plan_on_track:'Im Plan',plan_behind:'Im Rückstand',plan_ahead:'Voraus',plan_estimate:'Schätzung',plan_commitment:'Zusage',
prod_egg_type:'Eiertyp',prod_type_conventional:'Konventionell',prod_type_free_range:'Freiland',prod_type_organic:'Bio',prod_type_pasture:'Weidehaltung',prod_type_decorative:'Dekorativ',
prod_market:'Vertriebskanal',prod_market_wholesale:'Großhandel',prod_market_supermarket:'Supermarkt',prod_market_restaurant:'Restaurant',prod_market_direct:'Direktverkauf',prod_market_export:'Export',prod_market_pasteurized:'Pasteurisiert',
ana_by_segment:'Rentabilität nach Segment',ana_by_type:'Nach Typ',ana_by_channel:'Nach Kanal',
nav_campo_mode:'Feldmodus',nav_vet_mode:'Tierarztmodus',campo_today:'HEUTE',campo_quick_entry:'Schnelleingabe',vet_visit:'Besuch abgeschlossen',vet_vaccines:'Impfungen verabreicht',vet_pending:'Überprüfung ausstehend',vet_select_farm:'Betrieb/Herde auswählen',
cfg_font_size:'Schriftgröße',cfg_font_small:'Klein',cfg_font_normal:'Normal',cfg_font_large:'Groß',cfg_font_xlarge:'Sehr groß',cfg_dark_mode:'Dunkelmodus',cfg_theme_dark:'Dunkel',
pred_outbreak_risk:'Ausbruchsrisiko',pred_outbreak_high:'Hohes Risiko',pred_outbreak_medium:'Mittleres Risiko',pred_outbreak_low:'Niedriges Risiko',pred_outbreak_factor:'Faktor',pred_outbreak_weight:'Gewichtung',pred_outbreak_value:'Wert',pred_probability:'Wahrscheinlichkeit',pred_factors:'Faktoren',pred_recommendations:'Empfehlungen',pred_confidence:'Konfidenz',pred_forecast_7d:'7 Tage',pred_forecast_14d:'14 Tage',pred_ensemble:'Ensemble-Prognose',pred_forecast_upper:'Oberes Band',pred_forecast_lower:'Unteres Band',
ana_segment_profit:'Rentabilität nach Segment',cfg_accessibility:'Barrierefreiheit',
rec_title:'Empfehlungen',rec_dismiss:'Verwerfen',rec_check_diet:'Futter / Futterrezeptur prüfen / Krankheit ausschließen',rec_check_env:'Umwelt / Krankheit / Stress sofort prüfen',rec_below_curve:'Unter Standardproduktion — Stress, Licht, Futter prüfen',rec_buy_feed:'Futterkauf planen',rec_record_env:'Umweltbedingungen erfassen',rec_disinfect:'Desinfektionsprotokoll Zone ausführen',rec_heat_plan:'Anhaltender Hitzestress — Kühlungsplan aktivieren',rec_lab_samples:'Proben ins Labor bringen',rec_ventilation:'Belüftung erhöhen, Frischwasser kontrollieren',
auth_welcome:'Konto erstellt. Willkommen!',auth_error:'Ungültige Anmeldedaten',auth_first_run:'Erstmalig: Benutzernamen und Passwort eingeben, um Ihr Konto zu erstellen.',login_subtitle:'Geben Sie Ihre Anmeldedaten ein',logout:'Abmelden',required:'Pflichtfeld',invalid_email:'Ungültige E-Mail',invalid_phone:'Ungültige Telefonnummer',must_be_number:'Muss eine Zahl sein',invalid_date:'Ungültiges Datum',invalid_format:'Ungültiges Format',min_length:'Mindestlänge',max_length:'Maximale Länge',min_value:'Mindestwert',max_value:'Maximalwert',error_network:'Netzwerkfehler',error_unexpected:'Unerwarteter Fehler',error_loading:'Ladefehler'
},
it:{
save:'Salva',cancel:'Annulla',delete:'Elimina',edit:'Modifica',add:'Aggiungi',close:'Chiudi',actions:'Azioni',date:'Data',notes:'Note',name:'Nome',phone:'Telefono',email:'Email',address:'Indirizzo',confirm_delete:'Eliminare questo record?',no_data:'Nessun dato registrato',total:'Totale',all:'Tutti',loading:'Caricamento',search:'Cerca',from:'Da',to:'A',status:'Stato',export_csv:'Esporta CSV',today:'Oggi',active:'Attivo',inactive:'Inattivo',
nav_dashboard:'Pannello',nav_production:'Produzione',nav_flocks:'Gruppi',nav_health:'Sanità',nav_feed:'Mangime',nav_clients:'Clienti',nav_finances:'Finanze',nav_analysis:'Analisi',nav_operations:'Operazioni',nav_environment:'Ambiente',nav_config:'Impostazioni',nav_admin:'Admin SaaS',nav_inventory:'Inventario',grp_production:'Produzione',grp_health:'Salute',grp_commercial:'Commerciale',grp_management:'Gestione',grp_system:'Sistema',
dash_title:'Pannello Principale',kpi_today:'Produzione Oggi',kpi_henday:'Tasso Gallina-Giorno',kpi_fcr:'Indice di Conversione (FCR)',kpi_mortality:'Mortalità',kpi_cost_egg:'Costo/Uovo',kpi_income_net:'Reddito Netto',kpi_alerts:'Avvisi',kpi_active_hens:'Galline Attive',kpi_active_flocks:'Gruppi Attivi',dash_alerts:'Avvisi',dash_trend:'Tendenza 30 Giorni',dash_no_alerts:'Nessun avviso',dash_snapshot:'Salva Istantanea KPI',dash_kpi_history:'Storico KPI',
alert_vaccine_overdue:'Vaccino scaduto',alert_vaccine_soon:'Vaccino in arrivo',alert_low_feed:'Scorta mangime bassa',alert_high_mortality:'Mortalità elevata',alert_active_outbreak:'Focolaio attivo',alert_withdrawal:'Sospensione attiva',
flock_title:'Gestione Gruppi',flock_add:'Nuovo Gruppo',flock_name:'Nome',flock_breed:'Razza',flock_count:'Quantità Iniziale',flock_birthdate:'Data di Nascita',flock_purchase_date:'Data di Acquisto',flock_supplier:'Fornitore',flock_cost:'Costo Totale',flock_status:'Stato',flock_notes:'Note',flock_age:'Età',flock_health:'Sanità',flock_weeks:'sett.',flock_days:'giorni',flock_current:'Attuale',flock_status_cria:'Allevamento',flock_status_recria:'Accrescimento',flock_status_produccion:'Produzione',flock_status_descarte:'Scarti',flock_edit:'Modifica Gruppo',flock_lifecycle:'Ciclo di Vita',flock_roadmap:'Roadmap',
lc_pollito:'Pulcino',lc_cria:'Allevamento',lc_recria:'Accrescimento',lc_prepostura:'Pre-deposizione',lc_pico:'Picco Deposizione',lc_media:'Media Deposizione',lc_baja:'Bassa Deposizione',lc_descarte:'Scarti',lc_feed:'Mangime',lc_temp:'Temp.',lc_weeks:'Settimane',lc_milestone:'Tappe',lc_current_stage:'Fase Attuale',
prod_title:'Registro Produzione',prod_add:'Nuovo Record',prod_flock:'Gruppo',prod_eggs:'Uova Raccolte',prod_broken:'Rotte/Difettose',prod_size_s:'Piccole (S)',prod_size_m:'Medie (M)',prod_size_l:'Grandi (L)',prod_size_xl:'Extra Grandi (XL)',prod_size_jumbo:'Jumbo',prod_shell:'Colore Guscio',prod_yolk:'Qualità Tuorlo (1-10)',prod_deaths:'Decessi',prod_death_cause:'Causa di Morte',prod_date:'Data',
san_title:'Gestione Sanitaria',san_vaccines:'Vaccini',san_medications:'Farmaci',san_outbreaks:'Focolai',
vac_title:'Piano Vaccinale',vac_add:'Registra Vaccino',vac_vaccine:'Vaccino',vac_scheduled:'Programmato',vac_applied:'Applicato',vac_batch:'Lotto',vac_route:'Via di Somministrazione',vac_overdue:'Scaduto',vac_upcoming:'In Arrivo',vac_applied_status:'Applicato',vac_pending:'In Attesa',vac_generate:'Genera Calendario',vac_mark_applied:'Segna come Applicato',
med_title:'Farmaci',med_add:'Registra Farmaco',med_name:'Farmaco',med_reason:'Motivo',med_start:'Inizio',med_end:'Fine',med_withdrawal:'Giorni di Sospensione',med_withdrawal_end:'Fine Sospensione',med_dosage:'Dosaggio',med_in_withdrawal:'In Sospensione',
out_title:'Focolai',out_add:'Registra Focolaio',out_disease:'Malattia',out_start:'Inizio',out_end:'Fine',out_affected:'Colpiti',out_deaths:'Decessi',out_symptoms:'Sintomi',out_treatment:'Trattamento',out_loss:'Perdita Economica',out_active:'Attivo',out_controlled:'Controllato',out_resolved:'Risolto',
feed_title:'Gestione Mangimi',feed_purchases:'Acquisti',feed_consumption:'Consumo',feed_stock:'Scorta Attuale',feed_add_purchase:'Nuovo Acquisto',feed_add_consumption:'Registra Consumo',feed_type:'Tipo',feed_qty:'Quantità (kg)',feed_cost:'Costo',feed_supplier:'Fornitore',feed_flock:'Gruppo',feed_low_alert:'Scorta bassa',
cli_title:'Clienti',cli_add:'Nuovo Cliente',cli_route:'Percorso/Zona',cli_price:'Prezzi Concordati',cli_total:'Clienti Totali',
fin_title:'Finanze',fin_income:'Entrate',fin_expenses:'Uscite',fin_receivables:'Crediti',fin_summary:'Riepilogo',fin_add_income:'Nuova Entrata',fin_add_expense:'Nuova Uscita',fin_add_receivable:'Nuovo Credito',fin_type:'Tipo',fin_qty:'Quantità',fin_unit_price:'Prezzo Unitario',fin_client:'Cliente',fin_category:'Categoria',fin_description:'Descrizione',fin_amount:'Importo',fin_due_date:'Data Scadenza',fin_paid:'Pagato',fin_total_income:'Entrate Totali',fin_total_expenses:'Uscite Totali',fin_net:'Risultato Netto',fin_cost_per_egg:'Costo/Uovo',fin_break_even:'Punto di Pareggio',fin_month:'Mese',
fin_cat_feed:'Mangime',fin_cat_vaccines:'Vaccini/Farmaci',fin_cat_transport:'Trasporto',fin_cat_labor:'Manodopera',fin_cat_infrastructure:'Infrastruttura',fin_cat_bird_purchase:'Acquisto Pollame',fin_cat_other:'Altro',
fin_type_eggs:'Vendita Uova',fin_type_birds:'Vendita Avicoli',fin_type_manure:'Vendita Pollina',fin_type_other:'Altro',
ana_title:'Analisi',ana_comparison:'Confronto Gruppi',ana_seasonality:'Stagionalità',ana_profitability:'Redditività',ana_benchmarks:'Benchmark',ana_best_flock:'Miglior Gruppo',ana_worst_flock:'Peggior Gruppo',ana_avg_production:'Produzione Media',ana_trend:'Tendenza',ana_kpi_evolution:'Evoluzione KPI',ana_no_snapshots:'Nessuna istantanea. Salvare istantanee dal Pannello.',
ops_title:'Operazioni',ops_checklist:'Checklist Giornaliera',ops_logbook:'Registro',ops_personnel:'Personale',ops_task:'Attività',ops_done:'Completata',ops_add_task:'Aggiungi Attività',ops_check_date:'Data',ops_log_entry:'Registrazione',ops_log_category:'Categoria',ops_log_add:'Nuova Registrazione',
ops_log_cat_general:'Generale',ops_log_cat_health:'Sanità',ops_log_cat_production:'Produzione',ops_log_cat_maintenance:'Manutenzione',ops_log_cat_observation:'Osservazione',
ops_per_name:'Nome',ops_per_role:'Ruolo',ops_per_salary:'Stipendio',ops_per_start:'Data Inizio',ops_per_active:'Attivo',ops_per_add:'Aggiungi Personale',
env_title:'Condizioni Ambientali',env_add:'Nuovo Record',env_temp:'Temperatura (°C)',env_humidity:'Umidità (%)',env_light:'Ore di Luce',env_ventilation:'Ventilazione',env_density:'Densità (capi/m²)',env_optimal:'Intervallo Ottimale',env_temp_range:'18-24°C',env_humidity_range:'40-70%',env_light_range:'14-16 ore',env_density_range:'4-5 capi/m²',
cfg_title:'Impostazioni',cfg_farm:'Dettagli Allevamento',cfg_farm_name:'Nome Allevamento',cfg_location:'Posizione',cfg_capacity:'Capacità (capi)',cfg_currency:'Valuta',cfg_alerts:'Soglie di Avviso',cfg_min_feed:'Scorta Minima Mangime (kg)',cfg_max_mortality:'Mortalità Massima (%)',cfg_alert_days:'Giorni di Preavviso',cfg_data:'Dati',cfg_export:'Esporta (JSON)',cfg_import:'Importa (JSON)',cfg_reset:'Elimina Tutto',cfg_reset_confirm:'Eliminare TUTTI i dati definitivamente?',cfg_saved:'Salvato',cfg_exported:'Dati esportati',cfg_imported:'Dati importati',cfg_reset_done:'Dati eliminati',cfg_checklist:'Checklist Predefinita',cfg_checklist_items:'Attività checklist giornaliera',cfg_theme:'Tema Colore',cfg_theme_blue:'Blu Navy',cfg_theme_green:'Verde',cfg_theme_purple:'Viola',cfg_theme_black:'Nero',
sidebar_subtitle:'Sistema Avicolo 360°',prod_shell_white:'Bianco',prod_shell_brown:'Marrone',prod_shell_cream:'Crema',required:'Campo obbligatorio',no_flocks_birthdate:'Nessun gruppo con data di nascita',vac_select_flocks:'Seleziona i gruppi per generare il calendario:',feed_type_placeholder:'Ovaiole, Starter, ecc.',avg_per_day:'Media/giorno',per_flock:'Gruppo',history:'Storico',env_latest_reading:'Ultima Lettura',env_ok:'OK',env_out_of_range:'Fuori intervallo',data_stats:'Statistiche Dati',final_warning:'⚠️ ULTIMO AVVERTIMENTO — TUTTI i dati verranno eliminati',total_salaries:'Stipendi Totali',eggs_unit:'uova',csv_income:'Entrata',csv_expense:'Uscita',fcr_unit:'kg mangime/kg uovo',lc_feed_starter:'Starter',lc_feed_grower:'Accrescimento',lc_feed_developer:'Sviluppo',lc_feed_prelay:'Pre-deposizione',lc_feed_layer:'Ovaiole',lc_feed_lowlay:'Bassa deposizione',lc_prod_label:'Prod.',lc_prod_first:'Prime uova',lc_mile_1:'Vaccini Marek, Newcastle+BI, Gumboro',lc_mile_2:'Richiamo Newcastle, sviluppo piumaggio',lc_mile_3:'Vaiolo Aviare, EAV, Corizza, Salmonella',lc_mile_4:'Richiamo Newcastle+BI, cambio dieta, 16h luce',lc_mile_5:'Picco produzione sett. 26-30, monitorare FCR',lc_mile_6:'Richiamo Newcastle ogni 8-12 sett., valutare redditività',lc_mile_7:'Valutare scarto vs muta forzata',lc_mile_8:'Vendita avicoli a scarto, pulizia capannone',vac_route_injection:'Iniezione',vac_route_ocular:'Oculare/spray',vac_route_water:'Acqua di bevanda',vac_route_wing:'Puntura alare',snapshots:'istantanee',error_prefix:'Errore',chk_collect_eggs:'Raccogliere uova',chk_feed_birds:'Alimentare gli avicoli',chk_check_water:'Controllare acqua',chk_check_health:'Controllare stato sanitario',chk_cleaning:'Pulizia',chk_record_temp:'Registrare temperatura',
weather_title:'Meteo',weather_temp:'Temperatura',weather_humidity:'Umidità',weather_wind:'Vento',weather_forecast:'Previsioni 3 Giorni',weather_no_key:'Configurare la chiave API OpenWeatherMap nelle Impostazioni',weather_heat_alert:'Allerta Stress da Calore',weather_thi:'Indice THI',weather_feels:'Percepita',weather_last_update:'Ultimo aggiornamento',weather_test:'Test',
geo_set_location:'Posizione Allevamento',geo_use_gps:'Usa il mio GPS',geo_click_map:'Clicca sulla mappa per impostare la posizione',geo_lat:'Latitudine',geo_lng:'Longitudine',geo_saved:'Posizione salvata',
iot_title:'Sensori IoT',iot_broker:'Broker MQTT (wss://)',iot_user:'Utente MQTT',iot_pass:'Password MQTT',iot_topic:'Prefisso Topic',iot_connect:'Connetti',iot_disconnect:'Disconnetti',iot_live:'IoT in Tempo Reale',iot_no_config:'Configurare MQTT nelle Impostazioni',iot_save_reading:'Salva lettura corrente',iot_connected:'Connesso',iot_disconnected:'Disconnesso',iot_ammonia:'Ammoniaca',iot_light:'Luce',iot_lux:'lux',iot_ppm:'ppm',
pred_title:'Previsioni',pred_forecast:'Previsione Produzione',pred_anomaly:'Anomalie',pred_drop_risk:'Rischio di Calo',pred_breed_curve:'Curva di Razza',pred_fcr_trend:'Tendenza FCR',pred_next_7d:'Prossimi 7 giorni',pred_improving:'In miglioramento',pred_worsening:'In peggioramento',pred_stable:'Stabile',pred_score:'Punteggio',pred_low:'Basso',pred_medium:'Medio',pred_high:'Alto',pred_vs_expected:'Effettivo vs Previsto',
stress_title:'Eventi di Stress',stress_type:'Tipo',stress_severity:'Gravità',stress_heat:'Calore',stress_disease:'Malattia',stress_feed_change:'Cambio Mangime',stress_power:'Interruzione Elettrica',stress_predator:'Predatore',stress_other:'Altro',stress_description:'Descrizione',stress_add:'Nuovo Evento',stress_impact:'Impatto sulla Produzione',stress_auto:'(Auto-generato)',
env_ammonia:'Ammoniaca (ppm)',env_wind:'Velocità del Vento (km/h)',env_thi:'Indice THI',env_manual:'Inserimento Manuale',env_history:'Storico',env_iot:'IoT in Tempo Reale',
pwa_install:'Installa App',pwa_offline:'Modalità Offline Disponibile',
cfg_owm_key:'Chiave API OpenWeatherMap',cfg_mqtt:'Impostazioni MQTT',cfg_geo:'Geolocalizzazione',
flock_housing:'Tipo di Alloggiamento',flock_housing_floor:'A Terra',flock_housing_cage:'In Gabbia',flock_housing_free:'All\'aperto',flock_target_curve:'Curva Obiettivo',flock_egg_color:'Colore Uovo',
ana_predictions:'Previsioni',
per_day:'al giorno',actual:'Effettivo',expected:'Previsto',not_available:'non disponibile',
nav_biosecurity:'Biosicurezza',bio_title:'Biosicurezza e Controllo Infestanti',bio_visitors:'Visitatori',bio_zones:'Zone',bio_pests:'Infestanti',bio_protocols:'Protocolli',
bio_add_visitor:'Nuovo Visitatore',bio_visitor_name:'Nome',bio_visitor_company:'Azienda',bio_visitor_purpose:'Scopo',bio_visitor_zone:'Zona',bio_visitor_plate:'Targa Veicolo',bio_visitor_disinfected:'Disinfettato',bio_visitor_from_farm:'Allevamento di Provenienza',bio_visitor_from_health:'Stato Sanitario Provenienza',bio_cross_risk:'⚠️ Rischio di contaminazione incrociata',
bio_add_zone:'Nuova Zona',bio_zone_name:'Nome Zona',bio_zone_risk:'Livello di Rischio',bio_zone_last_disinfection:'Ultima Disinfezione',bio_zone_frequency:'Frequenza (giorni)',bio_risk_green:'Verde',bio_risk_yellow:'Giallo',bio_risk_red:'Rosso',
bio_add_pest:'Nuovo Avvistamento',bio_pest_type:'Tipo',bio_pest_rodent:'Roditore',bio_pest_fly:'Mosca',bio_pest_wild_bird:'Uccello Selvatico',bio_pest_other:'Altro',bio_pest_location:'Posizione',bio_pest_severity:'Gravità',bio_pest_action:'Azione Intrapresa',bio_pest_resolved:'Risolto',
bio_add_protocol:'Nuovo Protocollo',bio_protocol_name:'Nome Protocollo',bio_protocol_frequency:'Frequenza',bio_protocol_daily:'Giornaliera',bio_protocol_weekly:'Settimanale',bio_protocol_monthly:'Mensile',bio_protocol_last:'Ultimo Completamento',bio_protocol_items:'Voci del Protocollo',bio_protocol_complete:'Completato',bio_protocol_overdue:'Scaduto',
bio_pest_score:'Punteggio Infestanti',bio_overdue_disinfection:'Disinfezione scaduta',bio_unresolved_pests:'Infestanti non risolti',
alert_bio_disinfection:'Disinfezione zona scaduta',alert_bio_pests:'Infestanti non risolti',alert_bio_cross:'Rischio di contaminazione incrociata',
nav_traceability:'Tracciabilità',trace_title:'Tracciabilità Uova',trace_add:'Nuovo Lotto',trace_batch_id:'ID Lotto',trace_rack:'Scaffale',trace_box_count:'Scatole',trace_eggs_per_box:'Uova/Scatola',trace_qr:'Codice QR',trace_delivery:'Data di Consegna',trace_search:'Cerca per ID/QR',trace_origin:'Origine',trace_house:'Capannone',
nav_planning:'Pianificazione',plan_title:'Pianificazione Produzione',plan_add:'Nuovo Piano',plan_name:'Nome Piano',plan_target_date:'Data Obiettivo',plan_eggs_needed:'Uova Necessarie',plan_allocations:'Allocazioni Gruppi',plan_expected:'Produzione Prevista',plan_gap:'Scostamento',plan_on_track:'In Linea',plan_behind:'In Ritardo',plan_ahead:'In Anticipo',plan_estimate:'Stima',plan_commitment:'Impegno',
prod_egg_type:'Tipo di Uovo',prod_type_conventional:'Convenzionale',prod_type_free_range:'Allevamento a Terra',prod_type_organic:'Biologico',prod_type_pasture:'Allevamento al Pascolo',prod_type_decorative:'Decorativo',
prod_market:'Canale di Mercato',prod_market_wholesale:'Ingrosso',prod_market_supermarket:'Supermercato',prod_market_restaurant:'Ristorante',prod_market_direct:'Vendita Diretta',prod_market_export:'Esportazione',prod_market_pasteurized:'Pastorizzato',
ana_by_segment:'Redditività per Segmento',ana_by_type:'Per Tipo',ana_by_channel:'Per Canale',
nav_campo_mode:'Modalità Campo',nav_vet_mode:'Modalità Veterinario',campo_today:'OGGI',campo_quick_entry:'Inserimento Rapido',vet_visit:'Visita completata',vet_vaccines:'Vaccini applicati',vet_pending:'In attesa di revisione',vet_select_farm:'Seleziona Allevamento/Gruppo',
cfg_font_size:'Dimensione Testo',cfg_font_small:'Piccolo',cfg_font_normal:'Normale',cfg_font_large:'Grande',cfg_font_xlarge:'Extra Grande',cfg_dark_mode:'Modalità Scura',cfg_theme_dark:'Scuro',
pred_outbreak_risk:'Rischio Focolaio',pred_outbreak_high:'Rischio Alto',pred_outbreak_medium:'Rischio Medio',pred_outbreak_low:'Rischio Basso',pred_outbreak_factor:'Fattore',pred_outbreak_weight:'Peso',pred_outbreak_value:'Valore',pred_probability:'Probabilità',pred_factors:'Fattori',pred_recommendations:'Raccomandazioni',pred_confidence:'Affidabilità',pred_forecast_7d:'7 giorni',pred_forecast_14d:'14 giorni',pred_ensemble:'Previsione Combinata',pred_forecast_upper:'Banda Superiore',pred_forecast_lower:'Banda Inferiore',
ana_segment_profit:'Redditività per Segmento',cfg_accessibility:'Accessibilità',
rec_title:'Raccomandazioni',rec_dismiss:'Ignora',rec_check_diet:'Controllare dieta / formulazione mangime / escludere malattia',rec_check_env:'Controllare ambiente / malattia / stress immediatamente',rec_below_curve:'Sotto la produzione standard — controllare stress, luce, mangime',rec_buy_feed:'Programmare acquisto mangime',rec_record_env:'Registrare condizioni ambientali',rec_disinfect:'Eseguire protocollo di disinfezione zona',rec_heat_plan:'Stress da calore prolungato — attivare piano di raffreddamento',rec_lab_samples:'Inviare campioni al laboratorio',rec_ventilation:'Aumentare ventilazione, controllare acqua fresca',
auth_welcome:'Account creato. Benvenuto!',auth_error:'Credenziali non valide',auth_first_run:'Prima volta: inserisci nome utente e password per creare il tuo account.',login_subtitle:'Inserisci le tue credenziali',logout:'Esci',required:'Campo obbligatorio',invalid_email:'Email non valida',invalid_phone:'Telefono non valido',must_be_number:'Deve essere un numero',invalid_date:'Data non valida',invalid_format:'Formato non valido',min_length:'Lunghezza minima',max_length:'Lunghezza massima',min_value:'Valore minimo',max_value:'Valore massimo',error_network:'Errore di rete',error_unexpected:'Errore imprevisto',error_loading:'Errore di caricamento'
},
ja:{
save:'保存',cancel:'キャンセル',delete:'削除',edit:'編集',add:'追加',close:'閉じる',actions:'操作',date:'日付',notes:'メモ',name:'名前',phone:'電話',email:'メール',address:'住所',confirm_delete:'このレコードを削除しますか？',no_data:'データがありません',total:'合計',all:'すべて',loading:'読み込み中',search:'検索',from:'開始',to:'終了',status:'ステータス',export_csv:'CSV出力',today:'今日',active:'有効',inactive:'無効',
nav_dashboard:'ダッシュボード',nav_production:'産卵記録',nav_flocks:'鶏群',nav_health:'健康管理',nav_feed:'飼料',nav_clients:'取引先',nav_finances:'財務',nav_analysis:'分析',nav_operations:'運営',nav_environment:'環境',nav_config:'設定',nav_admin:'SaaS管理',nav_inventory:'在庫',grp_production:'生産',grp_health:'健康',grp_commercial:'商業',grp_management:'管理',grp_system:'システム',
dash_title:'メインダッシュボード',kpi_today:'本日の生産',kpi_henday:'ヘンデイ産卵率',kpi_fcr:'飼料要求率（FCR）',kpi_mortality:'死亡率',kpi_cost_egg:'卵1個あたりコスト',kpi_income_net:'純利益',kpi_alerts:'アラート',kpi_active_hens:'稼働鶏数',kpi_active_flocks:'稼働鶏群数',dash_alerts:'アラート',dash_trend:'30日間トレンド',dash_no_alerts:'アラートなし',dash_snapshot:'KPIスナップショットを保存',dash_kpi_history:'KPI履歴',
alert_vaccine_overdue:'ワクチン期限超過',alert_vaccine_soon:'ワクチン接種予定',alert_low_feed:'飼料在庫不足',alert_high_mortality:'高死亡率',alert_active_outbreak:'発生中の疾病',alert_withdrawal:'休薬期間中',
flock_title:'鶏群管理',flock_add:'新規鶏群',flock_name:'名称',flock_breed:'品種',flock_count:'初期羽数',flock_birthdate:'孵化日',flock_purchase_date:'購入日',flock_supplier:'仕入先',flock_cost:'総コスト',flock_status:'ステータス',flock_notes:'メモ',flock_age:'日齢',flock_health:'健康状態',flock_weeks:'週',flock_days:'日',flock_current:'現在',flock_status_cria:'育雛',flock_status_recria:'育成',flock_status_produccion:'産卵期',flock_status_descarte:'淘汰',flock_edit:'鶏群を編集',flock_lifecycle:'ライフサイクル',flock_roadmap:'ロードマップ',
lc_pollito:'ひよこ',lc_cria:'育雛',lc_recria:'育成',lc_prepostura:'産卵前期',lc_pico:'ピーク産卵期',lc_media:'中期産卵期',lc_baja:'後期産卵期',lc_descarte:'淘汰',lc_feed:'飼料',lc_temp:'温度',lc_weeks:'週齢',lc_milestone:'マイルストーン',lc_current_stage:'現在のステージ',
prod_title:'産卵記録',prod_add:'新規記録',prod_flock:'鶏群',prod_eggs:'採卵数',prod_broken:'破損・不良卵',prod_size_s:'小（S）',prod_size_m:'中（M）',prod_size_l:'大（L）',prod_size_xl:'特大（XL）',prod_size_jumbo:'ジャンボ',prod_shell:'卵殻色',prod_yolk:'卵黄品質（1-10）',prod_deaths:'死亡数',prod_death_cause:'死因',prod_date:'日付',
san_title:'健康管理',san_vaccines:'ワクチン',san_medications:'投薬',san_outbreaks:'疾病発生',
vac_title:'ワクチン計画',vac_add:'ワクチン記録',vac_vaccine:'ワクチン',vac_scheduled:'予定日',vac_applied:'接種日',vac_batch:'ロット番号',vac_route:'投与経路',vac_overdue:'期限超過',vac_upcoming:'接種予定',vac_applied_status:'接種済み',vac_pending:'未接種',vac_generate:'カレンダー生成',vac_mark_applied:'接種済みにする',
med_title:'投薬管理',med_add:'投薬記録',med_name:'薬剤名',med_reason:'理由',med_start:'開始日',med_end:'終了日',med_withdrawal:'休薬日数',med_withdrawal_end:'休薬終了日',med_dosage:'投与量',med_in_withdrawal:'休薬期間中',
out_title:'疾病発生',out_add:'発生記録',out_disease:'疾病名',out_start:'発生日',out_end:'終息日',out_affected:'罹患羽数',out_deaths:'死亡羽数',out_symptoms:'症状',out_treatment:'治療',out_loss:'経済損失',out_active:'発生中',out_controlled:'制御中',out_resolved:'終息',
feed_title:'飼料管理',feed_purchases:'購入',feed_consumption:'消費',feed_stock:'現在の在庫',feed_add_purchase:'新規購入',feed_add_consumption:'消費記録',feed_type:'種類',feed_qty:'数量（kg）',feed_cost:'コスト',feed_supplier:'仕入先',feed_flock:'鶏群',feed_low_alert:'在庫不足',
cli_title:'取引先',cli_add:'新規取引先',cli_route:'配送ルート・地域',cli_price:'取り決め価格',cli_total:'取引先合計',
fin_title:'財務',fin_income:'収入',fin_expenses:'支出',fin_receivables:'売掛金',fin_summary:'概要',fin_add_income:'新規収入',fin_add_expense:'新規支出',fin_add_receivable:'新規売掛金',fin_type:'種類',fin_qty:'数量',fin_unit_price:'単価',fin_client:'取引先',fin_category:'カテゴリ',fin_description:'説明',fin_amount:'金額',fin_due_date:'支払期限',fin_paid:'支払済み',fin_total_income:'総収入',fin_total_expenses:'総支出',fin_net:'純利益',fin_cost_per_egg:'卵1個あたりコスト',fin_break_even:'損益分岐点',fin_month:'月',
fin_cat_feed:'飼料',fin_cat_vaccines:'ワクチン・薬剤',fin_cat_transport:'輸送',fin_cat_labor:'人件費',fin_cat_infrastructure:'設備',fin_cat_bird_purchase:'鶏購入',fin_cat_other:'その他',
fin_type_eggs:'卵販売',fin_type_birds:'鶏販売',fin_type_manure:'鶏糞販売',fin_type_other:'その他',
ana_title:'分析',ana_comparison:'鶏群比較',ana_seasonality:'季節性',ana_profitability:'収益性',ana_benchmarks:'ベンチマーク',ana_best_flock:'最優良鶏群',ana_worst_flock:'最低鶏群',ana_avg_production:'平均生産',ana_trend:'トレンド',ana_kpi_evolution:'KPI推移',ana_no_snapshots:'スナップショットがありません。ダッシュボードから保存してください。',
ops_title:'運営管理',ops_checklist:'日次チェックリスト',ops_logbook:'作業日誌',ops_personnel:'人員',ops_task:'タスク',ops_done:'完了',ops_add_task:'タスク追加',ops_check_date:'日付',ops_log_entry:'記録内容',ops_log_category:'カテゴリ',ops_log_add:'新規記録',
ops_log_cat_general:'一般',ops_log_cat_health:'健康',ops_log_cat_production:'生産',ops_log_cat_maintenance:'メンテナンス',ops_log_cat_observation:'観察',
ops_per_name:'名前',ops_per_role:'役職',ops_per_salary:'給与',ops_per_start:'入社日',ops_per_active:'在籍中',ops_per_add:'人員追加',
env_title:'環境条件',env_add:'新規記録',env_temp:'温度（°C）',env_humidity:'湿度（%）',env_light:'照明時間',env_ventilation:'換気',env_density:'飼養密度（羽/m²）',env_optimal:'適正範囲',env_temp_range:'18-24°C',env_humidity_range:'40-70%',env_light_range:'14-16時間',env_density_range:'4-5羽/m²',
cfg_title:'設定',cfg_farm:'農場情報',cfg_farm_name:'農場名',cfg_location:'所在地',cfg_capacity:'収容能力（羽）',cfg_currency:'通貨',cfg_alerts:'アラート閾値',cfg_min_feed:'最低飼料在庫（kg）',cfg_max_mortality:'最大死亡率（%）',cfg_alert_days:'アラート先行日数',cfg_data:'データ',cfg_export:'エクスポート（JSON）',cfg_import:'インポート（JSON）',cfg_reset:'全データ削除',cfg_reset_confirm:'すべてのデータを完全に削除しますか？',cfg_saved:'保存しました',cfg_exported:'データをエクスポートしました',cfg_imported:'データをインポートしました',cfg_reset_done:'データを削除しました',cfg_checklist:'デフォルトチェックリスト',cfg_checklist_items:'日次チェックリストのタスク',cfg_theme:'カラーテーマ',cfg_theme_blue:'ネイビーブルー',cfg_theme_green:'グリーン',cfg_theme_purple:'パープル',cfg_theme_black:'ブラック',
sidebar_subtitle:'養鶏システム 360°',prod_shell_white:'白',prod_shell_brown:'赤（茶）',prod_shell_cream:'クリーム',required:'必須項目',no_flocks_birthdate:'孵化日のある鶏群がありません',vac_select_flocks:'カレンダーを生成する鶏群を選択：',feed_type_placeholder:'レイヤー、スターターなど',avg_per_day:'平均/日',per_flock:'鶏群',history:'履歴',env_latest_reading:'最新の計測値',env_ok:'正常',env_out_of_range:'範囲外',data_stats:'データ統計',final_warning:'⚠️ 最終警告 — すべてのデータが削除されます',total_salaries:'給与合計',eggs_unit:'卵',csv_income:'収入',csv_expense:'支出',fcr_unit:'kg飼料/kg卵',lc_feed_starter:'スターター',lc_feed_grower:'グロワー',lc_feed_developer:'デベロッパー',lc_feed_prelay:'プレレイ',lc_feed_layer:'レイヤー',lc_feed_lowlay:'ローレイ',lc_prod_label:'産卵',lc_prod_first:'初産卵',lc_mile_1:'マレック、ニューカッスル+IB、ガンボロワクチン',lc_mile_2:'ニューカッスル追加接種、羽毛発達',lc_mile_3:'鶏痘、AE、コリーザ、サルモネラ',lc_mile_4:'ニューカッスル+IB追加接種、飼料変更、16時間点灯',lc_mile_5:'ピーク産卵26-30週、FCRモニタリング',lc_mile_6:'ニューカッスル追加接種8-12週ごと、収益性評価',lc_mile_7:'淘汰または強制換羽を検討',lc_mile_8:'淘汰鶏を出荷、鶏舎清掃',vac_route_injection:'注射',vac_route_ocular:'点眼・噴霧',vac_route_water:'飲水投与',vac_route_wing:'翼膜刺種',snapshots:'スナップショット',error_prefix:'エラー',chk_collect_eggs:'採卵',chk_feed_birds:'給餌',chk_check_water:'飲水確認',chk_check_health:'健康チェック',chk_cleaning:'清掃',chk_record_temp:'温度記録',
weather_title:'天気',weather_temp:'気温',weather_humidity:'湿度',weather_wind:'風速',weather_forecast:'3日間予報',weather_no_key:'設定でOpenWeatherMap APIキーを設定してください',weather_heat_alert:'熱ストレス警報',weather_thi:'THI指数',weather_feels:'体感温度',weather_last_update:'最終更新',weather_test:'テスト',
geo_set_location:'農場の位置',geo_use_gps:'GPSを使用',geo_click_map:'地図をクリックして位置を設定',geo_lat:'緯度',geo_lng:'経度',geo_saved:'位置を保存しました',
iot_title:'IoTセンサー',iot_broker:'MQTTブローカー（wss://）',iot_user:'MQTTユーザー',iot_pass:'MQTTパスワード',iot_topic:'トピックプレフィックス',iot_connect:'接続',iot_disconnect:'切断',iot_live:'IoTライブ',iot_no_config:'設定でMQTTを構成してください',iot_save_reading:'現在の計測値を保存',iot_connected:'接続済み',iot_disconnected:'未接続',iot_ammonia:'アンモニア',iot_light:'照度',iot_lux:'lux',iot_ppm:'ppm',
pred_title:'予測',pred_forecast:'産卵予測',pred_anomaly:'異常検知',pred_drop_risk:'低下リスク',pred_breed_curve:'品種標準曲線',pred_fcr_trend:'FCRトレンド',pred_next_7d:'今後7日間',pred_improving:'改善傾向',pred_worsening:'悪化傾向',pred_stable:'安定',pred_score:'スコア',pred_low:'低',pred_medium:'中',pred_high:'高',pred_vs_expected:'実績 vs 予測',
stress_title:'ストレスイベント',stress_type:'種類',stress_severity:'重症度',stress_heat:'熱ストレス',stress_disease:'疾病',stress_feed_change:'飼料変更',stress_power:'停電',stress_predator:'外敵',stress_other:'その他',stress_description:'説明',stress_add:'新規イベント',stress_impact:'生産への影響',stress_auto:'（自動生成）',
env_ammonia:'アンモニア（ppm）',env_wind:'風速（km/h）',env_thi:'THI指数',env_manual:'手動入力',env_history:'履歴',env_iot:'IoTライブ',
pwa_install:'アプリをインストール',pwa_offline:'オフラインモード利用可能',
cfg_owm_key:'OpenWeatherMap APIキー',cfg_mqtt:'MQTT設定',cfg_geo:'位置情報',
flock_housing:'飼育形態',flock_housing_floor:'平飼い',flock_housing_cage:'ケージ',flock_housing_free:'放し飼い',flock_target_curve:'目標曲線',flock_egg_color:'卵殻色',
ana_predictions:'予測',
per_day:'日あたり',actual:'実績',expected:'予測',not_available:'利用不可',
nav_biosecurity:'バイオセキュリティ',bio_title:'バイオセキュリティ・害虫管理',bio_visitors:'来訪者',bio_zones:'ゾーン',bio_pests:'害虫',bio_protocols:'プロトコル',
bio_add_visitor:'新規来訪者',bio_visitor_name:'名前',bio_visitor_company:'会社名',bio_visitor_purpose:'目的',bio_visitor_zone:'ゾーン',bio_visitor_plate:'車両ナンバー',bio_visitor_disinfected:'消毒済み',bio_visitor_from_farm:'出発元農場',bio_visitor_from_health:'出発元農場の健康状態',bio_cross_risk:'⚠️ 交差汚染リスク',
bio_add_zone:'新規ゾーン',bio_zone_name:'ゾーン名',bio_zone_risk:'リスクレベル',bio_zone_last_disinfection:'最終消毒日',bio_zone_frequency:'頻度（日）',bio_risk_green:'グリーン',bio_risk_yellow:'イエロー',bio_risk_red:'レッド',
bio_add_pest:'新規目撃',bio_pest_type:'種類',bio_pest_rodent:'げっ歯類',bio_pest_fly:'ハエ',bio_pest_wild_bird:'野鳥',bio_pest_other:'その他',bio_pest_location:'場所',bio_pest_severity:'深刻度',bio_pest_action:'対処内容',bio_pest_resolved:'解決済み',
bio_add_protocol:'新規プロトコル',bio_protocol_name:'プロトコル名',bio_protocol_frequency:'頻度',bio_protocol_daily:'毎日',bio_protocol_weekly:'毎週',bio_protocol_monthly:'毎月',bio_protocol_last:'最終実施日',bio_protocol_items:'プロトコル項目',bio_protocol_complete:'完了',bio_protocol_overdue:'期限超過',
bio_pest_score:'害虫スコア',bio_overdue_disinfection:'消毒期限超過',bio_unresolved_pests:'未解決の害虫問題',
alert_bio_disinfection:'ゾーン消毒期限超過',alert_bio_pests:'未解決の害虫問題',alert_bio_cross:'交差汚染リスク',
nav_traceability:'トレーサビリティ',trace_title:'卵のトレーサビリティ',trace_add:'新規ロット',trace_batch_id:'ロットID',trace_rack:'ラック',trace_box_count:'箱数',trace_eggs_per_box:'卵数/箱',trace_qr:'QRコード',trace_delivery:'出荷日',trace_search:'ID/QRで検索',trace_origin:'産地',trace_house:'鶏舎',
nav_planning:'計画',plan_title:'生産計画',plan_add:'新規計画',plan_name:'計画名',plan_target_date:'目標日',plan_eggs_needed:'必要卵数',plan_allocations:'鶏群配分',plan_expected:'予想生産量',plan_gap:'差異',plan_on_track:'順調',plan_behind:'遅延',plan_ahead:'前倒し',plan_estimate:'見積り',plan_commitment:'コミットメント',
prod_egg_type:'卵の種類',prod_type_conventional:'慣行飼育',prod_type_free_range:'フリーレンジ',prod_type_organic:'有機',prod_type_pasture:'放牧',prod_type_decorative:'装飾用',
prod_market:'販売チャネル',prod_market_wholesale:'卸売',prod_market_supermarket:'スーパーマーケット',prod_market_restaurant:'レストラン',prod_market_direct:'直売',prod_market_export:'輸出',prod_market_pasteurized:'加工（殺菌）',
ana_by_segment:'セグメント別収益性',ana_by_type:'種類別',ana_by_channel:'チャネル別',
nav_campo_mode:'フィールドモード',nav_vet_mode:'獣医モード',campo_today:'本日',campo_quick_entry:'クイック入力',vet_visit:'訪問完了',vet_vaccines:'ワクチン接種済み',vet_pending:'確認待ち',vet_select_farm:'農場・鶏群を選択',
cfg_font_size:'文字サイズ',cfg_font_small:'小',cfg_font_normal:'標準',cfg_font_large:'大',cfg_font_xlarge:'特大',cfg_dark_mode:'ダークモード',cfg_theme_dark:'ダーク',
pred_outbreak_risk:'疾病発生リスク',pred_outbreak_high:'高リスク',pred_outbreak_medium:'中リスク',pred_outbreak_low:'低リスク',pred_outbreak_factor:'要因',pred_outbreak_weight:'重み',pred_outbreak_value:'値',pred_probability:'確率',pred_factors:'要因',pred_recommendations:'推奨事項',pred_confidence:'信頼度',pred_forecast_7d:'7日間',pred_forecast_14d:'14日間',pred_ensemble:'アンサンブル予測',pred_forecast_upper:'上限バンド',pred_forecast_lower:'下限バンド',
ana_segment_profit:'セグメント別収益性',cfg_accessibility:'アクセシビリティ',
rec_title:'推奨事項',rec_dismiss:'非表示にする',rec_check_diet:'飼料設計を確認・疾病の可能性を除外',rec_check_env:'環境・疾病・ストレスを直ちに確認',rec_below_curve:'標準産卵曲線を下回っています — ストレス・照明・飼料を確認',rec_buy_feed:'飼料の購入を計画してください',rec_record_env:'環境条件を記録してください',rec_disinfect:'ゾーンの消毒プロトコルを実施してください',rec_heat_plan:'長期間の熱ストレス — 冷却計画を実施してください',rec_lab_samples:'検体を検査機関に提出してください',rec_ventilation:'換気を強化し、新鮮な飲水を確認してください',
auth_welcome:'アカウントが作成されました。ようこそ！',auth_error:'認証情報が正しくありません',auth_first_run:'初回：ユーザー名とパスワードを入力してアカウントを作成してください。',login_subtitle:'認証情報を入力してください',logout:'ログアウト',required:'必須項目',invalid_email:'無効なメールアドレス',invalid_phone:'無効な電話番号',must_be_number:'数値を入力してください',invalid_date:'無効な日付',invalid_format:'無効な形式',min_length:'最小長',max_length:'最大長',min_value:'最小値',max_value:'最大値',error_network:'ネットワークエラー',error_unexpected:'予期しないエラー',error_loading:'読み込みエラー'
},
zh:{
save:'保存',cancel:'取消',delete:'删除',edit:'编辑',add:'添加',close:'关闭',actions:'操作',date:'日期',notes:'备注',name:'名称',phone:'电话',email:'邮箱',address:'地址',confirm_delete:'确定删除此记录？',no_data:'暂无数据',total:'合计',all:'全部',loading:'加载中',search:'搜索',from:'从',to:'至',status:'状态',export_csv:'导出CSV',today:'今天',active:'活跃',inactive:'停用',
nav_dashboard:'仪表盘',nav_production:'产蛋',nav_flocks:'鸡群',nav_health:'健康',nav_feed:'饲料',nav_clients:'客户',nav_finances:'财务',nav_analysis:'分析',nav_operations:'运营',nav_environment:'环境',nav_config:'设置',nav_admin:'SaaS管理',nav_inventory:'库存',grp_production:'生产',grp_health:'健康',grp_commercial:'商务',grp_management:'管理',grp_system:'系统',
dash_title:'主仪表盘',kpi_today:'今日产量',kpi_henday:'产蛋率',kpi_fcr:'饲料转化率(FCR)',kpi_mortality:'死亡率',kpi_cost_egg:'单蛋成本',kpi_income_net:'净收入',kpi_alerts:'警报',kpi_active_hens:'在产母鸡',kpi_active_flocks:'活跃鸡群',dash_alerts:'警报',dash_trend:'30天趋势',dash_no_alerts:'无警报',dash_snapshot:'保存KPI快照',dash_kpi_history:'KPI历史',
alert_vaccine_overdue:'疫苗已过期',alert_vaccine_soon:'疫苗即将到期',alert_low_feed:'饲料库存不足',alert_high_mortality:'死亡率偏高',alert_active_outbreak:'疫情进行中',alert_withdrawal:'休药期进行中',
flock_title:'鸡群管理',flock_add:'新建鸡群',flock_name:'名称',flock_breed:'品种',flock_count:'初始数量',flock_birthdate:'出生日期',flock_purchase_date:'购入日期',flock_supplier:'供应商',flock_cost:'总成本',flock_status:'状态',flock_notes:'备注',flock_age:'日龄',flock_health:'健康',flock_weeks:'周',flock_days:'天',flock_current:'当前',flock_status_cria:'育雏期',flock_status_recria:'育成期',flock_status_produccion:'产蛋期',flock_status_descarte:'淘汰',flock_edit:'编辑鸡群',flock_lifecycle:'生命周期',flock_roadmap:'发展规划',
lc_pollito:'雏鸡',lc_cria:'育雏期',lc_recria:'育成期',lc_prepostura:'预产期',lc_pico:'产蛋高峰期',lc_media:'产蛋中期',lc_baja:'产蛋后期',lc_descarte:'淘汰',lc_feed:'饲料',lc_temp:'温度',lc_weeks:'周龄',lc_milestone:'里程碑',lc_current_stage:'当前阶段',
prod_title:'产蛋记录',prod_add:'新建记录',prod_flock:'鸡群',prod_eggs:'收蛋数',prod_broken:'破损/次品',prod_size_s:'小号(S)',prod_size_m:'中号(M)',prod_size_l:'大号(L)',prod_size_xl:'特大号(XL)',prod_size_jumbo:'巨型',prod_shell:'蛋壳颜色',prod_yolk:'蛋黄品质(1-10)',prod_deaths:'死亡数',prod_death_cause:'死因',prod_date:'日期',
san_title:'健康管理',san_vaccines:'疫苗',san_medications:'药物',san_outbreaks:'疫情',
vac_title:'免疫计划',vac_add:'记录疫苗',vac_vaccine:'疫苗',vac_scheduled:'计划时间',vac_applied:'接种时间',vac_batch:'批号',vac_route:'接种途径',vac_overdue:'已过期',vac_upcoming:'即将到期',vac_applied_status:'已接种',vac_pending:'待接种',vac_generate:'生成日历',vac_mark_applied:'标记已接种',
med_title:'药物管理',med_add:'记录用药',med_name:'药物名称',med_reason:'用药原因',med_start:'开始',med_end:'结束',med_withdrawal:'休药天数',med_withdrawal_end:'休药结束',med_dosage:'剂量',med_in_withdrawal:'休药期中',
out_title:'疫情管理',out_add:'记录疫情',out_disease:'疾病',out_start:'开始',out_end:'结束',out_affected:'感染数',out_deaths:'死亡数',out_symptoms:'症状',out_treatment:'治疗',out_loss:'经济损失',out_active:'进行中',out_controlled:'已控制',out_resolved:'已解决',
feed_title:'饲料管理',feed_purchases:'采购',feed_consumption:'消耗',feed_stock:'当前库存',feed_add_purchase:'新建采购',feed_add_consumption:'记录消耗',feed_type:'类型',feed_qty:'数量(kg)',feed_cost:'费用',feed_supplier:'供应商',feed_flock:'鸡群',feed_low_alert:'库存不足',
cli_title:'客户',cli_add:'新建客户',cli_route:'线路/区域',cli_price:'协议价格',cli_total:'客户总数',
fin_title:'财务',fin_income:'收入',fin_expenses:'支出',fin_receivables:'应收款',fin_summary:'汇总',fin_add_income:'新建收入',fin_add_expense:'新建支出',fin_add_receivable:'新建应收款',fin_type:'类型',fin_qty:'数量',fin_unit_price:'单价',fin_client:'客户',fin_category:'类别',fin_description:'描述',fin_amount:'金额',fin_due_date:'到期日',fin_paid:'已付',fin_total_income:'总收入',fin_total_expenses:'总支出',fin_net:'净利润',fin_cost_per_egg:'单蛋成本',fin_break_even:'盈亏平衡点',fin_month:'月份',
fin_cat_feed:'饲料',fin_cat_vaccines:'疫苗/药物',fin_cat_transport:'运输',fin_cat_labor:'人工',fin_cat_infrastructure:'基础设施',fin_cat_bird_purchase:'购买家禽',fin_cat_other:'其他',
fin_type_eggs:'鸡蛋销售',fin_type_birds:'活禽销售',fin_type_manure:'鸡粪销售',fin_type_other:'其他',
ana_title:'分析',ana_comparison:'鸡群对比',ana_seasonality:'季节性分析',ana_profitability:'盈利分析',ana_benchmarks:'基准指标',ana_best_flock:'最佳鸡群',ana_worst_flock:'最差鸡群',ana_avg_production:'平均产量',ana_trend:'趋势',ana_kpi_evolution:'KPI演变',ana_no_snapshots:'暂无快照。请在仪表盘中保存快照。',
ops_title:'运营管理',ops_checklist:'每日检查表',ops_logbook:'日志',ops_personnel:'人员',ops_task:'任务',ops_done:'已完成',ops_add_task:'添加任务',ops_check_date:'日期',ops_log_entry:'条目',ops_log_category:'类别',ops_log_add:'新建条目',
ops_log_cat_general:'综合',ops_log_cat_health:'健康',ops_log_cat_production:'产蛋',ops_log_cat_maintenance:'维护',ops_log_cat_observation:'观察',
ops_per_name:'姓名',ops_per_role:'职务',ops_per_salary:'薪资',ops_per_start:'入职日期',ops_per_active:'在职',ops_per_add:'添加人员',
env_title:'环境条件',env_add:'新建记录',env_temp:'温度(°C)',env_humidity:'湿度(%)',env_light:'光照时数',env_ventilation:'通风',env_density:'饲养密度(只/m²)',env_optimal:'最佳范围',env_temp_range:'18-24°C',env_humidity_range:'40-70%',env_light_range:'14-16小时',env_density_range:'4-5只/m²',
cfg_title:'设置',cfg_farm:'养殖场信息',cfg_farm_name:'养殖场名称',cfg_location:'位置',cfg_capacity:'容量(只)',cfg_currency:'货币',cfg_alerts:'警报阈值',cfg_min_feed:'最低饲料库存(kg)',cfg_max_mortality:'最高死亡率(%)',cfg_alert_days:'提前预警天数',cfg_data:'数据',cfg_export:'导出(JSON)',cfg_import:'导入(JSON)',cfg_reset:'删除全部',cfg_reset_confirm:'确定永久删除所有数据？',cfg_saved:'已保存',cfg_exported:'数据已导出',cfg_imported:'数据已导入',cfg_reset_done:'数据已删除',cfg_checklist:'默认检查表',cfg_checklist_items:'每日检查任务',cfg_theme:'颜色主题',cfg_theme_blue:'藏蓝色',cfg_theme_green:'绿色',cfg_theme_purple:'紫色',cfg_theme_black:'黑色',
sidebar_subtitle:'家禽管理系统360°',prod_shell_white:'白色',prod_shell_brown:'褐色',prod_shell_cream:'米色',required:'必填项',no_flocks_birthdate:'无出生日期的鸡群',vac_select_flocks:'选择鸡群以生成日历：',feed_type_placeholder:'蛋鸡料、雏鸡料等',avg_per_day:'日均',per_flock:'鸡群',history:'历史',env_latest_reading:'最新读数',env_ok:'正常',env_out_of_range:'超出范围',data_stats:'数据统计',final_warning:'⚠️ 最终警告 - 所有数据将被删除',total_salaries:'工资总额',eggs_unit:'枚',csv_income:'收入',csv_expense:'支出',fcr_unit:'公斤饲料/公斤蛋',lc_feed_starter:'雏鸡料',lc_feed_grower:'育成料',lc_feed_developer:'发育料',lc_feed_prelay:'预产料',lc_feed_layer:'蛋鸡料',lc_feed_lowlay:'后期料',lc_prod_label:'产蛋',lc_prod_first:'初产蛋',lc_mile_1:'马立克、新城疫+传支、法氏囊疫苗',lc_mile_2:'新城疫加强免疫、羽毛发育',lc_mile_3:'鸡痘、禽脑脊髓炎、传染性鼻炎、沙门氏菌',lc_mile_4:'新城疫+传支加强免疫、换料、16小时光照',lc_mile_5:'产蛋高峰期第26-30周，监控FCR',lc_mile_6:'每8-12周加强新城疫免疫，评估盈利能力',lc_mile_7:'评估淘汰或强制换羽',lc_mile_8:'出售淘汰鸡、清洁鸡舍',vac_route_injection:'注射',vac_route_ocular:'点眼/喷雾',vac_route_water:'饮水',vac_route_wing:'翅膀刺种',snapshots:'快照',error_prefix:'错误',chk_collect_eggs:'捡蛋',chk_feed_birds:'喂料',chk_check_water:'检查饮水',chk_check_health:'检查健康',chk_cleaning:'清洁',chk_record_temp:'记录温度',
weather_title:'天气',weather_temp:'温度',weather_humidity:'湿度',weather_wind:'风力',weather_forecast:'3天预报',weather_no_key:'请在设置中配置OpenWeatherMap API密钥',weather_heat_alert:'热应激警报',weather_thi:'THI指数',weather_feels:'体感温度',weather_last_update:'最后更新',weather_test:'测试',
geo_set_location:'养殖场位置',geo_use_gps:'使用GPS定位',geo_click_map:'点击地图设置位置',geo_lat:'纬度',geo_lng:'经度',geo_saved:'位置已保存',
iot_title:'IoT传感器',iot_broker:'MQTT服务器(wss://)',iot_user:'MQTT用户名',iot_pass:'MQTT密码',iot_topic:'主题前缀',iot_connect:'连接',iot_disconnect:'断开',iot_live:'IoT实时',iot_no_config:'请在设置中配置MQTT',iot_save_reading:'保存当前读数',iot_connected:'已连接',iot_disconnected:'已断开',iot_ammonia:'氨气',iot_light:'光照',iot_lux:'lux',iot_ppm:'ppm',
pred_title:'预测',pred_forecast:'产蛋预测',pred_anomaly:'异常检测',pred_drop_risk:'下降风险',pred_breed_curve:'品种标准曲线',pred_fcr_trend:'FCR趋势',pred_next_7d:'未来7天',pred_improving:'改善中',pred_worsening:'恶化中',pred_stable:'稳定',pred_score:'评分',pred_low:'低',pred_medium:'中',pred_high:'高',pred_vs_expected:'实际与预期对比',
stress_title:'应激事件',stress_type:'类型',stress_severity:'严重程度',stress_heat:'热应激',stress_disease:'疾病',stress_feed_change:'换料',stress_power:'停电',stress_predator:'天敌',stress_other:'其他',stress_description:'描述',stress_add:'新建事件',stress_impact:'产蛋影响',stress_auto:'(自动生成)',
env_ammonia:'氨气(ppm)',env_wind:'风速(km/h)',env_thi:'THI指数',env_manual:'手动录入',env_history:'历史',env_iot:'IoT实时',
pwa_install:'安装应用',pwa_offline:'离线模式可用',
cfg_owm_key:'OpenWeatherMap API密钥',cfg_mqtt:'MQTT设置',cfg_geo:'地理定位',
flock_housing:'饲养方式',flock_housing_floor:'地面平养',flock_housing_cage:'笼养',flock_housing_free:'散养',flock_target_curve:'目标曲线',flock_egg_color:'蛋壳颜色',
ana_predictions:'预测',
per_day:'每天',actual:'实际',expected:'预期',not_available:'暂无',
nav_biosecurity:'生物安全',bio_title:'生物安全与虫害防治',bio_visitors:'访客',bio_zones:'区域',bio_pests:'虫害',bio_protocols:'规程',
bio_add_visitor:'新建访客',bio_visitor_name:'姓名',bio_visitor_company:'单位',bio_visitor_purpose:'目的',bio_visitor_zone:'区域',bio_visitor_plate:'车牌号',bio_visitor_disinfected:'已消毒',bio_visitor_from_farm:'来源养殖场',bio_visitor_from_health:'来源场健康状况',bio_cross_risk:'⚠️ 交叉污染风险',
bio_add_zone:'新建区域',bio_zone_name:'区域名称',bio_zone_risk:'风险等级',bio_zone_last_disinfection:'上次消毒',bio_zone_frequency:'频率(天)',bio_risk_green:'绿色',bio_risk_yellow:'黄色',bio_risk_red:'红色',
bio_add_pest:'新建记录',bio_pest_type:'类型',bio_pest_rodent:'鼠害',bio_pest_fly:'蝇害',bio_pest_wild_bird:'野鸟',bio_pest_other:'其他',bio_pest_location:'位置',bio_pest_severity:'严重程度',bio_pest_action:'已采取措施',bio_pest_resolved:'已解决',
bio_add_protocol:'新建规程',bio_protocol_name:'规程名称',bio_protocol_frequency:'频率',bio_protocol_daily:'每日',bio_protocol_weekly:'每周',bio_protocol_monthly:'每月',bio_protocol_last:'上次完成',bio_protocol_items:'规程项目',bio_protocol_complete:'完成',bio_protocol_overdue:'已逾期',
bio_pest_score:'虫害评分',bio_overdue_disinfection:'消毒已逾期',bio_unresolved_pests:'未解决虫害',
alert_bio_disinfection:'区域消毒已逾期',alert_bio_pests:'未解决虫害',alert_bio_cross:'交叉污染风险',
nav_traceability:'溯源',trace_title:'鸡蛋溯源',trace_add:'新建批次',trace_batch_id:'批次号',trace_rack:'蛋架',trace_box_count:'箱数',trace_eggs_per_box:'每箱蛋数',trace_qr:'二维码',trace_delivery:'配送日期',trace_search:'按批次号/二维码搜索',trace_origin:'产地',trace_house:'鸡舍',
nav_planning:'计划',plan_title:'生产计划',plan_add:'新建计划',plan_name:'计划名称',plan_target_date:'目标日期',plan_eggs_needed:'需蛋量',plan_allocations:'鸡群分配',plan_expected:'预计产量',plan_gap:'缺口',plan_on_track:'正常',plan_behind:'落后',plan_ahead:'超前',plan_estimate:'预估',plan_commitment:'承诺量',
prod_egg_type:'鸡蛋类型',prod_type_conventional:'常规蛋',prod_type_free_range:'散养蛋',prod_type_organic:'有机蛋',prod_type_pasture:'牧场蛋',prod_type_decorative:'观赏蛋',
prod_market:'销售渠道',prod_market_wholesale:'批发',prod_market_supermarket:'超市',prod_market_restaurant:'餐饮',prod_market_direct:'直销',prod_market_export:'出口',prod_market_pasteurized:'巴氏杀菌蛋',
ana_by_segment:'按细分盈利分析',ana_by_type:'按类型',ana_by_channel:'按渠道',
nav_campo_mode:'现场模式',nav_vet_mode:'兽医模式',campo_today:'今日',campo_quick_entry:'快速录入',vet_visit:'巡检完成',vet_vaccines:'已接种疫苗',vet_pending:'待审核',vet_select_farm:'选择养殖场/鸡群',
cfg_font_size:'字体大小',cfg_font_small:'小',cfg_font_normal:'正常',cfg_font_large:'大',cfg_font_xlarge:'特大',cfg_dark_mode:'深色模式',cfg_theme_dark:'深色',
pred_outbreak_risk:'疫情风险',pred_outbreak_high:'高风险',pred_outbreak_medium:'中风险',pred_outbreak_low:'低风险',pred_outbreak_factor:'因素',pred_outbreak_weight:'权重',pred_outbreak_value:'数值',pred_probability:'概率',pred_factors:'因素',pred_recommendations:'建议',pred_confidence:'置信度',pred_forecast_7d:'7天',pred_forecast_14d:'14天',pred_ensemble:'集成预测',pred_forecast_upper:'上限带',pred_forecast_lower:'下限带',
ana_segment_profit:'按细分盈利分析',cfg_accessibility:'无障碍',
rec_title:'建议',rec_dismiss:'忽略',rec_check_diet:'检查日粮/饲料配方/排除疾病',rec_check_env:'立即检查环境/疾病/应激',rec_below_curve:'低于标准产蛋曲线 - 检查应激、光照、饲料',rec_buy_feed:'安排饲料采购',rec_record_env:'记录环境条件',rec_disinfect:'执行区域消毒规程',rec_heat_plan:'持续热应激 - 启动降温方案',rec_lab_samples:'采集样本送检',rec_ventilation:'加强通风，检查饮水供应',
auth_welcome:'账户已创建。欢迎！',auth_error:'凭据不正确',auth_first_run:'首次使用：输入用户名和密码以创建您的账户。',login_subtitle:'请输入您的凭据',logout:'退出登录',required:'必填项',invalid_email:'无效的邮箱',invalid_phone:'无效的电话号码',must_be_number:'必须是数字',invalid_date:'无效的日期',invalid_format:'无效的格式',min_length:'最小长度',max_length:'最大长度',min_value:'最小值',max_value:'最大值',error_network:'网络错误',error_unexpected:'意外错误',error_loading:'加载错误'
}};

// ============ LIFECYCLE ROADMAP ============
const LIFECYCLE=[
{stage:'pollito',key:'lc_pollito',weekStart:0,weekEnd:4,color:'#FFF9C4',icon:'🐣',feed:'lc_feed_starter',temp:'32-35°C',prod:'-',milestones:'lc_mile_1'},
{stage:'cria',key:'lc_cria',weekStart:4,weekEnd:8,color:'#FFECB3',icon:'🐤',feed:'lc_feed_grower',temp:'28-32°C',prod:'-',milestones:'lc_mile_2'},
{stage:'recria',key:'lc_recria',weekStart:8,weekEnd:18,color:'#C8E6C9',icon:'🐔',feed:'lc_feed_developer',temp:'22-28°C',prod:'-',milestones:'lc_mile_3'},
{stage:'pre_postura',key:'lc_prepostura',weekStart:18,weekEnd:20,color:'#B3E5FC',icon:'🐔',feed:'lc_feed_prelay',temp:'20-24°C',prod:'lc_prod_first',milestones:'lc_mile_4'},
{stage:'postura_pico',key:'lc_pico',weekStart:20,weekEnd:42,color:'#A5D6A7',icon:'🥚',feed:'lc_feed_layer',temp:'18-24°C',prod:'90-95%',milestones:'lc_mile_5'},
{stage:'postura_media',key:'lc_media',weekStart:42,weekEnd:62,color:'#FFCC80',icon:'🥚',feed:'lc_feed_layer',temp:'18-24°C',prod:'80-90%',milestones:'lc_mile_6'},
{stage:'postura_baja',key:'lc_baja',weekStart:62,weekEnd:80,color:'#FFAB91',icon:'🥚',feed:'lc_feed_lowlay',temp:'18-24°C',prod:'<80%',milestones:'lc_mile_7'},
{stage:'descarte',key:'lc_descarte',weekStart:80,weekEnd:999,color:'#BDBDBD',icon:'📦',feed:'-',temp:'-',prod:'-',milestones:'lc_mile_8'}
];

// ============ THEMES ============
const THEMES={
blue:{primary:'#1A3C6E','primary-light':'#4A7AB5','primary-dark':'#0E2240','sidebar-bg':'#0E2240',rgb:'26,60,110'},
green:{primary:'#2E7D32','primary-light':'#4CAF50','primary-dark':'#1B5E20','sidebar-bg':'#1B5E20',rgb:'46,125,50'},
purple:{primary:'#6A1B9A','primary-light':'#AB47BC','primary-dark':'#4A148C','sidebar-bg':'#4A148C',rgb:'106,27,154'},
black:{primary:'#37474F','primary-light':'#607D8B','primary-dark':'#263238','sidebar-bg':'#263238',rgb:'55,71,79'},
dark:{primary:'#90CAF9','primary-light':'#42A5F5','primary-dark':'#1E1E1E','sidebar-bg':'#121212',rgb:'144,202,249'}
};
function applyTheme(name){
const th=THEMES[name]||THEMES.blue;const s=document.documentElement.style;
s.setProperty('--primary',th.primary);s.setProperty('--primary-light',th['primary-light']);
s.setProperty('--primary-dark',th['primary-dark']);s.setProperty('--sidebar-bg',th['sidebar-bg']);
s.setProperty('--primary-hover','rgba('+th.rgb+',.04)');s.setProperty('--primary-ring','rgba('+th.rgb+',.15)');
s.setProperty('--primary-fill','rgba('+th.rgb+',.1)');localStorage.setItem('egglogu_theme',name);
Object.keys(CHARTS).forEach(k=>{if(CHARTS[k]){try{CHARTS[k].destroy();}catch(e){}}});CHARTS={};
}
function themeColor(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
function themeRgba(a){const th=THEMES[localStorage.getItem('egglogu_theme')||'blue']||THEMES.blue;return'rgba('+th.rgb+','+a+')';}

// ============ CORE ============
let LANG=localStorage.getItem('egglogu_lang')||'es';
let DATA=null;let CHARTS={};let currentSection='dashboard';
let currentSanidadTab='vaccines';let currentFinanceTab='income';let currentOpsTab='checklist';
const $=id=>document.getElementById(id);
function t(k){return(T[LANG]&&T[LANG][k])||(T.es&&T.es[k])||k;}
function fmtNum(n,d=0){return Number(n||0).toLocaleString(locale(),{minimumFractionDigits:d,maximumFractionDigits:d});}
function fmtMoney(n){return currency()+fmtNum(n,2);}
function fmtDate(d){if(!d)return'-';return new Date(d+'T12:00:00').toLocaleDateString(locale());}
function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5);}
function currency(){return(DATA||loadData()).farm.currency||'$';}
function todayStr(){return new Date().toISOString().substring(0,10);}

// ============ SECURITY: XSS Prevention ============
function sanitizeHTML(str){
if(typeof str!=='string')return String(str||'');
const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
return str.replace(/[&<>"']/g,c=>map[c]);
}
function escapeAttr(str){return sanitizeHTML(String(str||''));}
function safeHTML(tpl,...vals){return tpl.reduce((out,s,i)=>out+s+(i<vals.length?sanitizeHTML(String(vals[i])):''),'');}

// ============ SECURITY: Input Validation ============
function validateInput(value,rules={}){
const errors=[];
const v=typeof value==='string'?value.trim():value;
if(rules.required&&(v===''||v===null||v===undefined))errors.push(t('required')||'Required');
if(rules.minLength&&typeof v==='string'&&v.length<rules.minLength)errors.push((t('min_length')||'Min length')+': '+rules.minLength);
if(rules.maxLength&&typeof v==='string'&&v.length>rules.maxLength)errors.push((t('max_length')||'Max length')+': '+rules.maxLength);
if(rules.min!==undefined&&Number(v)<rules.min)errors.push((t('min_value')||'Min')+': '+rules.min);
if(rules.max!==undefined&&Number(v)>rules.max)errors.push((t('max_value')||'Max')+': '+rules.max);
if(rules.pattern&&!rules.pattern.test(v))errors.push(rules.patternMsg||(t('invalid_format')||'Invalid format'));
if(rules.email&&v&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v))errors.push(t('invalid_email')||'Invalid email');
if(rules.phone&&v&&!/^[+\d\s\-()]{6,20}$/.test(v))errors.push(t('invalid_phone')||'Invalid phone');
if(rules.numeric&&v!==''&&isNaN(Number(v)))errors.push(t('must_be_number')||'Must be a number');
if(rules.date&&v&&isNaN(Date.parse(v)))errors.push(t('invalid_date')||'Invalid date');
return{valid:errors.length===0,errors};
}
function validateForm(fields){
const allErrors={};let valid=true;
for(const[name,{value,rules}]of Object.entries(fields)){
const result=validateInput(value,rules);
if(!result.valid){allErrors[name]=result.errors;valid=false;}
}
return{valid,errors:allErrors};
}
function showFieldError(fieldId,msg){
const el=$(fieldId);if(!el)return;
el.classList.add('field-error');
let errEl=el.parentElement?.querySelector('.field-error-msg');
if(!errEl){errEl=document.createElement('div');errEl.className='field-error-msg';el.parentElement?.appendChild(errEl);}
errEl.textContent=msg;
}
function clearFieldErrors(){
document.querySelectorAll('.field-error').forEach(el=>el.classList.remove('field-error'));
document.querySelectorAll('.field-error-msg').forEach(el=>el.remove());
}

// ============ UX: Custom Confirm Dialog ============
let _confirmResolve=null;
function showConfirm(msg){
return new Promise(resolve=>{
_confirmResolve=resolve;
$('confirm-title').textContent=t('confirm_delete')||'Confirm';
$('confirm-msg').textContent=msg;
$('confirm-overlay').classList.add('open');
});
}
function confirmYes(){$('confirm-overlay').classList.remove('open');if(_confirmResolve){_confirmResolve(true);_confirmResolve=null;}}
function confirmNo(){$('confirm-overlay').classList.remove('open');if(_confirmResolve){_confirmResolve(false);_confirmResolve=null;}}

// ============ SECURITY: Authentication ============
const AUTH_KEY='egglogu_auth';
const AUTH_SESSION='egglogu_session';
async function hashPassword(pwd, salt) {
  if (!salt) {
    salt = crypto.getRandomValues(new Uint8Array(16));
    salt = Array.from(salt).map(b => b.toString(16).padStart(2, '0')).join('');
  }
  const enc = new TextEncoder().encode(salt + pwd);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  const hash = Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
  return { hash, salt };
}
function isFirstRun(){return!localStorage.getItem(AUTH_KEY);}
function isAuthenticated(){return sessionStorage.getItem(AUTH_SESSION)==='true';}
const loginAttempts = { count: 0, lockUntil: 0 };
async function doLogin(){
const user=$('login-user')?.value?.trim();
const pass=$('login-pass')?.value;
const errEl=$('login-error');
if (Date.now() < loginAttempts.lockUntil) {
  const mins = Math.ceil((loginAttempts.lockUntil - Date.now()) / 60000);
  errEl.textContent = t('login_locked') || `Account locked. Try again in ${mins} minute(s).`;
  return;
}
if(!user||!pass){errEl.textContent=t('required')||'Required';return;}
if(isFirstRun()){
// First time setup — create credentials with salt
const { hash, salt } = await hashPassword(pass);
localStorage.setItem(AUTH_KEY,JSON.stringify({user:user,hash:hash,salt:salt}));
sessionStorage.setItem(AUTH_SESSION,'true');
$('login-screen').classList.add('hidden');
init();
toast(t('auth_welcome')||'Cuenta creada. Bienvenido!');
loginAttempts.count = 0;
return;
}
const stored=JSON.parse(localStorage.getItem(AUTH_KEY));
let match = false;
if (stored.salt) {
  // New salted format
  const { hash } = await hashPassword(pass, stored.salt);
  match = (stored.user === user && stored.hash === hash);
} else {
  // Legacy unsalted format — verify with raw SHA-256 then migrate
  const enc = new TextEncoder().encode(pass);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  const legacyHash = Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
  if (stored.user === user && stored.hash === legacyHash) {
    // Migrate to salted format
    const { hash: newHash, salt: newSalt } = await hashPassword(pass);
    localStorage.setItem(AUTH_KEY, JSON.stringify({ user: user, hash: newHash, salt: newSalt }));
    match = true;
  }
}
if(match){
sessionStorage.setItem(AUTH_SESSION,'true');
$('login-screen').classList.add('hidden');
loginAttempts.count = 0;
init();
}else{
errEl.textContent=t('auth_error')||'Credenciales incorrectas';
$('login-pass').value='';
loginAttempts.count++;
if (loginAttempts.count >= 5) {
  loginAttempts.lockUntil = Date.now() + 5 * 60000;
  loginAttempts.count = 0;
}
}
}
function doLogout(){
sessionStorage.removeItem(AUTH_SESSION);
location.reload();
}
function checkAuth(){
if(isAuthenticated()){
$('login-screen').classList.add('hidden');
return true;
}
$('login-screen').classList.remove('hidden');
// Show first-run setup message
if(isFirstRun()){
const msg=$('login-setup-msg');
if(msg)msg.textContent=t('auth_first_run')||'Primera vez: ingrese usuario y contraseña para crear su cuenta.';
}
$('login-user')?.focus();
return false;
}

// ============ DATA MODEL ============
const DEFAULT_DATA={
farm:{name:'Mi Granja',location:'',capacity:500,currency:'$',lat:null,lng:null,owmApiKey:'',mqttBroker:'',mqttUser:'',mqttPass:'',mqttTopicPrefix:'egglogu/',houses:[],routes:[],suppliers:[]},
flocks:[],dailyProduction:[],vaccines:[],medications:[],outbreaks:[],
feed:{purchases:[],consumption:[]},clients:[],
finances:{income:[],expenses:[],receivables:[]},
inventory:[],
environment:[],checklist:[],logbook:[],personnel:[],
kpiSnapshots:[],weatherCache:[],stressEvents:[],iotReadings:[],predictions:[],
biosecurity:{visitors:[],zones:[],pestSightings:[],protocols:[]},
traceability:{batches:[]},
productionPlans:[],
auditLog:[],
users:[],pendingActivations:[],
settings:{minFeedStock:50,maxMortality:5,alertDaysBefore:3,campoMode:false,vetMode:false,fontScale:'normal',darkMode:false,plan:{tier:'professional',baseCost:99,includedUsers:1,extraUserCost:2.99,billingCycle:'monthly',currency:'USD',startDate:'',upgradedAt:''},ownerEmail:'',
taxRate:0,depreciationYears:5,assetValue:0,
defaultChecklist:['chk_collect_eggs','chk_feed_birds','chk_check_water','chk_check_health','chk_cleaning','chk_record_temp']}
};
// ============ COMMERCIAL BREEDS DATABASE ============
const COMMERCIAL_BREEDS=[
{id:'leghorn-blanca',name:'Leghorn Blanca',eggsYear:'280–320',eggColor:'blanco',eggWeight:'55–60g',type:'hibrida',fcr:'2.0–2.1',notes:'Más usada mundialmente, excelente FCR'},
{id:'isa-brown',name:'ISA Brown',eggsYear:'300–320',eggColor:'marrón',eggWeight:'60–65g',type:'hibrida',fcr:'2.0–2.2',notes:'Híbrida líder global, muy dócil'},
{id:'hyline-w36',name:'Hy-Line W-36',eggsYear:'300–320',eggColor:'blanco',eggWeight:'63g',type:'hibrida',fcr:'2.0–2.1',notes:'Excelente en climas cálidos'},
{id:'hyline-w80',name:'Hy-Line W-80',eggsYear:'290–310',eggColor:'blanco',eggWeight:'60g',type:'hibrida',fcr:'2.1–2.2',notes:'Huevo mediano, alta persistencia'},
{id:'lohmann-brown',name:'Lohmann Brown',eggsYear:'290–310',eggColor:'marrón',eggWeight:'62–65g',type:'hibrida',fcr:'2.1–2.2',notes:'Muy popular en LATAM/Europa'},
{id:'hisex-brown',name:'Hisex Brown',eggsYear:'300–320',eggColor:'marrón',eggWeight:'62g',type:'hibrida',fcr:'2.0–2.2',notes:'Similar a ISA, muy productiva'},
{id:'golden-comet',name:'Golden Comet',eggsYear:'280–300',eggColor:'marrón',eggWeight:'60g',type:'hibrida',fcr:'2.1–2.3',notes:'Híbrida de rápida producción'},
{id:'shaver-white',name:'Shaver White',eggsYear:'280–300',eggColor:'blanco',eggWeight:'60g',type:'hibrida',fcr:'2.1–2.2',notes:'Blanca eficiente, buena en calor'},
{id:'rhode-island-red',name:'Rhode Island Red',eggsYear:'250–300',eggColor:'marrón',eggWeight:'60g',type:'pura',fcr:'2.3–2.5',notes:'Robusta, doble propósito'},
{id:'australorp',name:'Australorp',eggsYear:'250–280',eggColor:'marrón',eggWeight:'60g',type:'pura',fcr:'2.3–2.5',notes:'Resistente, récord histórico 364 huevos/año'},
{id:'sussex',name:'Sussex',eggsYear:'250–280',eggColor:'crema',eggWeight:'58g',type:'pura',fcr:'2.4–2.6',notes:'Buena conversión, adaptable'},
{id:'plymouth-rock',name:'Plymouth Rock',eggsYear:'200–250',eggColor:'marrón',eggWeight:'55g',type:'pura',fcr:'2.5–2.7',notes:'Familiar, huevos constantes'},
{id:'ameraucana',name:'Ameraucana',eggsYear:'200–250',eggColor:'azul',eggWeight:'55g',type:'pura',fcr:'2.5–2.7',notes:'Huevo azul, nicho premium'},
{id:'araucana',name:'Araucana',eggsYear:'180–220',eggColor:'azul-verde',eggWeight:'52g',type:'pura',fcr:'2.6–2.8',notes:'Originaria de Chile, huevo verde-azulado'},
{id:'marans',name:'Marans',eggsYear:'180–220',eggColor:'chocolate',eggWeight:'65g',type:'pura',fcr:'2.5–2.7',notes:'Huevo color chocolate oscuro, nicho gourmet'},
{id:'otra',name:'Otra / Personalizada',eggsYear:'-',eggColor:'-',eggWeight:'-',type:'-',fcr:'-',notes:'Raza no listada, usa curva genérica'}
];
// ============ BREED PRODUCTION CURVES (weekly Hen-Day % from week 18 to 80) ============
const BREED_CURVES={
'leghorn-blanca':[10,36,66,86,94,96,97,97,96,96,95,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43],
'isa-brown':[9,32,62,83,92,94,95,95,94,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43],
'hyline-w36':[10,35,65,85,93,95,96,96,95,95,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42],
'hyline-w80':[9,33,63,84,92,94,95,95,94,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43],
'lohmann-brown':[8,30,60,82,91,94,95,95,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42],
'hisex-brown':[9,31,61,83,92,94,95,95,94,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43],
'golden-comet':[9,30,58,80,90,93,94,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41],
'shaver-white':[9,33,63,84,92,94,94,94,93,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42],
'rhode-island-red':[6,22,48,72,84,88,90,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37],
'australorp':[5,20,45,68,82,86,88,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35],
'sussex':[5,18,42,65,80,84,86,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33],
'plymouth-rock':[4,15,38,60,74,78,80,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27],
'ameraucana':[4,14,36,58,72,76,78,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25],
'araucana':[3,12,32,54,68,72,74,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,21],
'marans':[3,12,32,52,66,70,72,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,21,20,19],
'otra':[8,28,55,78,88,92,93,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40],
'generic':[8,28,55,78,88,92,93,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40]
};
// ============ CATALOGS — "Selecciona, no escribas" ============
const CATALOGS={
feedTypes:[
{id:'inicio',name:'Inicio (0-6 sem)',protein:'20-22%',stage:'cria'},
{id:'crecimiento',name:'Crecimiento (6-12 sem)',protein:'18-19%',stage:'recria'},
{id:'desarrollo',name:'Desarrollo (12-16 sem)',protein:'15-16%',stage:'recria'},
{id:'pre-postura',name:'Pre-postura (16-18 sem)',protein:'17-18%',stage:'recria'},
{id:'postura-1',name:'Postura Fase 1 (18-45 sem)',protein:'17-18%',stage:'produccion'},
{id:'postura-2',name:'Postura Fase 2 (45-65 sem)',protein:'16-17%',stage:'produccion'},
{id:'postura-3',name:'Postura Fase 3 (65+ sem)',protein:'15-16%',stage:'produccion'},
],
deathCauses:['Enfermedad','Depredador','Golpe de calor','Asfixia','Canibalismo','Prolapso','Edad/Natural','Accidente','Desconocida'],
diseases:['Newcastle','Gumboro (IBD)','Bronquitis Infecciosa','Coccidiosis','Marek','Salmonelosis','Coriza Infecciosa','Viruela Aviar','Influenza Aviar','Micoplasmosis','Laringotraqueítis','Colibacilosis','Aspergilosis','Histomoniasis'],
medications:[
{name:'Enrofloxacina',type:'antibiotico',withdrawal:7},
{name:'Amoxicilina',type:'antibiotico',withdrawal:5},
{name:'Toltrazuril',type:'anticoccidial',withdrawal:14},
{name:'Ivermectina',type:'antiparasitario',withdrawal:14},
{name:'Tilosina',type:'antibiotico',withdrawal:5},
{name:'Oxitetraciclina',type:'antibiotico',withdrawal:7},
{name:'Vitamina AD3E',type:'suplemento',withdrawal:0},
{name:'Electrolitos',type:'suplemento',withdrawal:0},
],
personnelRoles:['Administrador','Técnico Avícola','Galponero','Recolector','Veterinario','Chofer/Repartidor','Limpieza','Mantenimiento'],
visitorPurposes:['Entrega de alimento','Servicio técnico','Inspección sanitaria','Retiro de huevos','Visita veterinaria','Mantenimiento','Otro'],
ventilationLevels:['Natural','Baja','Media','Alta','Túnel'],
bioProtocols:['Desinfección de galpón','Pediluvio','Control de roedores','Fumigación','Limpieza de bebederos','Limpieza de comederos','Desratización','Vacío sanitario'],
expenseDescriptions:{
feed:['Alimento postura','Alimento cría','Suplementos','Aditivos'],
vaccines:['Vacuna Newcastle','Vacuna Gumboro','Vacuna Marek','Otra vacuna'],
transport:['Distribución huevos','Retiro alimento','Traslado aves'],
labor:['Sueldos','Horas extra','Bonos'],
infrastructure:['Reparación galpón','Equipamiento','Nidales','Bebederos'],
other:['Servicios básicos','Asesoría','Varios'],
},
};
// ============ CATALOG TRANSLATIONS (WALTZ engine) ============
const CATALOG_T={
en:{
// deathCauses
'Enfermedad':'Disease','Depredador':'Predator','Golpe de calor':'Heat stroke','Asfixia':'Suffocation','Canibalismo':'Cannibalism','Prolapso':'Prolapse','Edad/Natural':'Age/Natural','Accidente':'Accident','Desconocida':'Unknown',
// diseases
'Newcastle':'Newcastle','Gumboro (IBD)':'Gumboro (IBD)','Bronquitis Infecciosa':'Infectious Bronchitis','Coccidiosis':'Coccidiosis','Marek':'Marek','Salmonelosis':'Salmonellosis','Coriza Infecciosa':'Infectious Coryza','Viruela Aviar':'Fowl Pox','Influenza Aviar':'Avian Influenza','Micoplasmosis':'Mycoplasmosis','Laringotraqueítis':'Laryngotracheitis','Colibacilosis':'Colibacillosis','Aspergilosis':'Aspergillosis','Histomoniasis':'Histomoniasis',
// medications
'Enrofloxacina':'Enrofloxacin','Amoxicilina':'Amoxicillin','Toltrazuril':'Toltrazuril','Ivermectina':'Ivermectin','Tilosina':'Tylosin','Oxitetraciclina':'Oxytetracycline','Vitamina AD3E':'Vitamin AD3E','Electrolitos':'Electrolytes',
// personnelRoles
'Administrador':'Administrator','Técnico Avícola':'Poultry Technician','Galponero':'House Keeper','Recolector':'Collector','Veterinario':'Veterinarian','Chofer/Repartidor':'Driver/Delivery','Limpieza':'Cleaning','Mantenimiento':'Maintenance',
// feedTypes
'Inicio (0-6 sem)':'Starter (0-6 wk)','Crecimiento (6-12 sem)':'Grower (6-12 wk)','Desarrollo (12-16 sem)':'Developer (12-16 wk)','Pre-postura (16-18 sem)':'Pre-lay (16-18 wk)','Postura Fase 1 (18-45 sem)':'Layer Phase 1 (18-45 wk)','Postura Fase 2 (45-65 sem)':'Layer Phase 2 (45-65 wk)','Postura Fase 3 (65+ sem)':'Layer Phase 3 (65+ wk)',
// visitorPurposes
'Entrega de alimento':'Feed delivery','Servicio técnico':'Technical service','Inspección sanitaria':'Health inspection','Retiro de huevos':'Egg pickup','Visita veterinaria':'Veterinary visit','Mantenimiento':'Maintenance','Otro':'Other',
// ventilationLevels
'Natural':'Natural','Baja':'Low','Media':'Medium','Alta':'High','Túnel':'Tunnel',
// bioProtocols
'Desinfección de galpón':'House disinfection','Pediluvio':'Footbath','Control de roedores':'Rodent control','Fumigación':'Fumigation','Limpieza de bebederos':'Waterer cleaning','Limpieza de comederos':'Feeder cleaning','Desratización':'Deratization','Vacío sanitario':'Sanitary void',
// expenseDescriptions
'Alimento postura':'Layer feed','Alimento cría':'Starter feed','Suplementos':'Supplements','Aditivos':'Additives','Vacuna Newcastle':'Newcastle vaccine','Vacuna Gumboro':'Gumboro vaccine','Vacuna Marek':'Marek vaccine','Otra vacuna':'Other vaccine','Distribución huevos':'Egg distribution','Retiro alimento':'Feed pickup','Traslado aves':'Bird transfer','Sueldos':'Wages','Horas extra':'Overtime','Bonos':'Bonuses','Reparación galpón':'House repair','Equipamiento':'Equipment','Nidales':'Nest boxes','Bebederos':'Waterers','Servicios básicos':'Utilities','Asesoría':'Consulting','Varios':'Miscellaneous',
// VACCINE_SCHEDULE names
'Newcastle + Bronquitis Infecciosa':'Newcastle + Infectious Bronchitis','Newcastle refuerzo':'Newcastle booster','Viruela Aviar':'Fowl Pox','Encefalomielitis Aviar':'Avian Encephalomyelitis','Coriza Infecciosa':'Infectious Coryza','Salmonella':'Salmonella','Newcastle + BI pre-postura':'Newcastle + IB pre-lay',
// COMMERCIAL_BREEDS notes
'Más usada mundialmente, excelente FCR':'Most used worldwide, excellent FCR','Híbrida líder global, muy dócil':'Global leading hybrid, very docile','Excelente en climas cálidos':'Excellent in warm climates','Huevo mediano, alta persistencia':'Medium egg, high persistence','Muy popular en LATAM/Europa':'Very popular in LATAM/Europe','Similar a ISA, muy productiva':'Similar to ISA, very productive','Híbrida de rápida producción':'Fast production hybrid','Blanca eficiente, buena en calor':'Efficient white, good in heat','Robusta, doble propósito':'Robust, dual purpose','Resistente, récord histórico 364 huevos/año':'Resistant, historic record 364 eggs/year','Buena conversión, adaptable':'Good conversion, adaptable','Familiar, huevos constantes':'Family-friendly, consistent eggs','Huevo azul, nicho premium':'Blue egg, premium niche','Originaria de Chile, huevo verde-azulado':'Native to Chile, blue-green egg','Huevo color chocolate oscuro, nicho gourmet':'Dark chocolate colored egg, gourmet niche','Raza no listada, usa curva genérica':'Unlisted breed, uses generic curve'
},
pt:{
// deathCauses
'Enfermedad':'Doença','Depredador':'Predador','Golpe de calor':'Golpe de calor','Asfixia':'Asfixia','Canibalismo':'Canibalismo','Prolapso':'Prolapso','Edad/Natural':'Idade/Natural','Accidente':'Acidente','Desconocida':'Desconhecida',
// diseases
'Newcastle':'Newcastle','Gumboro (IBD)':'Gumboro (IBD)','Bronquitis Infecciosa':'Bronquite Infecciosa','Coccidiosis':'Coccidiose','Marek':'Marek','Salmonelosis':'Salmonelose','Coriza Infecciosa':'Coriza Infecciosa','Viruela Aviar':'Varíola Aviária','Influenza Aviar':'Influenza Aviária','Micoplasmosis':'Micoplasmose','Laringotraqueítis':'Laringotraqueíte','Colibacilosis':'Colibacilose','Aspergilosis':'Aspergilose','Histomoniasis':'Histomoníase',
// medications
'Enrofloxacina':'Enrofloxacina','Amoxicilina':'Amoxicilina','Toltrazuril':'Toltrazuril','Ivermectina':'Ivermectina','Tilosina':'Tilosina','Oxitetraciclina':'Oxitetraciclina','Vitamina AD3E':'Vitamina AD3E','Electrolitos':'Eletrólitos',
// personnelRoles
'Administrador':'Administrador','Técnico Avícola':'Técnico Avícola','Galponero':'Granjeiro','Recolector':'Coletor','Veterinario':'Veterinário','Chofer/Repartidor':'Motorista/Entregador','Limpieza':'Limpeza','Mantenimiento':'Manutenção',
// feedTypes
'Inicio (0-6 sem)':'Inicial (0-6 sem)','Crecimiento (6-12 sem)':'Crescimento (6-12 sem)','Desarrollo (12-16 sem)':'Desenvolvimento (12-16 sem)','Pre-postura (16-18 sem)':'Pré-postura (16-18 sem)','Postura Fase 1 (18-45 sem)':'Postura Fase 1 (18-45 sem)','Postura Fase 2 (45-65 sem)':'Postura Fase 2 (45-65 sem)','Postura Fase 3 (65+ sem)':'Postura Fase 3 (65+ sem)',
// visitorPurposes
'Entrega de alimento':'Entrega de ração','Servicio técnico':'Serviço técnico','Inspección sanitaria':'Inspeção sanitária','Retiro de huevos':'Retirada de ovos','Visita veterinaria':'Visita veterinária','Mantenimiento':'Manutenção','Otro':'Outro',
// ventilationLevels
'Natural':'Natural','Baja':'Baixa','Media':'Média','Alta':'Alta','Túnel':'Túnel',
// bioProtocols
'Desinfección de galpón':'Desinfecção do galpão','Pediluvio':'Pedilúvio','Control de roedores':'Controle de roedores','Fumigación':'Fumigação','Limpieza de bebederos':'Limpeza de bebedouros','Limpieza de comederos':'Limpeza de comedouros','Desratización':'Desratização','Vacío sanitario':'Vazio sanitário',
// expenseDescriptions
'Alimento postura':'Ração postura','Alimento cría':'Ração inicial','Suplementos':'Suplementos','Aditivos':'Aditivos','Vacuna Newcastle':'Vacina Newcastle','Vacuna Gumboro':'Vacina Gumboro','Vacuna Marek':'Vacina Marek','Otra vacuna':'Outra vacina','Distribución huevos':'Distribuição de ovos','Retiro alimento':'Retirada de ração','Traslado aves':'Transferência de aves','Sueldos':'Salários','Horas extra':'Horas extras','Bonos':'Bônus','Reparación galpón':'Reparo do galpão','Equipamiento':'Equipamentos','Nidales':'Ninhos','Bebederos':'Bebedouros','Servicios básicos':'Serviços básicos','Asesoría':'Consultoria','Varios':'Diversos',
// VACCINE_SCHEDULE names
'Newcastle + Bronquitis Infecciosa':'Newcastle + Bronquite Infecciosa','Newcastle refuerzo':'Newcastle reforço','Viruela Aviar':'Varíola Aviária','Encefalomielitis Aviar':'Encefalomielite Aviária','Coriza Infecciosa':'Coriza Infecciosa','Salmonella':'Salmonella','Newcastle + BI pre-postura':'Newcastle + BI pré-postura',
// COMMERCIAL_BREEDS notes
'Más usada mundialmente, excelente FCR':'Mais usada mundialmente, excelente FCR','Híbrida líder global, muy dócil':'Híbrida líder global, muito dócil','Excelente en climas cálidos':'Excelente em climas quentes','Huevo mediano, alta persistencia':'Ovo médio, alta persistência','Muy popular en LATAM/Europa':'Muito popular na LATAM/Europa','Similar a ISA, muy productiva':'Similar à ISA, muito produtiva','Híbrida de rápida producción':'Híbrida de produção rápida','Blanca eficiente, buena en calor':'Branca eficiente, boa no calor','Robusta, doble propósito':'Robusta, duplo propósito','Resistente, récord histórico 364 huevos/año':'Resistente, recorde histórico 364 ovos/ano','Buena conversión, adaptable':'Boa conversão, adaptável','Familiar, huevos constantes':'Familiar, ovos constantes','Huevo azul, nicho premium':'Ovo azul, nicho premium','Originaria de Chile, huevo verde-azulado':'Originária do Chile, ovo verde-azulado','Huevo color chocolate oscuro, nicho gourmet':'Ovo cor chocolate escuro, nicho gourmet','Raza no listada, usa curva genérica':'Raça não listada, usa curva genérica'
},
fr:{
// deathCauses
'Enfermedad':'Maladie','Depredador':'Prédateur','Golpe de calor':'Coup de chaleur','Asfixia':'Asphyxie','Canibalismo':'Cannibalisme','Prolapso':'Prolapsus','Edad/Natural':'Âge/Naturel','Accidente':'Accident','Desconocida':'Inconnue',
// diseases
'Newcastle':'Newcastle','Gumboro (IBD)':'Gumboro (IBD)','Bronquitis Infecciosa':'Bronchite infectieuse','Coccidiosis':'Coccidiose','Marek':'Marek','Salmonelosis':'Salmonellose','Coriza Infecciosa':'Coryza infectieux','Viruela Aviar':'Variole aviaire','Influenza Aviar':'Influenza aviaire','Micoplasmosis':'Mycoplasmose','Laringotraqueítis':'Laryngotrachéite','Colibacilosis':'Colibacillose','Aspergilosis':'Aspergillose','Histomoniasis':'Histomonose',
// medications
'Enrofloxacina':'Enrofloxacine','Amoxicilina':'Amoxicilline','Toltrazuril':'Toltrazuril','Ivermectina':'Ivermectine','Tilosina':'Tylosine','Oxitetraciclina':'Oxytétracycline','Vitamina AD3E':'Vitamine AD3E','Electrolitos':'Électrolytes',
// personnelRoles
'Administrador':'Administrateur','Técnico Avícola':'Technicien avicole','Galponero':'Gardien de poulailler','Recolector':'Collecteur','Veterinario':'Vétérinaire','Chofer/Repartidor':'Chauffeur/Livreur','Limpieza':'Nettoyage','Mantenimiento':'Maintenance',
// feedTypes
'Inicio (0-6 sem)':'Démarrage (0-6 sem)','Crecimiento (6-12 sem)':'Croissance (6-12 sem)','Desarrollo (12-16 sem)':'Développement (12-16 sem)','Pre-postura (16-18 sem)':'Pré-ponte (16-18 sem)','Postura Fase 1 (18-45 sem)':'Ponte Phase 1 (18-45 sem)','Postura Fase 2 (45-65 sem)':'Ponte Phase 2 (45-65 sem)','Postura Fase 3 (65+ sem)':'Ponte Phase 3 (65+ sem)',
// visitorPurposes
'Entrega de alimento':'Livraison aliment','Servicio técnico':'Service technique','Inspección sanitaria':'Inspection sanitaire','Retiro de huevos':'Collecte des œufs','Visita veterinaria':'Visite vétérinaire','Mantenimiento':'Maintenance','Otro':'Autre',
// ventilationLevels
'Natural':'Naturelle','Baja':'Faible','Media':'Moyenne','Alta':'Forte','Túnel':'Tunnel',
// bioProtocols
'Desinfección de galpón':'Désinfection du poulailler','Pediluvio':'Pédiluve','Control de roedores':'Contrôle des rongeurs','Fumigación':'Fumigation','Limpieza de bebederos':'Nettoyage abreuvoirs','Limpieza de comederos':'Nettoyage mangeoires','Desratización':'Dératisation','Vacío sanitario':'Vide sanitaire',
// expenseDescriptions
'Alimento postura':'Aliment ponte','Alimento cría':'Aliment démarrage','Suplementos':'Suppléments','Aditivos':'Additifs','Vacuna Newcastle':'Vaccin Newcastle','Vacuna Gumboro':'Vaccin Gumboro','Vacuna Marek':'Vaccin Marek','Otra vacuna':'Autre vaccin','Distribución huevos':'Distribution œufs','Retiro alimento':'Retrait aliment','Traslado aves':'Transfert volailles','Sueldos':'Salaires','Horas extra':'Heures sup.','Bonos':'Primes','Reparación galpón':'Réparation poulailler','Equipamiento':'Équipement','Nidales':'Pondoirs','Bebederos':'Abreuvoirs','Servicios básicos':'Services publics','Asesoría':'Conseil','Varios':'Divers',
// VACCINE_SCHEDULE names
'Newcastle + Bronquitis Infecciosa':'Newcastle + Bronchite infectieuse','Newcastle refuerzo':'Newcastle rappel','Viruela Aviar':'Variole aviaire','Encefalomielitis Aviar':'Encéphalomyélite aviaire','Coriza Infecciosa':'Coryza infectieux','Salmonella':'Salmonelle','Newcastle + BI pre-postura':'Newcastle + BI pré-ponte',
// COMMERCIAL_BREEDS notes
'Más usada mundialmente, excelente FCR':'Plus utilisée mondialement, excellent FCR','Híbrida líder global, muy dócil':'Hybride leader mondial, très docile','Excelente en climas cálidos':'Excellente en climats chauds','Huevo mediano, alta persistencia':'Œuf moyen, haute persistance','Muy popular en LATAM/Europa':'Très populaire en LATAM/Europe','Similar a ISA, muy productiva':'Similaire à ISA, très productive','Híbrida de rápida producción':'Hybride à production rapide','Blanca eficiente, buena en calor':'Blanche efficace, bonne en chaleur','Robusta, doble propósito':'Robuste, double usage','Resistente, récord histórico 364 huevos/año':'Résistante, record historique 364 œufs/an','Buena conversión, adaptable':'Bonne conversion, adaptable','Familiar, huevos constantes':'Familiale, œufs constants','Huevo azul, nicho premium':'Œuf bleu, niche premium','Originaria de Chile, huevo verde-azulado':'Originaire du Chili, œuf bleu-vert','Huevo color chocolate oscuro, nicho gourmet':'Œuf chocolat foncé, niche gourmet','Raza no listada, usa curva genérica':'Race non listée, courbe générique'
},
de:{
// deathCauses
'Enfermedad':'Krankheit','Depredador':'Raubtier','Golpe de calor':'Hitzschlag','Asfixia':'Erstickung','Canibalismo':'Kannibalismus','Prolapso':'Prolaps','Edad/Natural':'Alter/Natürlich','Accidente':'Unfall','Desconocida':'Unbekannt',
// diseases
'Newcastle':'Newcastle','Gumboro (IBD)':'Gumboro (IBD)','Bronquitis Infecciosa':'Infektiöse Bronchitis','Coccidiosis':'Kokzidiose','Marek':'Marek','Salmonelosis':'Salmonellose','Coriza Infecciosa':'Infektiöser Schnupfen','Viruela Aviar':'Geflügelpocken','Influenza Aviar':'Geflügelgrippe','Micoplasmosis':'Mykoplasmose','Laringotraqueítis':'Laryngotracheitis','Colibacilosis':'Kolibazillose','Aspergilosis':'Aspergillose','Histomoniasis':'Histomonose',
// medications
'Enrofloxacina':'Enrofloxacin','Amoxicilina':'Amoxicillin','Toltrazuril':'Toltrazuril','Ivermectina':'Ivermectin','Tilosina':'Tylosin','Oxitetraciclina':'Oxytetracyclin','Vitamina AD3E':'Vitamin AD3E','Electrolitos':'Elektrolyte',
// personnelRoles
'Administrador':'Verwalter','Técnico Avícola':'Geflügeltechniker','Galponero':'Stallwart','Recolector':'Sammler','Veterinario':'Tierarzt','Chofer/Repartidor':'Fahrer/Lieferant','Limpieza':'Reinigung','Mantenimiento':'Wartung',
// feedTypes
'Inicio (0-6 sem)':'Starter (0-6 Wo)','Crecimiento (6-12 sem)':'Wachstum (6-12 Wo)','Desarrollo (12-16 sem)':'Entwicklung (12-16 Wo)','Pre-postura (16-18 sem)':'Vorlegephase (16-18 Wo)','Postura Fase 1 (18-45 sem)':'Legephase 1 (18-45 Wo)','Postura Fase 2 (45-65 sem)':'Legephase 2 (45-65 Wo)','Postura Fase 3 (65+ sem)':'Legephase 3 (65+ Wo)',
// visitorPurposes
'Entrega de alimento':'Futterlieferung','Servicio técnico':'Technischer Service','Inspección sanitaria':'Gesundheitskontrolle','Retiro de huevos':'Eiersammlung','Visita veterinaria':'Tierarztbesuch','Mantenimiento':'Wartung','Otro':'Andere',
// ventilationLevels
'Natural':'Natürlich','Baja':'Niedrig','Media':'Mittel','Alta':'Hoch','Túnel':'Tunnel',
// bioProtocols
'Desinfección de galpón':'Stalldesinfektion','Pediluvio':'Klauenbad','Control de roedores':'Nagetierbekämpfung','Fumigación':'Begasung','Limpieza de bebederos':'Tränkenreinigung','Limpieza de comederos':'Futtertrogreinigung','Desratización':'Rattenbekämpfung','Vacío sanitario':'Hygienepause',
// expenseDescriptions
'Alimento postura':'Legefutter','Alimento cría':'Aufzuchtfutter','Suplementos':'Ergänzungen','Aditivos':'Zusätze','Vacuna Newcastle':'Newcastle-Impfstoff','Vacuna Gumboro':'Gumboro-Impfstoff','Vacuna Marek':'Marek-Impfstoff','Otra vacuna':'Anderer Impfstoff','Distribución huevos':'Eierverteilung','Retiro alimento':'Futterabholung','Traslado aves':'Geflügeltransport','Sueldos':'Gehälter','Horas extra':'Überstunden','Bonos':'Boni','Reparación galpón':'Stallreparatur','Equipamiento':'Ausrüstung','Nidales':'Legenester','Bebederos':'Tränken','Servicios básicos':'Grundversorgung','Asesoría':'Beratung','Varios':'Sonstiges',
// VACCINE_SCHEDULE names
'Newcastle + Bronquitis Infecciosa':'Newcastle + Infektiöse Bronchitis','Newcastle refuerzo':'Newcastle Auffrischung','Viruela Aviar':'Geflügelpocken','Encefalomielitis Aviar':'Aviäre Enzephalomyelitis','Coriza Infecciosa':'Infektiöser Schnupfen','Salmonella':'Salmonelle','Newcastle + BI pre-postura':'Newcastle + IB Vorlegephase',
// COMMERCIAL_BREEDS notes
'Más usada mundialmente, excelente FCR':'Weltweit am meisten genutzt, exzellenter FCR','Híbrida líder global, muy dócil':'Weltweit führende Hybride, sehr zahm','Excelente en climas cálidos':'Hervorragend in warmen Klimazonen','Huevo mediano, alta persistencia':'Mittleres Ei, hohe Persistenz','Muy popular en LATAM/Europa':'Sehr beliebt in LATAM/Europa','Similar a ISA, muy productiva':'Ähnlich wie ISA, sehr produktiv','Híbrida de rápida producción':'Schnelle Produktionshybride','Blanca eficiente, buena en calor':'Effiziente Weiße, gut bei Hitze','Robusta, doble propósito':'Robust, Zweinutzung','Resistente, récord histórico 364 huevos/año':'Widerstandsfähig, historischer Rekord 364 Eier/Jahr','Buena conversión, adaptable':'Gute Verwertung, anpassungsfähig','Familiar, huevos constantes':'Familienfreundlich, konstante Eier','Huevo azul, nicho premium':'Blaues Ei, Premium-Nische','Originaria de Chile, huevo verde-azulado':'Aus Chile, blaugrünes Ei','Huevo color chocolate oscuro, nicho gourmet':'Dunkelschokoladenfarbenes Ei, Gourmet-Nische','Raza no listada, usa curva genérica':'Nicht gelistete Rasse, generische Kurve'
},
it:{
// deathCauses
'Enfermedad':'Malattia','Depredador':'Predatore','Golpe de calor':'Colpo di calore','Asfixia':'Asfissia','Canibalismo':'Cannibalismo','Prolapso':'Prolasso','Edad/Natural':'Età/Naturale','Accidente':'Incidente','Desconocida':'Sconosciuta',
// diseases
'Newcastle':'Newcastle','Gumboro (IBD)':'Gumboro (IBD)','Bronquitis Infecciosa':'Bronchite infettiva','Coccidiosis':'Coccidiosi','Marek':'Marek','Salmonelosis':'Salmonellosi','Coriza Infecciosa':'Corizza infettiva','Viruela Aviar':'Vaiolo aviare','Influenza Aviar':'Influenza aviaria','Micoplasmosis':'Micoplasmosi','Laringotraqueítis':'Laringotracheite','Colibacilosis':'Colibacillosi','Aspergilosis':'Aspergillosi','Histomoniasis':'Istomonosi',
// medications
'Enrofloxacina':'Enrofloxacina','Amoxicilina':'Amoxicillina','Toltrazuril':'Toltrazuril','Ivermectina':'Ivermectina','Tilosina':'Tilosina','Oxitetraciclina':'Ossitetraciclina','Vitamina AD3E':'Vitamina AD3E','Electrolitos':'Elettroliti',
// personnelRoles
'Administrador':'Amministratore','Técnico Avícola':'Tecnico avicolo','Galponero':'Addetto pollaio','Recolector':'Raccoglitore','Veterinario':'Veterinario','Chofer/Repartidor':'Autista/Fattorino','Limpieza':'Pulizia','Mantenimiento':'Manutenzione',
// feedTypes
'Inicio (0-6 sem)':'Avviamento (0-6 sett)','Crecimiento (6-12 sem)':'Crescita (6-12 sett)','Desarrollo (12-16 sem)':'Sviluppo (12-16 sett)','Pre-postura (16-18 sem)':'Pre-deposizione (16-18 sett)','Postura Fase 1 (18-45 sem)':'Deposizione Fase 1 (18-45 sett)','Postura Fase 2 (45-65 sem)':'Deposizione Fase 2 (45-65 sett)','Postura Fase 3 (65+ sem)':'Deposizione Fase 3 (65+ sett)',
// visitorPurposes
'Entrega de alimento':'Consegna mangime','Servicio técnico':'Servizio tecnico','Inspección sanitaria':'Ispezione sanitaria','Retiro de huevos':'Ritiro uova','Visita veterinaria':'Visita veterinaria','Mantenimiento':'Manutenzione','Otro':'Altro',
// ventilationLevels
'Natural':'Naturale','Baja':'Bassa','Media':'Media','Alta':'Alta','Túnel':'Tunnel',
// bioProtocols
'Desinfección de galpón':'Disinfezione pollaio','Pediluvio':'Pediluvio','Control de roedores':'Controllo roditori','Fumigación':'Fumigazione','Limpieza de bebederos':'Pulizia abbeveratoi','Limpieza de comederos':'Pulizia mangiatoie','Desratización':'Derattizzazione','Vacío sanitario':'Vuoto sanitario',
// expenseDescriptions
'Alimento postura':'Mangime ovaiole','Alimento cría':'Mangime avviamento','Suplementos':'Integratori','Aditivos':'Additivi','Vacuna Newcastle':'Vaccino Newcastle','Vacuna Gumboro':'Vaccino Gumboro','Vacuna Marek':'Vaccino Marek','Otra vacuna':'Altro vaccino','Distribución huevos':'Distribuzione uova','Retiro alimento':'Ritiro mangime','Traslado aves':'Trasferimento volatili','Sueldos':'Stipendi','Horas extra':'Straordinari','Bonos':'Bonus','Reparación galpón':'Riparazione pollaio','Equipamiento':'Attrezzature','Nidales':'Nidi','Bebederos':'Abbeveratoi','Servicios básicos':'Utenze','Asesoría':'Consulenza','Varios':'Vari',
// VACCINE_SCHEDULE names
'Newcastle + Bronquitis Infecciosa':'Newcastle + Bronchite infettiva','Newcastle refuerzo':'Newcastle richiamo','Viruela Aviar':'Vaiolo aviare','Encefalomielitis Aviar':'Encefalomielite aviaria','Coriza Infecciosa':'Corizza infettiva','Salmonella':'Salmonella','Newcastle + BI pre-postura':'Newcastle + BI pre-deposizione',
// COMMERCIAL_BREEDS notes
'Más usada mundialmente, excelente FCR':'Più usata al mondo, eccellente FCR','Híbrida líder global, muy dócil':'Ibrida leader globale, molto docile','Excelente en climas cálidos':'Eccellente nei climi caldi','Huevo mediano, alta persistencia':'Uovo medio, alta persistenza','Muy popular en LATAM/Europa':'Molto popolare in LATAM/Europa','Similar a ISA, muy productiva':'Simile a ISA, molto produttiva','Híbrida de rápida producción':'Ibrida a produzione rapida','Blanca eficiente, buena en calor':'Bianca efficiente, buona al caldo','Robusta, doble propósito':'Robusta, duplice attitudine','Resistente, récord histórico 364 huevos/año':'Resistente, record storico 364 uova/anno','Buena conversión, adaptable':'Buona conversione, adattabile','Familiar, huevos constantes':'Familiare, uova costanti','Huevo azul, nicho premium':'Uovo blu, nicchia premium','Originaria de Chile, huevo verde-azulado':'Originaria del Cile, uovo verde-azzurro','Huevo color chocolate oscuro, nicho gourmet':'Uovo cioccolato scuro, nicchia gourmet','Raza no listada, usa curva genérica':'Razza non elencata, curva generica'
},
ja:{
// deathCauses
'Enfermedad':'疾病','Depredador':'捕食者','Golpe de calor':'熱中症','Asfixia':'窒息','Canibalismo':'共食い','Prolapso':'脱肛','Edad/Natural':'老齢/自然死','Accidente':'事故','Desconocida':'不明',
// diseases
'Newcastle':'ニューカッスル','Gumboro (IBD)':'ガンボロ (IBD)','Bronquitis Infecciosa':'伝染性気管支炎','Coccidiosis':'コクシジウム症','Marek':'マレック','Salmonelosis':'サルモネラ症','Coriza Infecciosa':'伝染性コリーザ','Viruela Aviar':'鶏痘','Influenza Aviar':'鳥インフルエンザ','Micoplasmosis':'マイコプラズマ症','Laringotraqueítis':'伝染性喉頭気管炎','Colibacilosis':'大腸菌症','Aspergilosis':'アスペルギルス症','Histomoniasis':'ヒストモナス症',
// medications
'Enrofloxacina':'エンロフロキサシン','Amoxicilina':'アモキシシリン','Toltrazuril':'トルトラズリル','Ivermectina':'イベルメクチン','Tilosina':'タイロシン','Oxitetraciclina':'オキシテトラサイクリン','Vitamina AD3E':'ビタミンAD3E','Electrolitos':'電解質',
// personnelRoles
'Administrador':'管理者','Técnico Avícola':'養鶏技術者','Galponero':'鶏舎管理者','Recolector':'集卵者','Veterinario':'獣医師','Chofer/Repartidor':'運転手/配達員','Limpieza':'清掃','Mantenimiento':'保守',
// feedTypes
'Inicio (0-6 sem)':'スターター (0-6週)','Crecimiento (6-12 sem)':'成長期 (6-12週)','Desarrollo (12-16 sem)':'育成期 (12-16週)','Pre-postura (16-18 sem)':'産卵前期 (16-18週)','Postura Fase 1 (18-45 sem)':'産卵期1 (18-45週)','Postura Fase 2 (45-65 sem)':'産卵期2 (45-65週)','Postura Fase 3 (65+ sem)':'産卵期3 (65週以上)',
// visitorPurposes
'Entrega de alimento':'飼料配達','Servicio técnico':'技術サービス','Inspección sanitaria':'衛生検査','Retiro de huevos':'集卵','Visita veterinaria':'獣医訪問','Mantenimiento':'保守','Otro':'その他',
// ventilationLevels
'Natural':'自然','Baja':'低','Media':'中','Alta':'高','Túnel':'トンネル',
// bioProtocols
'Desinfección de galpón':'鶏舎消毒','Pediluvio':'踏込消毒槽','Control de roedores':'ネズミ駆除','Fumigación':'燻蒸消毒','Limpieza de bebederos':'給水器清掃','Limpieza de comederos':'給餌器清掃','Desratización':'駆鼠','Vacío sanitario':'衛生空白期間',
// expenseDescriptions
'Alimento postura':'産卵飼料','Alimento cría':'育雛飼料','Suplementos':'サプリメント','Aditivos':'添加物','Vacuna Newcastle':'ニューカッスルワクチン','Vacuna Gumboro':'ガンボロワクチン','Vacuna Marek':'マレックワクチン','Otra vacuna':'その他ワクチン','Distribución huevos':'鶏卵配送','Retiro alimento':'飼料回収','Traslado aves':'家禽移送','Sueldos':'給与','Horas extra':'残業代','Bonos':'賞与','Reparación galpón':'鶏舎修繕','Equipamiento':'設備','Nidales':'産卵箱','Bebederos':'給水器','Servicios básicos':'光熱費','Asesoría':'コンサルティング','Varios':'雑費',
// VACCINE_SCHEDULE names
'Newcastle + Bronquitis Infecciosa':'ニューカッスル + 伝染性気管支炎','Newcastle refuerzo':'ニューカッスル追加接種','Viruela Aviar':'鶏痘','Encefalomielitis Aviar':'鶏脳脊髄炎','Coriza Infecciosa':'伝染性コリーザ','Salmonella':'サルモネラ','Newcastle + BI pre-postura':'ニューカッスル + BI 産卵前',
// COMMERCIAL_BREEDS notes
'Más usada mundialmente, excelente FCR':'世界で最も使用、優れたFCR','Híbrida líder global, muy dócil':'世界的リーダーのハイブリッド、非常に温順','Excelente en climas cálidos':'暖かい気候に最適','Huevo mediano, alta persistencia':'中卵、高い持続性','Muy popular en LATAM/Europa':'中南米/ヨーロッパで非常に人気','Similar a ISA, muy productiva':'ISAに類似、非常に生産的','Híbrida de rápida producción':'高速生産ハイブリッド','Blanca eficiente, buena en calor':'効率的な白色種、暑さに強い','Robusta, doble propósito':'丈夫、兼用種','Resistente, récord histórico 364 huevos/año':'強健、歴史的記録364卵/年','Buena conversión, adaptable':'良い飼料効率、適応性あり','Familiar, huevos constantes':'家庭向き、安定した産卵','Huevo azul, nicho premium':'青い卵、プレミアムニッチ','Originaria de Chile, huevo verde-azulado':'チリ原産、青緑の卵','Huevo color chocolate oscuro, nicho gourmet':'ダークチョコレート色の卵、グルメニッチ','Raza no listada, usa curva genérica':'未登録品種、一般曲線使用'
},
zh:{
// deathCauses
'Enfermedad':'疾病','Depredador':'捕食者','Golpe de calor':'中暑','Asfixia':'窒息','Canibalismo':'啄食癖','Prolapso':'脱肛','Edad/Natural':'老龄/自然死亡','Accidente':'事故','Desconocida':'不明',
// diseases
'Newcastle':'新城疫','Gumboro (IBD)':'法氏囊病 (IBD)','Bronquitis Infecciosa':'传染性支气管炎','Coccidiosis':'球虫病','Marek':'马立克','Salmonelosis':'沙门氏菌病','Coriza Infecciosa':'传染性鼻炎','Viruela Aviar':'禽痘','Influenza Aviar':'禽流感','Micoplasmosis':'支原体病','Laringotraqueítis':'传染性喉气管炎','Colibacilosis':'大肠杆菌病','Aspergilosis':'曲霉菌病','Histomoniasis':'组织滴虫病',
// medications
'Enrofloxacina':'恩诺沙星','Amoxicilina':'阿莫西林','Toltrazuril':'妥曲珠利','Ivermectina':'伊维菌素','Tilosina':'泰乐菌素','Oxitetraciclina':'土霉素','Vitamina AD3E':'维生素AD3E','Electrolitos':'电解质',
// personnelRoles
'Administrador':'管理员','Técnico Avícola':'家禽技术员','Galponero':'鸡舍管理员','Recolector':'收蛋员','Veterinario':'兽医','Chofer/Repartidor':'司机/配送员','Limpieza':'清洁','Mantenimiento':'维护',
// feedTypes
'Inicio (0-6 sem)':'开食料 (0-6周)','Crecimiento (6-12 sem)':'生长料 (6-12周)','Desarrollo (12-16 sem)':'育成料 (12-16周)','Pre-postura (16-18 sem)':'预产料 (16-18周)','Postura Fase 1 (18-45 sem)':'产蛋期1 (18-45周)','Postura Fase 2 (45-65 sem)':'产蛋期2 (45-65周)','Postura Fase 3 (65+ sem)':'产蛋期3 (65周以上)',
// visitorPurposes
'Entrega de alimento':'饲料配送','Servicio técnico':'技术服务','Inspección sanitaria':'卫生检查','Retiro de huevos':'收蛋','Visita veterinaria':'兽医访问','Mantenimiento':'维护','Otro':'其他',
// ventilationLevels
'Natural':'自然','Baja':'低','Media':'中','Alta':'高','Túnel':'隧道式',
// bioProtocols
'Desinfección de galpón':'鸡舍消毒','Pediluvio':'脚踏消毒池','Control de roedores':'灭鼠','Fumigación':'熏蒸消毒','Limpieza de bebederos':'饮水器清洁','Limpieza de comederos':'料槽清洁','Desratización':'灭鼠处理','Vacío sanitario':'空舍期',
// expenseDescriptions
'Alimento postura':'产蛋饲料','Alimento cría':'育雏饲料','Suplementos':'补充剂','Aditivos':'添加剂','Vacuna Newcastle':'新城疫疫苗','Vacuna Gumboro':'法氏囊疫苗','Vacuna Marek':'马立克疫苗','Otra vacuna':'其他疫苗','Distribución huevos':'鸡蛋配送','Retiro alimento':'饲料回收','Traslado aves':'家禽转运','Sueldos':'工资','Horas extra':'加班费','Bonos':'奖金','Reparación galpón':'鸡舍维修','Equipamiento':'设备','Nidales':'产蛋箱','Bebederos':'饮水器','Servicios básicos':'水电费','Asesoría':'咨询','Varios':'杂项',
// VACCINE_SCHEDULE names
'Newcastle + Bronquitis Infecciosa':'新城疫 + 传染性支气管炎','Newcastle refuerzo':'新城疫加强','Viruela Aviar':'禽痘','Encefalomielitis Aviar':'禽脑脊髓炎','Coriza Infecciosa':'传染性鼻炎','Salmonella':'沙门氏菌','Newcastle + BI pre-postura':'新城疫 + 传支 产前',
// COMMERCIAL_BREEDS notes
'Más usada mundialmente, excelente FCR':'全球使用最广，优秀FCR','Híbrida líder global, muy dócil':'全球领先杂交品种，非常温顺','Excelente en climas cálidos':'适合炎热气候','Huevo mediano, alta persistencia':'中等蛋重，高持续性','Muy popular en LATAM/Europa':'在拉美/欧洲非常流行','Similar a ISA, muy productiva':'类似ISA，生产力强','Híbrida de rápida producción':'快速生产杂交种','Blanca eficiente, buena en calor':'高效白壳种，耐热','Robusta, doble propósito':'强健，兼用型','Resistente, récord histórico 364 huevos/año':'抗病力强，历史记录364蛋/年','Buena conversión, adaptable':'饲料转化好，适应性强','Familiar, huevos constantes':'家庭适用，产蛋稳定','Huevo azul, nicho premium':'蓝壳蛋，高端市场','Originaria de Chile, huevo verde-azulado':'原产智利，蓝绿壳蛋','Huevo color chocolate oscuro, nicho gourmet':'深巧克力色蛋，美食市场','Raza no listada, usa curva genérica':'未列出品种，使用通用曲线'
}
};
function tc(str){if(LANG==='es'||!CATALOG_T[LANG])return str;return CATALOG_T[LANG][str]||str;}
// ============ LOCALE MAP (WALTZ engine) ============
const LOCALE_MAP={es:'es-CL',en:'en-US',pt:'pt-BR',fr:'fr-FR',de:'de-DE',it:'it-IT',ja:'ja-JP',zh:'zh-CN',ko:'ko-KR',ar:'ar-SA',hi:'hi-IN',ru:'ru-RU'};
function locale(){return LOCALE_MAP[LANG]||'en-US';}
// ============ CATALOG HELPERS ============
function supplierSelect(sel){const D=loadData();const sups=D.farm.suppliers||[];let h='<option value="">--</option>';sups.forEach(s=>{h+=`<option value="${escapeAttr(s.name)}"${s.name===sel?' selected':''}>${sanitizeHTML(s.name)}</option>`;});h+='<option value="__new__">+ Nuevo proveedor</option>';return h;}
function houseSelect(sel){const D=loadData();const houses=D.farm.houses||[];let h='<option value="">--</option>';houses.forEach(ho=>{h+=`<option value="${escapeAttr(ho.name)}"${ho.name===sel?' selected':''}>${sanitizeHTML(ho.name)}</option>`;});return h;}
function rackSelect(houseName,sel){const D=loadData();const houses=D.farm.houses||[];const house=houses.find(h=>h.name===houseName);let h='<option value="">--</option>';if(house&&house.racks){house.racks.forEach(r=>{h+=`<option value="${escapeAttr(r.name)}"${r.name===sel?' selected':''}>${sanitizeHTML(r.name)}</option>`;});}return h;}
function routeSelect(sel){const D=loadData();const routes=D.farm.routes||[];let h='<option value="">--</option>';routes.forEach(r=>{h+=`<option value="${escapeAttr(r.name)}"${r.name===sel?' selected':''}>${sanitizeHTML(r.name)}</option>`;});return h;}
function catalogSelect(items,sel,addOther=true){let h='<option value="">--</option>';items.forEach(item=>{const v=typeof item==='string'?item:item.name||item.id;const lbl=typeof item==='string'?item:item.name;h+=`<option value="${escapeAttr(v)}"${v===sel?' selected':''}>${sanitizeHTML(tc(lbl))}</option>`;});if(addOther)h+='<option value="__other__">Otra...</option>';return h;}
function feedTypeSelect(sel,flockId){const D=loadData();let suggested='';if(flockId){const f=D.flocks.find(x=>x.id===flockId);if(f){const stage=flockLifecycleStage(f);if(stage)suggested=stage.id;}}let h='<option value="">--</option>';CATALOGS.feedTypes.forEach(ft=>{const isSuggested=ft.stage===suggested;h+=`<option value="${ft.id}"${ft.id===sel?' selected':''}>${tc(ft.name)}${isSuggested?' ★':''}</option>`;});h+='<option value="__other__">Otro...</option>';return h;}
function onMedSelect(){const sel=$('m-name');if(!sel)return;const med=CATALOGS.medications.find(m=>m.name===sel.value);const wd=$('m-wd');if(med&&wd&&!wd.value)wd.value=med.withdrawal;}
function onExpenseCatChange(){const cat=$('fe-cat')?.value;const descEl=$('fe-desc');if(!descEl||!cat)return;const opts=CATALOGS.expenseDescriptions[cat]||[];descEl.innerHTML=catalogSelect(opts,descEl.value,true);}
function onHouseChange(){const house=$('tb-house')?.value;const rackEl=$('tb-rack');if(!rackEl)return;rackEl.innerHTML=rackSelect(house,rackEl.value);}
function onProdFlockChange(){const fid=$('p-flock')?.value;const shellEl=$('p-shell');if(!fid||!shellEl)return;const D=loadData();const f=D.flocks.find(x=>x.id===fid);if(f){const b=COMMERCIAL_BREEDS.find(x=>x.id===f.breed);if(b&&b.eggColor){const colorMap={'Blanco':'blanco','Marrón':'marron','Marrón oscuro':'marron','Crema':'crema','Azul/Verde':'crema','Verde oliva':'crema'};shellEl.value=colorMap[b.eggColor]||'';}}}
function loadData(){
if(DATA)return DATA;
try{const r=localStorage.getItem('egglogu_data');
if(r){DATA=JSON.parse(r);
for(const k of Object.keys(DEFAULT_DATA)){if(!(k in DATA))DATA[k]=JSON.parse(JSON.stringify(DEFAULT_DATA[k]));}
if(!DATA.feed.purchases)DATA.feed.purchases=[];if(!DATA.feed.consumption)DATA.feed.consumption=[];
if(!DATA.finances.receivables)DATA.finances.receivables=[];
['medications','outbreaks','clients','checklist','logbook','personnel','kpiSnapshots','weatherCache','stressEvents','iotReadings','predictions'].forEach(k=>{if(!DATA[k])DATA[k]=[];});
// v2 farm field migrations
if(DATA.farm.lat===undefined)DATA.farm.lat=null;
if(DATA.farm.lng===undefined)DATA.farm.lng=null;
if(!DATA.farm.owmApiKey)DATA.farm.owmApiKey='';
if(!DATA.farm.mqttBroker)DATA.farm.mqttBroker='';
if(!DATA.farm.mqttUser)DATA.farm.mqttUser='';
if(!DATA.farm.mqttPass)DATA.farm.mqttPass='';
if(!DATA.farm.mqttTopicPrefix)DATA.farm.mqttTopicPrefix='egglogu/';
// v4 migrations — farm config expansion
if(!DATA.farm.houses)DATA.farm.houses=[];
if(!DATA.farm.routes)DATA.farm.routes=[];
if(!DATA.farm.suppliers)DATA.farm.suppliers=[];
// v3 migrations
if(!DATA.biosecurity)DATA.biosecurity={visitors:[],zones:[],pestSightings:[],protocols:[]};
if(!DATA.biosecurity.visitors)DATA.biosecurity.visitors=[];
if(!DATA.biosecurity.zones)DATA.biosecurity.zones=[];
if(!DATA.biosecurity.pestSightings)DATA.biosecurity.pestSightings=[];
if(!DATA.biosecurity.protocols)DATA.biosecurity.protocols=[];
if(!DATA.traceability)DATA.traceability={batches:[]};
if(!DATA.traceability.batches)DATA.traceability.batches=[];
if(!DATA.productionPlans)DATA.productionPlans=[];
if(!DATA.inventory)DATA.inventory=[];
if(!DATA.auditLog)DATA.auditLog=[];
if(!DATA.users)DATA.users=[];
if(DATA.settings.taxRate===undefined)DATA.settings.taxRate=0;
if(DATA.settings.depreciationYears===undefined)DATA.settings.depreciationYears=5;
if(DATA.settings.assetValue===undefined)DATA.settings.assetValue=0;
if(DATA.settings.campoMode===undefined)DATA.settings.campoMode=false;
if(DATA.settings.vetMode===undefined)DATA.settings.vetMode=false;
if(!DATA.settings.fontScale)DATA.settings.fontScale='normal';
if(DATA.settings.darkMode===undefined)DATA.settings.darkMode=false;
}else{DATA=JSON.parse(JSON.stringify(DEFAULT_DATA));}
}catch(e){DATA=JSON.parse(JSON.stringify(DEFAULT_DATA));}
return DATA;
}
function saveData(d){DATA=d||DATA;localStorage.setItem('egglogu_data',JSON.stringify(DATA));scheduleAutoBackup();}

// ============ PAGINATION SYSTEM (A4) ============
const PAGE_SIZE=50;
const _pageState={};
function paginate(arr,page,size){size=size||PAGE_SIZE;const totalPages=Math.max(1,Math.ceil(arr.length/size));const p=Math.max(1,Math.min(page||1,totalPages));return{items:arr.slice((p-1)*size,p*size),totalPages,page:p,total:arr.length};}
function paginationControls(stateKey,currentPage,totalPages,callback){
if(totalPages<=1)return '';
let h='<div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-top:12px;flex-wrap:wrap">';
h+=`<button class="btn btn-sm btn-secondary" onclick="_pageState['${stateKey}']=${Math.max(1,currentPage-1)};${callback}()" ${currentPage<=1?'disabled':''}>◀</button>`;
const start=Math.max(1,currentPage-2);const end=Math.min(totalPages,currentPage+2);
for(let i=start;i<=end;i++){h+=`<button class="btn btn-sm ${i===currentPage?'btn-primary':'btn-secondary'}" onclick="_pageState['${stateKey}']=${i};${callback}()">${i}</button>`;}
h+=`<button class="btn btn-sm btn-secondary" onclick="_pageState['${stateKey}']=${Math.min(totalPages,currentPage+1)};${callback}()" ${currentPage>=totalPages?'disabled':''}>▶</button>`;
h+=`<span style="color:var(--text-light);font-size:13px;margin-left:8px">${currentPage}/${totalPages}</span></div>`;
return h;
}

// ============ VENG — VALIDATION ENGINES (Zero Tolerance) ============
let _vengWarningsShown=false;
const VENG={
// --- GATE: Input Gate Processor ---
gate:{
production(o,D){
const e=[],w=[];const hens=activeHensByFlock(o.flockId);
if(o.date>todayStr())e.push({field:'p-date',msg:'Future date not allowed'});
if(hens>0&&o.eggsCollected>hens)e.push({field:'p-eggs',msg:'Eggs ('+o.eggsCollected+') exceed active hens ('+hens+')'});
if(o.eggsBroken>o.eggsCollected)e.push({field:'p-broken',msg:'Broken eggs ('+o.eggsBroken+') exceed collected ('+o.eggsCollected+')'});
const sizeSum=(o.eggsS||0)+(o.eggsM||0)+(o.eggsL||0)+(o.eggsXL||0)+(o.eggsJumbo||0);
if(sizeSum>0&&sizeSum>o.eggsCollected)e.push({field:'p-s',msg:'Size breakdown ('+sizeSum+') exceeds collected ('+o.eggsCollected+')'});
if(o.deaths>0&&hens>0&&o.deaths>hens)e.push({field:'p-deaths',msg:'Deaths ('+o.deaths+') exceed active hens ('+hens+')'});
const dup=D.dailyProduction.find(p=>p.date===o.date&&p.flockId===o.flockId&&(!o.id||p.id!==o.id));
if(dup)w.push({field:'p-date',msg:'Duplicate: production already recorded for this flock on '+o.date});
if(hens>0){const hd=(o.eggsCollected/hens)*100;
if(hd>105)w.push({field:'p-eggs',msg:'HD% is '+hd.toFixed(1)+'% — exceeds 105%, verify count'});
const f=D.flocks.find(x=>x.id===o.flockId);if(f){const age=flockAge(f);const bc=BREED_CURVES[f.targetCurve||f.breed];
if(bc&&age.weeks>=0){const idx=Math.min(age.weeks,bc.length-1);const expected=bc[idx]*(f.curveAdjust||1);
if(hd>0&&Math.abs(hd-expected)>25)w.push({field:'p-eggs',msg:'HD% ('+hd.toFixed(1)+'%) deviates >25pts from breed curve ('+expected.toFixed(1)+'%)'});}}}
return{ok:e.length===0,errors:e,warnings:w};
},
flock(o,D){
const e=[],w=[];
if(o.curveAdjust<0.3||o.curveAdjust>2.0)e.push({field:'f-curve',msg:'Curve adjust must be 0.3-2.0 (got '+o.curveAdjust+')'});
if(o.count>50000)w.push({field:'f-count',msg:'Large flock ('+o.count+' hens) — verify count'});
const dup=D.flocks.find(f=>f.name.toLowerCase()===o.name.toLowerCase()&&(!o.id||f.id!==o.id));
if(dup)e.push({field:'f-name',msg:'Flock name "'+o.name+'" already exists'});
if(o.birthDate>todayStr())w.push({field:'f-birth',msg:'Birth date is in the future'});
return{ok:e.length===0,errors:e,warnings:w};
},
feedCons(o,D){
const e=[],w=[];
if(o.date>todayStr())e.push({field:'fc-date',msg:'Future date not allowed'});
const hens=activeHensByFlock(o.flockId);
if(hens>0){const perHen=(o.quantityKg/hens)*1000;
if(perHen<50)w.push({field:'fc-qty',msg:'Very low: '+perHen.toFixed(0)+'g/hen (normal 80-160g)'});
if(perHen>250)w.push({field:'fc-qty',msg:'Very high: '+perHen.toFixed(0)+'g/hen (normal 80-160g)'});
if(perHen>400)e.push({field:'fc-qty',msg:'Impossible: '+perHen.toFixed(0)+'g/hen exceeds 400g max'});}
const stock=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0)-D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0);
if(o.quantityKg>stock&&stock>=0)w.push({field:'fc-qty',msg:'Consumption ('+o.quantityKg+'kg) exceeds feed stock ('+stock.toFixed(1)+'kg)'});
return{ok:e.length===0,errors:e,warnings:w};
},
income(o,D){
const e=[],w=[];
if(o.date>todayStr())e.push({field:'fi-date',msg:'Future date not allowed'});
if(o.type==='eggs'&&o.quantity>0){const inv=D.inventory.reduce((s,i)=>s+(i.qtyIn||0)-(i.qtyOut||0),0);
if(o.quantity>inv&&inv>=0)w.push({field:'fi-qty',msg:'Sale qty ('+o.quantity+') exceeds inventory ('+Math.floor(inv)+')'});}
if(o.unitPrice>0&&o.quantity>0){const total=o.unitPrice*o.quantity;
if(total>1000000)w.push({field:'fi-price',msg:'High transaction: '+total.toFixed(2)+' — verify'});}
return{ok:e.length===0,errors:e,warnings:w};
},
expense(o,D){
const e=[],w=[];
if(o.date>todayStr())e.push({field:'fe-date',msg:'Future date not allowed'});
if(o.amount>500000)w.push({field:'fe-amt',msg:'Large expense: '+o.amount.toFixed(2)+' — verify amount'});
return{ok:e.length===0,errors:e,warnings:w};
}
},
// --- XVAL: Cross-Validation Processor ---
xval(D){
const issues=[];let score=100;const penalty=5;
// 1. Inventory balance check
const invBal=D.inventory.reduce((s,i)=>s+(i.qtyIn||0)-(i.qtyOut||0),0);
if(invBal<0){issues.push({severity:'error',module:'inventory',msg:'Negative egg inventory: '+Math.floor(invBal),trace:VENG.trace.negativeInventory(D)});score-=penalty*2;}
// 2. Feed stock check
const feedStock=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0)-D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0);
if(feedStock<-0.1){issues.push({severity:'error',module:'feed',msg:'Negative feed stock: '+feedStock.toFixed(1)+'kg',trace:VENG.trace.negativeFeedStock(D)});score-=penalty*2;}
// 3. Orphan production records
const flockIds=new Set(D.flocks.map(f=>f.id));
const orphanProd=D.dailyProduction.filter(p=>p.flockId&&!flockIds.has(p.flockId));
if(orphanProd.length){issues.push({severity:'warning',module:'production',msg:orphanProd.length+' production records reference deleted flocks'});score-=penalty;}
// 4. Orphan feed consumption
const orphanFeed=D.feed.consumption.filter(c=>c.flockId&&!flockIds.has(c.flockId));
if(orphanFeed.length){issues.push({severity:'warning',module:'feed',msg:orphanFeed.length+' feed records reference deleted flocks'});score-=penalty;}
// 5. Orphan vaccine records
const orphanVax=D.vaccines.filter(v=>v.flockId&&!flockIds.has(v.flockId));
if(orphanVax.length){issues.push({severity:'warning',module:'vaccines',msg:orphanVax.length+' vaccine records reference deleted flocks'});score-=penalty;}
// 6. Orphan income-client references
const clientIds=new Set(D.clients.map(c=>c.id));
const orphanInc=D.finances.income.filter(i=>i.clientId&&!clientIds.has(i.clientId));
if(orphanInc.length){issues.push({severity:'warning',module:'income',msg:orphanInc.length+' income records reference deleted clients'});score-=penalty;}
// 7. Active hens consistency per flock
D.flocks.forEach(f=>{
const deaths=D.dailyProduction.filter(p=>p.flockId===f.id).reduce((s,p)=>s+(p.deaths||0),0);
const oDeaths=D.outbreaks.filter(o=>o.flockId===f.id).reduce((s,o)=>s+(o.deaths||0),0);
if(deaths+oDeaths>(f.count||0)){issues.push({severity:'error',module:'flocks',msg:'Flock "'+f.name+'": total deaths ('+(deaths+oDeaths)+') exceed initial count ('+f.count+')'});score-=penalty;}
});
// 8. Production vs inventory gap
const totalProdEggs=D.dailyProduction.reduce((s,p)=>s+(p.eggsCollected||0),0);
const totalInvIn=D.inventory.filter(i=>i.source==='production').reduce((s,i)=>s+(i.qtyIn||0),0);
const gap=Math.abs(totalProdEggs-totalInvIn);
if(gap>10&&totalProdEggs>0){issues.push({severity:'warning',module:'inventory',msg:'Production-inventory gap: '+gap+' eggs (prod='+totalProdEggs+', inv_in='+totalInvIn+')'});score-=Math.min(penalty,Math.ceil(gap/totalProdEggs*20));}
// 9. FCR sanity per flock (30-day)
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
D.flocks.forEach(f=>{
const eggs=D.dailyProduction.filter(p=>p.flockId===f.id&&p.date>=d30s).reduce((s,p)=>s+(p.eggsCollected||0),0);
const feedKg=D.feed.consumption.filter(c=>c.flockId===f.id&&c.date>=d30s).reduce((s,c)=>s+(c.quantityKg||0),0);
const eggKg=eggs*0.06;const fcr=eggKg>0?feedKg/eggKg:0;
if(fcr>5&&feedKg>0){issues.push({severity:'warning',module:'feed',msg:'Flock "'+f.name+'": FCR='+fcr.toFixed(2)+' (>5 abnormal, check feed/production data)'});score-=penalty;}
});
// 10. Date sequence gaps
const prodDates=new Set(D.dailyProduction.map(p=>p.date));
if(D.dailyProduction.length>7){const sorted=[...prodDates].sort();for(let i=1;i<Math.min(sorted.length,60);i++){
const prev=new Date(sorted[i-1]+'T12:00:00');const curr=new Date(sorted[i]+'T12:00:00');
const diff=Math.round((curr-prev)/864e5);
if(diff>3){issues.push({severity:'info',module:'production',msg:'Gap: no production data between '+sorted[i-1]+' and '+sorted[i]+' ('+diff+' days)'});score-=1;}}}
return{score:Math.max(0,score),issues,timestamp:new Date().toISOString()};
},
// --- MATHV: Math Verification Processor ---
mathv(D){
const checks=[];let pass=0,total=0;
const mo=todayStr().substring(0,7);
const mInc=D.finances.income.filter(i=>i.date&&i.date.startsWith(mo)).reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
const mExp=D.finances.expenses.filter(e=>e.date&&e.date.startsWith(mo)).reduce((s,e)=>s+(e.amount||0),0);
const grossProfit=mInc-mExp;
const taxRate=(D.settings.taxRate||0)/100;
const depY=D.settings.depreciationYears||5;
const assetVal=D.settings.assetValue||0;
const monthlyDep=assetVal>0?assetVal/(depY*12):0;
const opProfit=grossProfit-monthlyDep;
const taxAmt=opProfit>0?opProfit*taxRate:0;
const netProfit=opProfit-taxAmt;
// Check 1: Net profit formula
total++;const expectedNet=mInc-mExp-monthlyDep-(opProfit>0?opProfit*taxRate:0);
if(Math.abs(netProfit-expectedNet)<0.01){pass++;checks.push({name:'Net Profit Formula',ok:true,detail:'Income-Expenses-Depreciation-Tax = '+netProfit.toFixed(2)});}
else{checks.push({name:'Net Profit Formula',ok:false,detail:'Mismatch: computed='+netProfit.toFixed(2)+' vs expected='+expectedNet.toFixed(2)});}
// Check 2: Cost per egg
const tEggs=D.dailyProduction.reduce((s,p)=>s+(p.eggsCollected||0),0);
const tExp=D.finances.expenses.reduce((s,e)=>s+(e.amount||0),0);
const cpe=tEggs>0?tExp/tEggs:0;
total++;if(tEggs>0){const verify=cpe*tEggs;if(Math.abs(verify-tExp)<0.01){pass++;checks.push({name:'Cost/Egg Verification',ok:true,detail:'CPE('+cpe.toFixed(4)+') × Eggs('+tEggs+') = '+verify.toFixed(2)+' ≈ TotalExp('+tExp.toFixed(2)+')'});}
else{checks.push({name:'Cost/Egg Verification',ok:false,detail:'CPE×Eggs='+verify.toFixed(2)+' ≠ TotalExp='+tExp.toFixed(2)});}}
else{pass++;checks.push({name:'Cost/Egg Verification',ok:true,detail:'No eggs yet — N/A'});}
// Check 3: Break-even verification
const totalIncAmt=D.finances.income.reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
const totalIncQty=D.finances.income.reduce((s,i)=>s+(i.quantity||0),0);
const avgPrice=totalIncQty>0?totalIncAmt/totalIncQty:0;
const breakEven=avgPrice>0?Math.ceil(tExp/avgPrice):0;
total++;if(avgPrice>0){const verify=breakEven*avgPrice;if(verify>=tExp*0.99){pass++;checks.push({name:'Break-Even Check',ok:true,detail:'BE('+breakEven+') × AvgPrice('+avgPrice.toFixed(4)+') = '+verify.toFixed(2)+' ≥ Expenses('+tExp.toFixed(2)+')'});}
else{checks.push({name:'Break-Even Check',ok:false,detail:'BE×Price='+verify.toFixed(2)+' < Expenses='+tExp.toFixed(2)});}}
else{pass++;checks.push({name:'Break-Even Check',ok:true,detail:'No sales yet — N/A'});}
// Check 4: Channel revenue sums match total
const chRev=D.finances.income.reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
total++;if(Math.abs(chRev-totalIncAmt)<0.01){pass++;checks.push({name:'Channel Revenue Sum',ok:true,detail:'Sum of all income = '+totalIncAmt.toFixed(2)});}
else{checks.push({name:'Channel Revenue Sum',ok:false,detail:'Channel sum='+chRev.toFixed(2)+' ≠ Total='+totalIncAmt.toFixed(2)});}
// Check 5: Inventory in-out balance
const invIn=D.inventory.reduce((s,i)=>s+(i.qtyIn||0),0);
const invOut=D.inventory.reduce((s,i)=>s+(i.qtyOut||0),0);
const invBal=invIn-invOut;
total++;if(invBal>=0){pass++;checks.push({name:'Inventory Balance',ok:true,detail:'In('+invIn+') - Out('+invOut+') = '+invBal+' ≥ 0'});}
else{checks.push({name:'Inventory Balance',ok:false,detail:'In('+invIn+') - Out('+invOut+') = '+invBal+' < 0 (NEGATIVE)'});}
// Check 6: Active hens ≤ total initial count
const totalInit=D.flocks.reduce((s,f)=>s+(f.count||0),0);
const totalActive=activeHens();
total++;if(totalActive<=totalInit){pass++;checks.push({name:'Active Hens ≤ Initial',ok:true,detail:'Active('+totalActive+') ≤ Initial('+totalInit+')'});}
else{checks.push({name:'Active Hens ≤ Initial',ok:false,detail:'Active('+totalActive+') > Initial('+totalInit+') — IMPOSSIBLE'});}
return{pass,total,pct:total>0?Math.round((pass/total)*100):100,checks,timestamp:new Date().toISOString()};
},
// --- TRACE: Error Tracer ---
trace:{
negativeInventory(D){
let bal=0;const timeline=[];
const sorted=[...D.inventory].sort((a,b)=>(a.date||'').localeCompare(b.date||'')||a.id.localeCompare(b.id));
for(const r of sorted){bal+=(r.qtyIn||0)-(r.qtyOut||0);
if(bal<0){timeline.push({date:r.date,record:r.source+' ref:'+r.ref,delta:-((r.qtyOut||0)-(r.qtyIn||0)),balance:bal});if(timeline.length>=5)break;}}
return timeline;
},
negativeFeedStock(D){
let bal=0;const timeline=[];
const purchases=[...D.feed.purchases].map(p=>({date:p.date,qty:p.quantityKg||0,type:'purchase',id:p.id}));
const consumption=[...D.feed.consumption].map(c=>({date:c.date,qty:-(c.quantityKg||0),type:'consumption',id:c.id}));
const all=[...purchases,...consumption].sort((a,b)=>a.date.localeCompare(b.date));
for(const r of all){bal+=r.qty;
if(bal<0){timeline.push({date:r.date,type:r.type,id:r.id,qty:Math.abs(r.qty),balance:bal.toFixed(1)});if(timeline.length>=5)break;}}
return timeline;
}
},
// --- CENSUS: Aggregated Deficiency Report (Carencias) ---
census(D){
const f=[];const today=todayStr();
const flocks=(D.flocks||[]).filter(fl=>fl.status!=='descarte');
const allFlocks=D.flocks||[];const prod=D.dailyProduction||[];
const vacc=D.vaccines||[];const meds=D.medications||[];
const outbreaks=D.outbreaks||[];const feedP=D.feed?D.feed.purchases:[];
const feedC=D.feed?D.feed.consumption:[];const income=D.finances?D.finances.income:[];
const expenses=D.finances?D.finances.expenses:[];const inv=D.inventory||[];
const env=D.environment||[];const chk=D.checklist||[];
const bio=D.biosecurity?D.biosecurity.visitors:[];
const totalHens=flocks.reduce((s,fl)=>{const d=prod.filter(p=>p.flockId===fl.id).reduce((a,p)=>a+(p.deaths||0),0);return s+Math.max(0,(fl.initialCount||0)-d);},0);
// ── SANITARY ──
const flocksWithVacc=new Set(vacc.map(v=>v.flockId));
const noVacc=flocks.filter(fl=>!flocksWithVacc.has(fl.id));
if(noVacc.length>0&&flocks.length>0){f.push({cat:'sanitary',sev:'critical',code:'NO_VACCINE_PROGRAM',metric:Math.round((noVacc.length/flocks.length)*100),unit:'%',bench:0,msg:noVacc.length+'/'+flocks.length+' active flocks have ZERO vaccines',rec:'Establish vaccination schedule: Newcastle, Bronchitis, Influenza minimum'});}
// Mortality per flock (30d)
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
flocks.forEach(fl=>{const recs=prod.filter(p=>p.flockId===fl.id&&p.date>=d30s);const deaths=recs.reduce((s,p)=>s+(p.deaths||0),0);
const hens=fl.initialCount||0;if(hens>0){const pct=(deaths/hens)*100;
if(pct>3)f.push({cat:'sanitary',sev:'critical',code:'HIGH_MORTALITY',metric:+pct.toFixed(1),unit:'%/30d',bench:1.5,msg:'Flock "'+fl.name+'": '+pct.toFixed(1)+'% mortality in 30 days (expect <1.5%)',rec:'Veterinary inspection urgently needed — check for disease, stress, or ventilation'});
else if(pct>1.5)f.push({cat:'sanitary',sev:'warning',code:'ELEVATED_MORTALITY',metric:+pct.toFixed(1),unit:'%/30d',bench:1.5,msg:'Flock "'+fl.name+'": '+pct.toFixed(1)+'% mortality in 30 days (normal <1.5%)',rec:'Monitor closely — consider preventive vet check'});}});
// Outbreaks without treatment
const untreated=outbreaks.filter(o=>!o.resolved&&!meds.some(m=>m.flockId===o.flockId&&m.date>=o.dateDetected));
if(untreated.length>0)f.push({cat:'sanitary',sev:'critical',code:'UNTREATED_OUTBREAKS',metric:untreated.length,unit:'outbreaks',bench:0,msg:untreated.length+' outbreak(s) without registered treatment',rec:'Register medication/treatment for every outbreak — critical for flock survival'});
// No biosecurity
if(bio.length===0&&flocks.length>0)f.push({cat:'sanitary',sev:'warning',code:'NO_BIOSECURITY_LOGS',metric:0,unit:'visits',bench:1,msg:'Zero biosecurity visitor logs recorded',rec:'Log all farm visitors — essential for outbreak traceability'});
// ── NUTRITIONAL ──
flocks.forEach(fl=>{const cons=feedC.filter(c=>c.flockId===fl.id&&c.date>=d30s);
const hens=fl.initialCount||0;if(cons.length>0&&hens>0){const totalKg=cons.reduce((s,c)=>s+(c.quantityKg||0),0);
const gPerHenDay=(totalKg*1000)/(hens*Math.max(cons.length,1));
if(gPerHenDay>200)f.push({cat:'nutritional',sev:'warning',code:'HIGH_FEED_PER_HEN',metric:+gPerHenDay.toFixed(0),unit:'g/hen/d',bench:120,msg:'Flock "'+fl.name+'": '+gPerHenDay.toFixed(0)+'g/hen/day (expect ~120g)',rec:'Check feed waste, feeder adjustment, or possible recording error'});
else if(gPerHenDay<80&&gPerHenDay>0)f.push({cat:'nutritional',sev:'warning',code:'LOW_FEED_PER_HEN',metric:+gPerHenDay.toFixed(0),unit:'g/hen/d',bench:120,msg:'Flock "'+fl.name+'": only '+gPerHenDay.toFixed(0)+'g/hen/day (expect ~120g)',rec:'Insufficient feeding affects production and health — review feed plan'});}});
// FCR per flock (30d)
flocks.forEach(fl=>{const recs=prod.filter(p=>p.flockId===fl.id&&p.date>=d30s);const cons=feedC.filter(c=>c.flockId===fl.id&&c.date>=d30s);
const eggs=recs.reduce((s,p)=>s+(p.eggsCollected||0),0);const feedKg=cons.reduce((s,c)=>s+(c.quantityKg||0),0);
if(eggs>0&&feedKg>0){const fcr=feedKg/(eggs*0.06);
if(fcr>3)f.push({cat:'nutritional',sev:'critical',code:'HIGH_FCR',metric:+fcr.toFixed(2),unit:'kg feed/kg egg',bench:2.2,msg:'Flock "'+fl.name+'": FCR='+fcr.toFixed(2)+' (target <2.2)',rec:'Review feed quality, hen age, and health — high FCR destroys margins'});
else if(fcr>2.5)f.push({cat:'nutritional',sev:'warning',code:'ELEVATED_FCR',metric:+fcr.toFixed(2),unit:'kg feed/kg egg',bench:2.2,msg:'Flock "'+fl.name+'": FCR='+fcr.toFixed(2)+' (target <2.2)',rec:'Optimize feed formula or check for health issues affecting conversion'});}});
if(feedC.length===0&&flocks.length>0)f.push({cat:'nutritional',sev:'warning',code:'NO_FEED_TRACKING',metric:0,unit:'records',bench:1,msg:'Zero feed consumption records — impossible to calculate FCR',rec:'Register daily feed consumption per flock to track efficiency'});
// ── FINANCIAL ──
const totInc=income.reduce((s,i)=>s+(i.totalPrice||((i.unitPrice||0)*(i.quantity||0))),0);
const totExp=expenses.reduce((s,e)=>s+(e.amount||0),0)+feedP.reduce((s,p)=>s+((p.pricePerKg||0)*(p.quantityKg||0)),0);
if(totInc>0||totExp>0){const margin=totInc>0?((totInc-totExp)/totInc)*100:-100;
if(margin<0)f.push({cat:'financial',sev:'critical',code:'NEGATIVE_MARGIN',metric:+margin.toFixed(1),unit:'%',bench:10,msg:'Net margin is '+margin.toFixed(1)+'% — farm is losing money',rec:'Urgent: review pricing strategy, reduce costs, or diversify channels'});
else if(margin<5)f.push({cat:'financial',sev:'warning',code:'LOW_MARGIN',metric:+margin.toFixed(1),unit:'%',bench:10,msg:'Net margin only '+margin.toFixed(1)+'% — dangerously thin',rec:'Target minimum 10% margin — negotiate better prices or reduce feed costs'});}
if(income.length===0&&prod.length>0)f.push({cat:'financial',sev:'warning',code:'NO_INCOME_RECORDS',metric:0,unit:'records',bench:1,msg:'Production exists but zero sales recorded',rec:'Register all sales to track real profitability'});
const channels=new Set(income.map(i=>i.marketChannel||'default'));
if(income.length>5&&channels.size<=1)f.push({cat:'financial',sev:'info',code:'SINGLE_CHANNEL',metric:1,unit:'channels',bench:3,msg:'All sales through a single channel — high dependency risk',rec:'Diversify: add retail, direct, or organic channels for price resilience'});
// ── OPERATIONAL ──
// Production gaps >3 days
if(prod.length>5){const dates=[...new Set(prod.map(p=>p.date))].sort();
let maxGap=0;for(let i=1;i<dates.length;i++){const diff=(new Date(dates[i])-new Date(dates[i-1]))/(86400000);if(diff>maxGap)maxGap=diff;}
if(maxGap>7)f.push({cat:'operational',sev:'warning',code:'LARGE_PRODUCTION_GAP',metric:maxGap,unit:'days',bench:1,msg:'Largest gap between production records: '+maxGap+' days',rec:'Record production daily — gaps make analytics unreliable'});
else if(maxGap>3)f.push({cat:'operational',sev:'info',code:'PRODUCTION_GAP',metric:maxGap,unit:'days',bench:1,msg:maxGap+'-day gap detected in production records',rec:'Try to record production every day for accurate trend analysis'});}
// Low Hen-Day %
flocks.forEach(fl=>{const recs=prod.filter(p=>p.flockId===fl.id&&p.date>=d30s);
const hens=fl.initialCount||0;if(recs.length>5&&hens>0){const avgEggs=recs.reduce((s,p)=>s+(p.eggsCollected||0),0)/recs.length;
const hd=(avgEggs/hens)*100;const expected=fl.breed?80:75;
if(hd<expected*0.6&&hd>0)f.push({cat:'operational',sev:'warning',code:'LOW_HENDAY',metric:+hd.toFixed(1),unit:'%',bench:expected,msg:'Flock "'+fl.name+'": HD%='+hd.toFixed(1)+'% (expect ~'+expected+'%)',rec:'Check hen age, lighting program, nutrition, and stress factors'});}});
// Unused core modules
const usedModules=new Set();
if(prod.length>0)usedModules.add('production');if(feedC.length>0)usedModules.add('feed');
if(vacc.length>0)usedModules.add('vaccines');if(income.length>0)usedModules.add('income');
if(env.length>0)usedModules.add('environment');if(chk.length>0)usedModules.add('checklist');
if(bio.length>0)usedModules.add('biosecurity');if(inv.length>0)usedModules.add('inventory');
const core=['production','feed','income','vaccines'];
const unused=core.filter(m=>!usedModules.has(m));
if(unused.length>0&&flocks.length>0)f.push({cat:'operational',sev:'info',code:'UNUSED_MODULES',metric:unused.length,unit:'modules',bench:0,msg:'Core modules not used: '+unused.join(', '),rec:'Use all core modules for complete farm visibility'});
if(env.length===0&&flocks.length>0)f.push({cat:'operational',sev:'info',code:'NO_ENVIRONMENT',metric:0,unit:'readings',bench:1,msg:'No temperature/humidity readings recorded',rec:'Track environment — heat stress is #1 silent production killer'});
// ── DATA QUALITY ──
const xv=VENG.xval(D);
if(xv.score<70)f.push({cat:'data',sev:'critical',code:'LOW_XVAL_SCORE',metric:xv.score,unit:'/100',bench:90,msg:'Data integrity score: '+xv.score+'/100 (target: 90+)',rec:'Fix cross-validation issues: orphan records, negative balances, inconsistencies'});
else if(xv.score<90)f.push({cat:'data',sev:'warning',code:'MODERATE_XVAL_SCORE',metric:xv.score,unit:'/100',bench:90,msg:'Data integrity score: '+xv.score+'/100 (target: 90+)',rec:'Review and fix flagged issues to improve data reliability'});
const mv=VENG.mathv(D);
if(mv.pct<100)f.push({cat:'data',sev:'warning',code:'MATHV_FAILURES',metric:mv.pct,unit:'%',bench:100,msg:'Math verification: '+mv.pass+'/'+mv.total+' formulas pass ('+mv.pct+'%)',rec:'Check financial formulas — math inconsistencies undermine trust'});
// ── AGGREGATE SCORES ──
const byCat={sanitary:[],nutritional:[],financial:[],operational:[],data:[]};
f.forEach(x=>{if(byCat[x.cat])byCat[x.cat].push(x);});
function catScore(arr){if(arr.length===0)return 100;let s=100;arr.forEach(x=>{if(x.sev==='critical')s-=20;else if(x.sev==='warning')s-=10;else s-=3;});return Math.max(0,s);}
const scores={sanitary:catScore(byCat.sanitary),nutritional:catScore(byCat.nutritional),financial:catScore(byCat.financial),operational:catScore(byCat.operational),data:catScore(byCat.data)};
const overall=Math.round((scores.sanitary+scores.nutritional+scores.financial+scores.operational+scores.data)/5);
// Anonymized telemetry (no farm name, no client names, no financials)
const farmSize=totalHens>10000?'large':totalHens>2000?'medium':totalHens>0?'small':'empty';
const anon={farmSize,activeFlocks:flocks.length,totalHens:totalHens>0?Math.round(totalHens/100)*100:0,
codes:f.map(x=>x.code),scores,overall,
modulesUsed:[...usedModules],channelCount:channels?channels.size:0,
hasVet:vacc.length>0||meds.length>0,ts:new Date().toISOString()};
return{timestamp:new Date().toISOString(),overall,scores,findings:f,
critical:f.filter(x=>x.sev==='critical').length,
warning:f.filter(x=>x.sev==='warning').length,
info:f.filter(x=>x.sev==='info').length,
anonymized:anon};
}
};
function showVengPanel(errors,warnings){
let h='';
if(errors.length){h+='<div style="background:#fee;border:1px solid #f88;border-radius:8px;padding:10px;margin:8px 0"><strong style="color:#c00">⛔ VENG Errors</strong><ul style="margin:4px 0;padding-left:20px;color:#900">';
errors.forEach(e=>{h+='<li>'+sanitizeHTML(e.msg)+'</li>';});h+='</ul></div>';}
if(warnings.length){h+='<div style="background:#fff8e1;border:1px solid #ffc107;border-radius:8px;padding:10px;margin:8px 0"><strong style="color:#e65100">⚠ VENG Warnings</strong> <span style="font-size:12px;color:#795548">(save again to override)</span><ul style="margin:4px 0;padding-left:20px;color:#6d4c00">';
warnings.forEach(w=>{h+='<li>'+sanitizeHTML(w.msg)+'</li>';});h+='</ul></div>';}
let panel=$('veng-panel');
if(!panel){const mb=$('modal-body');if(mb){panel=document.createElement('div');panel.id='veng-panel';mb.prepend(panel);}}
if(panel)panel.innerHTML=h;
}
function renderIntegrityWidget(D){
const xv=VENG.xval(D);const mv=VENG.mathv(D);const cs=VENG.census(D);
let h='<div class="card" style="border-left:4px solid '+(xv.score>=90?'var(--success)':xv.score>=70?'var(--warning)':'var(--danger)')+'">';
h+='<h3>🔒 Data Integrity — Zero Tolerance</h3>';
h+='<div class="kpi-grid">';
h+=kpi('Data Score',xv.score+'/100','XVAL cross-check',xv.score>=90?'':'danger');
h+=kpi('Math Check',mv.pct+'%',mv.pass+'/'+mv.total+' passed',mv.pct===100?'':'danger');
const csC=cs.overall>=80?'':'danger';
h+=kpi('Farm Health',cs.overall+'/100',cs.critical+' critical, '+cs.warning+' warnings',csC);
h+='</div>';
if(cs.findings.length>0){h+='<div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">';
cs.findings.filter(f=>f.sev==='critical').slice(0,3).forEach(f=>{h+='<span style="background:#ffcdd2;color:#b71c1c;padding:3px 10px;border-radius:10px;font-size:12px">'+f.code+'</span>';});
h+=' <a href="javascript:nav(\'carencias\')" style="font-size:12px;color:var(--primary);align-self:center">View all →</a></div>';}
h+='</div><div class="card" style="border-left:4px solid '+(cs.overall>=80?'var(--success)':cs.overall>=60?'var(--warning)':'var(--danger)')+'">';
h+='<h3>🔍 Deficiency Census</h3><div style="display:flex;gap:10px;flex-wrap:wrap">';
['sanitary','nutritional','financial','operational','data'].forEach(cat=>{
const icons={sanitary:'💉',nutritional:'🌾',financial:'💰',operational:'📋',data:'🔒'};
const s=cs.scores[cat];const sc=s>=80?'#2e7d32':s>=60?'#e65100':'#c62828';
h+='<div style="text-align:center;min-width:60px"><div style="font-size:20px;font-weight:700;color:'+sc+'">'+s+'</div><div style="font-size:11px;color:var(--text-light)">'+icons[cat]+' '+cat.charAt(0).toUpperCase()+cat.slice(1)+'</div></div>';});
h+='</div></div>';
if(xv.issues.length){h+='<details style="margin-top:8px"><summary style="cursor:pointer;font-weight:600;color:var(--text-secondary)">'+xv.issues.length+' issue'+(xv.issues.length>1?'s':'')+' found</summary>';
h+='<div class="table-wrap" style="margin-top:6px"><table><thead><tr><th>Sev</th><th>Module</th><th>Issue</th></tr></thead><tbody>';
xv.issues.forEach(i=>{const c=i.severity==='error'?'var(--danger)':i.severity==='warning'?'var(--warning)':'var(--text-light)';
h+='<tr><td style="color:'+c+';font-weight:700">'+i.severity.toUpperCase()+'</td><td>'+sanitizeHTML(i.module)+'</td><td>'+sanitizeHTML(i.msg);
if(i.trace&&i.trace.length){h+='<br><small style="color:var(--text-light)">Origin: '+i.trace.map(t=>t.date+' '+t.type+(t.balance!==undefined?' (bal:'+t.balance+')':'')).join(' → ')+'</small>';}
h+='</td></tr>';});
h+='</tbody></table></div></details>';}
if(mv.checks.some(c=>!c.ok)){h+='<details style="margin-top:8px"><summary style="cursor:pointer;font-weight:600;color:var(--danger)">Math verification failures</summary>';
h+='<div style="margin-top:6px">';
mv.checks.filter(c=>!c.ok).forEach(c=>{h+='<div class="alert-card alert-danger" style="margin:4px 0">❌ '+sanitizeHTML(c.name)+': '+sanitizeHTML(c.detail)+'</div>';});
h+='</div></details>';}
h+='</div>';
return h;
}

// ============ AUDIT TRAIL (A3) ============
let _currentUser={name:'owner',role:'owner'};
function logAudit(action,module,detail,before,after){
const D=loadData();if(!D.auditLog)D.auditLog=[];
D.auditLog.push({ts:new Date().toISOString(),user:_currentUser.name,action,module,detail:detail||'',before:before||null,after:after||null});
if(D.auditLog.length>10000)D.auditLog=D.auditLog.slice(-10000);
DATA=D;localStorage.setItem('egglogu_data',JSON.stringify(DATA));
}

// ============ AUTO-BACKUP via Cache API (A7) ============
let _backupTimer=null;
function scheduleAutoBackup(){if(_backupTimer)clearTimeout(_backupTimer);_backupTimer=setTimeout(autoBackup,5000);}
async function autoBackup(){
if(!('caches' in window))return;
try{
const cache=await caches.open('egglogu-backups');
const keys=await cache.keys();
const backupKeys=keys.filter(k=>k.url.includes('egglogu-backup-')).sort((a,b)=>a.url.localeCompare(b.url));
while(backupKeys.length>=5){await cache.delete(backupKeys.shift());}
const ts=new Date().toISOString().replace(/[:.]/g,'-');
const data=localStorage.getItem('egglogu_data')||'{}';
await cache.put(new Request('/egglogu-backup-'+ts),new Response(data,{headers:{'Content-Type':'application/json','X-Backup-Date':new Date().toISOString(),'X-Backup-Size':String(data.length)}}));
}catch(e){console.warn('Auto-backup failed:',e.message);}
}
async function listBackups(){
if(!('caches' in window))return[];
try{
const cache=await caches.open('egglogu-backups');
const keys=await cache.keys();
const backups=[];
for(const k of keys){if(!k.url.includes('egglogu-backup-'))continue;
const r=await cache.match(k);const date=r.headers.get('X-Backup-Date')||'';const size=parseInt(r.headers.get('X-Backup-Size'))||0;
backups.push({url:k.url,date,size,key:k});}
return backups.sort((a,b)=>b.date.localeCompare(a.date));
}catch(e){return[];}
}
async function restoreBackup(url){
if(!await showConfirm(t('cfg_reset_confirm')||'Restore this backup? Current data will be overwritten.'))return;
try{
const cache=await caches.open('egglogu-backups');
const r=await cache.match(new Request(url));if(!r)return toast('Backup not found',true);
const data=await r.json();DATA=data;saveData(data);toast(t('cfg_imported')||'Restored');nav('config');
}catch(e){toast('Error: '+e.message,true);}
}
function getStorageUsage(){try{const d=localStorage.getItem('egglogu_data');return d?d.length:0;}catch(e){return 0;}}

// ============ ROLE PERMISSIONS (A8) ============
const ROLE_PERMISSIONS={
owner:['dashboard','produccion','lotes','alimento','ambiente','sanidad','bioseguridad','clientes','inventario','finanzas','analisis','operaciones','trazabilidad','planificacion','carencias','admin','config'],
manager:['dashboard','produccion','lotes','alimento','ambiente','sanidad','bioseguridad','clientes','inventario','finanzas','analisis','operaciones','trazabilidad','planificacion','carencias'],
worker:['dashboard','produccion','lotes','alimento','ambiente'],
vet:['dashboard','lotes','ambiente','sanidad','bioseguridad','trazabilidad','carencias']
};

const MODULE_GROUPS={
production:['produccion','lotes','alimento','ambiente'],
health:['sanidad','bioseguridad'],
commercial:['clientes','inventario','finanzas'],
management:['analisis','operaciones','trazabilidad','planificacion','carencias'],
system:['admin','config']
};
const DEFAULT_ROLE_PERMS=JSON.parse(JSON.stringify(ROLE_PERMISSIONS));
const ROLE_MAX_MODULES={
owner:['dashboard','produccion','lotes','alimento','ambiente','sanidad','bioseguridad','clientes','inventario','finanzas','analisis','operaciones','trazabilidad','planificacion','carencias','admin','config'],
manager:['dashboard','produccion','lotes','alimento','ambiente','sanidad','bioseguridad','clientes','inventario','finanzas','analisis','operaciones','trazabilidad','planificacion','carencias'],
worker:['dashboard','produccion','lotes','alimento','ambiente','operaciones'],
vet:['dashboard','sanidad','bioseguridad','lotes','ambiente','trazabilidad','planificacion','carencias']
};

function hasPermission(section){if(!_currentUser||!_currentUser.role)return true;const perms=ROLE_PERMISSIONS[_currentUser.role];return !perms||perms.includes(section);}

function activeHens(){const D=loadData();let n=0;D.flocks.forEach(f=>{if(f.status!=='descarte')n+=activeHensByFlock(f.id);});return n;}
function activeHensByFlock(fid){
const D=loadData();const f=D.flocks.find(x=>x.id===fid);if(!f)return 0;
const deaths=D.dailyProduction.filter(p=>p.flockId===fid).reduce((s,p)=>s+(p.deaths||0),0);
const oD=D.outbreaks.filter(o=>o.flockId===fid).reduce((s,o)=>s+(o.deaths||0),0);
return Math.max(0,(f.count||0)-deaths-oD);
}
function flockAge(f){if(!f.birthDate)return{days:0,weeks:0};const d=Math.floor((new Date()-new Date(f.birthDate+'T12:00:00'))/864e5);return{days:Math.max(0,d),weeks:Math.max(0,Math.floor(d/7))};}
function flockLifecycleStage(f){const w=flockAge(f).weeks;return LIFECYCLE.find(l=>w>=l.weekStart&&w<l.weekEnd)||LIFECYCLE[LIFECYCLE.length-1];}
function healthScore(fid){
const D=loadData();const f=D.flocks.find(x=>x.id===fid);if(!f)return 0;
const td=D.dailyProduction.filter(p=>p.flockId===fid).reduce((s,p)=>s+(p.deaths||0),0);
const mPct=f.count>0?(td/f.count)*100:0;const mS=Math.max(0,100-mPct*10);
const l7=D.dailyProduction.filter(p=>p.flockId===fid).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const hens=activeHensByFlock(fid);let pS=50;
if(l7.length>0&&hens>0){const avg=l7.reduce((s,p)=>s+(p.eggsCollected||0),0)/l7.length;pS=Math.min(100,(avg/hens)*125);}
let fS=80;const l7f=D.feed.consumption.filter(c=>c.flockId===fid).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
if(l7f.length>0&&l7.length>0&&hens>0){const aF=l7f.reduce((s,c)=>s+(c.quantityKg||0),0)/l7f.length;const aE=(l7.reduce((s,p)=>s+(p.eggsCollected||0),0)/l7.length*0.06);const fcr=aE>0?aF/aE:99;fS=fcr<2?100:fcr<2.5?80:fcr<3?60:fcr<4?40:20;}
const ao=D.outbreaks.filter(o=>o.flockId===fid&&o.status==='active').length;const oS=ao===0?100:ao===1?40:0;
return Math.round(mS*0.3+pS*0.3+fS*0.2+oS*0.2);
}
function healthBadge(s){return `<span class="health-score ${s>=70?'good':s>=40?'warn':'bad'}">${s}</span>`;}
function statusBadge(st){
const m={cria:'info',recria:'warning',produccion:'success',descarte:'secondary',active:'danger',controlled:'warning',resolved:'success',pending:'warning',applied:'success',overdue:'danger'};
const lb={cria:t('flock_status_cria'),recria:t('flock_status_recria'),produccion:t('flock_status_produccion'),descarte:t('flock_status_descarte'),active:t('out_active'),controlled:t('out_controlled'),resolved:t('out_resolved'),pending:t('vac_pending'),applied:t('vac_applied_status'),overdue:t('vac_overdue')};
return `<span class="badge badge-${m[st]||'secondary'}">${lb[st]||st}</span>`;
}

// ============ KPI SNAPSHOT SYSTEM ============
function computeKpiSnapshot(){
const D=loadData();const hens=activeHens();const today=todayStr();
const tp=D.dailyProduction.filter(p=>p.date===today);
const eggsToday=tp.reduce((s,p)=>s+(p.eggsCollected||0),0);
const henDay=hens>0?((eggsToday/hens)*100):0;
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const p30=D.dailyProduction.filter(p=>p.date>=d30s);const te30=p30.reduce((s,p)=>s+(p.eggsCollected||0),0);
const teKg=te30*0.06;const f30=D.feed.consumption.filter(c=>c.date>=d30s);const tfKg=f30.reduce((s,c)=>s+(c.quantityKg||0),0);
const fcr=teKg>0?(tfKg/teKg):0;
const tDeaths=D.dailyProduction.reduce((s,p)=>s+(p.deaths||0),0);const tInit=D.flocks.reduce((s,f)=>s+(f.count||0),0);
const mort=tInit>0?((tDeaths/tInit)*100):0;
const tExp=D.finances.expenses.reduce((s,e)=>s+(e.amount||0),0);const tEggs=D.dailyProduction.reduce((s,p)=>s+(p.eggsCollected||0),0);
const cpe=tEggs>0?tExp/tEggs:0;
const mo=today.substring(0,7);
const mInc=D.finances.income.filter(i=>i.date&&i.date.startsWith(mo)).reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
const mExp=D.finances.expenses.filter(e=>e.date&&e.date.startsWith(mo)).reduce((s,e)=>s+(e.amount||0),0);
const stock=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0)-D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0);
return{date:today,activeHens:hens,eggsToday,henDay:Math.round(henDay*10)/10,fcr:Math.round(fcr*100)/100,
mortality:Math.round(mort*10)/10,costPerEgg:Math.round(cpe*100)/100,netIncome:mInc-mExp,feedStock:Math.round(stock*10)/10,
totalFlocks:D.flocks.filter(f=>f.status!=='descarte').length,activeOutbreaks:D.outbreaks.filter(o=>o.status==='active').length};
}
function saveKpiSnapshot(){
const D=loadData();const snap={id:genId(),...computeKpiSnapshot()};
D.kpiSnapshots.push(snap);saveData(D);toast(t('cfg_saved'));renderDashboard();
}
function snapshotDelta(current,previous){
if(!previous)return'';const diff=current-previous;
if(Math.abs(diff)<0.01)return `<span class="snapshot-badge snapshot-same">= </span>`;
return diff>0?`<span class="snapshot-badge snapshot-up">▲ ${fmtNum(diff,1)}</span>`:`<span class="snapshot-badge snapshot-down">▼ ${fmtNum(Math.abs(diff),1)}</span>`;
}

// ============ VACCINE SCHEDULE ============
const VACCINE_SCHEDULE=[
{name:'Marek',ageDays:1,route:'vac_route_injection'},{name:'Newcastle + Bronquitis Infecciosa',ageDays:6,route:'vac_route_ocular'},
{name:'Gumboro (IBD)',ageDays:14,route:'vac_route_water'},{name:'Newcastle refuerzo',ageDays:21,route:'vac_route_water'},
{name:'Viruela Aviar',ageDays:49,route:'vac_route_wing'},{name:'Encefalomielitis Aviar',ageDays:63,route:'vac_route_water'},
{name:'Coriza Infecciosa',ageDays:77,route:'vac_route_injection'},{name:'Salmonella',ageDays:91,route:'vac_route_injection'},
{name:'Newcastle + BI pre-postura',ageDays:112,route:'vac_route_injection'}
];
function generateVaccineCalendar(flock){
const D=loadData();if(!flock.birthDate)return;const birth=new Date(flock.birthDate+'T12:00:00');
VACCINE_SCHEDULE.forEach(vs=>{const sd=new Date(birth.getTime()+vs.ageDays*864e5);
if(!D.vaccines.find(v=>v.flockId===flock.id&&v.vaccineName===vs.name)){
D.vaccines.push({id:genId(),flockId:flock.id,vaccineName:vs.name,scheduledDate:sd.toISOString().substring(0,10),appliedDate:'',batchNumber:'',route:vs.route,notes:'',status:'pending'});}});
saveData(D);
}

// ============ UI HELPERS ============
const HEAVY_SECTIONS=new Set(['dashboard','analisis','finanzas','bioseguridad','trazabilidad','carencias','admin']);
function toggleNavGroup(lbl){
const links=lbl.nextElementSibling;if(!links||!links.classList.contains('nav-group-links'))return;
lbl.classList.toggle('grp-open');links.classList.toggle('grp-open');
}
function openNavGroupFor(section){
if(section==='dashboard')return;
const link=document.querySelector('#main-nav a[data-section="'+section+'"]');
if(!link)return;
const grp=link.closest('.nav-group-links');
if(!grp)return;
const lbl=grp.previousElementSibling;
if(lbl&&!lbl.classList.contains('grp-open'))lbl.classList.add('grp-open');
if(!grp.classList.contains('grp-open'))grp.classList.add('grp-open');
}
function nav(section){
currentSection=section;document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
$('sec-'+section).classList.add('active');
document.querySelectorAll('#main-nav a').forEach(a=>a.classList.toggle('active',a.dataset.section===section));
openNavGroupFor(section);
$('sidebar').classList.remove('open');
const R={dashboard:renderDashboard,produccion:renderProduction,lotes:renderFlocks,sanidad:renderSanidad,alimento:renderFeed,clientes:renderClients,inventario:renderInventory,finanzas:renderFinances,analisis:renderAnalysis,operaciones:renderOperations,bioseguridad:renderBiosecurity,trazabilidad:renderTraceability,planificacion:renderPlanning,ambiente:renderEnvironment,carencias:renderCarencias,admin:renderAdmin,config:renderConfig};
if(R[section]){
if(HEAVY_SECTIONS.has(section)){$('sec-'+section).innerHTML='<div class="loading-spinner" aria-label="Loading"></div>';requestAnimationFrame(()=>{R[section]();postRenderA11y(section);});}
else{R[section]();postRenderA11y(section);}
}
}
function postRenderA11y(section){setTimeout(()=>{const sec=$('sec-'+section);if(sec)sec.querySelectorAll('thead th').forEach(th=>{if(!th.getAttribute('scope'))th.setAttribute('scope','col');});},50);}
function toggleSidebar(){$('sidebar').classList.toggle('open');}
let _modalTrigger=null;
function openModal(title,body){_modalTrigger=document.activeElement;$('modal-title').textContent=title;$('modal-body').innerHTML=body;$('modal-overlay').classList.add('open');
setTimeout(()=>{const first=$('modal-overlay').querySelector('input,select,textarea,button');if(first)first.focus();},50);}
function closeModal(){$('modal-overlay').classList.remove('open');if(_modalTrigger&&_modalTrigger.focus)_modalTrigger.focus();_modalTrigger=null;_vengWarningsShown=false;}
function toast(msg,err=false){const e=$('toast');e.textContent=msg;e.className='toast show'+(err?' error':'');setTimeout(()=>e.className='toast',3000);}
function emptyState(icon,msg,btn,act){let h=`<div class="empty-state"><div class="empty-icon">${sanitizeHTML(icon)}</div><p>${sanitizeHTML(msg)}</p>`;if(btn)h+=`<button class="btn btn-primary" onclick="${escapeAttr(act)}">${sanitizeHTML(btn)}</button>`;return h+'</div>';}
function switchLang(l){LANG=l;localStorage.setItem('egglogu_lang',l);document.documentElement.lang=l;const lt=$('langToggle');if(lt){lt.querySelectorAll('.lang-grid button').forEach(b=>{b.classList.toggle('active',b.id==='btn-'+l);});const names={es:'Español',en:'English',pt:'Português',fr:'Français',de:'Deutsch',it:'Italiano',ja:'日本語',zh:'中文'};const lc=$('langCurrent');if(lc)lc.textContent=names[l]||l;lt.classList.remove('open');}document.querySelectorAll('[data-t]').forEach(el=>el.textContent=t(el.dataset.t));nav(currentSection);}
function flockSelect(sel,all=false){const D=loadData();let h=all?`<option value="">${t('all')}</option>`:'<option value="">--</option>';D.flocks.forEach(f=>{h+=`<option value="${escapeAttr(f.id)}"${f.id===sel?' selected':''}>${sanitizeHTML(f.name)}</option>`;});return h;}
function clientSelect(sel){const D=loadData();let h='<option value="">--</option>';D.clients.forEach(c=>{h+=`<option value="${escapeAttr(c.id)}"${c.id===sel?' selected':''}>${sanitizeHTML(c.name)}</option>`;});return h;}
function destroyCharts(){Object.values(CHARTS).forEach(c=>{try{c.destroy();}catch(e){}});CHARTS={};}

// ============ ALERTS ============
function getAlerts(D){
const alerts=[];const today=todayStr();const ad=D.settings.alertDaysBefore||3;
const soon=new Date();soon.setDate(soon.getDate()+ad);const soonStr=soon.toISOString().substring(0,10);
D.vaccines.filter(v=>v.status!=='applied').forEach(v=>{
const f=D.flocks.find(x=>x.id===v.flockId);const fn=f?f.name:'';
if(v.scheduledDate<today)alerts.push({type:'danger',icon:'💉',msg:`${t('alert_vaccine_overdue')}: ${v.vaccineName} - ${fn}`});
else if(v.scheduledDate<=soonStr)alerts.push({type:'warning',icon:'💉',msg:`${t('alert_vaccine_soon')}: ${v.vaccineName} - ${fn} (${fmtDate(v.scheduledDate)})`});
});
const stock=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0)-D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0);
if(stock<(D.settings.minFeedStock||50))alerts.push({type:'warning',icon:'🌾',msg:`${t('alert_low_feed')}: ${fmtNum(stock,1)} kg`});
const tD=D.dailyProduction.reduce((s,p)=>s+(p.deaths||0),0);const tI=D.flocks.reduce((s,f)=>s+(f.count||0),0);
if(tI>0&&(tD/tI)*100>(D.settings.maxMortality||5))alerts.push({type:'danger',icon:'⚠️',msg:`${t('alert_high_mortality')}: ${fmtNum((tD/tI)*100,1)}%`});
D.outbreaks.filter(o=>o.status==='active').forEach(o=>{const f=D.flocks.find(x=>x.id===o.flockId);alerts.push({type:'danger',icon:'🦠',msg:`${t('alert_active_outbreak')}: ${o.disease} - ${f?f.name:''}`});});
D.medications.forEach(m=>{if(m.withdrawalEnd&&m.withdrawalEnd>=today){const f=D.flocks.find(x=>x.id===m.flockId);alerts.push({type:'warning',icon:'⏳',msg:`${t('alert_withdrawal')}: ${m.name} - ${f?f.name:''} (${fmtDate(m.withdrawalEnd)})`});}});
// Biosecurity alerts
if(D.biosecurity){
D.biosecurity.zones.forEach(z=>{if(z.lastDisinfection&&z.frequencyDays){
const next=new Date(z.lastDisinfection+'T12:00:00');next.setDate(next.getDate()+z.frequencyDays);
if(next.toISOString().substring(0,10)<today)alerts.push({type:'warning',icon:'🛡️',msg:`${t('alert_bio_disinfection')}: ${z.name}`});}});
const unresolved=D.biosecurity.pestSightings.filter(p=>!p.resolved).length;
if(unresolved>0)alerts.push({type:'warning',icon:'🐀',msg:`${t('alert_bio_pests')}: ${unresolved}`});
const recentCross=D.biosecurity.visitors.filter(v=>v.fromFarmHealth==='outbreak'&&v.date>=new Date(Date.now()-7*86400000).toISOString().substring(0,10));
if(recentCross.length)alerts.push({type:'danger',icon:'⚠️',msg:`${t('alert_bio_cross')}: ${recentCross.map(v=>sanitizeHTML(v.name)).join(', ')}`});
}
return alerts;
}

// ============ DASHBOARD ============
function renderDashboard(){
const D=loadData();
if(D.settings.campoMode){$('sec-dashboard').innerHTML=renderCampoDashboard(D);return;}
if(D.settings.vetMode){showVetDashboard();return;}
const today=todayStr();const snap=computeKpiSnapshot();
const prevSnap=D.kpiSnapshots.length>0?D.kpiSnapshots[D.kpiSnapshots.length-1]:null;
const alerts=getAlerts(D);
let h=`<div class="page-header"><h2>${t('dash_title')}</h2><div class="btn-group"><button class="btn btn-secondary" onclick="saveKpiSnapshot()">${t('dash_snapshot')}</button><span>${sanitizeHTML(D.farm.name)}</span></div></div><div class="kpi-grid">`;
h+=kpi(t('kpi_today'),fmtNum(snap.eggsToday),'','')+kpi(t('kpi_henday'),fmtNum(snap.henDay,1)+'%',fmtNum(snap.activeHens)+' '+t('kpi_active_hens').toLowerCase()+(prevSnap?snapshotDelta(snap.henDay,prevSnap.henDay):''),snap.henDay<50?'danger':snap.henDay<70?'warning':'');
h+=kpi(t('kpi_fcr'),snap.fcr>0?fmtNum(snap.fcr,2):'-',t('fcr_unit')+(prevSnap?snapshotDelta(-snap.fcr,-prevSnap.fcr):''),snap.fcr>3?'danger':snap.fcr>2.5?'warning':'');
h+=kpi(t('kpi_mortality'),fmtNum(snap.mortality,1)+'%',''+(prevSnap?snapshotDelta(-snap.mortality,-prevSnap.mortality):''),snap.mortality>5?'danger':snap.mortality>3?'warning':'');
h+=kpi(t('kpi_cost_egg'),fmtMoney(snap.costPerEgg),''+(prevSnap?snapshotDelta(-snap.costPerEgg,-prevSnap.costPerEgg):''),'accent');
h+=kpi(t('kpi_income_net'),fmtMoney(snap.netIncome),today.substring(0,7)+(prevSnap?snapshotDelta(snap.netIncome,prevSnap.netIncome):''),snap.netIncome<0?'danger':'secondary');
h+=kpi(t('kpi_active_hens'),fmtNum(snap.activeHens),snap.totalFlocks+' '+t('kpi_active_flocks').toLowerCase());
h+=kpi(t('kpi_alerts'),alerts.length.toString(),alerts.length>0?'⚠':'✓',alerts.length>0?'warning':'');
h+='</div>';
if(alerts.length){h+=`<div class="card"><h3>${t('dash_alerts')}</h3>`;alerts.forEach(a=>{h+=`<div class="alert-card alert-${sanitizeHTML(a.type)}">${sanitizeHTML(a.icon)} ${a.msg}</div>`;});h+='</div>';}
// Recommendations
const recs=getRecommendations(D);
if(recs.length){h+=`<div class="rec-card"><h3>💡 ${t('rec_title')}</h3>`;
recs.forEach(r=>{h+=`<div class="rec-item"><span class="rec-priority ${r.priority}">${r.priority.toUpperCase()}</span><span>${r.icon} ${r.msg}</span></div>`;});
h+='</div>';}
// Weather widget
if(D.farm.owmApiKey&&D.farm.lat!==null){
h+='<div id="weather-widget"><div class="weather-widget"><p style="color:var(--text-light)">'+t('weather_title')+'...</p></div></div>';
}else{
h+=`<div class="card" style="background:var(--primary-fill)"><p style="color:var(--text-light)">${t('weather_no_key')} <a href="javascript:nav('config')" style="color:var(--primary)">${t('cfg_title')}</a></p></div>`;
}
h+=`<div class="card"><h3>${t('dash_trend')}</h3><div class="chart-container"><canvas id="chart-trend"></canvas></div></div>`;
if(D.kpiSnapshots.length>1){h+=`<div class="card"><h3>${t('dash_kpi_history')} (${D.kpiSnapshots.length} ${t('snapshots')})</h3><div class="table-wrap"><table><thead><tr><th>${t('date')}</th><th>Hen-Day</th><th>FCR</th><th>${t('kpi_mortality')}</th><th>${t('kpi_cost_egg')}</th><th>${t('kpi_income_net')}</th><th>${t('kpi_active_hens')}</th></tr></thead><tbody>`;
D.kpiSnapshots.slice(-10).reverse().forEach((s,i,arr)=>{const prev=arr[i+1]||null;
h+=`<tr><td>${fmtDate(s.date)}</td><td>${fmtNum(s.henDay,1)}%${prev?snapshotDelta(s.henDay,prev.henDay):''}</td>
<td>${fmtNum(s.fcr,2)}</td><td>${fmtNum(s.mortality,1)}%</td><td>${fmtMoney(s.costPerEgg)}</td>
<td>${fmtMoney(s.netIncome)}</td><td>${fmtNum(s.activeHens)}</td></tr>`;});
h+='</tbody></table></div></div>';}
h+=renderIntegrityWidget(D);
$('sec-dashboard').innerHTML=h;destroyCharts();renderTrendChart(D);fetchWeather();
}
function kpi(label,value,sub,cls=''){return `<div class="kpi-card ${cls}"><div class="kpi-label">${label}</div><div class="kpi-value">${value}</div><div class="kpi-sub">${sub||''}</div></div>`;}
function renderTrendChart(D){
const c=document.getElementById('chart-trend');if(!c)return;
const labels=[],dE=[],dH=[];
for(let i=29;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().substring(0,10);
labels.push(ds.substring(5));const dp=D.dailyProduction.filter(p=>p.date===ds);
const eggs=dp.reduce((s,p)=>s+(p.eggsCollected||0),0);dE.push(eggs);const h=activeHens();dH.push(h>0?((eggs/h)*100):0);}
CHARTS.trend=new Chart(c,{type:'line',data:{labels,datasets:[
{label:t('prod_eggs'),data:dE,borderColor:themeColor('--primary'),backgroundColor:themeRgba(.1),fill:true,tension:.3,yAxisID:'y'},
{label:t('kpi_henday'),data:dH,borderColor:'#FF8F00',backgroundColor:'transparent',borderDash:[5,5],tension:.3,yAxisID:'y1'}
]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
scales:{y:{position:'left',title:{display:true,text:t('prod_eggs')}},y1:{position:'right',title:{display:true,text:'%'},grid:{drawOnChartArea:false},min:0,max:100}}}});
}

// ============ FLOCKS ============
function renderFlocks(){
const D=loadData();let h=`<div class="page-header"><h2>${t('flock_title')}</h2><button class="btn btn-primary" onclick="showFlockForm()">${t('flock_add')}</button></div>`;
if(!D.flocks.length){h+=emptyState('🐔',t('no_data'),t('flock_add'),'showFlockForm()');}
else{
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('flock_name')}</th><th>${t('flock_breed')}</th><th>${t('flock_count')}</th><th>${t('flock_current')}</th><th>${t('flock_age')}</th><th>${t('lc_current_stage')}</th><th>${t('flock_status')}</th><th>${t('flock_health')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.flocks.forEach(f=>{const age=flockAge(f);const cur=activeHensByFlock(f.id);const hs=healthScore(f.id);const lc=flockLifecycleStage(f);
const bi=breedInfo(f.breed||f.targetCurve);
h+=`<tr><td><strong>${sanitizeHTML(f.name)}</strong></td><td>${sanitizeHTML(breedName(f.breed||f.targetCurve))}${bi&&bi.eggColor!=='-'?'<br><small style="color:var(--text-light)">'+sanitizeHTML(bi.eggColor)+'</small>':''}</td><td>${fmtNum(f.count)}</td><td>${fmtNum(cur)}</td>
<td>${age.weeks} ${t('flock_weeks')} (${age.days} ${t('flock_days')})</td>
<td><span style="background:${lc.color};padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600">${lc.icon} ${t(lc.key)}</span></td>
<td>${statusBadge(f.status)}</td><td>${healthBadge(hs)}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showFlockForm('${escapeAttr(f.id)}')">${t('edit')}</button>
<button class="btn btn-sm" style="background:var(--accent);color:#fff" onclick="showFlockRoadmap('${escapeAttr(f.id)}')">${t('flock_roadmap')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteFlock('${escapeAttr(f.id)}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';}
$('sec-lotes').innerHTML=h;
}
function showFlockRoadmap(fid){
const D=loadData();const f=D.flocks.find(x=>x.id===fid);if(!f)return;
const age=flockAge(f);const currentLC=flockLifecycleStage(f);
let h=`<h3 style="margin-bottom:8px">${sanitizeHTML(f.name)} — ${t('flock_lifecycle')}</h3>
<p style="color:var(--text-light);margin-bottom:16px">${t('flock_age')}: ${age.weeks} ${t('flock_weeks')} | ${t('lc_current_stage')}: ${currentLC.icon} ${t(currentLC.key)}</p>`;
h+='<div class="lifecycle-bar">';
const totalWeeks=80;
LIFECYCLE.forEach(l=>{
const w=Math.min(l.weekEnd,totalWeeks)-l.weekStart;const pct=(w/totalWeeks*100);
if(pct<=0)return;
const isCurrent=l.stage===currentLC.stage;
h+=`<div class="lifecycle-stage${isCurrent?' current':''}" style="width:${pct}%;background:${l.color};${isCurrent?'font-weight:800':''}" title="${t(l.key)}: ${l.weekStart}-${l.weekEnd} ${t('flock_weeks')}">${l.icon} ${t(l.key)}</div>`;
});h+='</div>';
h+='<div class="lifecycle-detail">';
LIFECYCLE.forEach(l=>{const isCurrent=l.stage===currentLC.stage;
h+=`<div class="lifecycle-card" style="background:${l.color};${isCurrent?'box-shadow:0 0 0 3px var(--primary)':''}">
<div class="lc-icon">${l.icon}</div><div class="lc-name">${t(l.key)}</div>
<div class="lc-weeks">${t('lc_weeks')}: ${l.weekStart}-${l.weekEnd===999?'80+':l.weekEnd}</div>
<div class="lc-info"><strong>${t('lc_feed')}:</strong> ${l.feed==='-'?'-':t(l.feed)}<br><strong>${t('lc_temp')}:</strong> ${l.temp}<br>
<strong>${t('lc_prod_label')}:</strong> ${l.prod.startsWith('lc_')?t(l.prod):l.prod}<br><strong>${t('lc_milestone')}:</strong> ${t(l.milestones)}</div></div>`;
});h+='</div>';
// Vaccine timeline for this flock
const vaccines=D.vaccines.filter(v=>v.flockId===fid).sort((a,b)=>a.scheduledDate.localeCompare(b.scheduledDate));
if(vaccines.length){h+=`<h3 style="margin-top:16px">${t('san_vaccines')}</h3><div class="table-wrap" style="margin-top:8px"><table><thead><tr><th>${t('vac_vaccine')}</th><th>${t('vac_scheduled')}</th><th>${t('vac_route')}</th><th>${t('status')}</th></tr></thead><tbody>`;
vaccines.forEach(v=>{h+=`<tr><td>${sanitizeHTML(v.vaccineName)}</td><td>${fmtDate(v.scheduledDate)}</td><td>${t(v.route)}</td><td>${statusBadge(v.status==='applied'?'applied':v.scheduledDate<todayStr()?'overdue':'pending')}</td></tr>`;});
h+='</tbody></table></div>';}
openModal(t('flock_lifecycle')+' — '+sanitizeHTML(f.name),h);
}
function showFlockForm(id){
const D=loadData();const f=id?D.flocks.find(x=>x.id===id):null;
openModal(f?t('flock_edit'):t('flock_add'),`
<div class="form-row"><div class="form-group"><label>${t('flock_name')}</label><input id="f-name" value="${f?escapeAttr(f.name):''}"></div>
<div class="form-group"><label>${t('flock_breed')}</label><select id="f-breed" onchange="onBreedSelect()">
${COMMERCIAL_BREEDS.map(b=>`<option value="${b.id}"${(f&&(f.breed===b.id||f.targetCurve===b.id))?' selected':''}>${b.name}${b.type!=='-'?' ('+b.type+')':''}</option>`).join('')}
</select></div></div>
<div id="breed-info" style="background:var(--card-bg,#f0f4f8);border-radius:8px;padding:8px 12px;margin:-4px 0 8px;font-size:.85em;display:${f?'block':'block'}"></div>
<div class="form-row"><div class="form-group"><label>${t('flock_housing')}</label><select id="f-housing">
<option value="floor"${f&&f.housingType==='floor'?' selected':''}>${t('flock_housing_floor')}</option>
<option value="cage"${f&&f.housingType==='cage'?' selected':''}>${t('flock_housing_cage')}</option>
<option value="free"${f&&f.housingType==='free'?' selected':''}>${t('flock_housing_free')}</option></select></div>
<div class="form-group"><label>${t('flock_egg_color')}</label><input id="f-egg-color" readonly style="background:var(--card-bg,#f0f4f8);cursor:default"></div></div>
<div class="form-row"><div class="form-group"><label>${t('flock_count')}</label><input type="number" id="f-count" value="${f?f.count:''}"></div>
<div class="form-group"><label>${t('flock_status')}</label><select id="f-status">
<option value="cria"${f&&f.status==='cria'?' selected':''}>${t('flock_status_cria')}</option>
<option value="recria"${f&&f.status==='recria'?' selected':''}>${t('flock_status_recria')}</option>
<option value="produccion"${(!f||f.status==='produccion')?' selected':''}>${t('flock_status_produccion')}</option>
<option value="descarte"${f&&f.status==='descarte'?' selected':''}>${t('flock_status_descarte')}</option></select></div></div>
<div class="form-row"><div class="form-group"><label>${t('flock_birthdate')}</label><input type="date" id="f-birth" value="${f?f.birthDate:''}"></div>
<div class="form-group"><label>${t('flock_purchase_date')}</label><input type="date" id="f-purchase" value="${f?f.purchaseDate:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('flock_supplier')}</label><select id="f-supplier">${supplierSelect(f?f.supplier:'')}</select></div>
<div class="form-group"><label>${t('flock_cost')}</label><input type="number" id="f-cost" value="${f?f.cost:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('flock_curve_adjust')||'Curve Adjust'} (0.5-1.5)</label><input type="number" id="f-curve" value="${f&&f.curveAdjust!=null?f.curveAdjust:1.0}" min="0.5" max="1.5" step="0.05">
<small style="color:var(--text-light);display:block;margin-top:4px">${t('flock_curve_tip')||'1.0=standard, 0.85=tropical, 1.1=temperate'}</small></div></div>
<div class="form-group"><label>${t('flock_notes')}</label><textarea id="f-notes">${f?escapeAttr(f.notes||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveFlock('${id||''}')">${t('save')}</button></div>`);
setTimeout(onBreedSelect,50);
}
function breedName(id){const b=COMMERCIAL_BREEDS.find(x=>x.id===id);return b?b.name:(id||'-');}
function breedInfo(id){return COMMERCIAL_BREEDS.find(x=>x.id===id)||null;}
function onBreedSelect(){
const sel=$('f-breed');if(!sel)return;const bid=sel.value;
const b=COMMERCIAL_BREEDS.find(x=>x.id===bid);
const info=$('breed-info');const ec=$('f-egg-color');
if(b&&b.type!=='-'){
info.innerHTML=`<strong>${sanitizeHTML(b.name)}</strong> — ${sanitizeHTML(String(b.eggsYear))} huevos/año · Peso: ${sanitizeHTML(String(b.eggWeight))} · FCR: ${sanitizeHTML(String(b.fcr))}<br><span style="color:var(--text-secondary,#666)">${sanitizeHTML(b.notes)}</span>`;
info.style.display='block';if(ec)ec.value=b.eggColor;
}else{info.innerHTML='';info.style.display='none';if(ec)ec.value='';}
}
function saveFlock(id){
clearFieldErrors();
const D=loadData();const breedId=$('f-breed').value;
const o={name:$('f-name').value,breed:breedId,count:parseInt($('f-count').value)||0,
status:$('f-status').value,housingType:$('f-housing')?.value||'floor',targetCurve:breedId,
curveAdjust:parseFloat($('f-curve')?.value)||1.0,
birthDate:$('f-birth').value,purchaseDate:$('f-purchase').value,
supplier:$('f-supplier').value,cost:parseFloat($('f-cost').value)||0,notes:$('f-notes').value};
const v=validateForm({'f-name':{value:o.name,rules:{required:true,maxLength:100}},'f-count':{value:$('f-count').value,rules:{required:true,numeric:true,min:1}},'f-birth':{value:o.birthDate,rules:{required:true,date:true}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(!_vengWarningsShown){const vr=VENG.gate.flock(o,D);if(!vr.ok){vr.errors.forEach(e=>{if(e.field)showFieldError(e.field,e.msg);});showVengPanel(vr.errors,vr.warnings);return;}if(vr.warnings.length){showVengPanel([],vr.warnings);_vengWarningsShown=true;return;}}_vengWarningsShown=false;
if(id){const i=D.flocks.findIndex(f=>f.id===id);if(i>=0){logAudit('update','flocks','Edit flock: '+o.name,D.flocks[i],o);D.flocks[i]={...D.flocks[i],...o};}}
else{o.id=genId();D.flocks.push(o);if(o.birthDate)generateVaccineCalendar(o);
if(o.cost>0){const exp={id:genId(),date:o.purchaseDate||todayStr(),category:'bird_purchase',description:t('flock_name')+': '+o.name+' ('+o.count+' '+t('flock_count')+')',amount:o.cost,notes:''};D.finances.expenses.push(exp);logAudit('create','expenses','Auto expense from flock: '+o.name,null,exp);}
logAudit('create','flocks','New flock: '+o.name,null,o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFlocks();
}
async function deleteFlock(id){
if(!await showConfirm(t('confirm_delete')))return;const D=loadData();
const old=D.flocks.find(f=>f.id===id);
D.flocks=D.flocks.filter(f=>f.id!==id);D.dailyProduction=D.dailyProduction.filter(p=>p.flockId!==id);
D.vaccines=D.vaccines.filter(v=>v.flockId!==id);D.medications=D.medications.filter(m=>m.flockId!==id);
D.outbreaks=D.outbreaks.filter(o=>o.flockId!==id);D.feed.consumption=D.feed.consumption.filter(c=>c.flockId!==id);
D.traceability.batches=D.traceability.batches.filter(b=>b.flockId!==id);D.productionPlans=(D.productionPlans||[]).filter(p=>p.flockId!==id);
logAudit('delete','flocks','Delete flock: '+(old?old.name:id),old,null);
saveData(D);toast(t('cfg_saved'));renderFlocks();
}

// ============ PRODUCTION ============
function renderProduction(){
const D=loadData();let h=`<div class="page-header"><h2>${t('prod_title')}</h2><button class="btn btn-primary" onclick="showProdForm()">${t('prod_add')}</button></div>`;
h+=`<div class="filter-bar"><select onchange="filterProd()" id="pf-flock">${flockSelect('',true)}</select>
<input type="date" id="pf-from" onchange="filterProd()"><input type="date" id="pf-to" onchange="filterProd()"></div>`;
if(!D.dailyProduction.length){h+=emptyState('🥚',t('no_data'),t('prod_add'),'showProdForm()');}
else{h+='<div id="prod-table"></div>';}
$('sec-produccion').innerHTML=h;if(D.dailyProduction.length)filterProd();
}
function filterProd(){
const D=loadData();const fid=$('pf-flock')?.value||'';const fr=$('pf-from')?.value||'';const to=$('pf-to')?.value||'';
let recs=D.dailyProduction.sort((a,b)=>b.date.localeCompare(a.date));
if(fid)recs=recs.filter(r=>r.flockId===fid);if(fr)recs=recs.filter(r=>r.date>=fr);if(to)recs=recs.filter(r=>r.date<=to);
const pg=paginate(recs,_pageState.production||1,PAGE_SIZE);
let h='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('prod_flock')}</th><th>${t('prod_eggs')}</th><th>S/M/L/XL/J</th><th>${t('prod_egg_type')}</th><th>${t('prod_market')}</th><th>${t('prod_broken')}</th><th>${t('prod_deaths')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
pg.items.forEach(p=>{const f=D.flocks.find(x=>x.id===p.flockId);
const etype=p.eggType?t('prod_type_'+p.eggType):'-';
const mchan=p.marketChannel?t('prod_market_'+p.marketChannel):'-';
h+=`<tr><td>${fmtDate(p.date)}</td><td>${f?sanitizeHTML(f.name):'-'}</td><td><strong>${fmtNum(p.eggsCollected)}</strong></td>
<td>${[p.eggsS||0,p.eggsM||0,p.eggsL||0,p.eggsXL||0,p.eggsJumbo||0].join('/')}</td>
<td>${etype}</td><td>${mchan}</td>
<td>${fmtNum(p.eggsBroken||0)}</td><td>${p.deaths?'<span style="color:var(--danger)">'+p.deaths+'</span>':'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showProdForm('${escapeAttr(p.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteProd('${escapeAttr(p.id)}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';
h+=paginationControls('production',pg.page,pg.totalPages,function(p){_pageState.production=p;filterProd();});
const w=$('prod-table');if(w)w.innerHTML=h;
}
function showProdForm(id){
const D=loadData();const p=id?D.dailyProduction.find(x=>x.id===id):null;
openModal(p?t('edit'):t('prod_add'),`
<div class="form-row"><div class="form-group"><label>${t('prod_date')}</label><input type="date" id="p-date" value="${p?p.date:todayStr()}"></div>
<div class="form-group"><label>${t('prod_flock')}</label><select id="p-flock" onchange="onProdFlockChange()">${flockSelect(p?p.flockId:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('prod_eggs')}</label><input type="number" id="p-eggs" value="${p?p.eggsCollected:''}" min="0"></div>
<div class="form-group"><label>${t('prod_broken')}</label><input type="number" id="p-broken" value="${p?p.eggsBroken||'':''}" min="0"></div></div>
<div class="form-row-3"><div class="form-group"><label>${t('prod_size_s')}</label><input type="number" id="p-s" value="${p?p.eggsS||'':''}" min="0"></div>
<div class="form-group"><label>${t('prod_size_m')}</label><input type="number" id="p-m" value="${p?p.eggsM||'':''}" min="0"></div>
<div class="form-group"><label>${t('prod_size_l')}</label><input type="number" id="p-l" value="${p?p.eggsL||'':''}" min="0"></div></div>
<div class="form-row-3"><div class="form-group"><label>${t('prod_size_xl')}</label><input type="number" id="p-xl" value="${p?p.eggsXL||'':''}" min="0"></div>
<div class="form-group"><label>${t('prod_size_jumbo')}</label><input type="number" id="p-jumbo" value="${p?p.eggsJumbo||'':''}" min="0"></div>
<div class="form-group"><label>${t('prod_yolk')}</label><input type="number" id="p-yolk" value="${p?p.yolkScore||'':''}" min="1" max="10"></div></div>
<div class="form-row"><div class="form-group"><label>${t('prod_shell')}</label><select id="p-shell">
<option value="">--</option><option value="blanco"${p&&p.shellColor==='blanco'?' selected':''}>${t('prod_shell_white')}</option>
<option value="marron"${p&&p.shellColor==='marron'?' selected':''}>${t('prod_shell_brown')}</option>
<option value="crema"${p&&p.shellColor==='crema'?' selected':''}>${t('prod_shell_cream')}</option></select></div>
<div class="form-group"><label>${t('prod_deaths')}</label><input type="number" id="p-deaths" value="${p?p.deaths||'':''}" min="0"></div></div>
<div class="form-row"><div class="form-group"><label>${t('prod_egg_type')}</label><select id="p-etype">
<option value="conventional"${p&&p.eggType==='conventional'?' selected':''}>${t('prod_type_conventional')}</option>
<option value="free_range"${p&&p.eggType==='free_range'?' selected':''}>${t('prod_type_free_range')}</option>
<option value="organic"${p&&p.eggType==='organic'?' selected':''}>${t('prod_type_organic')}</option>
<option value="pasture_raised"${p&&p.eggType==='pasture_raised'?' selected':''}>${t('prod_type_pasture')}</option>
<option value="decorative"${p&&p.eggType==='decorative'?' selected':''}>${t('prod_type_decorative')}</option></select></div>
<div class="form-group"><label>${t('prod_market')}</label><select id="p-market">
<option value="wholesale"${p&&p.marketChannel==='wholesale'?' selected':''}>${t('prod_market_wholesale')}</option>
<option value="supermarket"${p&&p.marketChannel==='supermarket'?' selected':''}>${t('prod_market_supermarket')}</option>
<option value="restaurant"${p&&p.marketChannel==='restaurant'?' selected':''}>${t('prod_market_restaurant')}</option>
<option value="direct"${p&&p.marketChannel==='direct'?' selected':''}>${t('prod_market_direct')}</option>
<option value="export"${p&&p.marketChannel==='export'?' selected':''}>${t('prod_market_export')}</option>
<option value="pasteurized"${p&&p.marketChannel==='pasteurized'?' selected':''}>${t('prod_market_pasteurized')}</option></select></div></div>
<div class="form-group"><label>${t('prod_death_cause')}</label><select id="p-cause">${catalogSelect(CATALOGS.deathCauses,p?p.deathCause||'':'')}</select></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="p-notes">${p?escapeAttr(p.notes||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveProd('${id||''}')">${t('save')}</button></div>`);
if(!p)setTimeout(onProdFlockChange,50);
}
function saveProd(id){
clearFieldErrors();
const D=loadData();const o={date:$('p-date').value,flockId:$('p-flock').value,
eggsCollected:parseInt($('p-eggs').value)||0,eggsBroken:parseInt($('p-broken').value)||0,
eggsS:parseInt($('p-s').value)||0,eggsM:parseInt($('p-m').value)||0,eggsL:parseInt($('p-l').value)||0,
eggsXL:parseInt($('p-xl').value)||0,eggsJumbo:parseInt($('p-jumbo').value)||0,
shellColor:$('p-shell').value,yolkScore:parseInt($('p-yolk').value)||0,
deaths:parseInt($('p-deaths').value)||0,deathCause:$('p-cause').value,
eggType:$('p-etype')?.value||'conventional',marketChannel:$('p-market')?.value||'wholesale',
notes:$('p-notes').value};
const v=validateForm({'p-date':{value:o.date,rules:{required:true,date:true}},'p-flock':{value:o.flockId,rules:{required:true}},'p-eggs':{value:$('p-eggs').value,rules:{required:true,numeric:true,min:0}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(!_vengWarningsShown){const vr=VENG.gate.production(o,D);if(!vr.ok){vr.errors.forEach(e=>{if(e.field)showFieldError(e.field,e.msg);});showVengPanel(vr.errors,vr.warnings);return;}if(vr.warnings.length){showVengPanel([],vr.warnings);_vengWarningsShown=true;return;}}_vengWarningsShown=false;
if(id){const i=D.dailyProduction.findIndex(p=>p.id===id);if(i>=0){logAudit('update','production','Edit production',D.dailyProduction[i],o);D.dailyProduction[i]={...D.dailyProduction[i],...o};}}
else{o.id=genId();D.dailyProduction.push(o);logAudit('create','production','New production: '+o.eggsCollected+' eggs',null,o);
if(o.eggsCollected>0){const sizes=[{k:'eggsS',t:'S'},{k:'eggsM',t:'M'},{k:'eggsL',t:'L'},{k:'eggsXL',t:'XL'},{k:'eggsJumbo',t:'Jumbo'}];
let distributed=false;sizes.forEach(s=>{if(o[s.k]>0){D.inventory.push({id:genId(),date:o.date,flockId:o.flockId,eggType:s.t,qtyIn:o[s.k],qtyOut:0,source:'production',ref:o.id});distributed=true;}});
if(!distributed)D.inventory.push({id:genId(),date:o.date,flockId:o.flockId,eggType:'M',qtyIn:o.eggsCollected,qtyOut:0,source:'production',ref:o.id});}}
saveData(D);closeModal();toast(t('cfg_saved'));renderProduction();
}
async function deleteProd(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();const old=D.dailyProduction.find(p=>p.id===id);logAudit('delete','production','Delete production',old,null);D.dailyProduction=D.dailyProduction.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderProduction();}

// === SANIDAD MODULE ===
function renderSanidad(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('san_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentSanidadTab==='vaccines'?' active':''}" onclick="currentSanidadTab='vaccines';renderSanidad()">💉 ${t('san_vaccines')}</div>
<div class="tab${currentSanidadTab==='medications'?' active':''}" onclick="currentSanidadTab='medications';renderSanidad()">💊 ${t('san_medications')}</div>
<div class="tab${currentSanidadTab==='outbreaks'?' active':''}" onclick="currentSanidadTab='outbreaks';renderSanidad()">🦠 ${t('san_outbreaks')}</div>
<div class="tab${currentSanidadTab==='stress'?' active':''}" onclick="currentSanidadTab='stress';renderSanidad()">⚡ ${t('stress_title')}</div></div>`;
if(currentSanidadTab==='vaccines')h+=renderVaccinesTab(D);
else if(currentSanidadTab==='medications')h+=renderMedicationsTab(D);
else if(currentSanidadTab==='stress')h+=renderStressEventsTab(D);
else h+=renderOutbreaksTab(D);
$('sec-sanidad').innerHTML=h;
}
function renderVaccinesTab(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('vac_title')}</h3><div class="btn-group">
<button class="btn btn-secondary btn-sm" onclick="showGenVaccines()">${t('vac_generate')}</button>
<button class="btn btn-primary btn-sm" onclick="showVaccineForm()">${t('vac_add')}</button></div></div>`;
h+=`<div class="filter-bar"><select id="vf-flock" onchange="renderSanidad()">${flockSelect('',true)}</select>
<select id="vf-status" onchange="renderSanidad()"><option value="">${t('all')}</option><option value="pending">${t('vac_pending')}</option><option value="overdue">${t('vac_overdue')}</option><option value="applied">${t('vac_applied_status')}</option></select></div>`;
const fid=document.getElementById('vf-flock')?.value||'';const st=document.getElementById('vf-status')?.value||'';
let vacs=D.vaccines.sort((a,b)=>a.scheduledDate.localeCompare(b.scheduledDate));
if(fid)vacs=vacs.filter(v=>v.flockId===fid);
const today=todayStr();
vacs=vacs.map(v=>{const eff=v.status==='applied'?'applied':v.scheduledDate<today?'overdue':'pending';return{...v,effectiveStatus:eff};});
if(st)vacs=vacs.filter(v=>v.effectiveStatus===st);
if(!vacs.length)return h+emptyState('💉',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('prod_flock')}</th><th>${t('vac_vaccine')}</th><th>${t('vac_route')}</th><th>${t('vac_scheduled')}</th><th>${t('vac_applied')}</th><th>${t('vac_batch')}</th><th>${t('status')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
vacs.forEach(v=>{const f=D.flocks.find(x=>x.id===v.flockId);
h+=`<tr><td>${f?sanitizeHTML(f.name):'-'}</td><td>${sanitizeHTML(v.vaccineName)}</td><td>${v.route?t(v.route):'-'}</td><td>${fmtDate(v.scheduledDate)}</td>
<td>${v.appliedDate?fmtDate(v.appliedDate):'-'}</td><td>${sanitizeHTML(v.batchNumber||'-')}</td>
<td>${statusBadge(v.effectiveStatus)}</td>
<td><div class="btn-group">${v.effectiveStatus!=='applied'?`<button class="btn btn-primary btn-sm" onclick="markVaccineApplied('${escapeAttr(v.id)}')">${t('vac_mark_applied')}</button>`:''}
<button class="btn btn-secondary btn-sm" onclick="showVaccineForm('${escapeAttr(v.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteVaccine('${escapeAttr(v.id)}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showGenVaccines(){
const D=loadData();const flocks=D.flocks.filter(f=>f.birthDate&&f.status!=='descarte');
if(!flocks.length){toast(t('no_flocks_birthdate'),true);return;}
let body=`<p>${t('vac_select_flocks')}</p>`;
flocks.forEach(f=>{body+=`<div class="checklist-item"><input type="checkbox" id="gv-${escapeAttr(f.id)}" checked><span>${sanitizeHTML(f.name)} (${fmtDate(f.birthDate)})</span></div>`;});
body+=`<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="doGenVaccines()">${t('vac_generate')}</button></div>`;
openModal(t('vac_generate'),body);
}
function doGenVaccines(){
const D=loadData();D.flocks.filter(f=>f.birthDate&&f.status!=='descarte').forEach(f=>{
const cb=document.getElementById('gv-'+f.id);if(cb&&cb.checked)generateVaccineCalendar(f);});
closeModal();toast(t('cfg_saved'));renderSanidad();
}
function showVaccineForm(id){
const D=loadData();const v=id?D.vaccines.find(x=>x.id===id):null;
openModal(v?t('edit'):t('vac_add'),`
<div class="form-row"><div class="form-group"><label>${t('prod_flock')}</label><select id="v-flock">${flockSelect(v?v.flockId:'')}</select></div>
<div class="form-group"><label>${t('vac_vaccine')}</label><select id="v-name">${catalogSelect(VACCINE_SCHEDULE.map(vs=>vs.name),v?v.vaccineName:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('vac_route')}</label><select id="v-route">
<option value="">--</option>
<option value="vac_route_injection"${v&&v.route==='vac_route_injection'?' selected':''}>${t('vac_route_injection')}</option>
<option value="vac_route_ocular"${v&&v.route==='vac_route_ocular'?' selected':''}>${t('vac_route_ocular')}</option>
<option value="vac_route_water"${v&&v.route==='vac_route_water'?' selected':''}>${t('vac_route_water')}</option>
<option value="vac_route_wing"${v&&v.route==='vac_route_wing'?' selected':''}>${t('vac_route_wing')}</option>
</select></div>
<div class="form-group"><label>${t('vac_batch')}</label><input id="v-batch" value="${v?escapeAttr(v.batchNumber):''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('vac_scheduled')}</label><input type="date" id="v-sched" value="${v?v.scheduledDate:''}"></div>
<div class="form-group"><label>${t('vac_applied')}</label><input type="date" id="v-applied" value="${v?v.appliedDate:''}"></div></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="v-notes">${v?escapeAttr(v.notes||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveVaccine('${id||''}')">${t('save')}</button></div>`);
}
function saveVaccine(id){
clearFieldErrors();
const D=loadData();const o={flockId:$('v-flock').value,vaccineName:$('v-name').value,route:$('v-route').value,
batchNumber:$('v-batch').value,scheduledDate:$('v-sched').value,appliedDate:$('v-applied').value,
notes:$('v-notes').value,status:$('v-applied').value?'applied':'pending'};
const v=validateForm({'v-flock':{value:o.flockId,rules:{required:true}},'v-name':{value:o.vaccineName,rules:{required:true}},'v-sched':{value:o.scheduledDate,rules:{required:true,date:true}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.vaccines.findIndex(v=>v.id===id);if(i>=0)D.vaccines[i]={...D.vaccines[i],...o};}
else{o.id=genId();D.vaccines.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderSanidad();
}
function markVaccineApplied(id){
const D=loadData();const v=D.vaccines.find(x=>x.id===id);if(!v)return;
v.appliedDate=todayStr();v.status='applied';saveData(D);toast(t('cfg_saved'));renderSanidad();
}
async function deleteVaccine(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.vaccines=D.vaccines.filter(v=>v.id!==id);saveData(D);toast(t('cfg_saved'));renderSanidad();}

function renderMedicationsTab(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('med_title')}</h3>
<button class="btn btn-primary btn-sm" onclick="showMedForm()">${t('med_add')}</button></div>`;
if(!D.medications.length)return h+emptyState('💊',t('no_data'));
const today=todayStr();
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('prod_flock')}</th><th>${t('med_name')}</th><th>${t('med_reason')}</th><th>${t('med_dosage')}</th><th>${t('med_start')}</th><th>${t('med_end')}</th><th>${t('med_withdrawal')}</th><th>${t('med_withdrawal_end')}</th><th>${t('status')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.medications.forEach(m=>{const f=D.flocks.find(x=>x.id===m.flockId);
const inWD=m.withdrawalEnd&&m.withdrawalEnd>=today;
h+=`<tr><td>${f?sanitizeHTML(f.name):'-'}</td><td>${sanitizeHTML(m.name)}</td><td>${sanitizeHTML(m.reason||'-')}</td><td>${sanitizeHTML(m.dosage||'-')}</td>
<td>${fmtDate(m.startDate)}</td><td>${fmtDate(m.endDate)}</td><td>${m.withdrawalDays||'-'}</td>
<td>${fmtDate(m.withdrawalEnd)}</td>
<td>${inWD?'<span class="badge badge-warning">'+t('med_in_withdrawal')+'</span>':'<span class="badge badge-success">OK</span>'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showMedForm('${escapeAttr(m.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteMed('${escapeAttr(m.id)}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showMedForm(id){
const D=loadData();const m=id?D.medications.find(x=>x.id===id):null;
openModal(m?t('edit'):t('med_add'),`
<div class="form-row"><div class="form-group"><label>${t('prod_flock')}</label><select id="m-flock">${flockSelect(m?m.flockId:'')}</select></div>
<div class="form-group"><label>${t('med_name')}</label><select id="m-name" onchange="onMedSelect()">${catalogSelect(CATALOGS.medications,m?m.name:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('med_reason')}</label><select id="m-reason">${catalogSelect(CATALOGS.diseases,m?m.reason||'':'')}</select></div>
<div class="form-group"><label>${t('med_dosage')}</label><input id="m-dosage" value="${m?escapeAttr(m.dosage||''):''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('med_start')}</label><input type="date" id="m-start" value="${m?m.startDate:''}"></div>
<div class="form-group"><label>${t('med_end')}</label><input type="date" id="m-end" value="${m?m.endDate:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('med_withdrawal')}</label><input type="number" id="m-wd" value="${m?m.withdrawalDays||'':''}" min="0"></div>
<div class="form-group"><label>${t('notes')}</label><input id="m-notes" value="${m?escapeAttr(m.notes||''):''}"></div></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveMed('${id||''}')">${t('save')}</button></div>`);
}
function saveMed(id){
clearFieldErrors();
const D=loadData();const o={flockId:$('m-flock').value,name:$('m-name').value,reason:$('m-reason').value,
dosage:$('m-dosage').value,startDate:$('m-start').value,endDate:$('m-end').value,
withdrawalDays:parseInt($('m-wd').value)||0,notes:$('m-notes').value};
const v=validateForm({'m-flock':{value:o.flockId,rules:{required:true}},'m-name':{value:o.name,rules:{required:true}},'m-start':{value:o.startDate,rules:{required:true,date:true}},'m-dosage':{value:o.dosage,rules:{required:true}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(o.endDate&&o.withdrawalDays){const d=new Date(o.endDate+'T12:00:00');d.setDate(d.getDate()+o.withdrawalDays);o.withdrawalEnd=d.toISOString().substring(0,10);}else{o.withdrawalEnd='';}
if(id){const i=D.medications.findIndex(m=>m.id===id);if(i>=0)D.medications[i]={...D.medications[i],...o};}
else{o.id=genId();D.medications.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderSanidad();
}
async function deleteMed(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.medications=D.medications.filter(m=>m.id!==id);saveData(D);toast(t('cfg_saved'));renderSanidad();}

function renderOutbreaksTab(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('out_title')}</h3>
<button class="btn btn-primary btn-sm" onclick="showOutbreakForm()">${t('out_add')}</button></div>`;
if(!D.outbreaks.length)return h+emptyState('🦠',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('prod_flock')}</th><th>${t('out_disease')}</th><th>${t('out_start')}</th><th>${t('out_end')}</th><th>${t('out_affected')}</th><th>${t('out_deaths')}</th><th>${t('out_loss')}</th><th>${t('status')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.outbreaks.forEach(o=>{const f=D.flocks.find(x=>x.id===o.flockId);
h+=`<tr><td>${f?sanitizeHTML(f.name):'-'}</td><td>${sanitizeHTML(o.disease)}</td><td>${fmtDate(o.startDate)}</td><td>${fmtDate(o.endDate)}</td>
<td>${fmtNum(o.affected||0)}</td><td>${o.deaths?'<span style="color:var(--danger)">'+o.deaths+'</span>':'-'}</td>
<td>${fmtMoney(o.economicLoss||0)}</td><td>${statusBadge(o.status)}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showOutbreakForm('${escapeAttr(o.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteOutbreak('${escapeAttr(o.id)}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showOutbreakForm(id){
const D=loadData();const o=id?D.outbreaks.find(x=>x.id===id):null;
openModal(o?t('edit'):t('out_add'),`
<div class="form-row"><div class="form-group"><label>${t('prod_flock')}</label><select id="o-flock">${flockSelect(o?o.flockId:'')}</select></div>
<div class="form-group"><label>${t('out_disease')}</label><select id="o-disease">${catalogSelect(CATALOGS.diseases,o?o.disease:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('out_start')}</label><input type="date" id="o-start" value="${o?o.startDate:todayStr()}"></div>
<div class="form-group"><label>${t('out_end')}</label><input type="date" id="o-end" value="${o?o.endDate||'':''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('out_affected')}</label><input type="number" id="o-affected" value="${o?o.affected||'':''}" min="0"></div>
<div class="form-group"><label>${t('out_deaths')}</label><input type="number" id="o-deaths" value="${o?o.deaths||'':''}" min="0"></div></div>
<div class="form-row"><div class="form-group"><label>${t('out_loss')}</label><input type="number" id="o-loss" value="${o?o.economicLoss||'':''}" min="0"></div>
<div class="form-group"><label>${t('status')}</label><select id="o-status">
<option value="active"${o&&o.status==='active'?' selected':''}>${t('out_active')}</option>
<option value="controlled"${o&&o.status==='controlled'?' selected':''}>${t('out_controlled')}</option>
<option value="resolved"${o&&o.status==='resolved'?' selected':''}>${t('out_resolved')}</option></select></div></div>
<div class="form-group"><label>${t('out_symptoms')}</label><textarea id="o-symptoms">${o?escapeAttr(o.symptoms||''):''}</textarea></div>
<div class="form-group"><label>${t('out_treatment')}</label><textarea id="o-treatment">${o?escapeAttr(o.treatment||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveOutbreak('${id||''}')">${t('save')}</button></div>`);
}
function saveOutbreak(id){
clearFieldErrors();
const D=loadData();const o={flockId:$('o-flock').value,disease:$('o-disease').value,startDate:$('o-start').value,
endDate:$('o-end').value,affected:parseInt($('o-affected').value)||0,deaths:parseInt($('o-deaths').value)||0,
economicLoss:parseFloat($('o-loss').value)||0,status:$('o-status').value,
symptoms:$('o-symptoms').value,treatment:$('o-treatment').value};
const v=validateForm({'o-flock':{value:o.flockId,rules:{required:true}},'o-disease':{value:o.disease,rules:{required:true}},'o-start':{value:o.startDate,rules:{required:true,date:true}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.outbreaks.findIndex(x=>x.id===id);if(i>=0)D.outbreaks[i]={...D.outbreaks[i],...o};}
else{o.id=genId();D.outbreaks.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderSanidad();
}
async function deleteOutbreak(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.outbreaks=D.outbreaks.filter(o=>o.id!==id);saveData(D);toast(t('cfg_saved'));renderSanidad();}
// === END SANIDAD ===

// === FEED MODULE ===
let currentFeedTab='purchases';
function renderFeed(){
const D=loadData();
const totalPurchased=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0);
const totalConsumed=D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0);
const stock=totalPurchased-totalConsumed;
const isLow=stock<(D.settings.minFeedStock||50);
let h=`<div class="page-header"><h2>${t('feed_title')}</h2></div>`;
h+=`<div class="kpi-grid">`;
h+=kpi(t('feed_stock'),fmtNum(stock,1)+' kg','',isLow?'danger':'');
h+=kpi(t('feed_purchases'),fmtNum(totalPurchased,1)+' kg',fmtMoney(D.feed.purchases.reduce((s,p)=>s+(p.cost||0),0))+' '+t('total'));
h+=kpi(t('feed_consumption'),fmtNum(totalConsumed,1)+' kg','');
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const f30=D.feed.consumption.filter(c=>c.date>=d30s);const tF30=f30.reduce((s,c)=>s+(c.quantityKg||0),0);
const p30=D.dailyProduction.filter(p=>p.date>=d30s);const tE30=p30.reduce((s,p)=>s+(p.eggsCollected||0),0)*0.06;
const fcr=tE30>0?(tF30/tE30):0;
h+=kpi(t('kpi_fcr'),fcr>0?fmtNum(fcr,2):'-','30d',fcr>3?'danger':fcr>2.5?'warning':'');
h+='</div>';
h+=`<div class="tabs"><div class="tab${currentFeedTab==='purchases'?' active':''}" onclick="currentFeedTab='purchases';renderFeed()">📦 ${t('feed_purchases')}</div>
<div class="tab${currentFeedTab==='consumption'?' active':''}" onclick="currentFeedTab='consumption';renderFeed()">🍽️ ${t('feed_consumption')}</div></div>`;
if(currentFeedTab==='purchases')h+=renderFeedPurchases(D);
else h+=renderFeedConsumption(D);
$('sec-alimento').innerHTML=h;
}
function renderFeedPurchases(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('feed_purchases')}</h3>
<button class="btn btn-primary btn-sm" onclick="showFeedPurchaseForm()">${t('feed_add_purchase')}</button></div>`;
if(!D.feed.purchases.length)return h+emptyState('📦',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('feed_type')}</th><th>${t('feed_qty')}</th><th>${t('feed_cost')}</th><th>$/kg</th><th>${t('feed_supplier')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.feed.purchases.sort((a,b)=>b.date.localeCompare(a.date)).forEach(p=>{
const ppkg=p.quantityKg>0?(p.cost/p.quantityKg):0;
h+=`<tr><td>${fmtDate(p.date)}</td><td>${sanitizeHTML(p.type||'-')}</td><td>${fmtNum(p.quantityKg,1)}</td>
<td>${fmtMoney(p.cost)}</td><td>${fmtMoney(ppkg)}</td><td>${sanitizeHTML(p.supplier||'-')}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showFeedPurchaseForm('${escapeAttr(p.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteFeedPurchase('${escapeAttr(p.id)}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showFeedPurchaseForm(id){
const D=loadData();const p=id?D.feed.purchases.find(x=>x.id===id):null;
openModal(p?t('edit'):t('feed_add_purchase'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fp-date" value="${p?p.date:todayStr()}"></div>
<div class="form-group"><label>${t('feed_type')}</label><select id="fp-type">${feedTypeSelect(p?p.type||'':'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('feed_qty')}</label><input type="number" id="fp-qty" value="${p?p.quantityKg:''}" step="0.1" min="0"></div>
<div class="form-group"><label>${t('feed_cost')}</label><input type="number" id="fp-cost" value="${p?p.cost:''}" min="0"></div></div>
<div class="form-group"><label>${t('feed_supplier')}</label><select id="fp-sup">${supplierSelect(p?p.supplier||'':'')}</select></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveFeedPurchase('${id||''}')">${t('save')}</button></div>`);
}
function saveFeedPurchase(id){
clearFieldErrors();
const D=loadData();const o={date:$('fp-date').value,type:$('fp-type').value,
quantityKg:parseFloat($('fp-qty').value)||0,cost:parseFloat($('fp-cost').value)||0,supplier:$('fp-sup').value};
const v=validateForm({'fp-date':{value:o.date,rules:{required:true,date:true}},'fp-type':{value:o.type,rules:{required:true}},'fp-qty':{value:$('fp-qty').value,rules:{required:true,numeric:true,min:0.1}},'fp-cost':{value:$('fp-cost').value,rules:{required:true,numeric:true,min:0}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.feed.purchases.findIndex(p=>p.id===id);if(i>=0)D.feed.purchases[i]={...D.feed.purchases[i],...o};}
else{o.id=genId();D.feed.purchases.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFeed();
}
async function deleteFeedPurchase(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.feed.purchases=D.feed.purchases.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderFeed();}

function renderFeedConsumption(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('feed_consumption')}</h3>
<button class="btn btn-primary btn-sm" onclick="showFeedConsForm()">${t('feed_add_consumption')}</button></div>`;
if(!D.feed.consumption.length)return h+emptyState('🍽️',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('feed_flock')}</th><th>${t('feed_qty')}</th><th>${t('feed_type')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.feed.consumption.sort((a,b)=>b.date.localeCompare(a.date)).forEach(c=>{const f=D.flocks.find(x=>x.id===c.flockId);
h+=`<tr><td>${fmtDate(c.date)}</td><td>${f?sanitizeHTML(f.name):'-'}</td><td>${fmtNum(c.quantityKg,1)} kg</td><td>${sanitizeHTML(c.type||'-')}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showFeedConsForm('${escapeAttr(c.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteFeedCons('${escapeAttr(c.id)}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showFeedConsForm(id){
const D=loadData();const c=id?D.feed.consumption.find(x=>x.id===id):null;
openModal(c?t('edit'):t('feed_add_consumption'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fc-date" value="${c?c.date:todayStr()}"></div>
<div class="form-group"><label>${t('feed_flock')}</label><select id="fc-flock">${flockSelect(c?c.flockId:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('feed_qty')}</label><input type="number" id="fc-qty" value="${c?c.quantityKg:''}" step="0.1" min="0"></div>
<div class="form-group"><label>${t('feed_type')}</label><select id="fc-type">${feedTypeSelect(c?c.type||'':'',c?c.flockId:'')}</select></div></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveFeedCons('${id||''}')">${t('save')}</button></div>`);
}
function saveFeedCons(id){
clearFieldErrors();
const D=loadData();const o={date:$('fc-date').value,flockId:$('fc-flock').value,
quantityKg:parseFloat($('fc-qty').value)||0,type:$('fc-type').value};
const v=validateForm({'fc-date':{value:o.date,rules:{required:true,date:true}},'fc-flock':{value:o.flockId,rules:{required:true}},'fc-qty':{value:$('fc-qty').value,rules:{required:true,numeric:true,min:0.1}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(!_vengWarningsShown){const vr=VENG.gate.feedCons(o,D);if(!vr.ok){vr.errors.forEach(e=>{if(e.field)showFieldError(e.field,e.msg);});showVengPanel(vr.errors,vr.warnings);return;}if(vr.warnings.length){showVengPanel([],vr.warnings);_vengWarningsShown=true;return;}}_vengWarningsShown=false;
if(id){const i=D.feed.consumption.findIndex(c=>c.id===id);if(i>=0)D.feed.consumption[i]={...D.feed.consumption[i],...o};}
else{o.id=genId();D.feed.consumption.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFeed();
}
async function deleteFeedCons(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.feed.consumption=D.feed.consumption.filter(c=>c.id!==id);saveData(D);toast(t('cfg_saved'));renderFeed();}
// === END FEED ===

// === CLIENTS MODULE ===
function renderClients(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('cli_title')}</h2><button class="btn btn-primary" onclick="showClientForm()">${t('cli_add')}</button></div>`;
h+=`<div class="kpi-grid">${kpi(t('cli_total'),fmtNum(D.clients.length))}</div>`;
if(!D.clients.length){h+=emptyState('👥',t('no_data'),t('cli_add'),'showClientForm()');}
else{
const pg=paginate(D.clients,_pageState.clients||1,PAGE_SIZE);
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('name')}</th><th>${t('phone')}</th><th>${t('email')}</th><th>${t('cli_route')}</th><th>${t('cli_price')} (S/M/L/XL/J)</th><th>${t('notes')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
pg.items.forEach(c=>{
const prices=[c.priceS||'-',c.priceM||'-',c.priceL||'-',c.priceXL||'-',c.priceJumbo||'-'].join(' / ');
h+=`<tr><td><strong>${sanitizeHTML(c.name)}</strong></td><td>${sanitizeHTML(c.phone||'-')}</td><td>${sanitizeHTML(c.email||'-')}</td><td>${sanitizeHTML(c.route||'-')}</td>
<td>${sanitizeHTML(prices)}</td><td>${sanitizeHTML(c.notes||'-')}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showClientForm('${escapeAttr(c.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteClient('${escapeAttr(c.id)}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';
h+=paginationControls('clients',pg.page,pg.totalPages,function(p){_pageState.clients=p;renderClients();});}
$('sec-clientes').innerHTML=h;
}
function showClientForm(id){
const D=loadData();const c=id?D.clients.find(x=>x.id===id):null;
openModal(c?t('edit'):t('cli_add'),`
<div class="form-row"><div class="form-group"><label>${t('name')}</label><input id="cl-name" value="${c?escapeAttr(c.name):''}"></div>
<div class="form-group"><label>${t('phone')}</label><input id="cl-phone" value="${c?escapeAttr(c.phone||''):''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('email')}</label><input id="cl-email" value="${c?escapeAttr(c.email||''):''}"></div>
<div class="form-group"><label>${t('cli_route')}</label><select id="cl-route">${routeSelect(c?c.route||'':'')}</select></div></div>
<div class="form-group"><label>${t('address')}</label><input id="cl-addr" value="${c?escapeAttr(c.address||''):''}"></div>
<p style="font-weight:600;margin:12px 0 8px">${t('cli_price')} (${currency()}/huevo)</p>
<div class="form-row-3"><div class="form-group"><label>S</label><input type="number" id="cl-ps" value="${c?c.priceS||'':''}" step="1" min="0"></div>
<div class="form-group"><label>M</label><input type="number" id="cl-pm" value="${c?c.priceM||'':''}" step="1" min="0"></div>
<div class="form-group"><label>L</label><input type="number" id="cl-pl" value="${c?c.priceL||'':''}" step="1" min="0"></div></div>
<div class="form-row"><div class="form-group"><label>XL</label><input type="number" id="cl-pxl" value="${c?c.priceXL||'':''}" step="1" min="0"></div>
<div class="form-group"><label>Jumbo</label><input type="number" id="cl-pj" value="${c?c.priceJumbo||'':''}" step="1" min="0"></div></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="cl-notes">${c?escapeAttr(c.notes||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveClient('${id||''}')">${t('save')}</button></div>`);
}
function saveClient(id){
clearFieldErrors();
const D=loadData();const o={name:$('cl-name').value,phone:$('cl-phone').value,email:$('cl-email').value,
route:$('cl-route').value,address:$('cl-addr').value,
priceS:parseFloat($('cl-ps').value)||0,priceM:parseFloat($('cl-pm').value)||0,priceL:parseFloat($('cl-pl').value)||0,
priceXL:parseFloat($('cl-pxl').value)||0,priceJumbo:parseFloat($('cl-pj').value)||0,notes:$('cl-notes').value};
const v=validateForm({'cl-name':{value:o.name,rules:{required:true,maxLength:100}},'cl-email':{value:o.email,rules:{email:true}},'cl-phone':{value:o.phone,rules:{phone:true}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.clients.findIndex(c=>c.id===id);if(i>=0){logAudit('update','clients','Edit client: '+o.name,D.clients[i],o);D.clients[i]={...D.clients[i],...o};}}
else{o.id=genId();D.clients.push(o);logAudit('create','clients','New client: '+o.name,null,o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderClients();
}
async function deleteClient(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();
const hasRecords=D.finances.income.some(i=>i.clientId===id)||D.finances.receivables.some(r=>r.clientId===id)||D.traceability.batches.some(b=>b.clientId===id);
if(hasRecords&&!await showConfirm(t('confirm_delete_cascade')||'This client has associated financial records and/or batches. Deleting will remove those references. Continue?'))return;
D.clients=D.clients.filter(c=>c.id!==id);
D.finances.income.filter(i=>i.clientId===id).forEach(i=>{i.clientId='';});
D.finances.receivables.filter(r=>r.clientId===id).forEach(r=>{r.clientId='';});
D.traceability.batches.filter(b=>b.clientId===id).forEach(b=>{b.clientId='';});
saveData(D);toast(t('cfg_saved'));renderClients();}
// === END CLIENTS ===

// === INVENTORY MODULE (A1) ===
function renderInventory(){
const D=loadData();
let h=`<div class="page-header"><h2>📦 ${t('nav_inventory')||'Inventario'}</h2></div>`;
// Compute running balances
const sorted=[...D.inventory].sort((a,b)=>a.date.localeCompare(b.date));
const totIn=sorted.reduce((s,r)=>s+(r.qtyIn||0),0);
const totOut=sorted.reduce((s,r)=>s+(r.qtyOut||0),0);
const balance=totIn-totOut;
// Per egg-type balances
const byType={};sorted.forEach(r=>{const t2=r.eggType||'M';if(!byType[t2])byType[t2]={in:0,out:0};byType[t2].in+=(r.qtyIn||0);byType[t2].out+=(r.qtyOut||0);});
h+=`<div class="kpi-grid">`;
h+=kpi(t('inv_total_in')||'Total In',fmtNum(totIn),'','');
h+=kpi(t('inv_total_out')||'Total Out',fmtNum(totOut),'','');
h+=kpi(t('inv_balance')||'Balance',fmtNum(balance),'',balance<0?'danger':balance<100?'warning':'');
h+=kpi(t('inv_records')||'Records',fmtNum(sorted.length),'','');
h+='</div>';
// Per-type breakdown
if(Object.keys(byType).length){
h+='<div class="card"><h3>'+(t('inv_by_type')||'By Egg Type')+'</h3><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('fin_egg_type')||'Type'}</th><th>${t('inv_total_in')||'In'}</th><th>${t('inv_total_out')||'Out'}</th><th>${t('inv_balance')||'Balance'}</th>`;
h+='</tr></thead><tbody>';
['S','M','L','XL','Jumbo'].forEach(tp=>{if(!byType[tp])return;const b=byType[tp];
h+=`<tr><td><strong>${tp}</strong></td><td>${fmtNum(b.in)}</td><td>${fmtNum(b.out)}</td><td style="font-weight:700;color:${(b.in-b.out)<0?'var(--danger)':'var(--success)'}">${fmtNum(b.in-b.out)}</td></tr>`;});
h+='</tbody></table></div></div>';}
// Filters
h+=`<div class="filter-bar"><select onchange="filterInventory()" id="inv-flock"><option value="">${t('all')||'All'}</option>${D.flocks.map(f=>'<option value="'+escapeAttr(f.id)+'">'+sanitizeHTML(f.name)+'</option>').join('')}</select>
<select onchange="filterInventory()" id="inv-type"><option value="">${t('all')||'All'}</option><option value="S">S</option><option value="M">M</option><option value="L">L</option><option value="XL">XL</option><option value="Jumbo">Jumbo</option></select>
<input type="date" id="inv-from" onchange="filterInventory()"><input type="date" id="inv-to" onchange="filterInventory()"></div>`;
h+='<div id="inv-table"></div>';
$('sec-inventario').innerHTML=h;filterInventory();
}
function filterInventory(){
const D=loadData();const fid=$('inv-flock')?.value||'';const tp=$('inv-type')?.value||'';
const fr=$('inv-from')?.value||'';const to=$('inv-to')?.value||'';
let recs=[...D.inventory].sort((a,b)=>b.date.localeCompare(a.date));
if(fid)recs=recs.filter(r=>r.flockId===fid);if(tp)recs=recs.filter(r=>r.eggType===tp);
if(fr)recs=recs.filter(r=>r.date>=fr);if(to)recs=recs.filter(r=>r.date<=to);
const pg=paginate(recs,_pageState.inventory||1,PAGE_SIZE);
let h='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('prod_flock')||'Flock'}</th><th>${t('fin_egg_type')||'Type'}</th><th>${t('inv_total_in')||'In'}</th><th>${t('inv_total_out')||'Out'}</th><th>${t('source')||'Source'}</th></tr></thead><tbody>`;
if(!pg.items.length)h+=`<tr><td colspan="6" style="text-align:center;color:var(--text-light)">${t('no_data')}</td></tr>`;
pg.items.forEach(r=>{const f=D.flocks.find(x=>x.id===r.flockId);
h+=`<tr><td>${fmtDate(r.date)}</td><td>${f?sanitizeHTML(f.name):'-'}</td><td>${r.eggType||'-'}</td>
<td style="color:var(--success)">${r.qtyIn?'+'+fmtNum(r.qtyIn):'-'}</td>
<td style="color:var(--danger)">${r.qtyOut?'-'+fmtNum(r.qtyOut):'-'}</td>
<td>${sanitizeHTML(r.source||'-')}</td></tr>`;});
h+='</tbody></table></div></div>';
h+=paginationControls('inventory',pg.page,pg.totalPages,function(p){_pageState.inventory=p;filterInventory();});
const w=$('inv-table');if(w)w.innerHTML=h;
}
// === END INVENTORY ===

// === FINANCES MODULE ===
function renderFinances(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('fin_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentFinanceTab==='income'?' active':''}" onclick="currentFinanceTab='income';renderFinances()">📈 ${t('fin_income')}</div>
<div class="tab${currentFinanceTab==='expenses'?' active':''}" onclick="currentFinanceTab='expenses';renderFinances()">📉 ${t('fin_expenses')}</div>
<div class="tab${currentFinanceTab==='receivables'?' active':''}" onclick="currentFinanceTab='receivables';renderFinances()">📋 ${t('fin_receivables')}</div>
<div class="tab${currentFinanceTab==='summary'?' active':''}" onclick="currentFinanceTab='summary';renderFinances()">📊 ${t('fin_summary')}</div></div>`;
if(currentFinanceTab==='income')h+=renderFinIncome(D);
else if(currentFinanceTab==='expenses')h+=renderFinExpenses(D);
else if(currentFinanceTab==='receivables')h+=renderFinReceivables(D);
else h+=renderFinSummary(D);
$('sec-finanzas').innerHTML=h;
}
function renderFinIncome(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('fin_income')}</h3>
<button class="btn btn-primary btn-sm" onclick="showIncomeForm()">${t('fin_add_income')}</button></div>`;
if(!D.finances.income.length)return h+emptyState('📈',t('no_data'));
const tot=D.finances.income.reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
h+=`<div class="kpi-grid">${kpi(t('fin_total_income'),fmtMoney(tot))}</div>`;
const incSorted=D.finances.income.sort((a,b)=>b.date.localeCompare(a.date));
const pgI=paginate(incSorted,_pageState.income||1,PAGE_SIZE);
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('fin_type')}</th><th>${t('fin_qty')}</th><th>${t('fin_unit_price')}</th><th>${t('total')}</th><th>${t('fin_client')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
pgI.items.forEach(i=>{
const cl=D.clients.find(c=>c.id===i.clientId);const amt=(i.quantity||0)*(i.unitPrice||0)||(i.amount||0);
h+=`<tr><td>${fmtDate(i.date)}</td><td>${t('fin_type_'+i.type)||sanitizeHTML(i.type||'-')}</td><td>${fmtNum(i.quantity||0)}</td>
<td>${fmtMoney(i.unitPrice||0)}</td><td><strong>${fmtMoney(amt)}</strong></td><td>${cl?sanitizeHTML(cl.name):sanitizeHTML(i.clientName||'-')}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showIncomeForm('${escapeAttr(i.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteIncome('${escapeAttr(i.id)}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';
h+=paginationControls('income',pgI.page,pgI.totalPages,function(p){_pageState.income=p;renderFinances();});
return h;
}
function showIncomeForm(id){
const D=loadData();const i=id?D.finances.income.find(x=>x.id===id):null;
openModal(i?t('edit'):t('fin_add_income'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fi-date" value="${i?i.date:todayStr()}"></div>
<div class="form-group"><label>${t('fin_type')}</label><select id="fi-type">
<option value="eggs"${i&&i.type==='eggs'?' selected':''}>${t('fin_type_eggs')}</option>
<option value="birds"${i&&i.type==='birds'?' selected':''}>${t('fin_type_birds')}</option>
<option value="manure"${i&&i.type==='manure'?' selected':''}>${t('fin_type_manure')}</option>
<option value="other"${i&&i.type==='other'?' selected':''}>${t('fin_type_other')}</option></select></div></div>
<div class="form-row"><div class="form-group"><label>${t('fin_qty')}</label><input type="number" id="fi-qty" value="${i?i.quantity||'':''}" min="0"></div>
<div class="form-group"><label>${t('fin_unit_price')}</label><input type="number" id="fi-price" value="${i?i.unitPrice||'':''}" min="0"></div></div>
<div class="form-row"><div class="form-group"><label>${t('fin_egg_type')||'Egg Type'}</label><select id="fi-eggtype">
<option value=""${i&&!i.eggType?' selected':''}>--</option>
<option value="S"${i&&i.eggType==='S'?' selected':''}>S</option>
<option value="M"${i&&i.eggType==='M'?' selected':''}>M</option>
<option value="L"${i&&i.eggType==='L'?' selected':''}>L</option>
<option value="XL"${i&&i.eggType==='XL'?' selected':''}>XL</option>
<option value="Jumbo"${i&&i.eggType==='Jumbo'?' selected':''}>Jumbo</option></select></div>
<div class="form-group"><label>${t('fin_channel')||'Channel'}</label><select id="fi-channel">
<option value=""${i&&!i.marketChannel?' selected':''}>--</option>
<option value="wholesale"${i&&i.marketChannel==='wholesale'?' selected':''}>${t('ch_wholesale')||'Wholesale'}</option>
<option value="retail"${i&&i.marketChannel==='retail'?' selected':''}>${t('ch_retail')||'Retail'}</option>
<option value="direct"${i&&i.marketChannel==='direct'?' selected':''}>${t('ch_direct')||'Direct'}</option>
<option value="organic"${i&&i.marketChannel==='organic'?' selected':''}>${t('ch_organic')||'Organic'}</option>
<option value="export"${i&&i.marketChannel==='export'?' selected':''}>${t('ch_export')||'Export'}</option></select></div></div>
<div class="form-group"><label>${t('fin_client')}</label><select id="fi-client">${clientSelect(i?i.clientId:'')}</select></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="fi-notes">${i?escapeAttr(i.notes||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveIncome('${id||''}')">${t('save')}</button></div>`);
}
function saveIncome(id){
clearFieldErrors();
const D=loadData();const o={date:$('fi-date').value,type:$('fi-type').value,
quantity:parseFloat($('fi-qty').value)||0,unitPrice:parseFloat($('fi-price').value)||0,
eggType:$('fi-eggtype')?.value||'',marketChannel:$('fi-channel')?.value||'',
clientId:$('fi-client').value,notes:$('fi-notes').value};
const v=validateForm({'fi-date':{value:o.date,rules:{required:true,date:true}},'fi-qty':{value:$('fi-qty').value,rules:{required:true,numeric:true,min:1}},'fi-price':{value:$('fi-price').value,rules:{required:true,numeric:true,min:0.01}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(!_vengWarningsShown){const vr=VENG.gate.income(o,D);if(!vr.ok){vr.errors.forEach(e=>{if(e.field)showFieldError(e.field,e.msg);});showVengPanel(vr.errors,vr.warnings);return;}if(vr.warnings.length){showVengPanel([],vr.warnings);_vengWarningsShown=true;return;}}_vengWarningsShown=false;
if(id){const i=D.finances.income.findIndex(x=>x.id===id);if(i>=0){logAudit('update','income','Edit income',D.finances.income[i],o);D.finances.income[i]={...D.finances.income[i],...o};}}
else{o.id=genId();D.finances.income.push(o);logAudit('create','income','New income: '+o.type+' qty='+o.quantity,null,o);
if(o.type==='eggs'&&o.quantity>0){D.inventory.push({id:genId(),date:o.date,flockId:'',eggType:o.eggType||'M',qtyIn:0,qtyOut:o.quantity,source:'sale',ref:o.id});}}
saveData(D);closeModal();toast(t('cfg_saved'));renderFinances();
}
async function deleteIncome(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();const old=D.finances.income.find(i=>i.id===id);logAudit('delete','income','Delete income',old,null);D.finances.income=D.finances.income.filter(i=>i.id!==id);saveData(D);toast(t('cfg_saved'));renderFinances();}

function renderFinExpenses(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('fin_expenses')}</h3>
<button class="btn btn-primary btn-sm" onclick="showExpenseForm()">${t('fin_add_expense')}</button></div>`;
if(!D.finances.expenses.length)return h+emptyState('📉',t('no_data'));
const tot=D.finances.expenses.reduce((s,e)=>s+(e.amount||0),0);
h+=`<div class="kpi-grid">${kpi(t('fin_total_expenses'),fmtMoney(tot),'','danger')}</div>`;
const expSorted=D.finances.expenses.sort((a,b)=>b.date.localeCompare(a.date));
const pgE=paginate(expSorted,_pageState.expenses||1,PAGE_SIZE);
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('fin_category')}</th><th>${t('fin_description')}</th><th>${t('fin_amount')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
pgE.items.forEach(e=>{
h+=`<tr><td>${fmtDate(e.date)}</td><td>${t('fin_cat_'+e.category)||sanitizeHTML(e.category||'-')}</td><td>${sanitizeHTML(e.description||'-')}</td>
<td><strong>${fmtMoney(e.amount)}</strong></td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showExpenseForm('${escapeAttr(e.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteExpense('${escapeAttr(e.id)}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';
h+=paginationControls('expenses',pgE.page,pgE.totalPages,function(p){_pageState.expenses=p;renderFinances();});
return h;
}
function showExpenseForm(id){
const D=loadData();const e=id?D.finances.expenses.find(x=>x.id===id):null;
const cats=['feed','bird_purchase','vaccines','transport','labor','infrastructure','other'];
openModal(e?t('edit'):t('fin_add_expense'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fe-date" value="${e?e.date:todayStr()}"></div>
<div class="form-group"><label>${t('fin_category')}</label><select id="fe-cat" onchange="onExpenseCatChange()">${cats.map(c=>`<option value="${c}"${e&&e.category===c?' selected':''}>${t('fin_cat_'+c)}</option>`).join('')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('fin_description')}</label><select id="fe-desc">${catalogSelect(CATALOGS.expenseDescriptions[e?e.category:'feed']||CATALOGS.expenseDescriptions.feed,e?e.description||'':'')}</select></div>
<div class="form-group"><label>${t('fin_amount')}</label><input type="number" id="fe-amt" value="${e?e.amount:''}" min="0"></div></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="fe-notes">${e?escapeAttr(e.notes||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveExpense('${id||''}')">${t('save')}</button></div>`);
}
function saveExpense(id){
clearFieldErrors();
const D=loadData();const o={date:$('fe-date').value,category:$('fe-cat').value,
description:$('fe-desc').value,amount:parseFloat($('fe-amt').value)||0,notes:$('fe-notes').value};
const v=validateForm({'fe-date':{value:o.date,rules:{required:true,date:true}},'fe-cat':{value:o.category,rules:{required:true}},'fe-amt':{value:$('fe-amt').value,rules:{required:true,numeric:true,min:0.01}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(!_vengWarningsShown){const vr=VENG.gate.expense(o,D);if(!vr.ok){vr.errors.forEach(e=>{if(e.field)showFieldError(e.field,e.msg);});showVengPanel(vr.errors,vr.warnings);return;}if(vr.warnings.length){showVengPanel([],vr.warnings);_vengWarningsShown=true;return;}}_vengWarningsShown=false;
if(id){const i=D.finances.expenses.findIndex(e=>e.id===id);if(i>=0){logAudit('update','expenses','Edit expense',D.finances.expenses[i],o);D.finances.expenses[i]={...D.finances.expenses[i],...o};}}
else{o.id=genId();D.finances.expenses.push(o);logAudit('create','expenses','New expense: '+o.category+' $'+o.amount,null,o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFinances();
}
async function deleteExpense(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();const old=D.finances.expenses.find(e=>e.id===id);logAudit('delete','expenses','Delete expense',old,null);D.finances.expenses=D.finances.expenses.filter(e=>e.id!==id);saveData(D);toast(t('cfg_saved'));renderFinances();}

function renderFinReceivables(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('fin_receivables')}</h3>
<button class="btn btn-primary btn-sm" onclick="showReceivableForm()">${t('fin_add_receivable')}</button></div>`;
if(!D.finances.receivables.length)return h+emptyState('📋',t('no_data'));
const pending=D.finances.receivables.filter(r=>!r.paid);const tot=pending.reduce((s,r)=>s+(r.amount||0),0);
h+=`<div class="kpi-grid">${kpi(t('fin_receivables'),fmtMoney(tot),pending.length+' '+t('vac_pending').toLowerCase(),'warning')}</div>`;
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('fin_client')}</th><th>${t('fin_description')}</th><th>${t('fin_amount')}</th><th>${t('fin_due_date')}</th><th>${t('fin_paid')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.finances.receivables.sort((a,b)=>b.date.localeCompare(a.date)).forEach(r=>{
const cl=D.clients.find(c=>c.id===r.clientId);
h+=`<tr><td>${fmtDate(r.date)}</td><td>${cl?sanitizeHTML(cl.name):sanitizeHTML(r.clientName||'-')}</td><td>${sanitizeHTML(r.description||'-')}</td>
<td><strong>${fmtMoney(r.amount)}</strong></td><td>${fmtDate(r.dueDate)}</td>
<td><input type="checkbox" ${r.paid?'checked':''} onchange="toggleReceivablePaid('${escapeAttr(r.id)}',this.checked)"></td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showReceivableForm('${escapeAttr(r.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteReceivable('${escapeAttr(r.id)}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showReceivableForm(id){
const D=loadData();const r=id?D.finances.receivables.find(x=>x.id===id):null;
openModal(r?t('edit'):t('fin_add_receivable'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fr-date" value="${r?r.date:todayStr()}"></div>
<div class="form-group"><label>${t('fin_due_date')}</label><input type="date" id="fr-due" value="${r?r.dueDate||'':''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('fin_client')}</label><select id="fr-client">${clientSelect(r?r.clientId:'')}</select></div>
<div class="form-group"><label>${t('fin_amount')}</label><input type="number" id="fr-amt" value="${r?r.amount:''}" min="0"></div></div>
<div class="form-group"><label>${t('fin_description')}</label><input id="fr-desc" value="${r?escapeAttr(r.description||''):''}"></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveReceivable('${id||''}')">${t('save')}</button></div>`);
}
function saveReceivable(id){
clearFieldErrors();
const D=loadData();const o={date:$('fr-date').value,dueDate:$('fr-due').value,clientId:$('fr-client').value,
amount:parseFloat($('fr-amt').value)||0,description:$('fr-desc').value,paid:false};
const v=validateForm({'fr-date':{value:o.date,rules:{required:true,date:true}},'fr-client':{value:o.clientId,rules:{required:true}},'fr-amt':{value:$('fr-amt').value,rules:{required:true,numeric:true,min:0.01}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.finances.receivables.findIndex(r=>r.id===id);if(i>=0){o.paid=D.finances.receivables[i].paid;D.finances.receivables[i]={...D.finances.receivables[i],...o};}}
else{o.id=genId();D.finances.receivables.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFinances();
}
function toggleReceivablePaid(id,paid){const D=loadData();const r=D.finances.receivables.find(x=>x.id===id);if(r){r.paid=paid;saveData(D);renderFinances();}}
async function deleteReceivable(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.finances.receivables=D.finances.receivables.filter(r=>r.id!==id);saveData(D);toast(t('cfg_saved'));renderFinances();}

function renderFinSummary(D){
const mo=todayStr().substring(0,7);
const mInc=D.finances.income.filter(i=>i.date&&i.date.startsWith(mo)).reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
const mExp=D.finances.expenses.filter(e=>e.date&&e.date.startsWith(mo)).reduce((s,e)=>s+(e.amount||0),0);
const grossProfit=mInc-mExp;
// A5: Tax & Depreciation
const taxRate=(D.settings.taxRate||0)/100;
const depYears=D.settings.depreciationYears||5;
const assetVal=D.settings.assetValue||0;
const monthlyDep=assetVal>0?assetVal/(depYears*12):0;
const operatingProfit=grossProfit-monthlyDep;
const taxAmt=operatingProfit>0?operatingProfit*taxRate:0;
const netProfit=operatingProfit-taxAmt;
const tEggs=D.dailyProduction.reduce((s,p)=>s+(p.eggsCollected||0),0);
const tExp=D.finances.expenses.reduce((s,e)=>s+(e.amount||0),0);
const cpe=tEggs>0?tExp/tEggs:0;
const totalIncAmt=D.finances.income.reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
const totalIncQty=D.finances.income.reduce((s,i)=>s+(i.quantity||0),0);
const avgPrice=totalIncQty>0?totalIncAmt/totalIncQty:0;
const breakEven=avgPrice>0?Math.ceil(tExp/avgPrice):0;
let h=`<div class="kpi-grid">`;
h+=kpi(t('fin_total_income')+' ('+mo+')',fmtMoney(mInc),'','secondary');
h+=kpi(t('fin_total_expenses')+' ('+mo+')',fmtMoney(mExp),'','danger');
h+=kpi(t('fin_gross_profit')||'Gross Profit',fmtMoney(grossProfit),'',grossProfit<0?'danger':'');
if(monthlyDep>0)h+=kpi(t('fin_depreciation')||'Depreciation/mo',fmtMoney(monthlyDep),'','accent');
if(taxRate>0)h+=kpi(t('fin_tax')||'Tax ('+D.settings.taxRate+'%)',fmtMoney(taxAmt),'','warning');
h+=kpi(t('fin_net_profit')||'Net Profit ('+mo+')',fmtMoney(netProfit),'',netProfit<0?'danger':'');
h+=kpi(t('fin_cost_per_egg'),fmtMoney(cpe),'global','accent');
h+=kpi(t('fin_break_even'),fmtNum(breakEven)+' '+t('eggs_unit'),'global','warning');
h+='</div>';
// A2: Per-channel revenue breakdown
const channels={};D.finances.income.forEach(i=>{const ch=i.marketChannel||'other';const amt=(i.quantity||0)*(i.unitPrice||0)||(i.amount||0);const qty=i.quantity||0;
if(!channels[ch])channels[ch]={revenue:0,qty:0};channels[ch].revenue+=amt;channels[ch].qty+=qty;});
if(Object.keys(channels).length>1||Object.keys(channels).some(k=>k!=='other')){
h+='<div class="card"><h3>'+(t('fin_channel_breakdown')||'Revenue by Channel')+'</h3><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('fin_channel')||'Channel'}</th><th>${t('fin_qty')}</th><th>${t('fin_income')}</th><th>${t('fin_avg_price')||'Avg Price'}</th><th>%</th></tr></thead><tbody>`;
Object.entries(channels).sort((a,b)=>b[1].revenue-a[1].revenue).forEach(([ch,v])=>{
const avg=v.qty>0?v.revenue/v.qty:0;const pct=totalIncAmt>0?(v.revenue/totalIncAmt*100):0;
h+=`<tr><td><strong>${t('ch_'+ch)||ch}</strong></td><td>${fmtNum(v.qty)}</td><td style="color:var(--success)">${fmtMoney(v.revenue)}</td><td>${fmtMoney(avg)}</td><td>${fmtNum(pct,1)}%</td></tr>`;});
h+='</tbody></table></div></div>';}
// Monthly breakdown
const months={};D.finances.income.forEach(i=>{const m=i.date?.substring(0,7);if(!m)return;if(!months[m])months[m]={income:0,expenses:0};months[m].income+=(i.quantity||0)*(i.unitPrice||0)||(i.amount||0);});
D.finances.expenses.forEach(e=>{const m=e.date?.substring(0,7);if(!m)return;if(!months[m])months[m]={income:0,expenses:0};months[m].expenses+=(e.amount||0);});
const mKeys=Object.keys(months).sort().reverse();
if(mKeys.length){
h+='<div class="card"><h3>'+t('fin_summary')+' '+t('fin_month')+'</h3><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('fin_month')}</th><th>${t('fin_income')}</th><th>${t('fin_expenses')}</th><th>${t('fin_net')}</th></tr></thead><tbody>`;
mKeys.forEach(m=>{const d=months[m];const n=d.income-d.expenses;
h+=`<tr><td>${m}</td><td style="color:var(--success)">${fmtMoney(d.income)}</td><td style="color:var(--danger)">${fmtMoney(d.expenses)}</td>
<td style="font-weight:700;color:${n<0?'var(--danger)':'var(--success)'}">${fmtMoney(n)}</td></tr>`;});
h+='</tbody></table></div></div>';}
// Expense by category
const cats={};D.finances.expenses.forEach(e=>{const c=e.category||'other';cats[c]=(cats[c]||0)+(e.amount||0);});
if(Object.keys(cats).length){
h+='<div class="card"><h3>'+t('fin_expenses')+' / '+t('fin_category')+'</h3>';
Object.entries(cats).sort((a,b)=>b[1]-a[1]).forEach(([c,v])=>{const pct=tExp>0?(v/tExp*100):0;
h+=`<div class="stat-row"><span class="stat-label">${t('fin_cat_'+c)||c}</span><span class="stat-value">${fmtMoney(v)} (${fmtNum(pct,1)}%)</span></div>`;});
h+='</div>';}
// CSV export
// MATHV: Math Verification in Financial Summary
const mv=VENG.mathv(D);
h+='<div class="card" style="border-left:4px solid '+(mv.pct===100?'var(--success)':'var(--danger)')+'">';
h+='<h3>🔒 Math Verification — '+(mv.pct===100?'✓ All Passed':'⚠ '+mv.checks.filter(c=>!c.ok).length+' Failed')+'</h3>';
h+='<div style="display:flex;flex-wrap:wrap;gap:8px;margin:8px 0">';
mv.checks.forEach(c=>{h+='<div style="padding:6px 12px;border-radius:6px;font-size:13px;background:'+(c.ok?'#e8f5e9;color:#2e7d32':'#fce4ec;color:#c62828')+'">'+(c.ok?'✓':'✗')+' '+sanitizeHTML(c.name)+'</div>';});
h+='</div>';
if(mv.checks.some(c=>!c.ok)){h+='<details><summary style="cursor:pointer;color:var(--danger);font-weight:600">View failures</summary>';
mv.checks.filter(c=>!c.ok).forEach(c=>{h+='<div style="margin:4px 0;padding:6px;background:#fff3e0;border-radius:4px;font-size:12px">'+sanitizeHTML(c.name)+': '+sanitizeHTML(c.detail)+'</div>';});
h+='</details>';}
h+='</div>';
h+=`<div class="card"><button class="btn btn-secondary" onclick="exportFinCSV()">${t('export_csv')}</button></div>`;
return h;
}
function exportFinCSV(){
const D=loadData();let csv=t('fin_type')+','+t('date')+','+t('fin_category')+','+t('fin_description')+','+t('fin_qty')+','+t('fin_unit_price')+','+t('fin_amount')+'\n';
const esc=s=>String(s||'').replace(/"/g,'""');
D.finances.income.forEach(i=>{const a=(i.quantity||0)*(i.unitPrice||0)||(i.amount||0);csv+=`"${esc(t('csv_income'))}","${i.date}","${esc(i.type)}","${esc(i.notes)}",${i.quantity||0},${i.unitPrice||0},${a}\n`;});
D.finances.expenses.forEach(e=>{csv+=`"${esc(t('csv_expense'))}","${e.date}","${esc(e.category)}","${esc(e.description)}",,,${e.amount||0}\n`;});
const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);
a.download='egglogu_finanzas_'+todayStr()+'.csv';a.click();toast(t('cfg_exported'));
}
// === END FINANCES ===

// === ANALYSIS MODULE ===
let currentAnaTab='comparison';
function renderAnalysis(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('ana_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentAnaTab==='comparison'?' active':''}" onclick="currentAnaTab='comparison';renderAnalysis()">🔄 ${t('ana_comparison')}</div>
<div class="tab${currentAnaTab==='seasonality'?' active':''}" onclick="currentAnaTab='seasonality';renderAnalysis()">📅 ${t('ana_seasonality')}</div>
<div class="tab${currentAnaTab==='profitability'?' active':''}" onclick="currentAnaTab='profitability';renderAnalysis()">💰 ${t('ana_profitability')}</div>
<div class="tab${currentAnaTab==='kpi_evo'?' active':''}" onclick="currentAnaTab='kpi_evo';renderAnalysis()">📊 ${t('ana_kpi_evolution')}</div>
<div class="tab${currentAnaTab==='predictions'?' active':''}" onclick="currentAnaTab='predictions';renderAnalysis()">🤖 ${t('pred_title')}</div></div>`;
if(currentAnaTab==='comparison')h+=renderAnaComparison(D);
else if(currentAnaTab==='seasonality')h+=renderAnaSeasonality(D);
else if(currentAnaTab==='profitability')h+=renderAnaProfitability(D);
else if(currentAnaTab==='predictions')h+=renderPredictionsTab(D);
else h+=renderAnaKpiEvo(D);
$('sec-analisis').innerHTML=h;
}
function renderAnaComparison(D){
if(!D.flocks.length)return emptyState('🔄',t('no_data'));
let h='<div class="card"><h3>'+t('ana_comparison')+'</h3><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('flock_name')}</th><th>${t('flock_count')}</th><th>${t('flock_current')}</th><th>${t('kpi_henday')} (7d)</th><th>FCR (30d)</th><th>${t('kpi_mortality')} %</th><th>${t('flock_health')}</th></tr></thead><tbody>`;
const stats=D.flocks.map(f=>{
const cur=activeHensByFlock(f.id);const l7=D.dailyProduction.filter(p=>p.flockId===f.id).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const avgE=l7.length>0?l7.reduce((s,p)=>s+(p.eggsCollected||0),0)/l7.length:0;
const hd=cur>0?(avgE/cur*100):0;
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const f30=D.feed.consumption.filter(c=>c.flockId===f.id&&c.date>=d30s);const e30=D.dailyProduction.filter(p=>p.flockId===f.id&&p.date>=d30s);
const tfkg=f30.reduce((s,c)=>s+(c.quantityKg||0),0);const tekg=e30.reduce((s,p)=>s+(p.eggsCollected||0),0)*0.06;
const fcr=tekg>0?tfkg/tekg:0;
const deaths=D.dailyProduction.filter(p=>p.flockId===f.id).reduce((s,p)=>s+(p.deaths||0),0);
const mort=f.count>0?(deaths/f.count*100):0;const hs=healthScore(f.id);
return{f,cur,hd,fcr,mort,hs};
});
stats.sort((a,b)=>b.hd-a.hd);
stats.forEach(s=>{
h+=`<tr><td><strong>${sanitizeHTML(s.f.name)}</strong></td><td>${fmtNum(s.f.count)}</td><td>${fmtNum(s.cur)}</td>
<td style="color:${s.hd>=80?'var(--success)':s.hd>=60?'var(--warning)':'var(--danger)'}">${fmtNum(s.hd,1)}%</td>
<td>${s.fcr>0?fmtNum(s.fcr,2):'-'}</td><td>${fmtNum(s.mort,1)}%</td><td>${healthBadge(s.hs)}</td></tr>`;});
h+='</tbody></table></div></div>';
if(stats.length>=2){
h+=`<div class="kpi-grid">${kpi(t('ana_best_flock'),sanitizeHTML(stats[0].f.name),'Hen-Day: '+fmtNum(stats[0].hd,1)+'%')}`;
h+=kpi(t('ana_worst_flock'),sanitizeHTML(stats[stats.length-1].f.name),'Hen-Day: '+fmtNum(stats[stats.length-1].hd,1)+'%','danger');
h+='</div>';}
return h;
}
function renderAnaSeasonality(D){
const months={};D.dailyProduction.forEach(p=>{const m=p.date?.substring(5,7);if(!m)return;if(!months[m])months[m]={eggs:0,days:new Set()};months[m].eggs+=(p.eggsCollected||0);months[m].days.add(p.date);});
if(!Object.keys(months).length)return emptyState('📅',t('no_data'));
const mNames=Array.from({length:12},(_,i)=>new Date(2024,i,1).toLocaleDateString(locale(),{month:'short'}));
let h='<div class="card"><h3>'+t('ana_seasonality')+'</h3><div class="chart-container"><canvas id="chart-season"></canvas></div></div>';
h+='<div class="card"><div class="table-wrap"><table><thead><tr><th>'+t('fin_month')+'</th><th>'+t('prod_eggs')+'</th><th>'+t('avg_per_day')+'</th></tr></thead><tbody>';
for(let i=1;i<=12;i++){const k=String(i).padStart(2,'0');const d=months[k];
const avg=d?Math.round(d.eggs/d.days.size):0;
h+=`<tr><td>${mNames[i-1]}</td><td>${d?fmtNum(d.eggs):'-'}</td><td>${d?fmtNum(avg):'-'}</td></tr>`;}
h+='</tbody></table></div></div>';
$('sec-analisis').innerHTML?.includes('chart-season')||setTimeout(()=>{
const c=document.getElementById('chart-season');if(!c)return;
const labels=mNames;const vals=[];for(let i=1;i<=12;i++){const k=String(i).padStart(2,'0');const d=months[k];vals.push(d?Math.round(d.eggs/d.days.size):0);}
CHARTS.season=new Chart(c,{type:'bar',data:{labels,datasets:[{label:t('avg_per_day'),data:vals,backgroundColor:themeColor('--primary-light')}]},options:{responsive:true,maintainAspectRatio:false}});
},100);
return h;
}
function renderAnaProfitability(D){
if(!D.flocks.length)return emptyState('💰',t('no_data'));
let h='<div class="card"><h3>'+t('ana_profitability')+' / '+t('per_flock')+'</h3><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('flock_name')}</th><th>${t('prod_eggs')}</th><th>${t('fin_income')}</th><th>${t('fin_expenses')}</th><th>${t('fin_net')}</th><th>${t('fin_cost_per_egg')}</th></tr></thead><tbody>`;
const _totalFeedCost=D.feed.purchases.reduce((s,p)=>s+(p.cost||0),0);const _totalFeedKg=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0);
const _feedPricePerKg=_totalFeedKg>0?_totalFeedCost/_totalFeedKg:0;
const _totalIncAmt=D.finances.income.reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
const _totalIncQty=D.finances.income.reduce((s,i)=>s+(i.quantity||0),0);
const _weightedAvgPrice=_totalIncQty>0?_totalIncAmt/_totalIncQty:0;
D.flocks.forEach(f=>{
const eggs=D.dailyProduction.filter(p=>p.flockId===f.id).reduce((s,p)=>s+(p.eggsCollected||0),0);
const feedCost=D.feed.consumption.filter(c=>c.flockId===f.id).reduce((s,c)=>s+(c.quantityKg||0)*_feedPricePerKg,0);
const inc=eggs*_weightedAvgPrice;
const net=inc-feedCost-(f.cost||0);const cpe=eggs>0?(feedCost+(f.cost||0))/eggs:0;
h+=`<tr><td><strong>${sanitizeHTML(f.name)}</strong></td><td>${fmtNum(eggs)}</td><td style="color:var(--success)">${fmtMoney(inc)}</td>
<td style="color:var(--danger)">${fmtMoney(feedCost+(f.cost||0))}</td>
<td style="font-weight:700;color:${net<0?'var(--danger)':'var(--success)'}">${fmtMoney(net)}</td><td>${fmtMoney(cpe)}</td></tr>`;});
h+='</tbody></table></div></div>';
// Per-Channel Weighted Average Pricing (A2) — from income records
const chPricing={};const typePricing={};
D.finances.income.filter(i=>i.type==='eggs'&&i.quantity>0).forEach(i=>{
const ch=i.marketChannel||'other';const et=i.eggType||'M';const amt=(i.quantity||0)*(i.unitPrice||0);
if(!chPricing[ch])chPricing[ch]={qty:0,revenue:0};chPricing[ch].qty+=(i.quantity||0);chPricing[ch].revenue+=amt;
if(!typePricing[et])typePricing[et]={qty:0,revenue:0};typePricing[et].qty+=(i.quantity||0);typePricing[et].revenue+=amt;
});
const totalChQty=Object.values(chPricing).reduce((s,v)=>s+v.qty,0);
if(Object.keys(chPricing).length||Object.keys(typePricing).length){
h+=`<div class="card"><h3>${t('ana_channel_pricing')||'Per-Channel Pricing'}</h3>`;
if(Object.keys(chPricing).length){
h+=`<h4 style="margin:8px 0">${t('fin_channel')||'Channel'}</h4><div class="table-wrap"><table><thead><tr><th>${t('fin_channel')||'Channel'}</th><th>${t('fin_qty')}</th><th>${t('fin_income')}</th><th>${t('fin_avg_price')||'Avg Price'}</th><th>%</th></tr></thead><tbody>`;
Object.entries(chPricing).sort((a,b)=>b[1].revenue-a[1].revenue).forEach(([k,v])=>{
const avg=v.qty>0?v.revenue/v.qty:0;const pct=totalChQty>0?((v.qty/totalChQty)*100):0;
h+=`<tr><td>${t('ch_'+k)||k}</td><td>${fmtNum(v.qty)}</td><td style="color:var(--success)">${fmtMoney(v.revenue)}</td><td><strong>${fmtMoney(avg)}</strong></td><td>${fmtNum(pct,1)}%</td></tr>`;});
h+='</tbody></table></div>';}
if(Object.keys(typePricing).length){
h+=`<h4 style="margin:12px 0 8px">${t('fin_egg_type')||'Egg Type'}</h4><div class="table-wrap"><table><thead><tr><th>${t('fin_egg_type')||'Type'}</th><th>${t('fin_qty')}</th><th>${t('fin_income')}</th><th>${t('fin_avg_price')||'Avg Price'}</th></tr></thead><tbody>`;
['S','M','L','XL','Jumbo'].forEach(tp=>{const v=typePricing[tp];if(!v)return;const avg=v.qty>0?v.revenue/v.qty:0;
h+=`<tr><td>${tp}</td><td>${fmtNum(v.qty)}</td><td style="color:var(--success)">${fmtMoney(v.revenue)}</td><td><strong>${fmtMoney(avg)}</strong></td></tr>`;});
h+='</tbody></table></div>';}
h+='</div>';}
return h;
}
function renderAnaKpiEvo(D){
if(!D.kpiSnapshots.length)return emptyState('📊',t('ana_no_snapshots'));
let h='<div class="card"><h3>'+t('ana_kpi_evolution')+'</h3><div class="chart-container"><canvas id="chart-kpi-evo"></canvas></div></div>';
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('kpi_active_hens')}</th><th>Hen-Day %</th><th>FCR</th><th>${t('kpi_mortality')} %</th><th>${t('kpi_cost_egg')}</th><th>${t('kpi_income_net')}</th></tr></thead><tbody>`;
D.kpiSnapshots.slice(-20).reverse().forEach(s=>{
h+=`<tr><td>${fmtDate(s.date)}</td><td>${fmtNum(s.activeHens)}</td><td>${fmtNum(s.henDay,1)}%</td>
<td>${fmtNum(s.fcr,2)}</td><td>${fmtNum(s.mortality,1)}%</td><td>${fmtMoney(s.costPerEgg)}</td><td>${fmtMoney(s.netIncome)}</td></tr>`;});
h+='</tbody></table></div></div>';
setTimeout(()=>{
const c=document.getElementById('chart-kpi-evo');if(!c)return;
const snaps=D.kpiSnapshots.slice(-30);
CHARTS.kpiEvo=new Chart(c,{type:'line',data:{labels:snaps.map(s=>s.date.substring(5)),datasets:[
{label:'Hen-Day %',data:snaps.map(s=>s.henDay),borderColor:themeColor('--primary'),tension:.3,yAxisID:'y'},
{label:'FCR',data:snaps.map(s=>s.fcr),borderColor:'#FF8F00',tension:.3,yAxisID:'y1'},
{label:t('kpi_mortality')+' %',data:snaps.map(s=>s.mortality),borderColor:'#C62828',tension:.3,yAxisID:'y'}
]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
scales:{y:{position:'left',min:0},y1:{position:'right',grid:{drawOnChartArea:false}}}}});
},100);
return h;
}
// === END ANALYSIS ===

// === OPERATIONS MODULE ===
function renderOperations(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('ops_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentOpsTab==='checklist'?' active':''}" onclick="currentOpsTab='checklist';renderOperations()">✅ ${t('ops_checklist')}</div>
<div class="tab${currentOpsTab==='logbook'?' active':''}" onclick="currentOpsTab='logbook';renderOperations()">📓 ${t('ops_logbook')}</div>
<div class="tab${currentOpsTab==='personnel'?' active':''}" onclick="currentOpsTab='personnel';renderOperations()">👷 ${t('ops_personnel')}</div></div>`;
if(currentOpsTab==='checklist')h+=renderOpsChecklist(D);
else if(currentOpsTab==='logbook')h+=renderOpsLogbook(D);
else h+=renderOpsPersonnel(D);
$('sec-operaciones').innerHTML=h;
}
function renderOpsChecklist(D){
const today=todayStr();
let todayItems=D.checklist.filter(c=>c.date===today);
if(!todayItems.length&&D.settings.defaultChecklist){
D.settings.defaultChecklist.forEach(task=>{
D.checklist.push({id:genId(),date:today,task,done:false});});
todayItems=D.checklist.filter(c=>c.date===today);saveData(D);
}
const done=todayItems.filter(c=>c.done).length;const total=todayItems.length;
let h=`<div class="kpi-grid">${kpi(t('ops_done'),done+'/'+total,total>0?fmtNum(done/total*100,0)+'%':'',done===total&&total>0?'':'warning')}</div>`;
h+=`<div class="card"><h3>${t('ops_checklist')} — ${fmtDate(today)}</h3>`;
todayItems.forEach(c=>{
h+=`<div class="checklist-item${c.done?' done':''}"><input type="checkbox" ${c.done?'checked':''} onchange="toggleCheck('${escapeAttr(c.id)}',this.checked)"><span>${t(c.task)||sanitizeHTML(c.task)}</span>
<button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="deleteCheck('${escapeAttr(c.id)}')">✕</button></div>`;});
h+=`<div style="margin-top:12px;display:flex;gap:8px"><input id="new-task" placeholder="${t('ops_task')}" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:var(--radius)">
<button class="btn btn-primary btn-sm" onclick="addCheckTask()">${t('add')}</button></div></div>`;
// History
const dates=[...new Set(D.checklist.map(c=>c.date))].sort().reverse().filter(d=>d!==today).slice(0,7);
if(dates.length){
h+='<div class="card"><h3>'+t('history')+'</h3>';
dates.forEach(d=>{const items=D.checklist.filter(c=>c.date===d);const dn=items.filter(c=>c.done).length;
h+=`<div class="stat-row"><span class="stat-label">${fmtDate(d)}</span><span class="stat-value">${dn}/${items.length} (${items.length>0?fmtNum(dn/items.length*100,0):0}%)</span></div>`;});
h+='</div>';}
return h;
}
function toggleCheck(id,done){const D=loadData();const c=D.checklist.find(x=>x.id===id);if(c){c.done=done;saveData(D);renderOperations();}}
function deleteCheck(id){const D=loadData();D.checklist=D.checklist.filter(c=>c.id!==id);saveData(D);renderOperations();}
function addCheckTask(){const v=$('new-task')?.value;if(!v)return;const D=loadData();D.checklist.push({id:genId(),date:todayStr(),task:v,done:false});saveData(D);renderOperations();}

function renderOpsLogbook(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('ops_logbook')}</h3>
<button class="btn btn-primary btn-sm" onclick="showLogForm()">${t('ops_log_add')}</button></div>`;
if(!D.logbook.length)return h+emptyState('📓',t('no_data'));
const cats=['general','health','production','maintenance','observation'];
h+=`<div class="filter-bar"><select id="lf-cat" onchange="renderOperations()"><option value="">${t('all')}</option>${cats.map(c=>`<option value="${c}">${t('ops_log_cat_'+c)}</option>`).join('')}</select></div>`;
const selCat=document.getElementById('lf-cat')?.value||'';
let logs=D.logbook.sort((a,b)=>b.date.localeCompare(a.date));
if(selCat)logs=logs.filter(l=>l.category===selCat);
h+='<div class="card">';
logs.forEach(l=>{
h+=`<div class="alert-card alert-info" style="flex-wrap:wrap"><div style="flex:1"><strong>${fmtDate(l.date)}</strong> — <span class="badge badge-info">${t('ops_log_cat_'+l.category)||sanitizeHTML(l.category)}</span>
<p style="margin-top:4px">${sanitizeHTML(l.entry)}</p></div>
<div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showLogForm('${escapeAttr(l.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteLog('${escapeAttr(l.id)}')">${t('delete')}</button></div></div>`;});
h+='</div>';return h;
}
function showLogForm(id){
const D=loadData();const l=id?D.logbook.find(x=>x.id===id):null;
const cats=['general','health','production','maintenance','observation'];
openModal(l?t('edit'):t('ops_log_add'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="lg-date" value="${l?l.date:todayStr()}"></div>
<div class="form-group"><label>${t('ops_log_category')}</label><select id="lg-cat">${cats.map(c=>`<option value="${c}"${l&&l.category===c?' selected':''}>${t('ops_log_cat_'+c)}</option>`).join('')}</select></div></div>
<div class="form-group"><label>${t('ops_log_entry')}</label><textarea id="lg-entry" rows="4">${l?escapeAttr(l.entry||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveLog('${id||''}')">${t('save')}</button></div>`);
}
function saveLog(id){
clearFieldErrors();
const D=loadData();const o={date:$('lg-date').value,category:$('lg-cat').value,entry:$('lg-entry').value};
const v=validateForm({'lg-date':{value:o.date,rules:{required:true,date:true}},'lg-cat':{value:o.category,rules:{required:true}},'lg-entry':{value:o.entry,rules:{required:true,maxLength:2000}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.logbook.findIndex(l=>l.id===id);if(i>=0)D.logbook[i]={...D.logbook[i],...o};}
else{o.id=genId();D.logbook.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderOperations();
}
async function deleteLog(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.logbook=D.logbook.filter(l=>l.id!==id);saveData(D);toast(t('cfg_saved'));renderOperations();}

function renderOpsPersonnel(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('ops_personnel')}</h3>
<button class="btn btn-primary btn-sm" onclick="showPersonnelForm()">${t('ops_per_add')}</button></div>`;
if(!D.personnel.length)return h+emptyState('👷',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('ops_per_name')}</th><th>${t('ops_per_role')}</th><th>${t('ops_per_salary')}</th><th>${t('ops_per_start')}</th><th>${t('ops_per_active')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.personnel.forEach(p=>{
h+=`<tr><td><strong>${sanitizeHTML(p.name)}</strong></td><td>${sanitizeHTML(p.role||'-')}</td><td>${fmtMoney(p.salary||0)}</td><td>${fmtDate(p.startDate)}</td>
<td>${p.active?'<span class="badge badge-success">'+t('active')+'</span>':'<span class="badge badge-secondary">'+t('inactive')+'</span>'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showPersonnelForm('${escapeAttr(p.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deletePersonnel('${escapeAttr(p.id)}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';
const totalSalary=D.personnel.filter(p=>p.active).reduce((s,p)=>s+(p.salary||0),0);
h+=`<div class="kpi-grid">${kpi(t('total_salaries'),fmtMoney(totalSalary),D.personnel.filter(p=>p.active).length+' '+t('active').toLowerCase())}</div>`;
return h;
}
function showPersonnelForm(id){
const D=loadData();const p=id?D.personnel.find(x=>x.id===id):null;
openModal(p?t('edit'):t('ops_per_add'),`
<div class="form-row"><div class="form-group"><label>${t('ops_per_name')}</label><input id="pe-name" value="${p?escapeAttr(p.name):''}"></div>
<div class="form-group"><label>${t('ops_per_role')}</label><select id="pe-role">${catalogSelect(CATALOGS.personnelRoles,p?p.role||'':'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('ops_per_salary')}</label><input type="number" id="pe-salary" value="${p?p.salary||'':''}" min="0"></div>
<div class="form-group"><label>${t('ops_per_start')}</label><input type="date" id="pe-start" value="${p?p.startDate||'':''}"></div></div>
<div class="form-group"><label>${t('ops_per_active')}</label><select id="pe-active">
<option value="1"${!p||p.active?' selected':''}>${t('active')}</option>
<option value="0"${p&&!p.active?' selected':''}>${t('inactive')}</option></select></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="pe-notes">${p?escapeAttr(p.notes||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="savePersonnel('${id||''}')">${t('save')}</button></div>`);
}
function savePersonnel(id){
clearFieldErrors();
const D=loadData();const o={name:$('pe-name').value,role:$('pe-role').value,
salary:parseFloat($('pe-salary').value)||0,startDate:$('pe-start').value,
active:$('pe-active').value==='1',notes:$('pe-notes').value};
const v=validateForm({'pe-name':{value:o.name,rules:{required:true,maxLength:100}},'pe-role':{value:o.role,rules:{required:true}},'pe-salary':{value:$('pe-salary').value,rules:{numeric:true,min:0}},'pe-start':{value:o.startDate,rules:{required:true,date:true}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.personnel.findIndex(p=>p.id===id);if(i>=0)D.personnel[i]={...D.personnel[i],...o};}
else{o.id=genId();D.personnel.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderOperations();
}
async function deletePersonnel(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.personnel=D.personnel.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderOperations();}
// === END OPERATIONS ===

// === ENVIRONMENT MODULE ===
let currentEnvTab='manual';
function renderEnvironment(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('env_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentEnvTab==='manual'?' active':''}" onclick="currentEnvTab='manual';renderEnvironment()">📝 ${t('env_manual')}</div>
<div class="tab${currentEnvTab==='iot'?' active':''}" onclick="currentEnvTab='iot';renderEnvironment()">📡 ${t('iot_title')}</div>
<div class="tab${currentEnvTab==='history'?' active':''}" onclick="currentEnvTab='history';renderEnvironment()">📊 ${t('env_history')}</div></div>`;
if(currentEnvTab==='manual')h+=renderEnvManual(D);
else if(currentEnvTab==='iot')h+=renderEnvIoT(D);
else h+=renderEnvHistory(D);
$('sec-ambiente').innerHTML=h;if(currentEnvTab==='iot')updateIoTGauges();
}
function renderEnvManual(D){
let h=`<div style="text-align:right;margin-bottom:8px"><button class="btn btn-primary" onclick="showEnvForm()">${t('env_add')}</button></div>`;
h+=`<div class="card"><h3>${t('env_optimal')}</h3><div class="kpi-grid">
${kpi(t('env_temp'),t('env_temp_range'),'','')}</div><div class="kpi-grid">
${kpi(t('env_humidity'),t('env_humidity_range'),'','')}
${kpi(t('env_light'),t('env_light_range'),'','')}
${kpi(t('env_density'),t('env_density_range'),'','')}</div></div>`;
const latest=D.environment.sort((a,b)=>b.date.localeCompare(a.date))[0];
if(latest){
const tOk=latest.temperature>=18&&latest.temperature<=24;const hOk=latest.humidity>=40&&latest.humidity<=70;
const lOk=latest.lightHours>=14&&latest.lightHours<=16;
h+=`<div class="card"><h3>${t('env_latest_reading')} (${fmtDate(latest.date)})</h3><div class="kpi-grid">`;
h+=`<div class="kpi-card ${tOk?'':'danger'}"><div class="kpi-label">${t('env_temp')}</div><div class="kpi-value">${latest.temperature||'-'}°C</div><div class="kpi-sub">${tOk?'✓ '+t('env_ok'):'⚠ '+t('env_out_of_range')}</div></div>`;
h+=`<div class="kpi-card ${hOk?'':'warning'}"><div class="kpi-label">${t('env_humidity')}</div><div class="kpi-value">${latest.humidity||'-'}%</div><div class="kpi-sub">${hOk?'✓ '+t('env_ok'):'⚠ '+t('env_out_of_range')}</div></div>`;
h+=`<div class="kpi-card ${lOk?'':'warning'}"><div class="kpi-label">${t('env_light')}</div><div class="kpi-value">${latest.lightHours||'-'} hrs</div><div class="kpi-sub">${lOk?'✓ '+t('env_ok'):'⚠ '+t('env_out_of_range')}</div></div>`;
if(latest.temperature&&latest.humidity){const thi=calcTHI(latest.temperature,latest.humidity);
h+=`<div class="kpi-card ${thi>28?'danger':thi>25?'warning':''}"><div class="kpi-label">${t('env_thi')}</div><div class="kpi-value">${thi.toFixed(1)}</div><div class="kpi-sub">${thi>28?t('weather_heat_alert'):'OK'}</div></div>`;}
h+='</div></div>';}
if(!D.environment.length)h+=emptyState('🌡️',t('no_data'),t('env_add'),'showEnvForm()');
else{
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('env_temp')}</th><th>${t('env_humidity')}</th><th>${t('env_light')}</th><th>${t('env_ammonia')}</th><th>THI</th><th>${t('notes')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.environment.sort((a,b)=>b.date.localeCompare(a.date)).slice(0,20).forEach(e=>{
const tOk=e.temperature>=18&&e.temperature<=24;const hOk=e.humidity>=40&&e.humidity<=70;
const thi=(e.temperature&&e.humidity)?calcTHI(e.temperature,e.humidity):null;
h+=`<tr><td>${fmtDate(e.date)}</td><td style="color:${tOk?'var(--success)':'var(--danger)'}">${e.temperature||'-'}°C</td>
<td style="color:${hOk?'var(--success)':'var(--warning)'}">${e.humidity||'-'}%</td>
<td>${e.lightHours||'-'} hrs</td><td>${e.ammoniaLevel||'-'} ppm</td>
<td>${thi?thi.toFixed(1):'-'}</td><td>${sanitizeHTML(e.notes||'-')}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showEnvForm('${escapeAttr(e.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteEnv('${escapeAttr(e.id)}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';}
return h;
}
function renderEnvIoT(D){
let h='';
if(!D.farm.mqttBroker){return `<div class="card"><p>${t('iot_no_config')}</p>
<button class="btn btn-primary" onclick="nav('config')">${t('cfg_title')}</button></div>`;}
h+=`<div class="card"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
<div id="mqtt-indicator"></div>
<button class="btn btn-primary btn-sm" onclick="connectMQTT()">${t('iot_connect')}</button>
<button class="btn btn-secondary btn-sm" onclick="disconnectMQTT()">${t('iot_disconnect')}</button></div>
<div id="iot-gauges"><p style="color:var(--text-light)">${t('iot_no_config')}</p></div></div>`;
return h;
}
function renderEnvHistory(D){
let h='';
if(!D.environment.length)return emptyState('📊',t('no_data'));
h+='<div class="card"><h3>'+t('env_history')+'</h3><div class="chart-container"><canvas id="chart-env"></canvas></div></div>';
setTimeout(()=>{
const c=document.getElementById('chart-env');if(!c)return;
const recs=D.environment.sort((a,b)=>a.date.localeCompare(b.date)).slice(-30);
CHARTS.env=new Chart(c,{type:'line',data:{labels:recs.map(r=>r.date.substring(5)),datasets:[
{label:t('env_temp')+' °C',data:recs.map(r=>r.temperature),borderColor:'#C62828',tension:.3,yAxisID:'y'},
{label:t('env_humidity')+' %',data:recs.map(r=>r.humidity),borderColor:themeColor('--primary'),tension:.3,yAxisID:'y1'}
]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
scales:{y:{position:'left',title:{display:true,text:'°C'}},y1:{position:'right',title:{display:true,text:'%'},grid:{drawOnChartArea:false}}}}});
},100);
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('env_temp')}</th><th>${t('env_humidity')}</th><th>${t('env_light')}</th><th>${t('env_ammonia')}</th><th>THI</th><th>${t('notes')}</th></tr></thead><tbody>`;
D.environment.sort((a,b)=>b.date.localeCompare(a.date)).forEach(e=>{
const thi=(e.temperature&&e.humidity)?calcTHI(e.temperature,e.humidity):null;
h+=`<tr><td>${fmtDate(e.date)}</td><td>${e.temperature||'-'}°C</td><td>${e.humidity||'-'}%</td>
<td>${e.lightHours||'-'} hrs</td><td>${e.ammoniaLevel||'-'} ppm</td><td>${thi?thi.toFixed(1):'-'}</td><td>${sanitizeHTML(e.notes||'-')}</td></tr>`;});
h+='</tbody></table></div></div>';
return h;
}
function showEnvForm(id){
const D=loadData();const e=id?D.environment.find(x=>x.id===id):null;
openModal(e?t('edit'):t('env_add'),`
<div class="form-group"><label>${t('date')}</label><input type="date" id="en-date" value="${e?e.date:todayStr()}"></div>
<div class="form-row"><div class="form-group"><label>${t('env_temp')}</label><input type="number" id="en-temp" value="${e?e.temperature||'':''}" step="0.1"></div>
<div class="form-group"><label>${t('env_humidity')}</label><input type="number" id="en-hum" value="${e?e.humidity||'':''}" step="1" min="0" max="100"></div></div>
<div class="form-row"><div class="form-group"><label>${t('env_light')}</label><input type="number" id="en-light" value="${e?e.lightHours||'':''}" step="0.5" min="0" max="24"></div>
<div class="form-group"><label>${t('env_ammonia')} (ppm)</label><input type="number" id="en-ammonia" value="${e?e.ammoniaLevel||'':''}" step="0.1" min="0"></div></div>
<div class="form-group"><label>${t('env_ventilation')}</label><select id="en-vent">${catalogSelect(CATALOGS.ventilationLevels,e?e.ventilation||'':'',false)}</select></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="en-notes">${e?escapeAttr(e.notes||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveEnv('${id||''}')">${t('save')}</button></div>`);
}
function saveEnv(id){
clearFieldErrors();
const D=loadData();const o={date:$('en-date').value,temperature:parseFloat($('en-temp').value)||null,
humidity:parseFloat($('en-hum').value)||null,lightHours:parseFloat($('en-light').value)||null,
ammoniaLevel:parseFloat($('en-ammonia')?.value)||null,
ventilation:$('en-vent').value,notes:$('en-notes').value};
const v=validateForm({'en-date':{value:o.date,rules:{required:true,date:true}},'en-temp':{value:$('en-temp').value,rules:{numeric:true}},'en-hum':{value:$('en-hum').value,rules:{numeric:true,min:0,max:100}},'en-light':{value:$('en-light').value,rules:{numeric:true,min:0,max:24}},'en-ammonia':{value:$('en-ammonia')?.value||'',rules:{numeric:true,min:0}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.environment.findIndex(e=>e.id===id);if(i>=0)D.environment[i]={...D.environment[i],...o};}
else{o.id=genId();D.environment.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderEnvironment();
}
async function deleteEnv(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.environment=D.environment.filter(e=>e.id!==id);saveData(D);toast(t('cfg_saved'));renderEnvironment();}
// === END ENVIRONMENT ===

// === CARENCIAS (VENG CENSUS) MODULE ===
function renderCarencias(){
const D=loadData();const c=VENG.census(D);
const catMeta={sanitary:{icon:'💉',label:'Sanitaria',color:'#c62828'},nutritional:{icon:'🌾',label:'Nutricional',color:'#e65100'},financial:{icon:'💰',label:'Financiera',color:'#1565c0'},operational:{icon:'📋',label:'Operacional',color:'#6a1b9a'},data:{icon:'🔒',label:'Datos',color:'#00695c'}};
let h='<h2>🔍 '+t('nav_census')+' — VENG Census</h2>';
// Overall score gauge
const oc=c.overall>=80?'var(--success)':c.overall>=60?'var(--warning)':'var(--danger)';
h+='<div class="card" style="border-left:4px solid '+oc+'">';
h+='<div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">';
h+='<div style="text-align:center"><div style="font-size:48px;font-weight:800;color:'+oc+'">'+c.overall+'</div><div style="color:var(--text-light);font-size:13px">Overall Health /100</div></div>';
h+='<div style="flex:1;min-width:200px"><div class="kpi-grid">';
Object.keys(catMeta).forEach(k=>{const m=catMeta[k];const s=c.scores[k];
const sc=s>=80?'var(--success)':s>=60?'var(--warning)':'var(--danger)';
h+='<div class="kpi-card"><div class="kpi-label">'+m.icon+' '+m.label+'</div><div class="kpi-value" style="color:'+sc+'">'+s+'</div></div>';});
h+='</div></div></div>';
// Summary counts
h+='<div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">';
if(c.critical>0)h+='<span style="background:#ffcdd2;color:#b71c1c;padding:4px 12px;border-radius:12px;font-weight:600">'+c.critical+' Critical</span>';
if(c.warning>0)h+='<span style="background:#fff9c4;color:#f57f17;padding:4px 12px;border-radius:12px;font-weight:600">'+c.warning+' Warning</span>';
if(c.info>0)h+='<span style="background:#e3f2fd;color:#1565c0;padding:4px 12px;border-radius:12px;font-weight:600">'+c.info+' Info</span>';
if(c.findings.length===0)h+='<span style="background:#c8e6c9;color:#2e7d32;padding:4px 12px;border-radius:12px;font-weight:600">No deficiencies detected</span>';
h+='</div></div>';
// Findings by category
Object.keys(catMeta).forEach(cat=>{
const items=c.findings.filter(f=>f.cat===cat);if(items.length===0)return;
const m=catMeta[cat];
h+='<div class="card" style="border-left:4px solid '+m.color+'">';
h+='<h3>'+m.icon+' '+m.label+' ('+items.length+')</h3>';
h+='<div class="table-wrap"><table><thead><tr><th style="width:80px">Severity</th><th style="width:140px">Code</th><th>Finding</th><th>Metric</th><th>Benchmark</th></tr></thead><tbody>';
items.forEach(f=>{
const sevColor=f.sev==='critical'?'#c62828':f.sev==='warning'?'#e65100':'#1565c0';
const sevBg=f.sev==='critical'?'#ffcdd2':f.sev==='warning'?'#fff9c4':'#e3f2fd';
h+='<tr><td><span style="background:'+sevBg+';color:'+sevColor+';padding:2px 8px;border-radius:8px;font-size:12px;font-weight:600">'+f.sev.toUpperCase()+'</span></td>';
h+='<td style="font-family:monospace;font-size:12px;color:var(--text-light)">'+f.code+'</td>';
h+='<td>'+sanitizeHTML(f.msg)+'<br><small style="color:var(--primary)">→ '+sanitizeHTML(f.rec)+'</small></td>';
h+='<td style="font-weight:600;text-align:center">'+f.metric+' '+f.unit+'</td>';
h+='<td style="text-align:center;color:var(--text-light)">'+f.bench+' '+f.unit+'</td></tr>';});
h+='</tbody></table></div></div>';});
// Benchmarking context
h+='<div class="card" style="background:var(--primary-fill)">';
h+='<h3>📊 Benchmark Context</h3>';
h+='<p style="color:var(--text-secondary);font-size:13px;margin:0">Benchmarks are based on international poultry standards: mortality &lt;1.5%/month, FCR &lt;2.2, feed 100-140g/hen/day, margin &gt;10%, XVAL score &gt;90. ';
h+='Scores are calculated per category: each critical finding deducts 20 points, warning 10, info 3, from a base of 100.</p></div>';
// Anonymized export
h+='<div class="card">';
h+='<h3>📤 Anonymized Deficiency Report</h3>';
h+='<p style="color:var(--text-secondary);font-size:13px">Export an anonymized summary of deficiency patterns. Contains NO farm names, client data, or financial figures — only deficiency codes, category scores, and farm size classification.</p>';
h+='<div style="margin:12px 0"><button class="btn btn-primary" onclick="exportCensusAnon()">Export Anonymized Report (.json)</button>';
h+=' <button class="btn" onclick="showCensusAnon()" style="margin-left:8px">Preview Report</button></div>';
h+='<div id="census-anon-preview" style="display:none"></div>';
h+='</div>';
$('sec-carencias').innerHTML=h;
}
function exportCensusAnon(){
const D=loadData();const c=VENG.census(D);const json=JSON.stringify(c.anonymized,null,2);
const blob=new Blob([json],{type:'application/json'});const url=URL.createObjectURL(blob);
const a=document.createElement('a');a.href=url;a.download='egglogu_census_anon_'+todayStr()+'.json';a.click();URL.revokeObjectURL(url);
logAudit('export','census','Exported anonymized deficiency report');
}
function showCensusAnon(){
const el=$('census-anon-preview');if(!el)return;
if(el.style.display!=='none'){el.style.display='none';return;}
const D=loadData();const c=VENG.census(D);
el.style.display='block';
el.innerHTML='<pre style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;font-size:12px;overflow-x:auto;max-height:400px">'+sanitizeHTML(JSON.stringify(c.anonymized,null,2))+'</pre>';
}

// === ADMIN SaaS MODULE ===
const PLAN_TIERS={
hobbyist:{name:'Hobbyist',baseCost:19,maxFlocks:2,includedUsers:1,extraUserCost:4.99,modules:['dashboard','produccion','lotes']},
starter:{name:'Starter',baseCost:49,maxFlocks:5,includedUsers:1,extraUserCost:3.99,modules:['dashboard','produccion','lotes','alimento','sanidad','finanzas','clientes']},
professional:{name:'Professional',baseCost:99,maxFlocks:15,includedUsers:1,extraUserCost:2.99,modules:'all'},
enterprise:{name:'Enterprise',baseCost:199,maxFlocks:Infinity,includedUsers:1,extraUserCost:2.49,modules:'all'}
};

function renderAdmin(){
const D=loadData();
const plan=D.settings.plan||{};
const tier=plan.tier||'professional';
const tierInfo=PLAN_TIERS[tier]||PLAN_TIERS.professional;
const users=D.users||[];
const pending=D.pendingActivations||[];
const audit=D.auditLog||[];
const cur=plan.currency||'USD';

// i18n labels inline (avoids editing 8 language blocks for 40+ keys)
const L={es:{title:'Admin SaaS',plan_overview:'Resumen del Plan',current_plan:'Plan Actual',monthly_cost:'Costo Mensual',max_flocks:'Lotes Máx.',included_users:'Usuarios Incluidos',extra_cost:'Costo Extra/Usuario',billing:'Ciclo Facturación',user_kpis:'KPIs de Usuarios',total_users:'Total Usuarios',active_users:'Usuarios Activos',inactive_users:'Inactivos',by_role:'Por Rol',activation_kpis:'KPIs de Activación',activation_rate:'Tasa Activación',avg_time_activate:'Tiempo Promedio Activación',pending_activations:'Activaciones Pendientes',churn_kpis:'KPIs de Churn',monthly_churn:'Churn Mensual',retention:'Retención',deactivated_30d:'Desactivados (30d)',revenue_kpis:'KPIs de Revenue',mrr:'MRR (Ingreso Mensual Recurrente)',base_revenue:'Revenue Base',extra_user_revenue:'Revenue Usuarios Extra',total_mrr:'MRR Total',user_table:'Tabla de Usuarios',name:'Nombre',email:'Email',role:'Rol',status:'Estado',since:'Desde',actions:'Acciones',active:'Activo',inactive:'Inactivo',pending:'Pendiente',no_users:'No hay usuarios registrados',upgrade_plan:'Cambiar Plan',upgrade:'Upgrade',current:'(Actual)',audit_recent:'Actividad Reciente',no_audit:'Sin registros de auditoría',deactivate:'Desactivar',activate:'Activar',days:'días',confirm_deactivate:'¿Desactivar este usuario?',confirm_activate:'¿Reactivar este usuario?',plan_changed:'Plan actualizado exitosamente',user_toggled:'Estado del usuario actualizado',add_user:'Agregar Usuario',delete_user:'Eliminar',billing_title:'Facturación y Pagos',billing_next:'Próxima Facturación',billing_cycle:'Ciclo',billing_base:'Cargo Base',billing_extra:'Usuarios Extra',billing_total:'Total por Ciclo',billing_ledger:'Historial de Cobros',billing_type:'Tipo',billing_desc:'Descripción',billing_amount:'Monto',billing_monthly:'Cobro mensual',billing_activation_charge:'Cargo proporcional activación',billing_deactivation_credit:'Crédito desactivación',billing_auto_note:'Sistema autogestionable — los cobros y créditos se calculan automáticamente según activaciones/desactivaciones de usuarios. No se requiere intervención manual.'},
en:{title:'SaaS Admin',plan_overview:'Plan Overview',current_plan:'Current Plan',monthly_cost:'Monthly Cost',max_flocks:'Max Flocks',included_users:'Included Users',extra_cost:'Extra User Cost',billing:'Billing Cycle',user_kpis:'User KPIs',total_users:'Total Users',active_users:'Active Users',inactive_users:'Inactive',by_role:'By Role',activation_kpis:'Activation KPIs',activation_rate:'Activation Rate',avg_time_activate:'Avg. Time to Activate',pending_activations:'Pending Activations',churn_kpis:'Churn KPIs',monthly_churn:'Monthly Churn',retention:'Retention',deactivated_30d:'Deactivated (30d)',revenue_kpis:'Revenue KPIs',mrr:'MRR (Monthly Recurring Revenue)',base_revenue:'Base Revenue',extra_user_revenue:'Extra User Revenue',total_mrr:'Total MRR',user_table:'User Table',name:'Name',email:'Email',role:'Role',status:'Status',since:'Since',actions:'Actions',active:'Active',inactive:'Inactive',pending:'Pending',no_users:'No registered users',upgrade_plan:'Change Plan',upgrade:'Upgrade',current:'(Current)',audit_recent:'Recent Activity',no_audit:'No audit records',deactivate:'Deactivate',activate:'Activate',days:'days',confirm_deactivate:'Deactivate this user?',confirm_activate:'Reactivate this user?',plan_changed:'Plan updated successfully',user_toggled:'User status updated',add_user:'Add User',delete_user:'Delete',billing_title:'Billing & Payments',billing_next:'Next Billing',billing_cycle:'Cycle',billing_base:'Base Charge',billing_extra:'Extra Users',billing_total:'Total per Cycle',billing_ledger:'Payment History',billing_type:'Type',billing_desc:'Description',billing_amount:'Amount',billing_monthly:'Monthly charge',billing_activation_charge:'Proportional activation charge',billing_deactivation_credit:'Deactivation credit',billing_auto_note:'Self-managed system — charges and credits are calculated automatically based on user activations/deactivations. No manual intervention required.'}};
const lang=document.documentElement.lang||'es';
const lbl=L[lang]||L[Object.keys(L).find(k=>lang.startsWith(k))]||L.es;

// Compute KPIs
const activeUsers=users.filter(u=>u.status==='active');
const inactiveUsers=users.filter(u=>u.status==='inactive'||u.status==='deactivated');
const roleCounts={};
activeUsers.forEach(u=>{roleCounts[u.role]=(roleCounts[u.role]||0)+1;});

// Activation KPIs
const activatedUsers=users.filter(u=>u.activatedAt);
const activationRate=users.length?Math.round(activatedUsers.length/users.length*100):0;
let avgActivationDays=0;
if(activatedUsers.length){
const totalDays=activatedUsers.reduce((s,u)=>{
const req=u.requestedAt?new Date(u.requestedAt):new Date(u.createdAt||u.activatedAt);
const act=new Date(u.activatedAt);
return s+Math.max(0,(act-req)/(1000*60*60*24));
},0);
avgActivationDays=Math.round(totalDays/activatedUsers.length*10)/10;
}

// Churn KPIs (30-day window)
const now=Date.now();
const d30=30*24*60*60*1000;
const deactivated30d=users.filter(u=>u.deactivatedAt&&(now-new Date(u.deactivatedAt).getTime())<d30);
const activeStart=users.filter(u=>{
const created=new Date(u.createdAt||u.activatedAt||'2026-01-01').getTime();
return created<(now-d30);
});
const churnRate=activeStart.length?Math.round(deactivated30d.length/activeStart.length*100):0;
const retention=100-churnRate;

// Revenue KPIs
const extraUsers=Math.max(0,activeUsers.length-tierInfo.includedUsers);
const baseRevenue=tierInfo.baseCost;
const extraRevenue=extraUsers*tierInfo.extraUserCost;
const totalMRR=baseRevenue+extraRevenue;

// Build HTML
let h=`<div class="page-header"><h2>👑 ${lbl.title}</h2></div>`;

// Plan Overview Card
h+=`<div class="card" style="margin-bottom:16px"><h3>📋 ${lbl.plan_overview}</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px">
<div class="kpi-card"><div class="kpi-label">${lbl.current_plan}</div><div class="kpi-value" style="font-size:1.3rem;color:var(--primary)">${tierInfo.name.toUpperCase()}</div></div>
<div class="kpi-card"><div class="kpi-label">${lbl.monthly_cost}</div><div class="kpi-value">$${tierInfo.baseCost}<small>/${cur}</small></div></div>
<div class="kpi-card"><div class="kpi-label">${lbl.max_flocks}</div><div class="kpi-value">${tierInfo.maxFlocks===Infinity?'∞':tierInfo.maxFlocks}</div></div>
<div class="kpi-card"><div class="kpi-label">${lbl.included_users}</div><div class="kpi-value">${tierInfo.includedUsers}</div></div>
<div class="kpi-card"><div class="kpi-label">${lbl.extra_cost}</div><div class="kpi-value">$${tierInfo.extraUserCost}</div></div>
<div class="kpi-card"><div class="kpi-label">${lbl.billing}</div><div class="kpi-value">${plan.billingCycle||'monthly'}</div></div>
</div>
<div style="margin-top:12px;text-align:right"><button class="btn btn-sm" onclick="showUpgradeModal()">⬆ ${lbl.upgrade_plan}</button></div>
</div>`;

// KPI Row: Users + Activation + Churn + Revenue
h+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-bottom:16px">`;

// User KPIs
h+=`<div class="card"><h3>👥 ${lbl.user_kpis}</h3>
<div class="kpi-card" style="margin:8px 0"><div class="kpi-label">${lbl.total_users}</div><div class="kpi-value">${users.length}</div></div>
<div class="kpi-card" style="margin:8px 0"><div class="kpi-label">${lbl.active_users}</div><div class="kpi-value" style="color:#4caf50">${activeUsers.length}</div></div>
<div class="kpi-card" style="margin:8px 0"><div class="kpi-label">${lbl.inactive_users}</div><div class="kpi-value" style="color:#f44336">${inactiveUsers.length}</div></div>
<div style="margin-top:8px;font-size:0.85rem;color:var(--text-muted)"><strong>${lbl.by_role}:</strong> ${Object.entries(roleCounts).map(([r,c])=>`${r}: ${c}`).join(' · ')||'—'}</div>
</div>`;

// Activation KPIs
h+=`<div class="card"><h3>🚀 ${lbl.activation_kpis}</h3>
<div class="kpi-card" style="margin:8px 0"><div class="kpi-label">${lbl.activation_rate}</div><div class="kpi-value">${activationRate}%</div></div>
<div class="kpi-card" style="margin:8px 0"><div class="kpi-label">${lbl.avg_time_activate}</div><div class="kpi-value">${avgActivationDays} ${lbl.days}</div></div>
<div class="kpi-card" style="margin:8px 0"><div class="kpi-label">${lbl.pending_activations}</div><div class="kpi-value" style="color:${pending.length?'#ff9800':'#4caf50'}">${pending.length}</div></div>
</div>`;

// Churn KPIs
h+=`<div class="card"><h3>📉 ${lbl.churn_kpis}</h3>
<div class="kpi-card" style="margin:8px 0"><div class="kpi-label">${lbl.monthly_churn}</div><div class="kpi-value" style="color:${churnRate>10?'#f44336':churnRate>5?'#ff9800':'#4caf50'}">${churnRate}%</div></div>
<div class="kpi-card" style="margin:8px 0"><div class="kpi-label">${lbl.retention}</div><div class="kpi-value" style="color:${retention>=90?'#4caf50':'#ff9800'}">${retention}%</div></div>
<div class="kpi-card" style="margin:8px 0"><div class="kpi-label">${lbl.deactivated_30d}</div><div class="kpi-value">${deactivated30d.length}</div></div>
</div>`;

// Revenue KPIs
h+=`<div class="card"><h3>💰 ${lbl.revenue_kpis}</h3>
<div class="kpi-card" style="margin:8px 0"><div class="kpi-label">${lbl.base_revenue}</div><div class="kpi-value">$${baseRevenue.toFixed(2)}</div></div>
<div class="kpi-card" style="margin:8px 0"><div class="kpi-label">${lbl.extra_user_revenue}</div><div class="kpi-value">$${extraRevenue.toFixed(2)} <small>(${extraUsers} extra)</small></div></div>
<div class="kpi-card" style="margin:8px 0;border:2px solid var(--primary);border-radius:8px;padding:10px"><div class="kpi-label">${lbl.total_mrr}</div><div class="kpi-value" style="font-size:1.4rem;color:var(--primary)">$${totalMRR.toFixed(2)}</div></div>
</div>`;

h+=`</div>`;

// User Table with Add/Delete buttons
h+=`<div class="card" style="margin-bottom:16px"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
<h3 style="margin:0">📊 ${lbl.user_table}</h3>
<button class="btn btn-primary btn-sm" onclick="showUserForm()" style="font-size:0.85rem">➕ ${lbl.add_user}</button>
</div>`;
if(users.length===0){
h+=`<p style="color:var(--text-muted);text-align:center;padding:24px">${lbl.no_users}</p>`;
}else{
h+=`<div style="overflow-x:auto"><table class="data-table" style="width:100%;margin-top:12px"><thead><tr>
<th>${lbl.name}</th><th>${lbl.email}</th><th>${lbl.role}</th><th>${lbl.status}</th><th>${lbl.since}</th><th style="min-width:180px">${lbl.actions}</th>
</tr></thead><tbody>`;
users.forEach(u=>{
const statusColor=u.status==='active'?'#4caf50':u.status==='pending'?'#ff9800':'#f44336';
const statusText=u.status==='active'?lbl.active:u.status==='pending'?lbl.pending:lbl.inactive;
const since=u.activatedAt||u.createdAt||'—';
const sinceStr=since!=='—'?new Date(since).toLocaleDateString():since;
const isOwnerSelf=u.role==='owner'&&u.id===_currentUser?.id;
const toggleBtn=u.status==='active'
?`<button class="btn btn-sm" style="background:#f44336;font-size:0.72rem;padding:3px 8px" onclick="deactivateUser('${u.id}')"${isOwnerSelf?' disabled title="No se puede desactivar al dueño actual"':''}>${lbl.deactivate}</button>`
:u.status==='inactive'||u.status==='expired'||u.status==='deactivated'
?`<button class="btn btn-sm" style="background:#4caf50;font-size:0.72rem;padding:3px 8px" onclick="reactivateUser('${u.id}')">${lbl.activate}</button>`
:u.status==='pending'
?`<button class="btn btn-sm" style="background:#ff9800;font-size:0.72rem;padding:3px 8px" onclick="resendActivation('${u.id}')">📧</button>`:'';
const deleteBtn=u.status!=='active'&&!isOwnerSelf
?`<button class="btn btn-sm" style="background:#b71c1c;font-size:0.72rem;padding:3px 8px;margin-left:4px" onclick="removeUser('${u.id}')">${lbl.delete_user}</button>`:'';
const editBtn=`<button class="btn btn-sm" style="background:var(--primary);font-size:0.72rem;padding:3px 8px;margin-left:4px" onclick="showUserForm('${u.id}')">✏</button>`;
h+=`<tr>
<td><strong>${sanitizeHTML(u.name||'—')}</strong>${u.isExtra?'<span style="font-size:0.65rem;background:var(--warning);color:#000;padding:1px 5px;border-radius:8px;margin-left:4px">EXTRA</span>':''}</td>
<td>${sanitizeHTML(u.email||u.workerId||'—')}</td>
<td><span style="text-transform:capitalize">${u.role||'—'}</span></td>
<td><span style="color:${statusColor};font-weight:600">● ${statusText}</span></td>
<td>${sinceStr}</td>
<td style="white-space:nowrap">${toggleBtn}${editBtn}${deleteBtn}</td>
</tr>`;
});
h+=`</tbody></table></div>`;
}
h+=`</div>`;

// Billing & Payments (self-managed)
const billingCycle=plan.billingCycle||'monthly';
const nextBilling=getNextBillingDate(billingCycle);
const extraUsersActive=activeUsers.filter(u=>u.isExtra);
const totalExtraCharge=Math.round(extraUsersActive.length*tierInfo.extraUserCost*100)/100;
const totalMonthlyCharge=Math.round((tierInfo.baseCost+totalExtraCharge)*100)/100;

h+=`<div class="card" style="margin-bottom:16px"><h3>💳 ${lbl.billing_title}</h3>
<div style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-top:12px">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px">
<div><div style="font-size:0.75rem;color:var(--text-muted)">${lbl.billing_next}</div><div style="font-weight:700;font-size:1.1rem">${nextBilling}</div></div>
<div><div style="font-size:0.75rem;color:var(--text-muted)">${lbl.billing_cycle}</div><div style="font-weight:700;font-size:1.1rem;text-transform:capitalize">${billingCycle}</div></div>
<div><div style="font-size:0.75rem;color:var(--text-muted)">${lbl.billing_base}</div><div style="font-weight:700;font-size:1.1rem">$${tierInfo.baseCost.toFixed(2)}</div></div>
<div><div style="font-size:0.75rem;color:var(--text-muted)">${lbl.billing_extra} (${extraUsersActive.length})</div><div style="font-weight:700;font-size:1.1rem">$${totalExtraCharge.toFixed(2)}</div></div>
<div style="border:2px solid var(--primary);border-radius:8px;padding:8px"><div style="font-size:0.75rem;color:var(--text-muted)">${lbl.billing_total}</div><div style="font-weight:900;font-size:1.3rem;color:var(--primary)">$${totalMonthlyCharge.toFixed(2)}</div></div>
</div></div>`;

// Payment Ledger (auto-generated from user billing data)
const ledger=[];
users.forEach(u=>{
if(u.firstCharge&&u.activatedAt){ledger.push({date:u.activatedAt,type:'charge',desc:lbl.billing_activation_charge+': '+u.name+(u.isExtra?' (extra)':''),amount:u.firstCharge});}
if(u.deactivatedAt&&u.isExtra){ledger.push({date:u.deactivatedAt,type:'credit',desc:lbl.billing_deactivation_credit+': '+u.name,amount:Math.round(tierInfo.extraUserCost*0.3*100)/100});}
});
// Add recurring monthly charges based on history
const months=new Set();
D.kpiSnapshots?.forEach(k=>{if(k.date)months.add(k.date.substring(0,7));});
months.forEach(m=>{
const activeInMonth=users.filter(u=>u.activatedAt&&u.activatedAt.substring(0,7)<=m&&(!u.deactivatedAt||u.deactivatedAt.substring(0,7)>=m));
const extraInMonth=Math.max(0,activeInMonth.length-tierInfo.includedUsers);
ledger.push({date:m+'-01',type:'charge',desc:lbl.billing_monthly+' — '+tierInfo.name+' + '+extraInMonth+' extra',amount:Math.round((tierInfo.baseCost+extraInMonth*tierInfo.extraUserCost)*100)/100});
});
ledger.sort((a,b)=>b.date.localeCompare(a.date));

if(ledger.length>0){
h+=`<div style="margin-top:12px"><h4 style="font-size:0.9rem;margin-bottom:8px">📜 ${lbl.billing_ledger}</h4>
<div style="overflow-x:auto;max-height:250px;overflow-y:auto"><table class="data-table" style="width:100%;font-size:0.85rem"><thead><tr>
<th>${lbl.date||'Fecha'}</th><th>${lbl.billing_type}</th><th>${lbl.billing_desc}</th><th style="text-align:right">${lbl.billing_amount}</th>
</tr></thead><tbody>`;
ledger.slice(0,30).forEach(l=>{
const color=l.type==='charge'?'#f44336':'#4caf50';
const sign=l.type==='charge'?'-':'+';
h+=`<tr><td style="white-space:nowrap">${l.date}</td><td style="color:${color};font-weight:600;text-transform:capitalize">${l.type}</td>
<td>${sanitizeHTML(l.desc)}</td><td style="text-align:right;font-weight:600;color:${color}">${sign}$${l.amount.toFixed(2)}</td></tr>`;
});
h+=`</tbody></table></div></div>`;
}
h+=`<div style="margin-top:12px;padding:10px;background:rgba(76,175,80,.08);border-radius:var(--radius);font-size:0.8rem;color:var(--text-muted)">
🤖 ${lbl.billing_auto_note}</div></div>`;

// Recent Audit Activity
h+=`<div class="card"><h3>📝 ${lbl.audit_recent}</h3>`;
const recentAudit=audit.slice(-20).reverse();
if(recentAudit.length===0){
h+=`<p style="color:var(--text-muted);text-align:center;padding:24px">${lbl.no_audit}</p>`;
}else{
h+=`<div style="overflow-x:auto"><table class="data-table" style="width:100%;margin-top:12px"><thead><tr>
<th>Fecha</th><th>Usuario</th><th>Acción</th><th>Módulo</th><th>Detalle</th>
</tr></thead><tbody>`;
recentAudit.forEach(a=>{
const ts=a.ts?new Date(a.ts).toLocaleString():'—';
h+=`<tr>
<td style="white-space:nowrap;font-size:0.8rem">${ts}</td>
<td>${sanitizeHTML(a.user||'—')}</td>
<td>${sanitizeHTML(a.action||'—')}</td>
<td>${sanitizeHTML(a.module||'—')}</td>
<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${sanitizeHTML(a.detail||'—')}</td>
</tr>`;
});
h+=`</tbody></table></div>`;
}
h+=`</div>`;

$('sec-admin').innerHTML=h;
}

function showUpgradeModal(){
const D=loadData();
const current=D.settings.plan?.tier||'professional';
const lang=document.documentElement.lang||'es';
const isEs=lang.startsWith('es');
let body=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">`;
Object.entries(PLAN_TIERS).forEach(([key,t])=>{
const isCurrent=key===current;
const border=isCurrent?'border:2px solid var(--primary)':'border:1px solid var(--border)';
const badge=isCurrent?`<span style="background:var(--primary);color:#fff;font-size:0.7rem;padding:2px 8px;border-radius:10px;margin-left:6px">${isEs?'Actual':'Current'}</span>`:'';
const btn=isCurrent?'':`<button class="btn btn-sm" style="width:100%;margin-top:8px" onclick="doUpgradePlan('${key}')">⬆ Upgrade</button>`;
body+=`<div style="${border};border-radius:12px;padding:16px;text-align:center">
<div style="font-weight:700;text-transform:uppercase;letter-spacing:1px;font-size:0.85rem">${t.name}${badge}</div>
<div style="font-size:1.8rem;font-weight:900;margin:8px 0">$${t.baseCost}<small style="font-size:0.8rem;font-weight:400">/mo</small></div>
<div style="font-size:0.8rem;color:var(--text-muted)">${t.maxFlocks===Infinity?'∞':t.maxFlocks} ${isEs?'lotes':'flocks'} · $${t.extraUserCost}/${isEs?'extra':'extra'}</div>
${btn}
</div>`;
});
body+=`</div>`;
openModal(isEs?'Cambiar Plan':'Change Plan',body);
}

function doUpgradePlan(newTier){
if(!PLAN_TIERS[newTier])return;
const D=loadData();
D.settings.plan=D.settings.plan||{};
D.settings.plan.tier=newTier;
D.settings.plan.baseCost=PLAN_TIERS[newTier].baseCost;
D.settings.plan.extraUserCost=PLAN_TIERS[newTier].extraUserCost;
D.settings.plan.includedUsers=PLAN_TIERS[newTier].includedUsers;
D.settings.plan.upgradedAt=new Date().toISOString();
saveData(D);
if(typeof logAudit==='function')logAudit('plan_upgrade','admin','Upgraded to '+newTier);
closeModal();
renderAdmin();
}

function toggleUserStatus(userId,action){
// Route through secure 4-layer functions
if(action==='deactivate')deactivateUser(userId);
else reactivateUser(userId);
}

// Helper: refresh correct section after user management operations
function refreshUserSection(){if(currentSection==='admin')renderAdmin();else renderConfig();}

// === CONFIG MODULE ===
function renderConfig(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('cfg_title')}</h2></div>`;
// Theme picker
const curTheme=localStorage.getItem('egglogu_theme')||'blue';
h+='<div class="card"><h3>'+t('cfg_theme')+'</h3><div style="display:flex;gap:12px;flex-wrap:wrap">';
Object.keys(THEMES).forEach(name=>{const th=THEMES[name];const active=curTheme===name;
h+='<button onclick="applyTheme(\''+name+'\');nav(\'config\')" style="width:90px;height:64px;border-radius:var(--radius);border:'+(active?'3px solid var(--secondary)':'2px solid var(--border)')+';background:'+th['sidebar-bg']+';color:#fff;cursor:pointer;font-weight:'+(active?'700':'400')+';font-size:13px;transition:all .2s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px"><span style="width:24px;height:24px;border-radius:50%;background:'+th.primary+';border:2px solid rgba(255,255,255,.5)"></span>'+t('cfg_theme_'+name)+'</button>';});
h+='</div></div>';
// Accessibility: Font size + Dark mode
const curScale=D.settings.fontScale||'normal';
h+=`<div class="card"><h3>♿ ${t('cfg_accessibility')}</h3>
<div class="form-group"><label>${t('cfg_font_size')}</label>
<div style="display:flex;gap:8px;flex-wrap:wrap">
${['small','normal','large','xlarge'].map(s=>`<button class="btn btn-sm${curScale===s?' btn-primary':' btn-secondary'}" onclick="applyFontScale('${s}');const D=loadData();D.settings.fontScale='${s}';saveData(D);nav('config')">${t('cfg_font_'+s)}</button>`).join('')}
</div></div>
<div class="form-group" style="margin-top:12px"><label>${t('cfg_dark_mode')}</label>
<button class="btn btn-sm${D.settings.darkMode?' btn-primary':' btn-secondary'}" onclick="const D=loadData();D.settings.darkMode=!D.settings.darkMode;saveData(D);applyDarkMode(D.settings.darkMode);nav('config')">${D.settings.darkMode?'🌙 ON':'☀️ OFF'}</button>
</div></div>`;
// Farm info
h+=`<div class="card"><h3>${t('cfg_farm')}</h3>
<div class="form-row"><div class="form-group"><label>${t('cfg_farm_name')}</label><input id="cfg-name" value="${escapeAttr(D.farm.name||'')}"></div>
<div class="form-group"><label>${t('cfg_location')}</label><input id="cfg-loc" value="${escapeAttr(D.farm.location||'')}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('cfg_capacity')}</label><input type="number" id="cfg-cap" value="${D.farm.capacity||''}" min="0"></div>
<div class="form-group"><label>${t('cfg_currency')}</label><input id="cfg-cur" value="${escapeAttr(D.farm.currency||'$')}" maxlength="5"></div></div>
<button class="btn btn-primary" onclick="saveConfig()">${t('save')}</button></div>`;
// Geolocation
h+=`<div class="card"><h3>${t('geo_set_location')}</h3>
<p style="color:var(--text-light);margin-bottom:8px">${D.farm.lat?t('geo_lat')+': '+D.farm.lat+' | '+t('geo_lng')+': '+D.farm.lng:t('geo_click_map')}</p>
<button class="btn btn-secondary" onclick="showGeoModal()">${t('geo_set_location')}</button></div>`;
// Weather API
h+=`<div class="card"><h3>${t('weather_title')} (OpenWeatherMap)</h3>
<div class="form-row"><div class="form-group"><label>API Key</label><input id="cfg-owm" value="${escapeAttr(D.farm.owmApiKey||'')}"></div>
<div class="form-group" style="display:flex;align-items:flex-end"><button class="btn btn-secondary" onclick="testWeatherApi()">Test</button></div></div>
<button class="btn btn-primary" onclick="saveWeatherConfig()">${t('save')}</button></div>`;
// MQTT / IoT
h+=`<div class="card"><h3>${t('iot_title')} (MQTT)</h3>
<div class="form-group"><label>${t('iot_broker')} (wss://)</label><input id="cfg-mqtt-broker" value="${escapeAttr(D.farm.mqttBroker||'')}" placeholder="wss://broker.example.com:8084/mqtt"></div>
<div class="form-row"><div class="form-group"><label>${t('cfg_farm_name')} (user)</label><input id="cfg-mqtt-user" value="${escapeAttr(D.farm.mqttUser||'')}"></div>
<div class="form-group"><label>Password</label><input type="password" id="cfg-mqtt-pass" value="${escapeAttr(D.farm.mqttPass||'')}"></div></div>
<div class="form-group"><label>Topic Prefix</label><input id="cfg-mqtt-prefix" value="${escapeAttr(D.farm.mqttTopicPrefix||'egglogu/')}"></div>
<button class="btn btn-primary" onclick="saveMqttConfig()">${t('save')}</button></div>`;
// Alert thresholds
h+=`<div class="card"><h3>${t('cfg_alerts')}</h3>
<div class="form-row-3"><div class="form-group"><label>${t('cfg_min_feed')}</label><input type="number" id="cfg-minfeed" value="${D.settings.minFeedStock||50}" min="0"></div>
<div class="form-group"><label>${t('cfg_max_mortality')}</label><input type="number" id="cfg-maxmort" value="${D.settings.maxMortality||5}" min="0" step="0.5"></div>
<div class="form-group"><label>${t('cfg_alert_days')}</label><input type="number" id="cfg-alertdays" value="${D.settings.alertDaysBefore||3}" min="1"></div></div>
<button class="btn btn-primary" onclick="saveAlertConfig()">${t('save')}</button></div>`;
// Default checklist
h+=`<div class="card"><h3>${t('cfg_checklist')}</h3><p style="color:var(--text-light);font-size:13px;margin-bottom:12px">${t('cfg_checklist_items')}</p>`;
(D.settings.defaultChecklist||[]).forEach((task,i)=>{
h+=`<div class="checklist-item"><span>${t(task)}</span><button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="removeChecklistItem(${i})">✕</button></div>`;});
h+=`<div style="margin-top:12px;display:flex;gap:8px"><input id="cfg-newtask" placeholder="${t('ops_task')}" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:var(--radius)">
<button class="btn btn-primary btn-sm" onclick="addChecklistItem()">${t('add')}</button></div></div>`;
// Tax & Depreciation Settings (A5)
h+=`<div class="card"><h3>${t('cfg_tax')||'Tax & Depreciation'}</h3>
<div class="form-row-3"><div class="form-group"><label>${t('cfg_tax_rate')||'Tax Rate (%)'}</label><input type="number" id="cfg-taxrate" value="${D.settings.taxRate||0}" min="0" max="100" step="0.5"></div>
<div class="form-group"><label>${t('cfg_dep_years')||'Depreciation (years)'}</label><input type="number" id="cfg-depyears" value="${D.settings.depreciationYears||5}" min="1" max="50"></div>
<div class="form-group"><label>${t('cfg_asset_value')||'Total Asset Value'}</label><input type="number" id="cfg-assetval" value="${D.settings.assetValue||0}" min="0"></div></div>
<button class="btn btn-primary" onclick="saveTaxConfig()">${t('save')}</button></div>`;
// User Management (A8) — 4-Layer Security
h+=`<div class="card"><h3>${t('cfg_users')||'User Management'}</h3>`;
// Owner email & plan settings
h+=`<div style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:12px">
<div class="form-row"><div class="form-group"><label>📧 Email del Dueño (para confirmaciones)</label>
<input type="email" id="cfg-owner-email" value="${escapeAttr(D.settings.ownerEmail||'')}" placeholder="dueño@correo.com" style="font-size:13px">
<span style="font-size:10px;color:var(--text-light)">Las activaciones se confirman desde este correo</span></div>
<div class="form-group"><label>Usuarios incluidos en plan</label>
<input type="number" id="cfg-plan-users" value="${(D.settings.plan?.includedUsers)||3}" min="1" max="50" style="font-size:13px"></div>
<div class="form-group"><label>Costo por usuario extra (${(D.settings.plan?.currency)||'USD'})</label>
<input type="number" id="cfg-plan-extra-cost" value="${(D.settings.plan?.extraUserCost)||5}" min="0" step="0.5" style="font-size:13px"></div></div>
<div class="form-row"><div class="form-group"><label>Ciclo de facturación</label>
<select id="cfg-plan-cycle" style="font-size:13px">
<option value="monthly"${(D.settings.plan?.billingCycle||'monthly')==='monthly'?' selected':''}>Mensual</option>
<option value="quarterly"${D.settings.plan?.billingCycle==='quarterly'?' selected':''}>Trimestral</option>
<option value="yearly"${D.settings.plan?.billingCycle==='yearly'?' selected':''}>Anual</option></select></div>
<div class="form-group"><label>Moneda</label>
<select id="cfg-plan-currency" style="font-size:13px">
<option value="USD"${(D.settings.plan?.currency||'USD')==='USD'?' selected':''}>USD</option>
<option value="CLP"${D.settings.plan?.currency==='CLP'?' selected':''}>CLP</option>
<option value="EUR"${D.settings.plan?.currency==='EUR'?' selected':''}>EUR</option>
<option value="MXN"${D.settings.plan?.currency==='MXN'?' selected':''}>MXN</option></select></div></div>
<button class="btn btn-primary btn-sm" onclick="savePlanConfig()">Guardar Config Plan</button></div>`;
const plan=D.settings.plan||{includedUsers:3,extraUserCost:5,billingCycle:'monthly',currency:'USD'};
const activeUsers=D.users.filter(u=>u.status==='active').length;
const pendingUsers=D.users.filter(u=>u.status==='pending').length;
const extraCount=Math.max(0,activeUsers-plan.includedUsers);
h+=`<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:12px">
<button class="btn btn-primary btn-sm" onclick="showUserForm()">${t('cfg_add_user')||'+ Agregar Usuario'}</button>
<div style="font-size:13px"><strong>Activos:</strong> ${activeUsers}/${plan.includedUsers}${pendingUsers?' | <span style="color:var(--warning)">'+pendingUsers+' pendientes</span>':''}${extraCount>0?' | <span style="color:var(--warning)">+'+extraCount+' extras ('+plan.currency+' '+((extraCount*plan.extraUserCost).toFixed(2))+'/'+plan.billingCycle+')</span>':''}</div>
</div>`;
h+=`<div style="background:rgba(33,150,243,.08);border:1px solid rgba(33,150,243,.2);border-radius:var(--radius);padding:10px;margin-bottom:12px;font-size:11px;color:var(--text-light)">
🔒 <strong>4 Capas de Seguridad:</strong> Re-autenticación PIN → Confirmación por email → Cobro proporcional → Auto-desactivación al fin del ciclo</div>`;
if(D.users.length){
h+='<div class="table-wrap"><table><thead><tr><th>'+t('name')+'</th><th>Email / ID</th><th>'+(t('cfg_role')||'Role')+'</th><th>Estado</th><th>'+t('actions')+'</th></tr></thead><tbody>';
D.users.forEach(u=>{
const statusBadge=u.status==='active'?'<span class="badge badge-success">Activo</span>':u.status==='pending'?'<span class="badge badge-warning">Pendiente</span>':u.status==='expired'?'<span class="badge badge-danger">Expirado</span>':'<span class="badge badge-secondary">Inactivo</span>';
const isExtra=u.isExtra||false;
const billingInfo=u.isExtra&&u.nextBillingDate?'<br><span style="font-size:10px;color:var(--text-light)">Prox. ciclo: '+u.nextBillingDate+'</span>':'';
const chargeInfo=u.firstCharge?'<br><span style="font-size:10px;color:var(--warning)">Cargo: '+(D.settings.plan?.currency||'USD')+' '+u.firstCharge.toFixed(2)+'</span>':'';
const deactInfo=u.deactivatedAt?'<br><span style="font-size:10px;color:var(--text-light)">Desact: '+u.deactivatedAt+'</span>':'';
h+=`<tr><td><strong>${sanitizeHTML(u.name)}</strong>${isExtra?'<br><span style="font-size:10px;color:var(--warning)">Usuario adicional</span>':''}</td>
<td style="font-size:12px">${u.role==='worker'?(u.workerId?'<code>'+sanitizeHTML(u.workerId)+'</code>':'—'):sanitizeHTML(u.email||'—')}</td>
<td><span class="badge badge-${u.role==='owner'?'success':u.role==='manager'?'info':u.role==='vet'?'warning':'secondary'}">${u.role}</span></td>
<td>${statusBadge}${u.activatedAt?'<br><span style="font-size:10px;color:var(--text-light)">'+u.activatedAt+'</span>':''}${billingInfo}${chargeInfo}${deactInfo}</td>
<td><div class="btn-group">${u.status==='active'||u.status==='pending'?'<button class="btn btn-secondary btn-sm" onclick="showUserForm(\''+escapeAttr(u.id)+'\')">'+t('edit')+'</button>':''}
${u.status==='active'?'<button class="btn btn-danger btn-sm" onclick="deactivateUser(\''+escapeAttr(u.id)+'\')">Desactivar</button>':''}
${u.status==='pending'&&u.activationToken?'<button class="btn btn-primary btn-sm" onclick="resendActivation(\''+escapeAttr(u.id)+'\')">Reenviar</button>':''}
${u.status==='inactive'||u.status==='expired'?'<button class="btn btn-primary btn-sm" onclick="reactivateUser(\''+escapeAttr(u.id)+'\')">Reactivar</button><button class="btn btn-danger btn-sm" onclick="removeUser(\''+escapeAttr(u.id)+'\')">Eliminar</button>':''}</div></td></tr>`;});
h+='</tbody></table></div>';}else{h+=`<p style="color:var(--text-light)">${t('cfg_no_users')||'No users configured. App runs without authentication.'}</p>`;}
h+='</div>';
// Role Permissions Customization
if(_currentUser.role==='owner'){
h+=`<div class="card"><h3>Permisos por Rol</h3><p style="color:var(--text-light);font-size:13px;margin-bottom:12px">Personaliza qué módulos ve cada rol. Dashboard siempre visible.</p>`;
h+='<div class="table-wrap"><table id="perms-table"><thead><tr><th>Módulo</th><th>Grupo</th><th>Manager</th><th>Worker</th><th>Vet</th></tr></thead><tbody>';
const groupNames={production:'Producción',health:'Salud',commercial:'Comercial',management:'Gestión',system:'Sistema'};
const allMods=['produccion','lotes','alimento','ambiente','sanidad','bioseguridad','clientes','inventario','finanzas','analisis','operaciones','trazabilidad','planificacion','config'];
const modGroup={};Object.entries(MODULE_GROUPS).forEach(([g,ms])=>ms.forEach(m=>modGroup[m]=g));
const customPerms=D.settings.customPermissions||{};
allMods.forEach(m=>{
const grp=modGroup[m]||'?';const label=t('nav_'+{produccion:'production',lotes:'flocks',alimento:'feed',ambiente:'environment',sanidad:'health',bioseguridad:'biosecurity',clientes:'clients',inventario:'inventory',finanzas:'finances',analisis:'analysis',operaciones:'operations',trazabilidad:'traceability',planificacion:'planning',config:'config'}[m])||m;
h+=`<tr><td>${label}</td><td><span class="badge badge-secondary" style="font-size:10px">${groupNames[grp]||grp}</span></td>`;
['manager','worker','vet'].forEach(role=>{
const base=ROLE_PERMISSIONS[role]||[];
const custom=customPerms[role];
const has=custom?custom.includes(m):base.includes(m);
const allowed=(ROLE_MAX_MODULES[role]||[]).includes(m);
h+=`<td style="text-align:center">${allowed?`<input type="checkbox" data-role="${role}" data-mod="${m}" ${has?'checked':''} onchange="toggleRolePerm(this)">`:'<span style="color:var(--text-light);font-size:11px" title="No aplica al perfil">—</span>'}</td>`;
});
h+='</tr>';
});
h+=`</tbody></table></div><div style="margin-top:12px"><button class="btn btn-secondary btn-sm" onclick="resetPermsToDefault()">Restaurar Defaults</button></div></div>`;
}
// Auto-Backup Manager (A7)
h+=`<div class="card"><h3>${t('cfg_backups')||'Auto-Backup'}</h3>
<div id="backup-list"><p style="color:var(--text-light)">${t('cfg_loading')||'Loading...'}</p></div></div>`;
// localStorage Usage Meter (A7)
const storageUsed=getStorageUsage();const storageMax=5*1024*1024;const storagePct=Math.min(100,(storageUsed/storageMax)*100);
h+=`<div class="card"><h3>${t('cfg_storage')||'Storage Usage'}</h3>
<div style="background:var(--border);border-radius:8px;height:24px;overflow:hidden;margin-bottom:8px">
<div style="background:${storagePct>80?'var(--danger)':storagePct>60?'var(--warning)':'var(--success)'};height:100%;width:${storagePct}%;border-radius:8px;transition:width .3s"></div></div>
<p style="color:var(--text-light);font-size:13px">${(storageUsed/1024).toFixed(1)} KB / ${(storageMax/1024).toFixed(0)} KB (${storagePct.toFixed(1)}%)</p></div>`;
// Data management
h+=`<div class="card"><h3>${t('cfg_data')}</h3><div class="btn-group">
<button class="btn btn-secondary" onclick="exportData()">${t('cfg_export')}</button>
<button class="btn btn-secondary" onclick="$('cfg-import-file').click()">${t('cfg_import')}</button>
<input type="file" id="cfg-import-file" accept=".json" style="display:none" onchange="importData(event)">
<button class="btn btn-danger" onclick="resetData()">${t('cfg_reset')}</button></div></div>`;
// Audit Log Viewer (A3)
h+=`<div class="card"><h3>${t('cfg_audit')||'Audit Log'}</h3>
<div class="filter-bar" style="margin-bottom:12px"><input type="date" id="audit-from" onchange="renderAuditLog()"><input type="date" id="audit-to" onchange="renderAuditLog()">
<input id="audit-search" placeholder="${t('search')||'Search...'}" oninput="renderAuditLog()" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:var(--radius)"></div>
<div id="audit-log-table"></div></div>`;
// Stats
const stats={flocks:D.flocks.length,production:D.dailyProduction.length,vaccines:D.vaccines.length,
medications:D.medications.length,outbreaks:D.outbreaks.length,feedPurchases:D.feed.purchases.length,
feedConsumption:D.feed.consumption.length,clients:D.clients.length,income:D.finances.income.length,
expenses:D.finances.expenses.length,environment:D.environment.length,logbook:D.logbook.length,
personnel:D.personnel.length,snapshots:D.kpiSnapshots.length,inventory:D.inventory.length,auditLog:D.auditLog.length,users:D.users.length};
h+='<div class="card"><h3>'+t('data_stats')+'</h3>';
Object.entries(stats).forEach(([k,v])=>{h+=`<div class="stat-row"><span class="stat-label">${k}</span><span class="stat-value">${v}</span></div>`;});
h+='</div>';
$('sec-config').innerHTML=h;
// Load backup list asynchronously
loadBackupList();renderAuditLog();
}
function saveConfig(){
const D=loadData();D.farm.name=$('cfg-name').value;D.farm.location=$('cfg-loc').value;
D.farm.capacity=parseInt($('cfg-cap').value)||0;D.farm.currency=$('cfg-cur').value||'$';
saveData(D);toast(t('cfg_saved'));
}
function saveAlertConfig(){
const D=loadData();D.settings.minFeedStock=parseFloat($('cfg-minfeed').value)||50;
D.settings.maxMortality=parseFloat($('cfg-maxmort').value)||5;
D.settings.alertDaysBefore=parseInt($('cfg-alertdays').value)||3;
saveData(D);toast(t('cfg_saved'));
}
function addChecklistItem(){const v=$('cfg-newtask')?.value;if(!v)return;const D=loadData();if(!D.settings.defaultChecklist)D.settings.defaultChecklist=[];D.settings.defaultChecklist.push(v);saveData(D);renderConfig();}
function removeChecklistItem(i){const D=loadData();D.settings.defaultChecklist.splice(i,1);saveData(D);renderConfig();}
// Tax & Depreciation config save (A5)
function saveTaxConfig(){
const D=loadData();D.settings.taxRate=parseFloat($('cfg-taxrate').value)||0;
D.settings.depreciationYears=parseInt($('cfg-depyears').value)||5;
D.settings.assetValue=parseFloat($('cfg-assetval').value)||0;
logAudit('update','config','Tax/Depreciation settings updated',null,{taxRate:D.settings.taxRate,depreciationYears:D.settings.depreciationYears,assetValue:D.settings.assetValue});
saveData(D);toast(t('cfg_saved'));
}
function savePlanConfig(){
const D=loadData();const before=JSON.parse(JSON.stringify(D.settings.plan||{}));
if(!D.settings.plan)D.settings.plan={};
D.settings.ownerEmail=($('cfg-owner-email')?.value||'').trim();
D.settings.plan.includedUsers=parseInt($('cfg-plan-users')?.value)||3;
D.settings.plan.extraUserCost=parseFloat($('cfg-plan-extra-cost')?.value)||5;
D.settings.plan.billingCycle=$('cfg-plan-cycle')?.value||'monthly';
D.settings.plan.currency=$('cfg-plan-currency')?.value||'USD';
logAudit('update','config','Plan settings updated',before,D.settings.plan);
saveData(D);toast(t('cfg_saved'));renderConfig();
}
// User Management (A8) — 4-Layer Activation Security
// L1: Owner PIN re-auth | L2: Email confirmation | L3: Proportional billing | L4: Auto-deactivation
function showUserForm(id){
const D=loadData();const u=id?D.users.find(x=>x.id===id):null;
const plan=D.settings.plan||{includedUsers:3,extraUserCost:5,billingCycle:'monthly',currency:'USD'};
const activeCount=D.users.filter(x=>x.status==='active').length;
const isExtraUser=!id&&activeCount>=plan.includedUsers;
const billingNotice=isExtraUser?`<div style="background:rgba(255,152,0,.1);border:1px solid var(--warning);border-radius:var(--radius);padding:10px;margin-bottom:12px;font-size:12px">
<strong>⚠ Usuario adicional</strong> — Se cobrará ${plan.currency} ${plan.extraUserCost.toFixed(2)} proporcional desde la fecha de activación hasta fin del ciclo (${plan.billingCycle}).</div>`:'';
const editRole=u?u.role:'worker';
openModal(u?(t('edit')):t('cfg_add_user')||'Add User',`${billingNotice}
<div class="form-row"><div class="form-group"><label>${t('name')}</label><input id="usr-name" value="${u?escapeAttr(u.name):''}"></div>
<div class="form-group"><label>${t('cfg_role')||'Role'}</label><select id="usr-role" onchange="toggleEmailField()">
<option value="owner"${editRole==='owner'?' selected':''}>Owner</option>
<option value="manager"${editRole==='manager'?' selected':''}>Manager</option>
<option value="worker"${editRole==='worker'?' selected':''}>Worker</option>
<option value="vet"${editRole==='vet'?' selected':''}>Vet</option></select></div></div>
<div class="form-row" id="email-row" style="${editRole==='worker'?'display:none':''}">
<div class="form-group"><label>Email ${editRole==='worker'?'(opcional)':'*'}</label><input type="email" id="usr-email" value="${u?escapeAttr(u.email||''):''}" placeholder="usuario@correo.com"></div></div>
<div class="form-row" id="worker-id-row" style="${editRole==='worker'?'':'display:none'}">
<div class="form-group"><label>Worker ID</label><input id="usr-worker-id" value="${u?escapeAttr(u.workerId||''):''}" placeholder="Ej: OP-001"></div></div>
<div class="form-row"><div class="form-group"><label>PIN (4 ${t('cfg_digits')||'digits'})</label><input type="password" id="usr-pin" maxlength="4" pattern="[0-9]{4}" value="${u?u.pin:''}" placeholder="0000" inputmode="numeric"></div></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveUser('${id||''}')">${t('save')}</button></div>`);
}
function toggleEmailField(){
const role=$('usr-role')?.value;const emailRow=$('email-row');const workerRow=$('worker-id-row');
const emailLabel=emailRow?.querySelector('label');
if(role==='worker'){if(emailRow)emailRow.style.display='none';if(workerRow)workerRow.style.display='';
}else{if(emailRow)emailRow.style.display='';if(workerRow)workerRow.style.display='none';if(emailLabel)emailLabel.textContent='Email *';}
}
function saveUser(id){
const D=loadData();
const o={name:$('usr-name').value.trim(),role:$('usr-role').value,pin:$('usr-pin').value,email:($('usr-email')?.value||'').trim()};
if(o.role==='worker'){o.workerId=($('usr-worker-id')?.value||'').trim();o.email=o.email||'';}
if(!o.name){toast(t('required')||'Required',true);return;}
// Email obligatorio para owner/manager/vet — opcional para worker
if(o.role!=='worker'&&(!o.email||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o.email))){toast('Email válido requerido para '+o.role,true);return;}
if(o.role==='worker'&&!o.workerId){toast('Worker ID requerido',true);return;}
if(o.pin&&(o.pin.length!==4||!/^\d{4}$/.test(o.pin))){toast('PIN debe ser 4 dígitos numéricos',true);return;}
if(id){
const i=D.users.findIndex(u=>u.id===id);
if(i>=0){logAudit('update','users','Edit user: '+o.name,D.users[i],o);D.users[i]={...D.users[i],...o};}
saveData(D);closeModal();toast(t('cfg_saved'));refreshUserSection();
}else{
// New user → trigger 4-layer activation flow
closeModal();
requestUserActivation(o,D);
}
}
// LAYER 1: Owner PIN re-authentication
function requestUserActivation(newUser,D){
if(_currentUser.role!=='owner'){toast('Solo el dueño puede agregar usuarios',true);return;}
openModal('🔒 Verificación de Seguridad',`
<p style="color:var(--text-light);font-size:13px;margin-bottom:16px">Para agregar un nuevo usuario se requiere verificación del dueño. Ingrese su PIN para continuar.</p>
<div style="text-align:center;margin-bottom:16px">
<div style="font-size:13px;margin-bottom:8px"><strong>${newUser.name}</strong> (${newUser.role})</div>
<div style="font-size:12px;color:var(--text-light)">${newUser.email}</div>
</div>
<div class="form-group" style="max-width:200px;margin:0 auto">
<label>PIN del Dueño</label>
<input type="password" id="auth-owner-pin" maxlength="4" pattern="[0-9]{4}" placeholder="••••" inputmode="numeric" style="text-align:center;font-size:20px;letter-spacing:8px">
<p id="auth-pin-error" style="color:var(--danger);font-size:11px;margin-top:4px;display:none"></p>
</div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="verifyOwnerForActivation()">Verificar y Enviar Confirmación</button></div>`);
// Store pending user data temporarily
window._pendingActivation=newUser;
setTimeout(()=>{const el=$('auth-owner-pin');if(el)el.focus();},100);
}
// LAYER 1b: Verify owner PIN
function verifyOwnerForActivation(){
const D=loadData();const pin=$('auth-owner-pin')?.value||'';
const owner=D.users.find(u=>u.id===_currentUser.id);
if(!owner){toast('Usuario dueño no encontrado',true);return;}
if(owner.pin&&owner.pin!==pin){
$('auth-pin-error').textContent='PIN incorrecto';$('auth-pin-error').style.display='block';
$('auth-owner-pin').value='';$('auth-owner-pin')?.focus();
logAudit('auth_fail','users','Owner PIN verification failed for new user activation',null,{attemptedFor:window._pendingActivation?.name});
return;
}
logAudit('auth_success','users','Owner PIN verified for activation: '+window._pendingActivation?.name,null,{owner:_currentUser.name});
closeModal();
const pending=window._pendingActivation;
if(pending.role==='worker'){
// Workers: activate directly after PIN re-auth (no email required)
activateWorkerDirect(pending);
}else{
// Admin/Manager/Vet: LAYER 2 — email confirmation required
sendActivationConfirmation(pending,D);
}
}
// Direct activation for workers (no email layer)
function activateWorkerDirect(newUser){
const D=loadData();const plan=D.settings.plan||{includedUsers:3,extraUserCost:5,billingCycle:'monthly',currency:'USD'};
const activeCount=D.users.filter(x=>x.status==='active').length;
const isExtra=activeCount>=plan.includedUsers;
const now=new Date();
let userObj;
if(newUser._reactivateId){
userObj=D.users.find(u=>u.id===newUser._reactivateId);
if(!userObj){toast('Usuario no encontrado',true);return;}
}else{
userObj={id:genId(),name:newUser.name,role:'worker',pin:newUser.pin,workerId:newUser.workerId,email:newUser.email||'',created:todayStr()};
D.users.push(userObj);
}
userObj.status='active';userObj.activatedAt=now.toISOString().split('T')[0];
userObj.billingStart=now.toISOString();userObj.isExtra=isExtra;
userObj.confirmedBy=_currentUser.name;userObj.confirmedAt=now.toISOString();
if(isExtra){
const daysInCycle=plan.billingCycle==='monthly'?30:plan.billingCycle==='quarterly'?90:365;
const remainingDays=daysInCycle-now.getDate()+1;
userObj.firstCharge=Math.round((plan.extraUserCost/daysInCycle)*remainingDays*100)/100;
userObj.nextBillingDate=getNextBillingDate(plan.billingCycle);
}
logAudit('activation_direct','users','Worker activated directly: '+userObj.name+' ('+userObj.workerId+')',null,{user:userObj.name,workerId:userObj.workerId,isExtra,confirmedBy:_currentUser.name});
saveData(D);toast('✅ '+userObj.name+' ('+userObj.workerId+') activado');refreshUserSection();
window._pendingActivation=null;
}
// LAYER 2: Email confirmation to owner
function sendActivationConfirmation(newUser,D){
if(!D)D=loadData();
const token=genId()+'-'+Date.now().toString(36);
const plan=D.settings.plan||{includedUsers:3,extraUserCost:5,billingCycle:'monthly',currency:'USD'};
const activeCount=D.users.filter(x=>x.status==='active').length;
const isExtra=activeCount>=plan.includedUsers;
let userObj;
if(newUser._reactivateId){
// Reactivation of existing user
userObj=D.users.find(u=>u.id===newUser._reactivateId);
if(userObj){userObj.status='pending';userObj.activationToken=token;userObj.requestedBy=_currentUser.name;userObj.requestedAt=new Date().toISOString();userObj.isExtra=isExtra;userObj.billingStart=null;}
else{toast('Usuario no encontrado',true);return;}
}else{
// New user in pending state
userObj={
id:genId(),name:newUser.name,email:newUser.email,role:newUser.role,pin:newUser.pin,
status:'pending',created:todayStr(),activationToken:token,
requestedBy:_currentUser.name,requestedAt:new Date().toISOString(),
isExtra:isExtra,billingStart:null,activatedAt:null
};
D.users.push(userObj);
}
// Store pending activation
if(!D.pendingActivations)D.pendingActivations=[];
D.pendingActivations.push({token,userId:userObj.id,createdAt:new Date().toISOString(),expiresAt:new Date(Date.now()+24*60*60*1000).toISOString()});
logAudit('create','users','User created (pending): '+newUser.name+' — awaiting email confirmation',null,{user:userObj.name,role:userObj.role,email:userObj.email,isExtra});
saveData(D);
// Show confirmation email simulation (in a real deployment this sends via ProtonMail Bridge)
const ownerEmail=D.settings.ownerEmail||_currentUser.email||'dueño@correo.com';
const costLine=isExtra?`<br><span style="color:var(--warning)">Costo adicional: ${plan.currency} ${plan.extraUserCost.toFixed(2)}/${plan.billingCycle} (proporcional)</span>`:'<br><span style="color:var(--success)">Incluido en el plan (sin costo adicional)</span>';
openModal('📧 Confirmación Enviada',`
<div style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px">
<div style="font-size:11px;color:var(--text-light);margin-bottom:8px">EMAIL DE CONFIRMACIÓN</div>
<div style="font-size:13px"><strong>Para:</strong> ${sanitizeHTML(ownerEmail)}</div>
<div style="font-size:13px"><strong>Asunto:</strong> EGGlogU — Confirmar activación de usuario</div>
<hr style="border:none;border-top:1px solid var(--border);margin:12px 0">
<p style="font-size:13px">Se ha solicitado la activación del siguiente usuario:</p>
<div style="background:var(--card);border-radius:var(--radius);padding:12px;margin:8px 0">
<div><strong>${sanitizeHTML(newUser.name)}</strong> — ${newUser.role}</div>
<div style="font-size:12px;color:var(--text-light)">${sanitizeHTML(newUser.email)}</div>
${costLine}
</div>
<p style="font-size:12px;color:var(--text-light)">Solicitado por: ${sanitizeHTML(_currentUser.name)} el ${new Date().toLocaleString()}</p>
<p style="font-size:12px;color:var(--text-light)">Token de confirmación: <code style="font-size:11px">${token.substring(0,8)}...</code></p>
</div>
<p style="font-size:13px;text-align:center;margin-bottom:8px">Para activar, haga clic en el botón de abajo (simula confirmación por email):</p>
<div style="text-align:center;margin-bottom:12px">
<button class="btn btn-primary" onclick="confirmUserActivation('${token}')" style="padding:10px 24px">
✅ Confirmar Activación</button>
</div>
<p style="font-size:11px;color:var(--text-light);text-align:center">Este enlace expira en 24 horas. Si no solicitó esto, ignore este mensaje.</p>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal();refreshUserSection()">Cerrar (confirmar después)</button></div>`);
window._pendingActivation=null;
}
// LAYER 2b: Confirm activation (simulates email link click)
function confirmUserActivation(token){
const D=loadData();
const pending=D.pendingActivations?.find(p=>p.token===token);
if(!pending){toast('Token de activación inválido o expirado',true);return;}
if(new Date(pending.expiresAt)<new Date()){
toast('Token expirado. Solicite una nueva activación.',true);
logAudit('activation_expired','users','Activation token expired',null,{token:token.substring(0,8)});
return;
}
const user=D.users.find(u=>u.id===pending.userId);
if(!user){toast('Usuario no encontrado',true);return;}
// LAYER 3: Activate with proportional billing
const now=new Date();
user.status='active';
user.activatedAt=now.toISOString().split('T')[0];
user.billingStart=now.toISOString();
user.activationToken=null;
user.confirmedBy=_currentUser.name;
user.confirmedAt=now.toISOString();
// Calculate proportional cost
if(user.isExtra){
const plan=D.settings.plan||{includedUsers:3,extraUserCost:5,billingCycle:'monthly',currency:'USD'};
const daysInCycle=plan.billingCycle==='monthly'?30:plan.billingCycle==='quarterly'?90:365;
const dayOfCycle=now.getDate();
const remainingDays=daysInCycle-dayOfCycle+1;
const proportionalCost=(plan.extraUserCost/daysInCycle)*remainingDays;
user.firstCharge=Math.round(proportionalCost*100)/100;
user.nextBillingDate=getNextBillingDate(plan.billingCycle);
logAudit('billing','users','Extra user activated — proportional charge: '+plan.currency+' '+user.firstCharge.toFixed(2)+' for '+remainingDays+' remaining days',null,
{user:user.name,charge:user.firstCharge,currency:plan.currency,remainingDays,nextBilling:user.nextBillingDate});
}
// Remove from pending
D.pendingActivations=D.pendingActivations.filter(p=>p.token!==token);
logAudit('activation_confirmed','users','User activated: '+user.name+' — confirmed by owner via email',
{status:'pending'},{status:'active',activatedAt:user.activatedAt,confirmedBy:user.confirmedBy});
saveData(D);closeModal();
toast('✅ '+user.name+' activado correctamente');
refreshUserSection();
}
// LAYER 3 helper: Next billing date
function getNextBillingDate(cycle){
const d=new Date();
if(cycle==='monthly'){d.setMonth(d.getMonth()+1);d.setDate(1);}
else if(cycle==='quarterly'){d.setMonth(d.getMonth()+3);d.setDate(1);}
else{d.setFullYear(d.getFullYear()+1);d.setMonth(0);d.setDate(1);}
return d.toISOString().split('T')[0];
}
// LAYER 4: Deactivate user (manual or auto at billing cycle end)
async function deactivateUser(id){
const D=loadData();const u=D.users.find(x=>x.id===id);
if(!u){toast('Usuario no encontrado',true);return;}
if(u.role==='owner'&&D.users.filter(x=>x.role==='owner'&&x.status==='active').length<=1){
toast('No se puede desactivar el último dueño activo',true);return;}
if(!await showConfirm(`¿Desactivar a ${u.name}? El usuario perderá acceso al sistema. ${u.isExtra?'Se dejará de cobrar en el siguiente ciclo.':''}`))return;
// Re-authenticate owner
openModal('🔒 Confirmar Desactivación',`
<p style="font-size:13px;margin-bottom:12px">Ingrese su PIN para confirmar la desactivación de <strong>${sanitizeHTML(u.name)}</strong>.</p>
<div class="form-group" style="max-width:200px;margin:0 auto">
<label>PIN del Dueño</label>
<input type="password" id="deact-pin" maxlength="4" inputmode="numeric" style="text-align:center;font-size:20px;letter-spacing:8px">
</div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-danger" onclick="executeDeactivation('${escapeAttr(id)}')">Desactivar</button></div>`);
setTimeout(()=>{const el=$('deact-pin');if(el)el.focus();},100);
}
function executeDeactivation(id){
const D=loadData();const pin=$('deact-pin')?.value||'';
const owner=D.users.find(u=>u.id===_currentUser.id);
if(owner?.pin&&owner.pin!==pin){toast('PIN incorrecto',true);$('deact-pin').value='';return;}
const u=D.users.find(x=>x.id===id);if(!u)return;
const before={status:u.status,activatedAt:u.activatedAt};
u.status='inactive';u.deactivatedAt=new Date().toISOString().split('T')[0];u.deactivatedBy=_currentUser.name;
logAudit('deactivation','users','User deactivated: '+u.name+' by '+_currentUser.name,before,{status:'inactive',deactivatedAt:u.deactivatedAt});
saveData(D);closeModal();toast(u.name+' desactivado');refreshUserSection();
}
// Auto-deactivation check (LAYER 4) — runs on app load
function checkBillingCycleDeactivations(){
const D=loadData();const today=todayStr();let changed=false;
D.users.forEach(u=>{
if(u.status==='active'&&u.isExtra&&u.nextBillingDate&&u.nextBillingDate<=today){
u.status='inactive';u.deactivatedAt=today;u.deactivatedBy='system_billing';
logAudit('auto_deactivation','users','Auto-deactivated at billing cycle end: '+u.name,{status:'active'},{status:'inactive',reason:'billing_cycle_end'});
changed=true;
}
// Expire pending activations older than 24h
});
if(D.pendingActivations){
const before=D.pendingActivations.length;
D.pendingActivations=D.pendingActivations.filter(p=>new Date(p.expiresAt)>new Date());
if(D.pendingActivations.length<before){
D.users.forEach(u=>{if(u.status==='pending'&&u.activationToken){
const still=D.pendingActivations.find(p=>p.userId===u.id);
if(!still){u.status='expired';logAudit('activation_expired','users','Pending activation expired: '+u.name,null,null);changed=true;}
}});
}
}
if(changed)saveData(D);
}
// Resend activation email for pending users
function resendActivation(id){
const D=loadData();const u=D.users.find(x=>x.id===id);
if(!u||u.status!=='pending'){toast('Usuario no está pendiente',true);return;}
// Remove old token
if(D.pendingActivations)D.pendingActivations=D.pendingActivations.filter(p=>p.userId!==id);
// Create new token
const token=genId()+'-'+Date.now().toString(36);
u.activationToken=token;
if(!D.pendingActivations)D.pendingActivations=[];
D.pendingActivations.push({token,userId:id,createdAt:new Date().toISOString(),expiresAt:new Date(Date.now()+24*60*60*1000).toISOString()});
logAudit('resend_activation','users','Resent activation for: '+u.name,null,{newToken:token.substring(0,8)});
saveData(D);
sendActivationConfirmation({name:u.name,email:u.email,role:u.role},D);
}
// Reactivate inactive/expired user (triggers full 4-layer flow again)
function reactivateUser(id){
const D=loadData();const u=D.users.find(x=>x.id===id);
if(!u){toast('Usuario no encontrado',true);return;}
if(_currentUser.role!=='owner'){toast('Solo el dueño puede reactivar usuarios',true);return;}
// Re-trigger activation with existing user data
requestUserActivation({name:u.name,email:u.email,role:u.role,pin:u.pin,_reactivateId:id},D);
}
// Permanently remove inactive user
async function removeUser(id){
const D=loadData();const u=D.users.find(x=>x.id===id);
if(!u){return;}
if(u.status==='active'){toast('Desactive el usuario antes de eliminarlo',true);return;}
if(!await showConfirm('¿Eliminar permanentemente a '+u.name+'? Esta acción no se puede deshacer.'))return;
logAudit('delete','users','Permanently removed user: '+u.name,u,null);
D.users=D.users.filter(x=>x.id!==id);
if(D.pendingActivations)D.pendingActivations=D.pendingActivations.filter(p=>p.userId!==id);
saveData(D);toast(u.name+' eliminado');refreshUserSection();
}
// Backup list loader (A7)
async function loadBackupList(){
const el=$('backup-list');if(!el)return;
try{const backups=await listBackups();
if(!backups.length){el.innerHTML=`<p style="color:var(--text-light)">${t('cfg_no_backups')||'No auto-backups yet. Backups are created automatically after each save.'}</p>`;return;}
let h='<div class="table-wrap"><table><thead><tr><th>'+t('date')+'</th><th>'+(t('cfg_size')||'Size')+'</th><th>'+t('actions')+'</th></tr></thead><tbody>';
backups.forEach(b=>{h+=`<tr><td>${b.date}</td><td>${(b.size/1024).toFixed(1)} KB</td>
<td><button class="btn btn-secondary btn-sm" onclick="doRestore('${escapeAttr(b.url)}')">${t('cfg_restore')||'Restore'}</button></td></tr>`;});
h+='</tbody></table></div>';el.innerHTML=h;
}catch(e){el.innerHTML=`<p style="color:var(--text-light)">${t('cfg_backup_na')||'Cache API not available in this browser.'}</p>`;}
}
async function doRestore(url){if(!await showConfirm(t('cfg_restore_confirm')||'Restore from this backup? Current data will be replaced.'))return;
try{await restoreBackup(url);toast(t('cfg_restored')||'Backup restored');nav('dashboard');}catch(e){toast(t('error_unexpected')+': '+e.message,true);}
}
// Audit Log Viewer (A3)
function toggleRolePerm(el){
const role=el.dataset.role;const mod=el.dataset.mod;const D=loadData();
if(!D.settings.customPermissions)D.settings.customPermissions={};
if(!D.settings.customPermissions[role]){D.settings.customPermissions[role]=[...(ROLE_PERMISSIONS[role]||[])];}
const perms=D.settings.customPermissions[role];
const maxAllowed=ROLE_MAX_MODULES[role]||[];
if(el.checked&&!perms.includes(mod)){if(!maxAllowed.includes(mod)){el.checked=false;toast('Módulo no aplica a este perfil',true);return;}perms.push(mod);}
if(!el.checked){const i=perms.indexOf(mod);if(i>=0)perms.splice(i,1);}
// Always keep dashboard
if(!perms.includes('dashboard'))perms.unshift('dashboard');
// Update live ROLE_PERMISSIONS
ROLE_PERMISSIONS[role]=perms;
logAudit('update','config','Role permissions changed: '+role+' -> '+mod+' '+(el.checked?'ON':'OFF'),null,{role,mod,enabled:el.checked});
saveData(D);toast('Permisos actualizados');
}
function resetPermsToDefault(){
const D=loadData();delete D.settings.customPermissions;
Object.keys(DEFAULT_ROLE_PERMS).forEach(r=>{ROLE_PERMISSIONS[r]=[...DEFAULT_ROLE_PERMS[r]];});
logAudit('update','config','Role permissions reset to defaults');
saveData(D);renderConfig();toast('Permisos restaurados');
}
function applyCustomPermissions(){
const D=loadData();if(!D.settings.customPermissions)return;
Object.entries(D.settings.customPermissions).forEach(([role,perms])=>{
ROLE_PERMISSIONS[role]=perms;
});
}

function renderAuditLog(){
const D=loadData();const fr=$('audit-from')?.value||'';const to=$('audit-to')?.value||'';const q=($('audit-search')?.value||'').toLowerCase();
let recs=[...D.auditLog].sort((a,b)=>(b.ts||'').localeCompare(a.ts||''));
if(fr)recs=recs.filter(r=>(r.ts||'').substring(0,10)>=fr);
if(to)recs=recs.filter(r=>(r.ts||'').substring(0,10)<=to);
if(q)recs=recs.filter(r=>(r.action||'').toLowerCase().includes(q)||(r.module||'').toLowerCase().includes(q)||(r.detail||'').toLowerCase().includes(q)||(r.user||'').toLowerCase().includes(q));
const pg=paginate(recs,_pageState.auditLog||1,PAGE_SIZE);
let h='<div class="table-wrap"><table><thead><tr><th>'+(t('cfg_timestamp')||'Time')+'</th><th>'+(t('cfg_user')||'User')+'</th><th>'+(t('cfg_action')||'Action')+'</th><th>'+(t('cfg_module')||'Module')+'</th><th>'+(t('cfg_detail')||'Detail')+'</th></tr></thead><tbody>';
if(!pg.items.length)h+=`<tr><td colspan="5" style="text-align:center;color:var(--text-light)">${t('no_data')}</td></tr>`;
pg.items.forEach(r=>{h+=`<tr><td style="font-size:12px;white-space:nowrap">${(r.ts||'').replace('T',' ').substring(0,19)}</td><td>${sanitizeHTML(r.user||'-')}</td>
<td><span class="badge badge-${r.action==='create'?'success':r.action==='delete'?'danger':'info'}">${r.action}</span></td>
<td>${sanitizeHTML(r.module||'-')}</td><td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis">${sanitizeHTML(r.detail||'-')}</td></tr>`;});
h+='</tbody></table></div>';
h+=paginationControls('auditLog',pg.page,pg.totalPages,function(p){_pageState.auditLog=p;renderAuditLog();});
const el=$('audit-log-table');if(el)el.innerHTML=h;
}
function exportData(){
const D=loadData();const blob=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});
const a=document.createElement('a');a.href=URL.createObjectURL(blob);
a.download='egglogu_backup_'+todayStr()+'.json';a.click();toast(t('cfg_exported'));
}
function importData(e){
const file=e.target.files[0];if(!file)return;
const reader=new FileReader();reader.onload=function(ev){
try{const d=JSON.parse(ev.target.result);
DATA=d;saveData(d);toast(t('cfg_imported'));nav('config');
}catch(err){toast((t('error_unexpected')||'Error')+': '+sanitizeHTML(err.message),true);}};
reader.readAsText(file);e.target.value='';
}
async function resetData(){
if(!await showConfirm(t('cfg_reset_confirm')))return;if(!await showConfirm(t('final_warning')))return;
localStorage.removeItem('egglogu_data');DATA=null;loadData();toast(t('cfg_reset_done'));nav('dashboard');
}
// === END CONFIG ===

// ============ WEATHER API (OpenWeatherMap) ============
let weatherTimer=null;
async function fetchWeather(){
const D=loadData();if(!D.farm.owmApiKey||D.farm.lat===null||D.farm.lng===null)return;
const cached=D.weatherCache.find(w=>Date.now()-w.ts<1800000);
if(cached){renderWeatherWidget(cached);return;}
try{
const r=await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${encodeURIComponent(D.farm.lat)}&lon=${encodeURIComponent(D.farm.lng)}&appid=${encodeURIComponent(D.farm.owmApiKey)}&units=metric`);
if(!r.ok)throw new Error('HTTP '+r.status);
const d=await r.json();
if(d.cod&&d.cod!==200)return;
const w={ts:Date.now(),temp:d.main.temp,humidity:d.main.humidity,wind:d.wind.speed,
desc:d.weather[0].description,icon:d.weather[0].icon,feelsLike:d.main.feels_like};
D.weatherCache.push(w);if(D.weatherCache.length>48)D.weatherCache=D.weatherCache.slice(-24);
saveData(D);renderWeatherWidget(w);
const thi=calcTHI(w.temp,w.humidity);
if(thi>28)autoStressEvent(D,'heat',Math.min(5,Math.round((thi-28)/2)+1),`THI=${thi.toFixed(1)}, T=${w.temp}°C, H=${w.humidity}%`);
}catch(e){console.warn('Weather fetch error:',e.message);const el=document.getElementById('weather-widget');if(el)el.innerHTML='<div style="padding:8px;color:var(--text-light);font-size:13px">'+sanitizeHTML(t('error_network'))+'</div>';}
}
async function fetchForecast(){
const D=loadData();if(!D.farm.owmApiKey||D.farm.lat===null||D.farm.lng===null)return[];
try{
const r=await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${encodeURIComponent(D.farm.lat)}&lon=${encodeURIComponent(D.farm.lng)}&appid=${encodeURIComponent(D.farm.owmApiKey)}&units=metric`);
if(!r.ok)throw new Error('HTTP '+r.status);
const d=await r.json();
if(!d.list)return[];
const days={};d.list.forEach(f=>{const day=f.dt_txt.substring(0,10);if(!days[day])days[day]={temps:[],hums:[],icon:f.weather[0].icon,desc:f.weather[0].description};
days[day].temps.push(f.main.temp);days[day].hums.push(f.main.humidity);});
return Object.entries(days).slice(0,3).map(([date,v])=>({date,
tempMin:Math.min(...v.temps),tempMax:Math.max(...v.temps),
humidity:Math.round(v.hums.reduce((a,b)=>a+b,0)/v.hums.length),icon:v.icon,desc:v.desc}));
}catch(e){console.warn('Forecast fetch error:',e.message);return[];}
}
function calcTHI(t,h){return(1.8*t+32)-(0.55-0.0055*h)*(1.8*t-26);}
function renderWeatherWidget(w){
const el=document.getElementById('weather-widget');if(!el)return;
const thi=calcTHI(w.temp,w.humidity);
const thiClass=thi>28?'danger':thi>25?'warning':'';
el.innerHTML=`<div class="weather-widget">
<div style="display:flex;align-items:center;gap:12px">
<img src="https://openweathermap.org/img/wn/${w.icon}@2x.png" width="48" height="48" alt="">
<div><div style="font-size:24px;font-weight:700">${w.temp.toFixed(1)}°C</div><div style="color:var(--text-light)">${w.desc}</div></div></div>
<div class="kpi-grid" style="margin-top:8px">
${kpi(t('weather_humidity'),w.humidity+'%','','')}
${kpi(t('weather_wind'),w.wind.toFixed(1)+' m/s','','')}
${kpi('THI',thi.toFixed(1),thi>28?t('weather_heat_alert'):'OK',thiClass)}
</div>
<div style="font-size:11px;color:var(--text-light);margin-top:4px">${t('weather_last_update')}: ${new Date(w.ts).toLocaleTimeString()}</div>
</div>`;
}
async function testWeatherApi(){
const key=$('cfg-owm')?.value;if(!key){toast(t('required'),true);return;}
const D=loadData();const lat=D.farm.lat||0;const lng=D.farm.lng||0;
try{
const r=await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}&appid=${encodeURIComponent(key)}&units=metric`);
const d=await r.json();
if(d.cod===200)toast('API OK: '+d.main.temp+'°C');else toast('Error: '+sanitizeHTML(d.message||'unknown'),true);
}catch(e){toast(t('error_network')+': '+sanitizeHTML(e.message),true);}
}

// ============ GEOLOCATION & MAP (Leaflet) ============
let geoMap=null;let geoMarker=null;
function showGeoModal(){
const D=loadData();
openModal(t('geo_set_location'),`
<div style="margin-bottom:8px"><button class="btn btn-secondary btn-sm" onclick="useGPS()">${t('geo_use_gps')}</button>
<span style="margin-left:8px;color:var(--text-light)">${t('geo_click_map')}</span></div>
<div id="geo-map" class="leaflet-container" style="height:400px;border-radius:var(--radius)"></div>
<div class="form-row" style="margin-top:8px">
<div class="form-group"><label>${t('geo_lat')}</label><input id="geo-lat" type="number" step="any" value="${D.farm.lat||''}"></div>
<div class="form-group"><label>${t('geo_lng')}</label><input id="geo-lng" type="number" step="any" value="${D.farm.lng||''}"></div></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveGeoLocation()">${t('save')}</button></div>`);
setTimeout(()=>{
const lat=D.farm.lat||0;const lng=D.farm.lng||0;
geoMap=L.map('geo-map').setView([lat||20,lng||-70],lat?10:2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OSM'}).addTo(geoMap);
if(lat&&lng){geoMarker=L.marker([lat,lng]).addTo(geoMap);}
geoMap.on('click',function(e){
if(geoMarker)geoMap.removeLayer(geoMarker);
geoMarker=L.marker([e.latlng.lat,e.latlng.lng]).addTo(geoMap);
$('geo-lat').value=e.latlng.lat.toFixed(6);$('geo-lng').value=e.latlng.lng.toFixed(6);
});
},200);
}
function useGPS(){
if(!navigator.geolocation){toast('GPS '+t('not_available'),true);return;}
navigator.geolocation.getCurrentPosition(pos=>{
const lat=pos.coords.latitude;const lng=pos.coords.longitude;
$('geo-lat').value=lat.toFixed(6);$('geo-lng').value=lng.toFixed(6);
if(geoMap){geoMap.setView([lat,lng],12);if(geoMarker)geoMap.removeLayer(geoMarker);
geoMarker=L.marker([lat,lng]).addTo(geoMap);}
},err=>toast('GPS Error: '+err.message,true));
}
function saveGeoLocation(){
const D=loadData();D.farm.lat=parseFloat($('geo-lat').value)||null;D.farm.lng=parseFloat($('geo-lng').value)||null;
saveData(D);closeModal();toast(t('cfg_saved'));renderConfig();
}

// ============ IoT/MQTT INTEGRATION ============
let mqttClient=null;let mqttConnected=false;
function connectMQTT(){
const D=loadData();if(!D.farm.mqttBroker){toast(t('iot_no_config'),true);return;}
try{
mqttClient=mqtt.connect(D.farm.mqttBroker,{username:D.farm.mqttUser||undefined,password:D.farm.mqttPass||undefined,
reconnectPeriod:5000,connectTimeout:10000});
mqttClient.on('connect',()=>{mqttConnected=true;
mqttClient.subscribe(D.farm.mqttTopicPrefix+'sensors/#');updateMqttStatus();toast(t('iot_connect')+' OK');});
mqttClient.on('message',(topic,payload)=>{onMqttMessage(topic,payload);});
mqttClient.on('error',()=>{mqttConnected=false;updateMqttStatus();});
mqttClient.on('close',()=>{mqttConnected=false;updateMqttStatus();});
}catch(e){toast('MQTT Error: '+sanitizeHTML(e.message),true);}
}
function disconnectMQTT(){
if(mqttClient){mqttClient.end();mqttClient=null;}mqttConnected=false;updateMqttStatus();toast(t('iot_disconnect'));
}
function onMqttMessage(topic,payload){
try{const data=JSON.parse(payload.toString());const D=loadData();
const prefix=D.farm.mqttTopicPrefix||'egglogu/';
const sensor=topic.replace(prefix+'sensors/','');
const reading={id:genId(),ts:Date.now(),sensor,value:data.value,unit:data.unit||''};
D.iotReadings.push(reading);if(D.iotReadings.length>500)D.iotReadings=D.iotReadings.slice(-300);
saveData(D);updateIoTGauges();
}catch(e){}
}
function updateMqttStatus(){
const el=document.getElementById('mqtt-indicator');if(!el)return;
el.innerHTML=`<span class="mqtt-status ${mqttConnected?'connected':'disconnected'}">${mqttConnected?'● MQTT':'○ MQTT'}</span>`;
}
function updateIoTGauges(){
const D=loadData();const el=document.getElementById('iot-gauges');if(!el)return;
const latest={};D.iotReadings.slice(-20).forEach(r=>{latest[r.sensor]={value:r.value,unit:r.unit,ts:r.ts};});
const sensors=['temperature','humidity','ammonia','light'];
let h='<div class="kpi-grid">';
sensors.forEach(s=>{const d=latest[s];
const val=d?d.value:'--';const unit=d?d.unit:'';
let cls='';
if(s==='temperature'&&d){cls=d.value>30||d.value<15?'danger':d.value>26?'warning':'';}
if(s==='humidity'&&d){cls=d.value>80||d.value<30?'danger':d.value>70?'warning':'';}
if(s==='ammonia'&&d){cls=d.value>25?'danger':d.value>15?'warning':'';}
h+=kpi(t('iot_'+s)||s,typeof val==='number'?val.toFixed(1):val,unit,cls);
});
if(latest.temperature&&latest.humidity){
const thi=calcTHI(latest.temperature.value,latest.humidity.value);
h+=kpi('THI',thi.toFixed(1),thi>28?t('weather_heat_alert'):'OK',thi>28?'danger':thi>25?'warning':'');
}
h+='</div>';
if(Object.keys(latest).length){
h+=`<div style="margin-top:8px"><button class="btn btn-secondary btn-sm" onclick="saveIoTToEnv()">${t('iot_save_reading')}</button>
<span style="margin-left:8px;font-size:11px;color:var(--text-light)">${t('weather_last_update')}: ${new Date(D.iotReadings[D.iotReadings.length-1]?.ts||0).toLocaleTimeString()}</span></div>`;
}
el.innerHTML=h;
}
function saveIoTToEnv(){
const D=loadData();const latest={};D.iotReadings.slice(-20).forEach(r=>{latest[r.sensor]={value:r.value};});
const o={id:genId(),date:todayStr(),temperature:latest.temperature?.value||null,
humidity:latest.humidity?.value||null,lightHours:null,ventilation:'',
ammoniaLevel:latest.ammonia?.value||null,notes:'IoT auto-save'};
D.environment.push(o);saveData(D);toast(t('cfg_saved'));
}

// ============ ML / PREDICTIVE ANALYTICS ============
let forecastDays=7;
function renderPredictionsTab(D){
if(!D.dailyProduction.length)return emptyState('🤖',t('no_data'));
let h='';
const sorted=[...D.dailyProduction].sort((a,b)=>a.date.localeCompare(b.date));
const last30=sorted.slice(-30);
// === Outbreak Risk Classifier (traffic light) ===
const outbreak=computeOutbreakRisk(D);
const obColor=outbreak.classification===1?'red':outbreak.probability>0.4?'yellow':'green';
const obLabel=obColor==='red'?t('pred_outbreak_high'):obColor==='yellow'?t('pred_outbreak_medium'):t('pred_outbreak_low');
h+=`<div class="card"><h3>🔴 ${t('pred_outbreak_risk')}</h3>
<div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">
<div class="traffic-light"><div class="traffic-dot red${obColor==='red'?' active':''}"></div><div class="traffic-dot yellow${obColor==='yellow'?' active':''}"></div><div class="traffic-dot green${obColor==='green'?' active':''}"></div></div>
<div><strong style="font-size:1.4em">${(outbreak.probability*100).toFixed(0)}%</strong><br><span class="badge badge-${obColor==='red'?'danger':obColor==='yellow'?'warning':'success'}">${obLabel}</span></div></div>`;
if(outbreak.factors.length){
h+='<div class="table-wrap"><table><thead><tr><th>'+t('pred_outbreak_factor')+'</th><th>'+t('pred_outbreak_weight')+'</th><th>'+t('pred_outbreak_value')+'</th></tr></thead><tbody>';
outbreak.factors.forEach(f=>{h+=`<tr><td>${f.name}</td><td>${(f.weight*100).toFixed(0)}%</td><td><div class="severity-bar"><div style="width:${Math.min(100,f.value*100)}%;background:${f.value>0.6?'var(--danger)':f.value>0.3?'var(--warning)':'var(--success)'}"></div></div></td></tr>`;});
h+='</tbody></table></div>';}
if(outbreak.recommendations.length){
h+='<div style="margin-top:12px"><strong>'+t('rec_title')+':</strong><ul style="margin:4px 0 0 16px">';
outbreak.recommendations.forEach(r=>{h+=`<li>${r}</li>`;});h+='</ul></div>';}
h+='</div>';
// === Multi-step Forecast (ensemble) ===
if(last30.length>=7&&typeof ss!=='undefined'){
h+=`<div class="card"><h3>📈 ${t('pred_forecast')}</h3>
<div style="margin-bottom:8px"><button class="btn btn-sm${forecastDays===7?' btn-primary':' btn-secondary'}" onclick="forecastDays=7;renderAnalysis()">7d</button>
<button class="btn btn-sm${forecastDays===14?' btn-primary':' btn-secondary'}" onclick="forecastDays=14;renderAnalysis()">14d</button></div>
<div class="chart-container"><canvas id="chart-forecast"></canvas></div></div>`;
setTimeout(()=>{
const c=document.getElementById('chart-forecast');if(!c)return;
const fc=computeForecast(D,forecastDays);
const allLabels=last30.map(p=>p.date.substring(5));
for(let i=1;i<=forecastDays;i++){const d=new Date();d.setDate(d.getDate()+i);allLabels.push(d.toISOString().substring(5,10));}
const actual=last30.map(p=>p.eggsCollected||0);
const predLine=[...Array(last30.length).fill(null),...fc.forecast];
const upperBand=[...Array(last30.length).fill(null),...fc.upper];
const lowerBand=[...Array(last30.length).fill(null),...fc.lower];
CHARTS.forecast=new Chart(c,{type:'line',data:{labels:allLabels,datasets:[
{label:t('prod_eggs'),data:[...actual,...Array(forecastDays).fill(null)],borderColor:themeColor('--primary'),backgroundColor:themeRgba(.1),fill:true,tension:.3},
{label:t('pred_forecast'),data:predLine,borderColor:'#FF8F00',borderDash:[5,5],tension:.3,pointRadius:4},
{label:t('pred_forecast_upper'),data:upperBand,borderColor:'rgba(255,143,0,.2)',backgroundColor:'rgba(255,143,0,.08)',fill:'+1',borderDash:[2,2],pointRadius:0,tension:.3},
{label:t('pred_forecast_lower'),data:lowerBand,borderColor:'rgba(255,143,0,.2)',pointRadius:0,tension:.3}
]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{filter:item=>!item.text.includes('upper')&&!item.text.includes('lower')}}}}});
},100);
}
// === Anomaly Detection ===
if(last30.length>=7&&typeof ss!=='undefined'){
const vals=last30.map(p=>p.eggsCollected||0);
const mean=ss.mean(vals);const std=ss.standardDeviation(vals);
const anomalies=last30.filter(p=>{const z=std>0?Math.abs((p.eggsCollected-mean)/std):0;return z>2;});
if(anomalies.length){
h+=`<div class="card"><h3>${t('pred_anomaly')} (|Z|>2)</h3><div class="table-wrap"><table><thead><tr>
<th>${t('date')}</th><th>${t('prod_eggs')}</th><th>Z-score</th></tr></thead><tbody>`;
anomalies.forEach(p=>{const z=std>0?((p.eggsCollected-mean)/std):0;
h+=`<tr><td>${fmtDate(p.date)}</td><td>${p.eggsCollected} <span class="anomaly-icon">⚠</span></td>
<td style="color:var(--danger)">${z.toFixed(2)}</td></tr>`;});
h+='</tbody></table></div></div>';
}}
// === Breed Benchmark ===
const activeFlocks=D.flocks.filter(f=>f.status!=='descarte'&&f.birthDate);
if(activeFlocks.length){
h+=`<div class="card"><h3>${t('pred_breed_curve')}</h3>`;
activeFlocks.forEach(f=>{
const bkey=f.breed&&BREED_CURVES[f.breed]?f.breed:(f.targetCurve&&BREED_CURVES[f.targetCurve]?f.targetCurve:'generic');
const curve=BREED_CURVES[bkey];const age=flockAge(f);const weekIdx=Math.max(0,age.weeks-18);
const expected=weekIdx<curve.length?curve[weekIdx]:curve[curve.length-1];
const hens=activeHensByFlock(f.id);
const l7=D.dailyProduction.filter(p=>p.flockId===f.id).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const avgE=l7.length>0?l7.reduce((s,p)=>s+(p.eggsCollected||0),0)/l7.length:0;
const actual=hens>0?(avgE/hens*100):0;
const gap=actual-expected;const gapColor=gap>=0?'var(--success)':'var(--danger)';
h+=`<div class="stat-row"><span class="stat-label">${f.name} (${breed})</span>
<span class="stat-value">${t('actual')}: ${fmtNum(actual,1)}% | ${t('expected')}: ${expected}% |
<span style="color:${gapColor}">Gap: ${gap>0?'+':''}${fmtNum(gap,1)}%</span></span></div>`;
});
h+='</div>';}
return h;
}
function computeDropRisk(D){
let score=0;const hens=activeHens();
// Factor 1: Recent mortality spike (0-30 points)
const l7prod=D.dailyProduction.sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const l7deaths=l7prod.reduce((s,p)=>s+(p.deaths||0),0);
const deathRate=hens>0?(l7deaths/hens*100):0;
score+=Math.min(30,deathRate*6);
// Factor 2: FCR worsening (0-25 points)
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const f30=D.feed.consumption.filter(c=>c.date>=d30s);const e30=D.dailyProduction.filter(p=>p.date>=d30s);
const tfkg=f30.reduce((s,c)=>s+(c.quantityKg||0),0);const tekg=e30.reduce((s,p)=>s+(p.eggsCollected||0),0)*0.06;
const fcr=tekg>0?tfkg/tekg:0;
if(fcr>3)score+=25;else if(fcr>2.5)score+=15;else if(fcr>2)score+=5;
// Factor 3: Weather THI (0-20 points)
const lastW=D.weatherCache.length>0?D.weatherCache[D.weatherCache.length-1]:null;
if(lastW){const thi=calcTHI(lastW.temp,lastW.humidity);if(thi>30)score+=20;else if(thi>28)score+=12;else if(thi>25)score+=5;}
// Factor 4: Production trend (0-25 points)
if(l7prod.length>=7&&typeof ss!=='undefined'){
const points=l7prod.map((p,i)=>[i,p.eggsCollected||0]);
const reg=ss.linearRegression(points);
if(reg.m<-5)score+=25;else if(reg.m<-2)score+=15;else if(reg.m<0)score+=5;
}
return Math.min(100,Math.round(score));
}

// ============ STRESS EVENTS ============
let currentSanidadTab_stress=false;
function renderStressEventsTab(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('stress_title')}</h3>
<button class="btn btn-primary btn-sm" onclick="showStressForm()">${t('add')}</button></div>`;
if(!D.stressEvents.length)return h+emptyState('⚡',t('no_data'));
// Timeline view
h+='<div class="card"><div class="stress-timeline">';
D.stressEvents.sort((a,b)=>b.date.localeCompare(a.date)).forEach(ev=>{
const sColor=['','#4CAF50','#FFC107','#FF9800','#F44336','#9C27B0'][ev.severity]||'#999';
const f=D.flocks.find(x=>x.id===ev.flockId);
// Production impact
const evDate=new Date(ev.date+'T12:00:00');const after3=new Date(evDate);after3.setDate(after3.getDate()+3);
const before=D.dailyProduction.filter(p=>p.date<ev.date).slice(-3);
const afterP=D.dailyProduction.filter(p=>p.date>ev.date&&p.date<=after3.toISOString().substring(0,10));
const avgBefore=before.length>0?before.reduce((s,p)=>s+(p.eggsCollected||0),0)/before.length:0;
const avgAfter=afterP.length>0?afterP.reduce((s,p)=>s+(p.eggsCollected||0),0)/afterP.length:0;
const impact=avgBefore>0?((avgAfter-avgBefore)/avgBefore*100):0;
h+=`<div class="stress-event" style="border-left:4px solid ${sColor}">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px">
<strong>${fmtDate(ev.date)}</strong>
<span class="badge badge-${ev.severity>=4?'danger':ev.severity>=3?'warning':'info'}">${t('stress_'+ev.type)||ev.type} (${ev.severity}/5)</span>
</div>
<p style="margin:4px 0">${sanitizeHTML(ev.description)}</p>
<div style="font-size:12px;color:var(--text-light)">${f?sanitizeHTML(f.name):t('all')} | ${t('prod_title')}: <span style="color:${impact<0?'var(--danger)':'var(--success)'}">${impact>0?'+':''}${fmtNum(impact,1)}%</span></div>
<div class="btn-group" style="margin-top:4px"><button class="btn btn-secondary btn-sm" onclick="showStressForm('${escapeAttr(ev.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteStress('${escapeAttr(ev.id)}')">${t('delete')}</button></div></div>`;
});
h+='</div></div>';
return h;
}
function showStressForm(id){
const D=loadData();const ev=id?D.stressEvents.find(x=>x.id===id):null;
const types=['heat','disease','feed_change','power','predator','other'];
openModal(ev?t('edit'):t('stress_title'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="st-date" value="${ev?ev.date:todayStr()}"></div>
<div class="form-group"><label>${t('stress_type')}</label><select id="st-type">${types.map(ty=>`<option value="${ty}"${ev&&ev.type===ty?' selected':''}>${t('stress_'+ty)||ty}</option>`).join('')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('stress_severity')} (1-5)</label><input type="number" id="st-sev" value="${ev?ev.severity:3}" min="1" max="5"></div>
<div class="form-group"><label>${t('prod_flock')}</label><select id="st-flock">${flockSelect(ev?ev.flockId:'',true)}</select></div></div>
<div class="form-group"><label>${t('fin_description')}</label><textarea id="st-desc">${ev?escapeAttr(ev.description||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveStress('${id||''}')">${t('save')}</button></div>`);
}
function saveStress(id){
clearFieldErrors();
const D=loadData();const o={date:$('st-date').value,type:$('st-type').value,
severity:parseInt($('st-sev').value)||3,flockId:$('st-flock').value,description:$('st-desc').value};
const v=validateForm({'st-date':{value:o.date,rules:{required:true,date:true}},'st-type':{value:o.type,rules:{required:true}},'st-sev':{value:$('st-sev').value,rules:{required:true,numeric:true,min:1,max:5}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.stressEvents.findIndex(e=>e.id===id);if(i>=0)D.stressEvents[i]={...D.stressEvents[i],...o};}
else{o.id=genId();D.stressEvents.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderSanidad();
}
async function deleteStress(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.stressEvents=D.stressEvents.filter(e=>e.id!==id);saveData(D);toast(t('cfg_saved'));renderSanidad();}
function autoStressEvent(D,type,severity,desc){
const today=todayStr();
if(D.stressEvents.find(e=>e.date===today&&e.type===type))return;
D.stressEvents.push({id:genId(),date:today,flockId:'',type,severity,description:desc});
saveData(D);
}

// ============ CONFIG SAVE HELPERS ============
function saveWeatherConfig(){
const D=loadData();D.farm.owmApiKey=$('cfg-owm')?.value||'';saveData(D);toast(t('cfg_saved'));
if(D.farm.owmApiKey&&D.farm.lat)fetchWeather();
}
function saveMqttConfig(){
const D=loadData();
D.farm.mqttBroker=$('cfg-mqtt-broker')?.value||'';
D.farm.mqttUser=$('cfg-mqtt-user')?.value||'';
D.farm.mqttPass=$('cfg-mqtt-pass')?.value||'';
D.farm.mqttTopicPrefix=$('cfg-mqtt-prefix')?.value||'egglogu/';
saveData(D);toast(t('cfg_saved'));
}

// ============ BIOSECURITY MODULE ============
let currentBioTab='visitors';
function renderBiosecurity(){
const D=loadData();const bio=D.biosecurity;
let h=`<div class="page-header"><h2>${t('bio_title')}</h2></div>`;
// Pest Score
const ps=computePestScore(D);
h+=`<div class="kpi-grid" style="margin-bottom:16px">`;
h+=kpi(t('bio_pest_score'),ps.toString()+'/100','',ps>60?'danger':ps>30?'warning':'');
h+=kpi(t('bio_unresolved_pests'),bio.pestSightings.filter(p=>!p.resolved).length.toString(),'','');
h+=kpi(t('bio_visitors'),bio.visitors.length.toString(),t('total'),'');
h+=kpi(t('bio_zones'),bio.zones.length.toString(),'','');
h+=`</div>`;
h+=`<div class="tabs">
<div class="tab${currentBioTab==='visitors'?' active':''}" onclick="currentBioTab='visitors';renderBiosecurity()">👤 ${t('bio_visitors')}</div>
<div class="tab${currentBioTab==='zones'?' active':''}" onclick="currentBioTab='zones';renderBiosecurity()">🏠 ${t('bio_zones')}</div>
<div class="tab${currentBioTab==='pests'?' active':''}" onclick="currentBioTab='pests';renderBiosecurity()">🐀 ${t('bio_pests')}</div>
<div class="tab${currentBioTab==='protocols'?' active':''}" onclick="currentBioTab='protocols';renderBiosecurity()">📋 ${t('bio_protocols')}</div></div>`;
if(currentBioTab==='visitors')h+=renderBioVisitors(D);
else if(currentBioTab==='zones')h+=renderBioZones(D);
else if(currentBioTab==='pests')h+=renderBioPests(D);
else h+=renderBioProtocols(D);
$('sec-bioseguridad').innerHTML=h;
}
function computePestScore(D){
const bio=D.biosecurity;let score=0;
const unresolved=bio.pestSightings.filter(p=>!p.resolved);
score+=Math.min(40,unresolved.length*10);
score+=Math.min(20,unresolved.reduce((s,p)=>s+(p.severity||1),0)*2);
const redZones=bio.zones.filter(z=>z.riskLevel==='red').length;
const yellowZones=bio.zones.filter(z=>z.riskLevel==='yellow').length;
score+=redZones*15+yellowZones*5;
const today=todayStr();
bio.zones.forEach(z=>{
if(z.lastDisinfection&&z.frequencyDays){
const next=new Date(z.lastDisinfection+'T12:00:00');next.setDate(next.getDate()+z.frequencyDays);
if(next.toISOString().substring(0,10)<today)score+=10;
}});
return Math.min(100,Math.round(score));
}
function renderBioVisitors(D){
const bio=D.biosecurity;
let h=`<div class="card"><div class="page-header"><h3>👤 ${t('bio_visitors')}</h3>
<button class="btn btn-primary btn-sm" onclick="showBioVisitorForm()">${t('bio_add_visitor')}</button></div>`;
if(!bio.visitors.length)return h+emptyState('👤',t('no_data'))+'</div>';
h+=`<div class="table-wrap"><table><thead><tr><th>${t('date')}</th><th>${t('bio_visitor_name')}</th><th>${t('bio_visitor_company')}</th>
<th>${t('bio_visitor_purpose')}</th><th>${t('bio_visitor_zone')}</th><th>${t('bio_visitor_plate')}</th>
<th>${t('bio_visitor_disinfected')}</th><th>${t('actions')}</th></tr></thead><tbody>`;
bio.visitors.sort((a,b)=>b.date.localeCompare(a.date)).forEach(v=>{
const crossRisk=v.fromFarmHealth&&v.fromFarmHealth!=='healthy';
h+=`<tr${crossRisk?' style="background:#FFF3E0"':''}>
<td>${fmtDate(v.date)}</td><td>${sanitizeHTML(v.name)}${crossRisk?' <span title="'+t('bio_cross_risk')+'" style="color:var(--danger)">⚠️</span>':''}</td>
<td>${sanitizeHTML(v.company||'-')}</td><td>${sanitizeHTML(v.purpose||'-')}</td><td>${sanitizeHTML(v.zone||'-')}</td><td>${sanitizeHTML(v.vehiclePlate||'-')}</td>
<td>${v.disinfected?'✅':'❌'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showBioVisitorForm('${escapeAttr(v.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteBioVisitor('${escapeAttr(v.id)}')">${t('delete')}</button></div></td></tr>`;});
return h+'</tbody></table></div></div>';
}
function showBioVisitorForm(id){
const D=loadData();const v=id?D.biosecurity.visitors.find(x=>x.id===id):null;
const zoneOpts=D.biosecurity.zones.map(z=>`<option value="${escapeAttr(z.name)}"${v&&v.zone===z.name?' selected':''}>${sanitizeHTML(z.name)}</option>`).join('');
openModal(v?t('edit'):t('bio_add_visitor'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="bv-date" value="${v?v.date:todayStr()}"></div>
<div class="form-group"><label>${t('bio_visitor_name')}</label><input id="bv-name" value="${v?escapeAttr(v.name):''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('bio_visitor_company')}</label><input id="bv-company" value="${v?escapeAttr(v.company||''):''}"></div>
<div class="form-group"><label>${t('bio_visitor_purpose')}</label><select id="bv-purpose">${catalogSelect(CATALOGS.visitorPurposes,v?v.purpose||'':'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('bio_visitor_zone')}</label><select id="bv-zone"><option value="">--</option>${zoneOpts}</select></div>
<div class="form-group"><label>${t('bio_visitor_plate')}</label><input id="bv-plate" value="${v?escapeAttr(v.vehiclePlate||''):''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('bio_visitor_disinfected')}</label><select id="bv-disinf">
<option value="true"${v&&v.disinfected?' selected':''}>✅</option><option value="false"${v&&!v.disinfected?' selected':''}>❌</option></select></div>
<div class="form-group"><label>${t('bio_visitor_from_farm')}</label><select id="bv-farm">
<option value="">--</option>
<option value="internal"${v&&v.fromFarmId==='internal'?' selected':''}>${escapeAttr(D.farm.name||'Mi Granja')} (interna)</option>
<option value="external"${v&&v.fromFarmId==='external'?' selected':(!v?' selected':'')}>Externa</option>
</select></div></div>
<div class="form-group"><label>${t('bio_visitor_from_health')}</label><select id="bv-health">
<option value="healthy"${v&&v.fromFarmHealth==='healthy'?' selected':''}>✅ Healthy</option>
<option value="outbreak"${v&&v.fromFarmHealth==='outbreak'?' selected':''}>⚠️ Outbreak</option>
<option value="unknown"${v&&v.fromFarmHealth==='unknown'?' selected':''}>❓ Unknown</option></select></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="bv-notes">${v?escapeAttr(v.notes||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveBioVisitor('${id||''}')">${t('save')}</button></div>`);
}
function saveBioVisitor(id){
clearFieldErrors();
const D=loadData();const o={date:$('bv-date').value,name:$('bv-name').value,company:$('bv-company').value,
purpose:$('bv-purpose').value,zone:$('bv-zone').value,vehiclePlate:$('bv-plate').value,
disinfected:$('bv-disinf').value==='true',fromFarmId:$('bv-farm').value,
fromFarmHealth:$('bv-health').value,notes:$('bv-notes').value};
const v=validateForm({'bv-date':{value:o.date,rules:{required:true,date:true}},'bv-name':{value:o.name,rules:{required:true,maxLength:100}},'bv-company':{value:o.company,rules:{maxLength:100}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.biosecurity.visitors.findIndex(v=>v.id===id);if(i>=0)D.biosecurity.visitors[i]={...D.biosecurity.visitors[i],...o};}
else{o.id=genId();D.biosecurity.visitors.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderBiosecurity();
}
async function deleteBioVisitor(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.biosecurity.visitors=D.biosecurity.visitors.filter(v=>v.id!==id);saveData(D);toast(t('cfg_saved'));renderBiosecurity();}

function renderBioZones(D){
const bio=D.biosecurity;const today=todayStr();
let h=`<div class="card"><div class="page-header"><h3>🏠 ${t('bio_zones')}</h3>
<button class="btn btn-primary btn-sm" onclick="showBioZoneForm()">${t('bio_add_zone')}</button></div>`;
if(!bio.zones.length)return h+emptyState('🏠',t('no_data'))+'</div>';
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px">';
bio.zones.forEach(z=>{
const overdue=z.lastDisinfection&&z.frequencyDays&&(()=>{const n=new Date(z.lastDisinfection+'T12:00:00');n.setDate(n.getDate()+z.frequencyDays);return n.toISOString().substring(0,10)<today;})();
h+=`<div class="card" style="border-left:4px solid ${z.riskLevel==='red'?'#F44336':z.riskLevel==='yellow'?'#FFC107':'#4CAF50'}">
<div style="display:flex;justify-content:space-between;align-items:center">
<h4>${sanitizeHTML(z.name)}</h4><span class="risk-badge risk-${z.riskLevel}">${t('bio_risk_'+z.riskLevel)}</span></div>
<p style="font-size:13px;color:var(--text-light)">${t('bio_zone_last_disinfection')}: ${z.lastDisinfection?fmtDate(z.lastDisinfection):'-'}
${overdue?' <span style="color:var(--danger);font-weight:700">'+t('bio_protocol_overdue')+'</span>':''}</p>
<p style="font-size:13px;color:var(--text-light)">${t('bio_zone_frequency')}: ${z.frequencyDays||'-'} ${t('flock_days')}</p>
${z.notes?'<p style="font-size:12px">'+sanitizeHTML(z.notes)+'</p>':''}
<div class="btn-group" style="margin-top:8px"><button class="btn btn-secondary btn-sm" onclick="showBioZoneForm('${escapeAttr(z.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteBioZone('${escapeAttr(z.id)}')">${t('delete')}</button></div></div>`;});
return h+'</div></div>';
}
function showBioZoneForm(id){
const D=loadData();const z=id?D.biosecurity.zones.find(x=>x.id===id):null;
openModal(z?t('edit'):t('bio_add_zone'),`
<div class="form-row"><div class="form-group"><label>${t('bio_zone_name')}</label><input id="bz-name" value="${z?escapeAttr(z.name):''}"></div>
<div class="form-group"><label>${t('bio_zone_risk')}</label><select id="bz-risk">
<option value="green"${z&&z.riskLevel==='green'?' selected':''}>${t('bio_risk_green')}</option>
<option value="yellow"${z&&z.riskLevel==='yellow'?' selected':''}>${t('bio_risk_yellow')}</option>
<option value="red"${z&&z.riskLevel==='red'?' selected':''}>${t('bio_risk_red')}</option></select></div></div>
<div class="form-row"><div class="form-group"><label>${t('bio_zone_last_disinfection')}</label><input type="date" id="bz-last" value="${z?z.lastDisinfection||'':''}"></div>
<div class="form-group"><label>${t('bio_zone_frequency')}</label><input type="number" id="bz-freq" value="${z?z.frequencyDays||'':''}" min="1"></div></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="bz-notes">${z?escapeAttr(z.notes||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveBioZone('${id||''}')">${t('save')}</button></div>`);
}
function saveBioZone(id){
clearFieldErrors();
const D=loadData();const o={name:$('bz-name').value,riskLevel:$('bz-risk').value,
lastDisinfection:$('bz-last').value,frequencyDays:parseInt($('bz-freq').value)||0,notes:$('bz-notes').value};
const v=validateForm({'bz-name':{value:o.name,rules:{required:true,maxLength:100}},'bz-risk':{value:o.riskLevel,rules:{required:true}},'bz-freq':{value:$('bz-freq').value,rules:{numeric:true,min:1}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.biosecurity.zones.findIndex(z=>z.id===id);if(i>=0)D.biosecurity.zones[i]={...D.biosecurity.zones[i],...o};}
else{o.id=genId();D.biosecurity.zones.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderBiosecurity();
}
async function deleteBioZone(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.biosecurity.zones=D.biosecurity.zones.filter(z=>z.id!==id);saveData(D);toast(t('cfg_saved'));renderBiosecurity();}

function renderBioPests(D){
const bio=D.biosecurity;
let h=`<div class="card"><div class="page-header"><h3>🐀 ${t('bio_pests')}</h3>
<button class="btn btn-primary btn-sm" onclick="showBioPestForm()">${t('bio_add_pest')}</button></div>`;
if(!bio.pestSightings.length)return h+emptyState('🐀',t('no_data'))+'</div>';
h+='<div class="stress-timeline" style="padding-left:20px">';
bio.pestSightings.sort((a,b)=>b.date.localeCompare(a.date)).forEach(p=>{
const sColor=['','#4CAF50','#8BC34A','#FFC107','#FF9800','#F44336'][p.severity]||'#999';
const typeIcon={rodent:'🐀',fly:'🪰',wild_bird:'🐦',other:'🐛'}[p.type]||'🐛';
h+=`<div class="stress-event" style="border-left:4px solid ${sColor}">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px">
<strong>${fmtDate(p.date)} ${typeIcon} ${t('bio_pest_'+p.type)||p.type}</strong>
<span>${p.resolved?'✅ '+t('bio_pest_resolved'):'❌ '+t('active')}</span></div>
<p style="margin:4px 0">${t('bio_pest_location')}: ${sanitizeHTML(p.location||'-')} | ${t('bio_pest_severity')}: ${'⭐'.repeat(p.severity||1)}</p>
${p.action?'<p style="font-size:12px;color:var(--text-light)">'+t('bio_pest_action')+': '+sanitizeHTML(p.action)+'</p>':''}
<div class="btn-group" style="margin-top:4px">
${!p.resolved?'<button class="btn btn-primary btn-sm" onclick="resolveBioPest(\''+escapeAttr(p.id)+'\')">✅ '+t('bio_pest_resolved')+'</button>':''}
<button class="btn btn-secondary btn-sm" onclick="showBioPestForm('${escapeAttr(p.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteBioPest('${escapeAttr(p.id)}')">${t('delete')}</button></div></div>`;});
return h+'</div></div>';
}
function showBioPestForm(id){
const D=loadData();const p=id?D.biosecurity.pestSightings.find(x=>x.id===id):null;
openModal(p?t('edit'):t('bio_add_pest'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="bp-date" value="${p?p.date:todayStr()}"></div>
<div class="form-group"><label>${t('bio_pest_type')}</label><select id="bp-type">
<option value="rodent"${p&&p.type==='rodent'?' selected':''}>${t('bio_pest_rodent')}</option>
<option value="fly"${p&&p.type==='fly'?' selected':''}>${t('bio_pest_fly')}</option>
<option value="wild_bird"${p&&p.type==='wild_bird'?' selected':''}>${t('bio_pest_wild_bird')}</option>
<option value="other"${p&&p.type==='other'?' selected':''}>${t('bio_pest_other')}</option></select></div></div>
<div class="form-row"><div class="form-group"><label>${t('bio_pest_location')}</label><select id="bp-loc">
<option value="">--</option>
${D.biosecurity.zones.map(z=>`<option value="${escapeAttr(z.name)}"${p&&p.location===z.name?' selected':''}>${sanitizeHTML(z.name)}</option>`).join('')}
<option value="__other__">Otra...</option>
</select></div>
<div class="form-group"><label>${t('bio_pest_severity')} (1-5)</label><input type="number" id="bp-sev" value="${p?p.severity||3:3}" min="1" max="5"></div></div>
<div class="form-group"><label>${t('bio_pest_action')}</label><textarea id="bp-action">${p?escapeAttr(p.action||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveBioPest('${id||''}')">${t('save')}</button></div>`);
}
function saveBioPest(id){
clearFieldErrors();
const D=loadData();const o={date:$('bp-date').value,type:$('bp-type').value,
location:$('bp-loc').value,severity:parseInt($('bp-sev').value)||3,action:$('bp-action').value,resolved:false};
const v=validateForm({'bp-date':{value:o.date,rules:{required:true,date:true}},'bp-type':{value:o.type,rules:{required:true}},'bp-sev':{value:$('bp-sev').value,rules:{required:true,numeric:true,min:1,max:5}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.biosecurity.pestSightings.findIndex(p=>p.id===id);
if(i>=0){o.resolved=D.biosecurity.pestSightings[i].resolved;D.biosecurity.pestSightings[i]={...D.biosecurity.pestSightings[i],...o};}}
else{o.id=genId();D.biosecurity.pestSightings.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderBiosecurity();
}
function resolveBioPest(id){const D=loadData();const p=D.biosecurity.pestSightings.find(x=>x.id===id);if(p){p.resolved=true;saveData(D);toast(t('cfg_saved'));renderBiosecurity();}}
async function deleteBioPest(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.biosecurity.pestSightings=D.biosecurity.pestSightings.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderBiosecurity();}

function renderBioProtocols(D){
const bio=D.biosecurity;const today=todayStr();
let h=`<div class="card"><div class="page-header"><h3>📋 ${t('bio_protocols')}</h3>
<button class="btn btn-primary btn-sm" onclick="showBioProtocolForm()">${t('bio_add_protocol')}</button></div>`;
if(!bio.protocols.length)return h+emptyState('📋',t('no_data'))+'</div>';
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px">';
bio.protocols.forEach(p=>{
const freqDays={daily:1,weekly:7,monthly:30}[p.frequency]||7;
const overdue=p.lastCompleted&&(()=>{const n=new Date(p.lastCompleted+'T12:00:00');n.setDate(n.getDate()+freqDays);return n.toISOString().substring(0,10)<today;})();
h+=`<div class="card" style="border-top:3px solid ${overdue?'var(--danger)':'var(--primary)'}">
<h4>${sanitizeHTML(p.name)}</h4>
<p style="font-size:13px;color:var(--text-light)">${t('bio_protocol_frequency')}: ${t('bio_protocol_'+p.frequency)} | ${t('bio_protocol_last')}: ${p.lastCompleted?fmtDate(p.lastCompleted):'-'}
${overdue?' <span style="color:var(--danger);font-weight:700">'+t('bio_protocol_overdue')+'</span>':''}</p>`;
if(p.items&&p.items.length){h+='<ul style="font-size:13px;margin:8px 0">';p.items.forEach(it=>{h+=`<li>${sanitizeHTML(it)}</li>`;});h+='</ul>';}
h+=`<div class="btn-group"><button class="btn btn-primary btn-sm" onclick="completeBioProtocol('${escapeAttr(p.id)}')">✅ ${t('bio_protocol_complete')}</button>
<button class="btn btn-secondary btn-sm" onclick="showBioProtocolForm('${escapeAttr(p.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteBioProtocol('${escapeAttr(p.id)}')">${t('delete')}</button></div></div>`;});
return h+'</div></div>';
}
function showBioProtocolForm(id){
const D=loadData();const p=id?D.biosecurity.protocols.find(x=>x.id===id):null;
openModal(p?t('edit'):t('bio_add_protocol'),`
<div class="form-row"><div class="form-group"><label>${t('bio_protocol_name')}</label><select id="bpr-name">${catalogSelect(CATALOGS.bioProtocols,p?p.name:'')}</select></div>
<div class="form-group"><label>${t('bio_protocol_frequency')}</label><select id="bpr-freq">
<option value="daily"${p&&p.frequency==='daily'?' selected':''}>${t('bio_protocol_daily')}</option>
<option value="weekly"${p&&p.frequency==='weekly'?' selected':''}>${t('bio_protocol_weekly')}</option>
<option value="monthly"${p&&p.frequency==='monthly'?' selected':''}>${t('bio_protocol_monthly')}</option></select></div></div>
<div class="form-group"><label>${t('bio_protocol_items')} (${t('notes')}: uno por línea)</label>
<textarea id="bpr-items" rows="5">${p&&p.items?escapeAttr(p.items.join('\n')):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveBioProtocol('${id||''}')">${t('save')}</button></div>`);
}
function saveBioProtocol(id){
clearFieldErrors();
const D=loadData();const o={name:$('bpr-name').value,frequency:$('bpr-freq').value,
items:$('bpr-items').value.split('\n').map(s=>s.trim()).filter(Boolean),lastCompleted:null};
const v=validateForm({'bpr-name':{value:o.name,rules:{required:true}},'bpr-freq':{value:o.frequency,rules:{required:true}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.biosecurity.protocols.findIndex(p=>p.id===id);
if(i>=0){o.lastCompleted=D.biosecurity.protocols[i].lastCompleted;D.biosecurity.protocols[i]={...D.biosecurity.protocols[i],...o};}}
else{o.id=genId();D.biosecurity.protocols.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderBiosecurity();
}
function completeBioProtocol(id){const D=loadData();const p=D.biosecurity.protocols.find(x=>x.id===id);if(p){p.lastCompleted=todayStr();saveData(D);toast(t('cfg_saved'));renderBiosecurity();}}
async function deleteBioProtocol(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.biosecurity.protocols=D.biosecurity.protocols.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderBiosecurity();}

// ============ EGG TRACEABILITY MODULE ============
function renderTraceability(){
const D=loadData();const batches=D.traceability.batches;
let h=`<div class="page-header"><h2>${t('trace_title')}</h2>
<div class="btn-group"><button class="btn btn-primary" onclick="showBatchForm()">${t('trace_add')}</button>
<button class="btn btn-secondary" onclick="exportBatchCSV()">${t('export_csv')}</button></div></div>`;
// Search
h+=`<div class="card"><div class="form-row"><div class="form-group" style="flex:1">
<input id="trace-search" placeholder="${t('trace_search')}" oninput="filterBatches()"></div></div></div>`;
if(!batches.length){h+=emptyState('📦',t('no_data'));$('sec-trazabilidad').innerHTML=h;return;}
h+=`<div id="batch-list">`;h+=renderBatchList(batches,D);h+=`</div>`;
$('sec-trazabilidad').innerHTML=h;
}
function renderBatchList(batches,D){
let h=`<div class="card"><div class="table-wrap"><table><thead><tr>
<th>${t('trace_batch_id')}</th><th>${t('date')}</th><th>${t('prod_flock')}</th><th>${t('trace_house')}</th>
<th>${t('trace_rack')}</th><th>${t('trace_box_count')}</th><th>${t('trace_eggs_per_box')}</th>
<th>${t('prod_egg_type')}</th><th>${t('fin_client')}</th><th>${t('trace_delivery')}</th><th>${t('actions')}</th>
</tr></thead><tbody>`;
batches.sort((a,b)=>b.date.localeCompare(a.date)).forEach(b=>{
const f=D.flocks.find(x=>x.id===b.flockId);const c=D.clients.find(x=>x.id===b.clientId);
h+=`<tr><td><code>${sanitizeHTML(b.id.substring(0,8))}</code></td><td>${fmtDate(b.date)}</td><td>${f?sanitizeHTML(f.name):'-'}</td>
<td>${sanitizeHTML(b.house||'-')}</td><td>${sanitizeHTML(b.rackNumber||'-')}</td><td>${fmtNum(b.boxCount)}</td><td>${fmtNum(b.eggsPerBox)}</td>
<td>${b.eggType?t('prod_type_'+b.eggType)||sanitizeHTML(b.eggType):'-'}</td>
<td>${c?sanitizeHTML(c.name):'-'}</td><td>${b.deliveryDate?fmtDate(b.deliveryDate):'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showBatchTrace('${escapeAttr(b.id)}')" title="${t('trace_origin')}">🔍</button>
<button class="btn btn-secondary btn-sm" onclick="showBatchForm('${escapeAttr(b.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteBatch('${escapeAttr(b.id)}')">${t('delete')}</button></div></td></tr>`;});
return h+'</tbody></table></div></div>';
}
function showBatchForm(id){
const D=loadData();const b=id?D.traceability.batches.find(x=>x.id===id):null;
openModal(b?t('edit'):t('trace_add'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="tb-date" value="${b?b.date:todayStr()}"></div>
<div class="form-group"><label>${t('prod_flock')}</label><select id="tb-flock">${flockSelect(b?b.flockId:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('trace_house')}</label><select id="tb-house" onchange="onHouseChange()">${houseSelect(b?b.house||'':'')}</select></div>
<div class="form-group"><label>${t('trace_rack')}</label><select id="tb-rack">${rackSelect(b?b.house||'':'',b?b.rackNumber||'':'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('trace_box_count')}</label><input type="number" id="tb-boxes" value="${b?b.boxCount||'':''}" min="1"></div>
<div class="form-group"><label>${t('trace_eggs_per_box')}</label><input type="number" id="tb-epb" value="${b?b.eggsPerBox||30:30}" min="1"></div></div>
<div class="form-row"><div class="form-group"><label>${t('prod_egg_type')}</label><select id="tb-type">
<option value="conventional"${b&&b.eggType==='conventional'?' selected':''}>${t('prod_type_conventional')}</option>
<option value="free_range"${b&&b.eggType==='free_range'?' selected':''}>${t('prod_type_free_range')}</option>
<option value="organic"${b&&b.eggType==='organic'?' selected':''}>${t('prod_type_organic')}</option>
<option value="pasture_raised"${b&&b.eggType==='pasture_raised'?' selected':''}>${t('prod_type_pasture')}</option>
<option value="decorative"${b&&b.eggType==='decorative'?' selected':''}>${t('prod_type_decorative')}</option></select></div>
<div class="form-group"><label>${t('fin_client')}</label><select id="tb-client">${clientSelect(b?b.clientId:'')}</select></div></div>
<div class="form-group"><label>${t('trace_delivery')}</label><input type="date" id="tb-delivery" value="${b?b.deliveryDate||'':''}"></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="tb-notes">${b?escapeAttr(b.notes||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveBatch('${id||''}')">${t('save')}</button></div>`);
}
function saveBatch(id){
clearFieldErrors();
const D=loadData();const o={date:$('tb-date').value,flockId:$('tb-flock').value,house:$('tb-house').value,
rackNumber:$('tb-rack').value,boxCount:parseInt($('tb-boxes').value)||0,eggsPerBox:parseInt($('tb-epb').value)||30,
eggType:$('tb-type').value,clientId:$('tb-client').value,deliveryDate:$('tb-delivery').value,notes:$('tb-notes').value};
const v=validateForm({'tb-date':{value:o.date,rules:{required:true,date:true}},'tb-flock':{value:o.flockId,rules:{required:true}},'tb-boxes':{value:$('tb-boxes').value,rules:{required:true,numeric:true,min:1}},'tb-epb':{value:$('tb-epb').value,rules:{required:true,numeric:true,min:1}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
const batchEggs=o.boxCount*o.eggsPerBox;const prodEggs=D.dailyProduction.filter(p=>p.flockId===o.flockId).reduce((s,p)=>s+(p.eggsCollected||0),0);
const batchedEggs=D.traceability.batches.filter(b=>b.flockId===o.flockId&&b.id!==(id||'')).reduce((s,b)=>s+(b.boxCount||0)*(b.eggsPerBox||0),0);
const availableEggs=prodEggs-batchedEggs;
if(batchEggs>availableEggs&&availableEggs>=0){toast(`⚠️ Batch (${fmtNum(batchEggs)}) exceeds available production (${fmtNum(availableEggs)} eggs). Check data.`,'warning');}
if(id){o.qrCode=`EGGLOGU|BATCH:${id}|FLOCK:${o.flockId}|DATE:${o.date}|HOUSE:${o.house}|TYPE:${o.eggType}`;
const i=D.traceability.batches.findIndex(b=>b.id===id);if(i>=0)D.traceability.batches[i]={...D.traceability.batches[i],...o};}
else{o.id=genId();o.qrCode=`EGGLOGU|BATCH:${o.id}|FLOCK:${o.flockId}|DATE:${o.date}|HOUSE:${o.house}|TYPE:${o.eggType}`;D.traceability.batches.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderTraceability();
}
async function deleteBatch(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.traceability.batches=D.traceability.batches.filter(b=>b.id!==id);saveData(D);toast(t('cfg_saved'));renderTraceability();}
function showBatchTrace(id){
const D=loadData();const b=D.traceability.batches.find(x=>x.id===id);if(!b)return;
const f=D.flocks.find(x=>x.id===b.flockId);const c=D.clients.find(x=>x.id===b.clientId);
const breed=f?f.breed||'generic':'generic';
const l7=D.dailyProduction.filter(p=>p.flockId===b.flockId&&p.date<=b.date).sort((a,c)=>c.date.localeCompare(a.date)).slice(0,7);
const avgFCR=l7.length>0?'~':'N/A';
const hs=f?computeFlockHealthScore(f.id,D):'N/A';
openModal('🔍 '+t('trace_origin'),`
<div class="card" style="margin:0"><h4>${t('trace_batch_id')}: ${b.id.substring(0,8)}</h4>
<div class="stat-row"><span class="stat-label">${t('trace_house')}</span><span class="stat-value">${b.house||'-'}</span></div>
<div class="stat-row"><span class="stat-label">${t('prod_flock')}</span><span class="stat-value">${f?sanitizeHTML(f.name)+' ('+sanitizeHTML(breed)+')':'-'}</span></div>
<div class="stat-row"><span class="stat-label">${t('date')}</span><span class="stat-value">${fmtDate(b.date)}</span></div>
<div class="stat-row"><span class="stat-label">${t('flock_health')}</span><span class="stat-value">${hs}</span></div>
<div class="stat-row"><span class="stat-label">${t('prod_egg_type')}</span><span class="stat-value">${t('prod_type_'+b.eggType)||sanitizeHTML(b.eggType)}</span></div>
<div class="stat-row"><span class="stat-label">${t('fin_client')}</span><span class="stat-value">${c?sanitizeHTML(c.name):'-'}</span></div>
<hr><div class="qr-display">${sanitizeHTML(b.qrCode||'N/A')}</div>
</div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('close')}</button></div>`);
}
function computeFlockHealthScore(fid,D){
let score=100;
const deaths=D.dailyProduction.filter(p=>p.flockId===fid).reduce((s,p)=>s+(p.deaths||0),0);
const f=D.flocks.find(x=>x.id===fid);if(!f)return 0;
const mortality=f.count>0?(deaths/f.count*100):0;
score-=Math.min(30,mortality*3);
const activeOutbreaks=D.outbreaks.filter(o=>o.flockId===fid&&o.status==='active').length;
score-=activeOutbreaks*20;
return Math.max(0,Math.round(score));
}
function filterBatches(){
const q=($('trace-search')?.value||'').toLowerCase();const D=loadData();
const filtered=q?D.traceability.batches.filter(b=>{const flock=D.flocks.find(f=>f.id===b.flockId);const client=D.clients.find(c=>c.id===b.clientId);
return b.id.toLowerCase().includes(q)||(b.qrCode||'').toLowerCase().includes(q)||(b.house||'').toLowerCase().includes(q)||(flock?flock.name.toLowerCase().includes(q):false)||(client?client.name.toLowerCase().includes(q):false)||(b.eggType||'').toLowerCase().includes(q)||(b.date||'').includes(q);}):D.traceability.batches;
const el=$('batch-list');if(el)el.innerHTML=renderBatchList(filtered,D);
}
function exportBatchCSV(){
const D=loadData();const batches=D.traceability.batches;if(!batches.length)return;
let csv='Batch ID,Date,Flock,House,Rack,Boxes,Eggs/Box,Type,Client,Delivery,QR\n';
const esc=s=>String(s||'').replace(/"/g,'""');
batches.forEach(b=>{const f=D.flocks.find(x=>x.id===b.flockId);const c=D.clients.find(x=>x.id===b.clientId);
csv+=`"${esc(b.id)}","${b.date}","${esc(f?f.name:'')}","${esc(b.house)}","${esc(b.rackNumber)}",${b.boxCount},${b.eggsPerBox},"${esc(b.eggType)}","${esc(c?c.name:'')}","${b.deliveryDate||''}","${esc(b.qrCode)}"\n`;});
const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='egglogu_batches.csv';a.click();
}

// ============ PRODUCTION PLANNING MODULE ============
function renderPlanning(){
const D=loadData();const plans=D.productionPlans;
let h=`<div class="page-header"><h2>${t('plan_title')}</h2>
<button class="btn btn-primary" onclick="showPlanForm()">${t('plan_add')}</button></div>`;
if(!plans.length){h+=emptyState('📅',t('no_data'));$('sec-planificacion').innerHTML=h;return;}
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:16px">';
plans.forEach(p=>{
const totalExpected=estimateTotalProduction(D,p);
const gap=totalExpected-p.eggsNeeded;const pct=p.eggsNeeded>0?(totalExpected/p.eggsNeeded*100):0;
const statusColor=pct>=100?'var(--success)':pct>=80?'var(--warning)':'var(--danger)';
const statusText=pct>=100?t('plan_on_track'):pct>=80?t('plan_behind'):t('plan_behind');
const c=D.clients.find(x=>x.id===p.clientId);
h+=`<div class="card" style="border-top:3px solid ${statusColor}">
<div style="display:flex;justify-content:space-between;align-items:center"><h3>${sanitizeHTML(p.name)}</h3>
<span style="color:${statusColor};font-weight:700">${fmtNum(pct,0)}%</span></div>
<p style="font-size:13px;color:var(--text-light)">${t('plan_target_date')}: ${fmtDate(p.targetDate)}${c?' | '+sanitizeHTML(c.name):''}</p>
<div class="stat-row"><span class="stat-label">${t('plan_eggs_needed')}</span><span class="stat-value">${fmtNum(p.eggsNeeded)}</span></div>
<div class="stat-row"><span class="stat-label">${t('plan_expected')}</span><span class="stat-value">${fmtNum(totalExpected)}</span></div>
<div class="stat-row"><span class="stat-label">${t('plan_gap')}</span><span class="stat-value" style="color:${statusColor}">${gap>0?'+':''}${fmtNum(gap)} (${statusText})</span></div>`;
if(p.flockAllocations&&p.flockAllocations.length){
h+=`<div style="margin-top:8px;font-size:12px">`;
p.flockAllocations.forEach(a=>{const fl=D.flocks.find(x=>x.id===a.flockId);
h+=`<div class="stat-row"><span class="stat-label">${fl?sanitizeHTML(fl.name):'?'}</span><span class="stat-value">${fmtNum(a.expectedEggs)} ${t('eggs_unit')}</span></div>`;});
h+='</div>';}
h+=`<div class="btn-group" style="margin-top:12px">
<button class="btn btn-secondary btn-sm" onclick="showPlanForm('${escapeAttr(p.id)}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deletePlan('${escapeAttr(p.id)}')">${t('delete')}</button></div></div>`;});
h+='</div>';
$('sec-planificacion').innerHTML=h;
}
function estimateProduction(D,flockId,fromDate,toDate){
const f=D.flocks.find(x=>x.id===flockId);if(!f||!f.birthdate)return 0;
const bkey2=f.breed&&BREED_CURVES[f.breed]?f.breed:(f.targetCurve&&BREED_CURVES[f.targetCurve]?f.targetCurve:'generic');const curve=BREED_CURVES[bkey2]||BREED_CURVES.generic;
const birth=new Date(f.birthdate+'T12:00:00');
const from=new Date(fromDate+'T12:00:00');const to=new Date(toDate+'T12:00:00');
let total=0;const hens=activeHensByFlock(flockId);
for(let d=new Date(from);d<=to;d.setDate(d.getDate()+1)){
const ageWeeks=Math.floor((d-birth)/(7*24*3600000));
const weekIdx=ageWeeks-18;
if(weekIdx<0)continue;
const henDay=weekIdx<curve.length?curve[weekIdx]:curve[curve.length-1];
const adj=f.curveAdjust!=null?f.curveAdjust:1.0;
total+=hens*(henDay/100)*adj;
}
return Math.round(total);
}
function estimateTotalProduction(D,plan){
if(!plan.flockAllocations||!plan.flockAllocations.length){
let total=0;D.flocks.filter(f=>f.status!=='descarte').forEach(f=>{
total+=estimateProduction(D,f.id,todayStr(),plan.targetDate);});return total;}
return plan.flockAllocations.reduce((s,a)=>s+(a.expectedEggs||estimateProduction(D,a.flockId,todayStr(),plan.targetDate)),0);
}
function showPlanForm(id){
const D=loadData();const p=id?D.productionPlans.find(x=>x.id===id):null;
let flockChecks='';D.flocks.filter(f=>f.status!=='descarte').forEach(f=>{
const alloc=p?p.flockAllocations?.find(a=>a.flockId===f.id):null;
const est=estimateProduction(D,f.id,todayStr(),p?p.targetDate:new Date(Date.now()+30*86400000).toISOString().substring(0,10));
flockChecks+=`<div class="form-row" style="align-items:center"><label><input type="checkbox" class="plan-flock" value="${escapeAttr(f.id)}"${alloc?' checked':''}> ${sanitizeHTML(f.name)}</label>
<span style="font-size:12px;color:var(--text-light)">${t('plan_estimate')}: ~${fmtNum(est)}</span></div>`;});
openModal(p?t('edit'):t('plan_add'),`
<div class="form-row"><div class="form-group"><label>${t('plan_name')}</label><input id="pl-name" value="${p?escapeAttr(p.name):''}"></div>
<div class="form-group"><label>${t('plan_target_date')}</label><input type="date" id="pl-date" value="${p?p.targetDate:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('plan_eggs_needed')}</label><input type="number" id="pl-eggs" value="${p?p.eggsNeeded:''}" min="0"></div>
<div class="form-group"><label>${t('fin_client')}</label><select id="pl-client">${clientSelect(p?p.clientId:'')}</select></div></div>
<div class="form-group"><label>${t('plan_allocations')}</label>${flockChecks}</div>
<div class="form-group"><label>${t('notes')}</label><textarea id="pl-notes">${p?escapeAttr(p.notes||''):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="savePlan('${id||''}')">${t('save')}</button></div>`);
}
function savePlan(id){
clearFieldErrors();
const D=loadData();const checks=document.querySelectorAll('.plan-flock:checked');
const allocs=Array.from(checks).map(c=>({flockId:c.value,expectedEggs:estimateProduction(D,c.value,todayStr(),$('pl-date').value)}));
const o={name:$('pl-name').value,targetDate:$('pl-date').value,eggsNeeded:parseInt($('pl-eggs').value)||0,
clientId:$('pl-client').value,notes:$('pl-notes').value,flockAllocations:allocs};
const v=validateForm({'pl-name':{value:o.name,rules:{required:true,maxLength:100}},'pl-date':{value:o.targetDate,rules:{required:true,date:true}},'pl-eggs':{value:$('pl-eggs').value,rules:{numeric:true,min:0}}});
if(!v.valid){Object.entries(v.errors).forEach(([k,e])=>showFieldError(k,e[0]));return;}
if(id){const i=D.productionPlans.findIndex(p=>p.id===id);if(i>=0)D.productionPlans[i]={...D.productionPlans[i],...o};}
else{o.id=genId();D.productionPlans.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderPlanning();
}
async function deletePlan(id){if(!await showConfirm(t('confirm_delete')))return;const D=loadData();D.productionPlans=D.productionPlans.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderPlanning();}

// ============ CAMPO MODE ============
function toggleCampoMode(){
const D=loadData();D.settings.campoMode=!D.settings.campoMode;
if(D.settings.campoMode)D.settings.vetMode=false;
saveData(D);applyCampoMode(D);nav('dashboard');
}
function applyCampoMode(D){
document.body.classList.toggle('campo-mode',D.settings.campoMode);
document.body.classList.toggle('vet-mode',D.settings.vetMode);
$('btn-campo')?.classList.toggle('active',D.settings.campoMode);
$('btn-vet')?.classList.toggle('active',D.settings.vetMode);
// Hide non-essential nav items in campo mode
document.querySelectorAll('#main-nav a').forEach(a=>{
const s=a.dataset.section;
if(D.settings.campoMode&&!['dashboard','produccion','lotes','alimento','ambiente'].includes(s)){a.classList.add('campo-hide');}
else if(D.settings.vetMode&&!['dashboard','lotes','ambiente','sanidad','bioseguridad','trazabilidad'].includes(s)){a.classList.add('campo-hide');}
else{a.classList.remove('campo-hide');}
});
// Hide group labels + group containers whose modules are all hidden
document.querySelectorAll('.nav-group-label').forEach(lbl=>{
const grp=lbl.nextElementSibling;
if(!grp||!grp.classList.contains('nav-group-links'))return;
const allHidden=Array.from(grp.querySelectorAll('a[data-section]')).every(a=>a.classList.contains('campo-hide'));
lbl.classList.toggle('campo-hide',allHidden);
grp.classList.toggle('campo-hide',allHidden);
});
}
function renderCampoDashboard(D){
const snap=computeKpiSnapshot();const alerts=getAlerts(D);
let h=`<div style="text-align:center;padding:20px 0"><h2>🌾 ${t('nav_campo_mode')}</h2></div>`;
h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;max-width:500px;margin:0 auto">`;
h+=`<div class="kpi-card" style="padding:24px;text-align:center"><div class="kpi-label">${t('kpi_today')}</div><div class="campo-kpi">${fmtNum(snap.eggsToday)}</div></div>`;
h+=`<div class="kpi-card" style="padding:24px;text-align:center"><div class="kpi-label">${t('kpi_henday')}</div><div class="campo-kpi">${fmtNum(snap.henDay,1)}%</div></div>`;
h+=`<div class="kpi-card" style="padding:24px;text-align:center"><div class="kpi-label">${t('kpi_mortality')}</div><div class="campo-kpi">${fmtNum(snap.mortality,1)}%</div></div>`;
h+=`<div class="kpi-card" style="padding:24px;text-align:center"><div class="kpi-label">${t('kpi_alerts')}</div><div class="campo-kpi">${alerts.length}</div></div>`;
h+=`</div>`;
h+=`<button class="campo-btn-big" onclick="showCampoQuickEntry()">📝 ${t('campo_today')}</button>`;
if(alerts.length){h+=`<div class="card" style="margin-top:16px"><h3>${t('dash_alerts')}</h3>`;
alerts.forEach(a=>{h+=`<div class="alert-card alert-${sanitizeHTML(a.type)}">${sanitizeHTML(a.icon)} ${a.msg}</div>`;});h+='</div>';}
return h;
}
function showCampoQuickEntry(){
const D=loadData();
openModal('📝 '+t('campo_quick_entry'),`
<div class="form-group"><label>${t('prod_flock')}</label><select id="cq-flock">${flockSelect('')}</select></div>
<div class="form-group"><label>${t('prod_eggs')}</label><input type="number" id="cq-eggs" min="0" style="font-size:24px;padding:12px"></div>
<div class="form-group"><label>${t('prod_deaths')}</label><input type="number" id="cq-deaths" min="0" value="0"></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveCampoQuick()" style="font-size:18px;padding:12px 24px">${t('save')}</button></div>`);
}
function saveCampoQuick(){
const D=loadData();const o={id:genId(),date:todayStr(),flockId:$('cq-flock').value,
eggsCollected:parseInt($('cq-eggs').value)||0,deaths:parseInt($('cq-deaths').value)||0,
eggsBroken:0,eggsS:0,eggsM:0,eggsL:0,eggsXL:0,eggsJumbo:0,shellColor:'',yolkScore:0,deathCause:'',notes:'campo mode'};
if(!o.flockId){toast(t('required'),true);return;}
D.dailyProduction.push(o);saveData(D);closeModal();toast(t('cfg_saved'));nav('dashboard');
}

// ============ VET MODE ============
function toggleVetMode(){
const D=loadData();D.settings.vetMode=!D.settings.vetMode;
if(D.settings.vetMode)D.settings.campoMode=false;
saveData(D);applyCampoMode(D);
if(D.settings.vetMode)showVetDashboard();else nav('dashboard');
}
function showVetDashboard(){
const D=loadData();
let h=`<div style="text-align:center;padding:12px 0"><h2>🩺 ${t('nav_vet_mode')}</h2></div>`;
h+=`<div class="form-group"><label>${t('vet_select_farm')}</label><select id="vet-flock" onchange="renderVetFlock()">${flockSelect('',true)}</select></div>`;
h+=`<div id="vet-content"></div>`;
h+=`<div class="card" style="margin-top:16px"><h4>${t('actions')}</h4><div class="btn-group">
<button class="btn btn-primary" onclick="vetAction('visit')">✅ ${t('vet_visit')}</button>
<button class="btn btn-secondary" onclick="vetAction('vaccines')">💉 ${t('vet_vaccines')}</button>
<button class="btn btn-secondary" onclick="vetAction('pending')">⏳ ${t('vet_pending')}</button></div></div>`;
$('sec-dashboard').innerHTML=h;
}
function renderVetFlock(){
const fid=$('vet-flock')?.value;const D=loadData();
if(!fid){$('vet-content').innerHTML='';return;}
const f=D.flocks.find(x=>x.id===fid);if(!f)return;
const hs=computeFlockHealthScore(fid,D);
const outbreaks=D.outbreaks.filter(o=>o.flockId===fid&&o.status==='active');
const lastEnv=D.environment.length>0?D.environment[D.environment.length-1]:null;
const pendingVac=D.vaccines.filter(v=>v.flockId===fid&&v.status!=='applied');
let h=`<div class="kpi-grid">`;
h+=kpi(t('flock_health'),hs+'/100','',hs<50?'danger':hs<70?'warning':'');
h+=kpi(t('out_title'),outbreaks.length.toString(),outbreaks.length?t('out_active'):'✅',outbreaks.length?'danger':'');
h+=kpi(t('vac_title'),pendingVac.length.toString(),t('vac_pending'),'');
h+=`</div>`;
if(outbreaks.length){h+=`<div class="card"><h4>🦠 ${t('out_title')}</h4>`;
outbreaks.forEach(o=>{h+=`<div class="alert-card alert-danger">${sanitizeHTML(o.disease)} - ${fmtDate(o.startDate)} | ${sanitizeHTML(o.treatment||'-')}</div>`;});h+='</div>';}
if(lastEnv){h+=`<div class="card"><h4>🌡️ ${t('env_title')}</h4>
<p>${t('env_temp')}: ${lastEnv.temperature||'-'}°C | ${t('env_humidity')}: ${lastEnv.humidity||'-'}%</p></div>`;}
if(pendingVac.length){h+=`<div class="card"><h4>💉 ${t('vac_title')}</h4>`;
pendingVac.forEach(v=>{h+=`<div class="alert-card alert-${v.scheduledDate<todayStr()?'danger':'warning'}">${sanitizeHTML(v.vaccineName)} - ${fmtDate(v.scheduledDate)} (${v.scheduledDate<todayStr()?t('vac_overdue'):t('vac_pending')})</div>`;});h+='</div>';}
// Cross-contamination check from biosecurity visitors
const recentVisitors=D.biosecurity.visitors.filter(v=>v.fromFarmHealth==='outbreak'&&v.date>=new Date(Date.now()-7*86400000).toISOString().substring(0,10));
if(recentVisitors.length){h+=`<div class="alert-card alert-danger">${t('bio_cross_risk')}: ${recentVisitors.map(v=>sanitizeHTML(v.name)).join(', ')}</div>`;}
$('vet-content').innerHTML=h;
}
function vetAction(type){
const D=loadData();const fid=$('vet-flock')?.value||'';const f=D.flocks.find(x=>x.id===fid);
const note=type==='visit'?t('vet_visit'):type==='vaccines'?t('vet_vaccines'):t('vet_pending');
D.logbook.push({id:genId(),date:todayStr(),entry:'🩺 '+note+(f?' - '+sanitizeHTML(f.name):''),category:'health'});
// Auto-create biosecurity visitor record
D.biosecurity.visitors.push({id:genId(),date:todayStr(),name:'Veterinario',company:'',purpose:note,zone:'',vehiclePlate:'',disinfected:true,fromFarmId:'',fromFarmHealth:'healthy',notes:''});
saveData(D);toast(t('cfg_saved'));
}

// ============ OUTBREAK RISK CLASSIFIER ============
function computeOutbreakRisk(D){
const hens=activeHens();if(hens===0)return{probability:0,classification:0,factors:[],recommendations:[]};
const factors=[];
// 1. Mortality spike (0.25)
const l7prod=D.dailyProduction.sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const l7deaths=l7prod.reduce((s,p)=>s+(p.deaths||0),0);
const deathRate=hens>0?(l7deaths/hens*100):0;
const mortFactor=Math.min(1,deathRate/10);
factors.push({name:tc('Mortalidad')||t('kpi_mortality')||'Mortality',weight:0.25,value:mortFactor,detail:fmtNum(deathRate,2)+'%'});
// 2. FCR deterioration (0.15)
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const f30=D.feed.consumption.filter(c=>c.date>=d30s);const e30=D.dailyProduction.filter(p=>p.date>=d30s);
const tfkg=f30.reduce((s,c)=>s+(c.quantityKg||0),0);const tekg=e30.reduce((s,p)=>s+(p.eggsCollected||0),0)*0.06;
const fcr=tekg>0?tfkg/tekg:0;
const fcrFactor=fcr>0?Math.min(1,(fcr-2)/2):0;
factors.push({name:'FCR',weight:0.15,value:fcrFactor,detail:fmtNum(fcr,2)});
// 3. THI stress (0.15)
const lastW=D.weatherCache.length>0?D.weatherCache[D.weatherCache.length-1]:null;
let thiFactor=0;
if(lastW){const thi=calcTHI(lastW.temp,lastW.humidity);thiFactor=thi>28?Math.min(1,(thi-25)/10):0;
factors.push({name:'THI',weight:0.15,value:thiFactor,detail:fmtNum(thi,1)});}
else factors.push({name:'THI',weight:0.15,value:0,detail:'-'});
// 4. Production drop (0.20)
let prodFactor=0;
if(l7prod.length>=7&&typeof ss!=='undefined'){
const points=l7prod.map((p,i)=>[i,p.eggsCollected||0]);
const reg=ss.linearRegression(points);
prodFactor=reg.m<0?Math.min(1,Math.abs(reg.m)/10):0;
}
factors.push({name:t('pred_drop_risk')||'Production drop',weight:0.20,value:prodFactor,detail:''});
// 5. Active outbreaks (0.10)
const activeOut=D.outbreaks.filter(o=>o.status==='active').length;
const outFactor=Math.min(1,activeOut/3);
factors.push({name:t('out_active')||'Active outbreaks',weight:0.10,value:outFactor,detail:activeOut.toString()});
// 6. Vaccination gaps (0.10)
const today=todayStr();const overdueVac=D.vaccines.filter(v=>v.status!=='applied'&&v.scheduledDate<today).length;
const vacFactor=Math.min(1,overdueVac/5);
factors.push({name:t('vac_overdue')||'Vaccine gaps',weight:0.10,value:vacFactor,detail:overdueVac.toString()});
// 7. Stress events (0.05)
const d7=new Date();d7.setDate(d7.getDate()-7);const d7s=d7.toISOString().substring(0,10);
const recentStress=D.stressEvents.filter(e=>e.date>=d7s).length;
const stressFactor=Math.min(1,recentStress/3);
factors.push({name:t('stress_title')||'Recent stress',weight:0.05,value:stressFactor,detail:recentStress.toString()});
// Compute probability via sigmoid
const z=factors.reduce((s,f)=>s+f.weight*f.value*6,0)-2;
const probability=1/(1+Math.exp(-z));
const classification=probability>=0.5?1:0;
// Recommendations
const recommendations=[];
if(mortFactor>0.5)recommendations.push({priority:'high',icon:'🔬',msg:t('rec_lab_samples')});
if(thiFactor>0.5)recommendations.push({priority:'high',icon:'🌡️',msg:t('rec_ventilation')});
if(fcrFactor>0.5)recommendations.push({priority:'medium',icon:'🌾',msg:t('rec_check_diet')});
if(prodFactor>0.5)recommendations.push({priority:'medium',icon:'📉',msg:t('rec_check_env')});
if(overdueVac>0)recommendations.push({priority:'medium',icon:'💉',msg:t('alert_vaccine_overdue')+': '+overdueVac});
return{probability,classification,factors,recommendations};
}

// ============ MULTI-STEP FORECAST ============
function computeForecast(D,days=7){
if(typeof ss==='undefined')return{dates:[],actual:[],forecast:[],upper:[],lower:[]};
const prod=D.dailyProduction.sort((a,b)=>a.date.localeCompare(b.date));
if(prod.length<7)return{dates:[],actual:[],forecast:[],upper:[],lower:[]};
const last14=prod.slice(-14);
const values=last14.map(p=>p.eggsCollected||0);
// Weighted Moving Average
const wmaForecast=[];
const weights=values.map((_,i)=>Math.exp(i*0.2));const wSum=weights.reduce((a,b)=>a+b,0);
const wma=values.reduce((s,v,i)=>s+v*weights[i],0)/wSum;
for(let i=0;i<days;i++)wmaForecast.push(wma);
// Linear regression
const points=values.map((v,i)=>[i,v]);
const reg=ss.linearRegression(points);const regLine=ss.linearRegressionLine(reg);
const lrForecast=[];
for(let i=0;i<days;i++)lrForecast.push(Math.max(0,regLine(values.length+i)));
// Ensemble (average)
const ensemble=wmaForecast.map((w,i)=>(w+lrForecast[i])/2);
// Residuals for confidence bands
const residuals=values.map((v,i)=>v-regLine(i));
const stdDev=typeof ss.standardDeviation==='function'?ss.standardDeviation(residuals):
Math.sqrt(residuals.reduce((s,r)=>s+r*r,0)/residuals.length);
const upper=ensemble.map(v=>v+stdDev);
const lower=ensemble.map(v=>Math.max(0,v-stdDev));
// Generate date labels
const dates=[];const lastDate=new Date(last14[last14.length-1].date+'T12:00:00');
for(let i=1;i<=days;i++){const d=new Date(lastDate);d.setDate(d.getDate()+i);dates.push(d.toISOString().substring(0,10));}
const actualDates=last14.map(p=>p.date);
return{dates,actual:values,actualDates,forecast:ensemble,upper,lower,wma:wmaForecast,lr:lrForecast};
}

// ============ RECOMMENDATION ENGINE ============
function getRecommendations(D){
const recs=[];const today=todayStr();const hens=activeHens();
// FCR check
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const f30=D.feed.consumption.filter(c=>c.date>=d30s);const e30=D.dailyProduction.filter(p=>p.date>=d30s);
const tfkg=f30.reduce((s,c)=>s+(c.quantityKg||0),0);const tekg=e30.reduce((s,p)=>s+(p.eggsCollected||0),0)*0.06;
const fcr=tekg>0?tfkg/tekg:0;
if(fcr>2.4)recs.push({priority:'medium',icon:'🌾',msg:t('rec_check_diet')});
// Mortality spike 48h
const d2=new Date();d2.setDate(d2.getDate()-2);const d2s=d2.toISOString().substring(0,10);
const recent48=D.dailyProduction.filter(p=>p.date>=d2s);
const deaths48=recent48.reduce((s,p)=>s+(p.deaths||0),0);
const prev48=D.dailyProduction.filter(p=>p.date<d2s).slice(-recent48.length||1);
const deathsPrev=prev48.reduce((s,p)=>s+(p.deaths||0),0);
if(deathsPrev>0&&deaths48>deathsPrev*1.2)recs.push({priority:'high',icon:'⚠️',msg:t('rec_check_env')});
// Hen-Day vs breed curve
D.flocks.filter(f=>f.status==='produccion'&&f.birthdate).forEach(f=>{
const bkey3=f.breed&&BREED_CURVES[f.breed]?f.breed:(f.targetCurve&&BREED_CURVES[f.targetCurve]?f.targetCurve:'generic');const curve=BREED_CURVES[bkey3]||BREED_CURVES.generic;
const ageWeeks=Math.floor((new Date()-new Date(f.birthdate+'T12:00:00'))/(7*24*3600000));
const weekIdx=ageWeeks-18;if(weekIdx<0||weekIdx>=curve.length)return;
const expected=curve[weekIdx];const fhens=activeHensByFlock(f.id);
const l7=D.dailyProduction.filter(p=>p.flockId===f.id).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const avgE=l7.length>0?l7.reduce((s,p)=>s+(p.eggsCollected||0),0)/l7.length:0;
const actual=fhens>0?(avgE/fhens*100):0;
if(expected-actual>10)recs.push({priority:'medium',icon:'📉',msg:t('rec_below_curve')+' ('+f.name+')'});
});
// Feed stock
const stock=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0)-D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0);
const avgDaily=D.feed.consumption.length>0?D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0)/Math.max(1,D.feed.consumption.length):0;
if(avgDaily>0&&stock/avgDaily<7)recs.push({priority:'medium',icon:'🌾',msg:t('rec_buy_feed')});
// No env reading in 3 days
const d3=new Date();d3.setDate(d3.getDate()-3);const d3s=d3.toISOString().substring(0,10);
const recentEnv=D.environment.filter(e=>e.date>=d3s);
if(!recentEnv.length&&D.environment.length>0)recs.push({priority:'low',icon:'🌡️',msg:t('rec_record_env')});
// Overdue disinfection
if(D.biosecurity){D.biosecurity.zones.forEach(z=>{
if(z.lastDisinfection&&z.frequencyDays){
const next=new Date(z.lastDisinfection+'T12:00:00');next.setDate(next.getDate()+z.frequencyDays);
if(next.toISOString().substring(0,10)<today)recs.push({priority:'medium',icon:'🛡️',msg:t('rec_disinfect')+' '+z.name});
}});}
// Prolonged heat stress
const lastW=D.weatherCache.slice(-2);
if(lastW.length>=2&&lastW.every(w=>calcTHI(w.temp,w.humidity)>28))recs.push({priority:'high',icon:'🌡️',msg:t('rec_heat_plan')});
return recs;
}

// ============ ACCESSIBILITY HELPERS ============
function applyFontScale(scale){
document.body.classList.remove('font-small','font-normal','font-large','font-xlarge');
document.body.classList.add('font-'+scale);
const D=loadData();D.settings.fontScale=scale;saveData(D);
}
function applyDarkMode(on){
document.body.classList.toggle('dark-mode',on);
const D=loadData();D.settings.darkMode=on;saveData(D);
if(on){applyTheme('dark');localStorage.setItem('egglogu_theme','dark');}
}

// ============ PIN LOGIN (A8) ============
function showPinLogin(){
const D=loadData();if(!D.users.length)return false;// No users = skip PIN
const appEl=document.querySelector('.app');if(appEl)appEl.style.display='none';
const overlay=document.createElement('div');overlay.id='pin-login-overlay';
overlay.style.cssText='position:fixed;inset:0;background:var(--sidebar-bg,#1a237e);display:flex;align-items:center;justify-content:center;z-index:9999;';
let h='<div style="background:var(--card-bg,#fff);padding:32px;border-radius:16px;max-width:360px;width:90%;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.3)">';
h+='<h2 style="margin-bottom:4px">🥚 EGGlogU</h2><p style="color:var(--text-light);margin-bottom:20px">'+(t('pin_select_user')||'Select user')+'</p>';
h+='<div class="form-group"><select id="pin-user" style="width:100%;padding:10px;font-size:16px;border-radius:var(--radius);border:1px solid var(--border)">';
D.users.forEach(u=>{h+=`<option value="${escapeAttr(u.id)}">${sanitizeHTML(u.name)} (${u.role})</option>`;});
h+='</select></div>';
h+='<div class="form-group" style="margin-top:12px"><input type="password" id="pin-code" maxlength="4" placeholder="PIN (4 digits)" style="width:100%;padding:10px;font-size:20px;text-align:center;letter-spacing:8px;border-radius:var(--radius);border:1px solid var(--border)"></div>';
h+='<button onclick="verifyPin()" style="width:100%;padding:12px;background:var(--primary,#1a73e8);color:#fff;border:none;border-radius:var(--radius);font-size:16px;cursor:pointer;margin-top:8px">'+(t('pin_login')||'Login')+'</button>';
h+='<p id="pin-error" style="color:var(--danger,red);margin-top:8px;display:none"></p></div>';
overlay.innerHTML=h;document.body.appendChild(overlay);
$('pin-code')?.focus();
$('pin-code')?.addEventListener('keydown',e=>{if(e.key==='Enter')verifyPin();});
return true;
}
function verifyPin(){
const D=loadData();const uid=$('pin-user')?.value;const pin=$('pin-code')?.value||'';
const user=D.users.find(u=>u.id===uid);
if(!user){$('pin-error').textContent='User not found';$('pin-error').style.display='block';return;}
if(user.pin&&user.pin!==pin){$('pin-error').textContent=t('pin_invalid')||'Invalid PIN';$('pin-error').style.display='block';$('pin-code').value='';$('pin-code')?.focus();return;}
_currentUser={name:user.name,role:user.role,id:user.id};
logAudit('login','auth','User login: '+user.name+' ('+user.role+')',null,{user:user.name,role:user.role});
const overlay=$('pin-login-overlay');if(overlay)overlay.remove();
const appEl=document.querySelector('.app');if(appEl)appEl.style.display='';
// Apply role-based nav filtering
applyRoleNav();
// Show current user in header
const header=document.querySelector('.top-bar .hamburger');
if(header){const userTag=document.createElement('span');userTag.id='current-user-tag';userTag.style.cssText='font-size:12px;color:var(--text-light);margin-left:8px';
userTag.textContent='👤 '+user.name+' ('+user.role+')';header.parentNode.insertBefore(userTag,header.nextSibling);}
}
function applyRoleNav(){
if(!_currentUser||!_currentUser.role)return;
document.querySelectorAll('#main-nav a[data-section]').forEach(a=>{
const section=a.getAttribute('data-section');
if(!hasPermission(section)){a.style.display='none';}else{a.style.display='';}
});
// Hide group labels + containers if all children hidden
document.querySelectorAll('.nav-group-label').forEach(lbl=>{
const grp=lbl.nextElementSibling;
if(!grp||!grp.classList.contains('nav-group-links'))return;
const allHidden=Array.from(grp.querySelectorAll('a[data-section]')).every(a=>a.style.display==='none');
lbl.style.display=allHidden?'none':'';
grp.style.display=allHidden?'none':'';
});
}
// ============ INIT ============
function init(){
// Auth gate — must authenticate before loading app
if(!checkAuth())return;
DATA=null;loadData();const savedTheme=localStorage.getItem('egglogu_theme');if(savedTheme&&THEMES[savedTheme])applyTheme(savedTheme);
// Apply saved settings
const D=loadData();
if(D.settings.fontScale&&D.settings.fontScale!=='normal')applyFontScale(D.settings.fontScale);
if(D.settings.darkMode)document.body.classList.add('dark-mode');
applyCampoMode(D);
switchLang(LANG);
// PIN login if users exist (A8)
applyCustomPermissions();
checkBillingCycleDeactivations();
if(D.users.length>0){showPinLogin();}else{nav('dashboard');}
// Keyboard navigation for sidebar
document.querySelectorAll('#main-nav a').forEach(a=>{a.setAttribute('tabindex','0');a.setAttribute('role','menuitem');a.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();a.click();}});});
// Escape key closes modal/confirm dialogs
document.addEventListener('keydown',e=>{if(e.key==='Escape'){
if($('confirm-overlay')?.classList.contains('show')){const cBtn=$('confirm-overlay').querySelector('.confirm-btn-cancel');if(cBtn)cBtn.click();}
else if($('modal-overlay')?.classList.contains('open'))closeModal();
}});
// Focus trap within modal
document.addEventListener('keydown',e=>{if(e.key!=='Tab')return;
const modal=$('modal-overlay');if(!modal||!modal.classList.contains('open'))return;
const focusable=modal.querySelectorAll('input,select,textarea,button,[tabindex]:not([tabindex="-1"])');
if(!focusable.length)return;const first=focusable[0],last=focusable[focusable.length-1];
if(e.shiftKey&&document.activeElement===first){e.preventDefault();last.focus();}
else if(!e.shiftKey&&document.activeElement===last){e.preventDefault();first.focus();}
});
}
window.addEventListener('DOMContentLoaded',init);

// ============ BUG REPORTER WIDGET ============
(function(){
const STORAGE_KEY='egglogu_bugs';
function loadBugs(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch(e){return[];}}
function saveBugs(b){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(b.slice(-100)));}catch(e){}}

function injectBugWidget(){
// Floating button
const fab=document.createElement('div');
fab.id='bug-fab';
fab.innerHTML=`<span style="font-size:20px">🐛</span><span id="bug-badge" style="display:none;position:absolute;top:-4px;right:-4px;background:#f44336;color:#fff;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:50%;align-items:center;justify-content:center">0</span>`;
fab.style.cssText='position:fixed;bottom:20px;right:20px;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#ff5722,#f44336);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 16px rgba(244,67,54,.4);z-index:99999;transition:transform .2s,box-shadow .2s;user-select:none';
fab.onmouseenter=()=>{fab.style.transform='scale(1.12)';fab.style.boxShadow='0 6px 24px rgba(244,67,54,.5)';};
fab.onmouseleave=()=>{fab.style.transform='scale(1)';fab.style.boxShadow='0 4px 16px rgba(244,67,54,.4)';};
fab.onclick=toggleBugPanel;
document.body.appendChild(fab);
_bugUpdateBadge();

// Panel
const panel=document.createElement('div');
panel.id='bug-panel';
panel.style.cssText='position:fixed;bottom:80px;right:20px;width:380px;max-height:80vh;background:var(--card,#1a1a2e);border:1px solid var(--border,#333);border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.4);z-index:99998;display:none;flex-direction:column;overflow:hidden;font-family:inherit;font-size:13px;color:var(--text,#eee)';
document.body.appendChild(panel);
}

function toggleBugPanel(){
const p=document.getElementById('bug-panel');
if(!p)return;
if(p.style.display==='flex'){p.style.display='none';return;}
p.style.display='flex';
renderBugPanel();
}

function renderBugPanel(){
const p=document.getElementById('bug-panel');if(!p)return;
const bugs=loadBugs();
const section=typeof currentSection!=='undefined'?currentSection:'?';
const user=typeof _currentUser!=='undefined'&&_currentUser?_currentUser.name:'—';
const errCount=_bugErrors.length;

let h=`<div style="padding:14px 16px;background:linear-gradient(135deg,#ff5722,#d32f2f);color:#fff;font-weight:700;display:flex;justify-content:space-between;align-items:center">
<span>🐛 Bug Reporter</span>
<button onclick="document.getElementById('bug-panel').style.display='none'" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;padding:0 4px">✕</button>
</div>`;

// Auto-captured context
h+=`<div style="padding:10px 16px;background:rgba(255,152,0,.08);border-bottom:1px solid var(--border,#333);font-size:11px">
<div style="display:flex;gap:12px;flex-wrap:wrap">
<span><strong>Sección:</strong> <code style="background:rgba(255,255,255,.1);padding:1px 6px;border-radius:4px">${section}</code></span>
<span><strong>Usuario:</strong> ${sanitizeHTML(user)}</span>
<span><strong>Errores JS:</strong> <span style="color:${errCount?'#f44336':'#4caf50'};font-weight:700">${errCount}</span></span>
</div></div>`;

// New bug form
h+=`<div style="padding:12px 16px;border-bottom:1px solid var(--border,#333)">
<div style="margin-bottom:8px"><select id="bug-severity" style="width:100%;padding:6px 10px;border-radius:8px;border:1px solid var(--border,#333);background:var(--bg,#111);color:var(--text,#eee);font-size:12px">
<option value="low">🟡 Bajo — Visual/cosmético</option>
<option value="medium" selected>🟠 Medio — Funcionalidad parcial</option>
<option value="high">🔴 Alto — Funcionalidad rota</option>
<option value="critical">💀 Crítico — Pérdida de datos/crash</option>
</select></div>
<div style="margin-bottom:8px"><textarea id="bug-desc" rows="3" placeholder="¿Qué pasó? Describe el bug..." style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border,#333);background:var(--bg,#111);color:var(--text,#eee);font-size:12px;resize:vertical;box-sizing:border-box"></textarea></div>
<div style="display:flex;gap:8px">
<button onclick="_submitBug()" style="flex:1;padding:8px;border:none;border-radius:8px;background:linear-gradient(135deg,#ff5722,#f44336);color:#fff;font-weight:700;cursor:pointer;font-size:12px">📨 Reportar Bug</button>
${errCount?`<button onclick="_attachErrors()" style="padding:8px 12px;border:none;border-radius:8px;background:rgba(255,152,0,.2);color:#ff9800;cursor:pointer;font-size:11px;font-weight:600" title="Adjuntar errores capturados">📎 ${errCount} err</button>`:''}
</div></div>`;

// Bug list
h+=`<div style="flex:1;overflow-y:auto;max-height:40vh">`;
if(bugs.length===0){
h+=`<div style="text-align:center;padding:30px 16px;color:var(--text-muted,#666)">
<div style="font-size:32px;margin-bottom:8px">✨</div>
<div>No hay bugs reportados</div>
<div style="font-size:11px;margin-top:4px">¡El app funciona perfecto! (o nadie ha reportado)</div>
</div>`;
}else{
bugs.slice().reverse().forEach((b,i)=>{
const idx=bugs.length-1-i;
const sevIcon={low:'🟡',medium:'🟠',high:'🔴',critical:'💀'}[b.severity]||'🟠';
const sevColor={low:'#ffeb3b',medium:'#ff9800',high:'#f44336',critical:'#b71c1c'}[b.severity]||'#ff9800';
const ts=new Date(b.ts).toLocaleString();
const errBadge=b.errors?.length?`<span style="background:rgba(244,67,54,.15);color:#f44336;font-size:10px;padding:1px 6px;border-radius:8px;margin-left:4px">${b.errors.length} err</span>`:'';
h+=`<div style="padding:10px 16px;border-bottom:1px solid var(--border,#222);position:relative" class="bug-item">
<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
<div style="flex:1">
<div style="font-size:11px;color:var(--text-muted,#666);margin-bottom:3px">${ts} · <code style="font-size:10px;background:rgba(255,255,255,.06);padding:1px 5px;border-radius:4px">${sanitizeHTML(b.section)}</code> ${errBadge}</div>
<div style="font-size:12px;line-height:1.4">${sevIcon} ${sanitizeHTML(b.desc)}</div>`;
if(b.errors?.length){
h+=`<details style="margin-top:4px"><summary style="font-size:10px;color:#f44336;cursor:pointer">Ver errores adjuntos (${b.errors.length})</summary>
<div style="margin-top:4px;font-size:10px;font-family:monospace;background:rgba(0,0,0,.3);padding:6px 8px;border-radius:6px;max-height:120px;overflow-y:auto">`;
b.errors.forEach(e=>{
h+=`<div style="margin-bottom:4px;border-bottom:1px solid rgba(255,255,255,.05);padding-bottom:3px">
<span style="color:#f44336">${sanitizeHTML(e.type)}</span> @ <span style="color:#64b5f6">${sanitizeHTML(e.src)}:${e.line}:${e.col}</span><br>
<span style="color:#fff">${sanitizeHTML(e.msg)}</span>
${e.stack?'<br><span style="color:#888">'+sanitizeHTML(e.stack.substring(0,150))+'</span>':''}
</div>`;
});
h+=`</div></details>`;
}
h+=`</div>
<button onclick="_deleteBug(${idx})" style="background:none;border:none;color:var(--text-muted,#666);cursor:pointer;font-size:14px;padding:2px;flex-shrink:0" title="Eliminar">🗑</button>
</div></div>`;
});
}
h+=`</div>`;

// Footer
if(bugs.length>0){
h+=`<div style="padding:8px 16px;border-top:1px solid var(--border,#333);display:flex;justify-content:space-between;align-items:center">
<span style="font-size:11px;color:var(--text-muted,#666)">${bugs.length} bug${bugs.length!==1?'s':''} reportado${bugs.length!==1?'s':''}</span>
<div style="display:flex;gap:6px">
<button onclick="_exportBugs()" style="padding:4px 10px;border:none;border-radius:6px;background:rgba(255,255,255,.08);color:var(--text,#eee);cursor:pointer;font-size:11px">📋 Exportar</button>
<button onclick="_clearBugs()" style="padding:4px 10px;border:none;border-radius:6px;background:rgba(244,67,54,.1);color:#f44336;cursor:pointer;font-size:11px">🗑 Limpiar</button>
</div></div>`;
}

p.innerHTML=h;
}

// Submit bug
window._submitBug=function(){
const desc=document.getElementById('bug-desc')?.value?.trim();
if(!desc){toast?.('Describe el bug',true);return;}
const bug={
id:typeof genId!=='undefined'?genId():Date.now().toString(36),
ts:new Date().toISOString(),
section:typeof currentSection!=='undefined'?currentSection:'?',
user:typeof _currentUser!=='undefined'&&_currentUser?_currentUser.name:'anon',
severity:document.getElementById('bug-severity')?.value||'medium',
desc:desc,
errors:window._bugAttachedErrors||null,
ua:navigator.userAgent.substring(0,100),
viewport:window.innerWidth+'x'+window.innerHeight,
lang:typeof LANG!=='undefined'?LANG:'?'
};
const bugs=loadBugs();
bugs.push(bug);
saveBugs(bugs);
window._bugAttachedErrors=null;
document.getElementById('bug-desc').value='';
toast?.('🐛 Bug reportado — sección: '+bug.section);
renderBugPanel();
};

// Attach captured JS errors
window._attachErrors=function(){
if(!_bugErrors.length){toast?.('No hay errores capturados',true);return;}
window._bugAttachedErrors=[..._bugErrors];
const btn=document.querySelector('[onclick="_attachErrors()"]');
if(btn){btn.style.background='rgba(76,175,80,.2)';btn.style.color='#4caf50';btn.textContent='✅ '+_bugErrors.length+' adjuntos';}
};

// Delete single bug
window._deleteBug=function(idx){
const bugs=loadBugs();
bugs.splice(idx,1);
saveBugs(bugs);
renderBugPanel();
_bugUpdateBadge();
};

// Clear all bugs
window._clearBugs=function(){
if(!confirm('¿Eliminar todos los bugs reportados?'))return;
saveBugs([]);
renderBugPanel();
};

// Export bugs as JSON
window._exportBugs=function(){
const bugs=loadBugs();
if(!bugs.length)return;
const blob=new Blob([JSON.stringify(bugs,null,2)],{type:'application/json'});
const a=document.createElement('a');
a.href=URL.createObjectURL(blob);
a.download='egglogu_bugs_'+new Date().toISOString().split('T')[0]+'.json';
a.click();
URL.revokeObjectURL(a.href);
toast?.('📋 Bugs exportados ('+bugs.length+')');
};

// Inject on DOM ready
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',injectBugWidget);
else injectBugWidget();
})();

// ============ SERVICE WORKER ============
if('serviceWorker' in navigator){
navigator.serviceWorker.register('sw.js').then(reg=>{
console.log('SW registered',reg.scope);
}).catch(e=>console.log('SW registration failed',e));
}
</script>
</body>
</html>