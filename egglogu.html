<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>EGGlogU 360 ‚Äî Gesti√≥n Av√≠cola Inteligente</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1A3C6E">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="icon" type="image/png" href="favicon.png">
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/mqtt@5.14.1/dist/mqtt.min.js"></script>
<script src="https://unpkg.com/simple-statistics@7.8.8/dist/simple-statistics.min.js"></script>
<style>
:root{--primary:#1A3C6E;--primary-light:#4A7AB5;--primary-dark:#0E2240;--secondary:#FF8F00;--accent:#2E7D32;--danger:#C62828;--danger-light:#EF5350;--warning:#F9A825;--success:#2E7D32;--bg:#F5F5F5;--card:#FFF;--text:#212121;--text-light:#757575;--sidebar-bg:#0E2240;--sidebar-width:240px;--border:#E0E0E0;--radius:8px;--primary-hover:rgba(26,60,110,.04);--primary-ring:rgba(26,60,110,.15);--primary-fill:rgba(26,60,110,.1)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.app{display:flex;min-height:100vh}
.sidebar{width:var(--sidebar-width);background:var(--sidebar-bg);color:#fff;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;transition:transform .3s}
.sidebar-logo{padding:20px;font-size:24px;font-weight:700;text-align:center;border-bottom:1px solid rgba(255,255,255,.2);letter-spacing:2px}
.sidebar-logo small{display:block;font-size:10px;font-weight:400;opacity:.7}
.sidebar nav{flex:1;padding:10px 0;overflow-y:auto}
.sidebar nav a{display:flex;align-items:center;gap:12px;padding:12px 20px;color:rgba(255,255,255,.8);text-decoration:none;transition:all .2s;cursor:pointer;font-size:14px}
.sidebar nav a:hover{background:rgba(255,255,255,.1);color:#fff}
.sidebar nav a.active{background:rgba(255,255,255,.2);color:#fff;font-weight:600;border-left:3px solid var(--secondary)}
.sidebar nav a i{font-style:normal;font-size:18px;width:24px;text-align:center}
.lang-toggle{padding:15px;display:flex;gap:8px;justify-content:center;border-top:1px solid rgba(255,255,255,.2)}
.lang-toggle button{padding:6px 16px;border:1px solid rgba(255,255,255,.5);background:transparent;color:#fff;border-radius:4px;cursor:pointer;font-size:13px}
.lang-toggle button.active{background:#fff;color:var(--sidebar-bg);font-weight:600}
.hamburger{display:none;position:fixed;top:10px;left:10px;z-index:101;background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:var(--radius);font-size:20px;cursor:pointer}
.main-content{margin-left:var(--sidebar-width);flex:1;padding:20px 30px;min-height:100vh}
.section{display:none}.section.active{display:block}
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px}
.page-header h2{font-size:24px;color:var(--primary-dark)}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-bottom:24px}
.kpi-card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);border-left:4px solid var(--primary)}
.kpi-card.warning{border-left-color:var(--warning)}.kpi-card.danger{border-left-color:var(--danger)}.kpi-card.accent{border-left-color:var(--accent)}.kpi-card.secondary{border-left-color:var(--secondary)}
.kpi-card .kpi-label{font-size:12px;color:var(--text-light);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.kpi-card .kpi-value{font-size:28px;font-weight:700}.kpi-card .kpi-sub{font-size:12px;color:var(--text-light);margin-top:4px}
.card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:20px}
.card h3{margin-bottom:16px;color:var(--primary-dark);font-size:18px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border)}
th{background:var(--bg);font-weight:600;color:var(--text-light);font-size:12px;text-transform:uppercase;letter-spacing:.5px;position:sticky;top:0}
tr:hover{background:var(--primary-hover)}
.table-wrap{overflow-x:auto;max-height:500px;overflow-y:auto}
.btn{padding:8px 20px;border:none;border-radius:var(--radius);cursor:pointer;font-size:14px;font-weight:500;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark)}
.btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{background:var(--border)}
.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#a51c1c}
.btn-warning{background:var(--warning);color:#000}.btn-sm{padding:4px 12px;font-size:12px}
.btn-group{display:flex;gap:6px;flex-wrap:wrap}
.form-group{margin-bottom:16px}
.form-group label{display:block;margin-bottom:6px;font-weight:500;font-size:14px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;font-family:inherit;transition:border-color .2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-ring)}
.form-group textarea{min-height:80px;resize:vertical}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;justify-content:center;align-items:flex-start;padding:40px 20px;overflow-y:auto}
.modal-overlay.open{display:flex}
.modal{background:var(--card);border-radius:var(--radius);width:100%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border)}
.modal-header h3{font-size:18px;color:var(--primary-dark)}
.modal-header button{background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-light);padding:0 4px}
.modal-body{padding:20px}
.modal-footer{padding:15px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}
.toast{position:fixed;bottom:20px;right:20px;background:var(--primary);color:#fff;padding:12px 24px;border-radius:var(--radius);box-shadow:0 4px 12px rgba(0,0,0,.2);transform:translateY(100px);opacity:0;transition:all .3s;z-index:300;font-size:14px}
.toast.show{transform:translateY(0);opacity:1}.toast.error{background:var(--danger)}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase}
.badge-success{background:#E8F5E9;color:#2E7D32}.badge-warning{background:#FFF8E1;color:#F57F17}.badge-danger{background:#FFEBEE;color:#C62828}.badge-info{background:#E3F2FD;color:#1565C0}.badge-secondary{background:#F5F5F5;color:#757575}
.health-score{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;font-weight:700;font-size:14px;color:#fff}
.health-score.good{background:var(--success)}.health-score.warn{background:var(--warning);color:#000}.health-score.bad{background:var(--danger)}
.tabs{display:flex;gap:0;margin-bottom:20px;border-bottom:2px solid var(--border)}
.tab{padding:10px 20px;cursor:pointer;font-size:14px;font-weight:500;color:var(--text-light);border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s}
.tab:hover{color:var(--text)}.tab.active{color:var(--primary);border-bottom-color:var(--primary);font-weight:600}
.alert-card{padding:12px 16px;border-radius:var(--radius);margin-bottom:10px;font-size:14px;display:flex;align-items:center;gap:10px}
.alert-card.alert-danger{background:#FFEBEE;border-left:4px solid var(--danger);color:var(--danger)}
.alert-card.alert-warning{background:#FFF8E1;border-left:4px solid var(--warning);color:#E65100}
.alert-card.alert-success{background:#E8F5E9;border-left:4px solid var(--success);color:var(--success)}
.alert-card.alert-info{background:#E3F2FD;border-left:4px solid var(--accent);color:var(--accent)}
.checklist-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
.checklist-item input[type=checkbox]{width:18px;height:18px;accent-color:var(--primary)}
.checklist-item.done span{text-decoration:line-through;color:var(--text-light)}
.empty-state{text-align:center;padding:40px;color:var(--text-light)}
.empty-state .empty-icon{font-size:48px;margin-bottom:12px}.empty-state p{margin-bottom:16px}
.chart-container{position:relative;height:300px;margin-bottom:20px}
.filter-bar{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.filter-bar select,.filter-bar input{padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px}
.stat-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:14px}
.stat-row:last-child{border-bottom:none}.stat-row .stat-label{color:var(--text-light)}.stat-row .stat-value{font-weight:600}
.lifecycle-bar{display:flex;border-radius:var(--radius);overflow:hidden;height:48px;margin:16px 0}
.lifecycle-stage{display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;padding:4px 8px;position:relative;cursor:pointer;transition:opacity .2s;text-align:center;line-height:1.2}
.lifecycle-stage:hover{opacity:.85}
.lifecycle-stage.current{box-shadow:inset 0 0 0 3px var(--primary-dark);z-index:1}
.lifecycle-detail{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin:16px 0}
.lifecycle-card{border-radius:var(--radius);padding:12px;text-align:center;font-size:13px}
.lifecycle-card .lc-icon{font-size:28px;margin-bottom:4px}
.lifecycle-card .lc-name{font-weight:700;margin-bottom:4px}
.lifecycle-card .lc-weeks{font-size:11px;color:var(--text-light)}
.lifecycle-card .lc-info{font-size:11px;margin-top:6px;text-align:left}
.snapshot-badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:10px;font-weight:600;margin-left:6px}
.snapshot-up{background:#E8F5E9;color:#2E7D32}.snapshot-down{background:#FFEBEE;color:#C62828}.snapshot-same{background:#F5F5F5;color:#757575}
@media(max-width:768px){
.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.hamburger{display:block}
.main-content{margin-left:0;padding:60px 15px 20px}
.kpi-grid{grid-template-columns:1fr 1fr}.form-row,.form-row-3{grid-template-columns:1fr}
.page-header{flex-direction:column;align-items:flex-start}.modal{max-width:95vw}
.lifecycle-bar{flex-wrap:wrap;height:auto}.lifecycle-stage{padding:8px}
}
@media(max-width:480px){.kpi-grid{grid-template-columns:1fr}.kpi-card .kpi-value{font-size:22px}}
.leaflet-container{height:400px;width:100%;border-radius:var(--radius);z-index:1}
.weather-widget{background:linear-gradient(135deg,#4A7AB5,#1A3C6E);color:#fff;border-radius:var(--radius);padding:20px;margin-bottom:20px}
.weather-widget .weather-main{display:flex;align-items:center;gap:16px;margin-bottom:12px}
.weather-widget .weather-temp{font-size:42px;font-weight:700}.weather-widget .weather-desc{font-size:14px;opacity:.9}
.weather-widget .weather-details{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:13px}
.weather-widget .weather-details div{background:rgba(255,255,255,.15);padding:8px;border-radius:6px;text-align:center}
.weather-forecast{display:flex;gap:8px;margin-top:12px}.weather-forecast .fc-day{flex:1;background:rgba(255,255,255,.1);border-radius:6px;padding:8px;text-align:center;font-size:12px}
.gauge-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;margin:16px 0}
.gauge{text-align:center;background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.gauge svg{width:120px;height:120px}.gauge .gauge-value{font-size:24px;font-weight:700;margin-top:8px}.gauge .gauge-label{font-size:12px;color:var(--text-light);margin-top:4px}
.stress-timeline{position:relative;padding-left:24px;margin:16px 0}
.stress-timeline::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:var(--border)}
.stress-event{position:relative;margin-bottom:16px;padding:12px;background:var(--card);border-radius:var(--radius);box-shadow:0 1px 4px rgba(0,0,0,.08)}
.stress-event::before{content:'';position:absolute;left:-20px;top:16px;width:12px;height:12px;border-radius:50%;border:2px solid var(--card)}
.stress-event.sev-1::before{background:#4CAF50}.stress-event.sev-2::before{background:#8BC34A}.stress-event.sev-3::before{background:#FFC107}
.stress-event.sev-4::before{background:#FF9800}.stress-event.sev-5::before{background:#F44336}
.mqtt-status{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 10px;border-radius:12px}
.mqtt-status.connected{background:#E8F5E9;color:#2E7D32}.mqtt-status.disconnected{background:#FFEBEE;color:#C62828}
.mqtt-status .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.mqtt-status.connected .dot{background:#2E7D32}.mqtt-status.disconnected .dot{background:#C62828}
.pred-card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.08);text-align:center}
.pred-card .pred-score{font-size:36px;font-weight:700;margin:8px 0}.pred-card .pred-label{font-size:12px;color:var(--text-light)}
.anomaly-icon{color:var(--warning);font-weight:700;cursor:help}
.nav-badge{background:var(--secondary);color:#fff;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:auto}
/* Mode toggles */
.mode-toggles{padding:8px 12px;display:flex;gap:6px}
.mode-btn{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:var(--radius);padding:6px 10px;font-size:12px;cursor:pointer;flex:1;text-align:center;transition:.2s}
.mode-btn:hover{background:rgba(255,255,255,.2)}.mode-btn.active{background:var(--secondary);border-color:var(--secondary);font-weight:600}
/* Zone risk badges */
.risk-badge{display:inline-block;padding:2px 10px;border-radius:12px;font-size:12px;font-weight:600;color:#fff}
.risk-green{background:#4CAF50}.risk-yellow{background:#FFC107;color:#333}.risk-red{background:#F44336}
/* Pest severity */
.severity-bar{width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden}.severity-bar>div{height:100%;border-radius:4px;transition:width .3s}.severity-dot{width:10px;height:10px;border-radius:50%;background:var(--border)}
.severity-dot.active{background:var(--secondary)}
/* Recommendation card */
.rec-card{background:#E3F2FD;border:1px solid #90CAF9;border-radius:var(--radius);padding:16px;margin-top:12px}
.rec-item{display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid #BBDEFB}
.rec-item:last-child{border-bottom:none}
.rec-priority{font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;white-space:nowrap}
.rec-priority.high{background:#FFCDD2;color:#C62828}.rec-priority.medium{background:#FFF9C4;color:#F57F17}.rec-priority.low{background:#C8E6C9;color:#2E7D32}
/* Traffic light */
.traffic-light{display:flex;align-items:center;gap:8px;font-size:24px}
.traffic-dot{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);opacity:.3}.traffic-dot.active{opacity:1;box-shadow:0 0 8px currentColor}
.traffic-dot.green{background:#4CAF50;border-color:#4CAF50}.traffic-dot.yellow{background:#FFC107;border-color:#FFC107}.traffic-dot.red{background:#F44336;border-color:#F44336}
/* Campo mode */
body.campo-mode .campo-hide{display:none!important}
.campo-kpi{font-size:48px;font-weight:800;text-align:center;color:var(--primary)}
.campo-btn-big{display:block;width:100%;padding:24px;font-size:24px;font-weight:700;border:none;border-radius:var(--radius);background:var(--secondary);color:#fff;cursor:pointer;margin-top:16px}
/* Dark mode */
body.dark-mode{--bg:#1E1E1E;--card:#2D2D2D;--text:#E0E0E0;--text-light:#BDBDBD;--border:#424242}
body.dark-mode .sidebar{background:#121212}
body.dark-mode .kpi-card{background:#2D2D2D;border-color:#424242}
body.dark-mode input,body.dark-mode select,body.dark-mode textarea{background:#383838;color:#E0E0E0;border-color:#555}
body.dark-mode .modal{background:#2D2D2D;color:#E0E0E0}
body.dark-mode .rec-card{background:#1A237E;border-color:#3949AB}
body.dark-mode .card{background:#2D2D2D}
/* QR display */
.qr-display{padding:12px;background:#fff;border:1px solid var(--border);border-radius:var(--radius);font-family:monospace;word-break:break-all;text-align:center;font-size:11px}
/* Font scale */
body.font-small{font-size:13px}body.font-normal{font-size:15px}body.font-large{font-size:18px}body.font-xlarge{font-size:21px}
</style>
</head>
<body>
<div class="app">
<aside class="sidebar" id="sidebar" role="navigation" aria-label="Main Navigation">
<div class="sidebar-logo" aria-label="EGGlogU 360"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" style="width:36px;height:36px;vertical-align:middle;margin-right:4px;border-radius:6px"><rect width="32" height="32" rx="6" fill="#1E3A5F"/><path d="M16,3.5 C13,3.5 9.5,8 9.5,14.5 C9.5,19.5 12,24 16,24 C20,24 22.5,19.5 22.5,14.5 C22.5,8 19,3.5 16,3.5Z" fill="#FFF"/><path d="M10.8,17 Q12,14.5 14.5,13.5 Q16,13 17,13.2 Q19,13.8 21,16 Q22,17.5 22,19.5 Q22,22 19.5,23 C17.5,24 13,23.5 11.5,21.5 Q10.5,19.5 10.8,17Z" fill="#F5A623"/><path d="M12,21 Q13,20 14,21 Q15,20 16,21 Q17,20 18,21 Q19,20 20,21 Q20.5,22 19,22.5 Q16,24 13,22.5 Q12,22 12,21Z" fill="#E8912D"/><path d="M13.5,13.8 Q13,11.5 13.2,9.5 Q13.5,7.5 15,6.8 Q16.3,6 17.5,6.8 Q18.5,7.5 18.5,9.5 Q18.5,11 17.5,13 Q17,13.5 16,13.5Z" fill="#F5A623"/><path d="M15,6.8 Q14.3,5 15.3,4.5 Q15.8,4.2 16,4.8 Q16.3,3.8 17,4.2 Q18,3.6 18.3,4.5 Q18.8,5.2 17.8,6.5 Q17,7 16,6.5Z" fill="#E74C3C"/><path d="M12.8,10 L11.2,10.7 L12.8,11.2Z" fill="#E8912D"/><path d="M13.3,11.5 Q13.8,12.5 13.4,13.2 Q13,13.3 12.8,12.8 Q12.5,12 13.3,11.5Z" fill="#E74C3C"/><circle cx="15.5" cy="9" r="1.5" fill="#FFF"/><circle cx="15.5" cy="9" r="1" fill="#2C3E50"/><circle cx="15.8" cy="8.7" r=".4" fill="#FFF"/></svg> EGGlogU <span style="color:#FF8F00;font-size:16px">360</span><small data-t="sidebar_subtitle">Gesti√≥n Av√≠cola Inteligente</small></div>
<nav id="main-nav" role="menubar" aria-label="Modules">
<a data-section="dashboard" class="active" onclick="nav('dashboard')"><i>üìä</i><span data-t="nav_dashboard">Dashboard</span></a>
<a data-section="produccion" onclick="nav('produccion')"><i>ü•ö</i><span data-t="nav_production">Producci√≥n</span></a>
<a data-section="lotes" onclick="nav('lotes')"><i>üêî</i><span data-t="nav_flocks">Lotes</span></a>
<a data-section="sanidad" onclick="nav('sanidad')"><i>üíâ</i><span data-t="nav_health">Sanidad</span></a>
<a data-section="alimento" onclick="nav('alimento')"><i>üåæ</i><span data-t="nav_feed">Alimento</span></a>
<a data-section="clientes" onclick="nav('clientes')"><i>üë•</i><span data-t="nav_clients">Clientes</span></a>
<a data-section="finanzas" onclick="nav('finanzas')"><i>üí∞</i><span data-t="nav_finances">Finanzas</span></a>
<a data-section="analisis" onclick="nav('analisis')"><i>üìà</i><span data-t="nav_analysis">An√°lisis</span></a>
<a data-section="operaciones" onclick="nav('operaciones')"><i>üìã</i><span data-t="nav_operations">Operaciones</span></a>
<a data-section="bioseguridad" onclick="nav('bioseguridad')"><i>üõ°Ô∏è</i><span data-t="nav_biosecurity">Bioseguridad</span></a>
<a data-section="trazabilidad" onclick="nav('trazabilidad')"><i>üì¶</i><span data-t="nav_traceability">Trazabilidad</span></a>
<a data-section="planificacion" onclick="nav('planificacion')"><i>üìÖ</i><span data-t="nav_planning">Planificaci√≥n</span></a>
<a data-section="ambiente" onclick="nav('ambiente')"><i>üå°Ô∏è</i><span data-t="nav_environment">Ambiente</span></a>
<a data-section="config" onclick="nav('config')"><i>‚öôÔ∏è</i><span data-t="nav_config">Config</span></a>
</nav>
<div class="mode-toggles">
<button onclick="toggleCampoMode()" id="btn-campo" class="mode-btn" aria-label="Toggle Campo Mode">üåæ <span data-t="nav_campo_mode">Modo Campo</span></button>
<button onclick="toggleVetMode()" id="btn-vet" class="mode-btn" aria-label="Toggle Vet Mode">ü©∫ <span data-t="nav_vet_mode">Modo Vet</span></button>
</div>
<div class="lang-toggle">
<button onclick="switchLang('es')" id="btn-es" class="active">ES</button>
<button onclick="switchLang('en')" id="btn-en">EN</button>
<button onclick="switchLang('pt')" id="btn-pt">PT</button>
</div>
</aside>
<main class="main-content" role="main" aria-label="Content">
<button class="hamburger" onclick="toggleSidebar()" aria-label="Toggle menu">‚ò∞</button>
<div id="sec-dashboard" class="section active"></div>
<div id="sec-produccion" class="section"></div>
<div id="sec-lotes" class="section"></div>
<div id="sec-sanidad" class="section"></div>
<div id="sec-alimento" class="section"></div>
<div id="sec-clientes" class="section"></div>
<div id="sec-finanzas" class="section"></div>
<div id="sec-analisis" class="section"></div>
<div id="sec-operaciones" class="section"></div>
<div id="sec-bioseguridad" class="section"></div>
<div id="sec-trazabilidad" class="section"></div>
<div id="sec-planificacion" class="section"></div>
<div id="sec-ambiente" class="section"></div>
<div id="sec-config" class="section"></div>
</main>
</div>
<div class="modal-overlay" id="modal-overlay" onclick="closeModal()" role="dialog" aria-modal="true" aria-labelledby="modal-title">
<div class="modal" onclick="event.stopPropagation()">
<div class="modal-header"><h3 id="modal-title"></h3><button onclick="closeModal()" aria-label="Close dialog">‚úï</button></div>
<div class="modal-body" id="modal-body"></div>
</div>
</div>
<div class="toast" id="toast"></div>
<script>
// ============ TRANSLATIONS ============
const T={es:{
save:'Guardar',cancel:'Cancelar',delete:'Eliminar',edit:'Editar',add:'Agregar',close:'Cerrar',actions:'Acciones',date:'Fecha',notes:'Notas',name:'Nombre',phone:'Tel√©fono',email:'Email',address:'Direcci√≥n',confirm_delete:'¬øEliminar este registro?',no_data:'No hay datos registrados',total:'Total',all:'Todos',loading:'Cargando',search:'Buscar',from:'Desde',to:'Hasta',status:'Estado',export_csv:'Exportar CSV',today:'Hoy',active:'Activo',inactive:'Inactivo',
nav_dashboard:'Dashboard',nav_production:'Producci√≥n',nav_flocks:'Lotes',nav_health:'Sanidad',nav_feed:'Alimento',nav_clients:'Clientes',nav_finances:'Finanzas',nav_analysis:'An√°lisis',nav_operations:'Operaciones',nav_environment:'Ambiente',nav_config:'Configuraci√≥n',
dash_title:'Panel Principal',kpi_today:'Producci√≥n Hoy',kpi_henday:'Tasa Hen-Day',kpi_fcr:'Conversi√≥n (FCR)',kpi_mortality:'Mortalidad',kpi_cost_egg:'Costo/Huevo',kpi_income_net:'Ingreso Neto',kpi_alerts:'Alertas',kpi_active_hens:'Gallinas Activas',kpi_active_flocks:'Lotes Activos',dash_alerts:'Alertas',dash_trend:'Tendencia 30 D√≠as',dash_no_alerts:'Sin alertas',dash_snapshot:'Guardar Snapshot KPI',dash_kpi_history:'Historial KPI',
alert_vaccine_overdue:'Vacuna vencida',alert_vaccine_soon:'Vacuna pr√≥xima',alert_low_feed:'Stock alimento bajo',alert_high_mortality:'Mortalidad alta',alert_active_outbreak:'Brote activo',alert_withdrawal:'Retiro activo',
flock_title:'Gesti√≥n de Lotes',flock_add:'Nuevo Lote',flock_name:'Nombre',flock_breed:'Raza',flock_count:'Cantidad Inicial',flock_birthdate:'Fecha Nacimiento',flock_purchase_date:'Fecha Compra',flock_supplier:'Proveedor',flock_cost:'Costo Total',flock_status:'Estado',flock_notes:'Notas',flock_age:'Edad',flock_health:'Salud',flock_weeks:'sem',flock_days:'d√≠as',flock_current:'Actuales',flock_status_cria:'Cr√≠a',flock_status_recria:'Recr√≠a',flock_status_produccion:'Producci√≥n',flock_status_descarte:'Descarte',flock_edit:'Editar Lote',flock_lifecycle:'Ciclo de Vida',flock_roadmap:'Roadmap',
lc_pollito:'Pollito',lc_cria:'Cr√≠a',lc_recria:'Recr√≠a',lc_prepostura:'Pre-postura',lc_pico:'Postura Pico',lc_media:'Postura Media',lc_baja:'Postura Baja',lc_descarte:'Descarte',lc_feed:'Alimento',lc_temp:'Temp',lc_weeks:'Semanas',lc_milestone:'Hitos',lc_current_stage:'Etapa Actual',
prod_title:'Registro de Producci√≥n',prod_add:'Nuevo Registro',prod_flock:'Lote',prod_eggs:'Huevos Recolectados',prod_broken:'Rotos/Defectuosos',prod_size_s:'Peque√±o (S)',prod_size_m:'Mediano (M)',prod_size_l:'Grande (L)',prod_size_xl:'Extra Grande (XL)',prod_size_jumbo:'Jumbo',prod_shell:'Color C√°scara',prod_yolk:'Calidad Yema (1-10)',prod_deaths:'Muertes',prod_death_cause:'Causa de Muerte',prod_date:'Fecha',
san_title:'Sanidad',san_vaccines:'Vacunas',san_medications:'Medicamentos',san_outbreaks:'Brotes',
vac_title:'Plan de Vacunaci√≥n',vac_add:'Registrar Vacuna',vac_vaccine:'Vacuna',vac_scheduled:'Programada',vac_applied:'Aplicada',vac_batch:'Lote Vacuna',vac_route:'V√≠a',vac_overdue:'Vencida',vac_upcoming:'Pr√≥xima',vac_applied_status:'Aplicada',vac_pending:'Pendiente',vac_generate:'Generar Calendario',vac_mark_applied:'Marcar Aplicada',
med_title:'Medicamentos',med_add:'Registrar Medicamento',med_name:'Medicamento',med_reason:'Motivo',med_start:'Inicio',med_end:'Fin',med_withdrawal:'D√≠as Retiro',med_withdrawal_end:'Fin Retiro',med_dosage:'Dosis',med_in_withdrawal:'En Retiro',
out_title:'Brotes',out_add:'Registrar Brote',out_disease:'Enfermedad',out_start:'Inicio',out_end:'Fin',out_affected:'Afectadas',out_deaths:'Muertes',out_symptoms:'S√≠ntomas',out_treatment:'Tratamiento',out_loss:'P√©rdida Econ√≥mica',out_active:'Activo',out_controlled:'Controlado',out_resolved:'Resuelto',
feed_title:'Alimentaci√≥n',feed_purchases:'Compras',feed_consumption:'Consumo',feed_stock:'Stock Actual',feed_add_purchase:'Nueva Compra',feed_add_consumption:'Registrar Consumo',feed_type:'Tipo',feed_qty:'Cantidad (kg)',feed_cost:'Costo',feed_supplier:'Proveedor',feed_flock:'Lote',feed_low_alert:'Stock bajo',
cli_title:'Clientes',cli_add:'Nuevo Cliente',cli_route:'Ruta/Zona',cli_price:'Precios Acordados',cli_total:'Total Clientes',
fin_title:'Finanzas',fin_income:'Ingresos',fin_expenses:'Gastos',fin_receivables:'Cuentas por Cobrar',fin_summary:'Resumen',fin_add_income:'Nuevo Ingreso',fin_add_expense:'Nuevo Gasto',fin_add_receivable:'Nueva Cuenta',fin_type:'Tipo',fin_qty:'Cantidad',fin_unit_price:'Precio Unit.',fin_client:'Cliente',fin_category:'Categor√≠a',fin_description:'Descripci√≥n',fin_amount:'Monto',fin_due_date:'Vencimiento',fin_paid:'Pagado',fin_total_income:'Total Ingresos',fin_total_expenses:'Total Gastos',fin_net:'Resultado Neto',fin_cost_per_egg:'Costo/Huevo',fin_break_even:'Punto Equilibrio',fin_month:'Mes',
fin_cat_feed:'Alimento',fin_cat_vaccines:'Vacunas/Med.',fin_cat_transport:'Transporte',fin_cat_labor:'Mano de Obra',fin_cat_infrastructure:'Infraestructura',fin_cat_other:'Otros',
fin_type_eggs:'Venta Huevos',fin_type_birds:'Venta Aves',fin_type_manure:'Venta Abono',fin_type_other:'Otro',
ana_title:'An√°lisis',ana_comparison:'Comparaci√≥n Lotes',ana_seasonality:'Estacionalidad',ana_profitability:'Rentabilidad',ana_benchmarks:'Benchmarks',ana_best_flock:'Mejor Lote',ana_worst_flock:'Peor Lote',ana_avg_production:'Producci√≥n Promedio',ana_trend:'Tendencia',ana_kpi_evolution:'Evoluci√≥n KPI',ana_no_snapshots:'Sin snapshots. Guarde snapshots desde el Dashboard.',
ops_title:'Operaciones',ops_checklist:'Checklist Diario',ops_logbook:'Bit√°cora',ops_personnel:'Personal',ops_task:'Tarea',ops_done:'Completado',ops_add_task:'Agregar Tarea',ops_check_date:'Fecha',ops_log_entry:'Entrada',ops_log_category:'Categor√≠a',ops_log_add:'Nueva Entrada',
ops_log_cat_general:'General',ops_log_cat_health:'Sanidad',ops_log_cat_production:'Producci√≥n',ops_log_cat_maintenance:'Mantenimiento',ops_log_cat_observation:'Observaci√≥n',
ops_per_name:'Nombre',ops_per_role:'Cargo',ops_per_salary:'Salario',ops_per_start:'Fecha Inicio',ops_per_active:'Activo',ops_per_add:'Agregar Personal',
env_title:'Condiciones Ambientales',env_add:'Nuevo Registro',env_temp:'Temperatura (¬∞C)',env_humidity:'Humedad (%)',env_light:'Horas Luz',env_ventilation:'Ventilaci√≥n',env_density:'Densidad (aves/m¬≤)',env_optimal:'Rango √ìptimo',env_temp_range:'18-24¬∞C',env_humidity_range:'40-70%',env_light_range:'14-16 hrs',env_density_range:'4-5 aves/m¬≤',
cfg_title:'Configuraci√≥n',cfg_farm:'Datos de la Granja',cfg_farm_name:'Nombre Granja',cfg_location:'Ubicaci√≥n',cfg_capacity:'Capacidad (aves)',cfg_currency:'Moneda',cfg_alerts:'Umbrales de Alertas',cfg_min_feed:'Stock M√≠n. Alimento (kg)',cfg_max_mortality:'Mortalidad M√°x. (%)',cfg_alert_days:'D√≠as Anticipaci√≥n',cfg_data:'Datos',cfg_export:'Exportar (JSON)',cfg_import:'Importar (JSON)',cfg_reset:'Borrar Todo',cfg_reset_confirm:'¬øEliminar TODOS los datos?',cfg_saved:'Guardado',cfg_exported:'Datos exportados',cfg_imported:'Datos importados',cfg_reset_done:'Datos eliminados',cfg_checklist:'Checklist Predeterminado',cfg_checklist_items:'Tareas del checklist',cfg_theme:'Tema de Color',cfg_theme_blue:'Azul Marino',cfg_theme_green:'Verde',cfg_theme_purple:'P√∫rpura',cfg_theme_black:'Negro',
sidebar_subtitle:'Sistema Av√≠cola 360¬∞',prod_shell_white:'Blanco',prod_shell_brown:'Marr√≥n',prod_shell_cream:'Crema',required:'Campo requerido',no_flocks_birthdate:'No hay lotes con fecha de nacimiento',vac_select_flocks:'Seleccione lotes para generar calendario:',feed_type_placeholder:'Postura, Iniciador, etc.',avg_per_day:'Prom/d√≠a',per_flock:'Lote',history:'Historial',env_latest_reading:'√öltima Lectura',env_ok:'OK',env_out_of_range:'Fuera de rango',data_stats:'Estad√≠sticas de Datos',final_warning:'‚ö†Ô∏è ADVERTENCIA FINAL ‚Äî Se eliminar√°n TODOS los datos',total_salaries:'Total Salarios',eggs_unit:'huevos',csv_income:'Ingreso',csv_expense:'Gasto',fcr_unit:'kg alimento/kg huevo',lc_feed_starter:'Iniciador',lc_feed_grower:'Crecimiento',lc_feed_developer:'Desarrollo',lc_feed_prelay:'Pre-postura',lc_feed_layer:'Postura',lc_feed_lowlay:'Postura baja',lc_prod_label:'Prod',lc_prod_first:'Primeros huevos',lc_mile_1:'Vacunas Marek, Newcastle+BI, Gumboro',lc_mile_2:'Newcastle refuerzo, desarrollo plumaje',lc_mile_3:'Viruela, Encefalomielitis, Coriza, Salmonella',lc_mile_4:'Newcastle+BI refuerzo, cambio dieta, 16h luz',lc_mile_5:'Pico producci√≥n sem 26-30, monitorear FCR',lc_mile_6:'Newcastle refuerzo c/8-12 sem, evaluar rentabilidad',lc_mile_7:'Evaluar descarte vs muda forzada',lc_mile_8:'Venta ave descarte, limpieza galp√≥n',vac_route_injection:'Inyecci√≥n',vac_route_ocular:'Ocular/spray',vac_route_water:'Agua',vac_route_wing:'Punci√≥n alar',snapshots:'snapshots',error_prefix:'Error',chk_collect_eggs:'Recolectar huevos',chk_feed_birds:'Alimentar aves',chk_check_water:'Verificar agua',chk_check_health:'Revisar salud',chk_cleaning:'Limpieza',chk_record_temp:'Registrar temperatura',
weather_title:'Clima',weather_temp:'Temperatura',weather_humidity:'Humedad',weather_wind:'Viento',weather_forecast:'Pron√≥stico 3 D√≠as',weather_no_key:'Configure API key de OpenWeatherMap en Configuraci√≥n',weather_heat_alert:'Alerta de Estr√©s Cal√≥rico',weather_thi:'√çndice THI',weather_feels:'Sensaci√≥n',weather_last_update:'√öltima actualizaci√≥n',weather_test:'Probar',
geo_set_location:'Ubicaci√≥n de la Granja',geo_use_gps:'Usar mi GPS',geo_click_map:'Clic en el mapa para ubicar',geo_lat:'Latitud',geo_lng:'Longitud',geo_saved:'Ubicaci√≥n guardada',
iot_title:'IoT Sensores',iot_broker:'Broker MQTT (wss://)',iot_user:'Usuario MQTT',iot_pass:'Contrase√±a MQTT',iot_topic:'Prefijo Topic',iot_connect:'Conectar',iot_disconnect:'Desconectar',iot_live:'IoT En Vivo',iot_no_config:'Configure MQTT en Configuraci√≥n',iot_save_reading:'Guardar lectura actual',iot_connected:'Conectado',iot_disconnected:'Desconectado',iot_ammonia:'Amon√≠aco',iot_light:'Luz',iot_lux:'lux',iot_ppm:'ppm',
pred_title:'Predicciones',pred_forecast:'Pron√≥stico Producci√≥n',pred_anomaly:'Anomal√≠as',pred_drop_risk:'Riesgo de Ca√≠da',pred_breed_curve:'Curva de Raza',pred_fcr_trend:'Tendencia FCR',pred_next_7d:'Pr√≥ximos 7 d√≠as',pred_improving:'Mejorando',pred_worsening:'Empeorando',pred_stable:'Estable',pred_score:'Puntuaci√≥n',pred_low:'Bajo',pred_medium:'Medio',pred_high:'Alto',pred_vs_expected:'Real vs Esperado',
stress_title:'Eventos de Estr√©s',stress_type:'Tipo',stress_severity:'Severidad',stress_heat:'Calor',stress_disease:'Enfermedad',stress_feed_change:'Cambio Alimento',stress_power:'Corte El√©ctrico',stress_predator:'Depredador',stress_other:'Otro',stress_description:'Descripci√≥n',stress_add:'Nuevo Evento',stress_impact:'Impacto en Producci√≥n',stress_auto:'(Auto-generado)',
env_ammonia:'Amon√≠aco (ppm)',env_wind:'Velocidad Viento (km/h)',env_thi:'√çndice THI',env_manual:'Entrada Manual',env_history:'Historial',env_iot:'IoT En Vivo',
pwa_install:'Instalar App',pwa_offline:'Modo Offline Disponible',
cfg_owm_key:'API Key OpenWeatherMap',cfg_mqtt:'Configuraci√≥n MQTT',cfg_geo:'Geolocalizaci√≥n',
flock_housing:'Tipo Alojamiento',flock_housing_floor:'Piso',flock_housing_cage:'Jaula',flock_housing_free:'Libre',flock_target_curve:'Curva Objetivo',flock_egg_color:'Color Huevo',
ana_predictions:'Predicciones',
per_day:'por d√≠a',actual:'Real',expected:'Esperado',not_available:'no disponible',
// Biosecurity
nav_biosecurity:'Bioseguridad',bio_title:'Bioseguridad y Control de Plagas',bio_visitors:'Visitantes',bio_zones:'Zonas',bio_pests:'Plagas',bio_protocols:'Protocolos',
bio_add_visitor:'Nuevo Visitante',bio_visitor_name:'Nombre',bio_visitor_company:'Empresa',bio_visitor_purpose:'Prop√≥sito',bio_visitor_zone:'Zona',bio_visitor_plate:'Placa Veh√≠culo',bio_visitor_disinfected:'Desinfectado',bio_visitor_from_farm:'Granja Origen',bio_visitor_from_health:'Salud Granja Origen',bio_cross_risk:'‚ö†Ô∏è Riesgo contaminaci√≥n cruzada',
bio_add_zone:'Nueva Zona',bio_zone_name:'Nombre Zona',bio_zone_risk:'Nivel Riesgo',bio_zone_last_disinfection:'√öltima Desinfecci√≥n',bio_zone_frequency:'Frecuencia (d√≠as)',bio_risk_green:'Verde',bio_risk_yellow:'Amarillo',bio_risk_red:'Rojo',
bio_add_pest:'Nuevo Avistamiento',bio_pest_type:'Tipo',bio_pest_rodent:'Roedor',bio_pest_fly:'Mosca',bio_pest_wild_bird:'Ave Silvestre',bio_pest_other:'Otro',bio_pest_location:'Ubicaci√≥n',bio_pest_severity:'Severidad',bio_pest_action:'Acci√≥n Tomada',bio_pest_resolved:'Resuelto',
bio_add_protocol:'Nuevo Protocolo',bio_protocol_name:'Nombre Protocolo',bio_protocol_frequency:'Frecuencia',bio_protocol_daily:'Diario',bio_protocol_weekly:'Semanal',bio_protocol_monthly:'Mensual',bio_protocol_last:'√öltimo Completado',bio_protocol_items:'√çtems del Protocolo',bio_protocol_complete:'Completar',bio_protocol_overdue:'Vencido',
bio_pest_score:'Puntuaci√≥n Plagas',bio_overdue_disinfection:'Desinfecci√≥n vencida',bio_unresolved_pests:'Plagas sin resolver',
alert_bio_disinfection:'Desinfecci√≥n vencida zona',alert_bio_pests:'Plagas sin resolver',alert_bio_cross:'Riesgo contaminaci√≥n cruzada',
// Traceability
nav_traceability:'Trazabilidad',trace_title:'Trazabilidad de Huevos',trace_add:'Nuevo Lote',trace_batch_id:'ID Lote',trace_rack:'Rack',trace_box_count:'Cajas',trace_eggs_per_box:'Huevos/Caja',trace_qr:'C√≥digo QR',trace_delivery:'Fecha Entrega',trace_search:'Buscar por ID/QR',trace_origin:'Origen',trace_house:'Galp√≥n',
// Planning
nav_planning:'Planificaci√≥n',plan_title:'Planificaci√≥n de Producci√≥n',plan_add:'Nuevo Plan',plan_name:'Nombre Plan',plan_target_date:'Fecha Objetivo',plan_eggs_needed:'Huevos Necesarios',plan_allocations:'Asignaci√≥n de Lotes',plan_expected:'Producci√≥n Esperada',plan_gap:'Brecha',plan_on_track:'En Meta',plan_behind:'Atr√°s',plan_ahead:'Adelante',plan_estimate:'Estimaci√≥n',plan_commitment:'Compromiso',
// Egg types + market
prod_egg_type:'Tipo Huevo',prod_type_conventional:'Convencional',prod_type_free_range:'Campo Libre',prod_type_organic:'Org√°nico',prod_type_pasture:'Pastoreo',prod_type_decorative:'Decorativo',
prod_market:'Canal de Venta',prod_market_wholesale:'Mayorista',prod_market_supermarket:'Supermercado',prod_market_restaurant:'Restaurant',prod_market_direct:'Venta Directa',prod_market_export:'Exportaci√≥n',prod_market_pasteurized:'Pasteurizado',
ana_by_segment:'Rentabilidad por Segmento',ana_by_type:'Por Tipo',ana_by_channel:'Por Canal',
// Campo & Vet modes
nav_campo_mode:'Modo Campo',nav_vet_mode:'Modo Vet',campo_today:'HOY',campo_quick_entry:'Entrada R√°pida',vet_visit:'Visita realizada',vet_vaccines:'Vacunas aplicadas',vet_pending:'Pendiente revisi√≥n',vet_select_farm:'Seleccionar Granja/Lote',
// Accessibility
cfg_font_size:'Tama√±o Texto',cfg_font_small:'Peque√±o',cfg_font_normal:'Normal',cfg_font_large:'Grande',cfg_font_xlarge:'Extra Grande',cfg_dark_mode:'Modo Oscuro',cfg_theme_dark:'Oscuro',
// ML/Intelligence
pred_outbreak_risk:'Riesgo de Brote',pred_outbreak_high:'Alto Riesgo',pred_outbreak_medium:'Riesgo Medio',pred_outbreak_low:'Bajo Riesgo',pred_outbreak_factor:'Factor',pred_outbreak_weight:'Peso',pred_outbreak_value:'Valor',pred_probability:'Probabilidad',pred_factors:'Factores',pred_recommendations:'Recomendaciones',pred_confidence:'Confianza',pred_forecast_7d:'7 d√≠as',pred_forecast_14d:'14 d√≠as',pred_ensemble:'Pron√≥stico Conjunto',pred_forecast_upper:'Banda Superior',pred_forecast_lower:'Banda Inferior',
ana_segment_profit:'Rentabilidad por Segmento',cfg_accessibility:'Accesibilidad',
rec_title:'Recomendaciones',rec_dismiss:'Descartar',rec_check_diet:'Revisar dieta / dise√±o de alimentaci√≥n / descartar enfermedad',rec_check_env:'Verificar ambiente / enfermedad / estr√©s inmediatamente',rec_below_curve:'Producci√≥n bajo est√°ndar ‚Äî revisar estr√©s, luz, alimentaci√≥n',rec_buy_feed:'Programar compra de alimento',rec_record_env:'Registrar condiciones ambientales',rec_disinfect:'Ejecutar protocolo de desinfecci√≥n zona',rec_heat_plan:'Estr√©s cal√≥rico prolongado ‚Äî activar plan de enfriamiento',rec_lab_samples:'Llevar muestras al laboratorio',rec_ventilation:'Aumentar ventilaci√≥n, verificar agua fresca'
},en:{
save:'Save',cancel:'Cancel',delete:'Delete',edit:'Edit',add:'Add',close:'Close',actions:'Actions',date:'Date',notes:'Notes',name:'Name',phone:'Phone',email:'Email',address:'Address',confirm_delete:'Delete this record?',no_data:'No data recorded',total:'Total',all:'All',loading:'Loading',search:'Search',from:'From',to:'To',status:'Status',export_csv:'Export CSV',today:'Today',active:'Active',inactive:'Inactive',
nav_dashboard:'Dashboard',nav_production:'Production',nav_flocks:'Flocks',nav_health:'Health',nav_feed:'Feed',nav_clients:'Clients',nav_finances:'Finances',nav_analysis:'Analysis',nav_operations:'Operations',nav_environment:'Environment',nav_config:'Settings',
dash_title:'Main Dashboard',kpi_today:'Production Today',kpi_henday:'Hen-Day Rate',kpi_fcr:'Feed Conversion (FCR)',kpi_mortality:'Mortality',kpi_cost_egg:'Cost/Egg',kpi_income_net:'Net Income',kpi_alerts:'Alerts',kpi_active_hens:'Active Hens',kpi_active_flocks:'Active Flocks',dash_alerts:'Alerts',dash_trend:'30 Day Trend',dash_no_alerts:'No alerts',dash_snapshot:'Save KPI Snapshot',dash_kpi_history:'KPI History',
alert_vaccine_overdue:'Vaccine overdue',alert_vaccine_soon:'Vaccine upcoming',alert_low_feed:'Feed stock low',alert_high_mortality:'High mortality',alert_active_outbreak:'Active outbreak',alert_withdrawal:'Active withdrawal',
flock_title:'Flock Management',flock_add:'New Flock',flock_name:'Name',flock_breed:'Breed',flock_count:'Initial Count',flock_birthdate:'Birth Date',flock_purchase_date:'Purchase Date',flock_supplier:'Supplier',flock_cost:'Total Cost',flock_status:'Status',flock_notes:'Notes',flock_age:'Age',flock_health:'Health',flock_weeks:'wks',flock_days:'days',flock_current:'Current',flock_status_cria:'Brooding',flock_status_recria:'Growing',flock_status_produccion:'Production',flock_status_descarte:'Culled',flock_edit:'Edit Flock',flock_lifecycle:'Lifecycle',flock_roadmap:'Roadmap',
lc_pollito:'Chick',lc_cria:'Brooding',lc_recria:'Growing',lc_prepostura:'Pre-lay',lc_pico:'Peak Lay',lc_media:'Mid Lay',lc_baja:'Low Lay',lc_descarte:'Culled',lc_feed:'Feed',lc_temp:'Temp',lc_weeks:'Weeks',lc_milestone:'Milestones',lc_current_stage:'Current Stage',
prod_title:'Production Log',prod_add:'New Record',prod_flock:'Flock',prod_eggs:'Eggs Collected',prod_broken:'Broken/Defective',prod_size_s:'Small (S)',prod_size_m:'Medium (M)',prod_size_l:'Large (L)',prod_size_xl:'Extra Large (XL)',prod_size_jumbo:'Jumbo',prod_shell:'Shell Color',prod_yolk:'Yolk Quality (1-10)',prod_deaths:'Deaths',prod_death_cause:'Cause of Death',prod_date:'Date',
san_title:'Health Management',san_vaccines:'Vaccines',san_medications:'Medications',san_outbreaks:'Outbreaks',
vac_title:'Vaccination Plan',vac_add:'Record Vaccine',vac_vaccine:'Vaccine',vac_scheduled:'Scheduled',vac_applied:'Applied',vac_batch:'Batch',vac_route:'Route',vac_overdue:'Overdue',vac_upcoming:'Upcoming',vac_applied_status:'Applied',vac_pending:'Pending',vac_generate:'Generate Calendar',vac_mark_applied:'Mark Applied',
med_title:'Medications',med_add:'Record Medication',med_name:'Medication',med_reason:'Reason',med_start:'Start',med_end:'End',med_withdrawal:'Withdrawal Days',med_withdrawal_end:'Withdrawal End',med_dosage:'Dosage',med_in_withdrawal:'In Withdrawal',
out_title:'Outbreaks',out_add:'Record Outbreak',out_disease:'Disease',out_start:'Start',out_end:'End',out_affected:'Affected',out_deaths:'Deaths',out_symptoms:'Symptoms',out_treatment:'Treatment',out_loss:'Economic Loss',out_active:'Active',out_controlled:'Controlled',out_resolved:'Resolved',
feed_title:'Feed Management',feed_purchases:'Purchases',feed_consumption:'Consumption',feed_stock:'Current Stock',feed_add_purchase:'New Purchase',feed_add_consumption:'Record Consumption',feed_type:'Type',feed_qty:'Quantity (kg)',feed_cost:'Cost',feed_supplier:'Supplier',feed_flock:'Flock',feed_low_alert:'Low stock',
cli_title:'Clients',cli_add:'New Client',cli_route:'Route/Zone',cli_price:'Agreed Prices',cli_total:'Total Clients',
fin_title:'Finances',fin_income:'Income',fin_expenses:'Expenses',fin_receivables:'Receivables',fin_summary:'Summary',fin_add_income:'New Income',fin_add_expense:'New Expense',fin_add_receivable:'New Receivable',fin_type:'Type',fin_qty:'Quantity',fin_unit_price:'Unit Price',fin_client:'Client',fin_category:'Category',fin_description:'Description',fin_amount:'Amount',fin_due_date:'Due Date',fin_paid:'Paid',fin_total_income:'Total Income',fin_total_expenses:'Total Expenses',fin_net:'Net Result',fin_cost_per_egg:'Cost/Egg',fin_break_even:'Break-even',fin_month:'Month',
fin_cat_feed:'Feed',fin_cat_vaccines:'Vaccines/Meds',fin_cat_transport:'Transport',fin_cat_labor:'Labor',fin_cat_infrastructure:'Infrastructure',fin_cat_other:'Other',
fin_type_eggs:'Egg Sales',fin_type_birds:'Bird Sales',fin_type_manure:'Manure Sales',fin_type_other:'Other',
ana_title:'Analysis',ana_comparison:'Flock Comparison',ana_seasonality:'Seasonality',ana_profitability:'Profitability',ana_benchmarks:'Benchmarks',ana_best_flock:'Best Flock',ana_worst_flock:'Worst Flock',ana_avg_production:'Avg Production',ana_trend:'Trend',ana_kpi_evolution:'KPI Evolution',ana_no_snapshots:'No snapshots. Save snapshots from Dashboard.',
ops_title:'Operations',ops_checklist:'Daily Checklist',ops_logbook:'Logbook',ops_personnel:'Personnel',ops_task:'Task',ops_done:'Completed',ops_add_task:'Add Task',ops_check_date:'Date',ops_log_entry:'Entry',ops_log_category:'Category',ops_log_add:'New Entry',
ops_log_cat_general:'General',ops_log_cat_health:'Health',ops_log_cat_production:'Production',ops_log_cat_maintenance:'Maintenance',ops_log_cat_observation:'Observation',
ops_per_name:'Name',ops_per_role:'Role',ops_per_salary:'Salary',ops_per_start:'Start Date',ops_per_active:'Active',ops_per_add:'Add Personnel',
env_title:'Environmental Conditions',env_add:'New Record',env_temp:'Temperature (¬∞C)',env_humidity:'Humidity (%)',env_light:'Light Hours',env_ventilation:'Ventilation',env_density:'Density (birds/m¬≤)',env_optimal:'Optimal Range',env_temp_range:'18-24¬∞C',env_humidity_range:'40-70%',env_light_range:'14-16 hrs',env_density_range:'4-5 birds/m¬≤',
cfg_title:'Settings',cfg_farm:'Farm Details',cfg_farm_name:'Farm Name',cfg_location:'Location',cfg_capacity:'Capacity (birds)',cfg_currency:'Currency',cfg_alerts:'Alert Thresholds',cfg_min_feed:'Min Feed Stock (kg)',cfg_max_mortality:'Max Mortality (%)',cfg_alert_days:'Alert Days Ahead',cfg_data:'Data',cfg_export:'Export (JSON)',cfg_import:'Import (JSON)',cfg_reset:'Delete All',cfg_reset_confirm:'Delete ALL data permanently?',cfg_saved:'Saved',cfg_exported:'Data exported',cfg_imported:'Data imported',cfg_reset_done:'Data deleted',cfg_checklist:'Default Checklist',cfg_checklist_items:'Daily checklist tasks',cfg_theme:'Color Theme',cfg_theme_blue:'Navy Blue',cfg_theme_green:'Green',cfg_theme_purple:'Purple',cfg_theme_black:'Black',
sidebar_subtitle:'Poultry System 360¬∞',prod_shell_white:'White',prod_shell_brown:'Brown',prod_shell_cream:'Cream',required:'Required field',no_flocks_birthdate:'No flocks with birth date',vac_select_flocks:'Select flocks to generate calendar:',feed_type_placeholder:'Layer, Starter, etc.',avg_per_day:'Avg/day',per_flock:'Flock',history:'History',env_latest_reading:'Latest Reading',env_ok:'OK',env_out_of_range:'Out of range',data_stats:'Data Statistics',final_warning:'‚ö†Ô∏è FINAL WARNING ‚Äî ALL data will be deleted',total_salaries:'Total Salaries',eggs_unit:'eggs',csv_income:'Income',csv_expense:'Expense',fcr_unit:'kg feed/kg egg',lc_feed_starter:'Starter',lc_feed_grower:'Grower',lc_feed_developer:'Developer',lc_feed_prelay:'Pre-lay',lc_feed_layer:'Layer',lc_feed_lowlay:'Low-lay',lc_prod_label:'Prod',lc_prod_first:'First eggs',lc_mile_1:'Marek, Newcastle+IB, Gumboro vaccines',lc_mile_2:'Newcastle booster, feather development',lc_mile_3:'Fowl Pox, AE, Coryza, Salmonella',lc_mile_4:'Newcastle+IB booster, diet change, 16h light',lc_mile_5:'Peak production wk 26-30, monitor FCR',lc_mile_6:'Newcastle booster every 8-12 wk, evaluate profitability',lc_mile_7:'Evaluate culling vs forced molting',lc_mile_8:'Sell culled birds, clean house',vac_route_injection:'Injection',vac_route_ocular:'Ocular/spray',vac_route_water:'Water',vac_route_wing:'Wing web',snapshots:'snapshots',error_prefix:'Error',chk_collect_eggs:'Collect eggs',chk_feed_birds:'Feed birds',chk_check_water:'Check water',chk_check_health:'Check health',chk_cleaning:'Cleaning',chk_record_temp:'Record temperature',
weather_title:'Weather',weather_temp:'Temperature',weather_humidity:'Humidity',weather_wind:'Wind',weather_forecast:'3-Day Forecast',weather_no_key:'Configure OpenWeatherMap API key in Settings',weather_heat_alert:'Heat Stress Alert',weather_thi:'THI Index',weather_feels:'Feels like',weather_last_update:'Last updated',weather_test:'Test',
geo_set_location:'Farm Location',geo_use_gps:'Use my GPS',geo_click_map:'Click map to set location',geo_lat:'Latitude',geo_lng:'Longitude',geo_saved:'Location saved',
iot_title:'IoT Sensors',iot_broker:'MQTT Broker (wss://)',iot_user:'MQTT User',iot_pass:'MQTT Password',iot_topic:'Topic Prefix',iot_connect:'Connect',iot_disconnect:'Disconnect',iot_live:'IoT Live',iot_no_config:'Configure MQTT in Settings',iot_save_reading:'Save current reading',iot_connected:'Connected',iot_disconnected:'Disconnected',iot_ammonia:'Ammonia',iot_light:'Light',iot_lux:'lux',iot_ppm:'ppm',
pred_title:'Predictions',pred_forecast:'Production Forecast',pred_anomaly:'Anomalies',pred_drop_risk:'Drop Risk',pred_breed_curve:'Breed Curve',pred_fcr_trend:'FCR Trend',pred_next_7d:'Next 7 days',pred_improving:'Improving',pred_worsening:'Worsening',pred_stable:'Stable',pred_score:'Score',pred_low:'Low',pred_medium:'Medium',pred_high:'High',pred_vs_expected:'Actual vs Expected',
stress_title:'Stress Events',stress_type:'Type',stress_severity:'Severity',stress_heat:'Heat',stress_disease:'Disease',stress_feed_change:'Feed Change',stress_power:'Power Outage',stress_predator:'Predator',stress_other:'Other',stress_description:'Description',stress_add:'New Event',stress_impact:'Production Impact',stress_auto:'(Auto-generated)',
env_ammonia:'Ammonia (ppm)',env_wind:'Wind Speed (km/h)',env_thi:'THI Index',env_manual:'Manual Entry',env_history:'History',env_iot:'IoT Live',
pwa_install:'Install App',pwa_offline:'Offline Mode Available',
cfg_owm_key:'OpenWeatherMap API Key',cfg_mqtt:'MQTT Settings',cfg_geo:'Geolocation',
flock_housing:'Housing Type',flock_housing_floor:'Floor',flock_housing_cage:'Cage',flock_housing_free:'Free-range',flock_target_curve:'Target Curve',flock_egg_color:'Egg Color',
ana_predictions:'Predictions',
per_day:'per day',actual:'Actual',expected:'Expected',not_available:'not available',
nav_biosecurity:'Biosecurity',bio_title:'Biosecurity & Pest Control',bio_visitors:'Visitors',bio_zones:'Zones',bio_pests:'Pests',bio_protocols:'Protocols',
bio_add_visitor:'New Visitor',bio_visitor_name:'Name',bio_visitor_company:'Company',bio_visitor_purpose:'Purpose',bio_visitor_zone:'Zone',bio_visitor_plate:'Vehicle Plate',bio_visitor_disinfected:'Disinfected',bio_visitor_from_farm:'Origin Farm',bio_visitor_from_health:'Origin Farm Health',bio_cross_risk:'‚ö†Ô∏è Cross-contamination risk',
bio_add_zone:'New Zone',bio_zone_name:'Zone Name',bio_zone_risk:'Risk Level',bio_zone_last_disinfection:'Last Disinfection',bio_zone_frequency:'Frequency (days)',bio_risk_green:'Green',bio_risk_yellow:'Yellow',bio_risk_red:'Red',
bio_add_pest:'New Sighting',bio_pest_type:'Type',bio_pest_rodent:'Rodent',bio_pest_fly:'Fly',bio_pest_wild_bird:'Wild Bird',bio_pest_other:'Other',bio_pest_location:'Location',bio_pest_severity:'Severity',bio_pest_action:'Action Taken',bio_pest_resolved:'Resolved',
bio_add_protocol:'New Protocol',bio_protocol_name:'Protocol Name',bio_protocol_frequency:'Frequency',bio_protocol_daily:'Daily',bio_protocol_weekly:'Weekly',bio_protocol_monthly:'Monthly',bio_protocol_last:'Last Completed',bio_protocol_items:'Protocol Items',bio_protocol_complete:'Complete',bio_protocol_overdue:'Overdue',
bio_pest_score:'Pest Score',bio_overdue_disinfection:'Overdue disinfection',bio_unresolved_pests:'Unresolved pests',
alert_bio_disinfection:'Zone disinfection overdue',alert_bio_pests:'Unresolved pests',alert_bio_cross:'Cross-contamination risk',
nav_traceability:'Traceability',trace_title:'Egg Traceability',trace_add:'New Batch',trace_batch_id:'Batch ID',trace_rack:'Rack',trace_box_count:'Boxes',trace_eggs_per_box:'Eggs/Box',trace_qr:'QR Code',trace_delivery:'Delivery Date',trace_search:'Search by ID/QR',trace_origin:'Origin',trace_house:'House',
nav_planning:'Planning',plan_title:'Production Planning',plan_add:'New Plan',plan_name:'Plan Name',plan_target_date:'Target Date',plan_eggs_needed:'Eggs Needed',plan_allocations:'Flock Allocations',plan_expected:'Expected Production',plan_gap:'Gap',plan_on_track:'On Track',plan_behind:'Behind',plan_ahead:'Ahead',plan_estimate:'Estimate',plan_commitment:'Commitment',
prod_egg_type:'Egg Type',prod_type_conventional:'Conventional',prod_type_free_range:'Free Range',prod_type_organic:'Organic',prod_type_pasture:'Pasture Raised',prod_type_decorative:'Decorative',
prod_market:'Market Channel',prod_market_wholesale:'Wholesale',prod_market_supermarket:'Supermarket',prod_market_restaurant:'Restaurant',prod_market_direct:'Direct Sale',prod_market_export:'Export',prod_market_pasteurized:'Pasteurized',
ana_by_segment:'Profitability by Segment',ana_by_type:'By Type',ana_by_channel:'By Channel',
nav_campo_mode:'Campo Mode',nav_vet_mode:'Vet Mode',campo_today:'TODAY',campo_quick_entry:'Quick Entry',vet_visit:'Visit completed',vet_vaccines:'Vaccines applied',vet_pending:'Pending review',vet_select_farm:'Select Farm/Flock',
cfg_font_size:'Text Size',cfg_font_small:'Small',cfg_font_normal:'Normal',cfg_font_large:'Large',cfg_font_xlarge:'Extra Large',cfg_dark_mode:'Dark Mode',cfg_theme_dark:'Dark',
pred_outbreak_risk:'Outbreak Risk',pred_outbreak_high:'High Risk',pred_outbreak_medium:'Medium Risk',pred_outbreak_low:'Low Risk',pred_outbreak_factor:'Factor',pred_outbreak_weight:'Weight',pred_outbreak_value:'Value',pred_probability:'Probability',pred_factors:'Factors',pred_recommendations:'Recommendations',pred_confidence:'Confidence',pred_forecast_7d:'7 days',pred_forecast_14d:'14 days',pred_ensemble:'Ensemble Forecast',pred_forecast_upper:'Upper Band',pred_forecast_lower:'Lower Band',
ana_segment_profit:'Profitability by Segment',cfg_accessibility:'Accessibility',
rec_title:'Recommendations',rec_dismiss:'Dismiss',rec_check_diet:'Check diet / feed design / rule out disease',rec_check_env:'Check environment / disease / stress immediately',rec_below_curve:'Below standard production ‚Äî check stress, light, feed',rec_buy_feed:'Schedule feed purchase',rec_record_env:'Record environmental conditions',rec_disinfect:'Execute disinfection protocol zone',rec_heat_plan:'Prolonged heat stress ‚Äî activate cooling plan',rec_lab_samples:'Take samples to laboratory',rec_ventilation:'Increase ventilation, check fresh water'
},pt:{
save:'Salvar',cancel:'Cancelar',delete:'Excluir',edit:'Editar',add:'Adicionar',close:'Fechar',actions:'A√ß√µes',date:'Data',notes:'Observa√ß√µes',name:'Nome',phone:'Telefone',email:'Email',address:'Endere√ßo',confirm_delete:'Excluir este registro?',no_data:'Nenhum dado registrado',total:'Total',all:'Todos',loading:'Carregando',search:'Buscar',from:'De',to:'At√©',status:'Status',export_csv:'Exportar CSV',today:'Hoje',active:'Ativo',inactive:'Inativo',
nav_dashboard:'Dashboard',nav_production:'Produ√ß√£o',nav_flocks:'Lotes',nav_health:'Sanidade',nav_feed:'Alimenta√ß√£o',nav_clients:'Clientes',nav_finances:'Finan√ßas',nav_analysis:'An√°lise',nav_operations:'Opera√ß√µes',nav_environment:'Ambiente',nav_config:'Configura√ß√£o',
dash_title:'Painel Principal',kpi_today:'Produ√ß√£o Hoje',kpi_henday:'Taxa Hen-Day',kpi_fcr:'Convers√£o (FCR)',kpi_mortality:'Mortalidade',kpi_cost_egg:'Custo/Ovo',kpi_income_net:'Receita L√≠quida',kpi_alerts:'Alertas',kpi_active_hens:'Galinhas Ativas',kpi_active_flocks:'Lotes Ativos',dash_alerts:'Alertas',dash_trend:'Tend√™ncia 30 Dias',dash_no_alerts:'Sem alertas',dash_snapshot:'Salvar Snapshot KPI',dash_kpi_history:'Hist√≥rico KPI',
alert_vaccine_overdue:'Vacina vencida',alert_vaccine_soon:'Vacina pr√≥xima',alert_low_feed:'Estoque de ra√ß√£o baixo',alert_high_mortality:'Mortalidade alta',alert_active_outbreak:'Surto ativo',alert_withdrawal:'Car√™ncia ativa',
flock_title:'Gest√£o de Lotes',flock_add:'Novo Lote',flock_name:'Nome',flock_breed:'Ra√ßa',flock_count:'Quantidade Inicial',flock_birthdate:'Data de Nascimento',flock_purchase_date:'Data de Compra',flock_supplier:'Fornecedor',flock_cost:'Custo Total',flock_status:'Status',flock_notes:'Observa√ß√µes',flock_age:'Idade',flock_health:'Sa√∫de',flock_weeks:'sem',flock_days:'dias',flock_current:'Atuais',flock_status_cria:'Cria',flock_status_recria:'Recria',flock_status_produccion:'Produ√ß√£o',flock_status_descarte:'Descarte',flock_edit:'Editar Lote',flock_lifecycle:'Ciclo de Vida',flock_roadmap:'Roadmap',
lc_pollito:'Pintinho',lc_cria:'Cria',lc_recria:'Recria',lc_prepostura:'Pr√©-postura',lc_pico:'Postura Pico',lc_media:'Postura M√©dia',lc_baja:'Postura Baixa',lc_descarte:'Descarte',lc_feed:'Ra√ß√£o',lc_temp:'Temp',lc_weeks:'Semanas',lc_milestone:'Marcos',lc_current_stage:'Etapa Atual',
prod_title:'Registro de Produ√ß√£o',prod_add:'Novo Registro',prod_flock:'Lote',prod_eggs:'Ovos Coletados',prod_broken:'Quebrados/Defeituosos',prod_size_s:'Pequeno (S)',prod_size_m:'M√©dio (M)',prod_size_l:'Grande (L)',prod_size_xl:'Extra Grande (XL)',prod_size_jumbo:'Jumbo',prod_shell:'Cor da Casca',prod_yolk:'Qualidade Gema (1-10)',prod_deaths:'Mortes',prod_death_cause:'Causa da Morte',prod_date:'Data',
san_title:'Sanidade',san_vaccines:'Vacinas',san_medications:'Medicamentos',san_outbreaks:'Surtos',
vac_title:'Plano de Vacina√ß√£o',vac_add:'Registrar Vacina',vac_vaccine:'Vacina',vac_scheduled:'Programada',vac_applied:'Aplicada',vac_batch:'Lote Vacina',vac_route:'Via',vac_overdue:'Vencida',vac_upcoming:'Pr√≥xima',vac_applied_status:'Aplicada',vac_pending:'Pendente',vac_generate:'Gerar Calend√°rio',vac_mark_applied:'Marcar Aplicada',
med_title:'Medicamentos',med_add:'Registrar Medicamento',med_name:'Medicamento',med_reason:'Motivo',med_start:'In√≠cio',med_end:'Fim',med_withdrawal:'Dias de Car√™ncia',med_withdrawal_end:'Fim da Car√™ncia',med_dosage:'Dosagem',med_in_withdrawal:'Em Car√™ncia',
out_title:'Surtos',out_add:'Registrar Surto',out_disease:'Doen√ßa',out_start:'In√≠cio',out_end:'Fim',out_affected:'Afetadas',out_deaths:'Mortes',out_symptoms:'Sintomas',out_treatment:'Tratamento',out_loss:'Perda Econ√¥mica',out_active:'Ativo',out_controlled:'Controlado',out_resolved:'Resolvido',
feed_title:'Alimenta√ß√£o',feed_purchases:'Compras',feed_consumption:'Consumo',feed_stock:'Estoque Atual',feed_add_purchase:'Nova Compra',feed_add_consumption:'Registrar Consumo',feed_type:'Tipo',feed_qty:'Quantidade (kg)',feed_cost:'Custo',feed_supplier:'Fornecedor',feed_flock:'Lote',feed_low_alert:'Estoque baixo',
cli_title:'Clientes',cli_add:'Novo Cliente',cli_route:'Rota/Zona',cli_price:'Pre√ßos Acordados',cli_total:'Total de Clientes',
fin_title:'Finan√ßas',fin_income:'Receitas',fin_expenses:'Despesas',fin_receivables:'Contas a Receber',fin_summary:'Resumo',fin_add_income:'Nova Receita',fin_add_expense:'Nova Despesa',fin_add_receivable:'Nova Conta',fin_type:'Tipo',fin_qty:'Quantidade',fin_unit_price:'Pre√ßo Unit.',fin_client:'Cliente',fin_category:'Categoria',fin_description:'Descri√ß√£o',fin_amount:'Valor',fin_due_date:'Vencimento',fin_paid:'Pago',fin_total_income:'Total Receitas',fin_total_expenses:'Total Despesas',fin_net:'Resultado L√≠quido',fin_cost_per_egg:'Custo/Ovo',fin_break_even:'Ponto de Equil√≠brio',fin_month:'M√™s',
fin_cat_feed:'Ra√ß√£o',fin_cat_vaccines:'Vacinas/Med.',fin_cat_transport:'Transporte',fin_cat_labor:'M√£o de Obra',fin_cat_infrastructure:'Infraestrutura',fin_cat_other:'Outros',
fin_type_eggs:'Venda de Ovos',fin_type_birds:'Venda de Aves',fin_type_manure:'Venda de Adubo',fin_type_other:'Outro',
ana_title:'An√°lise',ana_comparison:'Compara√ß√£o de Lotes',ana_seasonality:'Sazonalidade',ana_profitability:'Rentabilidade',ana_benchmarks:'Benchmarks',ana_best_flock:'Melhor Lote',ana_worst_flock:'Pior Lote',ana_avg_production:'Produ√ß√£o M√©dia',ana_trend:'Tend√™ncia',ana_kpi_evolution:'Evolu√ß√£o KPI',ana_no_snapshots:'Sem snapshots. Salve snapshots pelo Dashboard.',
ops_title:'Opera√ß√µes',ops_checklist:'Checklist Di√°rio',ops_logbook:'Di√°rio de Bordo',ops_personnel:'Pessoal',ops_task:'Tarefa',ops_done:'Conclu√≠do',ops_add_task:'Adicionar Tarefa',ops_check_date:'Data',ops_log_entry:'Entrada',ops_log_category:'Categoria',ops_log_add:'Nova Entrada',
ops_log_cat_general:'Geral',ops_log_cat_health:'Sanidade',ops_log_cat_production:'Produ√ß√£o',ops_log_cat_maintenance:'Manuten√ß√£o',ops_log_cat_observation:'Observa√ß√£o',
ops_per_name:'Nome',ops_per_role:'Cargo',ops_per_salary:'Sal√°rio',ops_per_start:'Data de In√≠cio',ops_per_active:'Ativo',ops_per_add:'Adicionar Pessoal',
env_title:'Condi√ß√µes Ambientais',env_add:'Novo Registro',env_temp:'Temperatura (¬∞C)',env_humidity:'Umidade (%)',env_light:'Horas de Luz',env_ventilation:'Ventila√ß√£o',env_density:'Densidade (aves/m¬≤)',env_optimal:'Faixa Ideal',env_temp_range:'18-24¬∞C',env_humidity_range:'40-70%',env_light_range:'14-16 hrs',env_density_range:'4-5 aves/m¬≤',
cfg_title:'Configura√ß√£o',cfg_farm:'Dados da Granja',cfg_farm_name:'Nome da Granja',cfg_location:'Localiza√ß√£o',cfg_capacity:'Capacidade (aves)',cfg_currency:'Moeda',cfg_alerts:'Limites de Alertas',cfg_min_feed:'Estoque M√≠n. Ra√ß√£o (kg)',cfg_max_mortality:'Mortalidade M√°x. (%)',cfg_alert_days:'Dias de Anteced√™ncia',cfg_data:'Dados',cfg_export:'Exportar (JSON)',cfg_import:'Importar (JSON)',cfg_reset:'Excluir Tudo',cfg_reset_confirm:'Excluir TODOS os dados permanentemente?',cfg_saved:'Salvo',cfg_exported:'Dados exportados',cfg_imported:'Dados importados',cfg_reset_done:'Dados exclu√≠dos',cfg_checklist:'Checklist Padr√£o',cfg_checklist_items:'Tarefas do checklist di√°rio',cfg_theme:'Tema de Cor',cfg_theme_blue:'Azul Marinho',cfg_theme_green:'Verde',cfg_theme_purple:'Roxo',cfg_theme_black:'Preto',
sidebar_subtitle:'Sistema Av√≠cola 360¬∞',prod_shell_white:'Branco',prod_shell_brown:'Marrom',prod_shell_cream:'Creme',required:'Campo obrigat√≥rio',no_flocks_birthdate:'Nenhum lote com data de nascimento',vac_select_flocks:'Selecione lotes para gerar calend√°rio:',feed_type_placeholder:'Postura, Inicial, etc.',avg_per_day:'M√©d/dia',per_flock:'Lote',history:'Hist√≥rico',env_latest_reading:'√öltima Leitura',env_ok:'OK',env_out_of_range:'Fora da faixa',data_stats:'Estat√≠sticas de Dados',final_warning:'‚ö†Ô∏è AVISO FINAL ‚Äî TODOS os dados ser√£o exclu√≠dos',total_salaries:'Total Sal√°rios',eggs_unit:'ovos',csv_income:'Receita',csv_expense:'Despesa',fcr_unit:'kg ra√ß√£o/kg ovo',lc_feed_starter:'Inicial',lc_feed_grower:'Crescimento',lc_feed_developer:'Desenvolvimento',lc_feed_prelay:'Pr√©-postura',lc_feed_layer:'Postura',lc_feed_lowlay:'Postura baixa',lc_prod_label:'Prod',lc_prod_first:'Primeiros ovos',lc_mile_1:'Vacinas Marek, Newcastle+BI, Gumboro',lc_mile_2:'Newcastle refor√ßo, desenvolvimento plumagem',lc_mile_3:'Var√≠ola, Encefalomielite, Coriza, Salmonela',lc_mile_4:'Newcastle+BI refor√ßo, mudan√ßa dieta, 16h luz',lc_mile_5:'Pico produ√ß√£o sem 26-30, monitorar FCR',lc_mile_6:'Newcastle refor√ßo a cada 8-12 sem, avaliar rentabilidade',lc_mile_7:'Avaliar descarte vs muda for√ßada',lc_mile_8:'Venda ave descarte, limpeza galp√£o',vac_route_injection:'Inje√ß√£o',vac_route_ocular:'Ocular/spray',vac_route_water:'√Ågua',vac_route_wing:'Pun√ß√£o alar',snapshots:'snapshots',error_prefix:'Erro',chk_collect_eggs:'Coletar ovos',chk_feed_birds:'Alimentar aves',chk_check_water:'Verificar √°gua',chk_check_health:'Verificar sa√∫de',chk_cleaning:'Limpeza',chk_record_temp:'Registrar temperatura',
weather_title:'Clima',weather_temp:'Temperatura',weather_humidity:'Umidade',weather_wind:'Vento',weather_forecast:'Previs√£o 3 Dias',weather_no_key:'Configure a chave API OpenWeatherMap em Configura√ß√£o',weather_heat_alert:'Alerta de Estresse T√©rmico',weather_thi:'√çndice THI',weather_feels:'Sensa√ß√£o',weather_last_update:'√öltima atualiza√ß√£o',weather_test:'Testar',
geo_set_location:'Localiza√ß√£o da Granja',geo_use_gps:'Usar meu GPS',geo_click_map:'Clique no mapa para localizar',geo_lat:'Latitude',geo_lng:'Longitude',geo_saved:'Localiza√ß√£o salva',
iot_title:'IoT Sensores',iot_broker:'Broker MQTT (wss://)',iot_user:'Usu√°rio MQTT',iot_pass:'Senha MQTT',iot_topic:'Prefixo T√≥pico',iot_connect:'Conectar',iot_disconnect:'Desconectar',iot_live:'IoT Ao Vivo',iot_no_config:'Configure MQTT em Configura√ß√£o',iot_save_reading:'Salvar leitura atual',iot_connected:'Conectado',iot_disconnected:'Desconectado',iot_ammonia:'Am√¥nia',iot_light:'Luz',iot_lux:'lux',iot_ppm:'ppm',
pred_title:'Predi√ß√µes',pred_forecast:'Previs√£o de Produ√ß√£o',pred_anomaly:'Anomalias',pred_drop_risk:'Risco de Queda',pred_breed_curve:'Curva da Ra√ßa',pred_fcr_trend:'Tend√™ncia FCR',pred_next_7d:'Pr√≥ximos 7 dias',pred_improving:'Melhorando',pred_worsening:'Piorando',pred_stable:'Est√°vel',pred_score:'Pontua√ß√£o',pred_low:'Baixo',pred_medium:'M√©dio',pred_high:'Alto',pred_vs_expected:'Real vs Esperado',
stress_title:'Eventos de Estresse',stress_type:'Tipo',stress_severity:'Severidade',stress_heat:'Calor',stress_disease:'Doen√ßa',stress_feed_change:'Mudan√ßa de Ra√ß√£o',stress_power:'Queda de Energia',stress_predator:'Predador',stress_other:'Outro',stress_description:'Descri√ß√£o',stress_add:'Novo Evento',stress_impact:'Impacto na Produ√ß√£o',stress_auto:'(Auto-gerado)',
env_ammonia:'Am√¥nia (ppm)',env_wind:'Velocidade do Vento (km/h)',env_thi:'√çndice THI',env_manual:'Entrada Manual',env_history:'Hist√≥rico',env_iot:'IoT Ao Vivo',
pwa_install:'Instalar App',pwa_offline:'Modo Offline Dispon√≠vel',
cfg_owm_key:'Chave API OpenWeatherMap',cfg_mqtt:'Configura√ß√£o MQTT',cfg_geo:'Geolocaliza√ß√£o',
flock_housing:'Tipo de Alojamento',flock_housing_floor:'Piso',flock_housing_cage:'Gaiola',flock_housing_free:'Livre',flock_target_curve:'Curva Alvo',flock_egg_color:'Cor do Ovo',
ana_predictions:'Predi√ß√µes',
per_day:'por dia',actual:'Real',expected:'Esperado',not_available:'n√£o dispon√≠vel',
nav_biosecurity:'Biosseguran√ßa',bio_title:'Biosseguran√ßa e Controle de Pragas',bio_visitors:'Visitantes',bio_zones:'Zonas',bio_pests:'Pragas',bio_protocols:'Protocolos',
bio_add_visitor:'Novo Visitante',bio_visitor_name:'Nome',bio_visitor_company:'Empresa',bio_visitor_purpose:'Prop√≥sito',bio_visitor_zone:'Zona',bio_visitor_plate:'Placa Ve√≠culo',bio_visitor_disinfected:'Desinfetado',bio_visitor_from_farm:'Granja de Origem',bio_visitor_from_health:'Sa√∫de Granja Origem',bio_cross_risk:'‚ö†Ô∏è Risco de contamina√ß√£o cruzada',
bio_add_zone:'Nova Zona',bio_zone_name:'Nome da Zona',bio_zone_risk:'N√≠vel de Risco',bio_zone_last_disinfection:'√öltima Desinfec√ß√£o',bio_zone_frequency:'Frequ√™ncia (dias)',bio_risk_green:'Verde',bio_risk_yellow:'Amarelo',bio_risk_red:'Vermelho',
bio_add_pest:'Novo Avistamento',bio_pest_type:'Tipo',bio_pest_rodent:'Roedor',bio_pest_fly:'Mosca',bio_pest_wild_bird:'Ave Silvestre',bio_pest_other:'Outro',bio_pest_location:'Localiza√ß√£o',bio_pest_severity:'Severidade',bio_pest_action:'A√ß√£o Tomada',bio_pest_resolved:'Resolvido',
bio_add_protocol:'Novo Protocolo',bio_protocol_name:'Nome do Protocolo',bio_protocol_frequency:'Frequ√™ncia',bio_protocol_daily:'Di√°rio',bio_protocol_weekly:'Semanal',bio_protocol_monthly:'Mensal',bio_protocol_last:'√öltimo Completado',bio_protocol_items:'Itens do Protocolo',bio_protocol_complete:'Completar',bio_protocol_overdue:'Vencido',
bio_pest_score:'Pontua√ß√£o de Pragas',bio_overdue_disinfection:'Desinfec√ß√£o vencida',bio_unresolved_pests:'Pragas n√£o resolvidas',
alert_bio_disinfection:'Desinfec√ß√£o de zona vencida',alert_bio_pests:'Pragas n√£o resolvidas',alert_bio_cross:'Risco de contamina√ß√£o cruzada',
nav_traceability:'Rastreabilidade',trace_title:'Rastreabilidade de Ovos',trace_add:'Novo Lote',trace_batch_id:'ID do Lote',trace_rack:'Rack',trace_box_count:'Caixas',trace_eggs_per_box:'Ovos/Caixa',trace_qr:'C√≥digo QR',trace_delivery:'Data de Entrega',trace_search:'Buscar por ID/QR',trace_origin:'Origem',trace_house:'Galp√£o',
nav_planning:'Planejamento',plan_title:'Planejamento de Produ√ß√£o',plan_add:'Novo Plano',plan_name:'Nome do Plano',plan_target_date:'Data Alvo',plan_eggs_needed:'Ovos Necess√°rios',plan_allocations:'Aloca√ß√£o de Lotes',plan_expected:'Produ√ß√£o Esperada',plan_gap:'Diferen√ßa',plan_on_track:'No Alvo',plan_behind:'Atrasado',plan_ahead:'Adiantado',plan_estimate:'Estimativa',plan_commitment:'Compromisso',
prod_egg_type:'Tipo de Ovo',prod_type_conventional:'Convencional',prod_type_free_range:'Caipira',prod_type_organic:'Org√¢nico',prod_type_pasture:'Pastoreio',prod_type_decorative:'Decorativo',
prod_market:'Canal de Venda',prod_market_wholesale:'Atacado',prod_market_supermarket:'Supermercado',prod_market_restaurant:'Restaurante',prod_market_direct:'Venda Direta',prod_market_export:'Exporta√ß√£o',prod_market_pasteurized:'Pasteurizado',
ana_by_segment:'Rentabilidade por Segmento',ana_by_type:'Por Tipo',ana_by_channel:'Por Canal',
nav_campo_mode:'Modo Campo',nav_vet_mode:'Modo Vet',campo_today:'HOJE',campo_quick_entry:'Entrada R√°pida',vet_visit:'Visita realizada',vet_vaccines:'Vacinas aplicadas',vet_pending:'Pendente revis√£o',vet_select_farm:'Selecionar Granja/Lote',
cfg_font_size:'Tamanho do Texto',cfg_font_small:'Pequeno',cfg_font_normal:'Normal',cfg_font_large:'Grande',cfg_font_xlarge:'Extra Grande',cfg_dark_mode:'Modo Escuro',cfg_theme_dark:'Escuro',
pred_outbreak_risk:'Risco de Surto',pred_outbreak_high:'Alto Risco',pred_outbreak_medium:'Risco M√©dio',pred_outbreak_low:'Baixo Risco',pred_outbreak_factor:'Fator',pred_outbreak_weight:'Peso',pred_outbreak_value:'Valor',pred_probability:'Probabilidade',pred_factors:'Fatores',pred_recommendations:'Recomenda√ß√µes',pred_confidence:'Confian√ßa',pred_forecast_7d:'7 dias',pred_forecast_14d:'14 dias',pred_ensemble:'Previs√£o Conjunta',pred_forecast_upper:'Banda Superior',pred_forecast_lower:'Banda Inferior',
ana_segment_profit:'Rentabilidade por Segmento',cfg_accessibility:'Acessibilidade',
rec_title:'Recomenda√ß√µes',rec_dismiss:'Descartar',rec_check_diet:'Verificar dieta / formula√ß√£o de ra√ß√£o / descartar doen√ßa',rec_check_env:'Verificar ambiente / doen√ßa / estresse imediatamente',rec_below_curve:'Produ√ß√£o abaixo do padr√£o ‚Äî verificar estresse, luz, alimenta√ß√£o',rec_buy_feed:'Programar compra de ra√ß√£o',rec_record_env:'Registrar condi√ß√µes ambientais',rec_disinfect:'Executar protocolo de desinfec√ß√£o zona',rec_heat_plan:'Estresse t√©rmico prolongado ‚Äî ativar plano de resfriamento',rec_lab_samples:'Levar amostras ao laborat√≥rio',rec_ventilation:'Aumentar ventila√ß√£o, verificar √°gua fresca'
}};

// ============ LIFECYCLE ROADMAP ============
const LIFECYCLE=[
{stage:'pollito',key:'lc_pollito',weekStart:0,weekEnd:4,color:'#FFF9C4',icon:'üê£',feed:'lc_feed_starter',temp:'32-35¬∞C',prod:'-',milestones:'lc_mile_1'},
{stage:'cria',key:'lc_cria',weekStart:4,weekEnd:8,color:'#FFECB3',icon:'üê§',feed:'lc_feed_grower',temp:'28-32¬∞C',prod:'-',milestones:'lc_mile_2'},
{stage:'recria',key:'lc_recria',weekStart:8,weekEnd:18,color:'#C8E6C9',icon:'üêî',feed:'lc_feed_developer',temp:'22-28¬∞C',prod:'-',milestones:'lc_mile_3'},
{stage:'pre_postura',key:'lc_prepostura',weekStart:18,weekEnd:20,color:'#B3E5FC',icon:'üêî',feed:'lc_feed_prelay',temp:'20-24¬∞C',prod:'lc_prod_first',milestones:'lc_mile_4'},
{stage:'postura_pico',key:'lc_pico',weekStart:20,weekEnd:42,color:'#A5D6A7',icon:'ü•ö',feed:'lc_feed_layer',temp:'18-24¬∞C',prod:'90-95%',milestones:'lc_mile_5'},
{stage:'postura_media',key:'lc_media',weekStart:42,weekEnd:62,color:'#FFCC80',icon:'ü•ö',feed:'lc_feed_layer',temp:'18-24¬∞C',prod:'80-90%',milestones:'lc_mile_6'},
{stage:'postura_baja',key:'lc_baja',weekStart:62,weekEnd:80,color:'#FFAB91',icon:'ü•ö',feed:'lc_feed_lowlay',temp:'18-24¬∞C',prod:'<80%',milestones:'lc_mile_7'},
{stage:'descarte',key:'lc_descarte',weekStart:80,weekEnd:999,color:'#BDBDBD',icon:'üì¶',feed:'-',temp:'-',prod:'-',milestones:'lc_mile_8'}
];

// ============ THEMES ============
const THEMES={
blue:{primary:'#1A3C6E','primary-light':'#4A7AB5','primary-dark':'#0E2240','sidebar-bg':'#0E2240',rgb:'26,60,110'},
green:{primary:'#2E7D32','primary-light':'#4CAF50','primary-dark':'#1B5E20','sidebar-bg':'#1B5E20',rgb:'46,125,50'},
purple:{primary:'#6A1B9A','primary-light':'#AB47BC','primary-dark':'#4A148C','sidebar-bg':'#4A148C',rgb:'106,27,154'},
black:{primary:'#37474F','primary-light':'#607D8B','primary-dark':'#263238','sidebar-bg':'#263238',rgb:'55,71,79'},
dark:{primary:'#90CAF9','primary-light':'#42A5F5','primary-dark':'#1E1E1E','sidebar-bg':'#121212',rgb:'144,202,249'}
};
function applyTheme(name){
const th=THEMES[name]||THEMES.blue;const s=document.documentElement.style;
s.setProperty('--primary',th.primary);s.setProperty('--primary-light',th['primary-light']);
s.setProperty('--primary-dark',th['primary-dark']);s.setProperty('--sidebar-bg',th['sidebar-bg']);
s.setProperty('--primary-hover','rgba('+th.rgb+',.04)');s.setProperty('--primary-ring','rgba('+th.rgb+',.15)');
s.setProperty('--primary-fill','rgba('+th.rgb+',.1)');localStorage.setItem('egglogu_theme',name);
Object.keys(CHARTS).forEach(k=>{if(CHARTS[k]){try{CHARTS[k].destroy();}catch(e){}}});CHARTS={};
}
function themeColor(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
function themeRgba(a){const th=THEMES[localStorage.getItem('egglogu_theme')||'blue']||THEMES.blue;return'rgba('+th.rgb+','+a+')';}

// ============ CORE ============
let LANG=localStorage.getItem('egglogu_lang')||'es';
let DATA=null;let CHARTS={};let currentSection='dashboard';
let currentSanidadTab='vaccines';let currentFinanceTab='income';let currentOpsTab='checklist';
const $=id=>document.getElementById(id);
function t(k){return(T[LANG]&&T[LANG][k])||(T.es&&T.es[k])||k;}
function fmtNum(n,d=0){const loc=LANG==='es'?'es-CL':LANG==='pt'?'pt-BR':'en-US';return Number(n||0).toLocaleString(loc,{minimumFractionDigits:d,maximumFractionDigits:d});}
function fmtMoney(n){return currency()+fmtNum(n,0);}
function fmtDate(d){if(!d)return'-';const loc=LANG==='es'?'es-CL':LANG==='pt'?'pt-BR':'en-US';return new Date(d+'T12:00:00').toLocaleDateString(loc);}
function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5);}
function currency(){return(DATA||loadData()).farm.currency||'$';}
function todayStr(){return new Date().toISOString().substring(0,10);}

// ============ DATA MODEL ============
const DEFAULT_DATA={
farm:{name:'Mi Granja',location:'',capacity:500,currency:'$',lat:null,lng:null,owmApiKey:'',mqttBroker:'',mqttUser:'',mqttPass:'',mqttTopicPrefix:'egglogu/',houses:[],routes:[],suppliers:[]},
flocks:[],dailyProduction:[],vaccines:[],medications:[],outbreaks:[],
feed:{purchases:[],consumption:[]},clients:[],
finances:{income:[],expenses:[],receivables:[]},
environment:[],checklist:[],logbook:[],personnel:[],
kpiSnapshots:[],weatherCache:[],stressEvents:[],iotReadings:[],predictions:[],
biosecurity:{visitors:[],zones:[],pestSightings:[],protocols:[]},
traceability:{batches:[]},
productionPlans:[],
settings:{minFeedStock:50,maxMortality:5,alertDaysBefore:3,campoMode:false,vetMode:false,fontScale:'normal',darkMode:false,
defaultChecklist:['chk_collect_eggs','chk_feed_birds','chk_check_water','chk_check_health','chk_cleaning','chk_record_temp']}
};
// ============ COMMERCIAL BREEDS DATABASE ============
const COMMERCIAL_BREEDS=[
{id:'leghorn-blanca',name:'Leghorn Blanca',eggsYear:'280‚Äì320',eggColor:'blanco',eggWeight:'55‚Äì60g',type:'hibrida',fcr:'2.0‚Äì2.1',notes:'M√°s usada mundialmente, excelente FCR'},
{id:'isa-brown',name:'ISA Brown',eggsYear:'300‚Äì320',eggColor:'marr√≥n',eggWeight:'60‚Äì65g',type:'hibrida',fcr:'2.0‚Äì2.2',notes:'H√≠brida l√≠der global, muy d√≥cil'},
{id:'hyline-w36',name:'Hy-Line W-36',eggsYear:'300‚Äì320',eggColor:'blanco',eggWeight:'63g',type:'hibrida',fcr:'2.0‚Äì2.1',notes:'Excelente en climas c√°lidos'},
{id:'hyline-w80',name:'Hy-Line W-80',eggsYear:'290‚Äì310',eggColor:'blanco',eggWeight:'60g',type:'hibrida',fcr:'2.1‚Äì2.2',notes:'Huevo mediano, alta persistencia'},
{id:'lohmann-brown',name:'Lohmann Brown',eggsYear:'290‚Äì310',eggColor:'marr√≥n',eggWeight:'62‚Äì65g',type:'hibrida',fcr:'2.1‚Äì2.2',notes:'Muy popular en LATAM/Europa'},
{id:'hisex-brown',name:'Hisex Brown',eggsYear:'300‚Äì320',eggColor:'marr√≥n',eggWeight:'62g',type:'hibrida',fcr:'2.0‚Äì2.2',notes:'Similar a ISA, muy productiva'},
{id:'golden-comet',name:'Golden Comet',eggsYear:'280‚Äì300',eggColor:'marr√≥n',eggWeight:'60g',type:'hibrida',fcr:'2.1‚Äì2.3',notes:'H√≠brida de r√°pida producci√≥n'},
{id:'shaver-white',name:'Shaver White',eggsYear:'280‚Äì300',eggColor:'blanco',eggWeight:'60g',type:'hibrida',fcr:'2.1‚Äì2.2',notes:'Blanca eficiente, buena en calor'},
{id:'rhode-island-red',name:'Rhode Island Red',eggsYear:'250‚Äì300',eggColor:'marr√≥n',eggWeight:'60g',type:'pura',fcr:'2.3‚Äì2.5',notes:'Robusta, doble prop√≥sito'},
{id:'australorp',name:'Australorp',eggsYear:'250‚Äì280',eggColor:'marr√≥n',eggWeight:'60g',type:'pura',fcr:'2.3‚Äì2.5',notes:'Resistente, r√©cord hist√≥rico 364 huevos/a√±o'},
{id:'sussex',name:'Sussex',eggsYear:'250‚Äì280',eggColor:'crema',eggWeight:'58g',type:'pura',fcr:'2.4‚Äì2.6',notes:'Buena conversi√≥n, adaptable'},
{id:'plymouth-rock',name:'Plymouth Rock',eggsYear:'200‚Äì250',eggColor:'marr√≥n',eggWeight:'55g',type:'pura',fcr:'2.5‚Äì2.7',notes:'Familiar, huevos constantes'},
{id:'ameraucana',name:'Ameraucana',eggsYear:'200‚Äì250',eggColor:'azul',eggWeight:'55g',type:'pura',fcr:'2.5‚Äì2.7',notes:'Huevo azul, nicho premium'},
{id:'araucana',name:'Araucana',eggsYear:'180‚Äì220',eggColor:'azul-verde',eggWeight:'52g',type:'pura',fcr:'2.6‚Äì2.8',notes:'Originaria de Chile, huevo verde-azulado'},
{id:'marans',name:'Marans',eggsYear:'180‚Äì220',eggColor:'chocolate',eggWeight:'65g',type:'pura',fcr:'2.5‚Äì2.7',notes:'Huevo color chocolate oscuro, nicho gourmet'},
{id:'otra',name:'Otra / Personalizada',eggsYear:'-',eggColor:'-',eggWeight:'-',type:'-',fcr:'-',notes:'Raza no listada, usa curva gen√©rica'}
];
// ============ BREED PRODUCTION CURVES (weekly Hen-Day % from week 18 to 80) ============
const BREED_CURVES={
'leghorn-blanca':[10,36,66,86,94,96,97,97,96,96,95,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43],
'isa-brown':[9,32,62,83,92,94,95,95,94,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43],
'hyline-w36':[10,35,65,85,93,95,96,96,95,95,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42],
'hyline-w80':[9,33,63,84,92,94,95,95,94,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43],
'lohmann-brown':[8,30,60,82,91,94,95,95,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42],
'hisex-brown':[9,31,61,83,92,94,95,95,94,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43],
'golden-comet':[9,30,58,80,90,93,94,94,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41],
'shaver-white':[9,33,63,84,92,94,94,94,93,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42],
'rhode-island-red':[6,22,48,72,84,88,90,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37],
'australorp':[5,20,45,68,82,86,88,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35],
'sussex':[5,18,42,65,80,84,86,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33],
'plymouth-rock':[4,15,38,60,74,78,80,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27],
'ameraucana':[4,14,36,58,72,76,78,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25],
'araucana':[3,12,32,54,68,72,74,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,21],
'marans':[3,12,32,52,66,70,72,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40,39,38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,22,21,20,19],
'otra':[8,28,55,78,88,92,93,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40],
'generic':[8,28,55,78,88,92,93,93,92,91,90,89,88,87,86,85,84,83,82,81,80,79,78,77,76,75,74,73,72,71,70,69,68,67,66,65,64,63,62,61,60,59,58,57,56,55,54,53,52,51,50,49,48,47,46,45,44,43,42,41,40]
};
// ============ CATALOGS ‚Äî "Selecciona, no escribas" ============
const CATALOGS={
feedTypes:[
{id:'inicio',name:'Inicio (0-6 sem)',protein:'20-22%',stage:'cria'},
{id:'crecimiento',name:'Crecimiento (6-12 sem)',protein:'18-19%',stage:'recria'},
{id:'desarrollo',name:'Desarrollo (12-16 sem)',protein:'15-16%',stage:'recria'},
{id:'pre-postura',name:'Pre-postura (16-18 sem)',protein:'17-18%',stage:'recria'},
{id:'postura-1',name:'Postura Fase 1 (18-45 sem)',protein:'17-18%',stage:'produccion'},
{id:'postura-2',name:'Postura Fase 2 (45-65 sem)',protein:'16-17%',stage:'produccion'},
{id:'postura-3',name:'Postura Fase 3 (65+ sem)',protein:'15-16%',stage:'produccion'},
],
deathCauses:['Enfermedad','Depredador','Golpe de calor','Asfixia','Canibalismo','Prolapso','Edad/Natural','Accidente','Desconocida'],
diseases:['Newcastle','Gumboro (IBD)','Bronquitis Infecciosa','Coccidiosis','Marek','Salmonelosis','Coriza Infecciosa','Viruela Aviar','Influenza Aviar','Micoplasmosis','Laringotraque√≠tis','Colibacilosis','Aspergilosis','Histomoniasis'],
medications:[
{name:'Enrofloxacina',type:'antibiotico',withdrawal:7},
{name:'Amoxicilina',type:'antibiotico',withdrawal:5},
{name:'Toltrazuril',type:'anticoccidial',withdrawal:14},
{name:'Ivermectina',type:'antiparasitario',withdrawal:14},
{name:'Tilosina',type:'antibiotico',withdrawal:5},
{name:'Oxitetraciclina',type:'antibiotico',withdrawal:7},
{name:'Vitamina AD3E',type:'suplemento',withdrawal:0},
{name:'Electrolitos',type:'suplemento',withdrawal:0},
],
personnelRoles:['Administrador','T√©cnico Av√≠cola','Galponero','Recolector','Veterinario','Chofer/Repartidor','Limpieza','Mantenimiento'],
visitorPurposes:['Entrega de alimento','Servicio t√©cnico','Inspecci√≥n sanitaria','Retiro de huevos','Visita veterinaria','Mantenimiento','Otro'],
ventilationLevels:['Natural','Baja','Media','Alta','T√∫nel'],
bioProtocols:['Desinfecci√≥n de galp√≥n','Pediluvio','Control de roedores','Fumigaci√≥n','Limpieza de bebederos','Limpieza de comederos','Desratizaci√≥n','Vac√≠o sanitario'],
expenseDescriptions:{
feed:['Alimento postura','Alimento cr√≠a','Suplementos','Aditivos'],
vaccines:['Vacuna Newcastle','Vacuna Gumboro','Vacuna Marek','Otra vacuna'],
transport:['Distribuci√≥n huevos','Retiro alimento','Traslado aves'],
labor:['Sueldos','Horas extra','Bonos'],
infrastructure:['Reparaci√≥n galp√≥n','Equipamiento','Nidales','Bebederos'],
other:['Servicios b√°sicos','Asesor√≠a','Varios'],
},
};
// ============ CATALOG HELPERS ============
function supplierSelect(sel){const D=loadData();const sups=D.farm.suppliers||[];let h='<option value="">--</option>';sups.forEach(s=>{h+=`<option value="${s.name}"${s.name===sel?' selected':''}>${s.name}</option>`;});h+='<option value="__new__">+ Nuevo proveedor</option>';return h;}
function houseSelect(sel){const D=loadData();const houses=D.farm.houses||[];let h='<option value="">--</option>';houses.forEach(ho=>{h+=`<option value="${ho.name}"${ho.name===sel?' selected':''}>${ho.name}</option>`;});return h;}
function rackSelect(houseName,sel){const D=loadData();const houses=D.farm.houses||[];const house=houses.find(h=>h.name===houseName);let h='<option value="">--</option>';if(house&&house.racks){house.racks.forEach(r=>{h+=`<option value="${r.name}"${r.name===sel?' selected':''}>${r.name}</option>`;});}return h;}
function routeSelect(sel){const D=loadData();const routes=D.farm.routes||[];let h='<option value="">--</option>';routes.forEach(r=>{h+=`<option value="${r.name}"${r.name===sel?' selected':''}>${r.name}</option>`;});return h;}
function catalogSelect(items,sel,addOther=true){let h='<option value="">--</option>';items.forEach(item=>{const v=typeof item==='string'?item:item.name||item.id;const lbl=typeof item==='string'?item:item.name;h+=`<option value="${v}"${v===sel?' selected':''}>${lbl}</option>`;});if(addOther)h+='<option value="__other__">Otra...</option>';return h;}
function feedTypeSelect(sel,flockId){const D=loadData();let suggested='';if(flockId){const f=D.flocks.find(x=>x.id===flockId);if(f){const stage=flockLifecycleStage(f);if(stage)suggested=stage.id;}}let h='<option value="">--</option>';CATALOGS.feedTypes.forEach(ft=>{const isSuggested=ft.stage===suggested;h+=`<option value="${ft.id}"${ft.id===sel?' selected':''}>${ft.name}${isSuggested?' ‚òÖ':''}</option>`;});h+='<option value="__other__">Otro...</option>';return h;}
function onMedSelect(){const sel=$('m-name');if(!sel)return;const med=CATALOGS.medications.find(m=>m.name===sel.value);const wd=$('m-wd');if(med&&wd&&!wd.value)wd.value=med.withdrawal;}
function onExpenseCatChange(){const cat=$('fe-cat')?.value;const descEl=$('fe-desc');if(!descEl||!cat)return;const opts=CATALOGS.expenseDescriptions[cat]||[];descEl.innerHTML=catalogSelect(opts,descEl.value,true);}
function onHouseChange(){const house=$('tb-house')?.value;const rackEl=$('tb-rack');if(!rackEl)return;rackEl.innerHTML=rackSelect(house,rackEl.value);}
function onProdFlockChange(){const fid=$('p-flock')?.value;const shellEl=$('p-shell');if(!fid||!shellEl)return;const D=loadData();const f=D.flocks.find(x=>x.id===fid);if(f){const b=COMMERCIAL_BREEDS.find(x=>x.id===f.breed);if(b&&b.eggColor){const colorMap={'Blanco':'blanco','Marr√≥n':'marron','Marr√≥n oscuro':'marron','Crema':'crema','Azul/Verde':'crema','Verde oliva':'crema'};shellEl.value=colorMap[b.eggColor]||'';}}}
function loadData(){
if(DATA)return DATA;
try{const r=localStorage.getItem('egglogu_data');
if(r){DATA=JSON.parse(r);
for(const k of Object.keys(DEFAULT_DATA)){if(!(k in DATA))DATA[k]=JSON.parse(JSON.stringify(DEFAULT_DATA[k]));}
if(!DATA.feed.purchases)DATA.feed.purchases=[];if(!DATA.feed.consumption)DATA.feed.consumption=[];
if(!DATA.finances.receivables)DATA.finances.receivables=[];
['medications','outbreaks','clients','checklist','logbook','personnel','kpiSnapshots','weatherCache','stressEvents','iotReadings','predictions'].forEach(k=>{if(!DATA[k])DATA[k]=[];});
// v2 farm field migrations
if(DATA.farm.lat===undefined)DATA.farm.lat=null;
if(DATA.farm.lng===undefined)DATA.farm.lng=null;
if(!DATA.farm.owmApiKey)DATA.farm.owmApiKey='';
if(!DATA.farm.mqttBroker)DATA.farm.mqttBroker='';
if(!DATA.farm.mqttUser)DATA.farm.mqttUser='';
if(!DATA.farm.mqttPass)DATA.farm.mqttPass='';
if(!DATA.farm.mqttTopicPrefix)DATA.farm.mqttTopicPrefix='egglogu/';
// v4 migrations ‚Äî farm config expansion
if(!DATA.farm.houses)DATA.farm.houses=[];
if(!DATA.farm.routes)DATA.farm.routes=[];
if(!DATA.farm.suppliers)DATA.farm.suppliers=[];
// v3 migrations
if(!DATA.biosecurity)DATA.biosecurity={visitors:[],zones:[],pestSightings:[],protocols:[]};
if(!DATA.biosecurity.visitors)DATA.biosecurity.visitors=[];
if(!DATA.biosecurity.zones)DATA.biosecurity.zones=[];
if(!DATA.biosecurity.pestSightings)DATA.biosecurity.pestSightings=[];
if(!DATA.biosecurity.protocols)DATA.biosecurity.protocols=[];
if(!DATA.traceability)DATA.traceability={batches:[]};
if(!DATA.traceability.batches)DATA.traceability.batches=[];
if(!DATA.productionPlans)DATA.productionPlans=[];
if(DATA.settings.campoMode===undefined)DATA.settings.campoMode=false;
if(DATA.settings.vetMode===undefined)DATA.settings.vetMode=false;
if(!DATA.settings.fontScale)DATA.settings.fontScale='normal';
if(DATA.settings.darkMode===undefined)DATA.settings.darkMode=false;
}else{DATA=JSON.parse(JSON.stringify(DEFAULT_DATA));}
}catch(e){DATA=JSON.parse(JSON.stringify(DEFAULT_DATA));}
return DATA;
}
function saveData(d){DATA=d||DATA;localStorage.setItem('egglogu_data',JSON.stringify(DATA));}

function activeHens(){const D=loadData();let n=0;D.flocks.forEach(f=>{if(f.status!=='descarte')n+=activeHensByFlock(f.id);});return n;}
function activeHensByFlock(fid){
const D=loadData();const f=D.flocks.find(x=>x.id===fid);if(!f)return 0;
const deaths=D.dailyProduction.filter(p=>p.flockId===fid).reduce((s,p)=>s+(p.deaths||0),0);
const oD=D.outbreaks.filter(o=>o.flockId===fid).reduce((s,o)=>s+(o.deaths||0),0);
return Math.max(0,(f.count||0)-deaths-oD);
}
function flockAge(f){if(!f.birthDate)return{days:0,weeks:0};const d=Math.floor((new Date()-new Date(f.birthDate+'T12:00:00'))/864e5);return{days:Math.max(0,d),weeks:Math.max(0,Math.floor(d/7))};}
function flockLifecycleStage(f){const w=flockAge(f).weeks;return LIFECYCLE.find(l=>w>=l.weekStart&&w<l.weekEnd)||LIFECYCLE[LIFECYCLE.length-1];}
function healthScore(fid){
const D=loadData();const f=D.flocks.find(x=>x.id===fid);if(!f)return 0;
const td=D.dailyProduction.filter(p=>p.flockId===fid).reduce((s,p)=>s+(p.deaths||0),0);
const mPct=f.count>0?(td/f.count)*100:0;const mS=Math.max(0,100-mPct*10);
const l7=D.dailyProduction.filter(p=>p.flockId===fid).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const hens=activeHensByFlock(fid);let pS=50;
if(l7.length>0&&hens>0){const avg=l7.reduce((s,p)=>s+(p.eggsCollected||0),0)/l7.length;pS=Math.min(100,(avg/hens)*125);}
let fS=80;const l7f=D.feed.consumption.filter(c=>c.flockId===fid).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
if(l7f.length>0&&l7.length>0&&hens>0){const aF=l7f.reduce((s,c)=>s+(c.quantityKg||0),0)/l7f.length;const aE=(l7.reduce((s,p)=>s+(p.eggsCollected||0),0)/l7.length*0.06);const fcr=aE>0?aF/aE:99;fS=fcr<2?100:fcr<2.5?80:fcr<3?60:fcr<4?40:20;}
const ao=D.outbreaks.filter(o=>o.flockId===fid&&o.status==='active').length;const oS=ao===0?100:ao===1?40:0;
return Math.round(mS*0.3+pS*0.3+fS*0.2+oS*0.2);
}
function healthBadge(s){return `<span class="health-score ${s>=70?'good':s>=40?'warn':'bad'}">${s}</span>`;}
function statusBadge(st){
const m={cria:'info',recria:'warning',produccion:'success',descarte:'secondary',active:'danger',controlled:'warning',resolved:'success',pending:'warning',applied:'success',overdue:'danger'};
const lb={cria:t('flock_status_cria'),recria:t('flock_status_recria'),produccion:t('flock_status_produccion'),descarte:t('flock_status_descarte'),active:t('out_active'),controlled:t('out_controlled'),resolved:t('out_resolved'),pending:t('vac_pending'),applied:t('vac_applied_status'),overdue:t('vac_overdue')};
return `<span class="badge badge-${m[st]||'secondary'}">${lb[st]||st}</span>`;
}

// ============ KPI SNAPSHOT SYSTEM ============
function computeKpiSnapshot(){
const D=loadData();const hens=activeHens();const today=todayStr();
const tp=D.dailyProduction.filter(p=>p.date===today);
const eggsToday=tp.reduce((s,p)=>s+(p.eggsCollected||0),0);
const henDay=hens>0?((eggsToday/hens)*100):0;
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const p30=D.dailyProduction.filter(p=>p.date>=d30s);const te30=p30.reduce((s,p)=>s+(p.eggsCollected||0),0);
const teKg=te30*0.06;const f30=D.feed.consumption.filter(c=>c.date>=d30s);const tfKg=f30.reduce((s,c)=>s+(c.quantityKg||0),0);
const fcr=teKg>0?(tfKg/teKg):0;
const tDeaths=D.dailyProduction.reduce((s,p)=>s+(p.deaths||0),0);const tInit=D.flocks.reduce((s,f)=>s+(f.count||0),0);
const mort=tInit>0?((tDeaths/tInit)*100):0;
const tExp=D.finances.expenses.reduce((s,e)=>s+(e.amount||0),0);const tEggs=D.dailyProduction.reduce((s,p)=>s+(p.eggsCollected||0),0);
const cpe=tEggs>0?tExp/tEggs:0;
const mo=today.substring(0,7);
const mInc=D.finances.income.filter(i=>i.date&&i.date.startsWith(mo)).reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
const mExp=D.finances.expenses.filter(e=>e.date&&e.date.startsWith(mo)).reduce((s,e)=>s+(e.amount||0),0);
const stock=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0)-D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0);
return{date:today,activeHens:hens,eggsToday,henDay:Math.round(henDay*10)/10,fcr:Math.round(fcr*100)/100,
mortality:Math.round(mort*10)/10,costPerEgg:Math.round(cpe*100)/100,netIncome:mInc-mExp,feedStock:Math.round(stock*10)/10,
totalFlocks:D.flocks.filter(f=>f.status!=='descarte').length,activeOutbreaks:D.outbreaks.filter(o=>o.status==='active').length};
}
function saveKpiSnapshot(){
const D=loadData();const snap={id:genId(),...computeKpiSnapshot()};
D.kpiSnapshots.push(snap);saveData(D);toast(t('cfg_saved'));renderDashboard();
}
function snapshotDelta(current,previous){
if(!previous)return'';const diff=current-previous;
if(Math.abs(diff)<0.01)return `<span class="snapshot-badge snapshot-same">= </span>`;
return diff>0?`<span class="snapshot-badge snapshot-up">‚ñ≤ ${fmtNum(diff,1)}</span>`:`<span class="snapshot-badge snapshot-down">‚ñº ${fmtNum(Math.abs(diff),1)}</span>`;
}

// ============ VACCINE SCHEDULE ============
const VACCINE_SCHEDULE=[
{name:'Marek',ageDays:1,route:'vac_route_injection'},{name:'Newcastle + Bronquitis Infecciosa',ageDays:6,route:'vac_route_ocular'},
{name:'Gumboro (IBD)',ageDays:14,route:'vac_route_water'},{name:'Newcastle refuerzo',ageDays:21,route:'vac_route_water'},
{name:'Viruela Aviar',ageDays:49,route:'vac_route_wing'},{name:'Encefalomielitis Aviar',ageDays:63,route:'vac_route_water'},
{name:'Coriza Infecciosa',ageDays:77,route:'vac_route_injection'},{name:'Salmonella',ageDays:91,route:'vac_route_injection'},
{name:'Newcastle + BI pre-postura',ageDays:112,route:'vac_route_injection'}
];
function generateVaccineCalendar(flock){
const D=loadData();if(!flock.birthDate)return;const birth=new Date(flock.birthDate+'T12:00:00');
VACCINE_SCHEDULE.forEach(vs=>{const sd=new Date(birth.getTime()+vs.ageDays*864e5);
if(!D.vaccines.find(v=>v.flockId===flock.id&&v.vaccineName===vs.name)){
D.vaccines.push({id:genId(),flockId:flock.id,vaccineName:vs.name,scheduledDate:sd.toISOString().substring(0,10),appliedDate:'',batchNumber:'',route:vs.route,notes:'',status:'pending'});}});
saveData(D);
}

// ============ UI HELPERS ============
function nav(section){
currentSection=section;document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
$('sec-'+section).classList.add('active');
document.querySelectorAll('#main-nav a').forEach(a=>a.classList.toggle('active',a.dataset.section===section));
$('sidebar').classList.remove('open');
const R={dashboard:renderDashboard,produccion:renderProduction,lotes:renderFlocks,sanidad:renderSanidad,alimento:renderFeed,clientes:renderClients,finanzas:renderFinances,analisis:renderAnalysis,operaciones:renderOperations,bioseguridad:renderBiosecurity,trazabilidad:renderTraceability,planificacion:renderPlanning,ambiente:renderEnvironment,config:renderConfig};
if(R[section])R[section]();
}
function toggleSidebar(){$('sidebar').classList.toggle('open');}
function openModal(title,body){$('modal-title').textContent=title;$('modal-body').innerHTML=body;$('modal-overlay').classList.add('open');}
function closeModal(){$('modal-overlay').classList.remove('open');}
function toast(msg,err=false){const e=$('toast');e.textContent=msg;e.className='toast show'+(err?' error':'');setTimeout(()=>e.className='toast',3000);}
function emptyState(icon,msg,btn,act){let h=`<div class="empty-state"><div class="empty-icon">${icon}</div><p>${msg}</p>`;if(btn)h+=`<button class="btn btn-primary" onclick="${act}">${btn}</button>`;return h+'</div>';}
function switchLang(l){LANG=l;localStorage.setItem('egglogu_lang',l);$('btn-es').classList.toggle('active',l==='es');$('btn-en').classList.toggle('active',l==='en');$('btn-pt').classList.toggle('active',l==='pt');document.querySelectorAll('[data-t]').forEach(el=>el.textContent=t(el.dataset.t));nav(currentSection);}
function flockSelect(sel,all=false){const D=loadData();let h=all?`<option value="">${t('all')}</option>`:'<option value="">--</option>';D.flocks.forEach(f=>{h+=`<option value="${f.id}"${f.id===sel?' selected':''}>${f.name}</option>`;});return h;}
function clientSelect(sel){const D=loadData();let h='<option value="">--</option>';D.clients.forEach(c=>{h+=`<option value="${c.id}"${c.id===sel?' selected':''}>${c.name}</option>`;});return h;}
function destroyCharts(){Object.values(CHARTS).forEach(c=>{try{c.destroy();}catch(e){}});CHARTS={};}

// ============ ALERTS ============
function getAlerts(D){
const alerts=[];const today=todayStr();const ad=D.settings.alertDaysBefore||3;
const soon=new Date();soon.setDate(soon.getDate()+ad);const soonStr=soon.toISOString().substring(0,10);
D.vaccines.filter(v=>v.status!=='applied').forEach(v=>{
const f=D.flocks.find(x=>x.id===v.flockId);const fn=f?f.name:'';
if(v.scheduledDate<today)alerts.push({type:'danger',icon:'üíâ',msg:`${t('alert_vaccine_overdue')}: ${v.vaccineName} - ${fn}`});
else if(v.scheduledDate<=soonStr)alerts.push({type:'warning',icon:'üíâ',msg:`${t('alert_vaccine_soon')}: ${v.vaccineName} - ${fn} (${fmtDate(v.scheduledDate)})`});
});
const stock=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0)-D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0);
if(stock<(D.settings.minFeedStock||50))alerts.push({type:'warning',icon:'üåæ',msg:`${t('alert_low_feed')}: ${fmtNum(stock,1)} kg`});
const tD=D.dailyProduction.reduce((s,p)=>s+(p.deaths||0),0);const tI=D.flocks.reduce((s,f)=>s+(f.count||0),0);
if(tI>0&&(tD/tI)*100>(D.settings.maxMortality||5))alerts.push({type:'danger',icon:'‚ö†Ô∏è',msg:`${t('alert_high_mortality')}: ${fmtNum((tD/tI)*100,1)}%`});
D.outbreaks.filter(o=>o.status==='active').forEach(o=>{const f=D.flocks.find(x=>x.id===o.flockId);alerts.push({type:'danger',icon:'ü¶†',msg:`${t('alert_active_outbreak')}: ${o.disease} - ${f?f.name:''}`});});
D.medications.forEach(m=>{if(m.withdrawalEnd&&m.withdrawalEnd>=today){const f=D.flocks.find(x=>x.id===m.flockId);alerts.push({type:'warning',icon:'‚è≥',msg:`${t('alert_withdrawal')}: ${m.name} - ${f?f.name:''} (${fmtDate(m.withdrawalEnd)})`});}});
// Biosecurity alerts
if(D.biosecurity){
D.biosecurity.zones.forEach(z=>{if(z.lastDisinfection&&z.frequencyDays){
const next=new Date(z.lastDisinfection+'T12:00:00');next.setDate(next.getDate()+z.frequencyDays);
if(next.toISOString().substring(0,10)<today)alerts.push({type:'warning',icon:'üõ°Ô∏è',msg:`${t('alert_bio_disinfection')}: ${z.name}`});}});
const unresolved=D.biosecurity.pestSightings.filter(p=>!p.resolved).length;
if(unresolved>0)alerts.push({type:'warning',icon:'üêÄ',msg:`${t('alert_bio_pests')}: ${unresolved}`});
const recentCross=D.biosecurity.visitors.filter(v=>v.fromFarmHealth==='outbreak'&&v.date>=new Date(Date.now()-7*86400000).toISOString().substring(0,10));
if(recentCross.length)alerts.push({type:'danger',icon:'‚ö†Ô∏è',msg:`${t('alert_bio_cross')}: ${recentCross.map(v=>v.name).join(', ')}`});
}
return alerts;
}

// ============ DASHBOARD ============
function renderDashboard(){
const D=loadData();
if(D.settings.campoMode){$('sec-dashboard').innerHTML=renderCampoDashboard(D);return;}
if(D.settings.vetMode){showVetDashboard();return;}
const today=todayStr();const snap=computeKpiSnapshot();
const prevSnap=D.kpiSnapshots.length>0?D.kpiSnapshots[D.kpiSnapshots.length-1]:null;
const alerts=getAlerts(D);
let h=`<div class="page-header"><h2>${t('dash_title')}</h2><div class="btn-group"><button class="btn btn-secondary" onclick="saveKpiSnapshot()">${t('dash_snapshot')}</button><span>${D.farm.name}</span></div></div><div class="kpi-grid">`;
h+=kpi(t('kpi_today'),fmtNum(snap.eggsToday),'','')+kpi(t('kpi_henday'),fmtNum(snap.henDay,1)+'%',fmtNum(snap.activeHens)+' '+t('kpi_active_hens').toLowerCase()+(prevSnap?snapshotDelta(snap.henDay,prevSnap.henDay):''),snap.henDay<50?'danger':snap.henDay<70?'warning':'');
h+=kpi(t('kpi_fcr'),snap.fcr>0?fmtNum(snap.fcr,2):'-',t('fcr_unit')+(prevSnap?snapshotDelta(-snap.fcr,-prevSnap.fcr):''),snap.fcr>3?'danger':snap.fcr>2.5?'warning':'');
h+=kpi(t('kpi_mortality'),fmtNum(snap.mortality,1)+'%',''+(prevSnap?snapshotDelta(-snap.mortality,-prevSnap.mortality):''),snap.mortality>5?'danger':snap.mortality>3?'warning':'');
h+=kpi(t('kpi_cost_egg'),fmtMoney(snap.costPerEgg),''+(prevSnap?snapshotDelta(-snap.costPerEgg,-prevSnap.costPerEgg):''),'accent');
h+=kpi(t('kpi_income_net'),fmtMoney(snap.netIncome),today.substring(0,7)+(prevSnap?snapshotDelta(snap.netIncome,prevSnap.netIncome):''),snap.netIncome<0?'danger':'secondary');
h+=kpi(t('kpi_active_hens'),fmtNum(snap.activeHens),snap.totalFlocks+' '+t('kpi_active_flocks').toLowerCase());
h+=kpi(t('kpi_alerts'),alerts.length.toString(),alerts.length>0?'‚ö†':'‚úì',alerts.length>0?'warning':'');
h+='</div>';
if(alerts.length){h+=`<div class="card"><h3>${t('dash_alerts')}</h3>`;alerts.forEach(a=>{h+=`<div class="alert-card alert-${a.type}">${a.icon} ${a.msg}</div>`;});h+='</div>';}
// Recommendations
const recs=getRecommendations(D);
if(recs.length){h+=`<div class="rec-card"><h3>üí° ${t('rec_title')}</h3>`;
recs.forEach(r=>{h+=`<div class="rec-item"><span class="rec-priority ${r.priority}">${r.priority.toUpperCase()}</span><span>${r.icon} ${r.msg}</span></div>`;});
h+='</div>';}
// Weather widget
if(D.farm.owmApiKey&&D.farm.lat!==null){
h+='<div id="weather-widget"><div class="weather-widget"><p style="color:var(--text-light)">'+t('weather_title')+'...</p></div></div>';
}else{
h+=`<div class="card" style="background:var(--primary-fill)"><p style="color:var(--text-light)">${t('weather_no_key')} <a href="javascript:nav('config')" style="color:var(--primary)">${t('cfg_title')}</a></p></div>`;
}
h+=`<div class="card"><h3>${t('dash_trend')}</h3><div class="chart-container"><canvas id="chart-trend"></canvas></div></div>`;
if(D.kpiSnapshots.length>1){h+=`<div class="card"><h3>${t('dash_kpi_history')} (${D.kpiSnapshots.length} ${t('snapshots')})</h3><div class="table-wrap"><table><thead><tr><th>${t('date')}</th><th>Hen-Day</th><th>FCR</th><th>${t('kpi_mortality')}</th><th>${t('kpi_cost_egg')}</th><th>${t('kpi_income_net')}</th><th>${t('kpi_active_hens')}</th></tr></thead><tbody>`;
D.kpiSnapshots.slice(-10).reverse().forEach((s,i,arr)=>{const prev=arr[i+1]||null;
h+=`<tr><td>${fmtDate(s.date)}</td><td>${fmtNum(s.henDay,1)}%${prev?snapshotDelta(s.henDay,prev.henDay):''}</td>
<td>${fmtNum(s.fcr,2)}</td><td>${fmtNum(s.mortality,1)}%</td><td>${fmtMoney(s.costPerEgg)}</td>
<td>${fmtMoney(s.netIncome)}</td><td>${fmtNum(s.activeHens)}</td></tr>`;});
h+='</tbody></table></div></div>';}
$('sec-dashboard').innerHTML=h;destroyCharts();renderTrendChart(D);fetchWeather();
}
function kpi(label,value,sub,cls=''){return `<div class="kpi-card ${cls}"><div class="kpi-label">${label}</div><div class="kpi-value">${value}</div><div class="kpi-sub">${sub||''}</div></div>`;}
function renderTrendChart(D){
const c=document.getElementById('chart-trend');if(!c)return;
const labels=[],dE=[],dH=[];
for(let i=29;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().substring(0,10);
labels.push(ds.substring(5));const dp=D.dailyProduction.filter(p=>p.date===ds);
const eggs=dp.reduce((s,p)=>s+(p.eggsCollected||0),0);dE.push(eggs);const h=activeHens();dH.push(h>0?((eggs/h)*100):0);}
CHARTS.trend=new Chart(c,{type:'line',data:{labels,datasets:[
{label:t('prod_eggs'),data:dE,borderColor:themeColor('--primary'),backgroundColor:themeRgba(.1),fill:true,tension:.3,yAxisID:'y'},
{label:t('kpi_henday'),data:dH,borderColor:'#FF8F00',backgroundColor:'transparent',borderDash:[5,5],tension:.3,yAxisID:'y1'}
]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
scales:{y:{position:'left',title:{display:true,text:t('prod_eggs')}},y1:{position:'right',title:{display:true,text:'%'},grid:{drawOnChartArea:false},min:0,max:100}}}});
}

// ============ FLOCKS ============
function renderFlocks(){
const D=loadData();let h=`<div class="page-header"><h2>${t('flock_title')}</h2><button class="btn btn-primary" onclick="showFlockForm()">${t('flock_add')}</button></div>`;
if(!D.flocks.length){h+=emptyState('üêî',t('no_data'),t('flock_add'),'showFlockForm()');}
else{
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('flock_name')}</th><th>${t('flock_breed')}</th><th>${t('flock_count')}</th><th>${t('flock_current')}</th><th>${t('flock_age')}</th><th>${t('lc_current_stage')}</th><th>${t('flock_status')}</th><th>${t('flock_health')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.flocks.forEach(f=>{const age=flockAge(f);const cur=activeHensByFlock(f.id);const hs=healthScore(f.id);const lc=flockLifecycleStage(f);
const bi=breedInfo(f.breed||f.targetCurve);
h+=`<tr><td><strong>${f.name}</strong></td><td>${breedName(f.breed||f.targetCurve)}${bi&&bi.eggColor!=='-'?'<br><small style="color:var(--text-light)">'+bi.eggColor+'</small>':''}</td><td>${fmtNum(f.count)}</td><td>${fmtNum(cur)}</td>
<td>${age.weeks} ${t('flock_weeks')} (${age.days} ${t('flock_days')})</td>
<td><span style="background:${lc.color};padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600">${lc.icon} ${t(lc.key)}</span></td>
<td>${statusBadge(f.status)}</td><td>${healthBadge(hs)}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showFlockForm('${f.id}')">${t('edit')}</button>
<button class="btn btn-sm" style="background:var(--accent);color:#fff" onclick="showFlockRoadmap('${f.id}')">${t('flock_roadmap')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteFlock('${f.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';}
$('sec-lotes').innerHTML=h;
}
function showFlockRoadmap(fid){
const D=loadData();const f=D.flocks.find(x=>x.id===fid);if(!f)return;
const age=flockAge(f);const currentLC=flockLifecycleStage(f);
let h=`<h3 style="margin-bottom:8px">${f.name} ‚Äî ${t('flock_lifecycle')}</h3>
<p style="color:var(--text-light);margin-bottom:16px">${t('flock_age')}: ${age.weeks} ${t('flock_weeks')} | ${t('lc_current_stage')}: ${currentLC.icon} ${t(currentLC.key)}</p>`;
h+='<div class="lifecycle-bar">';
const totalWeeks=80;
LIFECYCLE.forEach(l=>{
const w=Math.min(l.weekEnd,totalWeeks)-l.weekStart;const pct=(w/totalWeeks*100);
if(pct<=0)return;
const isCurrent=l.stage===currentLC.stage;
h+=`<div class="lifecycle-stage${isCurrent?' current':''}" style="width:${pct}%;background:${l.color};${isCurrent?'font-weight:800':''}" title="${t(l.key)}: ${l.weekStart}-${l.weekEnd} ${t('flock_weeks')}">${l.icon} ${t(l.key)}</div>`;
});h+='</div>';
h+='<div class="lifecycle-detail">';
LIFECYCLE.forEach(l=>{const isCurrent=l.stage===currentLC.stage;
h+=`<div class="lifecycle-card" style="background:${l.color};${isCurrent?'box-shadow:0 0 0 3px var(--primary)':''}">
<div class="lc-icon">${l.icon}</div><div class="lc-name">${t(l.key)}</div>
<div class="lc-weeks">${t('lc_weeks')}: ${l.weekStart}-${l.weekEnd===999?'80+':l.weekEnd}</div>
<div class="lc-info"><strong>${t('lc_feed')}:</strong> ${l.feed==='-'?'-':t(l.feed)}<br><strong>${t('lc_temp')}:</strong> ${l.temp}<br>
<strong>${t('lc_prod_label')}:</strong> ${l.prod.startsWith('lc_')?t(l.prod):l.prod}<br><strong>${t('lc_milestone')}:</strong> ${t(l.milestones)}</div></div>`;
});h+='</div>';
// Vaccine timeline for this flock
const vaccines=D.vaccines.filter(v=>v.flockId===fid).sort((a,b)=>a.scheduledDate.localeCompare(b.scheduledDate));
if(vaccines.length){h+=`<h3 style="margin-top:16px">${t('san_vaccines')}</h3><div class="table-wrap" style="margin-top:8px"><table><thead><tr><th>${t('vac_vaccine')}</th><th>${t('vac_scheduled')}</th><th>${t('vac_route')}</th><th>${t('status')}</th></tr></thead><tbody>`;
vaccines.forEach(v=>{h+=`<tr><td>${v.vaccineName}</td><td>${fmtDate(v.scheduledDate)}</td><td>${t(v.route)}</td><td>${statusBadge(v.status==='applied'?'applied':v.scheduledDate<todayStr()?'overdue':'pending')}</td></tr>`;});
h+='</tbody></table></div>';}
openModal(t('flock_lifecycle')+' ‚Äî '+f.name,h);
}
function showFlockForm(id){
const D=loadData();const f=id?D.flocks.find(x=>x.id===id):null;
openModal(f?t('flock_edit'):t('flock_add'),`
<div class="form-row"><div class="form-group"><label>${t('flock_name')}</label><input id="f-name" value="${f?f.name:''}"></div>
<div class="form-group"><label>${t('flock_breed')}</label><select id="f-breed" onchange="onBreedSelect()">
${COMMERCIAL_BREEDS.map(b=>`<option value="${b.id}"${(f&&(f.breed===b.id||f.targetCurve===b.id))?' selected':''}>${b.name}${b.type!=='-'?' ('+b.type+')':''}</option>`).join('')}
</select></div></div>
<div id="breed-info" style="background:var(--card-bg,#f0f4f8);border-radius:8px;padding:8px 12px;margin:-4px 0 8px;font-size:.85em;display:${f?'block':'block'}"></div>
<div class="form-row"><div class="form-group"><label>${t('flock_housing')}</label><select id="f-housing">
<option value="floor"${f&&f.housingType==='floor'?' selected':''}>${t('flock_housing_floor')}</option>
<option value="cage"${f&&f.housingType==='cage'?' selected':''}>${t('flock_housing_cage')}</option>
<option value="free"${f&&f.housingType==='free'?' selected':''}>${t('flock_housing_free')}</option></select></div>
<div class="form-group"><label>${t('flock_egg_color')}</label><input id="f-egg-color" readonly style="background:var(--card-bg,#f0f4f8);cursor:default"></div></div>
<div class="form-row"><div class="form-group"><label>${t('flock_count')}</label><input type="number" id="f-count" value="${f?f.count:''}"></div>
<div class="form-group"><label>${t('flock_status')}</label><select id="f-status">
<option value="cria"${f&&f.status==='cria'?' selected':''}>${t('flock_status_cria')}</option>
<option value="recria"${f&&f.status==='recria'?' selected':''}>${t('flock_status_recria')}</option>
<option value="produccion"${(!f||f.status==='produccion')?' selected':''}>${t('flock_status_produccion')}</option>
<option value="descarte"${f&&f.status==='descarte'?' selected':''}>${t('flock_status_descarte')}</option></select></div></div>
<div class="form-row"><div class="form-group"><label>${t('flock_birthdate')}</label><input type="date" id="f-birth" value="${f?f.birthDate:''}"></div>
<div class="form-group"><label>${t('flock_purchase_date')}</label><input type="date" id="f-purchase" value="${f?f.purchaseDate:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('flock_supplier')}</label><select id="f-supplier">${supplierSelect(f?f.supplier:'')}</select></div>
<div class="form-group"><label>${t('flock_cost')}</label><input type="number" id="f-cost" value="${f?f.cost:''}"></div></div>
<div class="form-group"><label>${t('flock_notes')}</label><textarea id="f-notes">${f?f.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveFlock('${id||''}')">${t('save')}</button></div>`);
setTimeout(onBreedSelect,50);
}
function breedName(id){const b=COMMERCIAL_BREEDS.find(x=>x.id===id);return b?b.name:(id||'-');}
function breedInfo(id){return COMMERCIAL_BREEDS.find(x=>x.id===id)||null;}
function onBreedSelect(){
const sel=$('f-breed');if(!sel)return;const bid=sel.value;
const b=COMMERCIAL_BREEDS.find(x=>x.id===bid);
const info=$('breed-info');const ec=$('f-egg-color');
if(b&&b.type!=='-'){
info.innerHTML=`<strong>${b.name}</strong> ‚Äî ${b.eggsYear} huevos/a√±o ¬∑ Peso: ${b.eggWeight} ¬∑ FCR: ${b.fcr}<br><span style="color:var(--text-secondary,#666)">${b.notes}</span>`;
info.style.display='block';if(ec)ec.value=b.eggColor;
}else{info.innerHTML='';info.style.display='none';if(ec)ec.value='';}
}
function saveFlock(id){
const D=loadData();const breedId=$('f-breed').value;
const o={name:$('f-name').value,breed:breedId,count:parseInt($('f-count').value)||0,
status:$('f-status').value,housingType:$('f-housing')?.value||'floor',targetCurve:breedId,
birthDate:$('f-birth').value,purchaseDate:$('f-purchase').value,
supplier:$('f-supplier').value,cost:parseFloat($('f-cost').value)||0,notes:$('f-notes').value};
if(!o.name){toast(t('flock_name'),true);return;}
if(id){const i=D.flocks.findIndex(f=>f.id===id);if(i>=0)D.flocks[i]={...D.flocks[i],...o};}
else{o.id=genId();D.flocks.push(o);if(o.birthDate)generateVaccineCalendar(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFlocks();
}
function deleteFlock(id){
if(!confirm(t('confirm_delete')))return;const D=loadData();
D.flocks=D.flocks.filter(f=>f.id!==id);D.dailyProduction=D.dailyProduction.filter(p=>p.flockId!==id);
D.vaccines=D.vaccines.filter(v=>v.flockId!==id);D.medications=D.medications.filter(m=>m.flockId!==id);
D.outbreaks=D.outbreaks.filter(o=>o.flockId!==id);D.feed.consumption=D.feed.consumption.filter(c=>c.flockId!==id);
saveData(D);toast(t('cfg_saved'));renderFlocks();
}

// ============ PRODUCTION ============
function renderProduction(){
const D=loadData();let h=`<div class="page-header"><h2>${t('prod_title')}</h2><button class="btn btn-primary" onclick="showProdForm()">${t('prod_add')}</button></div>`;
h+=`<div class="filter-bar"><select onchange="filterProd()" id="pf-flock">${flockSelect('',true)}</select>
<input type="date" id="pf-from" onchange="filterProd()"><input type="date" id="pf-to" onchange="filterProd()"></div>`;
if(!D.dailyProduction.length){h+=emptyState('ü•ö',t('no_data'),t('prod_add'),'showProdForm()');}
else{h+='<div id="prod-table"></div>';}
$('sec-produccion').innerHTML=h;if(D.dailyProduction.length)filterProd();
}
function filterProd(){
const D=loadData();const fid=$('pf-flock')?.value||'';const fr=$('pf-from')?.value||'';const to=$('pf-to')?.value||'';
let recs=D.dailyProduction.sort((a,b)=>b.date.localeCompare(a.date));
if(fid)recs=recs.filter(r=>r.flockId===fid);if(fr)recs=recs.filter(r=>r.date>=fr);if(to)recs=recs.filter(r=>r.date<=to);
let h='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('prod_flock')}</th><th>${t('prod_eggs')}</th><th>S/M/L/XL/J</th><th>${t('prod_egg_type')}</th><th>${t('prod_market')}</th><th>${t('prod_broken')}</th><th>${t('prod_deaths')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
recs.forEach(p=>{const f=D.flocks.find(x=>x.id===p.flockId);
const etype=p.eggType?t('prod_type_'+p.eggType):'-';
const mchan=p.marketChannel?t('prod_market_'+p.marketChannel):'-';
h+=`<tr><td>${fmtDate(p.date)}</td><td>${f?f.name:'-'}</td><td><strong>${fmtNum(p.eggsCollected)}</strong></td>
<td>${[p.eggsS||0,p.eggsM||0,p.eggsL||0,p.eggsXL||0,p.eggsJumbo||0].join('/')}</td>
<td>${etype}</td><td>${mchan}</td>
<td>${fmtNum(p.eggsBroken||0)}</td><td>${p.deaths?'<span style="color:var(--danger)">'+p.deaths+'</span>':'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showProdForm('${p.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteProd('${p.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';const w=$('prod-table');if(w)w.innerHTML=h;
}
function showProdForm(id){
const D=loadData();const p=id?D.dailyProduction.find(x=>x.id===id):null;
openModal(p?t('edit'):t('prod_add'),`
<div class="form-row"><div class="form-group"><label>${t('prod_date')}</label><input type="date" id="p-date" value="${p?p.date:todayStr()}"></div>
<div class="form-group"><label>${t('prod_flock')}</label><select id="p-flock" onchange="onProdFlockChange()">${flockSelect(p?p.flockId:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('prod_eggs')}</label><input type="number" id="p-eggs" value="${p?p.eggsCollected:''}" min="0"></div>
<div class="form-group"><label>${t('prod_broken')}</label><input type="number" id="p-broken" value="${p?p.eggsBroken||'':''}" min="0"></div></div>
<div class="form-row-3"><div class="form-group"><label>${t('prod_size_s')}</label><input type="number" id="p-s" value="${p?p.eggsS||'':''}" min="0"></div>
<div class="form-group"><label>${t('prod_size_m')}</label><input type="number" id="p-m" value="${p?p.eggsM||'':''}" min="0"></div>
<div class="form-group"><label>${t('prod_size_l')}</label><input type="number" id="p-l" value="${p?p.eggsL||'':''}" min="0"></div></div>
<div class="form-row-3"><div class="form-group"><label>${t('prod_size_xl')}</label><input type="number" id="p-xl" value="${p?p.eggsXL||'':''}" min="0"></div>
<div class="form-group"><label>${t('prod_size_jumbo')}</label><input type="number" id="p-jumbo" value="${p?p.eggsJumbo||'':''}" min="0"></div>
<div class="form-group"><label>${t('prod_yolk')}</label><input type="number" id="p-yolk" value="${p?p.yolkScore||'':''}" min="1" max="10"></div></div>
<div class="form-row"><div class="form-group"><label>${t('prod_shell')}</label><select id="p-shell">
<option value="">--</option><option value="blanco"${p&&p.shellColor==='blanco'?' selected':''}>${t('prod_shell_white')}</option>
<option value="marron"${p&&p.shellColor==='marron'?' selected':''}>${t('prod_shell_brown')}</option>
<option value="crema"${p&&p.shellColor==='crema'?' selected':''}>${t('prod_shell_cream')}</option></select></div>
<div class="form-group"><label>${t('prod_deaths')}</label><input type="number" id="p-deaths" value="${p?p.deaths||'':''}" min="0"></div></div>
<div class="form-row"><div class="form-group"><label>${t('prod_egg_type')}</label><select id="p-etype">
<option value="conventional"${p&&p.eggType==='conventional'?' selected':''}>${t('prod_type_conventional')}</option>
<option value="free_range"${p&&p.eggType==='free_range'?' selected':''}>${t('prod_type_free_range')}</option>
<option value="organic"${p&&p.eggType==='organic'?' selected':''}>${t('prod_type_organic')}</option>
<option value="pasture_raised"${p&&p.eggType==='pasture_raised'?' selected':''}>${t('prod_type_pasture')}</option>
<option value="decorative"${p&&p.eggType==='decorative'?' selected':''}>${t('prod_type_decorative')}</option></select></div>
<div class="form-group"><label>${t('prod_market')}</label><select id="p-market">
<option value="wholesale"${p&&p.marketChannel==='wholesale'?' selected':''}>${t('prod_market_wholesale')}</option>
<option value="supermarket"${p&&p.marketChannel==='supermarket'?' selected':''}>${t('prod_market_supermarket')}</option>
<option value="restaurant"${p&&p.marketChannel==='restaurant'?' selected':''}>${t('prod_market_restaurant')}</option>
<option value="direct"${p&&p.marketChannel==='direct'?' selected':''}>${t('prod_market_direct')}</option>
<option value="export"${p&&p.marketChannel==='export'?' selected':''}>${t('prod_market_export')}</option>
<option value="pasteurized"${p&&p.marketChannel==='pasteurized'?' selected':''}>${t('prod_market_pasteurized')}</option></select></div></div>
<div class="form-group"><label>${t('prod_death_cause')}</label><select id="p-cause">${catalogSelect(CATALOGS.deathCauses,p?p.deathCause||'':'')}</select></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="p-notes">${p?p.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveProd('${id||''}')">${t('save')}</button></div>`);
if(!p)setTimeout(onProdFlockChange,50);
}
function saveProd(id){
const D=loadData();const o={date:$('p-date').value,flockId:$('p-flock').value,
eggsCollected:parseInt($('p-eggs').value)||0,eggsBroken:parseInt($('p-broken').value)||0,
eggsS:parseInt($('p-s').value)||0,eggsM:parseInt($('p-m').value)||0,eggsL:parseInt($('p-l').value)||0,
eggsXL:parseInt($('p-xl').value)||0,eggsJumbo:parseInt($('p-jumbo').value)||0,
shellColor:$('p-shell').value,yolkScore:parseInt($('p-yolk').value)||0,
deaths:parseInt($('p-deaths').value)||0,deathCause:$('p-cause').value,
eggType:$('p-etype')?.value||'conventional',marketChannel:$('p-market')?.value||'wholesale',
notes:$('p-notes').value};
if(!o.date||!o.flockId){toast(t('required'),true);return;}
if(id){const i=D.dailyProduction.findIndex(p=>p.id===id);if(i>=0)D.dailyProduction[i]={...D.dailyProduction[i],...o};}
else{o.id=genId();D.dailyProduction.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderProduction();
}
function deleteProd(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.dailyProduction=D.dailyProduction.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderProduction();}

// === SANIDAD MODULE ===
function renderSanidad(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('san_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentSanidadTab==='vaccines'?' active':''}" onclick="currentSanidadTab='vaccines';renderSanidad()">üíâ ${t('san_vaccines')}</div>
<div class="tab${currentSanidadTab==='medications'?' active':''}" onclick="currentSanidadTab='medications';renderSanidad()">üíä ${t('san_medications')}</div>
<div class="tab${currentSanidadTab==='outbreaks'?' active':''}" onclick="currentSanidadTab='outbreaks';renderSanidad()">ü¶† ${t('san_outbreaks')}</div>
<div class="tab${currentSanidadTab==='stress'?' active':''}" onclick="currentSanidadTab='stress';renderSanidad()">‚ö° ${t('stress_title')}</div></div>`;
if(currentSanidadTab==='vaccines')h+=renderVaccinesTab(D);
else if(currentSanidadTab==='medications')h+=renderMedicationsTab(D);
else if(currentSanidadTab==='stress')h+=renderStressEventsTab(D);
else h+=renderOutbreaksTab(D);
$('sec-sanidad').innerHTML=h;
}
function renderVaccinesTab(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('vac_title')}</h3><div class="btn-group">
<button class="btn btn-secondary btn-sm" onclick="showGenVaccines()">${t('vac_generate')}</button>
<button class="btn btn-primary btn-sm" onclick="showVaccineForm()">${t('vac_add')}</button></div></div>`;
h+=`<div class="filter-bar"><select id="vf-flock" onchange="renderSanidad()">${flockSelect('',true)}</select>
<select id="vf-status" onchange="renderSanidad()"><option value="">${t('all')}</option><option value="pending">${t('vac_pending')}</option><option value="overdue">${t('vac_overdue')}</option><option value="applied">${t('vac_applied_status')}</option></select></div>`;
const fid=document.getElementById('vf-flock')?.value||'';const st=document.getElementById('vf-status')?.value||'';
let vacs=D.vaccines.sort((a,b)=>a.scheduledDate.localeCompare(b.scheduledDate));
if(fid)vacs=vacs.filter(v=>v.flockId===fid);
const today=todayStr();
vacs=vacs.map(v=>{const eff=v.status==='applied'?'applied':v.scheduledDate<today?'overdue':'pending';return{...v,effectiveStatus:eff};});
if(st)vacs=vacs.filter(v=>v.effectiveStatus===st);
if(!vacs.length)return h+emptyState('üíâ',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('prod_flock')}</th><th>${t('vac_vaccine')}</th><th>${t('vac_route')}</th><th>${t('vac_scheduled')}</th><th>${t('vac_applied')}</th><th>${t('vac_batch')}</th><th>${t('status')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
vacs.forEach(v=>{const f=D.flocks.find(x=>x.id===v.flockId);
h+=`<tr><td>${f?f.name:'-'}</td><td>${v.vaccineName}</td><td>${v.route?t(v.route):'-'}</td><td>${fmtDate(v.scheduledDate)}</td>
<td>${v.appliedDate?fmtDate(v.appliedDate):'-'}</td><td>${v.batchNumber||'-'}</td>
<td>${statusBadge(v.effectiveStatus)}</td>
<td><div class="btn-group">${v.effectiveStatus!=='applied'?`<button class="btn btn-primary btn-sm" onclick="markVaccineApplied('${v.id}')">${t('vac_mark_applied')}</button>`:''}
<button class="btn btn-secondary btn-sm" onclick="showVaccineForm('${v.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteVaccine('${v.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showGenVaccines(){
const D=loadData();const flocks=D.flocks.filter(f=>f.birthDate&&f.status!=='descarte');
if(!flocks.length){toast(t('no_flocks_birthdate'),true);return;}
let body=`<p>${t('vac_select_flocks')}</p>`;
flocks.forEach(f=>{body+=`<div class="checklist-item"><input type="checkbox" id="gv-${f.id}" checked><span>${f.name} (${fmtDate(f.birthDate)})</span></div>`;});
body+=`<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="doGenVaccines()">${t('vac_generate')}</button></div>`;
openModal(t('vac_generate'),body);
}
function doGenVaccines(){
const D=loadData();D.flocks.filter(f=>f.birthDate&&f.status!=='descarte').forEach(f=>{
const cb=document.getElementById('gv-'+f.id);if(cb&&cb.checked)generateVaccineCalendar(f);});
closeModal();toast(t('cfg_saved'));renderSanidad();
}
function showVaccineForm(id){
const D=loadData();const v=id?D.vaccines.find(x=>x.id===id):null;
openModal(v?t('edit'):t('vac_add'),`
<div class="form-row"><div class="form-group"><label>${t('prod_flock')}</label><select id="v-flock">${flockSelect(v?v.flockId:'')}</select></div>
<div class="form-group"><label>${t('vac_vaccine')}</label><select id="v-name">${catalogSelect(VACCINE_SCHEDULE.map(vs=>vs.name),v?v.vaccineName:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('vac_route')}</label><select id="v-route">
<option value="">--</option>
<option value="vac_route_injection"${v&&v.route==='vac_route_injection'?' selected':''}>${t('vac_route_injection')}</option>
<option value="vac_route_ocular"${v&&v.route==='vac_route_ocular'?' selected':''}>${t('vac_route_ocular')}</option>
<option value="vac_route_water"${v&&v.route==='vac_route_water'?' selected':''}>${t('vac_route_water')}</option>
<option value="vac_route_wing"${v&&v.route==='vac_route_wing'?' selected':''}>${t('vac_route_wing')}</option>
</select></div>
<div class="form-group"><label>${t('vac_batch')}</label><input id="v-batch" value="${v?v.batchNumber:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('vac_scheduled')}</label><input type="date" id="v-sched" value="${v?v.scheduledDate:''}"></div>
<div class="form-group"><label>${t('vac_applied')}</label><input type="date" id="v-applied" value="${v?v.appliedDate:''}"></div></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="v-notes">${v?v.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveVaccine('${id||''}')">${t('save')}</button></div>`);
}
function saveVaccine(id){
const D=loadData();const o={flockId:$('v-flock').value,vaccineName:$('v-name').value,route:$('v-route').value,
batchNumber:$('v-batch').value,scheduledDate:$('v-sched').value,appliedDate:$('v-applied').value,
notes:$('v-notes').value,status:$('v-applied').value?'applied':'pending'};
if(!o.vaccineName){toast(t('required'),true);return;}
if(id){const i=D.vaccines.findIndex(v=>v.id===id);if(i>=0)D.vaccines[i]={...D.vaccines[i],...o};}
else{o.id=genId();D.vaccines.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderSanidad();
}
function markVaccineApplied(id){
const D=loadData();const v=D.vaccines.find(x=>x.id===id);if(!v)return;
v.appliedDate=todayStr();v.status='applied';saveData(D);toast(t('cfg_saved'));renderSanidad();
}
function deleteVaccine(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.vaccines=D.vaccines.filter(v=>v.id!==id);saveData(D);toast(t('cfg_saved'));renderSanidad();}

function renderMedicationsTab(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('med_title')}</h3>
<button class="btn btn-primary btn-sm" onclick="showMedForm()">${t('med_add')}</button></div>`;
if(!D.medications.length)return h+emptyState('üíä',t('no_data'));
const today=todayStr();
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('prod_flock')}</th><th>${t('med_name')}</th><th>${t('med_reason')}</th><th>${t('med_dosage')}</th><th>${t('med_start')}</th><th>${t('med_end')}</th><th>${t('med_withdrawal')}</th><th>${t('med_withdrawal_end')}</th><th>${t('status')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.medications.forEach(m=>{const f=D.flocks.find(x=>x.id===m.flockId);
const inWD=m.withdrawalEnd&&m.withdrawalEnd>=today;
h+=`<tr><td>${f?f.name:'-'}</td><td>${m.name}</td><td>${m.reason||'-'}</td><td>${m.dosage||'-'}</td>
<td>${fmtDate(m.startDate)}</td><td>${fmtDate(m.endDate)}</td><td>${m.withdrawalDays||'-'}</td>
<td>${fmtDate(m.withdrawalEnd)}</td>
<td>${inWD?'<span class="badge badge-warning">'+t('med_in_withdrawal')+'</span>':'<span class="badge badge-success">OK</span>'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showMedForm('${m.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteMed('${m.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showMedForm(id){
const D=loadData();const m=id?D.medications.find(x=>x.id===id):null;
openModal(m?t('edit'):t('med_add'),`
<div class="form-row"><div class="form-group"><label>${t('prod_flock')}</label><select id="m-flock">${flockSelect(m?m.flockId:'')}</select></div>
<div class="form-group"><label>${t('med_name')}</label><select id="m-name" onchange="onMedSelect()">${catalogSelect(CATALOGS.medications,m?m.name:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('med_reason')}</label><select id="m-reason">${catalogSelect(CATALOGS.diseases,m?m.reason||'':'')}</select></div>
<div class="form-group"><label>${t('med_dosage')}</label><input id="m-dosage" value="${m?m.dosage||'':''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('med_start')}</label><input type="date" id="m-start" value="${m?m.startDate:''}"></div>
<div class="form-group"><label>${t('med_end')}</label><input type="date" id="m-end" value="${m?m.endDate:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('med_withdrawal')}</label><input type="number" id="m-wd" value="${m?m.withdrawalDays||'':''}" min="0"></div>
<div class="form-group"><label>${t('notes')}</label><input id="m-notes" value="${m?m.notes||'':''}"></div></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveMed('${id||''}')">${t('save')}</button></div>`);
}
function saveMed(id){
const D=loadData();const o={flockId:$('m-flock').value,name:$('m-name').value,reason:$('m-reason').value,
dosage:$('m-dosage').value,startDate:$('m-start').value,endDate:$('m-end').value,
withdrawalDays:parseInt($('m-wd').value)||0,notes:$('m-notes').value};
if(!o.name){toast(t('required'),true);return;}
if(o.endDate&&o.withdrawalDays){const d=new Date(o.endDate+'T12:00:00');d.setDate(d.getDate()+o.withdrawalDays);o.withdrawalEnd=d.toISOString().substring(0,10);}else{o.withdrawalEnd='';}
if(id){const i=D.medications.findIndex(m=>m.id===id);if(i>=0)D.medications[i]={...D.medications[i],...o};}
else{o.id=genId();D.medications.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderSanidad();
}
function deleteMed(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.medications=D.medications.filter(m=>m.id!==id);saveData(D);toast(t('cfg_saved'));renderSanidad();}

function renderOutbreaksTab(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('out_title')}</h3>
<button class="btn btn-primary btn-sm" onclick="showOutbreakForm()">${t('out_add')}</button></div>`;
if(!D.outbreaks.length)return h+emptyState('ü¶†',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('prod_flock')}</th><th>${t('out_disease')}</th><th>${t('out_start')}</th><th>${t('out_end')}</th><th>${t('out_affected')}</th><th>${t('out_deaths')}</th><th>${t('out_loss')}</th><th>${t('status')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.outbreaks.forEach(o=>{const f=D.flocks.find(x=>x.id===o.flockId);
h+=`<tr><td>${f?f.name:'-'}</td><td>${o.disease}</td><td>${fmtDate(o.startDate)}</td><td>${fmtDate(o.endDate)}</td>
<td>${fmtNum(o.affected||0)}</td><td>${o.deaths?'<span style="color:var(--danger)">'+o.deaths+'</span>':'-'}</td>
<td>${fmtMoney(o.economicLoss||0)}</td><td>${statusBadge(o.status)}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showOutbreakForm('${o.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteOutbreak('${o.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showOutbreakForm(id){
const D=loadData();const o=id?D.outbreaks.find(x=>x.id===id):null;
openModal(o?t('edit'):t('out_add'),`
<div class="form-row"><div class="form-group"><label>${t('prod_flock')}</label><select id="o-flock">${flockSelect(o?o.flockId:'')}</select></div>
<div class="form-group"><label>${t('out_disease')}</label><select id="o-disease">${catalogSelect(CATALOGS.diseases,o?o.disease:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('out_start')}</label><input type="date" id="o-start" value="${o?o.startDate:todayStr()}"></div>
<div class="form-group"><label>${t('out_end')}</label><input type="date" id="o-end" value="${o?o.endDate||'':''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('out_affected')}</label><input type="number" id="o-affected" value="${o?o.affected||'':''}" min="0"></div>
<div class="form-group"><label>${t('out_deaths')}</label><input type="number" id="o-deaths" value="${o?o.deaths||'':''}" min="0"></div></div>
<div class="form-row"><div class="form-group"><label>${t('out_loss')}</label><input type="number" id="o-loss" value="${o?o.economicLoss||'':''}" min="0"></div>
<div class="form-group"><label>${t('status')}</label><select id="o-status">
<option value="active"${o&&o.status==='active'?' selected':''}>${t('out_active')}</option>
<option value="controlled"${o&&o.status==='controlled'?' selected':''}>${t('out_controlled')}</option>
<option value="resolved"${o&&o.status==='resolved'?' selected':''}>${t('out_resolved')}</option></select></div></div>
<div class="form-group"><label>${t('out_symptoms')}</label><textarea id="o-symptoms">${o?o.symptoms||'':''}</textarea></div>
<div class="form-group"><label>${t('out_treatment')}</label><textarea id="o-treatment">${o?o.treatment||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveOutbreak('${id||''}')">${t('save')}</button></div>`);
}
function saveOutbreak(id){
const D=loadData();const o={flockId:$('o-flock').value,disease:$('o-disease').value,startDate:$('o-start').value,
endDate:$('o-end').value,affected:parseInt($('o-affected').value)||0,deaths:parseInt($('o-deaths').value)||0,
economicLoss:parseFloat($('o-loss').value)||0,status:$('o-status').value,
symptoms:$('o-symptoms').value,treatment:$('o-treatment').value};
if(!o.disease){toast(t('required'),true);return;}
if(id){const i=D.outbreaks.findIndex(x=>x.id===id);if(i>=0)D.outbreaks[i]={...D.outbreaks[i],...o};}
else{o.id=genId();D.outbreaks.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderSanidad();
}
function deleteOutbreak(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.outbreaks=D.outbreaks.filter(o=>o.id!==id);saveData(D);toast(t('cfg_saved'));renderSanidad();}
// === END SANIDAD ===

// === FEED MODULE ===
let currentFeedTab='purchases';
function renderFeed(){
const D=loadData();
const totalPurchased=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0);
const totalConsumed=D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0);
const stock=totalPurchased-totalConsumed;
const isLow=stock<(D.settings.minFeedStock||50);
let h=`<div class="page-header"><h2>${t('feed_title')}</h2></div>`;
h+=`<div class="kpi-grid">`;
h+=kpi(t('feed_stock'),fmtNum(stock,1)+' kg','',isLow?'danger':'');
h+=kpi(t('feed_purchases'),fmtNum(totalPurchased,1)+' kg',fmtMoney(D.feed.purchases.reduce((s,p)=>s+(p.cost||0),0))+' '+t('total'));
h+=kpi(t('feed_consumption'),fmtNum(totalConsumed,1)+' kg','');
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const f30=D.feed.consumption.filter(c=>c.date>=d30s);const tF30=f30.reduce((s,c)=>s+(c.quantityKg||0),0);
const p30=D.dailyProduction.filter(p=>p.date>=d30s);const tE30=p30.reduce((s,p)=>s+(p.eggsCollected||0),0)*0.06;
const fcr=tE30>0?(tF30/tE30):0;
h+=kpi(t('kpi_fcr'),fcr>0?fmtNum(fcr,2):'-','30d',fcr>3?'danger':fcr>2.5?'warning':'');
h+='</div>';
h+=`<div class="tabs"><div class="tab${currentFeedTab==='purchases'?' active':''}" onclick="currentFeedTab='purchases';renderFeed()">üì¶ ${t('feed_purchases')}</div>
<div class="tab${currentFeedTab==='consumption'?' active':''}" onclick="currentFeedTab='consumption';renderFeed()">üçΩÔ∏è ${t('feed_consumption')}</div></div>`;
if(currentFeedTab==='purchases')h+=renderFeedPurchases(D);
else h+=renderFeedConsumption(D);
$('sec-alimento').innerHTML=h;
}
function renderFeedPurchases(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('feed_purchases')}</h3>
<button class="btn btn-primary btn-sm" onclick="showFeedPurchaseForm()">${t('feed_add_purchase')}</button></div>`;
if(!D.feed.purchases.length)return h+emptyState('üì¶',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('feed_type')}</th><th>${t('feed_qty')}</th><th>${t('feed_cost')}</th><th>$/kg</th><th>${t('feed_supplier')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.feed.purchases.sort((a,b)=>b.date.localeCompare(a.date)).forEach(p=>{
const ppkg=p.quantityKg>0?(p.cost/p.quantityKg):0;
h+=`<tr><td>${fmtDate(p.date)}</td><td>${p.type||'-'}</td><td>${fmtNum(p.quantityKg,1)}</td>
<td>${fmtMoney(p.cost)}</td><td>${fmtMoney(ppkg)}</td><td>${p.supplier||'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showFeedPurchaseForm('${p.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteFeedPurchase('${p.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showFeedPurchaseForm(id){
const D=loadData();const p=id?D.feed.purchases.find(x=>x.id===id):null;
openModal(p?t('edit'):t('feed_add_purchase'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fp-date" value="${p?p.date:todayStr()}"></div>
<div class="form-group"><label>${t('feed_type')}</label><select id="fp-type">${feedTypeSelect(p?p.type||'':'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('feed_qty')}</label><input type="number" id="fp-qty" value="${p?p.quantityKg:''}" step="0.1" min="0"></div>
<div class="form-group"><label>${t('feed_cost')}</label><input type="number" id="fp-cost" value="${p?p.cost:''}" min="0"></div></div>
<div class="form-group"><label>${t('feed_supplier')}</label><select id="fp-sup">${supplierSelect(p?p.supplier||'':'')}</select></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveFeedPurchase('${id||''}')">${t('save')}</button></div>`);
}
function saveFeedPurchase(id){
const D=loadData();const o={date:$('fp-date').value,type:$('fp-type').value,
quantityKg:parseFloat($('fp-qty').value)||0,cost:parseFloat($('fp-cost').value)||0,supplier:$('fp-sup').value};
if(!o.date){toast(t('required'),true);return;}
if(id){const i=D.feed.purchases.findIndex(p=>p.id===id);if(i>=0)D.feed.purchases[i]={...D.feed.purchases[i],...o};}
else{o.id=genId();D.feed.purchases.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFeed();
}
function deleteFeedPurchase(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.feed.purchases=D.feed.purchases.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderFeed();}

function renderFeedConsumption(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('feed_consumption')}</h3>
<button class="btn btn-primary btn-sm" onclick="showFeedConsForm()">${t('feed_add_consumption')}</button></div>`;
if(!D.feed.consumption.length)return h+emptyState('üçΩÔ∏è',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('feed_flock')}</th><th>${t('feed_qty')}</th><th>${t('feed_type')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.feed.consumption.sort((a,b)=>b.date.localeCompare(a.date)).forEach(c=>{const f=D.flocks.find(x=>x.id===c.flockId);
h+=`<tr><td>${fmtDate(c.date)}</td><td>${f?f.name:'-'}</td><td>${fmtNum(c.quantityKg,1)} kg</td><td>${c.type||'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showFeedConsForm('${c.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteFeedCons('${c.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showFeedConsForm(id){
const D=loadData();const c=id?D.feed.consumption.find(x=>x.id===id):null;
openModal(c?t('edit'):t('feed_add_consumption'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fc-date" value="${c?c.date:todayStr()}"></div>
<div class="form-group"><label>${t('feed_flock')}</label><select id="fc-flock">${flockSelect(c?c.flockId:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('feed_qty')}</label><input type="number" id="fc-qty" value="${c?c.quantityKg:''}" step="0.1" min="0"></div>
<div class="form-group"><label>${t('feed_type')}</label><select id="fc-type">${feedTypeSelect(c?c.type||'':'',c?c.flockId:'')}</select></div></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveFeedCons('${id||''}')">${t('save')}</button></div>`);
}
function saveFeedCons(id){
const D=loadData();const o={date:$('fc-date').value,flockId:$('fc-flock').value,
quantityKg:parseFloat($('fc-qty').value)||0,type:$('fc-type').value};
if(!o.date||!o.flockId){toast(t('required'),true);return;}
if(id){const i=D.feed.consumption.findIndex(c=>c.id===id);if(i>=0)D.feed.consumption[i]={...D.feed.consumption[i],...o};}
else{o.id=genId();D.feed.consumption.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFeed();
}
function deleteFeedCons(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.feed.consumption=D.feed.consumption.filter(c=>c.id!==id);saveData(D);toast(t('cfg_saved'));renderFeed();}
// === END FEED ===

// === CLIENTS MODULE ===
function renderClients(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('cli_title')}</h2><button class="btn btn-primary" onclick="showClientForm()">${t('cli_add')}</button></div>`;
h+=`<div class="kpi-grid">${kpi(t('cli_total'),fmtNum(D.clients.length))}</div>`;
if(!D.clients.length){h+=emptyState('üë•',t('no_data'),t('cli_add'),'showClientForm()');}
else{
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('name')}</th><th>${t('phone')}</th><th>${t('email')}</th><th>${t('cli_route')}</th><th>${t('cli_price')} (S/M/L/XL/J)</th><th>${t('notes')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.clients.forEach(c=>{
const prices=[c.priceS||'-',c.priceM||'-',c.priceL||'-',c.priceXL||'-',c.priceJumbo||'-'].join(' / ');
h+=`<tr><td><strong>${c.name}</strong></td><td>${c.phone||'-'}</td><td>${c.email||'-'}</td><td>${c.route||'-'}</td>
<td>${prices}</td><td>${c.notes||'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showClientForm('${c.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteClient('${c.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';}
$('sec-clientes').innerHTML=h;
}
function showClientForm(id){
const D=loadData();const c=id?D.clients.find(x=>x.id===id):null;
openModal(c?t('edit'):t('cli_add'),`
<div class="form-row"><div class="form-group"><label>${t('name')}</label><input id="cl-name" value="${c?c.name:''}"></div>
<div class="form-group"><label>${t('phone')}</label><input id="cl-phone" value="${c?c.phone||'':''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('email')}</label><input id="cl-email" value="${c?c.email||'':''}"></div>
<div class="form-group"><label>${t('cli_route')}</label><select id="cl-route">${routeSelect(c?c.route||'':'')}</select></div></div>
<div class="form-group"><label>${t('address')}</label><input id="cl-addr" value="${c?c.address||'':''}"></div>
<p style="font-weight:600;margin:12px 0 8px">${t('cli_price')} (${currency()}/huevo)</p>
<div class="form-row-3"><div class="form-group"><label>S</label><input type="number" id="cl-ps" value="${c?c.priceS||'':''}" step="1" min="0"></div>
<div class="form-group"><label>M</label><input type="number" id="cl-pm" value="${c?c.priceM||'':''}" step="1" min="0"></div>
<div class="form-group"><label>L</label><input type="number" id="cl-pl" value="${c?c.priceL||'':''}" step="1" min="0"></div></div>
<div class="form-row"><div class="form-group"><label>XL</label><input type="number" id="cl-pxl" value="${c?c.priceXL||'':''}" step="1" min="0"></div>
<div class="form-group"><label>Jumbo</label><input type="number" id="cl-pj" value="${c?c.priceJumbo||'':''}" step="1" min="0"></div></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="cl-notes">${c?c.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveClient('${id||''}')">${t('save')}</button></div>`);
}
function saveClient(id){
const D=loadData();const o={name:$('cl-name').value,phone:$('cl-phone').value,email:$('cl-email').value,
route:$('cl-route').value,address:$('cl-addr').value,
priceS:parseFloat($('cl-ps').value)||0,priceM:parseFloat($('cl-pm').value)||0,priceL:parseFloat($('cl-pl').value)||0,
priceXL:parseFloat($('cl-pxl').value)||0,priceJumbo:parseFloat($('cl-pj').value)||0,notes:$('cl-notes').value};
if(!o.name){toast(t('required'),true);return;}
if(id){const i=D.clients.findIndex(c=>c.id===id);if(i>=0)D.clients[i]={...D.clients[i],...o};}
else{o.id=genId();D.clients.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderClients();
}
function deleteClient(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.clients=D.clients.filter(c=>c.id!==id);saveData(D);toast(t('cfg_saved'));renderClients();}
// === END CLIENTS ===

// === FINANCES MODULE ===
function renderFinances(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('fin_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentFinanceTab==='income'?' active':''}" onclick="currentFinanceTab='income';renderFinances()">üìà ${t('fin_income')}</div>
<div class="tab${currentFinanceTab==='expenses'?' active':''}" onclick="currentFinanceTab='expenses';renderFinances()">üìâ ${t('fin_expenses')}</div>
<div class="tab${currentFinanceTab==='receivables'?' active':''}" onclick="currentFinanceTab='receivables';renderFinances()">üìã ${t('fin_receivables')}</div>
<div class="tab${currentFinanceTab==='summary'?' active':''}" onclick="currentFinanceTab='summary';renderFinances()">üìä ${t('fin_summary')}</div></div>`;
if(currentFinanceTab==='income')h+=renderFinIncome(D);
else if(currentFinanceTab==='expenses')h+=renderFinExpenses(D);
else if(currentFinanceTab==='receivables')h+=renderFinReceivables(D);
else h+=renderFinSummary(D);
$('sec-finanzas').innerHTML=h;
}
function renderFinIncome(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('fin_income')}</h3>
<button class="btn btn-primary btn-sm" onclick="showIncomeForm()">${t('fin_add_income')}</button></div>`;
if(!D.finances.income.length)return h+emptyState('üìà',t('no_data'));
const tot=D.finances.income.reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
h+=`<div class="kpi-grid">${kpi(t('fin_total_income'),fmtMoney(tot))}</div>`;
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('fin_type')}</th><th>${t('fin_qty')}</th><th>${t('fin_unit_price')}</th><th>${t('total')}</th><th>${t('fin_client')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.finances.income.sort((a,b)=>b.date.localeCompare(a.date)).forEach(i=>{
const cl=D.clients.find(c=>c.id===i.clientId);const amt=(i.quantity||0)*(i.unitPrice||0)||(i.amount||0);
h+=`<tr><td>${fmtDate(i.date)}</td><td>${t('fin_type_'+i.type)||i.type||'-'}</td><td>${fmtNum(i.quantity||0)}</td>
<td>${fmtMoney(i.unitPrice||0)}</td><td><strong>${fmtMoney(amt)}</strong></td><td>${cl?cl.name:i.clientName||'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showIncomeForm('${i.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteIncome('${i.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showIncomeForm(id){
const D=loadData();const i=id?D.finances.income.find(x=>x.id===id):null;
openModal(i?t('edit'):t('fin_add_income'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fi-date" value="${i?i.date:todayStr()}"></div>
<div class="form-group"><label>${t('fin_type')}</label><select id="fi-type">
<option value="eggs"${i&&i.type==='eggs'?' selected':''}>${t('fin_type_eggs')}</option>
<option value="birds"${i&&i.type==='birds'?' selected':''}>${t('fin_type_birds')}</option>
<option value="manure"${i&&i.type==='manure'?' selected':''}>${t('fin_type_manure')}</option>
<option value="other"${i&&i.type==='other'?' selected':''}>${t('fin_type_other')}</option></select></div></div>
<div class="form-row"><div class="form-group"><label>${t('fin_qty')}</label><input type="number" id="fi-qty" value="${i?i.quantity||'':''}" min="0"></div>
<div class="form-group"><label>${t('fin_unit_price')}</label><input type="number" id="fi-price" value="${i?i.unitPrice||'':''}" min="0"></div></div>
<div class="form-group"><label>${t('fin_client')}</label><select id="fi-client">${clientSelect(i?i.clientId:'')}</select></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="fi-notes">${i?i.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveIncome('${id||''}')">${t('save')}</button></div>`);
}
function saveIncome(id){
const D=loadData();const o={date:$('fi-date').value,type:$('fi-type').value,
quantity:parseInt($('fi-qty').value)||0,unitPrice:parseFloat($('fi-price').value)||0,
clientId:$('fi-client').value,notes:$('fi-notes').value};
if(!o.date){toast(t('required'),true);return;}
if(id){const i=D.finances.income.findIndex(x=>x.id===id);if(i>=0)D.finances.income[i]={...D.finances.income[i],...o};}
else{o.id=genId();D.finances.income.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFinances();
}
function deleteIncome(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.finances.income=D.finances.income.filter(i=>i.id!==id);saveData(D);toast(t('cfg_saved'));renderFinances();}

function renderFinExpenses(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('fin_expenses')}</h3>
<button class="btn btn-primary btn-sm" onclick="showExpenseForm()">${t('fin_add_expense')}</button></div>`;
if(!D.finances.expenses.length)return h+emptyState('üìâ',t('no_data'));
const tot=D.finances.expenses.reduce((s,e)=>s+(e.amount||0),0);
h+=`<div class="kpi-grid">${kpi(t('fin_total_expenses'),fmtMoney(tot),'','danger')}</div>`;
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('fin_category')}</th><th>${t('fin_description')}</th><th>${t('fin_amount')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.finances.expenses.sort((a,b)=>b.date.localeCompare(a.date)).forEach(e=>{
h+=`<tr><td>${fmtDate(e.date)}</td><td>${t('fin_cat_'+e.category)||e.category||'-'}</td><td>${e.description||'-'}</td>
<td><strong>${fmtMoney(e.amount)}</strong></td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showExpenseForm('${e.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteExpense('${e.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showExpenseForm(id){
const D=loadData();const e=id?D.finances.expenses.find(x=>x.id===id):null;
const cats=['feed','vaccines','transport','labor','infrastructure','other'];
openModal(e?t('edit'):t('fin_add_expense'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fe-date" value="${e?e.date:todayStr()}"></div>
<div class="form-group"><label>${t('fin_category')}</label><select id="fe-cat" onchange="onExpenseCatChange()">${cats.map(c=>`<option value="${c}"${e&&e.category===c?' selected':''}>${t('fin_cat_'+c)}</option>`).join('')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('fin_description')}</label><select id="fe-desc">${catalogSelect(CATALOGS.expenseDescriptions[e?e.category:'feed']||CATALOGS.expenseDescriptions.feed,e?e.description||'':'')}</select></div>
<div class="form-group"><label>${t('fin_amount')}</label><input type="number" id="fe-amt" value="${e?e.amount:''}" min="0"></div></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="fe-notes">${e?e.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveExpense('${id||''}')">${t('save')}</button></div>`);
}
function saveExpense(id){
const D=loadData();const o={date:$('fe-date').value,category:$('fe-cat').value,
description:$('fe-desc').value,amount:parseFloat($('fe-amt').value)||0,notes:$('fe-notes').value};
if(!o.date){toast(t('required'),true);return;}
if(id){const i=D.finances.expenses.findIndex(e=>e.id===id);if(i>=0)D.finances.expenses[i]={...D.finances.expenses[i],...o};}
else{o.id=genId();D.finances.expenses.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFinances();
}
function deleteExpense(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.finances.expenses=D.finances.expenses.filter(e=>e.id!==id);saveData(D);toast(t('cfg_saved'));renderFinances();}

function renderFinReceivables(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('fin_receivables')}</h3>
<button class="btn btn-primary btn-sm" onclick="showReceivableForm()">${t('fin_add_receivable')}</button></div>`;
if(!D.finances.receivables.length)return h+emptyState('üìã',t('no_data'));
const pending=D.finances.receivables.filter(r=>!r.paid);const tot=pending.reduce((s,r)=>s+(r.amount||0),0);
h+=`<div class="kpi-grid">${kpi(t('fin_receivables'),fmtMoney(tot),pending.length+' '+t('vac_pending').toLowerCase(),'warning')}</div>`;
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('fin_client')}</th><th>${t('fin_description')}</th><th>${t('fin_amount')}</th><th>${t('fin_due_date')}</th><th>${t('fin_paid')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.finances.receivables.sort((a,b)=>b.date.localeCompare(a.date)).forEach(r=>{
const cl=D.clients.find(c=>c.id===r.clientId);
h+=`<tr><td>${fmtDate(r.date)}</td><td>${cl?cl.name:r.clientName||'-'}</td><td>${r.description||'-'}</td>
<td><strong>${fmtMoney(r.amount)}</strong></td><td>${fmtDate(r.dueDate)}</td>
<td><input type="checkbox" ${r.paid?'checked':''} onchange="toggleReceivablePaid('${r.id}',this.checked)"></td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showReceivableForm('${r.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteReceivable('${r.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';return h;
}
function showReceivableForm(id){
const D=loadData();const r=id?D.finances.receivables.find(x=>x.id===id):null;
openModal(r?t('edit'):t('fin_add_receivable'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="fr-date" value="${r?r.date:todayStr()}"></div>
<div class="form-group"><label>${t('fin_due_date')}</label><input type="date" id="fr-due" value="${r?r.dueDate||'':''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('fin_client')}</label><select id="fr-client">${clientSelect(r?r.clientId:'')}</select></div>
<div class="form-group"><label>${t('fin_amount')}</label><input type="number" id="fr-amt" value="${r?r.amount:''}" min="0"></div></div>
<div class="form-group"><label>${t('fin_description')}</label><input id="fr-desc" value="${r?r.description||'':''}"></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveReceivable('${id||''}')">${t('save')}</button></div>`);
}
function saveReceivable(id){
const D=loadData();const o={date:$('fr-date').value,dueDate:$('fr-due').value,clientId:$('fr-client').value,
amount:parseFloat($('fr-amt').value)||0,description:$('fr-desc').value,paid:false};
if(!o.date){toast(t('required'),true);return;}
if(id){const i=D.finances.receivables.findIndex(r=>r.id===id);if(i>=0){o.paid=D.finances.receivables[i].paid;D.finances.receivables[i]={...D.finances.receivables[i],...o};}}
else{o.id=genId();D.finances.receivables.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderFinances();
}
function toggleReceivablePaid(id,paid){const D=loadData();const r=D.finances.receivables.find(x=>x.id===id);if(r){r.paid=paid;saveData(D);}}
function deleteReceivable(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.finances.receivables=D.finances.receivables.filter(r=>r.id!==id);saveData(D);toast(t('cfg_saved'));renderFinances();}

function renderFinSummary(D){
const mo=todayStr().substring(0,7);
const mInc=D.finances.income.filter(i=>i.date&&i.date.startsWith(mo)).reduce((s,i)=>s+((i.quantity||0)*(i.unitPrice||0)||(i.amount||0)),0);
const mExp=D.finances.expenses.filter(e=>e.date&&e.date.startsWith(mo)).reduce((s,e)=>s+(e.amount||0),0);
const net=mInc-mExp;
const tEggs=D.dailyProduction.reduce((s,p)=>s+(p.eggsCollected||0),0);
const tExp=D.finances.expenses.reduce((s,e)=>s+(e.amount||0),0);
const cpe=tEggs>0?tExp/tEggs:0;
const avgPrice=D.finances.income.length>0?D.finances.income.reduce((s,i)=>s+(i.unitPrice||0),0)/D.finances.income.length:0;
const breakEven=avgPrice>0?Math.ceil(tExp/avgPrice):0;
let h=`<div class="kpi-grid">`;
h+=kpi(t('fin_total_income')+' ('+mo+')',fmtMoney(mInc),'','secondary');
h+=kpi(t('fin_total_expenses')+' ('+mo+')',fmtMoney(mExp),'','danger');
h+=kpi(t('fin_net')+' ('+mo+')',fmtMoney(net),'',net<0?'danger':'');
h+=kpi(t('fin_cost_per_egg'),fmtMoney(cpe),'global','accent');
h+=kpi(t('fin_break_even'),fmtNum(breakEven)+' '+t('eggs_unit'),'global','warning');
h+='</div>';
// Monthly breakdown
const months={};D.finances.income.forEach(i=>{const m=i.date?.substring(0,7);if(!m)return;if(!months[m])months[m]={income:0,expenses:0};months[m].income+=(i.quantity||0)*(i.unitPrice||0)||(i.amount||0);});
D.finances.expenses.forEach(e=>{const m=e.date?.substring(0,7);if(!m)return;if(!months[m])months[m]={income:0,expenses:0};months[m].expenses+=(e.amount||0);});
const mKeys=Object.keys(months).sort().reverse();
if(mKeys.length){
h+='<div class="card"><h3>'+t('fin_summary')+' '+t('fin_month')+'</h3><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('fin_month')}</th><th>${t('fin_income')}</th><th>${t('fin_expenses')}</th><th>${t('fin_net')}</th></tr></thead><tbody>`;
mKeys.forEach(m=>{const d=months[m];const n=d.income-d.expenses;
h+=`<tr><td>${m}</td><td style="color:var(--success)">${fmtMoney(d.income)}</td><td style="color:var(--danger)">${fmtMoney(d.expenses)}</td>
<td style="font-weight:700;color:${n<0?'var(--danger)':'var(--success)'}">${fmtMoney(n)}</td></tr>`;});
h+='</tbody></table></div></div>';}
// Expense by category
const cats={};D.finances.expenses.forEach(e=>{const c=e.category||'other';cats[c]=(cats[c]||0)+(e.amount||0);});
if(Object.keys(cats).length){
h+='<div class="card"><h3>'+t('fin_expenses')+' / '+t('fin_category')+'</h3>';
Object.entries(cats).sort((a,b)=>b[1]-a[1]).forEach(([c,v])=>{const pct=tExp>0?(v/tExp*100):0;
h+=`<div class="stat-row"><span class="stat-label">${t('fin_cat_'+c)||c}</span><span class="stat-value">${fmtMoney(v)} (${fmtNum(pct,1)}%)</span></div>`;});
h+='</div>';}
// CSV export
h+=`<div class="card"><button class="btn btn-secondary" onclick="exportFinCSV()">${t('export_csv')}</button></div>`;
return h;
}
function exportFinCSV(){
const D=loadData();let csv=t('fin_type')+','+t('date')+','+t('fin_category')+','+t('fin_description')+','+t('fin_qty')+','+t('fin_unit_price')+','+t('fin_amount')+'\n';
D.finances.income.forEach(i=>{const a=(i.quantity||0)*(i.unitPrice||0);csv+=`${t('csv_income')},${i.date},${i.type||''},${(i.notes||'').replace(/,/g,';')},${i.quantity||0},${i.unitPrice||0},${a}\n`;});
D.finances.expenses.forEach(e=>{csv+=`${t('csv_expense')},${e.date},${e.category||''},${(e.description||'').replace(/,/g,';')},,,${e.amount||0}\n`;});
const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);
a.download='egglogu_finanzas_'+todayStr()+'.csv';a.click();toast(t('cfg_exported'));
}
// === END FINANCES ===

// === ANALYSIS MODULE ===
let currentAnaTab='comparison';
function renderAnalysis(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('ana_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentAnaTab==='comparison'?' active':''}" onclick="currentAnaTab='comparison';renderAnalysis()">üîÑ ${t('ana_comparison')}</div>
<div class="tab${currentAnaTab==='seasonality'?' active':''}" onclick="currentAnaTab='seasonality';renderAnalysis()">üìÖ ${t('ana_seasonality')}</div>
<div class="tab${currentAnaTab==='profitability'?' active':''}" onclick="currentAnaTab='profitability';renderAnalysis()">üí∞ ${t('ana_profitability')}</div>
<div class="tab${currentAnaTab==='kpi_evo'?' active':''}" onclick="currentAnaTab='kpi_evo';renderAnalysis()">üìä ${t('ana_kpi_evolution')}</div>
<div class="tab${currentAnaTab==='predictions'?' active':''}" onclick="currentAnaTab='predictions';renderAnalysis()">ü§ñ ${t('pred_title')}</div></div>`;
if(currentAnaTab==='comparison')h+=renderAnaComparison(D);
else if(currentAnaTab==='seasonality')h+=renderAnaSeasonality(D);
else if(currentAnaTab==='profitability')h+=renderAnaProfitability(D);
else if(currentAnaTab==='predictions')h+=renderPredictionsTab(D);
else h+=renderAnaKpiEvo(D);
$('sec-analisis').innerHTML=h;
}
function renderAnaComparison(D){
if(!D.flocks.length)return emptyState('üîÑ',t('no_data'));
let h='<div class="card"><h3>'+t('ana_comparison')+'</h3><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('flock_name')}</th><th>${t('flock_count')}</th><th>${t('flock_current')}</th><th>${t('kpi_henday')} (7d)</th><th>FCR (30d)</th><th>${t('kpi_mortality')} %</th><th>${t('flock_health')}</th></tr></thead><tbody>`;
const stats=D.flocks.map(f=>{
const cur=activeHensByFlock(f.id);const l7=D.dailyProduction.filter(p=>p.flockId===f.id).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const avgE=l7.length>0?l7.reduce((s,p)=>s+(p.eggsCollected||0),0)/l7.length:0;
const hd=cur>0?(avgE/cur*100):0;
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const f30=D.feed.consumption.filter(c=>c.flockId===f.id&&c.date>=d30s);const e30=D.dailyProduction.filter(p=>p.flockId===f.id&&p.date>=d30s);
const tfkg=f30.reduce((s,c)=>s+(c.quantityKg||0),0);const tekg=e30.reduce((s,p)=>s+(p.eggsCollected||0),0)*0.06;
const fcr=tekg>0?tfkg/tekg:0;
const deaths=D.dailyProduction.filter(p=>p.flockId===f.id).reduce((s,p)=>s+(p.deaths||0),0);
const mort=f.count>0?(deaths/f.count*100):0;const hs=healthScore(f.id);
return{f,cur,hd,fcr,mort,hs};
});
stats.sort((a,b)=>b.hd-a.hd);
stats.forEach(s=>{
h+=`<tr><td><strong>${s.f.name}</strong></td><td>${fmtNum(s.f.count)}</td><td>${fmtNum(s.cur)}</td>
<td style="color:${s.hd>=80?'var(--success)':s.hd>=60?'var(--warning)':'var(--danger)'}">${fmtNum(s.hd,1)}%</td>
<td>${s.fcr>0?fmtNum(s.fcr,2):'-'}</td><td>${fmtNum(s.mort,1)}%</td><td>${healthBadge(s.hs)}</td></tr>`;});
h+='</tbody></table></div></div>';
if(stats.length>=2){
h+=`<div class="kpi-grid">${kpi(t('ana_best_flock'),stats[0].f.name,'Hen-Day: '+fmtNum(stats[0].hd,1)+'%')}`;
h+=kpi(t('ana_worst_flock'),stats[stats.length-1].f.name,'Hen-Day: '+fmtNum(stats[stats.length-1].hd,1)+'%','danger');
h+='</div>';}
return h;
}
function renderAnaSeasonality(D){
const months={};D.dailyProduction.forEach(p=>{const m=p.date?.substring(5,7);if(!m)return;if(!months[m])months[m]={eggs:0,days:new Set()};months[m].eggs+=(p.eggsCollected||0);months[m].days.add(p.date);});
if(!Object.keys(months).length)return emptyState('üìÖ',t('no_data'));
const mNames=LANG==='es'?['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic']:LANG==='pt'?['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez']:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
let h='<div class="card"><h3>'+t('ana_seasonality')+'</h3><div class="chart-container"><canvas id="chart-season"></canvas></div></div>';
h+='<div class="card"><div class="table-wrap"><table><thead><tr><th>'+t('fin_month')+'</th><th>'+t('prod_eggs')+'</th><th>'+t('avg_per_day')+'</th></tr></thead><tbody>';
for(let i=1;i<=12;i++){const k=String(i).padStart(2,'0');const d=months[k];
const avg=d?Math.round(d.eggs/d.days.size):0;
h+=`<tr><td>${mNames[i-1]}</td><td>${d?fmtNum(d.eggs):'-'}</td><td>${d?fmtNum(avg):'-'}</td></tr>`;}
h+='</tbody></table></div></div>';
$('sec-analisis').innerHTML?.includes('chart-season')||setTimeout(()=>{
const c=document.getElementById('chart-season');if(!c)return;
const labels=mNames;const vals=[];for(let i=1;i<=12;i++){const k=String(i).padStart(2,'0');const d=months[k];vals.push(d?Math.round(d.eggs/d.days.size):0);}
CHARTS.season=new Chart(c,{type:'bar',data:{labels,datasets:[{label:t('avg_per_day'),data:vals,backgroundColor:themeColor('--primary-light')}]},options:{responsive:true,maintainAspectRatio:false}});
},100);
return h;
}
function renderAnaProfitability(D){
if(!D.flocks.length)return emptyState('üí∞',t('no_data'));
let h='<div class="card"><h3>'+t('ana_profitability')+' / '+t('per_flock')+'</h3><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('flock_name')}</th><th>${t('prod_eggs')}</th><th>${t('fin_income')}</th><th>${t('fin_expenses')}</th><th>${t('fin_net')}</th><th>${t('fin_cost_per_egg')}</th></tr></thead><tbody>`;
D.flocks.forEach(f=>{
const eggs=D.dailyProduction.filter(p=>p.flockId===f.id).reduce((s,p)=>s+(p.eggsCollected||0),0);
const feedCost=D.feed.consumption.filter(c=>c.flockId===f.id).reduce((s,c)=>{
const price=D.feed.purchases.length>0?D.feed.purchases.reduce((s,p)=>s+(p.cost||0),0)/D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0):0;
return s+(c.quantityKg||0)*price;},0);
const inc=eggs*(D.finances.income.length>0?D.finances.income.reduce((s,i)=>s+(i.unitPrice||0),0)/D.finances.income.length:0);
const net=inc-feedCost-(f.cost||0);const cpe=eggs>0?(feedCost+(f.cost||0))/eggs:0;
h+=`<tr><td><strong>${f.name}</strong></td><td>${fmtNum(eggs)}</td><td style="color:var(--success)">${fmtMoney(inc)}</td>
<td style="color:var(--danger)">${fmtMoney(feedCost+(f.cost||0))}</td>
<td style="font-weight:700;color:${net<0?'var(--danger)':'var(--success)'}">${fmtMoney(net)}</td><td>${fmtMoney(cpe)}</td></tr>`;});
h+='</tbody></table></div></div>';
// Profitability by Egg Type
const typeGroups={};const channelGroups={};
D.dailyProduction.forEach(p=>{
const et=p.eggType||'conventional';const mc=p.marketChannel||'wholesale';
if(!typeGroups[et])typeGroups[et]={eggs:0,revenue:0};
if(!channelGroups[mc])channelGroups[mc]={eggs:0,revenue:0};
const eggs=p.eggsCollected||0;
const avgPrice=D.finances.income.length>0?D.finances.income.reduce((s,i)=>s+(i.unitPrice||0),0)/D.finances.income.length:0;
typeGroups[et].eggs+=eggs;typeGroups[et].revenue+=eggs*avgPrice;
channelGroups[mc].eggs+=eggs;channelGroups[mc].revenue+=eggs*avgPrice;
});
if(Object.keys(typeGroups).length>1||D.dailyProduction.some(p=>p.eggType)){
h+=`<div class="card"><h3>${t('ana_segment_profit')}</h3>`;
h+=`<h4 style="margin:8px 0">${t('prod_egg_type')}</h4><div class="table-wrap"><table><thead><tr><th>${t('prod_egg_type')}</th><th>${t('prod_eggs')}</th><th>${t('fin_income')}</th></tr></thead><tbody>`;
Object.entries(typeGroups).forEach(([k,v])=>{h+=`<tr><td>${t('prod_type_'+k)}</td><td>${fmtNum(v.eggs)}</td><td style="color:var(--success)">${fmtMoney(v.revenue)}</td></tr>`;});
h+='</tbody></table></div>';
h+=`<h4 style="margin:12px 0 8px">${t('prod_market')}</h4><div class="table-wrap"><table><thead><tr><th>${t('prod_market')}</th><th>${t('prod_eggs')}</th><th>${t('fin_income')}</th></tr></thead><tbody>`;
Object.entries(channelGroups).forEach(([k,v])=>{h+=`<tr><td>${t('prod_market_'+k)}</td><td>${fmtNum(v.eggs)}</td><td style="color:var(--success)">${fmtMoney(v.revenue)}</td></tr>`;});
h+='</tbody></table></div></div>';}
return h;
}
function renderAnaKpiEvo(D){
if(!D.kpiSnapshots.length)return emptyState('üìä',t('ana_no_snapshots'));
let h='<div class="card"><h3>'+t('ana_kpi_evolution')+'</h3><div class="chart-container"><canvas id="chart-kpi-evo"></canvas></div></div>';
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('kpi_active_hens')}</th><th>Hen-Day %</th><th>FCR</th><th>${t('kpi_mortality')} %</th><th>${t('kpi_cost_egg')}</th><th>${t('kpi_income_net')}</th></tr></thead><tbody>`;
D.kpiSnapshots.slice(-20).reverse().forEach(s=>{
h+=`<tr><td>${fmtDate(s.date)}</td><td>${fmtNum(s.activeHens)}</td><td>${fmtNum(s.henDay,1)}%</td>
<td>${fmtNum(s.fcr,2)}</td><td>${fmtNum(s.mortality,1)}%</td><td>${fmtMoney(s.costPerEgg)}</td><td>${fmtMoney(s.netIncome)}</td></tr>`;});
h+='</tbody></table></div></div>';
setTimeout(()=>{
const c=document.getElementById('chart-kpi-evo');if(!c)return;
const snaps=D.kpiSnapshots.slice(-30);
CHARTS.kpiEvo=new Chart(c,{type:'line',data:{labels:snaps.map(s=>s.date.substring(5)),datasets:[
{label:'Hen-Day %',data:snaps.map(s=>s.henDay),borderColor:themeColor('--primary'),tension:.3,yAxisID:'y'},
{label:'FCR',data:snaps.map(s=>s.fcr),borderColor:'#FF8F00',tension:.3,yAxisID:'y1'},
{label:t('kpi_mortality')+' %',data:snaps.map(s=>s.mortality),borderColor:'#C62828',tension:.3,yAxisID:'y'}
]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
scales:{y:{position:'left',min:0},y1:{position:'right',grid:{drawOnChartArea:false}}}}});
},100);
return h;
}
// === END ANALYSIS ===

// === OPERATIONS MODULE ===
function renderOperations(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('ops_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentOpsTab==='checklist'?' active':''}" onclick="currentOpsTab='checklist';renderOperations()">‚úÖ ${t('ops_checklist')}</div>
<div class="tab${currentOpsTab==='logbook'?' active':''}" onclick="currentOpsTab='logbook';renderOperations()">üìì ${t('ops_logbook')}</div>
<div class="tab${currentOpsTab==='personnel'?' active':''}" onclick="currentOpsTab='personnel';renderOperations()">üë∑ ${t('ops_personnel')}</div></div>`;
if(currentOpsTab==='checklist')h+=renderOpsChecklist(D);
else if(currentOpsTab==='logbook')h+=renderOpsLogbook(D);
else h+=renderOpsPersonnel(D);
$('sec-operaciones').innerHTML=h;
}
function renderOpsChecklist(D){
const today=todayStr();
let todayItems=D.checklist.filter(c=>c.date===today);
if(!todayItems.length&&D.settings.defaultChecklist){
D.settings.defaultChecklist.forEach(task=>{
D.checklist.push({id:genId(),date:today,task,done:false});});
todayItems=D.checklist.filter(c=>c.date===today);saveData(D);
}
const done=todayItems.filter(c=>c.done).length;const total=todayItems.length;
let h=`<div class="kpi-grid">${kpi(t('ops_done'),done+'/'+total,total>0?fmtNum(done/total*100,0)+'%':'',done===total&&total>0?'':'warning')}</div>`;
h+=`<div class="card"><h3>${t('ops_checklist')} ‚Äî ${fmtDate(today)}</h3>`;
todayItems.forEach(c=>{
h+=`<div class="checklist-item${c.done?' done':''}"><input type="checkbox" ${c.done?'checked':''} onchange="toggleCheck('${c.id}',this.checked)"><span>${t(c.task)}</span>
<button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="deleteCheck('${c.id}')">‚úï</button></div>`;});
h+=`<div style="margin-top:12px;display:flex;gap:8px"><input id="new-task" placeholder="${t('ops_task')}" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:var(--radius)">
<button class="btn btn-primary btn-sm" onclick="addCheckTask()">${t('add')}</button></div></div>`;
// History
const dates=[...new Set(D.checklist.map(c=>c.date))].sort().reverse().filter(d=>d!==today).slice(0,7);
if(dates.length){
h+='<div class="card"><h3>'+t('history')+'</h3>';
dates.forEach(d=>{const items=D.checklist.filter(c=>c.date===d);const dn=items.filter(c=>c.done).length;
h+=`<div class="stat-row"><span class="stat-label">${fmtDate(d)}</span><span class="stat-value">${dn}/${items.length} (${items.length>0?fmtNum(dn/items.length*100,0):0}%)</span></div>`;});
h+='</div>';}
return h;
}
function toggleCheck(id,done){const D=loadData();const c=D.checklist.find(x=>x.id===id);if(c){c.done=done;saveData(D);renderOperations();}}
function deleteCheck(id){const D=loadData();D.checklist=D.checklist.filter(c=>c.id!==id);saveData(D);renderOperations();}
function addCheckTask(){const v=$('new-task')?.value;if(!v)return;const D=loadData();D.checklist.push({id:genId(),date:todayStr(),task:v,done:false});saveData(D);renderOperations();}

function renderOpsLogbook(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('ops_logbook')}</h3>
<button class="btn btn-primary btn-sm" onclick="showLogForm()">${t('ops_log_add')}</button></div>`;
if(!D.logbook.length)return h+emptyState('üìì',t('no_data'));
const cats=['general','health','production','maintenance','observation'];
h+=`<div class="filter-bar"><select id="lf-cat" onchange="renderOperations()"><option value="">${t('all')}</option>${cats.map(c=>`<option value="${c}">${t('ops_log_cat_'+c)}</option>`).join('')}</select></div>`;
const selCat=document.getElementById('lf-cat')?.value||'';
let logs=D.logbook.sort((a,b)=>b.date.localeCompare(a.date));
if(selCat)logs=logs.filter(l=>l.category===selCat);
h+='<div class="card">';
logs.forEach(l=>{
h+=`<div class="alert-card alert-info" style="flex-wrap:wrap"><div style="flex:1"><strong>${fmtDate(l.date)}</strong> ‚Äî <span class="badge badge-info">${t('ops_log_cat_'+l.category)||l.category}</span>
<p style="margin-top:4px">${l.entry}</p></div>
<div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showLogForm('${l.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteLog('${l.id}')">${t('delete')}</button></div></div>`;});
h+='</div>';return h;
}
function showLogForm(id){
const D=loadData();const l=id?D.logbook.find(x=>x.id===id):null;
const cats=['general','health','production','maintenance','observation'];
openModal(l?t('edit'):t('ops_log_add'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="lg-date" value="${l?l.date:todayStr()}"></div>
<div class="form-group"><label>${t('ops_log_category')}</label><select id="lg-cat">${cats.map(c=>`<option value="${c}"${l&&l.category===c?' selected':''}>${t('ops_log_cat_'+c)}</option>`).join('')}</select></div></div>
<div class="form-group"><label>${t('ops_log_entry')}</label><textarea id="lg-entry" rows="4">${l?l.entry||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveLog('${id||''}')">${t('save')}</button></div>`);
}
function saveLog(id){
const D=loadData();const o={date:$('lg-date').value,category:$('lg-cat').value,entry:$('lg-entry').value};
if(!o.entry){toast(t('required'),true);return;}
if(id){const i=D.logbook.findIndex(l=>l.id===id);if(i>=0)D.logbook[i]={...D.logbook[i],...o};}
else{o.id=genId();D.logbook.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderOperations();
}
function deleteLog(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.logbook=D.logbook.filter(l=>l.id!==id);saveData(D);toast(t('cfg_saved'));renderOperations();}

function renderOpsPersonnel(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('ops_personnel')}</h3>
<button class="btn btn-primary btn-sm" onclick="showPersonnelForm()">${t('ops_per_add')}</button></div>`;
if(!D.personnel.length)return h+emptyState('üë∑',t('no_data'));
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('ops_per_name')}</th><th>${t('ops_per_role')}</th><th>${t('ops_per_salary')}</th><th>${t('ops_per_start')}</th><th>${t('ops_per_active')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.personnel.forEach(p=>{
h+=`<tr><td><strong>${p.name}</strong></td><td>${p.role||'-'}</td><td>${fmtMoney(p.salary||0)}</td><td>${fmtDate(p.startDate)}</td>
<td>${p.active?'<span class="badge badge-success">'+t('active')+'</span>':'<span class="badge badge-secondary">'+t('inactive')+'</span>'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showPersonnelForm('${p.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deletePersonnel('${p.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';
const totalSalary=D.personnel.filter(p=>p.active).reduce((s,p)=>s+(p.salary||0),0);
h+=`<div class="kpi-grid">${kpi(t('total_salaries'),fmtMoney(totalSalary),D.personnel.filter(p=>p.active).length+' '+t('active').toLowerCase())}</div>`;
return h;
}
function showPersonnelForm(id){
const D=loadData();const p=id?D.personnel.find(x=>x.id===id):null;
openModal(p?t('edit'):t('ops_per_add'),`
<div class="form-row"><div class="form-group"><label>${t('ops_per_name')}</label><input id="pe-name" value="${p?p.name:''}"></div>
<div class="form-group"><label>${t('ops_per_role')}</label><select id="pe-role">${catalogSelect(CATALOGS.personnelRoles,p?p.role||'':'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('ops_per_salary')}</label><input type="number" id="pe-salary" value="${p?p.salary||'':''}" min="0"></div>
<div class="form-group"><label>${t('ops_per_start')}</label><input type="date" id="pe-start" value="${p?p.startDate||'':''}"></div></div>
<div class="form-group"><label>${t('ops_per_active')}</label><select id="pe-active">
<option value="1"${!p||p.active?' selected':''}>${t('active')}</option>
<option value="0"${p&&!p.active?' selected':''}>${t('inactive')}</option></select></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="pe-notes">${p?p.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="savePersonnel('${id||''}')">${t('save')}</button></div>`);
}
function savePersonnel(id){
const D=loadData();const o={name:$('pe-name').value,role:$('pe-role').value,
salary:parseFloat($('pe-salary').value)||0,startDate:$('pe-start').value,
active:$('pe-active').value==='1',notes:$('pe-notes').value};
if(!o.name){toast(t('required'),true);return;}
if(id){const i=D.personnel.findIndex(p=>p.id===id);if(i>=0)D.personnel[i]={...D.personnel[i],...o};}
else{o.id=genId();D.personnel.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderOperations();
}
function deletePersonnel(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.personnel=D.personnel.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderOperations();}
// === END OPERATIONS ===

// === ENVIRONMENT MODULE ===
let currentEnvTab='manual';
function renderEnvironment(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('env_title')}</h2></div>`;
h+=`<div class="tabs"><div class="tab${currentEnvTab==='manual'?' active':''}" onclick="currentEnvTab='manual';renderEnvironment()">üìù ${t('env_manual')}</div>
<div class="tab${currentEnvTab==='iot'?' active':''}" onclick="currentEnvTab='iot';renderEnvironment()">üì° ${t('iot_title')}</div>
<div class="tab${currentEnvTab==='history'?' active':''}" onclick="currentEnvTab='history';renderEnvironment()">üìä ${t('env_history')}</div></div>`;
if(currentEnvTab==='manual')h+=renderEnvManual(D);
else if(currentEnvTab==='iot')h+=renderEnvIoT(D);
else h+=renderEnvHistory(D);
$('sec-ambiente').innerHTML=h;if(currentEnvTab==='iot')updateIoTGauges();
}
function renderEnvManual(D){
let h=`<div style="text-align:right;margin-bottom:8px"><button class="btn btn-primary" onclick="showEnvForm()">${t('env_add')}</button></div>`;
h+=`<div class="card"><h3>${t('env_optimal')}</h3><div class="kpi-grid">
${kpi(t('env_temp'),t('env_temp_range'),'','')}</div><div class="kpi-grid">
${kpi(t('env_humidity'),t('env_humidity_range'),'','')}
${kpi(t('env_light'),t('env_light_range'),'','')}
${kpi(t('env_density'),t('env_density_range'),'','')}</div></div>`;
const latest=D.environment.sort((a,b)=>b.date.localeCompare(a.date))[0];
if(latest){
const tOk=latest.temperature>=18&&latest.temperature<=24;const hOk=latest.humidity>=40&&latest.humidity<=70;
const lOk=latest.lightHours>=14&&latest.lightHours<=16;
h+=`<div class="card"><h3>${t('env_latest_reading')} (${fmtDate(latest.date)})</h3><div class="kpi-grid">`;
h+=`<div class="kpi-card ${tOk?'':'danger'}"><div class="kpi-label">${t('env_temp')}</div><div class="kpi-value">${latest.temperature||'-'}¬∞C</div><div class="kpi-sub">${tOk?'‚úì '+t('env_ok'):'‚ö† '+t('env_out_of_range')}</div></div>`;
h+=`<div class="kpi-card ${hOk?'':'warning'}"><div class="kpi-label">${t('env_humidity')}</div><div class="kpi-value">${latest.humidity||'-'}%</div><div class="kpi-sub">${hOk?'‚úì '+t('env_ok'):'‚ö† '+t('env_out_of_range')}</div></div>`;
h+=`<div class="kpi-card ${lOk?'':'warning'}"><div class="kpi-label">${t('env_light')}</div><div class="kpi-value">${latest.lightHours||'-'} hrs</div><div class="kpi-sub">${lOk?'‚úì '+t('env_ok'):'‚ö† '+t('env_out_of_range')}</div></div>`;
if(latest.temperature&&latest.humidity){const thi=calcTHI(latest.temperature,latest.humidity);
h+=`<div class="kpi-card ${thi>28?'danger':thi>25?'warning':''}"><div class="kpi-label">${t('env_thi')}</div><div class="kpi-value">${thi.toFixed(1)}</div><div class="kpi-sub">${thi>28?t('weather_heat_alert'):'OK'}</div></div>`;}
h+='</div></div>';}
if(!D.environment.length)h+=emptyState('üå°Ô∏è',t('no_data'),t('env_add'),'showEnvForm()');
else{
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('env_temp')}</th><th>${t('env_humidity')}</th><th>${t('env_light')}</th><th>${t('env_ammonia')}</th><th>THI</th><th>${t('notes')}</th><th>${t('actions')}</th>`;
h+='</tr></thead><tbody>';
D.environment.sort((a,b)=>b.date.localeCompare(a.date)).slice(0,20).forEach(e=>{
const tOk=e.temperature>=18&&e.temperature<=24;const hOk=e.humidity>=40&&e.humidity<=70;
const thi=(e.temperature&&e.humidity)?calcTHI(e.temperature,e.humidity):null;
h+=`<tr><td>${fmtDate(e.date)}</td><td style="color:${tOk?'var(--success)':'var(--danger)'}">${e.temperature||'-'}¬∞C</td>
<td style="color:${hOk?'var(--success)':'var(--warning)'}">${e.humidity||'-'}%</td>
<td>${e.lightHours||'-'} hrs</td><td>${e.ammoniaLevel||'-'} ppm</td>
<td>${thi?thi.toFixed(1):'-'}</td><td>${e.notes||'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showEnvForm('${e.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteEnv('${e.id}')">${t('delete')}</button></div></td></tr>`;});
h+='</tbody></table></div></div>';}
return h;
}
function renderEnvIoT(D){
let h='';
if(!D.farm.mqttBroker){return `<div class="card"><p>${t('iot_no_config')}</p>
<button class="btn btn-primary" onclick="nav('config')">${t('cfg_title')}</button></div>`;}
h+=`<div class="card"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
<div id="mqtt-indicator"></div>
<button class="btn btn-primary btn-sm" onclick="connectMQTT()">${t('iot_connect')}</button>
<button class="btn btn-secondary btn-sm" onclick="disconnectMQTT()">${t('iot_disconnect')}</button></div>
<div id="iot-gauges"><p style="color:var(--text-light)">${t('iot_no_config')}</p></div></div>`;
return h;
}
function renderEnvHistory(D){
let h='';
if(!D.environment.length)return emptyState('üìä',t('no_data'));
h+='<div class="card"><h3>'+t('env_history')+'</h3><div class="chart-container"><canvas id="chart-env"></canvas></div></div>';
setTimeout(()=>{
const c=document.getElementById('chart-env');if(!c)return;
const recs=D.environment.sort((a,b)=>a.date.localeCompare(b.date)).slice(-30);
CHARTS.env=new Chart(c,{type:'line',data:{labels:recs.map(r=>r.date.substring(5)),datasets:[
{label:t('env_temp')+' ¬∞C',data:recs.map(r=>r.temperature),borderColor:'#C62828',tension:.3,yAxisID:'y'},
{label:t('env_humidity')+' %',data:recs.map(r=>r.humidity),borderColor:themeColor('--primary'),tension:.3,yAxisID:'y1'}
]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
scales:{y:{position:'left',title:{display:true,text:'¬∞C'}},y1:{position:'right',title:{display:true,text:'%'},grid:{drawOnChartArea:false}}}}});
},100);
h+='<div class="card"><div class="table-wrap"><table><thead><tr>';
h+=`<th>${t('date')}</th><th>${t('env_temp')}</th><th>${t('env_humidity')}</th><th>${t('env_light')}</th><th>${t('env_ammonia')}</th><th>THI</th><th>${t('notes')}</th></tr></thead><tbody>`;
D.environment.sort((a,b)=>b.date.localeCompare(a.date)).forEach(e=>{
const thi=(e.temperature&&e.humidity)?calcTHI(e.temperature,e.humidity):null;
h+=`<tr><td>${fmtDate(e.date)}</td><td>${e.temperature||'-'}¬∞C</td><td>${e.humidity||'-'}%</td>
<td>${e.lightHours||'-'} hrs</td><td>${e.ammoniaLevel||'-'} ppm</td><td>${thi?thi.toFixed(1):'-'}</td><td>${e.notes||'-'}</td></tr>`;});
h+='</tbody></table></div></div>';
return h;
}
function showEnvForm(id){
const D=loadData();const e=id?D.environment.find(x=>x.id===id):null;
openModal(e?t('edit'):t('env_add'),`
<div class="form-group"><label>${t('date')}</label><input type="date" id="en-date" value="${e?e.date:todayStr()}"></div>
<div class="form-row"><div class="form-group"><label>${t('env_temp')}</label><input type="number" id="en-temp" value="${e?e.temperature||'':''}" step="0.1"></div>
<div class="form-group"><label>${t('env_humidity')}</label><input type="number" id="en-hum" value="${e?e.humidity||'':''}" step="1" min="0" max="100"></div></div>
<div class="form-row"><div class="form-group"><label>${t('env_light')}</label><input type="number" id="en-light" value="${e?e.lightHours||'':''}" step="0.5" min="0" max="24"></div>
<div class="form-group"><label>${t('env_ammonia')} (ppm)</label><input type="number" id="en-ammonia" value="${e?e.ammoniaLevel||'':''}" step="0.1" min="0"></div></div>
<div class="form-group"><label>${t('env_ventilation')}</label><select id="en-vent">${catalogSelect(CATALOGS.ventilationLevels,e?e.ventilation||'':'',false)}</select></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="en-notes">${e?e.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveEnv('${id||''}')">${t('save')}</button></div>`);
}
function saveEnv(id){
const D=loadData();const o={date:$('en-date').value,temperature:parseFloat($('en-temp').value)||null,
humidity:parseFloat($('en-hum').value)||null,lightHours:parseFloat($('en-light').value)||null,
ammoniaLevel:parseFloat($('en-ammonia')?.value)||null,
ventilation:$('en-vent').value,notes:$('en-notes').value};
if(!o.date){toast(t('required'),true);return;}
if(id){const i=D.environment.findIndex(e=>e.id===id);if(i>=0)D.environment[i]={...D.environment[i],...o};}
else{o.id=genId();D.environment.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderEnvironment();
}
function deleteEnv(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.environment=D.environment.filter(e=>e.id!==id);saveData(D);toast(t('cfg_saved'));renderEnvironment();}
// === END ENVIRONMENT ===

// === CONFIG MODULE ===
function renderConfig(){
const D=loadData();
let h=`<div class="page-header"><h2>${t('cfg_title')}</h2></div>`;
// Theme picker
const curTheme=localStorage.getItem('egglogu_theme')||'blue';
h+='<div class="card"><h3>'+t('cfg_theme')+'</h3><div style="display:flex;gap:12px;flex-wrap:wrap">';
Object.keys(THEMES).forEach(name=>{const th=THEMES[name];const active=curTheme===name;
h+='<button onclick="applyTheme(\''+name+'\');nav(\'config\')" style="width:90px;height:64px;border-radius:var(--radius);border:'+(active?'3px solid var(--secondary)':'2px solid var(--border)')+';background:'+th['sidebar-bg']+';color:#fff;cursor:pointer;font-weight:'+(active?'700':'400')+';font-size:13px;transition:all .2s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px"><span style="width:24px;height:24px;border-radius:50%;background:'+th.primary+';border:2px solid rgba(255,255,255,.5)"></span>'+t('cfg_theme_'+name)+'</button>';});
h+='</div></div>';
// Accessibility: Font size + Dark mode
const curScale=D.settings.fontScale||'normal';
h+=`<div class="card"><h3>‚ôø ${t('cfg_accessibility')}</h3>
<div class="form-group"><label>${t('cfg_font_size')}</label>
<div style="display:flex;gap:8px;flex-wrap:wrap">
${['small','normal','large','xlarge'].map(s=>`<button class="btn btn-sm${curScale===s?' btn-primary':' btn-secondary'}" onclick="applyFontScale('${s}');const D=loadData();D.settings.fontScale='${s}';saveData(D);nav('config')">${t('cfg_font_'+s)}</button>`).join('')}
</div></div>
<div class="form-group" style="margin-top:12px"><label>${t('cfg_dark_mode')}</label>
<button class="btn btn-sm${D.settings.darkMode?' btn-primary':' btn-secondary'}" onclick="const D=loadData();D.settings.darkMode=!D.settings.darkMode;saveData(D);applyDarkMode(D.settings.darkMode);nav('config')">${D.settings.darkMode?'üåô ON':'‚òÄÔ∏è OFF'}</button>
</div></div>`;
// Farm info
h+=`<div class="card"><h3>${t('cfg_farm')}</h3>
<div class="form-row"><div class="form-group"><label>${t('cfg_farm_name')}</label><input id="cfg-name" value="${D.farm.name||''}"></div>
<div class="form-group"><label>${t('cfg_location')}</label><input id="cfg-loc" value="${D.farm.location||''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('cfg_capacity')}</label><input type="number" id="cfg-cap" value="${D.farm.capacity||''}" min="0"></div>
<div class="form-group"><label>${t('cfg_currency')}</label><input id="cfg-cur" value="${D.farm.currency||'$'}" maxlength="5"></div></div>
<button class="btn btn-primary" onclick="saveConfig()">${t('save')}</button></div>`;
// Geolocation
h+=`<div class="card"><h3>${t('geo_set_location')}</h3>
<p style="color:var(--text-light);margin-bottom:8px">${D.farm.lat?t('geo_lat')+': '+D.farm.lat+' | '+t('geo_lng')+': '+D.farm.lng:t('geo_click_map')}</p>
<button class="btn btn-secondary" onclick="showGeoModal()">${t('geo_set_location')}</button></div>`;
// Weather API
h+=`<div class="card"><h3>${t('weather_title')} (OpenWeatherMap)</h3>
<div class="form-row"><div class="form-group"><label>API Key</label><input id="cfg-owm" value="${D.farm.owmApiKey||''}"></div>
<div class="form-group" style="display:flex;align-items:flex-end"><button class="btn btn-secondary" onclick="testWeatherApi()">Test</button></div></div>
<button class="btn btn-primary" onclick="saveWeatherConfig()">${t('save')}</button></div>`;
// MQTT / IoT
h+=`<div class="card"><h3>${t('iot_title')} (MQTT)</h3>
<div class="form-group"><label>${t('iot_broker')} (wss://)</label><input id="cfg-mqtt-broker" value="${D.farm.mqttBroker||''}" placeholder="wss://broker.example.com:8084/mqtt"></div>
<div class="form-row"><div class="form-group"><label>${t('cfg_farm_name')} (user)</label><input id="cfg-mqtt-user" value="${D.farm.mqttUser||''}"></div>
<div class="form-group"><label>Password</label><input type="password" id="cfg-mqtt-pass" value="${D.farm.mqttPass||''}"></div></div>
<div class="form-group"><label>Topic Prefix</label><input id="cfg-mqtt-prefix" value="${D.farm.mqttTopicPrefix||'egglogu/'}"></div>
<button class="btn btn-primary" onclick="saveMqttConfig()">${t('save')}</button></div>`;
// Alert thresholds
h+=`<div class="card"><h3>${t('cfg_alerts')}</h3>
<div class="form-row-3"><div class="form-group"><label>${t('cfg_min_feed')}</label><input type="number" id="cfg-minfeed" value="${D.settings.minFeedStock||50}" min="0"></div>
<div class="form-group"><label>${t('cfg_max_mortality')}</label><input type="number" id="cfg-maxmort" value="${D.settings.maxMortality||5}" min="0" step="0.5"></div>
<div class="form-group"><label>${t('cfg_alert_days')}</label><input type="number" id="cfg-alertdays" value="${D.settings.alertDaysBefore||3}" min="1"></div></div>
<button class="btn btn-primary" onclick="saveAlertConfig()">${t('save')}</button></div>`;
// Default checklist
h+=`<div class="card"><h3>${t('cfg_checklist')}</h3><p style="color:var(--text-light);font-size:13px;margin-bottom:12px">${t('cfg_checklist_items')}</p>`;
(D.settings.defaultChecklist||[]).forEach((task,i)=>{
h+=`<div class="checklist-item"><span>${t(task)}</span><button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="removeChecklistItem(${i})">‚úï</button></div>`;});
h+=`<div style="margin-top:12px;display:flex;gap:8px"><input id="cfg-newtask" placeholder="${t('ops_task')}" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:var(--radius)">
<button class="btn btn-primary btn-sm" onclick="addChecklistItem()">${t('add')}</button></div></div>`;
// Data management
h+=`<div class="card"><h3>${t('cfg_data')}</h3><div class="btn-group">
<button class="btn btn-secondary" onclick="exportData()">${t('cfg_export')}</button>
<button class="btn btn-secondary" onclick="$('cfg-import-file').click()">${t('cfg_import')}</button>
<input type="file" id="cfg-import-file" accept=".json" style="display:none" onchange="importData(event)">
<button class="btn btn-danger" onclick="resetData()">${t('cfg_reset')}</button></div></div>`;
// Stats
const stats={flocks:D.flocks.length,production:D.dailyProduction.length,vaccines:D.vaccines.length,
medications:D.medications.length,outbreaks:D.outbreaks.length,feedPurchases:D.feed.purchases.length,
feedConsumption:D.feed.consumption.length,clients:D.clients.length,income:D.finances.income.length,
expenses:D.finances.expenses.length,environment:D.environment.length,logbook:D.logbook.length,
personnel:D.personnel.length,snapshots:D.kpiSnapshots.length};
h+='<div class="card"><h3>'+t('data_stats')+'</h3>';
Object.entries(stats).forEach(([k,v])=>{h+=`<div class="stat-row"><span class="stat-label">${k}</span><span class="stat-value">${v}</span></div>`;});
h+='</div>';
$('sec-config').innerHTML=h;
}
function saveConfig(){
const D=loadData();D.farm.name=$('cfg-name').value;D.farm.location=$('cfg-loc').value;
D.farm.capacity=parseInt($('cfg-cap').value)||0;D.farm.currency=$('cfg-cur').value||'$';
saveData(D);toast(t('cfg_saved'));
}
function saveAlertConfig(){
const D=loadData();D.settings.minFeedStock=parseFloat($('cfg-minfeed').value)||50;
D.settings.maxMortality=parseFloat($('cfg-maxmort').value)||5;
D.settings.alertDaysBefore=parseInt($('cfg-alertdays').value)||3;
saveData(D);toast(t('cfg_saved'));
}
function addChecklistItem(){const v=$('cfg-newtask')?.value;if(!v)return;const D=loadData();if(!D.settings.defaultChecklist)D.settings.defaultChecklist=[];D.settings.defaultChecklist.push(v);saveData(D);renderConfig();}
function removeChecklistItem(i){const D=loadData();D.settings.defaultChecklist.splice(i,1);saveData(D);renderConfig();}
function exportData(){
const D=loadData();const blob=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});
const a=document.createElement('a');a.href=URL.createObjectURL(blob);
a.download='egglogu_backup_'+todayStr()+'.json';a.click();toast(t('cfg_exported'));
}
function importData(e){
const file=e.target.files[0];if(!file)return;
const reader=new FileReader();reader.onload=function(ev){
try{const d=JSON.parse(ev.target.result);
DATA=d;saveData(d);toast(t('cfg_imported'));nav('config');
}catch(err){toast(t('error_prefix')+': '+err.message,true);}};
reader.readAsText(file);e.target.value='';
}
function resetData(){
if(!confirm(t('cfg_reset_confirm')))return;if(!confirm(t('final_warning')))return;
localStorage.removeItem('egglogu_data');DATA=null;loadData();toast(t('cfg_reset_done'));nav('dashboard');
}
// === END CONFIG ===

// ============ WEATHER API (OpenWeatherMap) ============
let weatherTimer=null;
function fetchWeather(){
const D=loadData();if(!D.farm.owmApiKey||D.farm.lat===null||D.farm.lng===null)return;
const cached=D.weatherCache.find(w=>Date.now()-w.ts<1800000);
if(cached){renderWeatherWidget(cached);return;}
fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${D.farm.lat}&lon=${D.farm.lng}&appid=${D.farm.owmApiKey}&units=metric`)
.then(r=>r.json()).then(d=>{
if(d.cod&&d.cod!==200)return;
const w={ts:Date.now(),temp:d.main.temp,humidity:d.main.humidity,wind:d.wind.speed,
desc:d.weather[0].description,icon:d.weather[0].icon,feelsLike:d.main.feels_like};
D.weatherCache.push(w);if(D.weatherCache.length>48)D.weatherCache=D.weatherCache.slice(-24);
saveData(D);renderWeatherWidget(w);
const thi=calcTHI(w.temp,w.humidity);
if(thi>28)autoStressEvent(D,'heat',Math.min(5,Math.round((thi-28)/2)+1),`THI=${thi.toFixed(1)}, T=${w.temp}¬∞C, H=${w.humidity}%`);
}).catch(()=>{});
}
function fetchForecast(){
const D=loadData();if(!D.farm.owmApiKey||D.farm.lat===null||D.farm.lng===null)return Promise.resolve([]);
return fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${D.farm.lat}&lon=${D.farm.lng}&appid=${D.farm.owmApiKey}&units=metric`)
.then(r=>r.json()).then(d=>{
if(!d.list)return[];
const days={};d.list.forEach(f=>{const day=f.dt_txt.substring(0,10);if(!days[day])days[day]={temps:[],hums:[],icon:f.weather[0].icon,desc:f.weather[0].description};
days[day].temps.push(f.main.temp);days[day].hums.push(f.main.humidity);});
return Object.entries(days).slice(0,3).map(([date,v])=>({date,
tempMin:Math.min(...v.temps),tempMax:Math.max(...v.temps),
humidity:Math.round(v.hums.reduce((a,b)=>a+b,0)/v.hums.length),icon:v.icon,desc:v.desc}));
}).catch(()=>[]);
}
function calcTHI(t,h){return(1.8*t+32)-(0.55-0.0055*h)*(1.8*t-26);}
function renderWeatherWidget(w){
const el=document.getElementById('weather-widget');if(!el)return;
const thi=calcTHI(w.temp,w.humidity);
const thiClass=thi>28?'danger':thi>25?'warning':'';
el.innerHTML=`<div class="weather-widget">
<div style="display:flex;align-items:center;gap:12px">
<img src="https://openweathermap.org/img/wn/${w.icon}@2x.png" width="48" height="48" alt="">
<div><div style="font-size:24px;font-weight:700">${w.temp.toFixed(1)}¬∞C</div><div style="color:var(--text-light)">${w.desc}</div></div></div>
<div class="kpi-grid" style="margin-top:8px">
${kpi(t('weather_humidity'),w.humidity+'%','','')}
${kpi(t('weather_wind'),w.wind.toFixed(1)+' m/s','','')}
${kpi('THI',thi.toFixed(1),thi>28?t('weather_heat_alert'):'OK',thiClass)}
</div>
<div style="font-size:11px;color:var(--text-light);margin-top:4px">${t('weather_last_update')}: ${new Date(w.ts).toLocaleTimeString()}</div>
</div>`;
}
function testWeatherApi(){
const key=$('cfg-owm')?.value;if(!key){toast(t('required'),true);return;}
const D=loadData();const lat=D.farm.lat||0;const lng=D.farm.lng||0;
fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${key}&units=metric`)
.then(r=>r.json()).then(d=>{if(d.cod===200)toast('API OK: '+d.main.temp+'¬∞C');else toast('Error: '+(d.message||'unknown'),true);})
.catch(e=>toast('Error: '+e.message,true));
}

// ============ GEOLOCATION & MAP (Leaflet) ============
let geoMap=null;let geoMarker=null;
function showGeoModal(){
const D=loadData();
openModal(t('geo_set_location'),`
<div style="margin-bottom:8px"><button class="btn btn-secondary btn-sm" onclick="useGPS()">${t('geo_use_gps')}</button>
<span style="margin-left:8px;color:var(--text-light)">${t('geo_click_map')}</span></div>
<div id="geo-map" class="leaflet-container" style="height:400px;border-radius:var(--radius)"></div>
<div class="form-row" style="margin-top:8px">
<div class="form-group"><label>${t('geo_lat')}</label><input id="geo-lat" type="number" step="any" value="${D.farm.lat||''}"></div>
<div class="form-group"><label>${t('geo_lng')}</label><input id="geo-lng" type="number" step="any" value="${D.farm.lng||''}"></div></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveGeoLocation()">${t('save')}</button></div>`);
setTimeout(()=>{
const lat=D.farm.lat||0;const lng=D.farm.lng||0;
geoMap=L.map('geo-map').setView([lat||20,lng||-70],lat?10:2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OSM'}).addTo(geoMap);
if(lat&&lng){geoMarker=L.marker([lat,lng]).addTo(geoMap);}
geoMap.on('click',function(e){
if(geoMarker)geoMap.removeLayer(geoMarker);
geoMarker=L.marker([e.latlng.lat,e.latlng.lng]).addTo(geoMap);
$('geo-lat').value=e.latlng.lat.toFixed(6);$('geo-lng').value=e.latlng.lng.toFixed(6);
});
},200);
}
function useGPS(){
if(!navigator.geolocation){toast('GPS '+t('not_available'),true);return;}
navigator.geolocation.getCurrentPosition(pos=>{
const lat=pos.coords.latitude;const lng=pos.coords.longitude;
$('geo-lat').value=lat.toFixed(6);$('geo-lng').value=lng.toFixed(6);
if(geoMap){geoMap.setView([lat,lng],12);if(geoMarker)geoMap.removeLayer(geoMarker);
geoMarker=L.marker([lat,lng]).addTo(geoMap);}
},err=>toast('GPS Error: '+err.message,true));
}
function saveGeoLocation(){
const D=loadData();D.farm.lat=parseFloat($('geo-lat').value)||null;D.farm.lng=parseFloat($('geo-lng').value)||null;
saveData(D);closeModal();toast(t('cfg_saved'));renderConfig();
}

// ============ IoT/MQTT INTEGRATION ============
let mqttClient=null;let mqttConnected=false;
function connectMQTT(){
const D=loadData();if(!D.farm.mqttBroker){toast(t('iot_no_config'),true);return;}
try{
mqttClient=mqtt.connect(D.farm.mqttBroker,{username:D.farm.mqttUser||undefined,password:D.farm.mqttPass||undefined,
reconnectPeriod:5000,connectTimeout:10000});
mqttClient.on('connect',()=>{mqttConnected=true;
mqttClient.subscribe(D.farm.mqttTopicPrefix+'sensors/#');updateMqttStatus();toast(t('iot_connect')+' OK');});
mqttClient.on('message',(topic,payload)=>{onMqttMessage(topic,payload);});
mqttClient.on('error',()=>{mqttConnected=false;updateMqttStatus();});
mqttClient.on('close',()=>{mqttConnected=false;updateMqttStatus();});
}catch(e){toast('MQTT Error: '+e.message,true);}
}
function disconnectMQTT(){
if(mqttClient){mqttClient.end();mqttClient=null;}mqttConnected=false;updateMqttStatus();toast(t('iot_disconnect'));
}
function onMqttMessage(topic,payload){
try{const data=JSON.parse(payload.toString());const D=loadData();
const prefix=D.farm.mqttTopicPrefix||'egglogu/';
const sensor=topic.replace(prefix+'sensors/','');
const reading={id:genId(),ts:Date.now(),sensor,value:data.value,unit:data.unit||''};
D.iotReadings.push(reading);if(D.iotReadings.length>500)D.iotReadings=D.iotReadings.slice(-300);
saveData(D);updateIoTGauges();
}catch(e){}
}
function updateMqttStatus(){
const el=document.getElementById('mqtt-indicator');if(!el)return;
el.innerHTML=`<span class="mqtt-status ${mqttConnected?'connected':'disconnected'}">${mqttConnected?'‚óè MQTT':'‚óã MQTT'}</span>`;
}
function updateIoTGauges(){
const D=loadData();const el=document.getElementById('iot-gauges');if(!el)return;
const latest={};D.iotReadings.slice(-20).forEach(r=>{latest[r.sensor]={value:r.value,unit:r.unit,ts:r.ts};});
const sensors=['temperature','humidity','ammonia','light'];
let h='<div class="kpi-grid">';
sensors.forEach(s=>{const d=latest[s];
const val=d?d.value:'--';const unit=d?d.unit:'';
let cls='';
if(s==='temperature'&&d){cls=d.value>30||d.value<15?'danger':d.value>26?'warning':'';}
if(s==='humidity'&&d){cls=d.value>80||d.value<30?'danger':d.value>70?'warning':'';}
if(s==='ammonia'&&d){cls=d.value>25?'danger':d.value>15?'warning':'';}
h+=kpi(t('iot_'+s)||s,typeof val==='number'?val.toFixed(1):val,unit,cls);
});
if(latest.temperature&&latest.humidity){
const thi=calcTHI(latest.temperature.value,latest.humidity.value);
h+=kpi('THI',thi.toFixed(1),thi>28?t('weather_heat_alert'):'OK',thi>28?'danger':thi>25?'warning':'');
}
h+='</div>';
if(Object.keys(latest).length){
h+=`<div style="margin-top:8px"><button class="btn btn-secondary btn-sm" onclick="saveIoTToEnv()">${t('iot_save_reading')}</button>
<span style="margin-left:8px;font-size:11px;color:var(--text-light)">${t('weather_last_update')}: ${new Date(D.iotReadings[D.iotReadings.length-1]?.ts||0).toLocaleTimeString()}</span></div>`;
}
el.innerHTML=h;
}
function saveIoTToEnv(){
const D=loadData();const latest={};D.iotReadings.slice(-20).forEach(r=>{latest[r.sensor]={value:r.value};});
const o={id:genId(),date:todayStr(),temperature:latest.temperature?.value||null,
humidity:latest.humidity?.value||null,lightHours:null,ventilation:'',
ammoniaLevel:latest.ammonia?.value||null,notes:'IoT auto-save'};
D.environment.push(o);saveData(D);toast(t('cfg_saved'));
}

// ============ ML / PREDICTIVE ANALYTICS ============
let forecastDays=7;
function renderPredictionsTab(D){
if(!D.dailyProduction.length)return emptyState('ü§ñ',t('no_data'));
let h='';
const sorted=[...D.dailyProduction].sort((a,b)=>a.date.localeCompare(b.date));
const last30=sorted.slice(-30);
// === Outbreak Risk Classifier (traffic light) ===
const outbreak=computeOutbreakRisk(D);
const obColor=outbreak.classification===1?'red':outbreak.probability>0.4?'yellow':'green';
const obLabel=obColor==='red'?t('pred_outbreak_high'):obColor==='yellow'?t('pred_outbreak_medium'):t('pred_outbreak_low');
h+=`<div class="card"><h3>üî¥ ${t('pred_outbreak_risk')}</h3>
<div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">
<div class="traffic-light"><div class="traffic-dot red${obColor==='red'?' active':''}"></div><div class="traffic-dot yellow${obColor==='yellow'?' active':''}"></div><div class="traffic-dot green${obColor==='green'?' active':''}"></div></div>
<div><strong style="font-size:1.4em">${(outbreak.probability*100).toFixed(0)}%</strong><br><span class="badge badge-${obColor==='red'?'danger':obColor==='yellow'?'warning':'success'}">${obLabel}</span></div></div>`;
if(outbreak.factors.length){
h+='<div class="table-wrap"><table><thead><tr><th>'+t('pred_outbreak_factor')+'</th><th>'+t('pred_outbreak_weight')+'</th><th>'+t('pred_outbreak_value')+'</th></tr></thead><tbody>';
outbreak.factors.forEach(f=>{h+=`<tr><td>${f.name}</td><td>${(f.weight*100).toFixed(0)}%</td><td><div class="severity-bar"><div style="width:${Math.min(100,f.value*100)}%;background:${f.value>0.6?'var(--danger)':f.value>0.3?'var(--warning)':'var(--success)'}"></div></div></td></tr>`;});
h+='</tbody></table></div>';}
if(outbreak.recommendations.length){
h+='<div style="margin-top:12px"><strong>'+t('rec_title')+':</strong><ul style="margin:4px 0 0 16px">';
outbreak.recommendations.forEach(r=>{h+=`<li>${r}</li>`;});h+='</ul></div>';}
h+='</div>';
// === Multi-step Forecast (ensemble) ===
if(last30.length>=7&&typeof ss!=='undefined'){
h+=`<div class="card"><h3>üìà ${t('pred_forecast')}</h3>
<div style="margin-bottom:8px"><button class="btn btn-sm${forecastDays===7?' btn-primary':' btn-secondary'}" onclick="forecastDays=7;renderAnalysis()">7d</button>
<button class="btn btn-sm${forecastDays===14?' btn-primary':' btn-secondary'}" onclick="forecastDays=14;renderAnalysis()">14d</button></div>
<div class="chart-container"><canvas id="chart-forecast"></canvas></div></div>`;
setTimeout(()=>{
const c=document.getElementById('chart-forecast');if(!c)return;
const fc=computeForecast(D,forecastDays);
const allLabels=last30.map(p=>p.date.substring(5));
for(let i=1;i<=forecastDays;i++){const d=new Date();d.setDate(d.getDate()+i);allLabels.push(d.toISOString().substring(5,10));}
const actual=last30.map(p=>p.eggsCollected||0);
const predLine=[...Array(last30.length).fill(null),...fc.forecast];
const upperBand=[...Array(last30.length).fill(null),...fc.upper];
const lowerBand=[...Array(last30.length).fill(null),...fc.lower];
CHARTS.forecast=new Chart(c,{type:'line',data:{labels:allLabels,datasets:[
{label:t('prod_eggs'),data:[...actual,...Array(forecastDays).fill(null)],borderColor:themeColor('--primary'),backgroundColor:themeRgba(.1),fill:true,tension:.3},
{label:t('pred_forecast'),data:predLine,borderColor:'#FF8F00',borderDash:[5,5],tension:.3,pointRadius:4},
{label:t('pred_forecast_upper'),data:upperBand,borderColor:'rgba(255,143,0,.2)',backgroundColor:'rgba(255,143,0,.08)',fill:'+1',borderDash:[2,2],pointRadius:0,tension:.3},
{label:t('pred_forecast_lower'),data:lowerBand,borderColor:'rgba(255,143,0,.2)',pointRadius:0,tension:.3}
]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{filter:item=>!item.text.includes('upper')&&!item.text.includes('lower')}}}}});
},100);
}
// === Anomaly Detection ===
if(last30.length>=7&&typeof ss!=='undefined'){
const vals=last30.map(p=>p.eggsCollected||0);
const mean=ss.mean(vals);const std=ss.standardDeviation(vals);
const anomalies=last30.filter(p=>{const z=std>0?Math.abs((p.eggsCollected-mean)/std):0;return z>2;});
if(anomalies.length){
h+=`<div class="card"><h3>${t('pred_anomaly')} (|Z|>2)</h3><div class="table-wrap"><table><thead><tr>
<th>${t('date')}</th><th>${t('prod_eggs')}</th><th>Z-score</th></tr></thead><tbody>`;
anomalies.forEach(p=>{const z=std>0?((p.eggsCollected-mean)/std):0;
h+=`<tr><td>${fmtDate(p.date)}</td><td>${p.eggsCollected} <span class="anomaly-icon">‚ö†</span></td>
<td style="color:var(--danger)">${z.toFixed(2)}</td></tr>`;});
h+='</tbody></table></div></div>';
}}
// === Breed Benchmark ===
const activeFlocks=D.flocks.filter(f=>f.status!=='descarte'&&f.birthDate);
if(activeFlocks.length){
h+=`<div class="card"><h3>${t('pred_breed_curve')}</h3>`;
activeFlocks.forEach(f=>{
const bkey=f.breed&&BREED_CURVES[f.breed]?f.breed:(f.targetCurve&&BREED_CURVES[f.targetCurve]?f.targetCurve:'generic');
const curve=BREED_CURVES[bkey];const age=flockAge(f);const weekIdx=Math.max(0,age.weeks-18);
const expected=weekIdx<curve.length?curve[weekIdx]:curve[curve.length-1];
const hens=activeHensByFlock(f.id);
const l7=D.dailyProduction.filter(p=>p.flockId===f.id).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const avgE=l7.length>0?l7.reduce((s,p)=>s+(p.eggsCollected||0),0)/l7.length:0;
const actual=hens>0?(avgE/hens*100):0;
const gap=actual-expected;const gapColor=gap>=0?'var(--success)':'var(--danger)';
h+=`<div class="stat-row"><span class="stat-label">${f.name} (${breed})</span>
<span class="stat-value">${t('actual')}: ${fmtNum(actual,1)}% | ${t('expected')}: ${expected}% |
<span style="color:${gapColor}">Gap: ${gap>0?'+':''}${fmtNum(gap,1)}%</span></span></div>`;
});
h+='</div>';}
return h;
}
function computeDropRisk(D){
let score=0;const hens=activeHens();
// Factor 1: Recent mortality spike (0-30 points)
const l7prod=D.dailyProduction.sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const l7deaths=l7prod.reduce((s,p)=>s+(p.deaths||0),0);
const deathRate=hens>0?(l7deaths/hens*100):0;
score+=Math.min(30,deathRate*6);
// Factor 2: FCR worsening (0-25 points)
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const f30=D.feed.consumption.filter(c=>c.date>=d30s);const e30=D.dailyProduction.filter(p=>p.date>=d30s);
const tfkg=f30.reduce((s,c)=>s+(c.quantityKg||0),0);const tekg=e30.reduce((s,p)=>s+(p.eggsCollected||0),0)*0.06;
const fcr=tekg>0?tfkg/tekg:0;
if(fcr>3)score+=25;else if(fcr>2.5)score+=15;else if(fcr>2)score+=5;
// Factor 3: Weather THI (0-20 points)
const lastW=D.weatherCache.length>0?D.weatherCache[D.weatherCache.length-1]:null;
if(lastW){const thi=calcTHI(lastW.temp,lastW.humidity);if(thi>30)score+=20;else if(thi>28)score+=12;else if(thi>25)score+=5;}
// Factor 4: Production trend (0-25 points)
if(l7prod.length>=7&&typeof ss!=='undefined'){
const points=l7prod.map((p,i)=>[i,p.eggsCollected||0]);
const reg=ss.linearRegression(points);
if(reg.m<-5)score+=25;else if(reg.m<-2)score+=15;else if(reg.m<0)score+=5;
}
return Math.min(100,Math.round(score));
}

// ============ STRESS EVENTS ============
let currentSanidadTab_stress=false;
function renderStressEventsTab(D){
let h=`<div class="page-header" style="margin-bottom:12px"><h3>${t('stress_title')}</h3>
<button class="btn btn-primary btn-sm" onclick="showStressForm()">${t('add')}</button></div>`;
if(!D.stressEvents.length)return h+emptyState('‚ö°',t('no_data'));
// Timeline view
h+='<div class="card"><div class="stress-timeline">';
D.stressEvents.sort((a,b)=>b.date.localeCompare(a.date)).forEach(ev=>{
const sColor=['','#4CAF50','#FFC107','#FF9800','#F44336','#9C27B0'][ev.severity]||'#999';
const f=D.flocks.find(x=>x.id===ev.flockId);
// Production impact
const evDate=new Date(ev.date+'T12:00:00');const after3=new Date(evDate);after3.setDate(after3.getDate()+3);
const before=D.dailyProduction.filter(p=>p.date<ev.date).slice(-3);
const afterP=D.dailyProduction.filter(p=>p.date>ev.date&&p.date<=after3.toISOString().substring(0,10));
const avgBefore=before.length>0?before.reduce((s,p)=>s+(p.eggsCollected||0),0)/before.length:0;
const avgAfter=afterP.length>0?afterP.reduce((s,p)=>s+(p.eggsCollected||0),0)/afterP.length:0;
const impact=avgBefore>0?((avgAfter-avgBefore)/avgBefore*100):0;
h+=`<div class="stress-event" style="border-left:4px solid ${sColor}">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px">
<strong>${fmtDate(ev.date)}</strong>
<span class="badge badge-${ev.severity>=4?'danger':ev.severity>=3?'warning':'info'}">${t('stress_'+ev.type)||ev.type} (${ev.severity}/5)</span>
</div>
<p style="margin:4px 0">${ev.description}</p>
<div style="font-size:12px;color:var(--text-light)">${f?f.name:t('all')} | ${t('prod_title')}: <span style="color:${impact<0?'var(--danger)':'var(--success)'}">${impact>0?'+':''}${fmtNum(impact,1)}%</span></div>
<div class="btn-group" style="margin-top:4px"><button class="btn btn-secondary btn-sm" onclick="showStressForm('${ev.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteStress('${ev.id}')">${t('delete')}</button></div></div>`;
});
h+='</div></div>';
return h;
}
function showStressForm(id){
const D=loadData();const ev=id?D.stressEvents.find(x=>x.id===id):null;
const types=['heat','disease','feed_change','power','predator','other'];
openModal(ev?t('edit'):t('stress_title'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="st-date" value="${ev?ev.date:todayStr()}"></div>
<div class="form-group"><label>${t('stress_type')}</label><select id="st-type">${types.map(ty=>`<option value="${ty}"${ev&&ev.type===ty?' selected':''}>${t('stress_'+ty)||ty}</option>`).join('')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('stress_severity')} (1-5)</label><input type="number" id="st-sev" value="${ev?ev.severity:3}" min="1" max="5"></div>
<div class="form-group"><label>${t('prod_flock')}</label><select id="st-flock">${flockSelect(ev?ev.flockId:'',true)}</select></div></div>
<div class="form-group"><label>${t('fin_description')}</label><textarea id="st-desc">${ev?ev.description||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveStress('${id||''}')">${t('save')}</button></div>`);
}
function saveStress(id){
const D=loadData();const o={date:$('st-date').value,type:$('st-type').value,
severity:parseInt($('st-sev').value)||3,flockId:$('st-flock').value,description:$('st-desc').value};
if(!o.date){toast(t('required'),true);return;}
if(id){const i=D.stressEvents.findIndex(e=>e.id===id);if(i>=0)D.stressEvents[i]={...D.stressEvents[i],...o};}
else{o.id=genId();D.stressEvents.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderSanidad();
}
function deleteStress(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.stressEvents=D.stressEvents.filter(e=>e.id!==id);saveData(D);toast(t('cfg_saved'));renderSanidad();}
function autoStressEvent(D,type,severity,desc){
const today=todayStr();
if(D.stressEvents.find(e=>e.date===today&&e.type===type))return;
D.stressEvents.push({id:genId(),date:today,flockId:'',type,severity,description:desc});
saveData(D);
}

// ============ CONFIG SAVE HELPERS ============
function saveWeatherConfig(){
const D=loadData();D.farm.owmApiKey=$('cfg-owm')?.value||'';saveData(D);toast(t('cfg_saved'));
if(D.farm.owmApiKey&&D.farm.lat)fetchWeather();
}
function saveMqttConfig(){
const D=loadData();
D.farm.mqttBroker=$('cfg-mqtt-broker')?.value||'';
D.farm.mqttUser=$('cfg-mqtt-user')?.value||'';
D.farm.mqttPass=$('cfg-mqtt-pass')?.value||'';
D.farm.mqttTopicPrefix=$('cfg-mqtt-prefix')?.value||'egglogu/';
saveData(D);toast(t('cfg_saved'));
}

// ============ BIOSECURITY MODULE ============
let currentBioTab='visitors';
function renderBiosecurity(){
const D=loadData();const bio=D.biosecurity;
let h=`<div class="page-header"><h2>${t('bio_title')}</h2></div>`;
// Pest Score
const ps=computePestScore(D);
h+=`<div class="kpi-grid" style="margin-bottom:16px">`;
h+=kpi(t('bio_pest_score'),ps.toString()+'/100','',ps>60?'danger':ps>30?'warning':'');
h+=kpi(t('bio_unresolved_pests'),bio.pestSightings.filter(p=>!p.resolved).length.toString(),'','');
h+=kpi(t('bio_visitors'),bio.visitors.length.toString(),t('total'),'');
h+=kpi(t('bio_zones'),bio.zones.length.toString(),'','');
h+=`</div>`;
h+=`<div class="tabs">
<div class="tab${currentBioTab==='visitors'?' active':''}" onclick="currentBioTab='visitors';renderBiosecurity()">üë§ ${t('bio_visitors')}</div>
<div class="tab${currentBioTab==='zones'?' active':''}" onclick="currentBioTab='zones';renderBiosecurity()">üè† ${t('bio_zones')}</div>
<div class="tab${currentBioTab==='pests'?' active':''}" onclick="currentBioTab='pests';renderBiosecurity()">üêÄ ${t('bio_pests')}</div>
<div class="tab${currentBioTab==='protocols'?' active':''}" onclick="currentBioTab='protocols';renderBiosecurity()">üìã ${t('bio_protocols')}</div></div>`;
if(currentBioTab==='visitors')h+=renderBioVisitors(D);
else if(currentBioTab==='zones')h+=renderBioZones(D);
else if(currentBioTab==='pests')h+=renderBioPests(D);
else h+=renderBioProtocols(D);
$('sec-bioseguridad').innerHTML=h;
}
function computePestScore(D){
const bio=D.biosecurity;let score=0;
const unresolved=bio.pestSightings.filter(p=>!p.resolved);
score+=Math.min(40,unresolved.length*10);
score+=Math.min(20,unresolved.reduce((s,p)=>s+(p.severity||1),0)*2);
const redZones=bio.zones.filter(z=>z.riskLevel==='red').length;
const yellowZones=bio.zones.filter(z=>z.riskLevel==='yellow').length;
score+=redZones*15+yellowZones*5;
const today=todayStr();
bio.zones.forEach(z=>{
if(z.lastDisinfection&&z.frequencyDays){
const next=new Date(z.lastDisinfection+'T12:00:00');next.setDate(next.getDate()+z.frequencyDays);
if(next.toISOString().substring(0,10)<today)score+=10;
}});
return Math.min(100,Math.round(score));
}
function renderBioVisitors(D){
const bio=D.biosecurity;
let h=`<div class="card"><div class="page-header"><h3>üë§ ${t('bio_visitors')}</h3>
<button class="btn btn-primary btn-sm" onclick="showBioVisitorForm()">${t('bio_add_visitor')}</button></div>`;
if(!bio.visitors.length)return h+emptyState('üë§',t('no_data'))+'</div>';
h+=`<div class="table-wrap"><table><thead><tr><th>${t('date')}</th><th>${t('bio_visitor_name')}</th><th>${t('bio_visitor_company')}</th>
<th>${t('bio_visitor_purpose')}</th><th>${t('bio_visitor_zone')}</th><th>${t('bio_visitor_plate')}</th>
<th>${t('bio_visitor_disinfected')}</th><th>${t('actions')}</th></tr></thead><tbody>`;
bio.visitors.sort((a,b)=>b.date.localeCompare(a.date)).forEach(v=>{
const crossRisk=v.fromFarmHealth&&v.fromFarmHealth!=='healthy';
h+=`<tr${crossRisk?' style="background:#FFF3E0"':''}>
<td>${fmtDate(v.date)}</td><td>${v.name}${crossRisk?' <span title="'+t('bio_cross_risk')+'" style="color:var(--danger)">‚ö†Ô∏è</span>':''}</td>
<td>${v.company||'-'}</td><td>${v.purpose||'-'}</td><td>${v.zone||'-'}</td><td>${v.vehiclePlate||'-'}</td>
<td>${v.disinfected?'‚úÖ':'‚ùå'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showBioVisitorForm('${v.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteBioVisitor('${v.id}')">${t('delete')}</button></div></td></tr>`;});
return h+'</tbody></table></div></div>';
}
function showBioVisitorForm(id){
const D=loadData();const v=id?D.biosecurity.visitors.find(x=>x.id===id):null;
const zoneOpts=D.biosecurity.zones.map(z=>`<option value="${z.name}"${v&&v.zone===z.name?' selected':''}>${z.name}</option>`).join('');
openModal(v?t('edit'):t('bio_add_visitor'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="bv-date" value="${v?v.date:todayStr()}"></div>
<div class="form-group"><label>${t('bio_visitor_name')}</label><input id="bv-name" value="${v?v.name:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('bio_visitor_company')}</label><input id="bv-company" value="${v?v.company||'':''}"></div>
<div class="form-group"><label>${t('bio_visitor_purpose')}</label><select id="bv-purpose">${catalogSelect(CATALOGS.visitorPurposes,v?v.purpose||'':'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('bio_visitor_zone')}</label><select id="bv-zone"><option value="">--</option>${zoneOpts}</select></div>
<div class="form-group"><label>${t('bio_visitor_plate')}</label><input id="bv-plate" value="${v?v.vehiclePlate||'':''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('bio_visitor_disinfected')}</label><select id="bv-disinf">
<option value="true"${v&&v.disinfected?' selected':''}>‚úÖ</option><option value="false"${v&&!v.disinfected?' selected':''}>‚ùå</option></select></div>
<div class="form-group"><label>${t('bio_visitor_from_farm')}</label><select id="bv-farm">
<option value="">--</option>
<option value="internal"${v&&v.fromFarmId==='internal'?' selected':''}>${D.farm.name||'Mi Granja'} (interna)</option>
<option value="external"${v&&v.fromFarmId==='external'?' selected':(!v?' selected':'')}>Externa</option>
</select></div></div>
<div class="form-group"><label>${t('bio_visitor_from_health')}</label><select id="bv-health">
<option value="healthy"${v&&v.fromFarmHealth==='healthy'?' selected':''}>‚úÖ Healthy</option>
<option value="outbreak"${v&&v.fromFarmHealth==='outbreak'?' selected':''}>‚ö†Ô∏è Outbreak</option>
<option value="unknown"${v&&v.fromFarmHealth==='unknown'?' selected':''}>‚ùì Unknown</option></select></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="bv-notes">${v?v.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveBioVisitor('${id||''}')">${t('save')}</button></div>`);
}
function saveBioVisitor(id){
const D=loadData();const o={date:$('bv-date').value,name:$('bv-name').value,company:$('bv-company').value,
purpose:$('bv-purpose').value,zone:$('bv-zone').value,vehiclePlate:$('bv-plate').value,
disinfected:$('bv-disinf').value==='true',fromFarmId:$('bv-farm').value,
fromFarmHealth:$('bv-health').value,notes:$('bv-notes').value};
if(!o.date||!o.name){toast(t('required'),true);return;}
if(id){const i=D.biosecurity.visitors.findIndex(v=>v.id===id);if(i>=0)D.biosecurity.visitors[i]={...D.biosecurity.visitors[i],...o};}
else{o.id=genId();D.biosecurity.visitors.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderBiosecurity();
}
function deleteBioVisitor(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.biosecurity.visitors=D.biosecurity.visitors.filter(v=>v.id!==id);saveData(D);toast(t('cfg_saved'));renderBiosecurity();}

function renderBioZones(D){
const bio=D.biosecurity;const today=todayStr();
let h=`<div class="card"><div class="page-header"><h3>üè† ${t('bio_zones')}</h3>
<button class="btn btn-primary btn-sm" onclick="showBioZoneForm()">${t('bio_add_zone')}</button></div>`;
if(!bio.zones.length)return h+emptyState('üè†',t('no_data'))+'</div>';
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px">';
bio.zones.forEach(z=>{
const overdue=z.lastDisinfection&&z.frequencyDays&&(()=>{const n=new Date(z.lastDisinfection+'T12:00:00');n.setDate(n.getDate()+z.frequencyDays);return n.toISOString().substring(0,10)<today;})();
h+=`<div class="card" style="border-left:4px solid ${z.riskLevel==='red'?'#F44336':z.riskLevel==='yellow'?'#FFC107':'#4CAF50'}">
<div style="display:flex;justify-content:space-between;align-items:center">
<h4>${z.name}</h4><span class="risk-badge risk-${z.riskLevel}">${t('bio_risk_'+z.riskLevel)}</span></div>
<p style="font-size:13px;color:var(--text-light)">${t('bio_zone_last_disinfection')}: ${z.lastDisinfection?fmtDate(z.lastDisinfection):'-'}
${overdue?' <span style="color:var(--danger);font-weight:700">'+t('bio_protocol_overdue')+'</span>':''}</p>
<p style="font-size:13px;color:var(--text-light)">${t('bio_zone_frequency')}: ${z.frequencyDays||'-'} ${t('flock_days')}</p>
${z.notes?'<p style="font-size:12px">'+z.notes+'</p>':''}
<div class="btn-group" style="margin-top:8px"><button class="btn btn-secondary btn-sm" onclick="showBioZoneForm('${z.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteBioZone('${z.id}')">${t('delete')}</button></div></div>`;});
return h+'</div></div>';
}
function showBioZoneForm(id){
const D=loadData();const z=id?D.biosecurity.zones.find(x=>x.id===id):null;
openModal(z?t('edit'):t('bio_add_zone'),`
<div class="form-row"><div class="form-group"><label>${t('bio_zone_name')}</label><input id="bz-name" value="${z?z.name:''}"></div>
<div class="form-group"><label>${t('bio_zone_risk')}</label><select id="bz-risk">
<option value="green"${z&&z.riskLevel==='green'?' selected':''}>${t('bio_risk_green')}</option>
<option value="yellow"${z&&z.riskLevel==='yellow'?' selected':''}>${t('bio_risk_yellow')}</option>
<option value="red"${z&&z.riskLevel==='red'?' selected':''}>${t('bio_risk_red')}</option></select></div></div>
<div class="form-row"><div class="form-group"><label>${t('bio_zone_last_disinfection')}</label><input type="date" id="bz-last" value="${z?z.lastDisinfection||'':''}"></div>
<div class="form-group"><label>${t('bio_zone_frequency')}</label><input type="number" id="bz-freq" value="${z?z.frequencyDays||'':''}" min="1"></div></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="bz-notes">${z?z.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveBioZone('${id||''}')">${t('save')}</button></div>`);
}
function saveBioZone(id){
const D=loadData();const o={name:$('bz-name').value,riskLevel:$('bz-risk').value,
lastDisinfection:$('bz-last').value,frequencyDays:parseInt($('bz-freq').value)||0,notes:$('bz-notes').value};
if(!o.name){toast(t('required'),true);return;}
if(id){const i=D.biosecurity.zones.findIndex(z=>z.id===id);if(i>=0)D.biosecurity.zones[i]={...D.biosecurity.zones[i],...o};}
else{o.id=genId();D.biosecurity.zones.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderBiosecurity();
}
function deleteBioZone(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.biosecurity.zones=D.biosecurity.zones.filter(z=>z.id!==id);saveData(D);toast(t('cfg_saved'));renderBiosecurity();}

function renderBioPests(D){
const bio=D.biosecurity;
let h=`<div class="card"><div class="page-header"><h3>üêÄ ${t('bio_pests')}</h3>
<button class="btn btn-primary btn-sm" onclick="showBioPestForm()">${t('bio_add_pest')}</button></div>`;
if(!bio.pestSightings.length)return h+emptyState('üêÄ',t('no_data'))+'</div>';
h+='<div class="stress-timeline" style="padding-left:20px">';
bio.pestSightings.sort((a,b)=>b.date.localeCompare(a.date)).forEach(p=>{
const sColor=['','#4CAF50','#8BC34A','#FFC107','#FF9800','#F44336'][p.severity]||'#999';
const typeIcon={rodent:'üêÄ',fly:'ü™∞',wild_bird:'üê¶',other:'üêõ'}[p.type]||'üêõ';
h+=`<div class="stress-event" style="border-left:4px solid ${sColor}">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px">
<strong>${fmtDate(p.date)} ${typeIcon} ${t('bio_pest_'+p.type)||p.type}</strong>
<span>${p.resolved?'‚úÖ '+t('bio_pest_resolved'):'‚ùå '+t('active')}</span></div>
<p style="margin:4px 0">${t('bio_pest_location')}: ${p.location||'-'} | ${t('bio_pest_severity')}: ${'‚≠ê'.repeat(p.severity||1)}</p>
${p.action?'<p style="font-size:12px;color:var(--text-light)">'+t('bio_pest_action')+': '+p.action+'</p>':''}
<div class="btn-group" style="margin-top:4px">
${!p.resolved?'<button class="btn btn-primary btn-sm" onclick="resolveBioPest(\''+p.id+'\')">‚úÖ '+t('bio_pest_resolved')+'</button>':''}
<button class="btn btn-secondary btn-sm" onclick="showBioPestForm('${p.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteBioPest('${p.id}')">${t('delete')}</button></div></div>`;});
return h+'</div></div>';
}
function showBioPestForm(id){
const D=loadData();const p=id?D.biosecurity.pestSightings.find(x=>x.id===id):null;
openModal(p?t('edit'):t('bio_add_pest'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="bp-date" value="${p?p.date:todayStr()}"></div>
<div class="form-group"><label>${t('bio_pest_type')}</label><select id="bp-type">
<option value="rodent"${p&&p.type==='rodent'?' selected':''}>${t('bio_pest_rodent')}</option>
<option value="fly"${p&&p.type==='fly'?' selected':''}>${t('bio_pest_fly')}</option>
<option value="wild_bird"${p&&p.type==='wild_bird'?' selected':''}>${t('bio_pest_wild_bird')}</option>
<option value="other"${p&&p.type==='other'?' selected':''}>${t('bio_pest_other')}</option></select></div></div>
<div class="form-row"><div class="form-group"><label>${t('bio_pest_location')}</label><select id="bp-loc">
<option value="">--</option>
${D.biosecurity.zones.map(z=>`<option value="${z.name}"${p&&p.location===z.name?' selected':''}>${z.name}</option>`).join('')}
<option value="__other__">Otra...</option>
</select></div>
<div class="form-group"><label>${t('bio_pest_severity')} (1-5)</label><input type="number" id="bp-sev" value="${p?p.severity||3:3}" min="1" max="5"></div></div>
<div class="form-group"><label>${t('bio_pest_action')}</label><textarea id="bp-action">${p?p.action||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveBioPest('${id||''}')">${t('save')}</button></div>`);
}
function saveBioPest(id){
const D=loadData();const o={date:$('bp-date').value,type:$('bp-type').value,
location:$('bp-loc').value,severity:parseInt($('bp-sev').value)||3,action:$('bp-action').value,resolved:false};
if(!o.date){toast(t('required'),true);return;}
if(id){const i=D.biosecurity.pestSightings.findIndex(p=>p.id===id);
if(i>=0){o.resolved=D.biosecurity.pestSightings[i].resolved;D.biosecurity.pestSightings[i]={...D.biosecurity.pestSightings[i],...o};}}
else{o.id=genId();D.biosecurity.pestSightings.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderBiosecurity();
}
function resolveBioPest(id){const D=loadData();const p=D.biosecurity.pestSightings.find(x=>x.id===id);if(p){p.resolved=true;saveData(D);toast(t('cfg_saved'));renderBiosecurity();}}
function deleteBioPest(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.biosecurity.pestSightings=D.biosecurity.pestSightings.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderBiosecurity();}

function renderBioProtocols(D){
const bio=D.biosecurity;const today=todayStr();
let h=`<div class="card"><div class="page-header"><h3>üìã ${t('bio_protocols')}</h3>
<button class="btn btn-primary btn-sm" onclick="showBioProtocolForm()">${t('bio_add_protocol')}</button></div>`;
if(!bio.protocols.length)return h+emptyState('üìã',t('no_data'))+'</div>';
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px">';
bio.protocols.forEach(p=>{
const freqDays={daily:1,weekly:7,monthly:30}[p.frequency]||7;
const overdue=p.lastCompleted&&(()=>{const n=new Date(p.lastCompleted+'T12:00:00');n.setDate(n.getDate()+freqDays);return n.toISOString().substring(0,10)<today;})();
h+=`<div class="card" style="border-top:3px solid ${overdue?'var(--danger)':'var(--primary)'}">
<h4>${p.name}</h4>
<p style="font-size:13px;color:var(--text-light)">${t('bio_protocol_frequency')}: ${t('bio_protocol_'+p.frequency)} | ${t('bio_protocol_last')}: ${p.lastCompleted?fmtDate(p.lastCompleted):'-'}
${overdue?' <span style="color:var(--danger);font-weight:700">'+t('bio_protocol_overdue')+'</span>':''}</p>`;
if(p.items&&p.items.length){h+='<ul style="font-size:13px;margin:8px 0">';p.items.forEach(it=>{h+=`<li>${it}</li>`;});h+='</ul>';}
h+=`<div class="btn-group"><button class="btn btn-primary btn-sm" onclick="completeBioProtocol('${p.id}')">‚úÖ ${t('bio_protocol_complete')}</button>
<button class="btn btn-secondary btn-sm" onclick="showBioProtocolForm('${p.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteBioProtocol('${p.id}')">${t('delete')}</button></div></div>`;});
return h+'</div></div>';
}
function showBioProtocolForm(id){
const D=loadData();const p=id?D.biosecurity.protocols.find(x=>x.id===id):null;
openModal(p?t('edit'):t('bio_add_protocol'),`
<div class="form-row"><div class="form-group"><label>${t('bio_protocol_name')}</label><select id="bpr-name">${catalogSelect(CATALOGS.bioProtocols,p?p.name:'')}</select></div>
<div class="form-group"><label>${t('bio_protocol_frequency')}</label><select id="bpr-freq">
<option value="daily"${p&&p.frequency==='daily'?' selected':''}>${t('bio_protocol_daily')}</option>
<option value="weekly"${p&&p.frequency==='weekly'?' selected':''}>${t('bio_protocol_weekly')}</option>
<option value="monthly"${p&&p.frequency==='monthly'?' selected':''}>${t('bio_protocol_monthly')}</option></select></div></div>
<div class="form-group"><label>${t('bio_protocol_items')} (${t('notes')}: uno por l√≠nea)</label>
<textarea id="bpr-items" rows="5">${p&&p.items?p.items.join('\n'):''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveBioProtocol('${id||''}')">${t('save')}</button></div>`);
}
function saveBioProtocol(id){
const D=loadData();const o={name:$('bpr-name').value,frequency:$('bpr-freq').value,
items:$('bpr-items').value.split('\n').map(s=>s.trim()).filter(Boolean),lastCompleted:null};
if(!o.name){toast(t('required'),true);return;}
if(id){const i=D.biosecurity.protocols.findIndex(p=>p.id===id);
if(i>=0){o.lastCompleted=D.biosecurity.protocols[i].lastCompleted;D.biosecurity.protocols[i]={...D.biosecurity.protocols[i],...o};}}
else{o.id=genId();D.biosecurity.protocols.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderBiosecurity();
}
function completeBioProtocol(id){const D=loadData();const p=D.biosecurity.protocols.find(x=>x.id===id);if(p){p.lastCompleted=todayStr();saveData(D);toast(t('cfg_saved'));renderBiosecurity();}}
function deleteBioProtocol(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.biosecurity.protocols=D.biosecurity.protocols.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderBiosecurity();}

// ============ EGG TRACEABILITY MODULE ============
function renderTraceability(){
const D=loadData();const batches=D.traceability.batches;
let h=`<div class="page-header"><h2>${t('trace_title')}</h2>
<div class="btn-group"><button class="btn btn-primary" onclick="showBatchForm()">${t('trace_add')}</button>
<button class="btn btn-secondary" onclick="exportBatchCSV()">${t('export_csv')}</button></div></div>`;
// Search
h+=`<div class="card"><div class="form-row"><div class="form-group" style="flex:1">
<input id="trace-search" placeholder="${t('trace_search')}" oninput="filterBatches()"></div></div></div>`;
if(!batches.length){h+=emptyState('üì¶',t('no_data'));$('sec-trazabilidad').innerHTML=h;return;}
h+=`<div id="batch-list">`;h+=renderBatchList(batches,D);h+=`</div>`;
$('sec-trazabilidad').innerHTML=h;
}
function renderBatchList(batches,D){
let h=`<div class="card"><div class="table-wrap"><table><thead><tr>
<th>${t('trace_batch_id')}</th><th>${t('date')}</th><th>${t('prod_flock')}</th><th>${t('trace_house')}</th>
<th>${t('trace_rack')}</th><th>${t('trace_box_count')}</th><th>${t('trace_eggs_per_box')}</th>
<th>${t('prod_egg_type')}</th><th>${t('fin_client')}</th><th>${t('trace_delivery')}</th><th>${t('actions')}</th>
</tr></thead><tbody>`;
batches.sort((a,b)=>b.date.localeCompare(a.date)).forEach(b=>{
const f=D.flocks.find(x=>x.id===b.flockId);const c=D.clients.find(x=>x.id===b.clientId);
h+=`<tr><td><code>${b.id.substring(0,8)}</code></td><td>${fmtDate(b.date)}</td><td>${f?f.name:'-'}</td>
<td>${b.house||'-'}</td><td>${b.rackNumber||'-'}</td><td>${fmtNum(b.boxCount)}</td><td>${fmtNum(b.eggsPerBox)}</td>
<td>${b.eggType?t('prod_type_'+b.eggType)||b.eggType:'-'}</td>
<td>${c?c.name:'-'}</td><td>${b.deliveryDate?fmtDate(b.deliveryDate):'-'}</td>
<td><div class="btn-group"><button class="btn btn-secondary btn-sm" onclick="showBatchTrace('${b.id}')" title="${t('trace_origin')}">üîç</button>
<button class="btn btn-secondary btn-sm" onclick="showBatchForm('${b.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deleteBatch('${b.id}')">${t('delete')}</button></div></td></tr>`;});
return h+'</tbody></table></div></div>';
}
function showBatchForm(id){
const D=loadData();const b=id?D.traceability.batches.find(x=>x.id===id):null;
openModal(b?t('edit'):t('trace_add'),`
<div class="form-row"><div class="form-group"><label>${t('date')}</label><input type="date" id="tb-date" value="${b?b.date:todayStr()}"></div>
<div class="form-group"><label>${t('prod_flock')}</label><select id="tb-flock">${flockSelect(b?b.flockId:'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('trace_house')}</label><select id="tb-house" onchange="onHouseChange()">${houseSelect(b?b.house||'':'')}</select></div>
<div class="form-group"><label>${t('trace_rack')}</label><select id="tb-rack">${rackSelect(b?b.house||'':'',b?b.rackNumber||'':'')}</select></div></div>
<div class="form-row"><div class="form-group"><label>${t('trace_box_count')}</label><input type="number" id="tb-boxes" value="${b?b.boxCount||'':''}" min="1"></div>
<div class="form-group"><label>${t('trace_eggs_per_box')}</label><input type="number" id="tb-epb" value="${b?b.eggsPerBox||30:30}" min="1"></div></div>
<div class="form-row"><div class="form-group"><label>${t('prod_egg_type')}</label><select id="tb-type">
<option value="conventional"${b&&b.eggType==='conventional'?' selected':''}>${t('prod_type_conventional')}</option>
<option value="free_range"${b&&b.eggType==='free_range'?' selected':''}>${t('prod_type_free_range')}</option>
<option value="organic"${b&&b.eggType==='organic'?' selected':''}>${t('prod_type_organic')}</option>
<option value="pasture_raised"${b&&b.eggType==='pasture_raised'?' selected':''}>${t('prod_type_pasture')}</option>
<option value="decorative"${b&&b.eggType==='decorative'?' selected':''}>${t('prod_type_decorative')}</option></select></div>
<div class="form-group"><label>${t('fin_client')}</label><select id="tb-client">${clientSelect(b?b.clientId:'')}</select></div></div>
<div class="form-group"><label>${t('trace_delivery')}</label><input type="date" id="tb-delivery" value="${b?b.deliveryDate||'':''}"></div>
<div class="form-group"><label>${t('notes')}</label><textarea id="tb-notes">${b?b.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveBatch('${id||''}')">${t('save')}</button></div>`);
}
function saveBatch(id){
const D=loadData();const o={date:$('tb-date').value,flockId:$('tb-flock').value,house:$('tb-house').value,
rackNumber:$('tb-rack').value,boxCount:parseInt($('tb-boxes').value)||0,eggsPerBox:parseInt($('tb-epb').value)||30,
eggType:$('tb-type').value,clientId:$('tb-client').value,deliveryDate:$('tb-delivery').value,notes:$('tb-notes').value};
if(!o.date||!o.flockId){toast(t('required'),true);return;}
o.qrCode=`EGGLOGU|BATCH:${id||genId()}|FLOCK:${o.flockId}|DATE:${o.date}|HOUSE:${o.house}|TYPE:${o.eggType}`;
if(id){const i=D.traceability.batches.findIndex(b=>b.id===id);if(i>=0)D.traceability.batches[i]={...D.traceability.batches[i],...o};}
else{o.id=genId();o.qrCode=o.qrCode.replace('BATCH:'+o.id,'BATCH:'+o.id);D.traceability.batches.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderTraceability();
}
function deleteBatch(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.traceability.batches=D.traceability.batches.filter(b=>b.id!==id);saveData(D);toast(t('cfg_saved'));renderTraceability();}
function showBatchTrace(id){
const D=loadData();const b=D.traceability.batches.find(x=>x.id===id);if(!b)return;
const f=D.flocks.find(x=>x.id===b.flockId);const c=D.clients.find(x=>x.id===b.clientId);
const breed=f?f.breed||'generic':'generic';
const l7=D.dailyProduction.filter(p=>p.flockId===b.flockId&&p.date<=b.date).sort((a,c)=>c.date.localeCompare(a.date)).slice(0,7);
const avgFCR=l7.length>0?'~':'N/A';
const hs=f?computeFlockHealthScore(f.id,D):'N/A';
openModal('üîç '+t('trace_origin'),`
<div class="card" style="margin:0"><h4>${t('trace_batch_id')}: ${b.id.substring(0,8)}</h4>
<div class="stat-row"><span class="stat-label">${t('trace_house')}</span><span class="stat-value">${b.house||'-'}</span></div>
<div class="stat-row"><span class="stat-label">${t('prod_flock')}</span><span class="stat-value">${f?f.name+' ('+breed+')':'-'}</span></div>
<div class="stat-row"><span class="stat-label">${t('date')}</span><span class="stat-value">${fmtDate(b.date)}</span></div>
<div class="stat-row"><span class="stat-label">${t('flock_health')}</span><span class="stat-value">${hs}</span></div>
<div class="stat-row"><span class="stat-label">${t('prod_egg_type')}</span><span class="stat-value">${t('prod_type_'+b.eggType)||b.eggType}</span></div>
<div class="stat-row"><span class="stat-label">${t('fin_client')}</span><span class="stat-value">${c?c.name:'-'}</span></div>
<hr><div class="qr-display">${b.qrCode||'N/A'}</div>
</div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('close')}</button></div>`);
}
function computeFlockHealthScore(fid,D){
let score=100;
const deaths=D.dailyProduction.filter(p=>p.flockId===fid).reduce((s,p)=>s+(p.deaths||0),0);
const f=D.flocks.find(x=>x.id===fid);if(!f)return 0;
const mortality=f.count>0?(deaths/f.count*100):0;
score-=Math.min(30,mortality*3);
const activeOutbreaks=D.outbreaks.filter(o=>o.flockId===fid&&o.status==='active').length;
score-=activeOutbreaks*20;
return Math.max(0,Math.round(score));
}
function filterBatches(){
const q=($('trace-search')?.value||'').toLowerCase();const D=loadData();
const filtered=q?D.traceability.batches.filter(b=>b.id.toLowerCase().includes(q)||(b.qrCode||'').toLowerCase().includes(q)||(b.house||'').toLowerCase().includes(q)):D.traceability.batches;
const el=$('batch-list');if(el)el.innerHTML=renderBatchList(filtered,D);
}
function exportBatchCSV(){
const D=loadData();const batches=D.traceability.batches;if(!batches.length)return;
let csv='Batch ID,Date,Flock,House,Rack,Boxes,Eggs/Box,Type,Client,Delivery,QR\n';
batches.forEach(b=>{const f=D.flocks.find(x=>x.id===b.flockId);const c=D.clients.find(x=>x.id===b.clientId);
csv+=`"${b.id}","${b.date}","${f?f.name:''}","${b.house||''}","${b.rackNumber||''}",${b.boxCount},${b.eggsPerBox},"${b.eggType||''}","${c?c.name:''}","${b.deliveryDate||''}","${b.qrCode||''}"\n`;});
const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='egglogu_batches.csv';a.click();
}

// ============ PRODUCTION PLANNING MODULE ============
function renderPlanning(){
const D=loadData();const plans=D.productionPlans;
let h=`<div class="page-header"><h2>${t('plan_title')}</h2>
<button class="btn btn-primary" onclick="showPlanForm()">${t('plan_add')}</button></div>`;
if(!plans.length){h+=emptyState('üìÖ',t('no_data'));$('sec-planificacion').innerHTML=h;return;}
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:16px">';
plans.forEach(p=>{
const totalExpected=estimateTotalProduction(D,p);
const gap=totalExpected-p.eggsNeeded;const pct=p.eggsNeeded>0?(totalExpected/p.eggsNeeded*100):0;
const statusColor=pct>=100?'var(--success)':pct>=80?'var(--warning)':'var(--danger)';
const statusText=pct>=100?t('plan_on_track'):pct>=80?t('plan_behind'):t('plan_behind');
const c=D.clients.find(x=>x.id===p.clientId);
h+=`<div class="card" style="border-top:3px solid ${statusColor}">
<div style="display:flex;justify-content:space-between;align-items:center"><h3>${p.name}</h3>
<span style="color:${statusColor};font-weight:700">${fmtNum(pct,0)}%</span></div>
<p style="font-size:13px;color:var(--text-light)">${t('plan_target_date')}: ${fmtDate(p.targetDate)}${c?' | '+c.name:''}</p>
<div class="stat-row"><span class="stat-label">${t('plan_eggs_needed')}</span><span class="stat-value">${fmtNum(p.eggsNeeded)}</span></div>
<div class="stat-row"><span class="stat-label">${t('plan_expected')}</span><span class="stat-value">${fmtNum(totalExpected)}</span></div>
<div class="stat-row"><span class="stat-label">${t('plan_gap')}</span><span class="stat-value" style="color:${statusColor}">${gap>0?'+':''}${fmtNum(gap)} (${statusText})</span></div>`;
if(p.flockAllocations&&p.flockAllocations.length){
h+=`<div style="margin-top:8px;font-size:12px">`;
p.flockAllocations.forEach(a=>{const fl=D.flocks.find(x=>x.id===a.flockId);
h+=`<div class="stat-row"><span class="stat-label">${fl?fl.name:'?'}</span><span class="stat-value">${fmtNum(a.expectedEggs)} ${t('eggs_unit')}</span></div>`;});
h+='</div>';}
h+=`<div class="btn-group" style="margin-top:12px">
<button class="btn btn-secondary btn-sm" onclick="showPlanForm('${p.id}')">${t('edit')}</button>
<button class="btn btn-danger btn-sm" onclick="deletePlan('${p.id}')">${t('delete')}</button></div></div>`;});
h+='</div>';
$('sec-planificacion').innerHTML=h;
}
function estimateProduction(D,flockId,fromDate,toDate){
const f=D.flocks.find(x=>x.id===flockId);if(!f||!f.birthdate)return 0;
const bkey2=f.breed&&BREED_CURVES[f.breed]?f.breed:(f.targetCurve&&BREED_CURVES[f.targetCurve]?f.targetCurve:'generic');const curve=BREED_CURVES[bkey2]||BREED_CURVES.generic;
const birth=new Date(f.birthdate+'T12:00:00');
const from=new Date(fromDate+'T12:00:00');const to=new Date(toDate+'T12:00:00');
let total=0;const hens=activeHensByFlock(flockId);
for(let d=new Date(from);d<=to;d.setDate(d.getDate()+1)){
const ageWeeks=Math.floor((d-birth)/(7*24*3600000));
const weekIdx=ageWeeks-18;
if(weekIdx<0)continue;
const henDay=weekIdx<curve.length?curve[weekIdx]:curve[curve.length-1];
total+=hens*(henDay/100);
}
return Math.round(total);
}
function estimateTotalProduction(D,plan){
if(!plan.flockAllocations||!plan.flockAllocations.length){
let total=0;D.flocks.filter(f=>f.status!=='descarte').forEach(f=>{
total+=estimateProduction(D,f.id,todayStr(),plan.targetDate);});return total;}
return plan.flockAllocations.reduce((s,a)=>s+(a.expectedEggs||estimateProduction(D,a.flockId,todayStr(),plan.targetDate)),0);
}
function showPlanForm(id){
const D=loadData();const p=id?D.productionPlans.find(x=>x.id===id):null;
let flockChecks='';D.flocks.filter(f=>f.status!=='descarte').forEach(f=>{
const alloc=p?p.flockAllocations?.find(a=>a.flockId===f.id):null;
const est=estimateProduction(D,f.id,todayStr(),p?p.targetDate:new Date(Date.now()+30*86400000).toISOString().substring(0,10));
flockChecks+=`<div class="form-row" style="align-items:center"><label><input type="checkbox" class="plan-flock" value="${f.id}"${alloc?' checked':''}> ${f.name}</label>
<span style="font-size:12px;color:var(--text-light)">${t('plan_estimate')}: ~${fmtNum(est)}</span></div>`;});
openModal(p?t('edit'):t('plan_add'),`
<div class="form-row"><div class="form-group"><label>${t('plan_name')}</label><input id="pl-name" value="${p?p.name:''}"></div>
<div class="form-group"><label>${t('plan_target_date')}</label><input type="date" id="pl-date" value="${p?p.targetDate:''}"></div></div>
<div class="form-row"><div class="form-group"><label>${t('plan_eggs_needed')}</label><input type="number" id="pl-eggs" value="${p?p.eggsNeeded:''}" min="0"></div>
<div class="form-group"><label>${t('fin_client')}</label><select id="pl-client">${clientSelect(p?p.clientId:'')}</select></div></div>
<div class="form-group"><label>${t('plan_allocations')}</label>${flockChecks}</div>
<div class="form-group"><label>${t('notes')}</label><textarea id="pl-notes">${p?p.notes||'':''}</textarea></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="savePlan('${id||''}')">${t('save')}</button></div>`);
}
function savePlan(id){
const D=loadData();const checks=document.querySelectorAll('.plan-flock:checked');
const allocs=Array.from(checks).map(c=>({flockId:c.value,expectedEggs:estimateProduction(D,c.value,todayStr(),$('pl-date').value)}));
const o={name:$('pl-name').value,targetDate:$('pl-date').value,eggsNeeded:parseInt($('pl-eggs').value)||0,
clientId:$('pl-client').value,notes:$('pl-notes').value,flockAllocations:allocs};
if(!o.name||!o.targetDate){toast(t('required'),true);return;}
if(id){const i=D.productionPlans.findIndex(p=>p.id===id);if(i>=0)D.productionPlans[i]={...D.productionPlans[i],...o};}
else{o.id=genId();D.productionPlans.push(o);}
saveData(D);closeModal();toast(t('cfg_saved'));renderPlanning();
}
function deletePlan(id){if(!confirm(t('confirm_delete')))return;const D=loadData();D.productionPlans=D.productionPlans.filter(p=>p.id!==id);saveData(D);toast(t('cfg_saved'));renderPlanning();}

// ============ CAMPO MODE ============
function toggleCampoMode(){
const D=loadData();D.settings.campoMode=!D.settings.campoMode;
if(D.settings.campoMode)D.settings.vetMode=false;
saveData(D);applyCampoMode(D);nav('dashboard');
}
function applyCampoMode(D){
document.body.classList.toggle('campo-mode',D.settings.campoMode);
$('btn-campo')?.classList.toggle('active',D.settings.campoMode);
$('btn-vet')?.classList.toggle('active',D.settings.vetMode);
// Hide non-essential nav items in campo mode
document.querySelectorAll('#main-nav a').forEach(a=>{
const s=a.dataset.section;
if(D.settings.campoMode&&s!=='dashboard'&&s!=='produccion'){a.classList.add('campo-hide');}
else{a.classList.remove('campo-hide');}
});
}
function renderCampoDashboard(D){
const snap=computeKpiSnapshot();const alerts=getAlerts(D);
let h=`<div style="text-align:center;padding:20px 0"><h2>üåæ ${t('nav_campo_mode')}</h2></div>`;
h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;max-width:500px;margin:0 auto">`;
h+=`<div class="kpi-card" style="padding:24px;text-align:center"><div class="kpi-label">${t('kpi_today')}</div><div class="campo-kpi">${fmtNum(snap.eggsToday)}</div></div>`;
h+=`<div class="kpi-card" style="padding:24px;text-align:center"><div class="kpi-label">${t('kpi_henday')}</div><div class="campo-kpi">${fmtNum(snap.henDay,1)}%</div></div>`;
h+=`<div class="kpi-card" style="padding:24px;text-align:center"><div class="kpi-label">${t('kpi_mortality')}</div><div class="campo-kpi">${fmtNum(snap.mortality,1)}%</div></div>`;
h+=`<div class="kpi-card" style="padding:24px;text-align:center"><div class="kpi-label">${t('kpi_alerts')}</div><div class="campo-kpi">${alerts.length}</div></div>`;
h+=`</div>`;
h+=`<button class="campo-btn-big" onclick="showCampoQuickEntry()">üìù ${t('campo_today')}</button>`;
if(alerts.length){h+=`<div class="card" style="margin-top:16px"><h3>${t('dash_alerts')}</h3>`;
alerts.forEach(a=>{h+=`<div class="alert-card alert-${a.type}">${a.icon} ${a.msg}</div>`;});h+='</div>';}
return h;
}
function showCampoQuickEntry(){
const D=loadData();
openModal('üìù '+t('campo_quick_entry'),`
<div class="form-group"><label>${t('prod_flock')}</label><select id="cq-flock">${flockSelect('')}</select></div>
<div class="form-group"><label>${t('prod_eggs')}</label><input type="number" id="cq-eggs" min="0" style="font-size:24px;padding:12px"></div>
<div class="form-group"><label>${t('prod_deaths')}</label><input type="number" id="cq-deaths" min="0" value="0"></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
<button class="btn btn-primary" onclick="saveCampoQuick()" style="font-size:18px;padding:12px 24px">${t('save')}</button></div>`);
}
function saveCampoQuick(){
const D=loadData();const o={id:genId(),date:todayStr(),flockId:$('cq-flock').value,
eggsCollected:parseInt($('cq-eggs').value)||0,deaths:parseInt($('cq-deaths').value)||0,
eggsBroken:0,eggsS:0,eggsM:0,eggsL:0,eggsXL:0,eggsJumbo:0,shellColor:'',yolkScore:0,deathCause:'',notes:'campo mode'};
if(!o.flockId){toast(t('required'),true);return;}
D.dailyProduction.push(o);saveData(D);closeModal();toast(t('cfg_saved'));nav('dashboard');
}

// ============ VET MODE ============
function toggleVetMode(){
const D=loadData();D.settings.vetMode=!D.settings.vetMode;
if(D.settings.vetMode)D.settings.campoMode=false;
saveData(D);applyCampoMode(D);
if(D.settings.vetMode)showVetDashboard();else nav('dashboard');
}
function showVetDashboard(){
const D=loadData();
let h=`<div style="text-align:center;padding:12px 0"><h2>ü©∫ ${t('nav_vet_mode')}</h2></div>`;
h+=`<div class="form-group"><label>${t('vet_select_farm')}</label><select id="vet-flock" onchange="renderVetFlock()">${flockSelect('',true)}</select></div>`;
h+=`<div id="vet-content"></div>`;
h+=`<div class="card" style="margin-top:16px"><h4>${t('actions')}</h4><div class="btn-group">
<button class="btn btn-primary" onclick="vetAction('visit')">‚úÖ ${t('vet_visit')}</button>
<button class="btn btn-secondary" onclick="vetAction('vaccines')">üíâ ${t('vet_vaccines')}</button>
<button class="btn btn-secondary" onclick="vetAction('pending')">‚è≥ ${t('vet_pending')}</button></div></div>`;
$('sec-dashboard').innerHTML=h;
}
function renderVetFlock(){
const fid=$('vet-flock')?.value;const D=loadData();
if(!fid){$('vet-content').innerHTML='';return;}
const f=D.flocks.find(x=>x.id===fid);if(!f)return;
const hs=computeFlockHealthScore(fid,D);
const outbreaks=D.outbreaks.filter(o=>o.flockId===fid&&o.status==='active');
const lastEnv=D.environment.length>0?D.environment[D.environment.length-1]:null;
const pendingVac=D.vaccines.filter(v=>v.flockId===fid&&v.status!=='applied');
let h=`<div class="kpi-grid">`;
h+=kpi(t('flock_health'),hs+'/100','',hs<50?'danger':hs<70?'warning':'');
h+=kpi(t('out_title'),outbreaks.length.toString(),outbreaks.length?t('out_active'):'‚úÖ',outbreaks.length?'danger':'');
h+=kpi(t('vac_title'),pendingVac.length.toString(),t('vac_pending'),'');
h+=`</div>`;
if(outbreaks.length){h+=`<div class="card"><h4>ü¶† ${t('out_title')}</h4>`;
outbreaks.forEach(o=>{h+=`<div class="alert-card alert-danger">${o.disease} - ${fmtDate(o.startDate)} | ${o.treatment||'-'}</div>`;});h+='</div>';}
if(lastEnv){h+=`<div class="card"><h4>üå°Ô∏è ${t('env_title')}</h4>
<p>${t('env_temp')}: ${lastEnv.temperature||'-'}¬∞C | ${t('env_humidity')}: ${lastEnv.humidity||'-'}%</p></div>`;}
if(pendingVac.length){h+=`<div class="card"><h4>üíâ ${t('vac_title')}</h4>`;
pendingVac.forEach(v=>{h+=`<div class="alert-card alert-${v.scheduledDate<todayStr()?'danger':'warning'}">${v.vaccineName} - ${fmtDate(v.scheduledDate)} (${v.scheduledDate<todayStr()?t('vac_overdue'):t('vac_pending')})</div>`;});h+='</div>';}
// Cross-contamination check from biosecurity visitors
const recentVisitors=D.biosecurity.visitors.filter(v=>v.fromFarmHealth==='outbreak'&&v.date>=new Date(Date.now()-7*86400000).toISOString().substring(0,10));
if(recentVisitors.length){h+=`<div class="alert-card alert-danger">${t('bio_cross_risk')}: ${recentVisitors.map(v=>v.name).join(', ')}</div>`;}
$('vet-content').innerHTML=h;
}
function vetAction(type){
const D=loadData();const fid=$('vet-flock')?.value||'';const f=D.flocks.find(x=>x.id===fid);
const note=type==='visit'?t('vet_visit'):type==='vaccines'?t('vet_vaccines'):t('vet_pending');
D.logbook.push({id:genId(),date:todayStr(),entry:'ü©∫ '+note+(f?' - '+f.name:''),category:'health'});
// Auto-create biosecurity visitor record
D.biosecurity.visitors.push({id:genId(),date:todayStr(),name:'Veterinario',company:'',purpose:note,zone:'',vehiclePlate:'',disinfected:true,fromFarmId:'',fromFarmHealth:'healthy',notes:''});
saveData(D);toast(t('cfg_saved'));
}

// ============ OUTBREAK RISK CLASSIFIER ============
function computeOutbreakRisk(D){
const hens=activeHens();if(hens===0)return{probability:0,classification:0,factors:[],recommendations:[]};
const factors=[];
// 1. Mortality spike (0.25)
const l7prod=D.dailyProduction.sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const l7deaths=l7prod.reduce((s,p)=>s+(p.deaths||0),0);
const deathRate=hens>0?(l7deaths/hens*100):0;
const mortFactor=Math.min(1,deathRate/10);
factors.push({name:LANG==='en'?'Mortality':'Mortalidad',weight:0.25,value:mortFactor,detail:fmtNum(deathRate,2)+'%'});
// 2. FCR deterioration (0.15)
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const f30=D.feed.consumption.filter(c=>c.date>=d30s);const e30=D.dailyProduction.filter(p=>p.date>=d30s);
const tfkg=f30.reduce((s,c)=>s+(c.quantityKg||0),0);const tekg=e30.reduce((s,p)=>s+(p.eggsCollected||0),0)*0.06;
const fcr=tekg>0?tfkg/tekg:0;
const fcrFactor=fcr>0?Math.min(1,(fcr-2)/2):0;
factors.push({name:'FCR',weight:0.15,value:fcrFactor,detail:fmtNum(fcr,2)});
// 3. THI stress (0.15)
const lastW=D.weatherCache.length>0?D.weatherCache[D.weatherCache.length-1]:null;
let thiFactor=0;
if(lastW){const thi=calcTHI(lastW.temp,lastW.humidity);thiFactor=thi>28?Math.min(1,(thi-25)/10):0;
factors.push({name:'THI',weight:0.15,value:thiFactor,detail:fmtNum(thi,1)});}
else factors.push({name:'THI',weight:0.15,value:0,detail:'-'});
// 4. Production drop (0.20)
let prodFactor=0;
if(l7prod.length>=7&&typeof ss!=='undefined'){
const points=l7prod.map((p,i)=>[i,p.eggsCollected||0]);
const reg=ss.linearRegression(points);
prodFactor=reg.m<0?Math.min(1,Math.abs(reg.m)/10):0;
}
factors.push({name:LANG==='en'?'Production drop':'Ca√≠da producci√≥n',weight:0.20,value:prodFactor,detail:''});
// 5. Active outbreaks (0.10)
const activeOut=D.outbreaks.filter(o=>o.status==='active').length;
const outFactor=Math.min(1,activeOut/3);
factors.push({name:LANG==='en'?'Active outbreaks':'Brotes activos',weight:0.10,value:outFactor,detail:activeOut.toString()});
// 6. Vaccination gaps (0.10)
const today=todayStr();const overdueVac=D.vaccines.filter(v=>v.status!=='applied'&&v.scheduledDate<today).length;
const vacFactor=Math.min(1,overdueVac/5);
factors.push({name:LANG==='en'?'Vaccine gaps':'Vacunas atrasadas',weight:0.10,value:vacFactor,detail:overdueVac.toString()});
// 7. Stress events (0.05)
const d7=new Date();d7.setDate(d7.getDate()-7);const d7s=d7.toISOString().substring(0,10);
const recentStress=D.stressEvents.filter(e=>e.date>=d7s).length;
const stressFactor=Math.min(1,recentStress/3);
factors.push({name:LANG==='en'?'Recent stress':'Estr√©s reciente',weight:0.05,value:stressFactor,detail:recentStress.toString()});
// Compute probability via sigmoid
const z=factors.reduce((s,f)=>s+f.weight*f.value*6,0)-2;
const probability=1/(1+Math.exp(-z));
const classification=probability>=0.5?1:0;
// Recommendations
const recommendations=[];
if(mortFactor>0.5)recommendations.push({priority:'high',icon:'üî¨',msg:t('rec_lab_samples')});
if(thiFactor>0.5)recommendations.push({priority:'high',icon:'üå°Ô∏è',msg:t('rec_ventilation')});
if(fcrFactor>0.5)recommendations.push({priority:'medium',icon:'üåæ',msg:t('rec_check_diet')});
if(prodFactor>0.5)recommendations.push({priority:'medium',icon:'üìâ',msg:t('rec_check_env')});
if(overdueVac>0)recommendations.push({priority:'medium',icon:'üíâ',msg:t('alert_vaccine_overdue')+': '+overdueVac});
return{probability,classification,factors,recommendations};
}

// ============ MULTI-STEP FORECAST ============
function computeForecast(D,days=7){
if(typeof ss==='undefined')return{dates:[],actual:[],forecast:[],upper:[],lower:[]};
const prod=D.dailyProduction.sort((a,b)=>a.date.localeCompare(b.date));
if(prod.length<7)return{dates:[],actual:[],forecast:[],upper:[],lower:[]};
const last14=prod.slice(-14);
const values=last14.map(p=>p.eggsCollected||0);
// Weighted Moving Average
const wmaForecast=[];
const weights=values.map((_,i)=>Math.exp(i*0.2));const wSum=weights.reduce((a,b)=>a+b,0);
const wma=values.reduce((s,v,i)=>s+v*weights[i],0)/wSum;
for(let i=0;i<days;i++)wmaForecast.push(wma);
// Linear regression
const points=values.map((v,i)=>[i,v]);
const reg=ss.linearRegression(points);const regLine=ss.linearRegressionLine(reg);
const lrForecast=[];
for(let i=0;i<days;i++)lrForecast.push(Math.max(0,regLine(values.length+i)));
// Ensemble (average)
const ensemble=wmaForecast.map((w,i)=>(w+lrForecast[i])/2);
// Residuals for confidence bands
const residuals=values.map((v,i)=>v-regLine(i));
const stdDev=typeof ss.standardDeviation==='function'?ss.standardDeviation(residuals):
Math.sqrt(residuals.reduce((s,r)=>s+r*r,0)/residuals.length);
const upper=ensemble.map(v=>v+stdDev);
const lower=ensemble.map(v=>Math.max(0,v-stdDev));
// Generate date labels
const dates=[];const lastDate=new Date(last14[last14.length-1].date+'T12:00:00');
for(let i=1;i<=days;i++){const d=new Date(lastDate);d.setDate(d.getDate()+i);dates.push(d.toISOString().substring(0,10));}
const actualDates=last14.map(p=>p.date);
return{dates,actual:values,actualDates,forecast:ensemble,upper,lower,wma:wmaForecast,lr:lrForecast};
}

// ============ RECOMMENDATION ENGINE ============
function getRecommendations(D){
const recs=[];const today=todayStr();const hens=activeHens();
// FCR check
const d30=new Date();d30.setDate(d30.getDate()-30);const d30s=d30.toISOString().substring(0,10);
const f30=D.feed.consumption.filter(c=>c.date>=d30s);const e30=D.dailyProduction.filter(p=>p.date>=d30s);
const tfkg=f30.reduce((s,c)=>s+(c.quantityKg||0),0);const tekg=e30.reduce((s,p)=>s+(p.eggsCollected||0),0)*0.06;
const fcr=tekg>0?tfkg/tekg:0;
if(fcr>2.4)recs.push({priority:'medium',icon:'üåæ',msg:t('rec_check_diet')});
// Mortality spike 48h
const d2=new Date();d2.setDate(d2.getDate()-2);const d2s=d2.toISOString().substring(0,10);
const recent48=D.dailyProduction.filter(p=>p.date>=d2s);
const deaths48=recent48.reduce((s,p)=>s+(p.deaths||0),0);
const prev48=D.dailyProduction.filter(p=>p.date<d2s).slice(-recent48.length||1);
const deathsPrev=prev48.reduce((s,p)=>s+(p.deaths||0),0);
if(deathsPrev>0&&deaths48>deathsPrev*1.2)recs.push({priority:'high',icon:'‚ö†Ô∏è',msg:t('rec_check_env')});
// Hen-Day vs breed curve
D.flocks.filter(f=>f.status==='produccion'&&f.birthdate).forEach(f=>{
const bkey3=f.breed&&BREED_CURVES[f.breed]?f.breed:(f.targetCurve&&BREED_CURVES[f.targetCurve]?f.targetCurve:'generic');const curve=BREED_CURVES[bkey3]||BREED_CURVES.generic;
const ageWeeks=Math.floor((new Date()-new Date(f.birthdate+'T12:00:00'))/(7*24*3600000));
const weekIdx=ageWeeks-18;if(weekIdx<0||weekIdx>=curve.length)return;
const expected=curve[weekIdx];const fhens=activeHensByFlock(f.id);
const l7=D.dailyProduction.filter(p=>p.flockId===f.id).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
const avgE=l7.length>0?l7.reduce((s,p)=>s+(p.eggsCollected||0),0)/l7.length:0;
const actual=fhens>0?(avgE/fhens*100):0;
if(expected-actual>10)recs.push({priority:'medium',icon:'üìâ',msg:t('rec_below_curve')+' ('+f.name+')'});
});
// Feed stock
const stock=D.feed.purchases.reduce((s,p)=>s+(p.quantityKg||0),0)-D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0);
const avgDaily=D.feed.consumption.length>0?D.feed.consumption.reduce((s,c)=>s+(c.quantityKg||0),0)/Math.max(1,D.feed.consumption.length):0;
if(avgDaily>0&&stock/avgDaily<7)recs.push({priority:'medium',icon:'üåæ',msg:t('rec_buy_feed')});
// No env reading in 3 days
const d3=new Date();d3.setDate(d3.getDate()-3);const d3s=d3.toISOString().substring(0,10);
const recentEnv=D.environment.filter(e=>e.date>=d3s);
if(!recentEnv.length&&D.environment.length>0)recs.push({priority:'low',icon:'üå°Ô∏è',msg:t('rec_record_env')});
// Overdue disinfection
if(D.biosecurity){D.biosecurity.zones.forEach(z=>{
if(z.lastDisinfection&&z.frequencyDays){
const next=new Date(z.lastDisinfection+'T12:00:00');next.setDate(next.getDate()+z.frequencyDays);
if(next.toISOString().substring(0,10)<today)recs.push({priority:'medium',icon:'üõ°Ô∏è',msg:t('rec_disinfect')+' '+z.name});
}});}
// Prolonged heat stress
const lastW=D.weatherCache.slice(-2);
if(lastW.length>=2&&lastW.every(w=>calcTHI(w.temp,w.humidity)>28))recs.push({priority:'high',icon:'üå°Ô∏è',msg:t('rec_heat_plan')});
return recs;
}

// ============ ACCESSIBILITY HELPERS ============
function applyFontScale(scale){
document.body.classList.remove('font-small','font-normal','font-large','font-xlarge');
document.body.classList.add('font-'+scale);
const D=loadData();D.settings.fontScale=scale;saveData(D);
}
function applyDarkMode(on){
document.body.classList.toggle('dark-mode',on);
const D=loadData();D.settings.darkMode=on;saveData(D);
if(on){applyTheme('dark');localStorage.setItem('egglogu_theme','dark');}
}

// ============ INIT ============
function init(){DATA=null;loadData();const savedTheme=localStorage.getItem('egglogu_theme');if(savedTheme&&THEMES[savedTheme])applyTheme(savedTheme);
// Apply saved settings
const D=loadData();
if(D.settings.fontScale&&D.settings.fontScale!=='normal')applyFontScale(D.settings.fontScale);
if(D.settings.darkMode)document.body.classList.add('dark-mode');
applyCampoMode(D);
switchLang(LANG);nav('dashboard');}
window.addEventListener('DOMContentLoaded',init);
// ============ SERVICE WORKER ============
if('serviceWorker' in navigator){
navigator.serviceWorker.register('sw.js').then(reg=>{
console.log('SW registered',reg.scope);
}).catch(e=>console.log('SW registration failed',e));
}
</script>
</body>
</html>